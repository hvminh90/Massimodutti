/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/jquery-1.11.0.min.js (en_US) */
/*! jQuery v1.11.0 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k="".trim,l={},m="1.11.0",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return n.each(this,a,b)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments[h]))for(d in e)a=g[d],c=e[d],g!==c&&(j&&c&&(n.isPlainObject(c)||(b=n.isArray(c)))?(b?(b=!1,f=a&&n.isArray(a)?a:[]):f=a&&n.isPlainObject(a)?a:{},g[d]=n.extend(j,f,c)):void 0!==c&&(g[d]=c));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){return a-parseFloat(a)>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;try{if(a.constructor&&!j.call(a,"constructor")&&!j.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(l.ownLast)for(b in a)return j.call(a,b);for(b in a);return void 0===b||j.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(b){b&&n.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:k&&!k.call("\ufeff\xa0")?function(a){return null==a?"":k.call(a)}:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(g)return g.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a[e++]=b[d++];if(c!==c)while(void 0!==b[d])a[e++]=b[d++];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(f=a[b],b=a,a=f),n.isFunction(a)?(c=d.call(arguments,2),e=function(){return a.apply(b||this,c.concat(d.call(arguments)))},e.guid=a.guid=a.guid||n.guid++,e):void 0},now:function(){return+new Date},support:l}),n.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="sizzle"+-new Date,t=a.document,u=0,v=0,w=eb(),x=eb(),y=eb(),z=function(a,b){return a===b&&(j=!0),0},A="undefined",B=1<<31,C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=D.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},J="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",K="[\\x20\\t\\r\\n\\f]",L="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",M=L.replace("w","w#"),N="\\["+K+"*("+L+")"+K+"*(?:([*^$|!~]?=)"+K+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+M+")|)|)"+K+"*\\]",O=":("+L+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+N.replace(3,8)+")*)|.*)\\)|)",P=new RegExp("^"+K+"+|((?:^|[^\\\\])(?:\\\\.)*)"+K+"+$","g"),Q=new RegExp("^"+K+"*,"+K+"*"),R=new RegExp("^"+K+"*([>+~]|"+K+")"+K+"*"),S=new RegExp("="+K+"*([^\\]'\"]*?)"+K+"*\\]","g"),T=new RegExp(O),U=new RegExp("^"+M+"$"),V={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L.replace("w","w*")+")"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+K+"*(even|odd|(([+-]|)(\\d*)n|)"+K+"*(?:([+-]|)"+K+"*(\\d+)|))"+K+"*\\)|)","i"),bool:new RegExp("^(?:"+J+")$","i"),needsContext:new RegExp("^"+K+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+K+"*((?:-\\d)?\\d*)"+K+"*\\)|)(?=[^-]|$)","i")},W=/^(?:input|select|textarea|button)$/i,X=/^h\d$/i,Y=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,$=/[+~]/,_=/'|\\/g,ab=new RegExp("\\\\([\\da-f]{1,6}"+K+"?|("+K+")|.)","ig"),bb=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{G.apply(D=H.call(t.childNodes),t.childNodes),D[t.childNodes.length].nodeType}catch(cb){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function db(a,b,d,e){var f,g,h,i,j,m,p,q,u,v;if((b?b.ownerDocument||b:t)!==l&&k(b),b=b||l,d=d||[],!a||"string"!=typeof a)return d;if(1!==(i=b.nodeType)&&9!==i)return[];if(n&&!e){if(f=Z.exec(a))if(h=f[1]){if(9===i){if(g=b.getElementById(h),!g||!g.parentNode)return d;if(g.id===h)return d.push(g),d}else if(b.ownerDocument&&(g=b.ownerDocument.getElementById(h))&&r(b,g)&&g.id===h)return d.push(g),d}else{if(f[2])return G.apply(d,b.getElementsByTagName(a)),d;if((h=f[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(h)),d}if(c.qsa&&(!o||!o.test(a))){if(q=p=s,u=b,v=9===i&&a,1===i&&"object"!==b.nodeName.toLowerCase()){m=ob(a),(p=b.getAttribute("id"))?q=p.replace(_,"\\$&"):b.setAttribute("id",q),q="[id='"+q+"'] ",j=m.length;while(j--)m[j]=q+pb(m[j]);u=$.test(a)&&mb(b.parentNode)||b,v=m.join(",")}if(v)try{return G.apply(d,u.querySelectorAll(v)),d}catch(w){}finally{p||b.removeAttribute("id")}}}return xb(a.replace(P,"$1"),b,d,e)}function eb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function fb(a){return a[s]=!0,a}function gb(a){var b=l.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function hb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function ib(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||B)-(~a.sourceIndex||B);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function jb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function kb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function lb(a){return fb(function(b){return b=+b,fb(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function mb(a){return a&&typeof a.getElementsByTagName!==A&&a}c=db.support={},f=db.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},k=db.setDocument=function(a){var b,e=a?a.ownerDocument||a:t,g=e.defaultView;return e!==l&&9===e.nodeType&&e.documentElement?(l=e,m=e.documentElement,n=!f(e),g&&g!==g.top&&(g.addEventListener?g.addEventListener("unload",function(){k()},!1):g.attachEvent&&g.attachEvent("onunload",function(){k()})),c.attributes=gb(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=gb(function(a){return a.appendChild(e.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Y.test(e.getElementsByClassName)&&gb(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),c.getById=gb(function(a){return m.appendChild(a).id=s,!e.getElementsByName||!e.getElementsByName(s).length}),c.getById?(d.find.ID=function(a,b){if(typeof b.getElementById!==A&&n){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){var c=typeof a.getAttributeNode!==A&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==A?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==A&&n?b.getElementsByClassName(a):void 0},p=[],o=[],(c.qsa=Y.test(e.querySelectorAll))&&(gb(function(a){a.innerHTML="<select t=''><option selected=''></option></select>",a.querySelectorAll("[t^='']").length&&o.push("[*^$]="+K+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||o.push("\\["+K+"*(?:value|"+J+")"),a.querySelectorAll(":checked").length||o.push(":checked")}),gb(function(a){var b=e.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&o.push("name"+K+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||o.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),o.push(",.*:")})),(c.matchesSelector=Y.test(q=m.webkitMatchesSelector||m.mozMatchesSelector||m.oMatchesSelector||m.msMatchesSelector))&&gb(function(a){c.disconnectedMatch=q.call(a,"div"),q.call(a,"[s!='']:x"),p.push("!=",O)}),o=o.length&&new RegExp(o.join("|")),p=p.length&&new RegExp(p.join("|")),b=Y.test(m.compareDocumentPosition),r=b||Y.test(m.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},z=b?function(a,b){if(a===b)return j=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===e||a.ownerDocument===t&&r(t,a)?-1:b===e||b.ownerDocument===t&&r(t,b)?1:i?I.call(i,a)-I.call(i,b):0:4&d?-1:1)}:function(a,b){if(a===b)return j=!0,0;var c,d=0,f=a.parentNode,g=b.parentNode,h=[a],k=[b];if(!f||!g)return a===e?-1:b===e?1:f?-1:g?1:i?I.call(i,a)-I.call(i,b):0;if(f===g)return ib(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)k.unshift(c);while(h[d]===k[d])d++;return d?ib(h[d],k[d]):h[d]===t?-1:k[d]===t?1:0},e):l},db.matches=function(a,b){return db(a,null,null,b)},db.matchesSelector=function(a,b){if((a.ownerDocument||a)!==l&&k(a),b=b.replace(S,"='$1']"),!(!c.matchesSelector||!n||p&&p.test(b)||o&&o.test(b)))try{var d=q.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return db(b,l,null,[a]).length>0},db.contains=function(a,b){return(a.ownerDocument||a)!==l&&k(a),r(a,b)},db.attr=function(a,b){(a.ownerDocument||a)!==l&&k(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!n):void 0;return void 0!==f?f:c.attributes||!n?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},db.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},db.uniqueSort=function(a){var b,d=[],e=0,f=0;if(j=!c.detectDuplicates,i=!c.sortStable&&a.slice(0),a.sort(z),j){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return i=null,a},e=db.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=db.selectors={cacheLength:50,createPseudo:fb,match:V,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ab,bb),a[3]=(a[4]||a[5]||"").replace(ab,bb),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||db.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&db.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return V.CHILD.test(a[0])?null:(a[3]&&void 0!==a[4]?a[2]=a[4]:c&&T.test(c)&&(b=ob(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ab,bb).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=w[a+" "];return b||(b=new RegExp("(^|"+K+")"+a+"("+K+"|$)"))&&w(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==A&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=db.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),t=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&t){k=q[s]||(q[s]={}),j=k[a]||[],n=j[0]===u&&j[1],m=j[0]===u&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[u,n,m];break}}else if(t&&(j=(b[s]||(b[s]={}))[a])&&j[0]===u)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(t&&((l[s]||(l[s]={}))[a]=[u,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||db.error("unsupported pseudo: "+a);return e[s]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?fb(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I.call(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:fb(function(a){var b=[],c=[],d=g(a.replace(P,"$1"));return d[s]?fb(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),!c.pop()}}),has:fb(function(a){return function(b){return db(a,b).length>0}}),contains:fb(function(a){return function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:fb(function(a){return U.test(a||"")||db.error("unsupported lang: "+a),a=a.replace(ab,bb).toLowerCase(),function(b){var c;do if(c=n?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===m},focus:function(a){return a===l.activeElement&&(!l.hasFocus||l.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:lb(function(){return[0]}),last:lb(function(a,b){return[b-1]}),eq:lb(function(a,b,c){return[0>c?c+b:c]}),even:lb(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:lb(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:lb(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:lb(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=jb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=kb(b);function nb(){}nb.prototype=d.filters=d.pseudos,d.setFilters=new nb;function ob(a,b){var c,e,f,g,h,i,j,k=x[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=Q.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P," ")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?db.error(a):x(a,i).slice(0)}function pb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function qb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=v++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[u,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[s]||(b[s]={}),(h=i[d])&&h[0]===u&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function rb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function sb(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function tb(a,b,c,d,e,f){return d&&!d[s]&&(d=tb(d)),e&&!e[s]&&(e=tb(e,f)),fb(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||wb(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:sb(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=sb(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I.call(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=sb(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ub(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],i=g||d.relative[" "],j=g?1:0,k=qb(function(a){return a===b},i,!0),l=qb(function(a){return I.call(b,a)>-1},i,!0),m=[function(a,c,d){return!g&&(d||c!==h)||((b=c).nodeType?k(a,c,d):l(a,c,d))}];f>j;j++)if(c=d.relative[a[j].type])m=[qb(rb(m),c)];else{if(c=d.filter[a[j].type].apply(null,a[j].matches),c[s]){for(e=++j;f>e;e++)if(d.relative[a[e].type])break;return tb(j>1&&rb(m),j>1&&pb(a.slice(0,j-1).concat({value:" "===a[j-2].type?"*":""})).replace(P,"$1"),c,e>j&&ub(a.slice(j,e)),f>e&&ub(a=a.slice(e)),f>e&&pb(a))}m.push(c)}return rb(m)}function vb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,i,j,k){var m,n,o,p=0,q="0",r=f&&[],s=[],t=h,v=f||e&&d.find.TAG("*",k),w=u+=null==t?1:Math.random()||.1,x=v.length;for(k&&(h=g!==l&&g);q!==x&&null!=(m=v[q]);q++){if(e&&m){n=0;while(o=a[n++])if(o(m,g,i)){j.push(m);break}k&&(u=w)}c&&((m=!o&&m)&&p--,f&&r.push(m))}if(p+=q,c&&q!==p){n=0;while(o=b[n++])o(r,s,g,i);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=E.call(j));s=sb(s)}G.apply(j,s),k&&!f&&s.length>0&&p+b.length>1&&db.uniqueSort(j)}return k&&(u=w,h=t),r};return c?fb(f):f}g=db.compile=function(a,b){var c,d=[],e=[],f=y[a+" "];if(!f){b||(b=ob(a)),c=b.length;while(c--)f=ub(b[c]),f[s]?d.push(f):e.push(f);f=y(a,vb(e,d))}return f};function wb(a,b,c){for(var d=0,e=b.length;e>d;d++)db(a,b[d],c);return c}function xb(a,b,e,f){var h,i,j,k,l,m=ob(a);if(!f&&1===m.length){if(i=m[0]=m[0].slice(0),i.length>2&&"ID"===(j=i[0]).type&&c.getById&&9===b.nodeType&&n&&d.relative[i[1].type]){if(b=(d.find.ID(j.matches[0].replace(ab,bb),b)||[])[0],!b)return e;a=a.slice(i.shift().value.length)}h=V.needsContext.test(a)?0:i.length;while(h--){if(j=i[h],d.relative[k=j.type])break;if((l=d.find[k])&&(f=l(j.matches[0].replace(ab,bb),$.test(i[0].type)&&mb(b.parentNode)||b))){if(i.splice(h,1),a=f.length&&pb(i),!a)return G.apply(e,f),e;break}}}return g(a,m)(f,b,!n,e,$.test(a)&&mb(b.parentNode)||b),e}return c.sortStable=s.split("").sort(z).join("")===s,c.detectDuplicates=!!j,k(),c.sortDetached=gb(function(a){return 1&a.compareDocumentPosition(l.createElement("div"))}),gb(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||hb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&gb(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||hb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),gb(function(a){return null==a.getAttribute("disabled")})||hb(J,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),db}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=n.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return n.inArray(a,b)>=0!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=[],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;e>b;b++)if(n.contains(d[b],this))return!0}));for(b=0;e>b;b++)n.find(a,d[b],c);return c=this.pushStack(e>1?n.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?n(a):a||[],!1).length}});var y,z=a.document,A=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,B=n.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:A.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:z,!0)),v.test(c[1])&&n.isPlainObject(b))for(c in b)n.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}if(d=z.getElementById(c[2]),d&&d.parentNode){if(d.id!==c[2])return y.find(a);this.length=1,this[0]=d}return this.context=z,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};B.prototype=n.fn,y=n(z);var C=/^(?:parents|prev(?:Until|All))/,D={children:!0,contents:!0,next:!0,prev:!0};n.extend({dir:function(a,b,c){var d=[],e=a[b];while(e&&9!==e.nodeType&&(void 0===c||1!==e.nodeType||!n(e).is(c)))1===e.nodeType&&d.push(e),e=e[b];return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),n.fn.extend({has:function(a){var b,c=n(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(n.contains(this,c[b]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.unique(f):f)},index:function(a){return a?"string"==typeof a?n.inArray(this[0],n(a)):n.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.unique(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function E(a,b){do a=a[b];while(a&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return n.dir(a,"parentNode")},parentsUntil:function(a,b,c){return n.dir(a,"parentNode",c)},next:function(a){return E(a,"nextSibling")},prev:function(a){return E(a,"previousSibling")},nextAll:function(a){return n.dir(a,"nextSibling")},prevAll:function(a){return n.dir(a,"previousSibling")},nextUntil:function(a,b,c){return n.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return n.dir(a,"previousSibling",c)},siblings:function(a){return n.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return n.sibling(a.firstChild)},contents:function(a){return n.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(D[a]||(e=n.unique(e)),C.test(a)&&(e=e.reverse())),this.pushStack(e)}});var F=/\S+/g,G={};function H(a){var b=G[a]={};return n.each(a.match(F)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?G[a]||H(a):n.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(c=a.memory&&l,d=!0,f=g||0,g=0,e=h.length,b=!0;h&&e>f;f++)if(h[f].apply(l[0],l[1])===!1&&a.stopOnFalse){c=!1;break}b=!1,h&&(i?i.length&&j(i.shift()):c?h=[]:k.disable())},k={add:function(){if(h){var d=h.length;!function f(b){n.each(b,function(b,c){var d=n.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&f(c)})}(arguments),b?e=h.length:c&&(g=d,j(c))}return this},remove:function(){return h&&n.each(arguments,function(a,c){var d;while((d=n.inArray(c,h,d))>-1)h.splice(d,1),b&&(e>=d&&e--,f>=d&&f--)}),this},has:function(a){return a?n.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],e=0,this},disable:function(){return h=i=c=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,c||k.disable(),this},locked:function(){return!i},fireWith:function(a,c){return!h||d&&!i||(c=c||[],c=[a,c.slice?c.slice():c],b?i.push(c):j(c)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!d}};return k},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&n.isFunction(a.promise)?e:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){if(a===!0?!--n.readyWait:!n.isReady){if(!z.body)return setTimeout(n.ready);n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(z,[n]),n.fn.trigger&&n(z).trigger("ready").off("ready"))}}});function J(){z.addEventListener?(z.removeEventListener("DOMContentLoaded",K,!1),a.removeEventListener("load",K,!1)):(z.detachEvent("onreadystatechange",K),a.detachEvent("onload",K))}function K(){(z.addEventListener||"load"===event.type||"complete"===z.readyState)&&(J(),n.ready())}n.ready.promise=function(b){if(!I)if(I=n.Deferred(),"complete"===z.readyState)setTimeout(n.ready);else if(z.addEventListener)z.addEventListener("DOMContentLoaded",K,!1),a.addEventListener("load",K,!1);else{z.attachEvent("onreadystatechange",K),a.attachEvent("onload",K);var c=!1;try{c=null==a.frameElement&&z.documentElement}catch(d){}c&&c.doScroll&&!function e(){if(!n.isReady){try{c.doScroll("left")}catch(a){return setTimeout(e,50)}J(),n.ready()}}()}return I.promise(b)};var L="undefined",M;for(M in n(l))break;l.ownLast="0"!==M,l.inlineBlockNeedsLayout=!1,n(function(){var a,b,c=z.getElementsByTagName("body")[0];c&&(a=z.createElement("div"),a.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",b=z.createElement("div"),c.appendChild(a).appendChild(b),typeof b.style.zoom!==L&&(b.style.cssText="border:0;margin:0;width:1px;padding:1px;display:inline;zoom:1",(l.inlineBlockNeedsLayout=3===b.offsetWidth)&&(c.style.zoom=1)),c.removeChild(a),a=b=null)}),function(){var a=z.createElement("div");if(null==l.deleteExpando){l.deleteExpando=!0;try{delete a.test}catch(b){l.deleteExpando=!1}}a=null}(),n.acceptData=function(a){var b=n.noData[(a.nodeName+" ").toLowerCase()],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b};var N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(O,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}n.data(a,b,c)}else c=void 0}return c}function Q(a){var b;for(b in a)if(("data"!==b||!n.isEmptyObject(a[b]))&&"toJSON"!==b)return!1;return!0}function R(a,b,d,e){if(n.acceptData(a)){var f,g,h=n.expando,i=a.nodeType,j=i?n.cache:a,k=i?a[h]:a[h]&&h;if(k&&j[k]&&(e||j[k].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a[h]=c.pop()||n.guid++:h),j[k]||(j[k]=i?{}:{toJSON:n.noop}),("object"==typeof b||"function"==typeof b)&&(e?j[k]=n.extend(j[k],b):j[k].data=n.extend(j[k].data,b)),g=j[k],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g[n.camelCase(b)]=d),"string"==typeof b?(f=g[b],null==f&&(f=g[n.camelCase(b)])):f=g,f
}}function S(a,b,c){if(n.acceptData(a)){var d,e,f=a.nodeType,g=f?n.cache:a,h=f?a[n.expando]:n.expando;if(g[h]){if(b&&(d=c?g[h]:g[h].data)){n.isArray(b)?b=b.concat(n.map(b,n.camelCase)):b in d?b=[b]:(b=n.camelCase(b),b=b in d?[b]:b.split(" ")),e=b.length;while(e--)delete d[b[e]];if(c?!Q(d):!n.isEmptyObject(d))return}(c||(delete g[h].data,Q(g[h])))&&(f?n.cleanData([a],!0):l.deleteExpando||g!=g.window?delete g[h]:g[h]=null)}}}n.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?n.cache[a[n.expando]]:a[n.expando],!!a&&!Q(a)},data:function(a,b,c){return R(a,b,c)},removeData:function(a,b){return S(a,b)},_data:function(a,b,c){return R(a,b,c,!0)},_removeData:function(a,b){return S(a,b,!0)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=n.data(f),1===f.nodeType&&!n._data(f,"parsedAttrs"))){c=g.length;while(c--)d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d]));n._data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){n.data(this,a)}):arguments.length>1?this.each(function(){n.data(this,a,b)}):f?P(f,a,n.data(f,a)):void 0},removeData:function(a){return this.each(function(){n.removeData(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=n._data(a,b),c&&(!d||n.isArray(c)?d=n._data(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return n._data(a,c)||n._data(a,c,{empty:n.Callbacks("once memory").add(function(){n._removeData(a,b+"queue"),n._removeData(a,c)})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=n._data(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var T=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,U=["Top","Right","Bottom","Left"],V=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)},W=n.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)n.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},X=/^(?:checkbox|radio)$/i;!function(){var a=z.createDocumentFragment(),b=z.createElement("div"),c=z.createElement("input");if(b.setAttribute("className","t"),b.innerHTML="  <link/><table></table><a href='/a'>a</a>",l.leadingWhitespace=3===b.firstChild.nodeType,l.tbody=!b.getElementsByTagName("tbody").length,l.htmlSerialize=!!b.getElementsByTagName("link").length,l.html5Clone="<:nav></:nav>"!==z.createElement("nav").cloneNode(!0).outerHTML,c.type="checkbox",c.checked=!0,a.appendChild(c),l.appendChecked=c.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue,a.appendChild(b),b.innerHTML="<input type='radio' checked='checked' name='t'/>",l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,l.noCloneEvent=!0,b.attachEvent&&(b.attachEvent("onclick",function(){l.noCloneEvent=!1}),b.cloneNode(!0).click()),null==l.deleteExpando){l.deleteExpando=!0;try{delete b.test}catch(d){l.deleteExpando=!1}}a=b=c=null}(),function(){var b,c,d=z.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(l[b+"Bubbles"]=c in a)||(d.setAttribute(c,"t"),l[b+"Bubbles"]=d.attributes[c].expando===!1);d=null}();var Y=/^(?:input|select|textarea)$/i,Z=/^key/,$=/^(?:mouse|contextmenu)|click/,_=/^(?:focusinfocus|focusoutblur)$/,ab=/^([^.]*)(?:\.(.+)|)$/;function bb(){return!0}function cb(){return!1}function db(){try{return z.activeElement}catch(a){}}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n._data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=n.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return typeof n===L||a&&n.event.triggered===a.type?void 0:n.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(F)||[""],h=b.length;while(h--)f=ab.exec(b[h])||[],o=q=f[1],p=(f[2]||"").split(".").sort(),o&&(j=n.event.special[o]||{},o=(e?j.delegateType:j.bindType)||o,j=n.event.special[o]||{},l=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},i),(m=g[o])||(m=g[o]=[],m.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,l):m.push(l),n.event.global[o]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.hasData(a)&&n._data(a);if(r&&(k=r.events)){b=(b||"").match(F)||[""],j=b.length;while(j--)if(h=ab.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=k[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=f=m.length;while(f--)g=m[f],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("**"!==d||!g.selector)||(m.splice(f,1),g.selector&&m.delegateCount--,l.remove&&l.remove.call(a,g));i&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete k[o])}else for(o in k)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(k)&&(delete r.handle,n._removeData(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,l,m,o=[d||z],p=j.call(b,"type")?b.type:b,q=j.call(b,"namespace")?b.namespace.split("."):[];if(h=l=d=d||z,3!==d.nodeType&&8!==d.nodeType&&!_.test(p+n.event.triggered)&&(p.indexOf(".")>=0&&(q=p.split("."),p=q.shift(),q.sort()),g=p.indexOf(":")<0&&"on"+p,b=b[n.expando]?b:new n.Event(p,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=q.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+q.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:n.makeArray(c,[b]),k=n.event.special[p]||{},e||!k.trigger||k.trigger.apply(d,c)!==!1)){if(!e&&!k.noBubble&&!n.isWindow(d)){for(i=k.delegateType||p,_.test(i+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),l=h;l===(d.ownerDocument||z)&&o.push(l.defaultView||l.parentWindow||a)}m=0;while((h=o[m++])&&!b.isPropagationStopped())b.type=m>1?i:k.bindType||p,f=(n._data(h,"events")||{})[b.type]&&n._data(h,"handle"),f&&f.apply(h,c),f=g&&h[g],f&&f.apply&&n.acceptData(h)&&(b.result=f.apply(h,c),b.result===!1&&b.preventDefault());if(b.type=p,!e&&!b.isDefaultPrevented()&&(!k._default||k._default.apply(o.pop(),c)===!1)&&n.acceptData(d)&&g&&d[p]&&!n.isWindow(d)){l=d[g],l&&(d[g]=null),n.event.triggered=p;try{d[p]()}catch(r){}n.event.triggered=void 0,l&&(d[g]=l)}return b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(n._data(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,g=0;while((e=f.handlers[g++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(e.namespace))&&(a.handleObj=e,a.data=e.data,c=((n.event.special[e.origType]||{}).handle||e.handler).apply(f.elem,i),void 0!==c&&(a.result=c)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(e=[],f=0;h>f;f++)d=b[f],c=d.selector+" ",void 0===e[c]&&(e[c]=d.needsContext?n(c,this).index(i)>=0:n.find(c,this,null,[i]).length),e[c]&&e.push(d);e.length&&g.push({elem:i,handlers:e})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a[n.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=$.test(e)?this.mouseHooks:Z.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new n.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=f.srcElement||z),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,g.filter?g.filter(a,f):a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button,g=b.fromElement;return null==a.pageX&&null!=b.clientX&&(d=a.target.ownerDocument||z,e=d.documentElement,c=d.body,a.pageX=b.clientX+(e&&e.scrollLeft||c&&c.scrollLeft||0)-(e&&e.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||c&&c.scrollTop||0)-(e&&e.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&g&&(a.relatedTarget=g===a.target?b.toElement:g),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==db()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===db()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return n.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=n.extend(new n.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?n.event.trigger(e,null,b):n.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=z.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){var d="on"+b;a.detachEvent&&(typeof a[d]===L&&(a[d]=null),a.detachEvent(d,c))},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&(a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault())?bb:cb):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={isDefaultPrevented:cb,isPropagationStopped:cb,isImmediatePropagationStopped:cb,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=bb,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=bb,a&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=bb,this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.submitBubbles||(n.event.special.submit={setup:function(){return n.nodeName(this,"form")?!1:void n.event.add(this,"click._submit keypress._submit",function(a){var b=a.target,c=n.nodeName(b,"input")||n.nodeName(b,"button")?b.form:void 0;c&&!n._data(c,"submitBubbles")&&(n.event.add(c,"submit._submit",function(a){a._submit_bubble=!0}),n._data(c,"submitBubbles",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&n.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){return n.nodeName(this,"form")?!1:void n.event.remove(this,"._submit")}}),l.changeBubbles||(n.event.special.change={setup:function(){return Y.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(n.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._just_changed=!0)}),n.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),n.event.simulate("change",this,a,!0)})),!1):void n.event.add(this,"beforeactivate._change",function(a){var b=a.target;Y.test(b.nodeName)&&!n._data(b,"changeBubbles")&&(n.event.add(b,"change._change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||n.event.simulate("change",this.parentNode,a,!0)}),n._data(b,"changeBubbles",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return n.event.remove(this,"._change"),!Y.test(this.nodeName)}}),l.focusinBubbles||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a),!0)};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=n._data(d,b);e||d.addEventListener(a,c,!0),n._data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=n._data(d,b)-1;e?n._data(d,b,e):(d.removeEventListener(a,c,!0),n._removeData(d,b))}}}),n.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(f in a)this.on(f,b,c,a[f],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=cb;else if(!d)return this;return 1===e&&(g=d,d=function(a){return n().off(a),g.apply(this,arguments)},d.guid=g.guid||(g.guid=n.guid++)),this.each(function(){n.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=cb),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});function eb(a){var b=fb.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}var fb="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gb=/ jQuery\d+="(?:null|\d+)"/g,hb=new RegExp("<(?:"+fb+")[\\s/>]","i"),ib=/^\s+/,jb=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,kb=/<([\w:]+)/,lb=/<tbody/i,mb=/<|&#?\w+;/,nb=/<(?:script|style|link)/i,ob=/checked\s*(?:[^=]|=\s*.checked.)/i,pb=/^$|\/(?:java|ecma)script/i,qb=/^true\/(.*)/,rb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,sb={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:l.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},tb=eb(z),ub=tb.appendChild(z.createElement("div"));sb.optgroup=sb.option,sb.tbody=sb.tfoot=sb.colgroup=sb.caption=sb.thead,sb.th=sb.td;function vb(a,b){var c,d,e=0,f=typeof a.getElementsByTagName!==L?a.getElementsByTagName(b||"*"):typeof a.querySelectorAll!==L?a.querySelectorAll(b||"*"):void 0;if(!f)for(f=[],c=a.childNodes||a;null!=(d=c[e]);e++)!b||n.nodeName(d,b)?f.push(d):n.merge(f,vb(d,b));return void 0===b||b&&n.nodeName(a,b)?n.merge([a],f):f}function wb(a){X.test(a.type)&&(a.defaultChecked=a.checked)}function xb(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function yb(a){return a.type=(null!==n.find.attr(a,"type"))+"/"+a.type,a}function zb(a){var b=qb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function Ab(a,b){for(var c,d=0;null!=(c=a[d]);d++)n._data(c,"globalEval",!b||n._data(b[d],"globalEval"))}function Bb(a,b){if(1===b.nodeType&&n.hasData(a)){var c,d,e,f=n._data(a),g=n._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;e>d;d++)n.event.add(b,c,h[c][d])}g.data&&(g.data=n.extend({},g.data))}}function Cb(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!l.noCloneEvent&&b[n.expando]){e=n._data(b);for(d in e.events)n.removeEvent(b,d,e.handle);b.removeAttribute(n.expando)}"script"===c&&b.text!==a.text?(yb(b).text=a.text,zb(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),l.html5Clone&&a.innerHTML&&!n.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&X.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}}n.extend({clone:function(a,b,c){var d,e,f,g,h,i=n.contains(a.ownerDocument,a);if(l.html5Clone||n.isXMLDoc(a)||!hb.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(ub.innerHTML=a.outerHTML,ub.removeChild(f=ub.firstChild)),!(l.noCloneEvent&&l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(d=vb(f),h=vb(a),g=0;null!=(e=h[g]);++g)d[g]&&Cb(e,d[g]);if(b)if(c)for(h=h||vb(a),d=d||vb(f),g=0;null!=(e=h[g]);g++)Bb(e,d[g]);else Bb(a,f);return d=vb(f,"script"),d.length>0&&Ab(d,!i&&vb(a,"script")),d=h=e=null,f},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k,m=a.length,o=eb(b),p=[],q=0;m>q;q++)if(f=a[q],f||0===f)if("object"===n.type(f))n.merge(p,f.nodeType?[f]:f);else if(mb.test(f)){h=h||o.appendChild(b.createElement("div")),i=(kb.exec(f)||["",""])[1].toLowerCase(),k=sb[i]||sb._default,h.innerHTML=k[1]+f.replace(jb,"<$1></$2>")+k[2],e=k[0];while(e--)h=h.lastChild;if(!l.leadingWhitespace&&ib.test(f)&&p.push(b.createTextNode(ib.exec(f)[0])),!l.tbody){f="table"!==i||lb.test(f)?"<table>"!==k[1]||lb.test(f)?0:h:h.firstChild,e=f&&f.childNodes.length;while(e--)n.nodeName(j=f.childNodes[e],"tbody")&&!j.childNodes.length&&f.removeChild(j)}n.merge(p,h.childNodes),h.textContent="";while(h.firstChild)h.removeChild(h.firstChild);h=o.lastChild}else p.push(b.createTextNode(f));h&&o.removeChild(h),l.appendChecked||n.grep(vb(p,"input"),wb),q=0;while(f=p[q++])if((!d||-1===n.inArray(f,d))&&(g=n.contains(f.ownerDocument,f),h=vb(o.appendChild(f),"script"),g&&Ab(h),c)){e=0;while(f=h[e++])pb.test(f.type||"")&&c.push(f)}return h=null,o},cleanData:function(a,b){for(var d,e,f,g,h=0,i=n.expando,j=n.cache,k=l.deleteExpando,m=n.event.special;null!=(d=a[h]);h++)if((b||n.acceptData(d))&&(f=d[i],g=f&&j[f])){if(g.events)for(e in g.events)m[e]?n.event.remove(d,e):n.removeEvent(d,e,g.handle);j[f]&&(delete j[f],k?delete d[i]:typeof d.removeAttribute!==L?d.removeAttribute(i):d[i]=null,c.push(f))}}}),n.fn.extend({text:function(a){return W(this,function(a){return void 0===a?n.text(this):this.empty().append((this[0]&&this[0].ownerDocument||z).createTextNode(a))},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=xb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=xb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?n.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||n.cleanData(vb(c)),c.parentNode&&(b&&n.contains(c.ownerDocument,c)&&Ab(vb(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++){1===a.nodeType&&n.cleanData(vb(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&n.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return W(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(gb,""):void 0;if(!("string"!=typeof a||nb.test(a)||!l.htmlSerialize&&hb.test(a)||!l.leadingWhitespace&&ib.test(a)||sb[(kb.exec(a)||["",""])[1].toLowerCase()])){a=a.replace(jb,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(vb(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,n.cleanData(vb(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,k=this.length,m=this,o=k-1,p=a[0],q=n.isFunction(p);if(q||k>1&&"string"==typeof p&&!l.checkClone&&ob.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(k&&(i=n.buildFragment(a,this[0].ownerDocument,!1,this),c=i.firstChild,1===i.childNodes.length&&(i=c),c)){for(g=n.map(vb(i,"script"),yb),f=g.length;k>j;j++)d=i,j!==o&&(d=n.clone(d,!0,!0),f&&n.merge(g,vb(d,"script"))),b.call(this[j],d,j);if(f)for(h=g[g.length-1].ownerDocument,n.map(g,zb),j=0;f>j;j++)d=g[j],pb.test(d.type||"")&&!n._data(d,"globalEval")&&n.contains(h,d)&&(d.src?n._evalUrl&&n._evalUrl(d.src):n.globalEval((d.text||d.textContent||d.innerHTML||"").replace(rb,"")));i=c=null}return this}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=0,e=[],g=n(a),h=g.length-1;h>=d;d++)c=d===h?this:this.clone(!0),n(g[d])[b](c),f.apply(e,c.get());return this.pushStack(e)}});var Db,Eb={};function Fb(b,c){var d=n(c.createElement(b)).appendTo(c.body),e=a.getDefaultComputedStyle?a.getDefaultComputedStyle(d[0]).display:n.css(d[0],"display");return d.detach(),e}function Gb(a){var b=z,c=Eb[a];return c||(c=Fb(a,b),"none"!==c&&c||(Db=(Db||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Db[0].contentWindow||Db[0].contentDocument).document,b.write(),b.close(),c=Fb(a,b),Db.detach()),Eb[a]=c),c}!function(){var a,b,c=z.createElement("div"),d="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;padding:0;margin:0;border:0";c.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=c.getElementsByTagName("a")[0],a.style.cssText="float:left;opacity:.5",l.opacity=/^0.5/.test(a.style.opacity),l.cssFloat=!!a.style.cssFloat,c.style.backgroundClip="content-box",c.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===c.style.backgroundClip,a=c=null,l.shrinkWrapBlocks=function(){var a,c,e,f;if(null==b){if(a=z.getElementsByTagName("body")[0],!a)return;f="border:0;width:0;height:0;position:absolute;top:0;left:-9999px",c=z.createElement("div"),e=z.createElement("div"),a.appendChild(c).appendChild(e),b=!1,typeof e.style.zoom!==L&&(e.style.cssText=d+";width:1px;padding:1px;zoom:1",e.innerHTML="<div></div>",e.firstChild.style.width="5px",b=3!==e.offsetWidth),a.removeChild(c),a=c=e=null}return b}}();var Hb=/^margin/,Ib=new RegExp("^("+T+")(?!px)[a-z%]+$","i"),Jb,Kb,Lb=/^(top|right|bottom|left)$/;a.getComputedStyle?(Jb=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)},Kb=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Jb(a),g=c?c.getPropertyValue(b)||c[b]:void 0,c&&(""!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),Ib.test(g)&&Hb.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0===g?g:g+""}):z.documentElement.currentStyle&&(Jb=function(a){return a.currentStyle},Kb=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Jb(a),g=c?c[b]:void 0,null==g&&h&&h[b]&&(g=h[b]),Ib.test(g)&&!Lb.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function Mb(a,b){return{get:function(){var c=a();if(null!=c)return c?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d,e,f,g,h=z.createElement("div"),i="border:0;width:0;height:0;position:absolute;top:0;left:-9999px",j="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;padding:0;margin:0;border:0";h.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",b=h.getElementsByTagName("a")[0],b.style.cssText="float:left;opacity:.5",l.opacity=/^0.5/.test(b.style.opacity),l.cssFloat=!!b.style.cssFloat,h.style.backgroundClip="content-box",h.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===h.style.backgroundClip,b=h=null,n.extend(l,{reliableHiddenOffsets:function(){if(null!=c)return c;var a,b,d,e=z.createElement("div"),f=z.getElementsByTagName("body")[0];if(f)return e.setAttribute("className","t"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=z.createElement("div"),a.style.cssText=i,f.appendChild(a).appendChild(e),e.innerHTML="<table><tr><td></td><td>t</td></tr></table>",b=e.getElementsByTagName("td"),b[0].style.cssText="padding:0;margin:0;border:0;display:none",d=0===b[0].offsetHeight,b[0].style.display="",b[1].style.display="none",c=d&&0===b[0].offsetHeight,f.removeChild(a),e=f=null,c},boxSizing:function(){return null==d&&k(),d},boxSizingReliable:function(){return null==e&&k(),e},pixelPosition:function(){return null==f&&k(),f},reliableMarginRight:function(){var b,c,d,e;if(null==g&&a.getComputedStyle){if(b=z.getElementsByTagName("body")[0],!b)return;c=z.createElement("div"),d=z.createElement("div"),c.style.cssText=i,b.appendChild(c).appendChild(d),e=d.appendChild(z.createElement("div")),e.style.cssText=d.style.cssText=j,e.style.marginRight=e.style.width="0",d.style.width="1px",g=!parseFloat((a.getComputedStyle(e,null)||{}).marginRight),b.removeChild(c)}return g}});function k(){var b,c,h=z.getElementsByTagName("body")[0];h&&(b=z.createElement("div"),c=z.createElement("div"),b.style.cssText=i,h.appendChild(b).appendChild(c),c.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:absolute;display:block;padding:1px;border:1px;width:4px;margin-top:1%;top:1%",n.swap(h,null!=h.style.zoom?{zoom:1}:{},function(){d=4===c.offsetWidth}),e=!0,f=!1,g=!0,a.getComputedStyle&&(f="1%"!==(a.getComputedStyle(c,null)||{}).top,e="4px"===(a.getComputedStyle(c,null)||{width:"4px"}).width),h.removeChild(b),c=h=null)}}(),n.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var Nb=/alpha\([^)]*\)/i,Ob=/opacity\s*=\s*([^)]*)/,Pb=/^(none|table(?!-c[ea]).+)/,Qb=new RegExp("^("+T+")(.*)$","i"),Rb=new RegExp("^([+-])=("+T+")","i"),Sb={position:"absolute",visibility:"hidden",display:"block"},Tb={letterSpacing:0,fontWeight:400},Ub=["Webkit","O","Moz","ms"];function Vb(a,b){if(b in a)return b;var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,e=Ub.length;while(e--)if(b=Ub[e]+c,b in a)return b;return d}function Wb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=n._data(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&V(d)&&(f[g]=n._data(d,"olddisplay",Gb(d.nodeName)))):f[g]||(e=V(d),(c&&"none"!==c||!e)&&n._data(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function Xb(a,b,c){var d=Qb.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Yb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+U[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+U[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+U[f]+"Width",!0,e))):(g+=n.css(a,"padding"+U[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+U[f]+"Width",!0,e)));return g}function Zb(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Jb(a),g=l.boxSizing()&&"border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Kb(a,b,f),(0>e||null==e)&&(e=a.style[b]),Ib.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Yb(a,b,c||(g?"border":"content"),d,f)+"px"}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Kb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":l.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;if(b=n.cssProps[h]||(n.cssProps[h]=Vb(i,h)),g=n.cssHooks[b]||n.cssHooks[h],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b];if(f=typeof c,"string"===f&&(e=Rb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(n.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||n.cssNumber[h]||(c+="px"),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i[b]="",i[b]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Vb(a.style,h)),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Kb(a,b,d)),"normal"===f&&b in Tb&&(f=Tb[b]),""===c||c?(e=parseFloat(f),c===!0||n.isNumeric(e)?e||0:f):f}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?0===a.offsetWidth&&Pb.test(n.css(a,"display"))?n.swap(a,Sb,function(){return Zb(a,b,d)}):Zb(a,b,d):void 0},set:function(a,c,d){var e=d&&Jb(a);return Xb(a,c,d?Yb(a,b,d,l.boxSizing()&&"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),l.opacity||(n.cssHooks.opacity={get:function(a,b){return Ob.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=n.isNumeric(b)?"alpha(opacity="+100*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===n.trim(f.replace(Nb,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Nb.test(f)?f.replace(Nb,e):f+" "+e)}}),n.cssHooks.marginRight=Mb(l.reliableMarginRight,function(a,b){return b?n.swap(a,{display:"inline-block"},Kb,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+U[d]+b]=f[d]||f[d-2]||f[0];return e}},Hb.test(a)||(n.cssHooks[a+b].set=Xb)}),n.fn.extend({css:function(a,b){return W(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Jb(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)
},a,b,arguments.length>1)},show:function(){return Wb(this,!0)},hide:function(){return Wb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){V(this)?n(this).show():n(this).hide()})}});function $b(a,b,c,d,e){return new $b.prototype.init(a,b,c,d,e)}n.Tween=$b,$b.prototype={constructor:$b,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=$b.propHooks[this.prop];return a&&a.get?a.get(this):$b.propHooks._default.get(this)},run:function(a){var b,c=$b.propHooks[this.prop];return this.pos=b=this.options.duration?n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):$b.propHooks._default.set(this),this}},$b.prototype.init.prototype=$b.prototype,$b.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[n.cssProps[a.prop]]||n.cssHooks[a.prop])?n.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},$b.propHooks.scrollTop=$b.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},n.fx=$b.prototype.init,n.fx.step={};var _b,ac,bc=/^(?:toggle|show|hide)$/,cc=new RegExp("^(?:([+-])=|)("+T+")([a-z%]*)$","i"),dc=/queueHooks$/,ec=[jc],fc={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=cc.exec(b),f=e&&e[3]||(n.cssNumber[a]?"":"px"),g=(n.cssNumber[a]||"px"!==f&&+d)&&cc.exec(n.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,n.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function gc(){return setTimeout(function(){_b=void 0}),_b=n.now()}function hc(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=U[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function ic(a,b,c){for(var d,e=(fc[b]||[]).concat(fc["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function jc(a,b,c){var d,e,f,g,h,i,j,k,m=this,o={},p=a.style,q=a.nodeType&&V(a),r=n._data(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,m.always(function(){m.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[p.overflow,p.overflowX,p.overflowY],j=n.css(a,"display"),k=Gb(a.nodeName),"none"===j&&(j=k),"inline"===j&&"none"===n.css(a,"float")&&(l.inlineBlockNeedsLayout&&"inline"!==k?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",l.shrinkWrapBlocks()||m.always(function(){p.overflow=c.overflow[0],p.overflowX=c.overflow[1],p.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],bc.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r[d])continue;q=!0}o[d]=r&&r[d]||n.style(a,d)}if(!n.isEmptyObject(o)){r?"hidden"in r&&(q=r.hidden):r=n._data(a,"fxshow",{}),f&&(r.hidden=!q),q?n(a).show():m.done(function(){n(a).hide()}),m.done(function(){var b;n._removeData(a,"fxshow");for(b in o)n.style(a,b,o[b])});for(d in o)g=ic(q?r[d]:0,d,m),d in r||(r[d]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function kc(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function lc(a,b,c){var d,e,f=0,g=ec.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=_b||gc(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:_b||gc(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(kc(k,j.opts.specialEasing);g>f;f++)if(d=ec[f].call(j,a,k,j.opts))return d;return n.map(k,ic,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(lc,{tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],fc[c]=fc[c]||[],fc[c].unshift(b)},prefilter:function(a,b){b?ec.unshift(a):ec.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(V).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=lc(this,n.extend({},a),f);(e||n._data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=n._data(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&dc.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=n._data(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(hc(b,!0),a,d,e)}}),n.each({slideDown:hc("show"),slideUp:hc("hide"),slideToggle:hc("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=n.timers,c=0;for(_b=n.now();c<b.length;c++)a=b[c],a()||b[c]!==a||b.splice(c--,1);b.length||n.fx.stop(),_b=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){ac||(ac=setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){clearInterval(ac),ac=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(a,b){return a=n.fx?n.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a,b,c,d,e=z.createElement("div");e.setAttribute("className","t"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=e.getElementsByTagName("a")[0],c=z.createElement("select"),d=c.appendChild(z.createElement("option")),b=e.getElementsByTagName("input")[0],a.style.cssText="top:1px",l.getSetAttribute="t"!==e.className,l.style=/top/.test(a.getAttribute("style")),l.hrefNormalized="/a"===a.getAttribute("href"),l.checkOn=!!b.value,l.optSelected=d.selected,l.enctype=!!z.createElement("form").enctype,c.disabled=!0,l.optDisabled=!d.disabled,b=z.createElement("input"),b.setAttribute("value",""),l.input=""===b.getAttribute("value"),b.value="t",b.setAttribute("type","radio"),l.radioValue="t"===b.value,a=b=c=d=e=null}();var mc=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(mc,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.text(a)}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(l.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)if(d=e[g],n.inArray(n.valHooks.option.get(d),f)>=0)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>=0:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var nc,oc,pc=n.expr.attrHandle,qc=/^(?:checked|selected)$/i,rc=l.getSetAttribute,sc=l.input;n.fn.extend({attr:function(a,b){return W(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===L?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),d=n.attrHooks[b]||(n.expr.match.bool.test(b)?oc:nc)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=n.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void n.removeAttr(a,b))},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(F);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)?sc&&rc||!qc.test(c)?a[d]=!1:a[n.camelCase("default-"+c)]=a[d]=!1:n.attr(a,c,""),a.removeAttribute(rc?c:d)},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),oc={set:function(a,b,c){return b===!1?n.removeAttr(a,c):sc&&rc||!qc.test(c)?a.setAttribute(!rc&&n.propFix[c]||c,c):a[n.camelCase("default-"+c)]=a[c]=!0,c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=pc[b]||n.find.attr;pc[b]=sc&&rc||!qc.test(b)?function(a,b,d){var e,f;return d||(f=pc[b],pc[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,pc[b]=f),e}:function(a,b,c){return c?void 0:a[n.camelCase("default-"+b)]?b.toLowerCase():null}}),sc&&rc||(n.attrHooks.value={set:function(a,b,c){return n.nodeName(a,"input")?void(a.defaultValue=b):nc&&nc.set(a,b,c)}}),rc||(nc={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},pc.id=pc.name=pc.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},n.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:nc.set},n.attrHooks.contenteditable={set:function(a,b,c){nc.set(a,""===b?!1:b,c)}},n.each(["width","height"],function(a,b){n.attrHooks[b]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),l.style||(n.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var tc=/^(?:input|select|textarea|button|object)$/i,uc=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return W(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return a=n.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(b){}})}}),n.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!n.isXMLDoc(a),f&&(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):tc.test(a.nodeName)||uc.test(a.nodeName)&&a.href?0:-1}}}}),l.hrefNormalized||n.each(["href","src"],function(a,b){n.propHooks[b]={get:function(a){return a.getAttribute(b,4)}}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this}),l.enctype||(n.propFix.enctype="encoding");var vc=/[\t\r\n\f]/g;n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j="string"==typeof a&&a;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(F)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(vc," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=n.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j=0===arguments.length||"string"==typeof a&&a;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(F)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(vc," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?n.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(n.isFunction(a)?function(c){n(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=n(this),f=a.match(F)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===L||"boolean"===c)&&(this.className&&n._data(this,"__className__",this.className),this.className=this.className||a===!1?"":n._data(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(vc," ").indexOf(b)>=0)return!0;return!1}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var wc=n.now(),xc=/\?/,yc=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;n.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=n.trim(b+"");return e&&!n.trim(e.replace(yc,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():n.error("Invalid JSON: "+b)},n.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new DOMParser,c=d.parseFromString(b,"text/xml")):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var zc,Ac,Bc=/#.*$/,Cc=/([?&])_=[^&]*/,Dc=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Ec=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Fc=/^(?:GET|HEAD)$/,Gc=/^\/\//,Hc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Ic={},Jc={},Kc="*/".concat("*");try{Ac=location.href}catch(Lc){Ac=z.createElement("a"),Ac.href="",Ac=Ac.href}zc=Hc.exec(Ac.toLowerCase())||[];function Mc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(F)||[];if(n.isFunction(c))while(d=f[e++])"+"===d.charAt(0)?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Nc(a,b,c,d){var e={},f=a===Jc;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function Oc(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(d in b)void 0!==b[d]&&((e[d]?a:c||(c={}))[d]=b[d]);return c&&n.extend(!0,a,c),a}function Pc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h[g]&&h[g].test(e)){i.unshift(g);break}if(i[0]in c)f=i[0];else{for(g in c){if(!i[0]||a.converters[g+" "+i[0]]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Qc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ac,type:"GET",isLocal:Ec.test(zc[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Kc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Oc(Oc(a,n.ajaxSettings),b):Oc(n.ajaxSettings,a)},ajaxPrefilter:Mc(Ic),ajaxTransport:Mc(Jc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=n.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?n(l):n.event,o=n.Deferred(),p=n.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!j){j={};while(b=Dc.exec(f))j[b[1].toLowerCase()]=b[2]}b=j[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?f:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return i&&i.abort(b),x(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||Ac)+"").replace(Bc,"").replace(Gc,zc[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=n.trim(k.dataType||"*").toLowerCase().match(F)||[""],null==k.crossDomain&&(c=Hc.exec(k.url.toLowerCase()),k.crossDomain=!(!c||c[1]===zc[1]&&c[2]===zc[2]&&(c[3]||("http:"===c[1]?"80":"443"))===(zc[3]||("http:"===zc[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=n.param(k.data,k.traditional)),Nc(Ic,k,b,v),2===t)return v;h=k.global,h&&0===n.active++&&n.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!Fc.test(k.type),e=k.url,k.hasContent||(k.data&&(e=k.url+=(xc.test(e)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=Cc.test(e)?e.replace(Cc,"$1_="+wc++):e+(xc.test(e)?"&":"?")+"_="+wc++)),k.ifModified&&(n.lastModified[e]&&v.setRequestHeader("If-Modified-Since",n.lastModified[e]),n.etag[e]&&v.setRequestHeader("If-None-Match",n.etag[e])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+Kc+"; q=0.01":""):k.accepts["*"]);for(d in k.headers)v.setRequestHeader(d,k.headers[d]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(d in{success:1,error:1,complete:1})v[d](k[d]);if(i=Nc(Jc,k,b,v)){v.readyState=1,h&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,i.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,c,d){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),i=void 0,f=d||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,c&&(u=Pc(k,v,c)),u=Qc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(n.lastModified[e]=w),w=v.getResponseHeader("etag"),w&&(n.etag[e]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?o.resolveWith(l,[r,x,v]):o.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,h&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),h&&(m.trigger("ajaxComplete",[v,k]),--n.active||n.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){if(n.isFunction(a))return this.each(function(b){n(this).wrapAll(a.call(this,b))});if(this[0]){var b=n(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return this.each(n.isFunction(a)?function(b){n(this).wrapInner(a.call(this,b))}:function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0||!l.reliableHiddenOffsets()&&"none"===(a.style&&a.style.display||n.css(a,"display"))},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var Rc=/%20/g,Sc=/\[\]$/,Tc=/\r?\n/g,Uc=/^(?:submit|button|image|reset|file)$/i,Vc=/^(?:input|select|textarea|keygen)/i;function Wc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||Sc.test(a)?d(a,e):Wc(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Wc(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Wc(c,a[c],b,e);return d.join("&").replace(Rc,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Vc.test(this.nodeName)&&!Uc.test(a)&&(this.checked||!X.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(Tc,"\r\n")}}):{name:b.name,value:c.replace(Tc,"\r\n")}}).get()}}),n.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return!this.isLocal&&/^(get|post|head|put|delete|options)$/i.test(this.type)&&$c()||_c()}:$c;var Xc=0,Yc={},Zc=n.ajaxSettings.xhr();a.ActiveXObject&&n(a).on("unload",function(){for(var a in Yc)Yc[a](void 0,!0)}),l.cors=!!Zc&&"withCredentials"in Zc,Zc=l.ajax=!!Zc,Zc&&n.ajaxTransport(function(a){if(!a.crossDomain||l.cors){var b;return{send:function(c,d){var e,f=a.xhr(),g=++Xc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)void 0!==c[e]&&f.setRequestHeader(e,c[e]+"");f.send(a.hasContent&&a.data||null),b=function(c,e){var h,i,j;if(b&&(e||4===f.readyState))if(delete Yc[g],b=void 0,f.onreadystatechange=n.noop,e)4!==f.readyState&&f.abort();else{j={},h=f.status,"string"==typeof f.responseText&&(j.text=f.responseText);try{i=f.statusText}catch(k){i=""}h||!a.isLocal||a.crossDomain?1223===h&&(h=204):h=j.text?200:404}j&&d(h,i,j,f.getAllResponseHeaders())},a.async?4===f.readyState?setTimeout(b):f.onreadystatechange=Yc[g]=b:b()},abort:function(){b&&b(void 0,!0)}}}});function $c(){try{return new a.XMLHttpRequest}catch(b){}}function _c(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=z.head||n("head")[0]||z.documentElement;return{send:function(d,e){b=z.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||e(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var ad=[],bd=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=ad.pop()||n.expando+"_"+wc++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(bd.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&bd.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(bd,"$1"+e):b.jsonp!==!1&&(b.url+=(xc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,ad.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||z;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=n.buildFragment([a],b,e),e&&e.length&&n(e).remove(),n.merge([],d.childNodes))};var cd=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&cd)return cd.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=a.slice(h,a.length),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(f="POST"),g.length>0&&n.ajax({url:a,type:f,dataType:"html",data:b}).done(function(a){e=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,e||[a.responseText,b,a])}),this},n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};var dd=a.document.documentElement;function ed(a){return n.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&n.inArray("auto",[f,i])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this[0],f=e&&e.ownerDocument;if(f)return b=f.documentElement,n.contains(b,e)?(typeof e.getBoundingClientRect!==L&&(d=e.getBoundingClientRect()),c=ed(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this[0]){var a,b,c={top:0,left:0},d=this[0];return"fixed"===n.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(c=a.offset()),c.top+=n.css(a[0],"borderTopWidth",!0),c.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-c.top-n.css(d,"marginTop",!0),left:b.left-c.left-n.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||dd;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||dd})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);n.fn[a]=function(d){return W(this,function(a,d,e){var f=ed(a);return void 0===e?f?b in f?f[b]:f.document.documentElement[d]:a[d]:void(f?f.scrollTo(c?n(f).scrollLeft():e,c?e:n(f).scrollTop()):a[d]=e)},a,d,arguments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Mb(l.pixelPosition,function(a,c){return c?(c=Kb(a,b),Ib.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return W(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var fd=a.jQuery,gd=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=gd),b&&a.jQuery===n&&(a.jQuery=fd),n},typeof b===L&&(a.jQuery=a.$=n),n});
;
/* END /DuttiNEWStorefrontAssetStore/js/lib/jquery-1.11.0.min.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/jquery.placeholder.js (en_US) */
/*! http://mths.be/placeholder v2.0.8 by @mathias */
;(function(window, document, $) {

    // Opera Mini v7 doesnt support placeholder although its DOM seems to indicate so
    var isOperaMini = Object.prototype.toString.call(window.operamini) == '[object OperaMini]';
    var isInputSupported = 'placeholder' in document.createElement('input') && !isOperaMini;
    var isTextareaSupported = 'placeholder' in document.createElement('textarea') && !isOperaMini;
    var prototype = $.fn;
    var valHooks = $.valHooks;
    var propHooks = $.propHooks;
    var hooks;
    var placeholder;

    if (isInputSupported && isTextareaSupported) {

        placeholder = prototype.placeholder = function() {
            return this;
        };

        placeholder.input = placeholder.textarea = true;

    } else {

        placeholder = prototype.placeholder = function() {
            var $this = this;
            $this
                .filter((isInputSupported ? 'textarea' : ':input') + '[placeholder]')
                .not('.placeholder')
                .bind({
                    'focus.placeholder': clearPlaceholder,
                    'blur.placeholder': setPlaceholder
                })
                .data('placeholder-enabled', true)
                .trigger('blur.placeholder');
            return $this;
        };

        placeholder.input = isInputSupported;
        placeholder.textarea = isTextareaSupported;

        hooks = {
            'get': function(element) {
                var $element = $(element);

                var $passwordInput = $element.data('placeholder-password');
                if ($passwordInput) {
                    return $passwordInput[0].value;
                }

                return $element.data('placeholder-enabled') && $element.hasClass('placeholder') ? '' : element.value;
            },
            'set': function(element, value) {
                var $element = $(element);

                var $passwordInput = $element.data('placeholder-password');
                if ($passwordInput) {
                    return $passwordInput[0].value = value;
                }

                if (!$element.data('placeholder-enabled')) {
                    return element.value = value;
                }
                if (value == '') {
                    element.value = value;
                    // Issue #56: Setting the placeholder causes problems if the element continues to have focus.
                    if (element != safeActiveElement()) {
                        // We can't use `triggerHandler` here because of dummy text/password inputs :(
                        setPlaceholder.call(element);
                    }
                } else if ($element.hasClass('placeholder')) {
                    clearPlaceholder.call(element, true, value) || (element.value = value);
                } else {
                    element.value = value;
                }
                // `set` can not return `undefined`; see http://jsapi.info/jquery/1.7.1/val#L2363
                return $element;
            }
        };

        if (!isInputSupported) {
            valHooks.input = hooks;
            propHooks.value = hooks;
        }
        if (!isTextareaSupported) {
            valHooks.textarea = hooks;
            propHooks.value = hooks;
        }

        $(function() {
            // Look for forms
            $(document).delegate('form', 'submit.placeholder', function() {
                // Clear the placeholder values so they don't get submitted
                var $inputs = $('.placeholder', this).each(clearPlaceholder);
                setTimeout(function() {
                    $inputs.each(setPlaceholder);
                }, 10);
            });
        });

        // Clear placeholder values upon page reload
        $(window).bind('beforeunload.placeholder', function() {
            $('.placeholder').each(function() {
                this.value = '';
            });
        });

    }

    function args(elem) {
        // Return an object of element attributes
        var newAttrs = {};
        var rinlinejQuery = /^jQuery\d+$/;
        $.each(elem.attributes, function(i, attr) {
            if (attr.specified && !rinlinejQuery.test(attr.name)) {
                newAttrs[attr.name] = attr.value;
            }
        });
        return newAttrs;
    }

    function clearPlaceholder(event, value) {
        var input = this;
        var $input = $(input);
        if (input.value == $input.attr('placeholder') && $input.hasClass('placeholder')) {
            if ($input.data('placeholder-password')) {
                $input = $input.hide().next().show().attr('id', $input.removeAttr('id').data('placeholder-id'));
                // If `clearPlaceholder` was called from `$.valHooks.input.set`
                if (event === true) {
                    return $input[0].value = value;
                }
                $input.focus();
            } else {
                input.value = '';
                $input.removeClass('placeholder');
                input == safeActiveElement() && input.select();
            }
        }
    }

    function setPlaceholder() {
        var $replacement;
        var input = this;
        var $input = $(input);
        var id = this.id;
        if (input.value == '') {
            if (input.type == 'password') {
                if (!$input.data('placeholder-textinput')) {
                    try {
                        $replacement = $input.clone().attr({ 'type': 'text' });
                    } catch(e) {
                        $replacement = $('<input>').attr($.extend(args(this), { 'type': 'text' }));
                    }
                    $replacement
                        .removeAttr('name')
                        .data({
                            'placeholder-password': $input,
                            'placeholder-id': id
                        })
                        .bind('focus.placeholder', clearPlaceholder);
                    $input
                        .data({
                            'placeholder-textinput': $replacement,
                            'placeholder-id': id
                        })
                        .before($replacement);
                }
                $input = $input.removeAttr('id').hide().prev().attr('id', id).show();
                // Note: `$input[0] != input` now!
            }
            $input.addClass('placeholder');
            $input[0].value = $input.attr('placeholder');
        } else {
            $input.removeClass('placeholder');
        }
    }

    function safeActiveElement() {
        // Avoid IE9 `document.activeElement` of death
        // https://github.com/mathiasbynens/jquery-placeholder/pull/99
        try {
            return document.activeElement;
        } catch (exception) {}
    }

}(this, document, jQuery));
;
/* END /DuttiNEWStorefrontAssetStore/js/lib/jquery.placeholder.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/easyxdm/easyXDM.min.js (en_US) */
/**
 * easyXDM
 * http://easyxdm.net/
 * Copyright(c) 2009-2011, yvind Sean Kinsey, oyvind@kinsey.no.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
(function(N,d,p,K,k,H){var b=this;var n=Math.floor(Math.random()*10000);var q=Function.prototype;var Q=/^((http.?:)\/\/([^:\/\s]+)(:\d+)*)/;var R=/[\-\w]+\/\.\.\//;var F=/([^:])\/\//g;var I="";var o={};var M=N.easyXDM;var U="easyXDM_";var E;var y=false;var i;var h;function C(X,Z){var Y=typeof X[Z];return Y=="function"||(!!(Y=="object"&&X[Z]))||Y=="unknown"}function u(X,Y){return !!(typeof(X[Y])=="object"&&X[Y])}function r(X){return Object.prototype.toString.call(X)==="[object Array]"}function c(){try{var X=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");i=Array.prototype.slice.call(X.GetVariable("$version").match(/(\d+),(\d+),(\d+),(\d+)/),1);h=parseInt(i[0],10)>9&&parseInt(i[1],10)>0;X=null;return true}catch(Y){return false}}var v,x;if(C(N,"addEventListener")){v=function(Z,X,Y){Z.addEventListener(X,Y,false)};x=function(Z,X,Y){Z.removeEventListener(X,Y,false)}}else{if(C(N,"attachEvent")){v=function(X,Z,Y){X.attachEvent("on"+Z,Y)};x=function(X,Z,Y){X.detachEvent("on"+Z,Y)}}else{throw new Error("Browser not supported")}}var W=false,J=[],L;if("readyState" in d){L=d.readyState;W=L=="complete"||(~navigator.userAgent.indexOf("AppleWebKit/")&&(L=="loaded"||L=="interactive"))}else{W=!!d.body}function s(){if(W){return}W=true;for(var X=0;X<J.length;X++){J[X]()}J.length=0}if(!W){if(C(N,"addEventListener")){v(d,"DOMContentLoaded",s)}else{v(d,"readystatechange",function(){if(d.readyState=="complete"){s()}});if(d.documentElement.doScroll&&N===top){var g=function(){if(W){return}try{d.documentElement.doScroll("left")}catch(X){K(g,1);return}s()};g()}}v(N,"load",s)}function G(Y,X){if(W){Y.call(X);return}J.push(function(){Y.call(X)})}function m(){var Z=parent;if(I!==""){for(var X=0,Y=I.split(".");X<Y.length;X++){Z=Z[Y[X]]}}return Z.easyXDM}function e(X){N.easyXDM=M;I=X;if(I){U="easyXDM_"+I.replace(".","_")+"_"}return o}function z(X){return X.match(Q)[3]}function f(X){return X.match(Q)[4]||""}function j(Z){var X=Z.toLowerCase().match(Q);var aa=X[2],ab=X[3],Y=X[4]||"";if((aa=="http:"&&Y==":80")||(aa=="https:"&&Y==":443")){Y=""}return aa+"//"+ab+Y}function B(X){X=X.replace(F,"$1/");if(!X.match(/^(http||https):\/\//)){var Y=(X.substring(0,1)==="/")?"":p.pathname;if(Y.substring(Y.length-1)!=="/"){Y=Y.substring(0,Y.lastIndexOf("/")+1)}X=p.protocol+"//"+p.host+Y+X}while(R.test(X)){X=X.replace(R,"")}return X}function P(X,aa){var ac="",Z=X.indexOf("#");if(Z!==-1){ac=X.substring(Z);X=X.substring(0,Z)}var ab=[];for(var Y in aa){if(aa.hasOwnProperty(Y)){ab.push(Y+"="+H(aa[Y]))}}return X+(y?"#":(X.indexOf("?")==-1?"?":"&"))+ab.join("&")+ac}var S=(function(X){X=X.substring(1).split("&");var Z={},aa,Y=X.length;while(Y--){aa=X[Y].split("=");Z[aa[0]]=k(aa[1])}return Z}(/xdm_e=/.test(p.search)?p.search:p.hash));function t(X){return typeof X==="undefined"}var O=function(){var Y={};var Z={a:[1,2,3]},X='{"a":[1,2,3]}';if(typeof JSON!="undefined"&&typeof JSON.stringify==="function"&&JSON.stringify(Z).replace((/\s/g),"")===X){return JSON}if(Object.toJSON){if(Object.toJSON(Z).replace((/\s/g),"")===X){Y.stringify=Object.toJSON}}if(typeof String.prototype.evalJSON==="function"){Z=X.evalJSON();if(Z.a&&Z.a.length===3&&Z.a[2]===3){Y.parse=function(aa){return aa.evalJSON()}}}if(Y.stringify&&Y.parse){O=function(){return Y};return Y}return null};function T(X,Y,Z){var ab;for(var aa in Y){if(Y.hasOwnProperty(aa)){if(aa in X){ab=Y[aa];if(typeof ab==="object"){T(X[aa],ab,Z)}else{if(!Z){X[aa]=Y[aa]}}}else{X[aa]=Y[aa]}}}return X}function a(){var Y=d.body.appendChild(d.createElement("form")),X=Y.appendChild(d.createElement("input"));X.name=U+"TEST"+n;E=X!==Y.elements[X.name];d.body.removeChild(Y)}function A(X){if(t(E)){a()}var Z;if(E){Z=d.createElement('<iframe name="'+X.props.name+'"/>')}else{Z=d.createElement("IFRAME");Z.name=X.props.name}Z.id=Z.name=X.props.name;delete X.props.name;if(X.onLoad){v(Z,"load",X.onLoad)}if(typeof X.container=="string"){X.container=d.getElementById(X.container)}if(!X.container){T(Z.style,{position:"absolute",top:"-2000px"});X.container=d.body}var Y=X.props.src;delete X.props.src;T(Z,X.props);Z.border=Z.frameBorder=0;Z.allowTransparency=true;X.container.appendChild(Z);Z.src=Y;X.props.src=Y;return Z}function V(aa,Z){if(typeof aa=="string"){aa=[aa]}var Y,X=aa.length;while(X--){Y=aa[X];Y=new RegExp(Y.substr(0,1)=="^"?Y:("^"+Y.replace(/(\*)/g,".$1").replace(/\?/g,".")+"$"));if(Y.test(Z)){return true}}return false}function l(Z){var ae=Z.protocol,Y;Z.isHost=Z.isHost||t(S.xdm_p);y=Z.hash||false;if(!Z.props){Z.props={}}if(!Z.isHost){Z.channel=S.xdm_c;Z.secret=S.xdm_s;Z.remote=S.xdm_e;ae=S.xdm_p;if(Z.acl&&!V(Z.acl,Z.remote)){throw new Error("Access denied for "+Z.remote)}}else{Z.remote=B(Z.remote);Z.channel=Z.channel||"default"+n++;Z.secret=Math.random().toString(16).substring(2);if(t(ae)){if(j(p.href)==j(Z.remote)){ae="4"}else{if(C(N,"postMessage")||C(d,"postMessage")){ae="1"}else{if(Z.swf&&C(N,"ActiveXObject")&&c()){ae="6"}else{if(navigator.product==="Gecko"&&"frameElement" in N&&navigator.userAgent.indexOf("WebKit")==-1){ae="5"}else{if(Z.remoteHelper){Z.remoteHelper=B(Z.remoteHelper);ae="2"}else{ae="0"}}}}}}}Z.protocol=ae;switch(ae){case"0":T(Z,{interval:100,delay:2000,useResize:true,useParent:false,usePolling:false},true);if(Z.isHost){if(!Z.local){var ac=p.protocol+"//"+p.host,X=d.body.getElementsByTagName("img"),ad;var aa=X.length;while(aa--){ad=X[aa];if(ad.src.substring(0,ac.length)===ac){Z.local=ad.src;break}}if(!Z.local){Z.local=N}}var ab={xdm_c:Z.channel,xdm_p:0};if(Z.local===N){Z.usePolling=true;Z.useParent=true;Z.local=p.protocol+"//"+p.host+p.pathname+p.search;ab.xdm_e=Z.local;ab.xdm_pa=1}else{ab.xdm_e=B(Z.local)}if(Z.container){Z.useResize=false;ab.xdm_po=1}Z.remote=P(Z.remote,ab)}else{T(Z,{channel:S.xdm_c,remote:S.xdm_e,useParent:!t(S.xdm_pa),usePolling:!t(S.xdm_po),useResize:Z.useParent?false:Z.useResize})}Y=[new o.stack.HashTransport(Z),new o.stack.ReliableBehavior({}),new o.stack.QueueBehavior({encode:true,maxLength:4000-Z.remote.length}),new o.stack.VerifyBehavior({initiate:Z.isHost})];break;case"1":Y=[new o.stack.PostMessageTransport(Z)];break;case"2":Y=[new o.stack.NameTransport(Z),new o.stack.QueueBehavior(),new o.stack.VerifyBehavior({initiate:Z.isHost})];break;case"3":Y=[new o.stack.NixTransport(Z)];break;case"4":Y=[new o.stack.SameOriginTransport(Z)];break;case"5":Y=[new o.stack.FrameElementTransport(Z)];break;case"6":if(!i){c()}Y=[new o.stack.FlashTransport(Z)];break}Y.push(new o.stack.QueueBehavior({lazy:Z.lazy,remove:true}));return Y}function D(aa){var ab,Z={incoming:function(ad,ac){this.up.incoming(ad,ac)},outgoing:function(ac,ad){this.down.outgoing(ac,ad)},callback:function(ac){this.up.callback(ac)},init:function(){this.down.init()},destroy:function(){this.down.destroy()}};for(var Y=0,X=aa.length;Y<X;Y++){ab=aa[Y];T(ab,Z,true);if(Y!==0){ab.down=aa[Y-1]}if(Y!==X-1){ab.up=aa[Y+1]}}return ab}function w(X){X.up.down=X.down;X.down.up=X.up;X.up=X.down=null}T(o,{version:"2.4.15.118",query:S,stack:{},apply:T,getJSONObject:O,whenReady:G,noConflict:e});o.DomHelper={on:v,un:x,requiresJSON:function(X){if(!u(N,"JSON")){d.write('<script type="text/javascript" src="'+X+'"><\/script>')}}};(function(){var X={};o.Fn={set:function(Y,Z){X[Y]=Z},get:function(Z,Y){var aa=X[Z];if(Y){delete X[Z]}return aa}}}());o.Socket=function(Y){var X=D(l(Y).concat([{incoming:function(ab,aa){Y.onMessage(ab,aa)},callback:function(aa){if(Y.onReady){Y.onReady(aa)}}}])),Z=j(Y.remote);this.origin=j(Y.remote);this.destroy=function(){X.destroy()};this.postMessage=function(aa){X.outgoing(aa,Z)};X.init()};o.Rpc=function(Z,Y){if(Y.local){for(var ab in Y.local){if(Y.local.hasOwnProperty(ab)){var aa=Y.local[ab];if(typeof aa==="function"){Y.local[ab]={method:aa}}}}}var X=D(l(Z).concat([new o.stack.RpcBehavior(this,Y),{callback:function(ac){if(Z.onReady){Z.onReady(ac)}}}]));this.origin=j(Z.remote);this.destroy=function(){X.destroy()};X.init()};o.stack.SameOriginTransport=function(Y){var Z,ab,aa,X;return(Z={outgoing:function(ad,ae,ac){aa(ad);if(ac){ac()}},destroy:function(){if(ab){ab.parentNode.removeChild(ab);ab=null}},onDOMReady:function(){X=j(Y.remote);if(Y.isHost){T(Y.props,{src:P(Y.remote,{xdm_e:p.protocol+"//"+p.host+p.pathname,xdm_c:Y.channel,xdm_p:4}),name:U+Y.channel+"_provider"});ab=A(Y);o.Fn.set(Y.channel,function(ac){aa=ac;K(function(){Z.up.callback(true)},0);return function(ad){Z.up.incoming(ad,X)}})}else{aa=m().Fn.get(Y.channel,true)(function(ac){Z.up.incoming(ac,X)});K(function(){Z.up.callback(true)},0)}},init:function(){G(Z.onDOMReady,Z)}})};o.stack.FlashTransport=function(aa){var ac,X,ab,ad,Y,ae;function af(ah,ag){K(function(){ac.up.incoming(ah,ad)},0)}function Z(ah){var ag=aa.swf+"?host="+aa.isHost;var aj="easyXDM_swf_"+Math.floor(Math.random()*10000);o.Fn.set("flash_loaded"+ah.replace(/[\-.]/g,"_"),function(){o.stack.FlashTransport[ah].swf=Y=ae.firstChild;var ak=o.stack.FlashTransport[ah].queue;for(var al=0;al<ak.length;al++){ak[al]()}ak.length=0});if(aa.swfContainer){ae=(typeof aa.swfContainer=="string")?d.getElementById(aa.swfContainer):aa.swfContainer}else{ae=d.createElement("div");T(ae.style,h&&aa.swfNoThrottle?{height:"20px",width:"20px",position:"fixed",right:0,top:0}:{height:"1px",width:"1px",position:"absolute",overflow:"hidden",right:0,top:0});d.body.appendChild(ae)}var ai="callback=flash_loaded"+ah.replace(/[\-.]/g,"_")+"&proto="+b.location.protocol+"&domain="+z(b.location.href)+"&port="+f(b.location.href)+"&ns="+I;ae.innerHTML="<object height='20' width='20' type='application/x-shockwave-flash' id='"+aj+"' data='"+ag+"'><param name='allowScriptAccess' value='always'></param><param name='wmode' value='transparent'><param name='movie' value='"+ag+"'></param><param name='flashvars' value='"+ai+"'></param><embed type='application/x-shockwave-flash' FlashVars='"+ai+"' allowScriptAccess='always' wmode='transparent' src='"+ag+"' height='1' width='1'></embed></object>"}return(ac={outgoing:function(ah,ai,ag){Y.postMessage(aa.channel,ah.toString());if(ag){ag()}},destroy:function(){try{Y.destroyChannel(aa.channel)}catch(ag){}Y=null;if(X){X.parentNode.removeChild(X);X=null}},onDOMReady:function(){ad=aa.remote;o.Fn.set("flash_"+aa.channel+"_init",function(){K(function(){ac.up.callback(true)})});o.Fn.set("flash_"+aa.channel+"_onMessage",af);aa.swf=B(aa.swf);var ah=z(aa.swf);var ag=function(){o.stack.FlashTransport[ah].init=true;Y=o.stack.FlashTransport[ah].swf;Y.createChannel(aa.channel,aa.secret,j(aa.remote),aa.isHost);if(aa.isHost){if(h&&aa.swfNoThrottle){T(aa.props,{position:"fixed",right:0,top:0,height:"20px",width:"20px"})}T(aa.props,{src:P(aa.remote,{xdm_e:j(p.href),xdm_c:aa.channel,xdm_p:6,xdm_s:aa.secret}),name:U+aa.channel+"_provider"});X=A(aa)}};if(o.stack.FlashTransport[ah]&&o.stack.FlashTransport[ah].init){ag()}else{if(!o.stack.FlashTransport[ah]){o.stack.FlashTransport[ah]={queue:[ag]};Z(ah)}else{o.stack.FlashTransport[ah].queue.push(ag)}}},init:function(){G(ac.onDOMReady,ac)}})};o.stack.PostMessageTransport=function(aa){var ac,ad,Y,Z;function X(ae){if(ae.origin){return j(ae.origin)}if(ae.uri){return j(ae.uri)}if(ae.domain){return p.protocol+"//"+ae.domain}throw"Unable to retrieve the origin of the event"}function ab(af){var ae=X(af);if(ae==Z&&af.data.substring(0,aa.channel.length+1)==aa.channel+" "){ac.up.incoming(af.data.substring(aa.channel.length+1),ae)}}return(ac={outgoing:function(af,ag,ae){Y.postMessage(aa.channel+" "+af,ag||Z);if(ae){ae()}},destroy:function(){x(N,"message",ab);if(ad){Y=null;ad.parentNode.removeChild(ad);ad=null}},onDOMReady:function(){Z=j(aa.remote);if(aa.isHost){var ae=function(af){if(af.data==aa.channel+"-ready"){Y=("postMessage" in ad.contentWindow)?ad.contentWindow:ad.contentWindow.document;x(N,"message",ae);v(N,"message",ab);K(function(){ac.up.callback(true)},0)}};v(N,"message",ae);T(aa.props,{src:P(aa.remote,{xdm_e:j(p.href),xdm_c:aa.channel,xdm_p:1}),name:U+aa.channel+"_provider"});ad=A(aa)}else{v(N,"message",ab);Y=("postMessage" in N.parent)?N.parent:N.parent.document;Y.postMessage(aa.channel+"-ready",Z);K(function(){ac.up.callback(true)},0)}},init:function(){G(ac.onDOMReady,ac)}})};o.stack.FrameElementTransport=function(Y){var Z,ab,aa,X;return(Z={outgoing:function(ad,ae,ac){aa.call(this,ad);if(ac){ac()}},destroy:function(){if(ab){ab.parentNode.removeChild(ab);ab=null}},onDOMReady:function(){X=j(Y.remote);if(Y.isHost){T(Y.props,{src:P(Y.remote,{xdm_e:j(p.href),xdm_c:Y.channel,xdm_p:5}),name:U+Y.channel+"_provider"});ab=A(Y);ab.fn=function(ac){delete ab.fn;aa=ac;K(function(){Z.up.callback(true)},0);return function(ad){Z.up.incoming(ad,X)}}}else{if(d.referrer&&j(d.referrer)!=S.xdm_e){N.top.location=S.xdm_e}aa=N.frameElement.fn(function(ac){Z.up.incoming(ac,X)});Z.up.callback(true)}},init:function(){G(Z.onDOMReady,Z)}})};o.stack.NameTransport=function(ab){var ac;var ae,ai,aa,ag,ah,Y,X;function af(al){var ak=ab.remoteHelper+(ae?"#_3":"#_2")+ab.channel;ai.contentWindow.sendMessage(al,ak)}function ad(){if(ae){if(++ag===2||!ae){ac.up.callback(true)}}else{af("ready");ac.up.callback(true)}}function aj(ak){ac.up.incoming(ak,Y)}function Z(){if(ah){K(function(){ah(true)},0)}}return(ac={outgoing:function(al,am,ak){ah=ak;af(al)},destroy:function(){ai.parentNode.removeChild(ai);ai=null;if(ae){aa.parentNode.removeChild(aa);aa=null}},onDOMReady:function(){ae=ab.isHost;ag=0;Y=j(ab.remote);ab.local=B(ab.local);if(ae){o.Fn.set(ab.channel,function(al){if(ae&&al==="ready"){o.Fn.set(ab.channel,aj);ad()}});X=P(ab.remote,{xdm_e:ab.local,xdm_c:ab.channel,xdm_p:2});T(ab.props,{src:X+"#"+ab.channel,name:U+ab.channel+"_provider"});aa=A(ab)}else{ab.remoteHelper=ab.remote;o.Fn.set(ab.channel,aj)}ai=A({props:{src:ab.local+"#_4"+ab.channel},onLoad:function ak(){var al=ai||this;x(al,"load",ak);o.Fn.set(ab.channel+"_load",Z);(function am(){if(typeof al.contentWindow.sendMessage=="function"){ad()}else{K(am,50)}}())}})},init:function(){G(ac.onDOMReady,ac)}})};o.stack.HashTransport=function(Z){var ac;var ah=this,af,aa,X,ad,am,ab,al;var ag,Y;function ak(ao){if(!al){return}var an=Z.remote+"#"+(am++)+"_"+ao;((af||!ag)?al.contentWindow:al).location=an}function ae(an){ad=an;ac.up.incoming(ad.substring(ad.indexOf("_")+1),Y)}function aj(){if(!ab){return}var an=ab.location.href,ap="",ao=an.indexOf("#");if(ao!=-1){ap=an.substring(ao)}if(ap&&ap!=ad){ae(ap)}}function ai(){aa=setInterval(aj,X)}return(ac={outgoing:function(an,ao){ak(an)},destroy:function(){N.clearInterval(aa);if(af||!ag){al.parentNode.removeChild(al)}al=null},onDOMReady:function(){af=Z.isHost;X=Z.interval;ad="#"+Z.channel;am=0;ag=Z.useParent;Y=j(Z.remote);if(af){Z.props={src:Z.remote,name:U+Z.channel+"_provider"};if(ag){Z.onLoad=function(){ab=N;ai();ac.up.callback(true)}}else{var ap=0,an=Z.delay/50;(function ao(){if(++ap>an){throw new Error("Unable to reference listenerwindow")}try{ab=al.contentWindow.frames[U+Z.channel+"_consumer"]}catch(aq){}if(ab){ai();ac.up.callback(true)}else{K(ao,50)}}())}al=A(Z)}else{ab=N;ai();if(ag){al=parent;ac.up.callback(true)}else{T(Z,{props:{src:Z.remote+"#"+Z.channel+new Date(),name:U+Z.channel+"_consumer"},onLoad:function(){ac.up.callback(true)}});al=A(Z)}}},init:function(){G(ac.onDOMReady,ac)}})};o.stack.ReliableBehavior=function(Y){var aa,ac;var ab=0,X=0,Z="";return(aa={incoming:function(af,ad){var ae=af.indexOf("_"),ag=af.substring(0,ae).split(",");af=af.substring(ae+1);if(ag[0]==ab){Z="";if(ac){ac(true)}}if(af.length>0){aa.down.outgoing(ag[1]+","+ab+"_"+Z,ad);if(X!=ag[1]){X=ag[1];aa.up.incoming(af,ad)}}},outgoing:function(af,ad,ae){Z=af;ac=ae;aa.down.outgoing(X+","+(++ab)+"_"+af,ad)}})};o.stack.QueueBehavior=function(Z){var ac,ad=[],ag=true,aa="",af,X=0,Y=false,ab=false;function ae(){if(Z.remove&&ad.length===0){w(ac);return}if(ag||ad.length===0||af){return}ag=true;var ah=ad.shift();ac.down.outgoing(ah.data,ah.origin,function(ai){ag=false;if(ah.callback){K(function(){ah.callback(ai)},0)}ae()})}return(ac={init:function(){if(t(Z)){Z={}}if(Z.maxLength){X=Z.maxLength;ab=true}if(Z.lazy){Y=true}else{ac.down.init()}},callback:function(ai){ag=false;var ah=ac.up;ae();ah.callback(ai)},incoming:function(ak,ai){if(ab){var aj=ak.indexOf("_"),ah=parseInt(ak.substring(0,aj),10);aa+=ak.substring(aj+1);if(ah===0){if(Z.encode){aa=k(aa)}ac.up.incoming(aa,ai);aa=""}}else{ac.up.incoming(ak,ai)}},outgoing:function(al,ai,ak){if(Z.encode){al=H(al)}var ah=[],aj;if(ab){while(al.length!==0){aj=al.substring(0,X);al=al.substring(aj.length);ah.push(aj)}while((aj=ah.shift())){ad.push({data:ah.length+"_"+aj,origin:ai,callback:ah.length===0?ak:null})}}else{ad.push({data:al,origin:ai,callback:ak})}if(Y){ac.down.init()}else{ae()}},destroy:function(){af=true;ac.down.destroy()}})};o.stack.VerifyBehavior=function(ab){var ac,aa,Y,Z=false;function X(){aa=Math.random().toString(16).substring(2);ac.down.outgoing(aa)}return(ac={incoming:function(af,ad){var ae=af.indexOf("_");if(ae===-1){if(af===aa){ac.up.callback(true)}else{if(!Y){Y=af;if(!ab.initiate){X()}ac.down.outgoing(af)}}}else{if(af.substring(0,ae)===Y){ac.up.incoming(af.substring(ae+1),ad)}}},outgoing:function(af,ad,ae){ac.down.outgoing(aa+"_"+af,ad,ae)},callback:function(ad){if(ab.initiate){X()}}})};o.stack.RpcBehavior=function(ad,Y){var aa,af=Y.serializer||O();var ae=0,ac={};function X(ag){ag.jsonrpc="2.0";aa.down.outgoing(af.stringify(ag))}function ab(ag,ai){var ah=Array.prototype.slice;return function(){var aj=arguments.length,al,ak={method:ai};if(aj>0&&typeof arguments[aj-1]==="function"){if(aj>1&&typeof arguments[aj-2]==="function"){al={success:arguments[aj-2],error:arguments[aj-1]};ak.params=ah.call(arguments,0,aj-2)}else{al={success:arguments[aj-1]};ak.params=ah.call(arguments,0,aj-1)}ac[""+(++ae)]=al;ak.id=ae}else{ak.params=ah.call(arguments,0)}if(ag.namedParams&&ak.params.length===1){ak.params=ak.params[0]}X(ak)}}function Z(an,am,ai,al){if(!ai){if(am){X({id:am,error:{code:-32601,message:"Procedure not found."}})}return}var ak,ah;if(am){ak=function(ao){ak=q;X({id:am,result:ao})};ah=function(ao,ap){ah=q;var aq={id:am,error:{code:-32099,message:ao}};if(ap){aq.error.data=ap}X(aq)}}else{ak=ah=q}if(!r(al)){al=[al]}try{var ag=ai.method.apply(ai.scope,al.concat([ak,ah]));if(!t(ag)){ak(ag)}}catch(aj){ah(aj.message)}}return(aa={incoming:function(ah,ag){var ai=af.parse(ah);if(ai.method){if(Y.handle){Y.handle(ai,X)}else{Z(ai.method,ai.id,Y.local[ai.method],ai.params)}}else{var aj=ac[ai.id];if(ai.error){if(aj.error){aj.error(ai.error)}}else{if(aj.success){aj.success(ai.result)}}delete ac[ai.id]}},init:function(){if(Y.remote){for(var ag in Y.remote){if(Y.remote.hasOwnProperty(ag)){ad[ag]=ab(Y.remote[ag],ag)}}}aa.down.init()},destroy:function(){for(var ag in Y.remote){if(Y.remote.hasOwnProperty(ag)&&ad.hasOwnProperty(ag)){delete ad[ag]}}aa.down.destroy()}})};b.easyXDM=o})(window,document,location,window.setTimeout,decodeURIComponent,encodeURIComponent);;
/* END /DuttiNEWStorefrontAssetStore/js/lib/easyxdm/easyXDM.min.js (en_US) */

/* BEGIN /Common/js/inditex-current.js (en_US) */
/**
 * Inditex class constructor.
 */

/**
 * Global instance of InditexClass.
 */
if (typeof __inditexInstanceName != "undefined" && __inditexInstanceName == "InditexNew") {
    var InditexClasNew = function(){ };
    var InditexNew = new InditexClasNew();
} else {
    var InditexClass = function(){ };
    var Inditex = new InditexClass();
}

(function (Inditex,InditexClass,WC_ITX_HEADERDATA){
    /*
     * ----------------------------------------------------------------------------
     * BEGIN DINAMIC PROPERTIES NEEDED BY THE API
     * ----------------------------------------------------------------------------
     */

    /**
     *  Current store identifier.
     */
    Inditex.iStoreId = undefined;

    /**
     * Current language identifier.
     */
    Inditex.iLangId = undefined;

    /**
     * Current catalog identifier.
     */
    Inditex.iCatalogId = undefined;

    /**
     * Current category identifier.
     */
    Inditex.iCategoryId = undefined;

    /**
     * Current build version identifier.
     */
    Inditex.iBuildVersion = undefined;

    /**
     * Current domain name.
     */
    Inditex.iDomainName = undefined;

    /**
     * Google maps key.
     */
    Inditex.iGoogleMapsKey = undefined;

    /**
     * Google maps channel.
     */
    Inditex.iGoogleMapsChannel = undefined;

    /**
     * Google maps user.
     */
    Inditex.iGoogleMapsUser = undefined;

    /**
     * Account property for google analytics.
     */
    Inditex.iGaAccount = undefined;

    /**
     * Domain property for google analytics.
     */
    Inditex.iGaDomain = undefined;

    /**
     * Iso store property for google analytics.
     */
    Inditex.iGaIsoStore = undefined;

    /**
     * Iso lang property for google analytics.
     */
    Inditex.iGaIsoLang = undefined;

    /**
     * Iso country property for google analytics.
     */
    Inditex.iGaIsoCountry = undefined;

    /**
     * Buyer id property for google analytics.
     */
    Inditex.iGaBuyerId = undefined;

    /**
     * Path where flowplayer swf is located.
     */
    Inditex.iFlowplayerSwf = undefined;

    /**
     * FlowPlayer key.
     */
    Inditex.iFlowplayerKey = undefined;


    /**
     * Max last product list length. Default 10.
     */
    Inditex.iMaxLastProductListLength = 10;

    /**
     * Grouping separator to format numbers.
     */
    Inditex.iNumberFormatGroupingChar = ",";

    /**
     * Decimal separator to format numbers.
     */
    Inditex.iNumberFormatDecimalChar = ".";

    /**
     * - ONLY SET FOR MOCKUP ENVIRONMENT!!!
     */
    InditexClass.prototype.iIsMockup = false;

    /*
     * ----------------------------------------------------------------------------
     * END DINAMIC PROPERTIES NEEDED BY THE API
     * ----------------------------------------------------------------------------
     */

    /**
     * Field to configure if the page header needs to be drawn on page ready.
     * Defaults to true.
     */
    InditexClass.prototype.iDrawHeaderOnReady = true;

    /**
     * Field to store a list of callbacks that will be executed on page ready event.
     */
    InditexClass.prototype.iReadyArray = [];

    /**
     * Field to store a list of callbacks that will be executed each time the
     * initHtml() function is used.
     */
    InditexClass.prototype.iInitHtmlArray = [];

    /**
     * Field to store a list of callbacks that will be executed on page resize
     * event.
     */
    InditexClass.prototype.iResizeArray = [];

    /**
     * Field to store a map of key/value pairs. Mainly used to store i18n texts.
     */
    InditexClass.prototype.iProperties = {};

    /**
     * Url generic service web stock store
     */
    InditexClass.prototype.iURLStockStore = "";

    /**
     * Field to set Ajax asynchronous/synchronous mode.
     */
    InditexClass.prototype.iAjaxAsync = true;

    /**
     * Field to store a list of callbacks that will be executed when user accepts
     * cookies policy
     */
    InditexClass.prototype.iThirdPartyCookiesArray = [];

    /**
     * Constant for Employee variant of an order card adjustment.
     */
    InditexClass.prototype.ORDER_CARD_ADJUSTMENT_EMPLOYEE_CARD_VARIANT = "EmployeeCard";

    /**
     * Constant for GiftCard variant of an order card adjustment.
     */
    InditexClass.prototype.ORDER_CARD_ADJUSTMENT_GIFT_CARD_VARIANT = "GiftCard";

    /**
     * Dimensions send with trackPage
     */
    InditexClass.prototype.iTrackPageDimension = {};

    /***
     * Field to store a list of callbacks that will be executed when activate
     * google universal
     */
    InditexClass.prototype.iEnableUniversalAnalyticsArray = [];

    /**
     * Method to print a javascript property.
     *
     * @param aKey: Key for the property.
     * @param aValues: (optional) Array of values to replace by index in the \
     * translated property text.
     *
     * @return (String) The translated string with values.
     */
    InditexClass.prototype.msg = function(aKey, aValues) {
        var self = this;

        var translatedString = self.iProperties[aKey+"_"+Inditex.iStoreJSON.countryCode] ?
            self.iProperties[aKey+"_"+Inditex.iStoreJSON.countryCode] :
            (self.iProperties[aKey] ? self.iProperties[aKey]	: ("???" + aKey + "???"));

        if (aValues) {
            for (var i=0; i<aValues.length; i++) {
                var rx = RegExp('\\\{'+ i +'\\\}','g');
                translatedString = translatedString.replace(rx, aValues[i]);
            }
        }

        return translatedString;
    };

    /**
     * Method to format a price.
     *
     * @param aPrice Price as integer.
     *
     * @return (String) Price as formatted string.
     */
    InditexClass.prototype.formatPrice = function(aPrice) {
        var self = this;
        var price = new Number(aPrice);
        var sprice = Math.abs(price).toString();
        var locale = self.iStoreJSON.details.locale;
        var decimals = Math.abs(locale.currencyDecimals);
        var pattern = aPrice >= 0
            ? locale.currencyFormatPosHtml : locale.currencyFormatNegHtml;
        var i, max;
        var result;
        var sint, sdec, fint, fdec;
        var prefix, suffix;
        var tmp;
        var grouping;

        tmp = pattern.match(/[#0][#0,.]*[#0]/)[0];
        i = tmp.indexOf(".");
        if (i == -1) {
            fint = tmp;
            fdec = "";
        } else {
            fint = tmp.substring(0, i);
            fdec = tmp.substring(i + 1);
        }

        i = fint.lastIndexOf(",");
        if (i == -1) {
            grouping = 0;
        } else {
            grouping = fint.length - 1 - i;
        }

        max = decimals + 1 - sprice.length;
        for(i = 0; i < max; i++) {
            sprice = "0" + sprice;
        }

        i = sprice.length - decimals;

        sint = sprice.substring(0, i);
        sdec = sprice.substring(i);

        result = "";
        max = sint.length;
        for (i = 0; i < max; i++) {
            if (i > 0 && grouping > 0 && ((max - i) % grouping) == 0) {
                result += self.iNumberFormatGroupingChar;
            }

            result += sint[i];
        }

        if (Inditex.iForceCurfmtdescNumberpattern == '0') {
            max = Math.max(fdec.replace(/#/g, "").length, sdec.length);
        } else {
            max = Math.max(fdec.replace(/#/g, "").length, Math.min(fdec.length,sdec.length));
        }
        for (i = 0; i < max; i++) {
            if (i == 0) {
                result += self.iNumberFormatDecimalChar;
            }
            result += sdec[i] ? sdec[i] : "0";
        }

        result = pattern.replace(/[#0][#0,.]*[#0]/, result);

        return result;
    };

    /**
     * Method to format a price.
     *
     * @param aPrice Price as integer.
     *
     * @return (String) Price as formatted string.
     */
    InditexClass.prototype.formatNumber = function(aPrice) {
        var self = this;
        var price = new Number(aPrice);
        var sprice = Math.abs(price).toString();
        var locale = self.iStoreJSON.details.locale;
        var decimals = Math.abs(locale.currencyDecimals);
        var pattern = aPrice >= 0
            ? locale.currencyFormatPosHtml : locale.currencyFormatNegHtml;
        var i, max;
        var result;
        var sint, sdec, fint, fdec;
        var prefix, suffix;
        var tmp;
        var grouping;

        tmp = pattern.match(/[#0][#0,.]*[#0]/)[0];
        i = tmp.indexOf(".");
        if (i == -1) {
            fint = tmp;
            fdec = "";
        } else {
            fint = tmp.substring(0, i);
            fdec = tmp.substring(i + 1);
        }

        i = fint.lastIndexOf(",");
        if (i == -1) {
            grouping = 0;
        } else {
            grouping = fint.length - 1 - i;
        }

        max = decimals + 1 - sprice.length;
        for(i = 0; i < max; i++) {
            sprice = "0" + sprice;
        }

        i = sprice.length - decimals;

        sint = sprice.substring(0, i);
        sdec = sprice.substring(i);

        result = "";
        max = sint.length;
        for (i = 0; i < max; i++) {
            result += sint[i];
        }

        max = Math.max(fdec.replace(/#/g, "").length, sdec.length);
        for (i = 0; i < max; i++) {
            if (i == 0) {
                result += ".";
            }
            result += sdec[i] ? sdec[i] : "0";
        }

        return result;
    };

    /**
     * Method to round a price.
     *
     * @param aPrice Price as integer.
     *
     * @return (Integer) Price rounded.
     */
    InditexClass.prototype.roundPrice = function(aPrice) {
        var self = this;
        var price = new Number(aPrice);
        var locale = self.iStoreJSON.details.locale;
        var decimals = Math.abs(locale.currencyDecimals);

        var mprice = price / Math.pow(10, decimals);
        var rprice = Math.round(mprice);
        var result = rprice * Math.pow(10, decimals);

        return result;
    };
    /**
     * Method to retrieve a care image url.
     *
     * @param aCareId Care identifier.
     * @param aExtension Image file extension.
     *
     * @return Care image url.
     */
    InditexClass.prototype.generateCareImageUrl = function(aCareId, aExtension) {
        var self = this;
        var result;

        if (!self.iStoreJSON) {
            throw "InditexClass.generateCareImageUrl: Missing attribute 'iStoreJSON'.";
        }

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        result += result[result.length-1] == '/' ? '' : '/';
        if(Inditex.isMobilePath()){
            result += "itxmobile/images/cares/";
        }
        else{
            result += "itxstandard/images/cares/";
        }
        result += aCareId;
        result += ".";
        result += aExtension;
        result += "?t=";
        result += self.iStoreJSON.details.timestampBuildVersion;

        return result;
    };

    /**
     * Method to retrieve a dynamic url.
     *
     * @param path relative url.
     *
     * @return absolute url.
     */
    InditexClass.prototype.getDynamicResourceUrl = function(path) {
        var self = this;
        var result;

        if (!self.iStoreJSON) {
            throw "InditexClass.getDynamicResourceUrl: Missing attribute 'iStoreJSON'.";
        }

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticContentPath.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticContentPath.replace("https:", "http:");
        }
        result += result[result.length-1] == '/' ? '' : '/';
        result += path[0]== '/' ? path.substring(1, path.length) : path;
        result += "?t=";
        result += self.iBuildVersion;

        return result;
    };


    /**
     * Method to retrieve an absolute static url.
     *
     * @param relative url.
     *
     * @return absolute url.
     */
    InditexClass.prototype.getStaticResourceUrl = function(path) {
        var self = this;
        var result;

        if (!self.iStoreJSON) {
            throw "InditexClass.getStaticResourceUrl: Missing attribute 'iStoreJSON'.";
        }

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }
        result += result[result.length-1] == '/' ? '' : '/';
        result += path[0]== '/' ? path.substring(1, path.length) : path;
        result += "?t=";
        result += self.iBuildVersion;

        return result;
    };

    (function() {

        function buildQueryString(aParams) {

            var q = "?";

            if (aParams) {
                for (i in aParams) {
                    if ((aParams[i] != null) && (aParams[i] != undefined)) {
                        q += encodeURIComponent(i);
                        q += "=";
                        q += encodeURIComponent(aParams[i]);
                        q += "&";
                    }
                }
            }

            return q.slice(0, -1);

        }

        function buildMockupUrl(aSelf, aAction, aParams, aSecure, aForMobile) {

            var url = "";

            url += encodeURIComponent(aAction);
            url += ".html";
            url += buildQueryString(aParams);

            return url;

        }

        function buildClassicUrl(aSelf, aAction, aParams, aSecure, aForMobile) {

            var url;

            url = aSecure ? "https://" : "http://";
            url += aSelf.iDomainName;
            url += "/webapp/wcs/stores/";
            url += aForMobile ? "mobile/" : "servlet/";
            url += encodeURIComponent(aAction);
            url += buildQueryString(aParams);

            return url;

        }

        function getSeoCategoryPath(aSelf, aList, aCategoryId) {
            var i,s;

            if ((aList == null) || (aList.length == 0)) {
                return "";
            }

            for (i = 0; i < aList.length; i++) {
                if (aList[i].id == aCategoryId) {
                    s = "";
                    if (aList[i].name != null) {
                        s += encodeURIComponent(aList[i].name.trim().toLowerCase().replace(/<[^>]+>/g, "").replace(/\s+|\/|\\/g, "-"));
                    }

                    return s;
                } else {
                    s = getSeoCategoryPath(aSelf, aList[i].subcategories, aCategoryId);

                    if (s != "") {
                        if (aList[i].name == null) {
                            return s;
                        } else {
                            return encodeURIComponent(aList[i].name.trim().toLowerCase().replace(/<[^>]+>/g, "").replace(/\s+|\/|\\/g, "-")) + "/" + s;
                        }
                    }
                }
            }

            return "";
        }

        function getSeoKeyword(aSelf, aList, aParams, aValue) {
            var s;

            s = getSeoCategoryPath(aSelf, aList, aParams.categoryId);

            if (aValue && aParams.productId) {
                if (s != "") {
                    s += "/";
                }
                s += encodeURIComponent(aValue.trim().toLowerCase().replace(/<[^>]+>/g, "").replace(/\s+|\/|\\/g, "-"));
            }

            return s;
        }

        var PATTERN_OPT = new RegExp("\\[[^\\[\\]]*\\]");

        function parseTemplateOpt(aSelf, aTemplate, aParams, aDefCatalogId, aToRemove) {

            var s,t,t1;

            s = aTemplate;

            while (t = PATTERN_OPT.exec(s)) {
                t1 = parseTemplateVar(aSelf, t[0].slice(1, -1), aParams, aDefCatalogId, true, aToRemove);
                if (t1 == null) {
                    return null;
                } else {
                    s = s.replace(t[0], t1);
                }
            }

            return parseTemplateVar(aSelf, s, aParams, aDefCatalogId, false, aToRemove);

        }

        var PATTERN_VAR = new RegExp("\\{[*a-zA-Z]+\\}");
        var KEYWORD = "keyWord";
        var CATALOG_ID = "catalogId";
        var CATEGORY_ID = "categoryId";
        var GENERIC = "*";
        var STORE_ID = "storeId";
        var LANG_ID = "langId";
        var NAME = "name";
        var SEARCH_TERM = "searchTerm";

        function getDefaultCatalog(aSelf, aStoreId) {

            var t;

            if (!aSelf.iSeoDefaultCatalogMap) {
                return null;
            }

            if (!aStoreId) {
                return null;
            }

            t = aSelf.iSeoDefaultCatalogMap[aStoreId];

            if (t == undefined) {
                return null;
            }

            return aSelf.isMobilePath() ? t[1] : t[0];

        }

        function parseTemplateVar(aSelf, aTemplate, aParams, aDefCatalogId, aIsOptional, aToRemove) {
            var map0 = aSelf.iSeoParameterMap;
            var s = aTemplate;
            var t, k, v, i;

            while (t = PATTERN_VAR.exec(s)) {
                k = t[0].slice(1, -1);
                v = aParams[k];
                aToRemove.push(k);

                if (KEYWORD === k) {
                    v = getSeoKeyword(
                        aSelf,
                        aSelf.iCategoryTreeJSON ? aSelf.iCategoryTreeJSON.categories : null,
                        aParams,
                        v);
                    if (v == null || v == "") {
                        return aIsOptional ? "" : null;
                    }
                } else if ((v == null) || (v == undefined)) {
                    return aIsOptional ? "" : null;
                } else if ((CATALOG_ID === k) && (v == aDefCatalogId) && aIsOptional) {
                    return "";
                } else {
                    map1 = map0 == null ? null : map0[k];

                    if (map1 && map1[v]) {
                        v = map1[v];
                    }

                    v = encodeURIComponent(v);
                }

                s = s.replace(t[0], v);
            }

            return s;
        }

        function buildSeoUrl(aSelf, aTemplate, aParams, aSecure, aForMobile) {

            var url;

            url = aSecure ? "https://" : "http://";
            url += aSelf.iDomainName;
            url += aForMobile ? "/m/" : "/";
            url += aTemplate[0] == "/" ? aTemplate.slice(1) : aTemplate;
            url += buildQueryString(aParams);

            return url;

        }

        /**
         * Method to generate an url from an action name and a parameters map.
         *
         * @param aAction Action name.
         * @param aParams Action parameters as Key/Value map.
         *
         * @return The action url.
         */
        InditexClass.prototype.generateUrl = function(aAction, aParams, aSecure, aForMobile) {

            var self = this;
            var template;
            var toRemove = [];

            if (!aParams) {
                aParams = {};
            }

            if (aForMobile == undefined) {
                aForMobile = self.isMobilePath();
            }

            if (self.iIsMockup) {
                return buildMockupUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            if (!self.iEnablePrettyUrls) {
                return buildClassicUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            if (!self.iSeoTemplateMap) {
                return buildClassicUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            if (/^CaptchaImg$/.test(aAction)) {
                return buildClassicUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            template = self.iSeoTemplateMap[aAction];

            if (!template) {
                template = self.iSeoTemplateMap["*"];
            }

            if (!template) {
                return buildClassicUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            template = template.replace("{*}", aAction);

            template = parseTemplateOpt(
                self,
                template,
                aParams,
                getDefaultCatalog(self, aParams.storeId),
                toRemove);

            if (template == null) {
                return buildClassicUrl(self, aAction, aParams, aSecure, aForMobile);
            }

            toRemove.push("storeId");
            toRemove.push("langId");
            toRemove.push("catalogId");

            for (i = 0; i < toRemove.length; i++) {
                delete aParams[toRemove[i]];
            }

            return buildSeoUrl(self, template, aParams, aSecure, aForMobile);

        }

        InditexClass.prototype.toDeviceUrl = function() {
            var self = this, hash, flag1, flag2, isSecure, obj;

            flag1 = self.isMobileDevice();
            flag2 = self.isMobilePath();

            if (Inditex.getCurrentURLParams().standardVersion == 1){
                return null;
            }

            if (flag1 && flag2) {
                return null;
            }

            if (!flag1 && !flag2) {
                return null;
            }

            obj = self.parseUrl(location.href);

            if (obj) {
                isSecure = location.protocol == "https:";
                hash = location.hash;
            } else {
                obj = {
                    "action": "WorldWidePage",
                    "params": {
                        "storeId": self.iStoreId,
                        "useCookie": 1
                    }
                };

                isSecure = false;
                hash = "";
            }

            if (obj.params.catalogId && self.iStoreJSON && self.iStoreJSON.catalogs) {
                for (i = 0; i < self.iStoreJSON.catalogs.length; i++) {
                    if (flag1 && self.iStoreJSON.catalogs[i].type == 5) {
                        obj.params.catalogId = self.iStoreJSON.catalogs[i].id;
                    } else if (!flag1 && self.iStoreJSON.catalogs[i].type == 1) {
                        obj.params.catalogId = self.iStoreJSON.catalogs[i].id;
                    }
                }
            }

            return self.generateUrl(
                    obj.action,
                    obj.params,
                    isSecure,
                    flag1) + hash;
        };

        InditexClass.prototype.parseUrl = function(aUrl) {
            var self,re,key,t1,t2,t3,item,i,j,path,search,map0,map1,result;

            self = this;

            re = new RegExp("^(http|https)://" + location.host);

            if (!re.test(aUrl)){
                return null;
            }

            result = {
                "params": {
                }
            };

            t1 = aUrl.replace(re, "").split("?");
            path = t1[0];
            search = t1[1];
            t1 = search ? search.split("#") : [];
            search = t1[0];
            hash = t1[1];
            if (hash) {
                result.hash = hash;
            }
            map0 = self.iSeoParameterMap;

            t1 = search ? search.split("&") : [];
            for (i = 0; i < t1.length; i++) {
                t2 = t1[i].split("=");
                if (t2.length == 2) {
                    result.params[decodeURIComponent(t2[0])] = decodeURIComponent(t2[1]);
                }
            }

            if (result.params.storeId == undefined) {
                result.params.storeId = self.iStoreId;
            }

            if (result.params.langId == undefined) {
                result.params.langId = self.iLangId;
            }

            if (result.params.catalogId == undefined) {
                result.params.catalogId = self.iCatalogId;
            }

            re = new RegExp("^/webapp/wcs/stores/(servlet|mobile)/([a-zA-Z0-9]+)$");
            if (t1 = re.exec(path)) {
                result.action = t1[2];

                return result;
            } else if (self.iSeoTemplateMap) {

                if (/^\/m\//.test(path)) {
                    path = path.slice(2);
                }

                for (key in self.iSeoTemplateMap) {
                    t1 = [self.iSeoTemplateMap[key]];
                    while (t1.length > 0) {
                        item = t1.pop();
                        if (t2 = PATTERN_OPT.exec(item)) {
                            t1.push(item.replace(t2[0], ""));
                            t1.push(item.replace(t2[0], t2[0].slice(1, -1)));
                        } else {
                            t3 = [];
                            while (t2 = PATTERN_VAR.exec(item)) {
                                item = item.replace(t2[0], self.iSeoParamRegexMap[t2[0].slice(1, -1)]);
                                t3.push(t2[0].slice(1, -1));
                            }

                            if (t2 = new RegExp("^" + item + "$").exec(path)) {
                                for (i = 0; i < t3.length; i++) {
                                    if (t3[i] == "*") {
                                        key = t2[i + 1];
                                    } else {
                                        map1 = map0 ? map0[t3[i]] : null;
                                        if (map1) {
                                            for (j in map1) {
                                                if (map1[j] == t2[i + 1]) {
                                                    result.params[t3[i]] = j;
                                                    break;
                                                }
                                            }
                                        } else {
                                            result.params[t3[i]] = decodeURI(t2[i + 1]);
                                        }
                                    }
                                }

                                result.action = key;

                                return result;
                            }
                        }
                    }
                }
            }

            return null;
        };

    })();

    InditexClass.prototype.getCurrentURLParams = function(){
        var params = {};
        var paramSets = window.location.href
                .replace(/#.*$/g,'')
                .replace(/^.*\?([^#]*)$/g,'$1').split('&')
            ;
        for (var i=0; i<paramSets.length; i++) {
            var k = paramSets[i].split('=')[0];
            var v = paramSets[i].split('=')[1];
            params[k] = v;
        }
        return params;
    };

    InditexClass.prototype.getCurrentAnalyticsParams = function(urlParams){
        var self = this;
        var socialRequests = ["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content"];
        var params = self.getCurrentURLParams();
        if(params && params != null){
            if(!urlParams || urlParams == null){
                var urlParams = [];
            }
            for (var i = 0; i < socialRequests.length; i++){
                if(params[socialRequests[i]] && params[socialRequests[i]] != null){
                    urlParams[socialRequests[i]] = params[socialRequests[i]];
                }
            }
        }
        return urlParams;
    };

    InditexClass.prototype.generateUrlWithAnalyticsParams = function(commandName, urlParams, aSecure){
        var self = this;
        urlParams = self.getCurrentAnalyticsParams(urlParams);
        return self.generateUrl(commandName, urlParams, aSecure);
    };

    InditexClass.prototype.generateStoreUrl = function(aStoreId, aLangId, aCatalogId) {
        var self = this,params,aux1,aux2,re,map0,map1,store,lang,catalog,url,hash;

        params = {};
        aux1 = location.search.slice(1).split("&");
        for (i = 0; i < aux1.length; i++) {
            aux2 = aux1[i].split("=");
            if (aux2.length == 2) {
                params[decodeURIComponent(aux2[0])] = decodeURIComponent(aux2[1]);
            }
        }

        delete params.useCookie;

        if (self.iIsMockup) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;

            url = self.generateUrl("ItxHomePage", params, false);

            return url;
        }

        re = new RegExp("^/webapp/wcs/stores/(servlet|mobile)/social/");

        if (re.test(location.pathname)) {
            aux1 = location.pathname.split("/");
            aux2 = ["categoryId", "idTipoTiendaCatalogo", "option", "productId", "looks", "idBundle", "initColor"];
            for (i = 0; i < aux2.length; i++) {
                if (aux1[i + 7] !== undefined) {
                    params[aux2[i]] = decodeURIComponent(aux1[i + 7]);
                }
            }
        }

        re = new RegExp("\^\(http\|https\)://" + self.iDomainName);

        if (params.shareUrl && re.test(params.shareUrl)) {

            re =  new RegExp("\^\(http\|https\)://" + self.iDomainName + "/webapp/");

            if (re.test(params.shareUrl)) {
                url = params.shareUrl
                    .replace(/_storeId_/g, aStoreId)
                    .replace(/_langId_/g, aLangId)
                    .replace(/_catalogId_/g, aCatalogId);
            } else {
                aux1 = params.shareUrl.split("?");
                map0 = self.iSeoParameterMap;
                url = aux1[0];

                map1 = map0 ? map0["storeId"] : null;
                if (map1) {
                    store = map1[aStoreId];
                }

                if (store) {
                    url = url.replace(/_storeId_/g, store);
                } else {
                    url = url.replace(/_storeId_/g, aStoreId);
                }

                map1 = map0 ? map0["langId"] : null;
                if (map1) {
                    lang = map1[aLangId];
                }

                if (lang) {
                    url = url.replace(/_langId_/g, lang);
                } else {
                    url = url.replace(/_langId_/g, aLangId);
                }

                map1 = map0 ? map0["catalogId"] : null;
                if (map1) {
                    catalog = map1[aCatalogId];
                }

                if (catalog) {
                    url = url.replace(/_catalogId_/g, catalog);
                } else {
                    url = url.replace(/_catalogId_/g, aCatalogId);
                }

                if (aux1[1]) {
                    url += "?";
                    url += aux1[1]
                        .replace(/_storeId_/g, aStoreId)
                        .replace(/_langId_/g, aLangId)
                        .replace(/_catalogId_/g, aCatalogId);
                }
            }

            delete params.storeId;
            delete params.langId;
            delete params.catalogId;
            delete params.shareUrl;

            hash = url.split("#")[1];
            url = url.split("#")[0];

            for (i in params) {
                url += url.search("\\?") == -1 ? "?" : "&";
                url += encodeURIComponent(i);
                url += "=";
                url += encodeURIComponent(params[i]);
            }

            if (hash) {
                url += "#" + hash;
            }

            return url;
        }

        delete params.shareUrl;

        if (params.option == 1) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;

            delete params.socialShare;
            delete params.option;

            url = self.generateUrl("ProductPage", params, false);

            return url;
        }

        if (params.option == 2) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;

            delete params.socialShare;
            delete params.option;

            url = self.generateUrl("CategoryPage", params, false);

            return url;
        }

        if (params.option == 3) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;

            hash = params.looks ? "#" + encodeURIComponent(params.looks) : "";

            delete params.socialShare;
            delete params.option;
            delete params.looks;

            url = self.generateUrl("CategoryPage", params, false) + hash;

            return url;
        }

        if (params.option == 4) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;

            hash = params.looks ? "#" + encodeURIComponent(params.looks) : "";

            delete params.socialShare;
            delete params.option;
            delete params.looks;

            url = self.generateUrl("ItxStandardBundlePage", params, false) + hash;

            return url;
        }

        if (params.option == 5) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;
            params.bundleId = params.productId;

            hash = params.looks ? "#" + encodeURIComponent(params.looks) : "";

            delete params.socialShare;
            delete params.option;
            delete params.productId;
            delete params.looks;

            url = self.generateUrl("ItxStandardLookbookBundlePage", params, false) + hash;

            return url;
        }

        if (params.option == 6) {

            params.langId = aLangId;
            params.storeId = aStoreId;
            params.catalogId = aCatalogId;
            params.fts = params.selectedAccordionTab;

            delete params.socialShare;
            delete params.option;
            delete params.selectedAccordionTab;

            url = self.generateUrl("ItxStandardGiftCardPage", params, false);

            return url;
        }

        params.langId = aLangId;
        params.storeId = aStoreId;
        params.catalogId = aCatalogId;
        url = self.generateUrl("HomePage", params, false);

        return url;
    };

    InditexClass.prototype.generateStandardWorldWideUrl = function(aStoreJSON, aCatalogType, aLangId) {
        var self = this,catalogId;

        catalogId = 0;
        for (i = 0; i < aStoreJSON.catalogs.length; i++) {
            if (aStoreJSON.catalogs[i].type == aCatalogType) {
                catalogId = aStoreJSON.catalogs[i].id;
                break;
            }
        }

        return self.generateStoreUrl(aStoreJSON.id, aLangId, catalogId);
    };

    InditexClass.prototype.isMobilePath = function (){

        if (/^\/m\//.test(location.pathname)) {
            return true;
        } else if (/^\/webapp\/wcs\/stores\/mobile\//.test(location.pathname)) {
            return true;
        } else if (Inditex.iIsMockup && /\/mobile\//.test(location.pathname)) {
            return true;
        } else {
            return false;
        }

    };

    InditexClass.prototype.getRestJSON = function(aProtocol, aVersion, aPath, aData, aOnSuccess, aOnFailure) {
        var self = this;
        var url = "";

        if (self.iIsMockup) {
            url += "../../../../";
        } else {
            url += aProtocol;
            url += "//";

            if (self.iDomainName === undefined) {
                throw "InditexClass.getRestBaseUrl: Missing attribute 'iDomainName'.";
            }

            url += self.iDomainName + "/";
        }

        url += "itxrest/" + aVersion + aPath;

        Inditex.request({
            "url": url,
            "data": aData,
            "contentType": "application/json",
            "onSuccess": function(aText) {
                if (aOnSuccess) {
                    aOnSuccess(Inditex.evalJSON(aText));
                }
            },
            "onFailure": function(aStatus) {
                if (aOnFailure) {
                    aOnFailure(aStatus);
                }
            }
        });
    };

    InditexClass.prototype.getRestProxyJSON = function(aProtocol, aVersion, aPath, aData, aOnSuccess, aOnFailure) {
        var self = this;
        var url = "";

        if (self.iIsMockup) {
            url += "../../../../";
        } else {
            url += aProtocol;
            url += "//";

            if (self.iDomainName === undefined) {
                throw "InditexClass.getRestBaseUrl: Missing attribute 'iDomainName'.";
            }

            url += self.iDomainName + "/";
        }

        url += "itxrestproxy/" + aVersion + aPath;

        Inditex.request({
            "url": url,
            "data": aData,
            "contentType": "application/json",
            "onSuccess": function(aText) {
                if (aOnSuccess) {
                    aOnSuccess(Inditex.evalJSON(aText));
                }
            },
            "onFailure": function(aStatus) {
                if (aOnFailure) {
                    aOnFailure(aStatus);
                }
            }
        });
    };

    InditexClass.prototype.getRestBamPhysicalStores = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/physical-store";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.favouriteStores
            ? "&favouriteStores=true" : "&favouriteStores=false";
        path += aOptions.lastStores
            ? "&lastStores=true" : "&lastStores=false";
        path += aOptions.receiveEcommerce
            ? "&receiveEcommerce=true" : "&receiveEcommerce=false";
        path += aOptions.latitude == undefined
            ? "" : "&latitude=" + aOptions.latitude;
        path += aOptions.longitude == undefined
            ? "" : "&longitude=" + aOptions.longitude;
        path += aOptions.max == undefined
            ? "" : "&max=" + aOptions.max;
        path += aOptions.min == undefined
            ? "" : "&min=" + aOptions.min;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamDropPoint = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/drop-point";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.postalCode == undefined
            ? "" : "&postalCode=" + aOptions.postalCode;
        path += aOptions.latitude == undefined
            ? "" : "&latitude=" + aOptions.latitude;
        path += aOptions.longitude == undefined
            ? "" : "&longitude=" + aOptions.longitude;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };


    InditexClass.prototype.getRestBamPackStation = function(aOptions) {
        var self = this;
        var path = "/bam/store/" + self.iStoreId + "/packstation";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.postalCode == undefined
            ? "" : "&postalCode=" + aOptions.postalCode;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };



    InditexClass.prototype.getRestBamStates = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/state";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamStock = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/bam-stock";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += "&catentryId=" + aOptions.catentryId;
        path += "&latitude=" + aOptions.latitude;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += "&longitude=" + aOptions.longitude;
        if (aOptions.max != undefined) {
            path += "&max=" + aOptions.max;
        }
        if (aOptions.min != undefined) {
            path += "&min=" + aOptions.min;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBookingGetBookingById = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardGetBookingByIdCmd", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "bookingId": aOptions.bookingId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestBookingGetBookingsByUserCmd = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardGetBookingsByUserCmd", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestBookingAddBookingCmd = function(aOptions) {
        var self;
        var url;

        self = this;

        var urlParams = {
            "storeId":							self.iStoreId,
            "languageId":						self.iLangId,
            "catalogId":						self.iCatalogId,
            "captchaAnswer":					aOptions.captcha,
            "email":							aOptions.email,
            "fullName" : 						aOptions.fullName,
            "phoneNumber": 						aOptions.phone,
            "viewname":							"ItxStandardJSON",
            "errorViewName":					"ItxStandardJSON"
        };

        if (aOptions.policyVersionIds != null){
            urlParams["policyVersionIds"] = aOptions.policyVersionIds;
        }

        for (var i=0; i<aOptions.bamStoreId.length; i++){
            urlParams["bookingStoreItems_" + i + "_bamStoreId"] =  aOptions.bamStoreId[i];
            urlParams["bookingStoreItems_" + i + "_catentryId"] =  aOptions.catentryId[i];
            urlParams["bookingStoreItems_" + i + "_unitsOrdered"] =  aOptions.unitsOrdered[i];
        }

        var url = self.generateUrl('ItxStandardAddBookingCmd', urlParams, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };


    InditexClass.prototype.getRestBookingDeleteBookingById = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardDeleteBookingByIdCmd", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId,
            "bookingId": aOptions.bookingId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestCatalogStores = function(aOptions) {
        var self = this;

        var path = "/catalog/store";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?brandId=" + aOptions.brandId + "&languageId=" + self.iLangId;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogStore = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId;
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogCategories = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogCategory = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category/" + aOptions.categoryId;
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogProducts = function(aOptions) {
        var self = this;
        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category/" + aOptions.categoryId + "/product";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        if(aOptions.withSubcategories){
            path += "&withSubcategories=" + aOptions.withSubcategories;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestProxyCatalogProducts = function(aOptions) {
        var self = this;
        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category/" + aOptions.categoryId + "/product";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        if(aOptions.withSubcategories){
            path += "&withSubcategories=" + aOptions.withSubcategories;
        }

        self.getRestProxyJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogProductsBySearchTerm = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/product";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId + "&searchTerm="
            + encodeURIComponent(aOptions.searchTerm);

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogProductDetail = function(aOptions) {
        var self = this;

        var catalogId = self.iCatalogId;
        if (aOptions.catalogId)
            catalogId = aOptions.catalogId;


        var path = "/catalog/store/" + self.iStoreId + "/" + catalogId
            + "/category/" + aOptions.categoryId + "/product/"
            + aOptions.productId + "/detail";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogProductsByPartNumber = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/product/" + aOptions.partNumber;
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogProductStock = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/product/" + aOptions.productId + "/stock";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogCategoryStock = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category/" + aOptions.categoryId + "/stock";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if (aOptions.withSubCategories != undefined && aOptions.withSubCategories != null){
            path += "&withSubCategories=" + encodeURIComponent(aOptions.withSubCategories);
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    (function() {

        var optionsArray = [];
        var socket = null;
        var flag = false;

        function doProcess(resp) {
            var tokens = resp.split("|");

            if (tokens[1] == 'START') {
                try {
                    if (optionsArray[0].onStart) {
                        optionsArray[0].onStart();
                    }
                } catch (err) {
                }
            } else {
                try {
                    var status = parseInt(tokens[1]);
                    if (status == 200) {
                        if (optionsArray[0].onSuccess) {
                            optionsArray[0].onSuccess(unescape(tokens[2]));
                        }
                    } else {
                        if (optionsArray[0].onFailure) {
                            optionsArray[0].onFailure(status);
                        }
                    }
                } catch (err) {
                } finally {
                    doFinish();
                }
            }
        }

        function doFinish() {
            optionsArray.shift();
            flag = false;
            setTimeout(doMessage, 50);
        }

        function doMessage() {

            if (flag) {
                return;
            }

            try {
                flag = true;

                var msg;
                msg = "0|" + optionsArray[0].url + "|" + (optionsArray[0].data && optionsArray[0].data.length > 0 ? optionsArray[0].data : "") + "|" + (optionsArray[0].contentType ? optionsArray[0].contentType : "application/x-www-form-urlencoded");

                if (socket == null) {

                    var secure;
                    secure = (location.protocol == 'https:');

                    socket = new easyXDM.Socket({
                        remote: (secure ? "http://" : "https://") + location.host + "/wcsstore/Common/views/itx-iframe-tool.html",
                        swf: (secure ? "http://" : "https://") + Inditex.iDomainName + "/wcsstore/Common/js/easyxdm.swf",
                        container: document.body,
                        props: {
                            style: {
                                width: '0px',
                                height: '0px',
                                'z-index': '-100'
                            }
                        },
                        onMessage: function(resp, origin) {
                            doProcess(resp);
                        },
                        onReady: function() {
                            socket.postMessage(msg);
                        }
                    });
                } else {
                    socket.postMessage(msg);
                }
            } catch (err) {
                doFinish();
            }
        }

        InditexClass.prototype.request = function(options) {
            var self = this;

            if ((location.protocol == 'http:' && /^https:/.test(options.url))) {
                // Cross domain request

                optionsArray.push(options);

                doMessage();

            }

            // Not cross domain request
            else {

                if (location.protocol == "https:" && /^http:/.test(options.url)){
                    options.url = options.url.replace('http://', 'https://');
                }
                var tieneDatos = false;
                if (options.data && options.data.length > 0) {
                    tieneDatos = true;
                }
                if ((typeof XDomainRequest == 'object' || typeof XDomainRequest == 'function' ) &&  !tieneDatos && !(new RegExp("^(http|https)://" + location.host).test(options.url)) && (new RegExp("^(http|https)://").test(options.url))) {

                    var xdr = new XDomainRequest();
                    xdr.onload = function() {
                        if (options.onSuccess) {
                            options.onSuccess(xdr.responseText);
                        }
                    };
                    xdr.onerror = function() {
                        if (options.onFailure) {
                            options.onFailure();
                        }
                    };

                    xdr.open("GET", options.url);
                    xdr.onprogress = function(){ };
                    xdr.ontimeout = function(){ };
                    xdr.onerror = function () { };
                    setTimeout(function () {
                        xdr.send();
                    }, 0);
                }
                else{

                    var xmlhttp = false;

                    try {
                        xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch(e1) {
                        try {
                            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                        } catch(e2) {
                            xmlhttp = false;
                        }
                    }

                    if((!xmlhttp && typeof XMLHttpRequest != 'undefined')|| (!(new RegExp("^(http|https)://" + location.host).test(options.url)) && (new RegExp("^(http|https)://").test(options.url))) &&  typeof XMLHttpRequest != 'undefined') {
                        xmlhttp = new XMLHttpRequest();
                    }

                    if (options.data && options.data.length > 0) {
                        xmlhttp.open('POST', options.url, self.iAjaxAsync);
                        xmlhttp.setRequestHeader("Content-type", options.contentType ? options.contentType : "application/x-www-form-urlencoded");
                    } else {
                        xmlhttp.open('GET', options.url, self.iAjaxAsync);
                    }

                    xmlhttp.onreadystatechange = function() {
                        if (xmlhttp.readyState == 1) {
                            if (options.onStart) {
                                options.onStart();
                            }
                        } else if (xmlhttp.readyState == 4) {
                            if (xmlhttp.status == 200) {
                                if (options.onSuccess) {
                                    options.onSuccess(xmlhttp.responseText);
                                }
                            } else {
                                if (options.onFailure) {
                                    options.onFailure(xmlhttp.status);
                                }
                            }
                        }
                    };

                    xmlhttp.send(options.data);
                }
            }
        };
    })();

    InditexClass.prototype.readCookie = function(name) {
        var cookies = document.cookie.split(";");
        var i, key, value, index;

        for (i = 0; i < cookies.length; i++) {
            index = cookies[i].indexOf("=");
            key = cookies[i].substr(0, index).replace(/^\s+|\s+$/g, "");
            value = cookies[i].substr(index + 1);
            if (key == name) {
                return decodeURIComponent(value);
            }
        }

        return null;
    };


    InditexClass.prototype.writeCookie = function(name, data, expiresIn) {
        var expires;
        if (expiresIn != undefined){
            var date = new Date();
            date.setTime(date.getTime() + (expiresIn*24*60*60*1000));
            expires = "; expires="+date.toGMTString();
        }
        if (expires != undefined){
            document.cookie = name + "=" + encodeURIComponent(data) + expires + "; path=/";
        } else {
            document.cookie = name + "=" + encodeURIComponent(data) + "; path=/";
        }

    };

    (function() {
        var special = {'\b': '\\b', '\t': '\\t', '\n': '\\n', '\f': '\\f', '\r': '\\r', '"' : '\\"', '\\': '\\\\'};

        var escape = function(chr){
            return special[chr] || '\\u' + ('0000' + chr.charCodeAt(0).toString(16)).slice(-4);
        };

        InditexClass.prototype.evalJSON = function(aText) {

            if (!aText || typeof aText !== "string") {
                return null;
            }

            if ( window.JSON && window.JSON.parse ) {
                return window.JSON.parse(aText);
            }

            if ( window.JSON && window.JSON.decode ) {
                return window.JSON.decode(aText);
            }

            if (!/^[\],:{}\s]*$/.test(aText.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').
                    replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').
                    replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {

                throw "InditexClass.evalJSON(aText): Invalid JSON.";
            }

            return eval('(' + aText + ')');
        };

        InditexClass.prototype.serializeJSON = function(aJson) {
            var self = this;
            var i, tmp, tmp1;

            if (window.JSON && window.JSON.stringify) {
                return window.JSON.stringify(aJson);
            }

            if (window.JSON && window.JSON.encode) {
                return window.JSON.encode(aJson);
            }

            if (typeof aJson == "string") {
                return '"' + aJson.replace(/[\x00-\x1f\\"]/g, escape) + '"';
            } else if (typeof aJson == "array") {
                return '[' + aJson.map(self.serializeJSON).clean() + ']';
            } else if (typeof aJson == "object" || typeof aJson == "hash") {
                tmp = [];
                for (i in aJson) {
                    tmp1 = self.serializeJSON(aJson[i]);
                    if (tmp1) {
                        tmp.push(self.serializeJSON(i) + ":" + tmp1);
                    }
                }
                return "{" + tmp + "}";
            } else if (typeof aJson == "number" || typeof aJson == "boolean") {
                return "" + aJson;
            } else if (typeof aJson == "null") {
                return "null";
            }

            return null;
        };
    })();

    InditexClass.prototype.getPendingJSON = function() {
        var self = this;
        var pending = new Object();
        var tmp = self.readCookie("WC_ITX_PENDINGDATA");

        if(self.iEnableOrderItemsOrigin){
            if (tmp && /[0-9]+:[0-9]+:([0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?(,[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?)*)?:([0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*)?/g.test(tmp)) {

                tmp = tmp.match(/^([0-9]+):([0-9]+):((?:[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?(?:,[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?)*)?):([0-9]+_[\-0-9]+(?:,[0-9]+_[\-0-9]+)*)?$/);

                pending.timestamp = tmp[1];
                pending.storeId = tmp[2];
                pending.shopCart = new Array();
                pending.wishCart = new Array();
                if (pending.storeId == self.iStoreId) {

                    tmp[3] = /[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?(,[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?)*/g.test(tmp[3]) ? tmp[3].match(/[0-9]+_[\-0-9]+(?:@(?:.(?![^\\]\\@))*.[^\\]\\@)?/g) : [];
                    tmp[4] = /[0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*/g.test(tmp[4]) ? tmp[4].split(",") : [];

                    for (var i = 0; i < tmp[3].length; i++) {
                        var item = new Object();
                        var tmpOrigin = null;
                        var at = tmp[3][i].indexOf("@");
                        if (at>=0) {
                            tmpOrigin = tmp[3][i].substring(at+1,tmp[3][i].length-2);
                            tmp[3][i] = tmp[3][i].substring(0,at);
                        }
                        var tokens = tmp[3][i].split("_");
                        item.id = tokens[0];
                        item.quantity = parseFloat(tokens[1]);

                        if(tmpOrigin){
                            item.origin = self.evalJSON(tmpOrigin);
                        }else{
                            item.origin = new Array();
                        }
                        pending.shopCart.push(item);
                    }

                    for (var i = 0; i < tmp[4].length; i++) {
                        var item = new Object();
                        var tokens = tmp[4][i].split("_");
                        item.id = tokens[0];
                        item.quantity = parseFloat(tokens[1]);
                        pending.wishCart.push(item);
                    }
                } else {
                    pending.storeId = self.iStoreId;
                    self.setPendingJSON(pending);
                }
            } else {
                pending.timestamp = "0";
                pending.storeId = self.iStoreId;
                pending.shopCart = new Array();
                pending.wishCart = new Array();
                self.setPendingJSON(pending);
            }
        }else{
            if (tmp && /[0-9]+:[0-9]+:([0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*)?:([0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*)?/g.test(tmp)) {

                tmp = tmp.split(":");

                pending.timestamp = tmp[0];
                pending.storeId = tmp[1];
                pending.shopCart = new Array();
                pending.wishCart = new Array();
                if (pending.storeId == self.iStoreId) {

                    tmp[2] = /[0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*/g.test(tmp[2]) ? tmp[2].split(",") : [];
                    tmp[3] = /[0-9]+_[\-0-9]+(,[0-9]+_[\-0-9]+)*/g.test(tmp[3]) ? tmp[3].split(",") : [];

                    for (var i = 0; i < tmp[2].length; i++) {
                        var item = new Object();
                        var tokens = tmp[2][i].split("_");
                        item.id = tokens[0];
                        item.quantity = parseFloat(tokens[1]);
                        pending.shopCart.push(item);
                    }

                    for (var i = 0; i < tmp[3].length; i++) {
                        var item = new Object();
                        var tokens = tmp[3][i].split("_");
                        item.id = tokens[0];
                        item.quantity = parseFloat(tokens[1]);
                        pending.wishCart.push(item);
                    }
                } else {
                    pending.storeId = self.iStoreId;
                    self.setPendingJSON(pending);
                }
            } else {
                pending.timestamp = "0";
                pending.storeId = self.iStoreId;
                pending.shopCart = new Array();
                pending.wishCart = new Array();
                self.setPendingJSON(pending);
            }
        }

        return pending;
    };

    InditexClass.prototype.setPendingJSON = function(json) {
        var self = this;
        var tmp = json.timestamp + ":" + json.storeId + ":";

        for (i = 0; i < json.shopCart.length; i++) {

            if (i > 0) {
                tmp += ",";
            }

            tmp += json.shopCart[i].id;
            tmp += "_";
            tmp += json.shopCart[i].quantity;
            if(Inditex.iEnableOrderItemsOrigin && json.shopCart[i].origin){
                tmp += "@";
                tmp += self.serializeJSON(json.shopCart[i].origin);
                tmp += "\\@"
            }
        }

        tmp += ":";

        for (i = 0; i < json.wishCart.length; i++) {

            if (i > 0) {
                tmp += ",";
            }

            tmp += json.wishCart[i].id;
            tmp += "_";
            tmp += json.wishCart[i].quantity;
        }

        self.writeCookie("WC_ITX_PENDINGDATA", tmp);
    };

    InditexClass.prototype.addItem = function(aCart, aOrderItem, origin) {
        var self = this;
        var pJson = self.getPendingJSON();
        var found = false;

        for (var i = 0; i < pJson[aCart].length; i++) {
            if (pJson[aCart][i].id == aOrderItem.sku) {
                pJson[aCart][i].quantity += aOrderItem.quantity;
                found = true;
                if(self.iEnableOrderItemsOrigin && origin){
                    var a = {};
                    a.quantity = aOrderItem.quantity;
                    if(origin.categoryType)
                        a.categoryType = origin.categoryType;
                    if(origin.categoryData)
                        a.categoryData = origin.categoryData;
                    if(origin.parentId)
                        a.parentId = origin.parentId;
                    if(origin.productId)
                        a.productId = origin.productId;
                    if(!pJson[aCart][i].origin){
                        pJson[aCart][i].origin = new Array();
                    }
                    pJson[aCart][i].origin.push(a);
                }
            }
        }

        if (!found) {
            if(self.iEnableOrderItemsOrigin && origin){
                var o = new Object();
                o.id = aOrderItem.sku;
                o.quantity = aOrderItem.quantity;
                o.origin = new Array();
                var a = {};
                a.quantity = aOrderItem.quantity;
                if(origin.categoryType)
                    a.categoryType = origin.categoryType;
                if(origin.categoryData)
                    a.categoryData = origin.categoryData;
                if(origin.parentId)
                    a.parentId = origin.parentId;
                if(origin.productId)
                    a.productId = origin.productId;
                o.origin.push(a);
                pJson[aCart].push(o);
            }else{
                pJson[aCart].push({
                    "id":aOrderItem.sku,
                    "quantity":aOrderItem.quantity
                });
            }
        }

        pJson.timestamp = 1;
        self.setPendingJSON(pJson);

        var uJson = self._readUserJSON();
        if (uJson) {

            found = false;
            for (var i = 0; i < uJson[aCart].items.length; i++) {
                if (uJson[aCart].items[i].sku == aOrderItem.sku) {
                    uJson[aCart].items[i].quantity += aOrderItem.quantity;
                    found = true;
                }
            }

            if (!found && aOrderItem.quantity > 0) {
                uJson[aCart].items.push(aOrderItem);
            }

            uJson.timestamp = 1;
            self._writeUserJSON(uJson);
        }
        if (aOrderItem.reference!==undefined) {
            if(Inditex.iBrandId==3){
                var id;
                var ecId;
                if (aOrderItem.bundleReference!==undefined) {
                    id = aOrderItem.bundleReference+"/"+aOrderItem.reference.substring(0,11)+aOrderItem.reference.substring(13);
                    if (!Inditex.isMobilePath()) {
                        ecId = "Bundle_"+aOrderItem.bundleReference+"_Producto_"+aOrderItem.reference.substring(0,11)+aOrderItem.reference.substring(13);
                    } else {
                        ecId = id;
                    }
                } else {
                    id = aOrderItem.reference.substring(0,11)+aOrderItem.reference.substring(13);
                    ecId = id;
                }
                if (Inditex.iEnableUniversalAnalytics) {
                    Inditex.ga( 'ec:addProduct', jQuery.extend({
                        'id': id,
                        'name': aOrderItem.name,
                        'price': (aOrderItem.unitPrice * Math.pow(10, Inditex.iStoreJSON.details.locale.currencyDecimals)).toFixed(Inditex.iStoreJSON.details.locale.currencyDecimals*-1),
                        'quantity': aOrderItem.quantity
                    },aOrderItem.ecProperties?aOrderItem.ecProperties:{}));
                    Inditex.ga( 'ec:setAction', 'add');
                }
                var trackCategory = aOrderItem.trackCategory;
                if (!trackCategory) {
                    if (aOrderItem.bundleReference!==undefined) {
                        trackCategory = "Ficha_Bundle";
                    } else {
                        trackCategory = "Ficha_Producto";
                    }
                }
                self.trackEvent( trackCategory,"anadir_producto_cesta",id,self.iTrackPageDimension);
                self.trackPage((aCart == "shopCart" ? (Inditex.isMobilePath() ? "/M_Cesta_de_Compra" : '/Paginas_Virtuales/Cesta_de_Compra') : '/Wishlist')
                    + "/Anadir_Cesta/" + aOrderItem.reference);
            }else{
                self.trackPage((aCart == "shopCart" ? (Inditex.isMobilePath() ? "/M_Cesta_de_Compra" : '/Cesta_de_Compra') : '/Wishlist')
                    + "/Anadir_Cesta/" + aOrderItem.reference);
            }
        }
    };

    InditexClass.prototype._readUserJSON = function() {
        var self = this;
        var text = self.retrieve(WC_ITX_HEADERDATA);

        return text ? self.evalJSON(text) : null;
    };

    InditexClass.prototype.openShopCartWithItems = function(url) {
        var self = this;

        var obj = self.parseUrl(location.href);
        var openShopCart = obj.params["openShopCart"];
        var addItems = obj.params["addItems"];

        if(openShopCart!=undefined && addItems!=undefined){
            jQuery.each(addItems.split(','),function(index,sku){
                var item = {}
                item.sku  = sku;
                item.quantity = 1;
                if (Inditex.iEnableOrderItemsOrigin) {
                    Inditex.addItem("shopCart", jQuery.extend({ecProperties: {
                        'list':  Inditex._getECList(),
                        'brand': Inditex._getECBrand(),
                        'category': Inditex._getECCategory(),
                        'quantity': item.quantity
                    }},item),{
                        'categoryType':Inditex._getECList(),
                        'categoryData':Inditex._getECCategoryDataDB(),
                        'productId':null,
                        'parentId':null
                    });
                } else {
                    Inditex.addItem("shopCart", item);

                }
            });

            if(openShopCart == "true"){
                Inditex.orderManage({"url":Inditex.generateUrl("ItxOrderManageCmd", {
                    "storeId": Inditex.iStoreId,
                    "langId": Inditex.iLangId,
                    "catalogId": Inditex.iCatalogId,
                    "categoryId": Inditex.iCategoryId,
                    "URL":url
                },true)});
            }
        }


    };

    InditexClass.prototype._writeUserJSON = function(json) {
        var self = this;

        if (json) {
            self.store(WC_ITX_HEADERDATA, self.serializeJSON(json));
        }
    };

    InditexClass.prototype.getUserJSON = function(callback) {
        var self = this;
        var pJson = self.getPendingJSON();
        var uJson = self._readUserJSON();

        if (uJson && uJson.storeId == self.iStoreId
            && uJson.timestamp == pJson.timestamp
            && uJson.langId == self.iLangId) {

            callback(uJson);
        } else {


            if (pJson.timestamp == 1) {
                var url = self.generateUrl("ItxOrderManageCmd", {
                    "storeId": self.iStoreId,
                    "langId": self.iLangId,
                    "catalogId": self.iCatalogId,
                    "URL": "ItxStandardUserJSON"
                }, true);
                self.orderManage({
                    "url": url,
                    "method": "get",
                    "onSuccess": function(text) {
                        var uJson = self.evalJSON(text);
                        var pJson = self.getPendingJSON();
                        uJson.storeId = self.iStoreId;
                        uJson.timestamp = pJson.timestamp;
                        uJson.langId = self.iLangId;
                        self._writeUserJSON(uJson);
                        callback(uJson);
                    }
                });
            } else {
                var url;
                if(self.isMobilePath()){
                    url = self.generateUrl("ItxStandardUserJSON", {
                        "storeId": self.iStoreId,
                        "langId": self.iLangId,
                        "catalogId": self.iCatalogId,
                        "timestamp":(new Date()).getTime()
                    }, true);
                }else{
                    url = self.generateUrl("ItxStandardUserJSON", {
                        "storeId": self.iStoreId,
                        "langId": self.iLangId,
                        "catalogId": self.iCatalogId,
                        "timestamp":(new Date()).getTime()
                    }, true);
                }

                //Llamada para recuperar la informacion del usuario.
                self.request({
                    "url": url,
                    "method": "get",
                    "onSuccess": function(text) {
                        //Si va todo bien cacheo los datos.
                        if (text != null && text != undefined) {
                            var uJson = self.evalJSON(text);
                            var pJson = self.getPendingJSON();
                            uJson.storeId = self.iStoreId;
                            uJson.timestamp = pJson.timestamp;
                            uJson.langId = self.iLangId;
                            self._writeUserJSON(uJson);
                            callback(uJson);
                        } else {
                            //Si falla lo intentamos por segunda vez
                            self.request({
                                "url": url,
                                "method": "get",
                                "onSuccess": function(text) {
                                    //Si va todo bien cacheo los datos.
                                    if (text != null && text != undefined) {
                                        var uJson = self.evalJSON(text);
                                        var pJson = self.getPendingJSON();
                                        uJson.storeId = self.iStoreId;
                                        uJson.timestamp = pJson.timestamp;
                                        uJson.langId = self.iLangId;
                                        self._writeUserJSON(uJson);
                                        callback(uJson);
                                    } else {
                                        //Si falla siginifca que hemos intentado dos veces y no hemos sido capaz de recuperar su 
                                        //informacion, muestro la pagina de error.
                                        var urlError = self.generateUrl("ItxGenericErrorPage", {
                                            "storeId": self.iStoreId,
                                            "langId": self.iLangId,
                                            "catalogId": self.iCatalogId
                                        }, true);
                                        window.location = urlError;
                                    }
                                }
                            });
                        }
                    },
                    onFailure: function(xhr, textStatus, errorThrown){

                        self.request({
                            "url": url,
                            "method": "get",
                            "onSuccess": function(text) {
                                //Si va todo bien cacheo los datos.
                                if (text != null && text != undefined) {
                                    var uJson = self.evalJSON(text);
                                    var pJson = self.getPendingJSON();
                                    uJson.storeId = self.iStoreId;
                                    uJson.timestamp = pJson.timestamp;
                                    uJson.langId = self.iLangId;
                                    self._writeUserJSON(uJson);
                                    callback(uJson);
                                } else {
                                    //Si falla siginifca que hemos intentado dos veces y no hemos sido capaz de recuperar su 
                                    //informacion, muestro la pagina de error.
                                    var urlError = self.generateUrl("ItxGenericErrorPage", {
                                        "storeId": self.iStoreId,
                                        "langId": self.iLangId,
                                        "catalogId": self.iCatalogId
                                    }, true);
                                    window.location = urlError;
                                }
                            },
                            "onFailure": function(xhr, textStatus, errorThrown){
                                //Si falla signifca se ha intentado dos veces y no ha sido posible recuperar la
                                //informacion, muestro la pagina de error.
                                var urlError = self.generateUrl("ItxGenericErrorPage", {
                                    "storeId": self.iStoreId,
                                    "langId": self.iLangId,
                                    "catalogId": self.iCatalogId
                                }, true);
                                window.location = urlError;
                            }

                        });
                    }
                });
            }

        }
    };

    InditexClass.prototype.hasLocalStorage = function() {
        if('localStorage' in window && window['localStorage'] !== null){
            var test = 'test';
            try {
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch(e) {
                return false;
            }
        }else{
            return false;
        }
    };

    InditexClass.prototype.store = function(name, value) {
        var self = this;
        try {
            if (self.hasLocalStorage()) {
                localStorage.setItem(name, value);
            }
        } catch(e) {
        }
    };

    InditexClass.prototype.retrieve = function(name) {
        var self = this;

        if (self.hasLocalStorage()) {
            return localStorage.getItem(name);
        } else {
            return null;
        }
    };


    InditexClass.prototype.hasSessionStorage = function() {
        if('sessionStorage' in window && window['sessionStorage'] !== null){
            var test = 'test';
            try {
                sessionStorage.setItem(test, test);
                sessionStorage.removeItem(test);
                return true;
            } catch(e) {
                return false;
            }
        }else{
            return false;
        }
    };

    InditexClass.prototype.sessionStore = function(name, value) {
        var self = this;

        if (self.hasSessionStorage()) {
            sessionStorage.setItem(name, value);
        }
    };

    InditexClass.prototype.sessionRetrieve = function(name) {
        var self = this;

        if (self.hasSessionStorage()) {
            return sessionStorage.getItem(name);
        } else {
            return null;
        }
    };


    InditexClass.prototype.hasFlash = function() {
        var self = this;
        var hasFlash = false;

        if(navigator.plugins && navigator.plugins.length > 0) {
            var type = 'application/x-shockwave-flash';
            var mimeTypes = navigator.mimeTypes;
            if(mimeTypes && mimeTypes[type] && mimeTypes[type].enabledPlugin && mimeTypes[type].enabledPlugin.description) {
                hasFlash = true;
            }
        } else if(navigator.appVersion.indexOf("Mac") == -1 && window.execScript) {
            var activeXDetectRules = ["ShockwaveFlash.ShockwaveFlash.7", "ShockwaveFlash.ShockwaveFlash.6","ShockwaveFlash.ShockwaveFlash"];

            for(var i = 0; i < activeXDetectRules.length && !hasFlash; i++) {
                var obj = -1;
                try {
                    obj = new ActiveXObject(activeXDetectRules[i]);
                } catch(err) {
                    obj = {activeXError:true};
                }

                if(!obj.activeXError) {
                    hasFlash = true;
                }
            }
        }

        return hasFlash;
    };

    InditexClass.prototype.popupUrl = function(aUrl, aWidth, aHeight, aCallback) {
        var self = this;

        self.request({
            "url": aUrl,
            "onSuccess": function(aText) {
                self.popupHtml(aText, aWidth, aHeight, aCallback);
            }
        });
    };

    InditexClass.prototype._initGoogleMaps = function(aCallback) {
        var self = this;
        var head;
        var script;
        var done = false;
        var url;
        var params;

        if (location.protocol === "https:" && self.iGoogleMapsUser) {
            url = "https://www.google.com/jsapi";
            params = "sensor=false&client=" + self.iGoogleMapsUser +
                "&channel=" + self.iGoogleMapsChannel;
        } else {
            url = "https://www.google.com/jsapi?key=" + self.iGoogleMapsKey;
            params = "sensor=false&channel=" + self.iGoogleMapsChannel;
        }

        script = document.createElement("script");
        script.src = url;
        script.type = "text/javascript";
        script.onload = script.onreadystatechange = function() {
            if (!done) {
                if (!this.readyState ||
                    this.readyState === "loaded" ||
                    this.readyState === "complete") {

                    done = true;
                    script.onload = script.onreadystatechange = null;
                    if (head && script.parentNode) {
                        head.removeChild(script);
                    }

                    google.load("maps", "3", {
                        other_params: params,
                        callback: function(){
                            if (aCallback) {
                                aCallback();
                            }
                        }
                    });
                }
            }
        };

        head = document.getElementsByTagName("head")[0] || document.documentElement;
        if(!(head.children[0].src&&(head.children[0].src.indexOf("google.com/jsapi")>-1))){
            head.insertBefore(script, head.firstChild);
        }
    };

    InditexClass.prototype.getGoogleMapsMarkerUrl = function(aOn) {
        var self = this;
        var result;

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        result += result[result.length -1] == '/' ? '' : '/';

        if(Inditex.isMobilePath())
            result += "itxmobile/images/google_maps_marker_";
        else
            result += "itxstandard/images/google_maps_marker_";

        result += aOn ? "on" : "off";
        result += ".png";

        return result;
    };

    InditexClass.prototype.getGoogleMapsMarkerUrlAlt = function(aOn, aCustomIcon) {
        var self = this;
        var result;

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        result += result[result.length -1] == '/' ? '' : '/';

        if(Inditex.isMobilePath())
            result += "itxmobile/images/" + aCustomIcon + '_' ;
        else
            result += "itxstandard/images/" + aCustomIcon + '_';

        result += aOn ? "on" : "off";
        result += ".png";

        return result;
    };

    InditexClass.prototype.initGoogleMaps = function(aContainer, aCountry, aAddress, aCallback, aCustomIcon ) {
        var self = this;

        self.getGoogleCoords(aCountry, aAddress, function(aResult) {
            var map = {
                iMap: new google.maps.Map(document.getElementById(aContainer), {
                    zoom: 5,
                    center: aResult ? aResult.geometry.location : new google.maps.LatLng(0, 0),
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                }),

                iMarkers: [],
                iWindows: [],

                addMark: function(index, latitude, longitude, text, onSuccess) {
                    var self = this;

                    if ((aCustomIcon == undefined || aCustomIcon == true)){
                        self.iMarkers[index] = new google.maps.Marker({
                            position: new google.maps.LatLng(latitude, longitude),
                            map: self.iMap,
                            icon: Inditex.getGoogleMapsMarkerUrl(false)
                        });
                    }
                    else{
                        if ((aCustomIcon == false)){

                            self.iMarkers[index] = new google.maps.Marker({
                                position: new google.maps.LatLng(latitude, longitude),
                                map: self.iMap
                            });
                        }
                        else if(typeof aCustomIcon == "string"){
                            self.iMarkers[index] = new google.maps.Marker({
                                position: new google.maps.LatLng(latitude, longitude),
                                map: self.iMap,
                                icon: Inditex.getGoogleMapsMarkerUrlAlt(false, aCustomIcon)
                            });
                        }
                    }
                    if (text && text!=""){
                        self.iWindows[index] = new google.maps.InfoWindow({
                            content: text
                        });
                    }


                    google.maps.event.addListener(self.iMarkers[index], 'click', function(e) {
                        self.focusMark(index);
                        if (onSuccess) {
                            onSuccess(index);
                        }
                    });
                },

                focusMark: function(index) {
                    var self = this;

                    for(var i = 0; i < self.iMarkers.length; i++) {
                        if (i == index) {
                            if (self.iWindows[i]){
                                self.iWindows[i].open(self.iMap, self.iMarkers[i]);
                            }

                            if (!self.iMap.getBounds().contains(self.iMarkers[i].getPosition())) {
                                self.iMap.panTo(self.iMarkers[i].getPosition());
                            }
                            if (aCustomIcon == undefined || aCustomIcon == true) {
                                self.iMarkers[i].setIcon(Inditex.getGoogleMapsMarkerUrl(true));
                            }
                            else if (typeof aCustomIcon == "string") {
                                self.iMarkers[i].setIcon(Inditex.getGoogleMapsMarkerUrlAlt(true, aCustomIcon));
                            }
                        } else {
                            if (self.iWindows[i]){
                                self.iWindows[i].close();
                            }
                            if (aCustomIcon == undefined || aCustomIcon == true) {
                                self.iMarkers[i].setIcon(Inditex.getGoogleMapsMarkerUrl(false));
                            }
                            else if (typeof aCustomIcon == "string") {
                                self.iMarkers[i].setIcon(Inditex.getGoogleMapsMarkerUrlAlt(false, aCustomIcon));
                            }
                        }
                    }
                },
                clear: function() {
                    var self = this;

                    for (var i = 0; i < self.iMarkers.length; i++) {
                        self.iMarkers[i].setMap(null);
                        if(self.iWindows[i] != undefined){
                            self.iWindows[i].close();
                        }
                    }
                    self.iMarkers.length = 0;
                    self.iWindows.length = 0;
                },
                focus: function() {
                    var self = this;

                    var bounds = new google.maps.LatLngBounds();

                    for (var i = 0; i < self.iMarkers.length; i++) {
                        bounds.extend(self.iMarkers[i].getPosition());
                    }

                    self.iMap.fitBounds(bounds);
                    if(self.iMap.getZoom() > 17) {
                        self.iMap.setZoom(17);
                    }
                }
            }

            aCallback(map);
        });
    };

    InditexClass.prototype.getGoogleCoords = function(aCountry, aAddress, aCallback) {
        var self = this;

        self._initGoogleMaps(function() {
            var tokens = aCountry.split("_");
            var country = tokens[0];
            var address = aAddress;

            if ((country == "ES") && (aAddress == "ES")) {
                address = "Spain";
            }

            if (country == "ESCN" || country == "IC") {
                country = "ES";
                if(aAddress == "IC"){
                    address = "Canarias";
                }
            }

            var region = null;
            if (tokens.length > 1) {
                region = tokens[1];
            }

            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({address: address, region: country}, function(results, status) {
                var result = null;

                if(status = google.maps.GeocoderStatus.OK) {
                    for(var i = 0; i < results.length && result == null; i++){
                        var components = results[i].address_components;

                        var equalsCountry = false;
                        var equalsRegion = region ? false : true;

                        for(var j = components.length - 1; j >= 0; j--) {
                            var component = components[j];

                            if(!country || (component.types[0] == 'country' && component.types[1] == 'political' && component.short_name == country)) {
                                equalsCountry = true;
                            }

                            if((component.types[0]=='administrative_area_level_1' && component.types[1]=='political' && component.short_name == region)) {
                                equalsRegion = true;
                            }

                            if(equalsCountry && equalsRegion){
                                result = results[i];
                                break;
                            }
                        }
                    }
                }

                aCallback(result);
            });
        });
    };

    InditexClass.prototype.getProductImageUrls = function(aImageObj, aType, aSize, aExtension) {

        var self = this;
        var result = [];
        if(aImageObj!== null){
            if (aExtension == undefined) {
                aExtension = "jpg";
            }

            var base;
            if (window.location.protocol == 'https:') {
                base = self.iStoreJSON.details.imageBaseUrl.replace("http:", "https:");
            } else {
                base = self.iStoreJSON.details.imageBaseUrl.replace("https:", "http:");
            }
            if (aType == 2) {
                for (var i = 0; i < aImageObj.aux.length; i++) {
                    result.push(base + aImageObj.url + "_" + aType + "_" + aImageObj.aux[i] + "_" + aSize + "." + aExtension + "?t=" + aImageObj.timestamp);
                }
            } else {
                result.push(base + aImageObj.url + "_" + aType + "_1_" + aSize + "." + aExtension + "?t=" + aImageObj.timestamp);
            }
        }

        return result;
    };

    InditexClass.prototype.encodeHtml = function(aHtml) {
        return aHtml.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    };

    InditexClass.prototype.decodeHtml = function(aHtml) {
        return aHtml.replace(/&quot;/g, '"')
            .replace(/&gt;/g, '>')
            .replace(/&lt;/g, '<')
            .replace(/&amp;/g, '&');
    };

    InditexClass.prototype.writeStoreCookie = function() {
        var self = this;
        if (self.iStoreCookieName != undefined
            && /^[0-9]+$/.test(self.iStoreId)
            && /^([\-])?[0-9]+$/.test(self.iLangId)
            && /^[0-9]+$/.test(self.iCatalogId)) {

            self.writeCookie(self.iStoreCookieName,
                self.iStoreId + "," + self.iLangId + "," + self.iCatalogId);
        }
    };

    InditexClass.prototype.sortSizes = function(aSizeArray) {
        var self = this;

        return aSizeArray.sort(function(aSize1, aSize2) {
            var points = ["XXS","XS","S","M","L","XL","XXL"];
            var a_in_points = false;
            var b_in_points = false
            for (var i =0; i< points.length; i++) {
                if (points[i] == aSize1) {
                    a_in_points = true;
                    break;
                }
            }
            for (var i =0; i< points.length; i++) {
                if (points[i] == aSize2) {
                    b_in_points = true;
                    break;
                }
            }

            if(a_in_points && b_in_points){
                var index1 = -1;
                var index2 = -1;
                for (var i = 0; i < points.length; i++) {
                    if (aSize1.toUpperCase() == points[i]) {
                        index1 = i;
                    }
                    if (aSize2.toUpperCase() == points[i]) {
                        index2 = i;
                    }
                }

                if (index1 == -1 && index2 == -1) {
                    if (aSize1 < aSize2) {
                        return -1;
                    } else if (aSize1 == aSize2) {
                        return 0;
                    } else {
                        return 1;
                    }
                } else {
                    return index1 - index2;
                }
            }
            else if(a_in_points) return 1;
            else if(b_in_points) return -1;
            else{
                tmp_a = aSize1.replace(/([0-9]+)/g, "$1#").replace(/([a-zA-Z]+)/g,"$1#").replace(/#$/,"");
                tmp_b = aSize2.replace(/([0-9]+)/g, "$1#").replace(/([a-zA-Z]+)/g,"$1#").replace(/#$/,"");

                as = tmp_a.split("#");
                bs = tmp_b.split("#");

                for (var i =0; i< Math.min(as.length, bs.length); i++){
                    var a_has_number = /[0-9]/.test(as[i]);
                    var b_has_number = /[0-9]/.test(bs[i]);
                    if (a_has_number && b_has_number){
                        if(Number(as[i]) > Number(bs[i]))
                            return 1;
                        else if (Number(as[i]) < Number(bs[i])) return -1;
                    }
                    else{
                        if (as[i] > bs[i])
                            return 1;
                        else if (as[i] < bs[i]) return -1;
                    }
                }
                return as.length - bs.length;
            }
        });
    };


    InditexClass.prototype.getCookiePrefix = function() {
        var self = this;

        var brand = Math.floor(self.iStoreId/10000000);

        switch(brand) {
            case 2:
                return "WC_PB_";
            case 3:
                if (self.isMobilePath()) {
                    return "WC_MD_";
                } else {
                    return "WC_MD2_";
                }
            case 4:
                return "WC_BK_";
            case 5:
                return "WC_ST_";
            case 6:
                return "WC_OY_";
            case 7:
                return "WC_UT_";
            case 8:
                return "WC_ZH_";
            default:
                return "WC_ITX_";
        }
    };

    InditexClass.prototype.getCookieSufix = function() {
        var self = this;

        if(document.getElementById("cookiesVersion")){
            var version = document.getElementById("cookiesVersion").value;
            return "_"+version;
        }else{
            return "";
        }
    };

    InditexClass.prototype.getCookiesPolicyAccepted = function() {
        var self = this;

        var name = self.getCookiePrefix() + "COOKIESPOLICYACCEPTED"  + self.getCookieSufix();
        var value = Inditex.readCookie(name);

        return value === "true";
    };

    InditexClass.prototype.setCookiesPolicyAccepted = function() {
        var self = this;

        var name = self.getCookiePrefix() + "COOKIESPOLICYACCEPTED"  + self.getCookieSufix();

        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
            var index = cookies[i].indexOf("=");
            var key = cookies[i].substr(0, index).replace(/^\s+|\s+$/g, "");
            var value = cookies[i].substr(index + 1);
            if (key!=name && key.indexOf(self.getCookiePrefix()+"COOKIESPOLICYACCEPTED")==0) {
                Inditex.writeCookie(key,null,-1);
            }
        }

        Inditex.writeCookie(name, true, 365);
    };

    Inditex.iThirdPartyCookiesArray.push(function() {
        Inditex.enableGoogleAnalytics();
    });

    /**
     *
     */
    InditexClass.prototype.enableGoogleAnalytics = function() {
        if (this.iEnableGoogleAnalytics==true) {
            return;
        } else {
            this.iEnableGoogleAnalytics=true;
        }

        var self = this;
        var urlMSGoogleadservices = self.generateUrl(
            "ItxStandardMarketingSpotPage",
            {
                "storeId": self.iStoreId,
                "langId": self.iLangId,
                "catalogId": self.iCatalogId,
                "name": self.iSpotPrefix+'Googleadservices'
            },
            location.protocol == "https:");
        $('body').append($('<iframe src="'+urlMSGoogleadservices+'" style="border:none;width:1px;height:1px;" marginheight="0" marginwidth="0" frameborder="0"></iframe>'));

        window['ga-disable-'+self.iGaAccount] = false;

        var gaUrl = location.hostname + location.pathname + location.search;
        gaUrl += gaUrl.match(/\?/) ? '&' : '?';

        var gaLogic = window.MooTools
            ? $(document.body).getProperty("data-ga-logic")
            : jQuery(document.body).attr("data-ga-logic");
        var gaLogicU = window.MooTools
            ? $(document.body).getProperty("data-ga-logic-universal")
            : jQuery(document.body).attr("data-ga-logic-universal");
        var gaExternalOnly = window.MooTools
            ? $(document.body).getProperty("data-ga-external-only")
            : jQuery(document.body).attr("data-ga-external-only");
        var gaReferer = window.MooTools
            ? $(document.body).getProperty("data-ga-referer")
            : jQuery(document.body).attr("data-ga-referer");
        var gaSource = window.MooTools
            ? $(document.body).getProperty("data-ga-source")
            : jQuery(document.body).attr("data-ga-source");

        if (self.iEnableUniversalAnalytics) {
            if (Inditex.iBrandId!="3") {
                self.iEnableUniversalAnalyticsArray=false;
            }
            if (self.iEnableUniversalAnalytics==1) {
                Inditex.ga( 'create', self.iGaAccount, {
                    cookieDomain: self.iGaDomain
                });
            } else {
                Inditex.ga( 'create', self.iEnableUniversalAnalytics, {
                    cookieDomain: self.iGaDomain
                });
            }
            Inditex.ga( 'require', 'ec');
        }
        if (self.iEnableUniversalAnalytics!=1) {
            _gaq.push(['_setAccount', self.iGaAccount]);
            _gaq.push(['_setDomainName', self.iGaDomain]);
            _gaq.push(['_setCampaignCookieTimeOut', 2628000000]);
        }

        try {
            if (window.sessionStorage) {
                var r = window.sessionStorage.getItem("itxGaReferrer");
                if (r) {
                    if (self.iEnableUniversalAnalytics) {
                        Inditex.ga( 'set', 'referrer', r);
                    }
                    if (self.iEnableUniversalAnalytics!=1) {
                        _gaq.push(['_setReferrerOverride', r]);
                    }
                }
            }
        } catch (ignore) {}

        if (self.iEnableUniversalAnalytics!=1) {
            _gaq.push(['_setCustomVar', 2, 'Idioma', self.iGaIsoLang, 2]);
            _gaq.push(['_setCustomVar', 5, 'Pais', self.iGaIsoCountry, 2]);
        }

        if (self.iGaBuyerId) {
            if (self.iEnableUniversalAnalytics!=1) {
                _gaq.push(['_setCustomVar', 1, 'Comprador', 'ID_' + self.iGaBuyerId, 1]);
            }
        }

        if (self.iEnableUniversalAnalytics!=1) {
            _gaq.push(['_addIgnoredRef', 'www.paypal.com']);
        }

        var url = gaUrl + "mxr=";
        var urlU = gaUrl + "mxr=";
        if (Inditex.iBrandId=="3" && self.iEnableUniversalAnalytics) {
            if (self.isMobilePath()) {
                urlU += "/web-mobile";
            } else {
                urlU += "/web-standar";
            }
            if (gaLogicU && !/^\//.test(gaLogicU)) {
                gaLogicU = "/"+gaLogicU;
            }
            if (gaLogicU=="/Worldwide") {
                urlU += "/DuttiZXX/Worldwide/";
            } else {
                urlU += "/" + self.iGaIsoStore + gaLogicU;
            }
        }
        if (Inditex.iBrandId!="3" || self.iEnableUniversalAnalytics!=1) {
            if(Inditex.iBrandId=="3"&&gaLogic=="/Worldwide"){
                url += "/" + "DuttiZXX";
            }else if (self.iGaIsoStore) {
                url += "/" + self.iGaIsoStore;
            }
            if (/^\//.test(gaLogic)) {
                if (self.isMobilePath()) {
                    if (/^\/M_/.test(gaLogic)) {
                        url += gaLogic;
                    } else {
                        url += "/M_" + gaLogic.slice(1);
                    }
                } else {
                    if (/^\/M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(3);
                    } else {
                        url += gaLogic;
                    }
                }
            } else {
                if (self.isMobilePath()) {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic;
                    } else {
                        url += "/M_" + gaLogic;
                    }
                } else {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(2);
                    } else {
                        url += "/" + gaLogic;
                    }
                }
            }
        }

        Inditex.iWC_GASource = Inditex.readCookie("WC_GASource");
        Inditex.iPrevGaSource = Inditex.sessionRetrieve("prevGASource");
        Inditex.iPrevURL = Inditex.sessionRetrieve("prevURL");
        Inditex.sessionStore("prevGASource",Inditex.iWC_GASource);
        Inditex.sessionStore("prevURL",window.location.href);
        if (self.iEnableUniversalAnalytics!=1 || Inditex.iBrandId!="3") {
            if (gaSource == "cookie") {
                var source = Inditex.iWC_GASource;
                if (source) {
                    url += "/Origen_" + source;
                } else {
                    var domain = self.iGaDomain[0] == '.' ? self.iGaDomain.substr('1') : self.iGaDomain;
                    if (new RegExp("^(http(s)?://)?(www\\.)?.*(" + domain + ").*","i").test(document.referrer)) {
                        url += "/Origen_Interno";
                    } else {
                        url += "/Origen_Externo";
                    }
                }
            } else if (gaSource == "referer") {
                url += "/Origen_" + (document.referrer ? document.referrer : "Desconocido");
            }
        }

        Inditex.writeCookie("WC_GASource", "");

        if (self.iEnableUniversalAnalytics) {
            if (Inditex.iBrandId=="3") {
                self.ga( 'set', 'dimension1', self.iGaIsoCountry);
                self.ga( 'set', 'dimension2', self.iGaIsoLang);
                self.ga( 'set', 'dimension14', window.navigator.platform);
                var paraEjecutarPre = self.iEnableUniversalAnalyticsArray;
                self.iEnableUniversalAnalyticsArray = [];
                self.getUserJSON(function(userJSON){
                    var paraEjecutarPos = self.iEnableUniversalAnalyticsArray;
                    self.iEnableUniversalAnalyticsArray=false;
                    for (var i = 0; i < paraEjecutarPre.length; i++) {
                        try {
                            paraEjecutarPre[i]();
                        } catch (ignore2) {}
                    }
                    self.ga( 'set', 'dimension4', userJSON.isBuyer?'Si':'No');
                    self.ga( 'set', 'dimension13', userJSON.userType=="R"?'Logueado':'No Logueado');
                    self.ga( 'set', 'dimension19', userJSON.isWalletUser?'Si':'No');
                    if (gaLogicU !== undefined) {
                        self.ga( 'set', 'page', urlU);
                        self.ga( 'send', 'pageview', jQuery.extend({},self.iTrackPageDimension));
                    }
                    for (var i = 0; i < paraEjecutarPos.length; i++) {
                        try {
                            paraEjecutarPos[i]();
                        } catch (ignore2) {}
                    }
                });
            } else {
                if (gaLogic !== undefined) {
                    Inditex.ga( 'set', 'page', url);
                    Inditex.ga( 'send', 'pageview');
                }
            }
            if (gaLogic !== undefined) {
                if (self.iEnableUniversalAnalytics!=1) {
                    _gaq.push(['set', 'page', url]);
                    _gaq.push(['_trackPageview', url]);
                }
            }
        } else {
            if (gaLogic !== undefined) {
                _gaq.push(['set', 'page', url]);
                _gaq.push(['_trackPageview', url]);
            }
        }

    };

    /**
     * This method is used to track orders with analytics.
     */
    InditexClass.prototype.trackOrder = function(aOrder, aShippingAddress) {
        var self = this;

        try {
            if (self.iEnableUniversalAnalytics  && !self.iBrandId=="3") {
                Inditex.ga( 'require', 'ecommerce', 'ecommerce.js');
            }

            for (var i = 0; i < aOrder.items.length; i++) {
                self.trackPage("/Paginas_Virtuales/Look_to_book/" + aOrder.items[i].parentReference.trim() + "/Confirmacion");
            }

            if (self.iStoreJSON.details.locale.currencyCode != "EUR" ) {
                if (self.iEnableUniversalAnalytics&& !self.iBrandId=="3") {
                    Inditex.ga( 'ecommerce:addTransaction', {
                        id: aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-EUR',
                        affiliation: aOrder.payment[0].name,
                        revenue: (aOrder.totalOrderEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        shipping: (aOrder.shippingPriceEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        tax: ''
                    });
                }
                if (!self.iEnableUniversalAnalytics || self.iEnableUniversalAnalytics!=1) {
                    _gaq.push([
                        '_addTrans',
                        aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-EUR',
                        aOrder.payment[0].name,
                        (aOrder.totalOrderEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        '',
                        (aOrder.shippingPriceEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        aShippingAddress.city,
                        aShippingAddress.stateCode,
                        aShippingAddress.countryCode
                    ]);
                }

                for (var i = 0; i < aOrder.items.length; i++) {
                    if (!aOrder.items[i].categoryIdentifier) aOrder.items[i].categoryIdentifier="";
                    var totalItem = aOrder.items[i].quantity;
                    var totalItemOrigin = 0;
                    var categoryKey = self.iEnableOrderItemsOrigin? '':aOrder.items[i].categoryIdentifier;
                    var enc = false;
                    if(aOrder.items[i].origin != null && aOrder.items[i].origin.length > 0){
                        for(var j=aOrder.items[i].origin.length-1; j>=0 && !enc; j--){
                            var categoryData = aOrder.items[i].origin[j].categoryData.split('#')[0];
                            if(categoryData=="-1"){
                                categoryKey = "BUSCADOR_INTERNO";
                                enc = true;
                            }else{
                                var categories = new Array();
                                if(Inditex.iCategoryTreeJSON && Inditex.iCategoryTreeJSON.categories && Inditex.iCategoryTreeJSON.categories.length>0){
                                    jQuery.each(Inditex.iCategoryTreeJSON.categories,function(index,category){
                                        categories.push(category);
                                    });
                                }
                                while(categories.length>0 && !enc){
                                    var category = categories[0];
                                    if(category.id == categoryData){
                                        categoryKey = category.key;
                                        enc = true;
                                    }else{
                                        if(category.subcategories && category.subcategories.length>0){
                                            jQuery.each(category.subcategories,function(index2,subcategory){
                                                categories.push(subcategory);
                                            });
                                        }
                                        categories.splice(0,1);
                                    }
                                }
                            }

                        }
                    }

                    if (self.iEnableUniversalAnalytics && !self.iBrandId=="3") {
                        Inditex.ga( 'ecommerce:addItem', {
                            id: aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-EUR',
                            sku: aOrder.items[i].reference,
                            name: aOrder.items[i].parentReference,
                            category: categoryKey,
                            price: (aOrder.items[i].unitPriceEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                            quantity: aOrder.items[i].quantity
                        });
                    }
                    if (!self.iEnableUniversalAnalytics || self.iEnableUniversalAnalytics!=1) {
                        _gaq.push([
                            '_addItem',
                            aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-EUR',
                            aOrder.items[i].reference,
                            aOrder.items[i].parentReference,
                            categoryKey,
                            (aOrder.items[i].unitPriceEuro * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                            aOrder.items[i].quantity
                        ]);
                    }
                }
            }

            if (self.iEnableUniversalAnalytics  && !self.iBrandId=="3") {
                Inditex.ga( 'ecommerce:addTransaction', {
                    id:  aOrder.id + '-' + self.iGaIsoStore + ((Inditex.isMobilePath()&& self.iBrandId!="3" ) ? '-Movil' : '') + '-' + self.iStoreJSON.details.locale.currencyCode,
                    affiliation: aOrder.payment[0].name,
                    revenue: (aOrder.totalOrder * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                    shipping: (aOrder.shippingPrice * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                    tax: ''
                });
            }
            if (!self.iEnableUniversalAnalytics || self.iEnableUniversalAnalytics!=1) {
                _gaq.push([
                    '_addTrans',
                    aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-' + self.iStoreJSON.details.locale.currencyCode,
                    aOrder.payment[0].name,
                    (aOrder.totalOrder * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                    '',
                    (aOrder.shippingPrice * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                    aShippingAddress.city,
                    aShippingAddress.stateCode,
                    aShippingAddress.countryCode
                ]);
            }

            for (var i = 0; i < aOrder.items.length; i++) {
                if (!aOrder.items[i].categoryIdentifier) aOrder.items[i].categoryIdentifier="";
                var totalItem = aOrder.items[i].quantity;
                var totalItemOrigin = 0;
                var categoryKey = self.iEnableOrderItemsOrigin? '':aOrder.items[i].categoryIdentifier;
                var enc = false;
                if(aOrder.items[i].origin != null && aOrder.items[i].origin.length > 0){
                    for(var j=aOrder.items[i].origin.length-1; j>=0 && !enc; j--){
                        var categoryData = aOrder.items[i].origin[j].categoryData.split('#')[0];
                        if(categoryData=="-1"){
                            categoryKey = "BUSCADOR_INTERNO";
                            enc = true;
                        }else{
                            var categories = new Array();
                            if(Inditex.iCategoryTreeJSON && Inditex.iCategoryTreeJSON.categories && Inditex.iCategoryTreeJSON.categories.length>0){
                                jQuery.each(Inditex.iCategoryTreeJSON.categories,function(index,category){
                                    categories.push(category);
                                });
                            }
                            while(categories.length>0 && !enc){
                                var category = categories[0];
                                if(category.id == categoryData){
                                    categoryKey = category.key;
                                    enc = true;
                                }else{
                                    if(category.subcategories && category.subcategories.length>0){
                                        jQuery.each(category.subcategories,function(index2,subcategory){
                                            categories.push(subcategory);
                                        });
                                    }
                                    categories.splice(0,1);
                                }
                            }
                        }

                    }
                }

                if (self.iEnableUniversalAnalytics && !self.iBrandId=="3") {
                    Inditex.ga( 'ecommerce:addItem', {
                        id: aOrder.id + '-' + self.iGaIsoStore + ((Inditex.isMobilePath()&& self.iBrandId!="3" ) ? '-Movil' : '') + '-' + self.iStoreJSON.details.locale.currencyCode,
                        sku: aOrder.items[i].reference,
                        name: aOrder.items[i].parentReference,
                        category: categoryKey,
                        price: (aOrder.items[i].unitPrice * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        quantity: aOrder.items[i].quantity
                    });
                }
                if (!self.iEnableUniversalAnalytics || self.iEnableUniversalAnalytics!=1) {
                    _gaq.push([
                        '_addItem',
                        aOrder.id + '-' + self.iGaIsoStore + (Inditex.isMobilePath() ? '-Movil' : '') + '-' + self.iStoreJSON.details.locale.currencyCode,
                        aOrder.items[i].reference,
                        aOrder.items[i].parentReference,
                        categoryKey,
                        (aOrder.items[i].unitPrice * Math.pow(10, self.iStoreJSON.details.locale.currencyDecimals)).toFixed(self.iStoreJSON.details.locale.currencyDecimals*-1),
                        aOrder.items[i].quantity
                    ]);
                }
            }

            if (self.iEnableUniversalAnalytics && !self.iBrandId=="3") {
                Inditex.ga( 'ecommerce:send');
            }
            if (!self.iEnableUniversalAnalytics || self.iEnableUniversalAnalytics!=1) {
                _gaq.push(['_trackTrans']);
            }
        } catch (ignore) {
        }
    };

    /**
     * This method is used to track user interactions with analytics.
     */
    InditexClass.prototype.trackEvent = function(aSource, aAction, aExtra, isUniversal) {
        var self = this;

        if (isUniversal != undefined && isUniversal.page != undefined && self.iBrandId=="3"){
            isUniversal.page= self.getPageAnalytics(isUniversal.page);
        }

        if (this.iEnableGoogleAnalytics!=true) {
            var args = arguments;
            this.iThirdPartyCookiesArray.push(function() {
                self.trackEvent.apply(self,arguments);
            });
            return;
        } else if (self.iEnableUniversalAnalytics && self.iEnableUniversalAnalyticsArray!==false) {
            var args = arguments;
            self.iEnableUniversalAnalyticsArray.push(function() {
                self.trackEvent.apply(self,args);
            })
            return;
        }

        if (typeof isUniversal==="object" && isUniversal.hitCallback) {
            var alreadyCalled = false;
            var callback = isUniversal.hitCallback;
            var wrapperHitCallback = function() {
                if (alreadyCalled) return;
                alreadyCalled = true;
                callback();
            }
            if (!self.iEnableUniversalAnalytics || !(ga.hasOwnProperty('loaded') && ga.loaded === true)) {
                wrapperHitCallback();
            } else {
                isUniversal.hitCallback = wrapperHitCallback;
                setTimeout(wrapperHitCallback, 2000);
            }
        }

        if (self.iBrandId=="3" && (
            (self.iEnableUniversalAnalytics==1 && !isUniversal) ||
            (self.iEnableUniversalAnalytics==0 && isUniversal))) {
            return;
        }

        if (aExtra) {
            if (isUniversal) {
                Inditex.ga( 'send', 'event', aSource, aAction.replace(/&|&amp;/g,"_"), aExtra, jQuery.extend({},isUniversal));
            } else if (self.iEnableUniversalAnalytics==1) {
                Inditex.ga( 'send', 'event', aSource, aAction.replace(/&|&amp;/g,"_"), aExtra);
            } else {
                _gaq.push(['_trackEvent', aSource, aAction.replace(/&|&amp;/g,"_"), aExtra]);
            }
        } else {
            if (isUniversal) {
                Inditex.ga( 'send', 'event', aSource, aAction.replace(/&|&amp;/g,"_"), jQuery.extend({},isUniversal));
            } else if (self.iEnableUniversalAnalytics==1) {
                Inditex.ga( 'send', 'event', aSource, aAction.replace(/&|&amp;/g,"_"));
            } else {
                _gaq.push(['_trackEvent', aSource, aAction.replace(/&|&amp;/g,"_")]);
            }
        }
    };

    /**
     * This method is used to track a page view with analytics.
     */
    InditexClass.prototype.trackPage = function(aLogic, isUniversal) {
        var self = this;
        var url;
        var gaLogic = aLogic;

        if (this.iEnableGoogleAnalytics!=true) {
            var args = arguments;
            this.iThirdPartyCookiesArray.push(function() {
                self.trackPage.apply(self,arguments);
            });
            return;
        } else if (self.iEnableUniversalAnalytics && self.iEnableUniversalAnalyticsArray!==false) {
            var args = arguments;
            self.iEnableUniversalAnalyticsArray.push(function() {
                self.trackPage.apply(self,args);
            })
            return;
        }

        if (self.iBrandId=="3" && (
            (self.iEnableUniversalAnalytics==1 && !isUniversal) ||
            (self.iEnableUniversalAnalytics==0 && isUniversal))) {
            return;
        }

        url = "&mxr=";
        if (Inditex.iBrandId=="3" && isUniversal) {
            if (self.isMobilePath()) {
                url += "/web-mobile";
            } else {
                url += "/web-standar";
            }
            if (!/^\//.test(gaLogic)) {
                gaLogic = "/"+gaLogic;
            }
            url += "/" + self.iGaIsoStore + gaLogic;
        } else {
            if (self.iGaIsoStore) {
                url += "/" + self.iGaIsoStore
            }

            if (/^\//.test(gaLogic)) {
                if (self.isMobilePath()) {
                    if (/^\/M_/.test(gaLogic)) {
                        url += gaLogic;
                    } else {
                        url += "/M_" + gaLogic.slice(1);
                    }
                } else {
                    if (/^\/M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(3);
                    } else {
                        url += gaLogic;
                    }
                }
            } else {
                if (self.isMobilePath()) {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic;
                    } else {
                        url += "/M_" + gaLogic;
                    }
                } else {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(2);
                    } else {
                        url += "/" + gaLogic;
                    }
                }
            }
        }

        if (isUniversal) {
            if (isUniversal.page===false) {
                delete isUniversal.page;
                Inditex.ga( 'send', 'pageview', jQuery.extend({'page':url},isUniversal));
            } else {
                Inditex.ga( 'set', 'page', url);
                Inditex.ga( 'send', 'pageview', jQuery.extend({},isUniversal));
            }
        } else {
            if (self.iEnableUniversalAnalytics==1) {
                Inditex.ga( 'send', 'pageview',{'page':url});
            } else {
                _gaq.push(['_trackPageview', url]);
            }
        }
    };

    /**
     * Metodo usado para aadir al Page de Analytics informacin adicional cuando se lanza el InditexClass.prototype.trackEvent y se le indica un page manualmente.
     */
    InditexClass.prototype.getPageAnalytics = function(aLogic)
    {
        var self = this;
        var gaLogic = aLogic;

        url = "&mxr=";
        if (Inditex.iBrandId=="3" && aLogic) {
            if (self.isMobilePath()) {
                url += "/web-mobile";
            } else {
                url += "/web-standar";
            }
            if (!/^\//.test(gaLogic)) {
                gaLogic = "/"+gaLogic;
            }
            url += "/" + self.iGaIsoStore + gaLogic;
        } else {
            if (self.iGaIsoStore) {
                url += "/" + self.iGaIsoStore
            }

            if (/^\//.test(gaLogic)) {
                if (self.isMobilePath()) {
                    if (/^\/M_/.test(gaLogic)) {
                        url += gaLogic;
                    } else {
                        url += "/M_" + gaLogic.slice(1);
                    }
                } else {
                    if (/^\/M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(3);
                    } else {
                        url += gaLogic;
                    }
                }
            } else {
                if (self.isMobilePath()) {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic;
                    } else {
                        url += "/M_" + gaLogic;
                    }
                } else {
                    if (/^M_/.test(gaLogic)) {
                        url += "/" + gaLogic.slice(2);
                    } else {
                        url += "/" + gaLogic;
                    }
                }
            }
        }
        return url;
    };


    /**
     * Metodo usado para etiquetado de informacion con comercio electronico mejorado
     */
    InditexClass.prototype.ga = function() {
        var self = this;
        if (self.iEnableUniversalAnalytics) {
            if (this.iEnableGoogleAnalytics==true) {
                if (self.iEnableUniversalAnalyticsArray!==false) {
                    var args = arguments;
                    self.iEnableUniversalAnalyticsArray.push(function() {
                        self.ga.apply(self,args);
                    })
                    return;
                } else {
                    window.ga.apply(window,arguments);
                }
            } else {
                var args = arguments;
                self.iThirdPartyCookiesArray.push(function() {
                    window.ga.apply(window,args);
                });
            }
        }
    }


    /**
     * This method sets a cookie with the source that will be used in order to
     * track with analytics.
     */
    InditexClass.prototype.setSource = function(aSource) {
        Inditex.writeCookie("WC_GASource", aSource.replace(/&|&amp;/g,"_"));
    };

    InditexClass.prototype.getPaymentMethodImageUrl = function(aPaymentMethodObj, aExtension) {
        var self = this;

        var url;
        if (window.location.protocol == 'https:') {
            url = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            url = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        url += url[-1] == '/' ? '' : '/';

        if(Inditex.isMobilePath())
            url += "itxmobile/images/payment/";
        else
            url += "itxstandard/images/payment/";

        url += aPaymentMethodObj.code;
        url += ".";
        url += aExtension;
        url += "?";
        url += self.iStoreJSON.details.timestampBuildVersion;

        return url;
    };

    InditexClass.prototype.getProductVisibilityMap = function(aProductArray, aStockArray, aCategoryJson) {
        var self = this;
        var mode = self.iStoreJSON.details.showProductCategorySkuNoStock;

        // Si la categora contiene SHOW_ALL_PRODUCTS el modo es SHOW
        if(aCategoryJson && aCategoryJson.key){
            if(aCategoryJson.key.indexOf("SHOW_ALL_PRODUCTS")>0){
                mode = "SHOW";
            }
        }

        // Si la categora contiene un asset del tipo SHOW_PRODUCT_CATEGORY_SKU_NO_STOCK el modo es SHOW
        if(aCategoryJson && aCategoryJson.attachments){
            for (var i = 0; i < aCategoryJson.attachments.length; i++) {
                if (aCategoryJson.attachments[i].type == "SHOW_PRODUCT_CATEGORY_SKU_NO_STOCK"){
                    mode = "SHOW";
                }
            }
        }

        var stockMap = {};
        var visibilityMap = {};
        var visibilityMapProductBundle = {};

        for (var i = 0; i < aStockArray.length; i++) {
            var stockDetailArray = aStockArray[i].stocks;

            for (var j = 0; j < stockDetailArray.length; j++) {
                var stockDetail = stockDetailArray[j];

                stockMap[stockDetail.id] = stockDetail.availability;
            }
        }

        var priority = {
            "hidden":0,
            "sold_out":1,
            "coming_soon":2,
            "back_soon":3,
            "show":4
        };

        for (var i = 0; i < aProductArray.length; i++) {
            var product = aProductArray[i];
            var colorArray = product.detail.colors;
            var bundleProductArray = product.bundleProductSummaries;
            visibilityMap[product.id] = "hidden";

            //Comprobamos si est configurado el stock automtico.
            var automaticComingSoon = Inditex.iIsAutomaticComingSoon;
            if(automaticComingSoon){
                if(Inditex.automaticComingSoonSection){
                    var comingSoonSections = Inditex.automaticComingSoonSection.split(",");
                    if(comingSoonSections.indexOf(product.section)<0){
                        automaticComingSoon = false;
                    }
                }
                if(Inditex.automaticComingSoonCampaign){
                    var comingSoonSections = Inditex.automaticComingSoonCampaign.split(",");
                    var data = product.detail.reference.split("-");
                    if(data.length>1){
                        var campaign = data[1];
                        if(comingSoonSections.indexOf(campaign)<0){
                            automaticComingSoon = false;
                        }
                    }
                }
                if(Inditex.automaticComingSoonFfmcenter){
                    var comingSoonFfmcenters = Inditex.automaticComingSoonFfmcenter.split(",");
                    if(comingSoonFfmcenters.indexOf(Inditex.iStoreJSON.ffmcenter.toString())<0){
                        automaticComingSoon = false;
                    }
                }
            }

            if (colorArray != undefined && colorArray != null
                && colorArray.length > 0) {

                for (var j = 0; j < colorArray.length; j++) {
                    var sizeArray = colorArray[j].sizes;

                    for (var k = 0; k < sizeArray.length; k++) {
                        var size = sizeArray[k];

                        if (size.backSoon == 1 || product.backSoon == 1) {

                            if (stockMap[size.sku] == null
                                || stockMap[size.sku] == undefined
                                || stockMap[size.sku] == "unknown") {

                                visibilityMap[size.sku] = "coming_soon";
                            } else if (stockMap[size.sku] == "out_of_stock"){
                                visibilityMap[size.sku] = "back_soon";
                            } else {
                                visibilityMap[size.sku] = "show";
                            }
                        }else if (stockMap[size.sku] == null
                            || stockMap[size.sku] == undefined
                            || stockMap[size.sku] == "unknown"
                            || stockMap[size.sku] == "out_of_stock") {

                            visibilityMap[size.sku] = mode == "SHOW"
                                ? "sold_out" : "hidden";
                        } else {
                            visibilityMap[size.sku] = "show";
                        }

                        if (priority[visibilityMap[product.id]]
                            < priority[visibilityMap[size.sku]]) {

                            visibilityMap[product.id] = visibilityMap[size.sku];
                        }
                    }

                    //ECOMDUTI-2667
                    if(automaticComingSoon){
                        var allSizeSkuStockUnknow = true;
                        for (var k = 0; k < sizeArray.length; k++) {
                            var size = sizeArray[k];
                            if(stockMap[size.sku] != "unknown"){
                                allSizeSkuStockUnknow = false;
                            }
                        }
                        if(allSizeSkuStockUnknow){
                            visibilityMap[product.id] = "coming_soon";
                            for (var k = 0; k < sizeArray.length; k++) {
                                var size = sizeArray[k];
                                visibilityMap[size.sku] = "coming_soon";
                            }
                        }
                    }

                    //ECOMDUTI-2976
                    if(Inditex.showAllProductsEnabled){
                        visibilityMap[product.id] = "show";
                        for (var k = 0; k < sizeArray.length; k++) {
                            var size = sizeArray[k];
                            visibilityMap[size.sku] = "show";
                        }
                    }


                }
            } else if (bundleProductArray != undefined
                && bundleProductArray != null
                && bundleProductArray.length > 0) {

                for (var j = 0; j < bundleProductArray.length; j++) {
                    var bundleProduct = bundleProductArray[j];
                    var colorArray = bundleProduct.detail.colors;
                    visibilityMapProductBundle[bundleProduct.id] = "hidden";
                    visibilityMapProductBundle[product.id] = "hidden";

                    //Comprobamos si est configurado el stock automtico.
                    var automaticComingSoon = Inditex.iIsAutomaticComingSoon;
                    if(automaticComingSoon){
                        if(Inditex.automaticComingSoonSection){
                            var comingSoonSections = Inditex.automaticComingSoonSection.split(",");
                            if(comingSoonSections.indexOf(bundleProduct.section)<0){
                                automaticComingSoon = false;
                            }
                        }
                        if(Inditex.automaticComingSoonCampaign){
                            var comingSoonSections = Inditex.automaticComingSoonCampaign.split(",");
                            var data = bundleProduct.detail.reference.split("-");
                            if(data.length>1){
                                var campaign = data[1];
                                if(comingSoonSections.indexOf(campaign)<0){
                                    automaticComingSoon = false;
                                }
                            }
                        }
                        if(Inditex.automaticComingSoonFfmcenter){
                            var comingSoonFfmcenters = Inditex.automaticComingSoonFfmcenter.split(",");
                            if(comingSoonFfmcenters.indexOf(Inditex.iStoreJSON.ffmcenter.toString())<0){
                                automaticComingSoon = false;
                            }
                        }
                    }

                    if (colorArray != undefined && colorArray != null
                        && colorArray.length > 0) {

                        for (var k = 0; k < colorArray.length; k++) {
                            var sizeArray = colorArray[k].sizes;

                            for (var l = 0; l < sizeArray.length; l++) {
                                var size = sizeArray[l];

                                if (size.backSoon == 1
                                    || bundleProduct.backSoon == 1
                                    || product.backSoon == 1) {

                                    if (stockMap[size.sku] == null
                                        || stockMap[size.sku] == undefined
                                        || stockMap[size.sku] == "unknown") {

                                        visibilityMapProductBundle[size.sku] = "coming_soon";
                                    } else if (stockMap[size.sku] == "out_of_stock"){
                                        visibilityMapProductBundle[size.sku] = "back_soon";
                                    } else {
                                        visibilityMapProductBundle[size.sku] = "show";
                                    }
                                }  else if (stockMap[size.sku] == null
                                    || stockMap[size.sku] == undefined
                                    || stockMap[size.sku] == "unknown"
                                    || stockMap[size.sku] == "out_of_stock") {

                                    visibilityMapProductBundle[size.sku] = mode == "SHOW"
                                        ? "sold_out" : "hidden";
                                } else {
                                    visibilityMapProductBundle[size.sku] = "show";
                                }

                                if (priority[visibilityMapProductBundle[bundleProduct.id]]
                                    < priority[visibilityMapProductBundle[size.sku]]) {

                                    visibilityMapProductBundle[bundleProduct.id] =
                                        visibilityMapProductBundle[size.sku];
                                }
                            }

                            //ECOMDUTI-2667
                            if(automaticComingSoon){
                                var allSizeSkuStockUnknow = true;
                                for (var l = 0; l < sizeArray.length; l++) {
                                    var size = sizeArray[l];
                                    if(stockMap[size.sku] != "unknown"){
                                        allSizeSkuStockUnknow = false;
                                    }
                                }
                                if(allSizeSkuStockUnknow){
                                    visibilityMapProductBundle[bundleProduct.id] = "coming_soon";
                                    for (var l = 0; l < sizeArray.length; l++) {
                                        var size = sizeArray[l];
                                        visibilityMapProductBundle[size.sku] = "coming_soon";
                                    }
                                }
                            }

                            //ECOMDUTI-2976
                            if(Inditex.showAllProductsEnabled){
                                visibilityMapProductBundle[bundleProduct.id] = "show";
                                for (var l = 0; l < sizeArray.length; l++) {
                                    var size = sizeArray[l];
                                    visibilityMapProductBundle[size.sku] = "show";
                                }
                            }

                        }
                    } else {
                        visibilityMapProductBundle[bundleProduct.id] = "show";
                    }

                    if (priority[visibilityMapProductBundle[product.id]]
                        < priority[visibilityMapProductBundle[bundleProduct.id]]) {
                        visibilityMap[product.id] = visibilityMapProductBundle[bundleProduct.id];
                    }
                }
            } else {
                visibilityMap[product.id] = "show";
            }
        }
        jQuery.each(visibilityMapProductBundle,function(id,visibility){
            if(!visibilityMap[id]){
                visibilityMap[id] = visibility;
            }
        });


        return visibilityMap;
    };

    InditexClass.prototype.getUserAddressBookJSON = function(aOptions) {
        var self;
        var url;
        var params;

        self = this;

        url = self.generateUrl("ItxStandardUserAddressBookJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId,
            "errorViewName" : "ItxStandardJSON"
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    (function() {
        InditexClass.prototype._doTestCookiesPolicy = function() {
            var self = this;

            if (self.getCookiesPolicyAccepted()) {
                self.enableThirdPartyCookies();
            } else {
                if (typeof Inditex.showCookiesWarn == "function") {
                    Inditex.showCookiesWarn();
                }

                if (window.MooTools) {
                    $(document).removeEvents("mousedown");
                    $(document).addEvent("mousedown", function(event) {
                        var flag = true;
                        // para Oysho no activar si mostrado overlay_shadow
                        if ($(document.body).getElement(".overlay_shadow") != null) {
                            if ($(document.body).getElement(".overlay_shadow").getStyle('display') == "block") {
                                if ($$("div.overlay div.shop_guide").size()>0) {
                                    flag = false;
                                }
                            }
                        }
                        if ($(document.body).hasClass('notSetCookies') == true) {
                            return;
                        }
                        if (flag) {
                            self.enableThirdPartyCookies();
                        }
                    });


                    $(document.body).getElement("#cookiesWarn").removeEvents("mousedown");
                    $(document.body).getElement("#cookiesWarn").addEvent("mousedown", function(event) {
                        event.stopPropagation();
                    });
                } else {
                    jQuery(document).bind("mousedown", function(event) {
                        var flag = true;
                        // para Oysho no activar si mostrado overlay_shadow
                        if ($('.overlay_shadow').length > 0) {
                            if ($('.overlay_shadow').css('display') == "block") {
                                if ($("div.overlay div.shop_guide").size()>0) {
                                    flag = false;
                                }
                            }
                        }
                        if ($(document.body).hasClass('notSetCookies') == true) {
                            return;
                        }
                        if (flag){
                            self.enableThirdPartyCookies();
                        }
                    });

                    jQuery("#cookiesWarn").bind("mousedown", function(event) {
                        event.stopPropagation();
                    });
                }
                if (document.addEventListener) {
                    document.addEventListener("click", function capturador(event) {
                        if (self.iEnabledThirdPartyCookies) {
                            if (event.target.clickFromTimeout!=true) {
                                event.preventDefault();
                                event.stopPropagation();
                                setTimeout( function() {
                                    event.target.clickFromTimeout=true;
                                    var evObj = document.createEvent('MouseEvents');
                                    evObj.initMouseEvent('click', event.bubbles, event.cancelable, event.view, event.detail, event.screenX, event.screenY, event.clientX, event.clientY, event.ctrlKey, event.altKey, event.shiftKey, event.metaKey, event.button, event.relatedTarget);
                                    event.target.dispatchEvent(evObj);
                                }, 100);
                                document.removeEventListener("click",capturador,true);
                                return false;
                            }
                            event.target.clickFromTimeout=false;
                        }
                    }, true);
                }
            }
        };

        Inditex.iReadyArray.push(function() {
            Inditex._doTestCookiesPolicy();
        });

        InditexClass.prototype.iEnabledThirdPartyCookies = false;

        InditexClass.prototype.enableThirdPartyCookies = function() {
            var self,i;

            self = this;

            if (self.iEnabledThirdPartyCookies) {
                return;
            } else {
                self.iEnabledThirdPartyCookies = true;
            }

            if (typeof Inditex.closeCookiesWarn == "function") {
                try {
                    Inditex.closeCookiesWarn();
                } catch (ignore1) {}
            }

            for (i = 0; i < self.iThirdPartyCookiesArray.length; i++) {
                try {
                    self.iThirdPartyCookiesArray[i]();
                } catch (ignore2) {}
            }
        };
    })();

    Inditex.iReadyArray.push(function() {
        Inditex.writeStoreCookie();
    });

    Inditex.iReadyArray.push(function() {
        if (Inditex.iDrawHeaderOnReady) {
            Inditex.drawHeader();
        }
    });

    Inditex.iReadyArray.push(function() {
        Inditex.writeItxSourceCookie();
    });

    Inditex.iReadyArray.push(function() {
        setTimeout(function(){Inditex.thereCookieInternalError();}, 500);
    });


    (function() {
        function gaPageHandler(aEvent) {
            if (window.MooTools) {
                Inditex.trackPage(this.getProperty("data-ga-page-logic"));
            } else {
                Inditex.trackPage(jQuery(this).attr("data-ga-page-logic"));
            }
        }

        function gaEventHandler(aEvent) {
            var source = window.MooTools
                ? this.getProperty("data-ga-source")
                : jQuery(this).attr("data-ga-source");
            var action = window.MooTools
                ? this.getProperty("data-ga-action")
                : jQuery(this).attr("data-ga-action");
            var extra = window.MooTools
                ? this.getProperty("data-ga-extra")
                : jQuery(this).attr("data-ga-extra");

            if (extra)
                Inditex.trackEvent(source, action, extra);
            else
                Inditex.trackEvent(source, action);
        }

        function gaSourceHandler(aEvent) {
            var source = window.MooTools
                ? this.getProperty("data-ga-source-value")
                : jQuery(this).attr("data-ga-source-value");

            Inditex.setSource(source);
        }

        Inditex.iInitHtmlArray.push(function() {
            if (window.MooTools) {
                $$(".gaPage").each(function(aItem) {
                    if (aItem.itxHasGaPageHandler == undefined) {
                        var event = aItem.getProperty("data-ga-page-event");
                        if (event) {
                            aItem.addEvent(event, gaPageHandler);
                        }
                        aItem.itxHasGaPageHandler = true;
                    }
                });
            } else {
                jQuery(".gaPage").each(function(aIndex, aItem) {
                    if (aItem.itxHasGaPageHandler == undefined) {
                        var event = jQuery(aItem).attr("data-ga-page-event");
                        if (event) {
                            jQuery(aItem).bind(event, gaPageHandler);
                        }
                        aItem.itxHasGaPageHandler = true;
                    }
                });
            }
        });

        Inditex.iInitHtmlArray.push(function() {
            if (window.MooTools) {
                $$(".gaEvent").each(function(aItem) {
                    if (aItem.itxHasGaEventHandler == undefined) {
                        var event = aItem.getProperty("data-ga-event");
                        if (event) {
                            aItem.addEvent(event, gaEventHandler);
                        }
                        aItem.itxHasGaEventHandler = true;
                    }
                });
            } else {
                jQuery(".gaEvent").each(function(aIndex, aItem) {
                    if (aItem.itxHasGaEventHandler == undefined) {
                        var event = jQuery(aItem).attr("data-ga-event");
                        if (event) {
                            jQuery(aItem).bind(event, gaEventHandler);
                        }
                        aItem.itxHasGaEventHandler = true;
                    }
                });
            }
        });

        Inditex.iInitHtmlArray.push(function() {
            if (window.MooTools) {
                $$(".gaSource").each(function(aItem) {
                    if (aItem.itxHasGaSourceHandler == undefined) {
                        var event = aItem.getProperty("data-ga-source-event");
                        if (event) {
                            aItem.addEvent(event, gaSourceHandler);
                        }
                        aItem.itxHasGaSourceHandler = true;
                    }
                });
            } else {
                jQuery(".gaSource").each(function(aIndex, aItem) {
                    if (aItem.itxHasGaSourceHandler == undefined) {
                        var event = jQuery(aItem).attr("data-ga-source-event");
                        if (event) {
                            jQuery(aItem).bind(event, gaSourceHandler);
                        }
                        aItem.itxHasGaSourceHandler = true;
                    }
                });
            }
        });

    })();

    InditexClass.prototype.initHtml = function(aRootElement) {
        var self = this;

        for (var i = 0; i < self.iInitHtmlArray.length; i++) {
            try {
                self.iInitHtmlArray[i](aRootElement);
            } catch (err) {
                if (window.console) {
                    window.console.log(err);
                }
            }
        }
    };

    Inditex.iReadyArray.push(function() {
        Inditex.initHtml();
    });

    InditexClass.prototype.onReady = function() {
        var self = this;

        for (var i = 0; i < self.iReadyArray.length; i++) {
            try {
                self.iReadyArray[i]();
            } catch (err) {
                if (window.console) {
                    window.console.log(err);
                }
            }
        }
    };

    InditexClass.prototype.onResize = function() {
        var self = this;

        for (var i = 0; i < self.iResizeArray.length; i++) {
            try {
                self.iResizeArray[i]();
            } catch (err) {
                if (window.console) {
                    window.console.log(err);
                }
            }
        }
    };

    InditexClass.prototype.getRestCatalogProductListStock = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/product/stock";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        path += "&productIds=" + encodeURIComponent(aOptions.products);

        self.getRestJSON(location.protocol, 1, path, null,
            aOptions.onSuccess, aOptions.onFailure);
    };

    InditexClass.prototype.getUserAddressJSON = function(aOptions) {
        var self;
        var url;
        var params;

        self = this;

        url = self.generateUrl("ItxStandardUserAddressJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId,
            "addressId": aOptions.addressId,
            "forceCommerce": aOptions.forceCommerce
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getBamStoresJSON = function(aOptions) {
        var self;
        var url;
        var params;

        self = this;

        params = {};
        params.storeId = self.iStoreId;
        params.langId = self.iLangId;
        params.catalogId = self.iCatalogId;

        if (aOptions.latitude != undefined) {
            params.latitude = aOptions.latitude;
        }

        if (aOptions.longitude != undefined) {
            params.longitude = aOptions.longitude;
        }

        if (aOptions.favouriteStores != undefined) {
            params.favouriteStores = aOptions.favouriteStores;
        }

        if (aOptions.lastStores != undefined) {
            params.lastStores = aOptions.lastStores;
        }

        if (aOptions.receiveEcommerce != undefined) {
            params.receiveEcommerce = aOptions.receiveEcommerce;
        }

        if (aOptions.max != undefined) {
            params.max = aOptions.max;
        }

        if (aOptions.min != undefined) {
            params.min = aOptions.min;
        }

        if (aOptions.countryCode != undefined){
            params.countryCode = aOptions.countryCode;
        }
        if (aOptions.showBlockedByMaxPackage != undefined){
            params.showBlockedByMaxPackage = aOptions.showBlockedByMaxPackage;
        }

        url = self.generateUrl("ItxStandardBamStoresJSON", params, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getBamStoreJSON = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardBamStoreJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId,
            "physicalStoreId": aOptions.physicalStoreId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restBamAddFavouriteStore = function(aOptions) {
        var self;
        var url;
        var viewname = null;
        var errorViewName  = 'ItxStandardJSON';

        self = this;

        url = Inditex.generateUrl(
            'ItxStandardAddFavouritePhysicalStoreCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "langId"			: Inditex.iLangId,
                "catalogId"			: Inditex.iCatalogId,
                "physicalStoreId"	: aOptions.physicalStoreId,
                "viewname"			: viewname,
                "errorViewName"     : errorViewName
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restBamDeleteFavouriteStore = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardJSON';

        self = this;

        url = Inditex.generateUrl(
            'ItxStandardRemoveFavouritePhysicalStoreCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "langId"			: Inditex.iLangId,
                "catalogId"			: Inditex.iCatalogId,
                "physicalStoreId"	: aOptions.physicalStoreId,
                "viewname"			: viewname,
                "errorViewName"     : errorViewName
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restWalletMakeCardDefault = function(aOptions) {
        var self;
        var url;

        self = this;

        url = Inditex.generateUrl(
            'ItxStandardSetDefaultPaymentCardCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "langId"			: Inditex.iLangId,
                "catalogId"			: Inditex.iCatalogId,
                "hash"				: aOptions.hash
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restWalletDeleteCard = function(aOptions) {
        var self;
        var url;

        self = this;

        url = Inditex.generateUrl(
            'ItxStandardRemovePaymentCardCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "langId"			: Inditex.iLangId,
                "catalogId"			: Inditex.iCatalogId,
                "hash"				: aOptions.hash
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };



    InditexClass.prototype.getRestOrderShoppingCart = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardOrderShoppingCartJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };


    InditexClass.prototype.getRestOrderAffinityModes = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardOrderAffinityModesJSON", {}, true);

        var params={
            "amount": aOptions.amount,
            "number": aOptions.number,
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "vatin": aOptions.vatin
        };

        self.request({
            "url": url,
            "method": "post",
            "data": jQuery.param(params),
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestOrderPaymentModes = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardOrderPaymentModesJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "number": aOptions.number ? aOptions.number : "",
            "vatin": aOptions.vatin,
            "amount": aOptions.amount,
            "policy": aOptions.policy
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestGiftCardGetBalance = function(aOptions) {
        var self = this;
        var url;

        url = self.generateUrl("ItxStandardGiftCardGetBalanceJSON", {
        }, true);

        var objData = {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "number": aOptions.number,
            "cvv": aOptions.cvv,
            "captcha": aOptions.captcha
        };

        var separador = "";
        var data = "";
        for (var key in objData) {
            data += separador+key+"="+encodeURIComponent(objData[key]);
            separador = "&";
        }

        self.request({
            "url": url,
            "data": data,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };

    InditexClass.prototype.getRestOrderCardAdjustmentsJSON = function(aOptions) {
        var self = this;
        var url;

        var data = "storeId=" + encodeURIComponent(self.iStoreId);
        data += "&langId=" + encodeURIComponent(self.iLangId);
        data += "&catalogId=" + encodeURIComponent(self.iCatalogId);
        data += "&orderId=" + encodeURIComponent(aOptions.orderId);
        if (aOptions.action !== undefined) {
            data += "&action=" + encodeURIComponent(aOptions.action);
        }
        if (aOptions.captcha !== undefined) {
            data += "&captcha=" + encodeURIComponent(aOptions.captcha);
        }

        if (aOptions.cards) {
            for (i = 0; i < aOptions.cards.length; i++) {
                for (var k in aOptions.cards[i]) {
                    data += "&" + k + "_" + i + "=" + encodeURIComponent(aOptions.cards[i][k]);
                }
            }
        }

        url = self.generateUrl("ItxStandardOrderCardAdjustmentsCmd", null, true);

        self.request({
            "url": url,
            "data": data,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };

    InditexClass.prototype.getRestWalletGetWalletCards = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardWalletGetWalletCardsJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId

        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestWalletGetInWalletCards = function(aOptions) {
        var self;
        var url;

        self = this;

        var params={
            "email": aOptions.email,
            "password": aOptions.password,
            "storeId": self.iStoreId,
            "langId": self.iLangId

        };
        url = self.generateUrl("ItxStandardWalletGetInWalletCardsJSON", {}, true);



        self.request({
            "url": url,
            "method": "post",
            "data": jQuery.param(params),
            "onSuccess": function(aText) {
                try{
                    aOptions.onSuccess(self.evalJSON(aText));
                }catch(e){
                    aOptions.onFailure(aText);
                }
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestWalletGetWalletCards2 = function(aOptions) {
        var self = this;

        var path = "/wallet/store/" + self.iStoreId + "/cards2";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        var loginRequest = {
            "email": aOptions.email,
            "password": aOptions.password
        }

        self.getRestJSON(location.protocol, 1, path, self.serializeJSON(loginRequest), aOptions.onSuccess,
            aOptions.onFailure);
    };


    InditexClass.prototype.getRestOrderOrder = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardOrderOrderJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "orderId": aOptions.orderId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestOrderShippingMethods = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardOrderShippingMethodsJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getRestWishWishListByUser = function(aOptions) {
        var self;
        var url;

        self = this;

        url = self.generateUrl("ItxStandardWishWishListByUserJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };


    InditexClass.prototype.getMarketingSpot = function(aOptions) {
        var self;
        var url;

        self = this;

        if (!(self.iIsMockup)) {
            var protocol = aOptions.protocol;
            if (protocol===undefined || protocol===null) {
                protocol = window.location.protocol=="https:"?"https":"http";
            }
            url = self.generateUrl("ItxStandardMarketingSpotPage", {
                "storeId": self.iStoreId,
                "langId": self.iLangId,
                "catalogId": self.iCatalogId,
                "name": aOptions.name,
                "protocol": protocol
            }, location.protocol == "https:");
        }
        else {
            url = "../../../../spot/"+aOptions.name+".html";
        }

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(aText);
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    var ITX_LAST_VIEW_PRODUCTS_INFO = "ITX_LAST_VIEW_PRODUCTS_INFO";

    InditexClass.prototype.addProductToLastProductList = function(aProductJSON, aCallback) {
        var self = this;

        self.getLocalAttribute(ITX_LAST_VIEW_PRODUCTS_INFO, function(aKey, aValue) {
            var i;
            if (!aValue || (aValue.storeId != self.iStoreId)) {
                aValue = {
                    storeId: self.iStoreId,
                    products: []
                }
            }

            for (i = 0; i < aValue.products.length; i++) {
                if (aValue.products[i].product.id == aProductJSON.id) {
                    aValue.products.splice(i, 1);
                    break;
                }
            }

            aValue.products.push({
                timestamp: new Date().getTime(),
                catalogId: self.iCatalogId,
                categoryId: self.iCategoryId ? self.iCategoryId : 0,
                product: aProductJSON
            });

            if (aValue.products.length > self.iMaxLastProductListLength) {
                aValue.products.shift();
            }

            self.setLocalAttribute(ITX_LAST_VIEW_PRODUCTS_INFO, aValue, function(aKey1, aValue1) {
                if (typeof aCallback == "function") {
                    aCallback.apply(self);
                }
            });
        });
    };

    InditexClass.prototype.getRestCatalogProductDetailList = function(aOptions) {
        var argumentList = aOptions.products;

        var json = {
            "products": []
        };

        var getProductDetails = function() {
            if (argumentList.length > 0) {
                var args = argumentList.shift();
                Inditex.getRestCatalogProductDetail({
                    "catalogId": args.catalogId,
                    "categoryId": args.categoryId,
                    "productId": args.productId,
                    "onSuccess": function(productJSON) {
                        json.products.push({
                            "catalogId": args.catalogId,
                            "categoryId": args.categoryId,
                            "product": productJSON
                        });
                        getProductDetails();
                    },
                    "onFailure": function(status){
                        aOptions.onFailure(status);
                    }
                });
            } else {
                aOptions.onSuccess(json);
            }
        };

        getProductDetails();
    }

    var LAST_PRODUCT_DT = 3600000;

    function getLastProductListRecursive(aSelf, aObj, aIndex, aCallback) {
        var t;

        if (aIndex < aObj.products.length) {
            t = new Date().getTime();
            if ((t - aObj.products[aIndex].timestamp) > LAST_PRODUCT_DT) {
                Inditex.getRestCatalogProductDetail({
                    catalogId: aObj.products[aIndex].catalogId,
                    categoryId: 0,
                    productId: aObj.products[aIndex].product.id,
                    onSuccess: function(aProductJSON) {
                        aObj.products[aIndex] = {
                            timestamp: t,
                            catalogId: aObj.products[aIndex].catalogId,
                            categoryId: aObj.products[aIndex].categoryId,
                            product: aProductJSON
                        }

                        getLastProductListRecursive(aSelf, aObj, aIndex + 1, aCallback);
                    },
                    onFailure: function() {
                        aObj.products.splice(aIndex, 1);

                        getLastProductListRecursive(aSelf, aObj, aIndex, aCallback);
                    }
                });
            } else {
                getLastProductListRecursive(aSelf, aObj, aIndex + 1, aCallback);
            }
        } else {
            aSelf.setLocalAttribute(ITX_LAST_VIEW_PRODUCTS_INFO, aObj, function (aKey, aValue) {
                aCallback.apply(aSelf, [aValue]);
            });
        }
    }

    InditexClass.prototype.getLastProductList = function(aCallback) {
        var self = this;

        self.getLocalAttribute(ITX_LAST_VIEW_PRODUCTS_INFO, function(aKey, aValue) {
            if (!aValue || (aValue.storeId != self.iStoreId)) {
                aValue = {
                    storeId: self.iStoreId,
                    products: []
                }
            }

            getLastProductListRecursive(self, aValue, 0, aCallback);
        });
    };

    InditexClass.prototype.restOrderAddPromoCode = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardJSON';

        self = this;

        if (aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        var url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addPromoCode',
                'code'			: aOptions.promoCode,
                'viewname'		: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderDeletePromoCode = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';

        self = this;

        if (aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        var url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'removePromoCode',
                'code'			: aOptions.promoCode,
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    //TODO Modificar vistas para que sean modificables
    InditexClass.prototype.restOrderAddGiftTicket = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        var url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addGiftTicket',
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderDeleteGiftTicket = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        var url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'removeGiftTicket',
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderAddGiftPacking = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addGiftPackingAndText',
                'text'			: aOptions.message,
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderDeleteGiftPacking = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'removeGiftPacking',
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderAddGiftPackingOnlyText = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addGiftPackingText',
                'text'			: aOptions.message,
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderAddPhysicalGiftCard = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addPhysicalGiftCardItem',
                'catEntryId'	: aOptions.catEntryId,
                'senderName'	: aOptions.senderName,
                'receiverName'	: aOptions.receiverName,
                'receiverEmail'	: aOptions.receiverEmail,
                'receiverPhone'	: aOptions.receiverPhone,
                'message'		: aOptions.message,
                'quantity'		: aOptions.quantity == null ? 1 : aOptions.quantity,
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.restOrderAddVirtualGiftCard = function(aOptions) {
        var self;
        var url;
        var viewname = errorViewName  = 'ItxStandardUserJSON';
        self = this;

        if (aOptions != undefined && aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions != undefined && aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId"		: Inditex.iStoreId,
                "langId"		: Inditex.iLangId,
                "catalogId"		: Inditex.iCatalogId,
                'action'		: 'addVirtualGiftCardItem',
                'catEntryId'	: aOptions.catEntryId,
                'senderName'	: aOptions.senderName,
                'receiverName'	: aOptions.receiverName,
                'receiverEmail'	: aOptions.receiverEmail,
                'receiverPhone'	: aOptions.receiverPhone,
                'message'		: aOptions.message,
                'quantity'		: aOptions.quantity == null ? 1 : aOptions.quantity,
                'addHours'		: aOptions.addHours,
                'year'			: aOptions.year == null ? "" : aOptions.year,
                'month'			: aOptions.month == null ? "" : aOptions.month,
                'day'			: aOptions.day == null ? "" : aOptions.day,
                'hour'			: aOptions.hour == null ? "" : aOptions.hour,
                'minute'		: aOptions.minute == null ? "" : aOptions.minute,
                'URL'			: viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype._getAllCategoryFilters = function() {
        var self = this;

        if (self.hasLocalStorage()) {
            var text = self.retrieve('ITX_CATEGORY_FILTER');
            return text ? self.evalJSON(text) : null;
        } else {
            var text = self.readCookie('ITX_CATEGORY_FILTER');
            return text ? self.evalJSON(text) : null;
        }
    };

    InditexClass.prototype.setCategoryFilter = function(aCategoryId, aFilters, aCatentryIds) {
        var self = this;

        var allFiltersJSON = {};

        try {
            var aCategoryId= parseInt(aCategoryId);
        } catch (err) {
        }

        if (typeof aCategoryId != "number")
            return;

        if (typeof aFilters != "object" || typeof aFilters == "object" && Object.prototype.toString.call(aFilters) != "[object Array]")
            return;

        if (typeof aCatentryIds != "object" || typeof aCatentryIds == "object" && Object.prototype.toString.call(aCatentryIds) != "[object Array]")
            return;


        for (var i=0; i<aCatentryIds.length; i++){
            if(aCatentryIds[i].categoryId){
                for (var j=0; j<aCatentryIds[i].catentryIds.length; j++){
                    if (typeof aCatentryIds[i].catentryIds[j] != "number")
                        return;
                }
            }
            else{
                if (typeof aCatentryIds[i] != "number")
                    return;
            }
        }

        allFiltersJSON[('' + aCategoryId)] = {
            "filters": aFilters,
            "catentryIds": aCatentryIds
        };

        if (self.hasLocalStorage()) {
            self.store('ITX_CATEGORY_FILTER', self.serializeJSON(allFiltersJSON));
        } else {

            self.writeCookie('ITX_CATEGORY_FILTER', self.serializeJSON(allFiltersJSON));
        }
    };

    InditexClass.prototype.getCategoryFilter = function(aCategoryId) {
        var self = this;

        try {
            return self._getAllCategoryFilters()[aCategoryId];
        } catch (e) {
        }
        return null;
    };

    InditexClass.prototype.initVideo = function(aElementId, aVideoArray, aOptions) {
        var self = this;

        if (window.MooTools) {
            var container = $(aElementId + "_container");
            if (container)
                container.destroy();
        } else {
            jQuery("#" + aElementId + "_container").remove();
        }


        var div = (window.MooTools) ? $(aElementId) : jQuery("#"+aElementId);

        var options = {
            autoplay: true
        }

        if (typeof(aOptions) != "undefined" && typeof(aOptions.autoplay) != "undefined") {
            options.autoplay = aOptions.autoplay;
        }
        if (typeof(aOptions) != "undefined" && typeof(aOptions.wmode) != "undefined") {
            options.wmode = aOptions.wmode;
        }

        if (typeof(aOptions) != "undefined" && typeof(aOptions.scaling) != "undefined") {
            //Se comprueba si es una de las opciones validas de flowplayer
            var scalingValues = ['fit', 'half', 'orig', 'scale'];
            for (i = 0; i<scalingValues.length ; i++){
                if (scalingValues[i] == aOptions.scaling){
                    options.scaling = aOptions.scaling;
                }
            }
        }

        if (typeof(aOptions) != "undefined" && typeof(aOptions.backgroundColor) != "undefined") {
            //Comprueba si es un codigo hexadecimal valido de tres o seis cifras.
            if (/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(aOptions.backgroundColor)) {
                options.backgroundColor = aOptions.backgroundColor;
            }
        }

        if (typeof(aOptions) != "undefined" && typeof(aOptions.onLoad) != "undefined") {
            //Comprueba si hay funcin para cargar el video.
            options.onLoad = aOptions.onLoad;
        }

        if (typeof(aOptions) != "undefined" && typeof(aOptions.poster) != "undefined") {
            options.poster = aOptions.poster;
        }

        var getMimeTypeByExtension = function(filename) {
            var mimeTable = {
                "mp4" : "video/mp4",
                "ogv" : "video/ogg",
                "ogg" : "video/ogg",
                "webm": "video/webm"
            }
            var tokens = filename.split('.');
            var ext = tokens[tokens.length-1];
            ext = ext.split('?')[0];

            return (mimeTable[ext]) ? mimeTable[ext] : "application/octet-stream";
        }

        if (!!document.createElement('video').canPlayType) {
            if (window.MooTools) {

                var videoEl = new Element("video", {
                    width: "100%",
                    height: "100%",
                    controls: ""
                });
                if (options.autoplay)
                    videoEl.setAttribute('autoplay', "true");

                if (options.poster)
                    videoEl.setAttribute('poster', options.poster);

                for (var i=0; i<aVideoArray.length; i++) {
                    videoEl.grab(new Element('source', {
                            'src' : aVideoArray[i],
                            'type': getMimeTypeByExtension(aVideoArray[i])
                        })
                    );
                }

                div.grab(
                    new Element("div", {
                        id: (aElementId + "_container")
                    }).grab(
                        videoEl
                    )
                );
            } else {
                var html =
                    '<div style="display:table; width: 100%">' +
                    ' <div id="#id#" style="display: table-cell; vertical-align:middle; text-align:center;">' +
                    ' <video style="width: 100%; height: 100%;" #autoplay# controls=""';

                if (options.poster){
                    html = html + 'poster="' + options.poster + '" >';
                } else {
                    html = html + ' >';
                }

                for (var i=0; i<aVideoArray.length; i++) {
                    html += '<source src="' + aVideoArray[i] + '" type="' + getMimeTypeByExtension(aVideoArray[i]) + '" />';
                }
                html +=
                    ' </video>' +
                    ' </div>' +
                    '</div>';

                el = jQuery(
                    html.replace('#id#', (aElementId + "_container"))
                        .replace("#autoplay#", ((options.autoplay) ? ' autoplay="true" ' : ''))
                );

                div.append(el);
            }
        } else {
            if (window.MooTools) {
                var aVideoTag = div.grab(new Element("a", {
                    id: (aElementId + "_container"),
                    href: aVideoArray[0]
                }));
                if (options.poster){
                    aVideoTag.grab(new Element("img",{
                        id: (aElementId + "_container_img"),
                        src: options.poster,
                        alt: "poster image"
                    }));
                }
            } else {
                var html = '<a id="#id#" href="#href#"></a>'
                        .replace('#id#', (aElementId + "_container"))
                        .replace(/#href#/g, aVideoArray[0])
                    ;

                div.append(jQuery(html));
                if (options.poster){
                    var img = '<img id="#id#" src="#src#" alt="#alt#" />'
                            .replace('#id#', (aElementId + "_container_img"))
                            .replace(/#src#/g, options.poster)
                            .replace(/#alt#/g, "poster image")
                        ;
                    jQuery("#"+aElementId + "_container").append(jQuery(img));
                }

            }

            flowplayer((aElementId + "_container"), {
                    src: self.iFlowplayerSwf,
                    wmode: options.wmode
                },
                {
                    clip: {
                        autoPlay: options.autoplay,
                        scaling: options.scaling
                    },
                    onLoad: options.onLoad,
                    canvas: {
                        backgroundColor: options.backgroundColor
                    },
                    key: self.iFlowplayerKey
                });

        }
    };

    InditexClass.prototype.getShippingMethodsByZipCode = function(zipCode) {
        var self = this;
        var json;
        var path = "/order/store/" + self.iStoreId + "/"+ self.iCatalogId+"/shipping";
        if (self.iIsMockup) {
            path += ".json";
        }else{
            path += "?zipCode=" + zipCode + "&searchType=0" + "&languageId=" + self.iLangId;;
        }
        Inditex.iAjaxAsync = false;
        self.getRestJSON(location.protocol, 1, path, null,
            function(text){
                self.json = text;
            },
            function(text){
                self.json = text;
            }
        );
        Inditex.iAjaxAsync = true;
        return self.json;
    };

    InditexClass.prototype.getShippingMethodsRestrictedByZipCode = function(zipCode,aOnSuccess,aOnFailure) {
        var self = this;
        var json;
        var path = "/order/store/" + self.iStoreId + "/"+ self.iCatalogId+"/shipping";
        if (self.iIsMockup) {
            path += "/restricted/"+zipCode+".json";
        }else{
            path += "?zipCode=" + zipCode + "&searchType=1" + "&languageId=" + self.iLangId;;
        }
        self.getRestJSON(location.protocol, 1, path, null, aOnSuccess, aOnFailure);
        return self.json;
    };

    InditexClass.prototype.getShippingMethodsByDefault = function() {
        var self = this;
        var json;
        var path = "/order/store/" + self.iStoreId + "/"+ self.iCatalogId+"/shipping/default";
        if (self.iIsMockup) {
            path += ".json";
        }else{
            path += "?languageId=" + self.iLangId;;
        }
        Inditex.iAjaxAsync = false;
        self.getRestJSON(location.protocol, 1, path, null,
            function(text){
                self.json = text;
            },
            function(text){
                self.json = text;
            }
        );
        Inditex.iAjaxAsync = true;
        return self.json;
    };

    InditexClass.prototype.getShippingModeSelected = function(code, shippingModeList) {
        var self = this;
        if(!code || !shippingModeList || !shippingModeList.shippingMethods || shippingModeList.shippingMethods.length <= 0){
            return null;
        }
        var shippingMethods = shippingModeList.shippingMethods;

        for(i = 0; i< shippingMethods.length; i++ ){
            if(shippingMethods[i].code == code){
                return shippingMethods[i].id;
            }
        }
        //si no se encuentra ningn mtodo de envo en la lista de mtodos de envo que se corresponda 
        //con el code que se la pasa, se devuelve el primer mtodo de envo de la lista 
        return shippingMethods[0].id;
    };

    InditexClass.prototype.getRestStockPhysicalStores = function(aOptions) {
        var self = this;

        var params = {};
        params.storeId = self.iStoreId;
        params.langId = self.iLangId;
        params.catalogId = self.iCatalogId;

        if (aOptions.latitude != undefined) {
            params.latitude = aOptions.latitude;
        }

        if (aOptions.longitude != undefined) {
            params.longitude = aOptions.longitude;
        }

        if (aOptions.favouriteStores != undefined) {
            params.favouriteStores = aOptions.favouriteStores;
        }

        if (aOptions.lastStores != undefined) {
            params.lastStores = aOptions.lastStores;
        }

        if (aOptions.receiveEcommerce != undefined) {
            params.receiveEcommerce = aOptions.receiveEcommerce;
        }

        if (aOptions.max != undefined) {
            params.max = aOptions.max;
        }

        if (aOptions.min != undefined) {
            params.min = aOptions.min;
        }

        if (aOptions.countryCode != undefined){
            params.countryCode = aOptions.countryCode;
        }

        var urlPhysicalStore = self.generateUrl('ItxStandardListPhysicalStoreJSON', params, true);

        var infoStoreJSON = null;

        //1 Busco las tiendas fisicas de una longitud y latitud determinada
        self.request({
            "url": urlPhysicalStore,
            "method": "post",
            "onSuccess": function(text) {
                self.infoStoreJSON = self.evalJSON(text);

                var lsPartNumberData = aOptions.partNumber.split("-");

                //Preparo la url de busqueda de stock para un producto model color (talla no) 
                //para ello necesito el pathnamber y las tiendas donde tengo que buscar

                var path = aOptions.urlStockSotre.replace("_campaign_",lsPartNumberData[1]).replace("_part-number_",lsPartNumberData[0]);
                if (self.iIsMockup) {
                    path += ".json";
                }


                //Concateno las tiendas antes encontrada en la otra llamada
                for (var i=0; i < self.infoStoreJSON.closerStores.length; i++) {
                    if (i == 0) {
                        path += "?";
                    } else {
                        path += "&";
                    }
                    path += "physicalStoreId=" + self.infoStoreJSON.closerStores[i].id;
                }

                //2 Busco el stock con la llamada al servicio web como si fuese rest. 
                self.request({
                    "url": path,
                    "method": "post",
                    "onSuccess": function(aStock) {
                        if (aOptions.onSuccess) {
                            var stJSON_INFO_STORE = JSON.stringify(self.infoStoreJSON);
                            var stJSON_FINAL= '{"infoPhysicalStore" : ' + stJSON_INFO_STORE + ', "storeStock" :' + aStock + '}';

                            var JSONFinal = self.evalJSON(stJSON_FINAL);
                            aOptions.onSuccess(JSONFinal);
                        }
                    },
                    "onFailure": function() {
                        if (aOptions.onFailure) {
                            aOptions.onFailure();
                        }
                    }
                });
            }
        });
    };


    InditexClass.prototype.twinnedPartnumbersByColor = function(jSon, idColor) {
        var twinnedPartnumbersByColor = [];
        if (jSon != null && jSon.detail != null && jSon.detail.colors != null) {
            jQuery.each(jSon.detail.colors, function(index, color) {
                if(color.id == idColor){
                    jQuery.each(color.sizes, function(index2, size) {
                        var partNumberData = size.partnumber.split("-");
                        var mocaco = partNumberData[0].substr(0,partNumberData[0].length-2);
                        twinnedPartnumbersByColor.push(mocaco+"-"+partNumberData[1]);
                    });
                }
            });
        }

        var uniqueTwinnedPartnumbersByColor = twinnedPartnumbersByColor.filter(function(item, pos, self) {
            return self.indexOf(item) == pos;
        })

        return uniqueTwinnedPartnumbersByColor.toString();
    }


    InditexClass.prototype.getRestTwinnedStockPhysicalStores = function(aOptions) {
        var self = this;

        var params = {};
        params.storeId = self.iStoreId;
        params.langId = self.iLangId;
        params.catalogId = self.iCatalogId;

        if (aOptions.latitude != undefined) {
            params.latitude = aOptions.latitude;
        }

        if (aOptions.longitude != undefined) {
            params.longitude = aOptions.longitude;
        }

        if (aOptions.favouriteStores != undefined) {
            params.favouriteStores = aOptions.favouriteStores;
        }

        if (aOptions.lastStores != undefined) {
            params.lastStores = aOptions.lastStores;
        }

        if (aOptions.receiveEcommerce != undefined) {
            params.receiveEcommerce = aOptions.receiveEcommerce;
        }

        if (aOptions.max != undefined) {
            params.max = aOptions.max;
        }

        if (aOptions.min != undefined) {
            params.min = aOptions.min;
        }

        if (aOptions.countryCode != undefined){
            params.countryCode = aOptions.countryCode;
        }

        var urlPhysicalStore = self.generateUrl('ItxStandardListPhysicalStoreJSON', params, true);

        var infoStoreJSON = null;

        //1 Busco las tiendas fisicas de una longitud y latitud determinada
        self.request({
            "url": urlPhysicalStore,
            "method": "post",
            "onSuccess": function(text) {
                self.infoStoreJSON = self.evalJSON(text);

                var lsPartNumberData = aOptions.partNumber.split(",");

                var finishedRequest = new Array();
                for(var i=0;i<lsPartNumberData.length;i++){
                    finishedRequest.push(false);
                }


                var finalStoreStock = {};
                finalStoreStock.stocks = [];

                //Temporalmente se realiza una llamada para cada hermanado
                $.each(lsPartNumberData, function(index, partNumber) {

                    var partNumberData = partNumber.split("-");

                    //Preparo la url de busqueda de stock para un producto model color (talla no) 
                    //para ello necesito el pathnamber y las tiendas donde tengo que buscar

                    var path = aOptions.urlStockSotre.replace("_campaign_",partNumberData[1]).replace("_part-number_",partNumberData[0]);
                    if (self.iIsMockup) {
                        path += ".json";
                    }


                    //Concateno las tiendas antes encontrada en la otra llamada
                    /*for (var i=0; i < self.infoStoreJSON.closerStores.length; i++) {
                     if (i == 0) {
                     path += "?";
                     } else {
                     path += "&";
                     }
                     path += "physicalStoreId=" + self.infoStoreJSON.closerStores[i].id;
                     }*/

                    path +="?physicalStoreId=2592&physicalStoreId=7596&physicalStoreId=2590&physicalStoreId=2667&physicalStoreId=7575&physicalStoreId=2788&physicalStoreId=2820&physicalStoreId=2716"

                    //2 Busco el stock con la llamada al servicio web como si fuese rest. 
                    self.request({
                        "url": path,
                        "method": "post",
                        "onSuccess": function(aJson) {
                            finishedRequest[index]= true;
                            aStock = $.parseJSON(aJson);
                            for(var j=0;j<aStock.stocks.length;j++){
                                var hasThisStock = false;
                                for(var k=0;k<finalStoreStock.stocks.length;k++){
                                    if(aStock.stocks[j].physicalStoreId == finalStoreStock.stocks[k].physicalStoreId){
                                        hasThisStock=true;

                                        for(var m=0;m<aStock.stocks[j].sizeStocks.length;m++){
                                            var hasThisSizeStock = false;
                                            for(var n=0;n<finalStoreStock.stocks[k].sizeStocks.length;n++){
                                                if(aStock.stocks[j].sizeStocks[m].sizeId == finalStoreStock.stocks[k].sizeStocks[n].sizeId){
                                                    hasThisSizeStock = true;
                                                    finalStoreStock.stocks[k].sizeStocks[n].quantity += aStock.stocks[j].sizeStocks[m].quantity;
                                                }
                                            }
                                            if(!hasThisSizeStock){
                                                finalStoreStock.stocks[k].sizeStocks.push(aStock.stocks[j].sizeStocks[m]);
                                            }
                                        }
                                    }
                                }
                                if(!hasThisStock){
                                    finalStoreStock.stocks.push(aStock.stocks[j]);
                                }
                            }


                            if (finishedRequest.indexOf(false)<0 && aOptions.onSuccess) {
                                var stJSON_INFO_STORE = JSON.stringify(self.infoStoreJSON);
                                var stFinal_Store_Stock = JSON.stringify(finalStoreStock);
                                var stJSON_FINAL= '{"infoPhysicalStore" : ' + stJSON_INFO_STORE + ', "storeStock" :' + stFinal_Store_Stock + '}';
                                var JSONFinal = self.evalJSON(stJSON_FINAL);
                                aOptions.onSuccess(JSONFinal);
                            }
                        },
                        "onFailure": function() {
                            if (aOptions.onFailure) {
                                aOptions.onFailure();
                            }
                        }
                    });


                });
            }
        });
    };

    (function() {
        var count = 0;

        InditexClass.prototype.submitPayment = function(options) {
            var self = this;
            count = 0;

            if (typeof options.onStart === 'function') {
                options.onStart();
            }

            Inditex.request({
                url: Inditex.generateUrl("ItxStandardOrderConfirmationCmd", null, true),
                data: options.data,
                onSuccess: function(text) {
                    process(options, Inditex.evalJSON(text));
                },
                onFailure: function() {
                    if (typeof options.onError === 'function') {
                        options.onError();
                    }
                }
            });
        };

        function process(options, json) {
            if (json.data === null || json.data.orderStatus === undefined) {
                if (json.errorKey) {
                    if (typeof options.onError === 'function') {
                        options.onError(json.errorMessage, json.errorKey);
                    }
                } else {
                    if (typeof options.onError === 'function') {
                        options.onError();
                    }
                }
            } else if (json.data.orderStatus === "PQ"
                && json.data.redirectTo != null
                && json.data.noPolling == true) {
                redirect(options, json);
            } else if (json.data.orderStatus === "P") {
                if (json.errorKey) {
                    if (typeof options.onError === 'function') {
                        options.onError(json.errorMessage, json.errorKey);
                    }
                } else if (json.data.redirectTo) {
                    redirect(options, json);
                } else {
                    if (typeof options.onError === 'function') {
                        options.onError();
                    }
                }
            } else if (json.data.orderStatus === "PQ") {
                if (count < Inditex.iAsyncPaymentPollingTries) {
                    check(options, json);
                } else {
                    redirect(options, json);
                }
            } else {
                redirect(options, json);
            }
        };

        function check(options, json) {
            count++;

            var data = "storeId=" + encodeURIComponent(Inditex.iStoreId)
                + "&langId=" + encodeURIComponent(Inditex.iLangId)
                + "&catalogId=" + encodeURIComponent(Inditex.iCatalogId)
                + "&orderId=" + encodeURIComponent(json.data.orderId);

            setTimeout(function() {
                Inditex.request({
                    url: Inditex.generateUrl("ItxStandardOrderStatusCmd", null, true),
                    data: data,
                    onSuccess: function(text) {
                        process(options, Inditex.evalJSON(text));
                    }
                });
            }, Inditex.iAsyncPaymentPollingInterval);
        };

        function redirect(options, json) {

            if (json.data.redirectData) {
                if (typeof options.onConfirm === 'function') {
                    options.onConfirm(json.data.redirectTo, json.data.redirectData);
                } else {
                    var form = document.createElement("form");
                    form.setAttribute("action", json.data.redirectTo);
                    form.setAttribute("method", "post");
                    for (var i in json.data.redirectData) {
                        var input = document.createElement("input");
                        input.setAttribute("type", "hidden");
                        input.setAttribute("name", i);
                        input.setAttribute("value", json.data.redirectData[i]);
                        form.appendChild(input);
                    }
                    document.body.appendChild(form);
                    form.submit();
                }
            } else {

                if (Inditex.iBrandId=="3" && Inditex.iEnableUniversalAnalytics && Inditex.isMobilePath()) {

                    var paymentSelected="";
                    if(Inditex.iXShopCart){
                        paymentSelected = $('#kind').val().toLowerCase();
                    }else{
                        if($('#wallet_payment').is(':checked')){
                            paymentSelected=$('#kindSelected').val().toLowerCase();
                        }else{
                            paymentSelected=$('.card_type option:selected').attr("value").toLowerCase();
                        }
                    }
                    if(ItxMobileOrderPaymentPageClass.isWalletUser || Inditex.iXShopCart){
                        Inditex.trackEvent( 'Cesta_de_Compra_Rapida','Autorizar_Pago_'+ paymentSelected+'_validacion_ok',null,{
                            hitCallback: function(){
                                window.location = json.data.redirectTo;
                            }
                        });
                    }else{
                        Inditex.trackEvent( 'Cesta_de_Compra','Autorizar_Pago_'+ paymentSelected+'_validacion_ok',null,{
                            hitCallback: function(){
                                window.location = json.data.redirectTo;
                            }
                        });
                    }

                }else{
                    window.location = json.data.redirectTo;
                }

            }
        };
    })();

    InditexClass.prototype.generateLangUrl = function(langId) {
        var self, t, url;

        self = this;
        t = self.parseUrl(location.href);

        if (t) {
            t.params.langId = langId;
            url = self.generateUrl(
                t.action,
                t.params,
                location.protocol == "https:",
                self.isMobilePath());
            url += location.hash;
        } else {
            url = self.generateUrl(
                "HomePage", {
                    "storeId": self.iStoreId,
                    "langId": langId,
                    "catalogId": self.iCatalogId
                },
                false,
                self.isMobilePath());
        }

        return url;
    };

    //Escapar a html todo el contenido del elemento (de forma recursiva)
    InditexClass.prototype.htmlEncodeObject = function (obj) {
        var ret = obj;
        if (typeof obj == "string") {
            ret = document.createElement('a').appendChild(document.createTextNode(obj)).parentNode.innerHTML;
        } else if (typeof obj == "object" && obj != null) {
            if( Object.prototype.toString.call(obj) === '[object Array]' ) {
                ret = [];
            } else {
                ret = {};
            }
            for(var key in obj) {
                if (typeof obj[key] == "object") {
                    ret[key]=InditexClass.prototype.htmlEncodeObject(obj[key]);
                } else {
                    ret[key]=document.createElement('a').appendChild(document.createTextNode(obj[key])).parentNode.innerHTML;
                }
            }
        }
        return ret;
    }

    InditexClass.prototype.clickItxOrderManageCmd = function (element) {
        var self = this;
        if (window.MooTools) {
            var href = element.getAttribute("href");
            element.addEvent('click', function(){
                self.orderManage({"url":href});
                return false;
            });
            element.href="javascript:void(0)";
        } else {
            var href = $(element).attr("href");
            $(element).click(function() {
                self.orderManage({"url":href});
                return false;
            });
            $(element).attr("href","javascript:void(0)");
        }
    }

    InditexClass.prototype._orderManageSuccess = function(options, evalJson) {
        var self = this;
        if (options.form) {
            var element = document.createElement("input");
            element.setAttribute("type", "hidden");
            element.setAttribute("name", "authToken");
            element.setAttribute("value", evalJson.authToken);
            if (options.form.jquery) {
                options.form.append(element);
                options.form.submit();
            } else {
                options.form.appendChild(element);
                options.form.submit();
            }
        } else {
            var params = {}, sparam = "", url, tokens, re = /[?&]([^=]+)=([^&]*)/g;
            var	ini = options.url.indexOf('?');
            if (ini>=0) {
                url = options.url.substring(0,ini);
                sparam = options.url.substring(ini);
                var fin = sparam.indexOf('#');
                if (fin>=0) {
                    url += sparam.substring(fin);
                    sparam = sparam.substring(0,fin);
                }
            } else {
                url = options.url;
            }
            sparam += "&authToken="+encodeURIComponent(evalJson.authToken);
            options.url = url;

            if (options.onSuccess || options.success) {
                if (options.customRequest) {
                    if (options.data===undefined || !options.data) {
                        options.data = sparam.substring(1);
                    } else {
                        if (typeof options.data == "string") {
                            options.data += "&"+sparam.substring(1);
                        } else {
                            while (tokens = re.exec(sparam)) {
                                var input = document.createElement("input");
                                input.type = "hidden";
                                input.name = decodeURIComponent(tokens[1]);
                                input.value = decodeURIComponent(tokens[2]);
                                options.data.appendChild(input);
                            }
                        }
                    }
                    options.data.method = 'post';
                    options.data.type = 'post';
                    options.customRequest(options);
                } else {
                    if (options.data===undefined || !options.data) {
                        options.data = sparam.substring(1);
                    } else {
                        options.data += "&"+sparam.substring(1);
                    }
                    self.request(options);
                }
            } else {
                var form = document.createElement("form");
                form.method = 'post';
                form.action = url;
                sparam = sparam.split("+").join(" ");
                while (tokens = re.exec(sparam)) {
                    var input = document.createElement("input");
                    input.type = "hidden";
                    input.name = decodeURIComponent(tokens[1]);
                    input.value = decodeURIComponent(tokens[2]);
                    form.appendChild(input);
                }
                document.body.appendChild(form);
                form.submit();
                //window.location = newUrl; 
            }
        }
    }

    InditexClass.prototype.orderManage = function (options){
        var self = Inditex;
        var urlAuthToken = self.generateUrl("ItxStandardAuthTokenJSON",{
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "catalogId": self.iCatalogId
        },true);
        self.request({
            "url": urlAuthToken,
            "contentType": "application/json",
            "onSuccess": function(textJson) {
                var evalJson = Inditex.evalJSON(textJson);
                if (!evalJson.authToken) {
                    self.writeCookie("WC_USERACTIVITY_-1002","",-1);
                    var urlUser = self.generateUrl("ItxStandardUserJSON", {
                        "storeId" : self.iStoreId,
                        "langId" : self.iLangId,
                        "catalogId" : self.iCatalogId
                    }, true);
                    self.request( {
                        "url" : urlUser,
                        "onSuccess" : function(text) {
                            self.request( {
                                "url" : urlAuthToken,
                                "contentType" : "application/json",
                                "onSuccess" : function(textJson) {
                                    var evalJson = Inditex.evalJSON(textJson);
                                    self._orderManageSuccess(options, evalJson);
                                },
                                "onFailure" : function(aStatus) {
                                    if (options.onFailure) {
                                        options.onFailure(aStatus);
                                    } else {
                                        self.xOpenErrorPopUp();
                                    }
                                }
                            });
                        }
                    });
                } else {
                    self._orderManageSuccess(options, evalJson);
                }


            },
            "onFailure": function(aStatus) {
                if (options.onFailure) {
                    options.onFailure(aStatus);
                } else {
                    self.xOpenErrorPopUp();
                }
            }
        });
    }
    InditexClass.prototype.restOrderModifyShipmodeId = function(aOptions) {

        var self;

        var url;

        var viewname = errorViewName = 'ItxStandardJSON';

        self = this;

        if (aOptions.viewname != undefined) {
            viewname = aOptions.viewname;
        }

        if (aOptions.errorViewName != undefined) {
            errorViewName = aOptions.errorViewName;
        }

        var url = Inditex.generateUrl(
            'ItxOrderManageCmd',
            {
                "storeId" : Inditex.iStoreId,
                "langId" : Inditex.iLangId,
                "catalogId" : Inditex.iCatalogId,
                'action' : 'modifyShippingMethod',
                'iShippingMethodId' : aOptions.iShippingMethodId,
                'viewname' : viewname,
                'errorViewName' : errorViewName
            },
            true
        );

        self.orderManage({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.thereCookieInternalError = function() {
        var self = this;
        var cookie = self.readCookie('WC_ITX_OLDCONTENT');
        //si existe cookie

        if (cookie) {
            if (window.MooTools) {

                var elementHidden =  document.querySelectorAll('*[element-error="0"]');
                Array.each(elementHidden, function(elemn, index) {
                    elemn.setStyle('display', 'none');
                });

                var elementDelete =document.querySelectorAll('*[element-error="1"]');
                Array.each(elementDelete,function(elemn, index) {
                    elemn.destroy();
                });

                var elementVisibility = document.querySelectorAll('*[element-error="2"]');
                Array.each(elementVisibility,function(elemn, index) {
                    elemn.setStyle('visibility', 'hidden');
                });

            } else if (window.jQuery) {

                var elementHidden = $('[element-error=0]');
                elementHidden.each(function(index, elemn) {
                    $(elemn).css('display', 'none');
                });

                var elementDelete = $('[element-error=1]');
                elementDelete.each(function(index, elemn) {
                    $(elemn).remove();
                });

                var elementVisibility = $('[element-error=2]');
                elementVisibility.each(function(index, elemn) {
                    $(elemn).css('visibility', 'hidden');
                });
            }
        }
    };

    InditexClass.prototype.writeItxSourceCookie = function() {
        var self = this;
        var params=self.getCurrentURLParams();
        if(params["itxSource"]&&params["itxSource"]!=""){
            self.writeCookie("WC_ItxSource",params["itxSource"]);
        }
    };

    InditexClass.prototype.getCookieStore = function() {

        var self = this;
        var h = location.host.toLowerCase();
        var n, v, t;
        var brandId = Math.floor(self.iStoreId / 10000000);

        switch (brandId) {
            case 2:
                n = "WC_PullStore";
                break;
            case 3:
                n = "WC_DuttiStore";
                break;
            case 4:
                n = "WC_BershkaStore";
                break;
            case 5:
                n = "WC_StradivariusStore";
                break;
            case 6:
                n = "WC_OyshoStore";
                break;
            case 7:
                n = "WC_UterqueStore";
                break;
            case 8:
                n = "WC_ZaraHomeStore";
                break;
            default:
                n = null;
                break;
        }

        if (n == null) {
            v = null;
        } else {
            v = self.readCookie(n);
        }

        if (/^[0-9]+,\-?[0-9]+,[0-9]+$/.test(v)) {
            v = v.split(",");
            return {
                storeId: parseInt(v[0]),
                langId: parseInt(v[1]),
                catalogId: parseInt(v[2])
            }
        }

        return null;

    };

    InditexClass.prototype.isMobileDevice = function() {

        if (/.*\(BB[0-9]+;.*Mobile.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*BlackBerry.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*Android.*Mobile.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*MSIEMobile.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*SymbianOS.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*Windows Phone.*/.test(navigator.userAgent)) {
            return true;
        }

        if (/.*iPhone.*/.test(navigator.userAgent)) {
            return true;
        }

        return false;

    };

    //*********************************************************
    //Inicio mtodos a implementar para cada cadena
    //*********************************************************
    InditexClass.prototype.drawHeader = function() {
        throw "drawHeader: Not implemented!";
    };

    InditexClass.prototype.popupHtml = function(aHtml, aWidth, aHeight, aCallback) {
        throw "popupHtml: Not implemented!";
    };

    InditexClass.prototype.popupVideo = function(aVideos, aWidth, aHeight, aCallback) {
        throw "popupVideo: Not implemented!";
    };

    //*********************************************************
    //Fin mtodos a implementar para cada cadena
    //*********************************************************

    if (window.MooTools) {

        window.addEvent("domready", function() {
            Inditex.onReady();
        });

        window.addEvent("resize", function() {
            Inditex.onResize();
        });
    } else if (window.jQuery) {

        jQuery(document).ready(function() {
            Inditex.onReady();
        });

        jQuery(window).resize(function() {
            Inditex.onResize();
        });
    };



    InditexClass.prototype.isUnsupportedBrowser = function() {
        var self = this;
        if (self.iUnsupportedUaPattern) {
            try {
                var re = new RegExp(self.iUnsupportedUaPattern);
                if (re.test(navigator.userAgent)) {
                    return true;
                }
            } catch (err) {
            }
        }
        return false;
    };


    Inditex.iReadyArray.push(function() {

        if (Inditex.isUnsupportedBrowser()) {
            location.href = Inditex.generateUrl("ItxStandardMarketingSpotPage", {
                storeId: Inditex.iStoreId,
                catalogId: Inditex.iCatalogId,
                langId: Inditex.iLangId,
                name: Inditex.iSpotPrefix + "BrowserSupport"
            }, false);
        }
    });


    InditexClass.prototype.relatedProductsByColor = function(jSon, idColor) {
        var relatedProductsJson = [];
        if (jSon != null && jSon.detail != null && jSon.detail.relatedProducts != null) {
            jQuery.each(jSon.detail.relatedProducts, function(key, relatedProduct) {
                var addAsociateProducts = false;
                jQuery.each(relatedProduct.colors, function(key, color) {
                    if(idColor == color.id){
                        addAsociateProducts = true;
                    }
                });
                if (addAsociateProducts) {
                    delete relatedProduct['colors'];
                    relatedProductsJson.push(relatedProduct);
                }
            });
            jSon.detail.relatedProducts = relatedProductsJson;
        }
        return jSon;
    }

    InditexClass.prototype.getParentCategory = function(categoryId) {
        var aCategory = Inditex.iCategoryTreeJSON;
        var categoriaPadre = 0;
        $.each(aCategory.categories, function(indCate, categories) {
            $.each(categories.subcategories, function(indSubCate, subcategories) {
                if(subcategories.id==Inditex.iCategoryId){
                    categoriaPadre = categories;
                }
                $.each(subcategories.subcategories, function(indSubCate2, subcategories2) {
                    if(subcategories2.id==Inditex.iCategoryId){
                        categoriaPadre = subcategories;
                    }
                });
            });
        });
        return categoriaPadre;
    };


    if (!String.prototype.trim) String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g, '');};




    InditexClass.prototype.getExternalResourceByName = function(aOptions) {
        var self = this;
        var path = "/externalResource/name/" + aOptions.resourceName;
        path += "?languageId=" + self.iLangId;
        if (self.iIsMockup) {
            path += ".json";
        }
        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.sendContacStoreOnline = function(aOptions) {
        var self = this;
        var path = "/user/store/" + self.iStoreId + "/contact";
        if (self.iIsMockup) {
            path += ".json";
        }else{
            path += "?languageId=" + self.iLangId;;
        }
        self.getRestJSON(location.protocol, 1, path, JSON.stringify(aOptions.data),aOptions.onSuccess, aOptions.onFailure);
    };

    InditexClass.prototype.restSubscribeNewsletterRequest = function (aOptions) {

        var self = this;
        var viewname = errorViewName  = 'ItxStandardJSON';

        var url = Inditex.generateUrl(
            'ItxStandardNewslettersRequestSubscriptionCmd',
            {
                "storeId"				: Inditex.iStoreId,
                "catalogId"				: Inditex.iCatalogId,
                "langId"				: Inditex.iLangId,
                "firstName"				: aOptions.firstName,
                "lastName"				: aOptions.lastName,
                "countryCode"			: aOptions.countryCode,
                "city"					: aOptions.city,
                "stateCode"				: aOptions.stateCode,
                "addressLine_0"			: aOptions.addressLine_0,
                "email"					: aOptions.email,
                "emailConfirm"			: aOptions.emailConfirm,
                "zipCode"				: aOptions.zipCode,
                "phone"					: aOptions.phone,
                "privacyPolicyAccepted"	: aOptions.privacyPolicyAccepted,
                "birthDate"				: aOptions.birthDate,
                "gender"				: aOptions.gender,
                "newsletter"			: aOptions.newsletter,
                "fromBlockPage"			: aOptions.fromBlockPage,
                "origin"				: aOptions.origin,
                "viewname"				: viewname,
                "errorViewName"			: errorViewName
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };

    InditexClass.prototype.restUnsubscribeNewsletterRequest = function (aOptions) {

        var self = this;
        var viewname = errorViewName  = 'ItxStandardJSON';

        var url = Inditex.generateUrl(
            'ItxStandardNewslettersRequestDeleteCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "languageId"		: Inditex.iLangId,
                "catalogId"			: Inditex.iCatalogId,
                "email"				: aOptions.email,
                "viewname"			: viewname,
                "errorViewName"		: errorViewName
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };


    InditexClass.prototype.restRequestInvoice = function (aOptions) {

        var self = this;
        var viewname = errorViewName  = 'ItxStandardJSON';

        var url = Inditex.generateUrl(
            'ItxRequestInvoiceCmd',
            {
                "storeId"			: Inditex.iStoreId,
                "langId"			: Inditex.iLangId,
                "orderId"			: aOptions.orderId,
                "viewname"			: viewname,
                "errorViewName"		: errorViewName
            },
            true
        );

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });
    };

    InditexClass.prototype.getProxyProductVisibilityMap = function(){
        var self = this;
        visibilityMap = {};
        if (Inditex.iXProductListJSON && Inditex.iXProductListJSON.products){
            $.each(Inditex.iXProductListJSON.products,function(i,catentry){
                if (catentry.type == "ProductBean"){
                    self.getProductVisibility(catentry, visibilityMap);
                }
                if (catentry.type == "BundleBean"){
                    visibilityMap[catentry.id] = catentry.visibility;
                    if (catentry.bundleProductSummaries){
                        $.each(catentry.bundleProductSummaries,function(j,product){
                            self.getProductVisibility(product,  visibilityMap);
                        });
                    }
                }
            });
        }
        return visibilityMap;
    };

    InditexClass.prototype.getProductVisibility = function(product, visibilityMap){
        if (product && product.detail && product.detail.colors){
            visibilityMap[product.id] = product.visibility;
            $.each(product.detail.colors,function(i,color){
                if (color && color.sizes){
                    $.each(color.sizes,function(j,size){
                        if (size){
                            visibilityMap[size.sku] = size.visibility;
                        }
                    });
                }
            });
        }
    };


    InditexClass.prototype.getRelatedProductsJSON= function(products, visibilityMap, colorSelected) {
        var self= this;

        var lsRelatedProducts = new Array();
        for (var i=0; i< products.detail.relatedProducts.length; i++) {
            if(visibilityMap[products.detail.relatedProducts[i].id]=="show"){
                var relatedProducts	= products.detail.relatedProducts[i];
                var defaultColor = null;


                var colorsRelatedProducts = relatedProducts.colors;
                //colorsRelatedProducts no es vacio busco si el color selecionado (colorSelected.id);
                if (colorsRelatedProducts.length > 0) {
                    for (var pos=0; pos< colorsRelatedProducts.length; pos++) {
                        if (colorsRelatedProducts[pos].id == colorSelected) {
                            defaultColor = colorsRelatedProducts[pos].defaultColor;
                        }
                    }
                }

                if (defaultColor != null || relatedProducts.type == "BundleBean") {

                    if (relatedProducts.type == "BundleBean"){
                        var urlRelatedProduct = Inditex.generateUrl("ProductPage", {
                            "storeId": Inditex.iStoreId,
                            "langId": Inditex.iLangId,
                            "catalogId": Inditex.iCatalogId,
                            "categoryId": 0,
                            "productId": relatedProducts.id,
                            "keyWord": relatedProducts.name
                        });
                    } else {
                        var urlRelatedProduct = Inditex.generateUrl("ProductPage", {
                            "storeId": Inditex.iStoreId,
                            "langId": Inditex.iLangId,
                            "catalogId": Inditex.iCatalogId,
                            "categoryId": 0,
                            "initColor": defaultColor,
                            "productId": relatedProducts.id,
                            "keyWord": relatedProducts.name
                        });
                    }


                    var image = null;


                    if (defaultColor) {
                        if (relatedProducts.detail && relatedProducts.detail.colors && relatedProducts.detail.colors.length > 0) {
                            for (var posColorImg=0; posColorImg < relatedProducts.detail.colors.length; posColorImg++) {
                                if (relatedProducts.detail.colors[posColorImg].id == defaultColor) {
                                    image = relatedProducts.detail.colors[posColorImg].image;
                                }
                            }
                        }
                    }


                    var urls = [];

                    if (image==null) image="";

                    if (image) {
                        urls = Inditex.getProductImageUrls(image, 1, 4);
                    }

                    image = urls[0];


                    lsRelatedProducts.push({
                        "id"	 	: relatedProducts.id,
                        "name"	 	: relatedProducts.name,
                        "url"	 	: urlRelatedProduct,
                        "urlImage4" : urls[0],
                        "image"  	: image
                    });
                }
            }
        }

        return lsRelatedProducts;

    };

    (function() {
        var iframe = null;
        var iframeReady = false;
        var queue = [];
        var requests = {};
        var id = 0;
        var origin = "https://" + location.host;

        function init() {
            if (!iframe) {
                iframe = document.createElement("iframe");
                iframe.style.cssText = "position:absolute;width:1px;height:0px;left:-9999px;display:none";
                document.body.appendChild(iframe);

                if (window.addEventListener){
                    iframe.addEventListener("load", function() {
                        loaded();
                    }, false);

                    window.addEventListener("message", function(event) {
                        message(event);
                    }, false);

                } else if (iframe.attachEvent){
                    iframe.attachEvent("onload", function() {
                        loaded();
                    }, false);

                    window.attachEvent("onmessage", function(event) {
                        message(event);
                    });
                }
            }

            if (!Inditex.iIsMockup){
                iframe.src = origin + "/wcsstore/Common/views/itx-helper.html?t=" + Inditex.iBuildVersion;
            } else {
                iframe.src = Inditex.iStoreJSON.details.staticContentPath + "itx-helper.html";
                origin = "http://" + location.host;
            }
        }

        function loaded() {
            iframeReady = true;
            if (queue.length) {
                for (var i = 0, len = queue.length; i < len; i++) {
                    try {
                        send(queue[i]);
                    } catch (err) {
                    }
                }
                queue = [];
            }
        }

        function message(event) {
            try{
                if ((event.origin == origin) && iframe && (event.source == iframe.contentWindow)) {
                    var data = JSON.parse ? JSON.parse(event.data) : JSON.decode(event.data);
                    requests[data.id].callback(data.key, data.value);
                    delete requests[data.id];
                }
            }catch(e){}
        }

        function send(data) {
            if (iframeReady) {
                requests[data.request.id] = data;
                var s = JSON.stringify ? JSON.stringify(data.request) : JSON.encode(data.request);
                iframe.contentWindow.postMessage(s, origin);
            } else {
                queue.push(data);
            }

            if (!iframe){
                init();
            }
        }

        InditexClass.prototype.getSessionAttribute = function(key, callback) {
            send({
                request: {
                    id: ++id,
                    option: 1,
                    key: key
                },
                callback: callback
            });
        };

        InditexClass.prototype.setSessionAttribute = function(key, value, callback) {
            send({
                request: {
                    id: ++id,
                    option: 2,
                    key: key,
                    value: value
                },
                callback: callback
            });
        };

        InditexClass.prototype.getLocalAttribute = function(key, callback) {
            send({
                request: {
                    id: ++id,
                    option: 3,
                    key: key
                },
                callback: callback
            });
        };

        InditexClass.prototype.setLocalAttribute = function(key, value, callback) {
            send({
                request: {
                    id: ++id,
                    option: 4,
                    key: key,
                    value: value
                },
                callback: callback
            });
        };

    })();

    InditexClass.prototype.getRestBamItxDropPointStates = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/itx-drop-point/state";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamItxDropPointMunicipalities = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/itx-drop-point/municipality";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.state == undefined
            ? "" : "&state=" + aOptions.state;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamItxDropPointColonies = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/itx-drop-point/colony";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.state == undefined
            ? "" : "&state=" + aOptions.state;
        path += aOptions.municipality == undefined
            ? "" : "&municipality=" + aOptions.municipality;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamItxDropPoints = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/itx-drop-point";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.state == undefined
            ? "" : "&state=" + aOptions.state;
        path += aOptions.municipality == undefined
            ? "" : "&municipality=" + aOptions.municipality;
        path += aOptions.colony == undefined
            ? "" : "&colony=" + aOptions.colony;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestBamItxDropPointsByPostalCode = function(aOptions) {
        var self = this;

        var path = "/bam/store/" + self.iStoreId + "/itx-drop-point";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;
        path += aOptions.countryCode == undefined
            ? "" : "&countryCode=" + aOptions.countryCode;
        path += aOptions.postalCode == undefined
            ? "" : "&postalCode=" + aOptions.postalCode;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };


    InditexClass.prototype.bindMobilePayment = function(aOptions)  {

        var self=this;
        jQuery("#data-itx-bind-mobile-payment-qr-submit").click(function(event){
            aOptions.showWaitView();
            var valorQR = jQuery('#data-itx-bind-mobile-payment-qr-input').val();
            self.getPaymentWalletQr(aOptions,valorQR, 0);
        });

    };

    InditexClass.prototype.getPaymentWalletQr = function(aOptions, valorQR, intentosQR) {

        var self=this;

        aOptions.orderId == undefined ? aOptions.orderId = self.iXShopCart.id : aOptions.orderId;

        var params={
            "orderId": aOptions.orderId,
            "qrCode": valorQR,
            "storeId": self.iStoreId,
            "langId": self.iLangId

        };

        url = self.generateUrl("ItxStandardWalletGetQRPaymentTokenJSON", params, true);

        self.request({
            "url": url,
            "onSuccess": function(aJson){
                var response=self.evalJSON(aJson);
                if(response.paymentToken!=null){
                    self.getWalletQrCards(aOptions,response,0);
                }else{
                    aOptions.showErrorQRView();
                }
            },
            "onFailure": function() {
                if (intentosQR < self.iAsyncPaymentPollingTries) {
                    intentosQR++;
                    setTimeout(function(){self.getPaymentWalletQr(aOptions, valorQR, intentosQR )}, self.iAsyncPaymentPollingInterval);
                } else {
                    aOptions.showErrorView();
                }
            }
        });

    };

    InditexClass.prototype.getWalletQrCards = function(aOptions, aJson, intentos) {

        var self=this;

        var params={
            "orderId": aOptions.orderId,
            "paymentToken": aJson.paymentToken,
            "storeId": self.iStoreId,
            "langId": self.iLangId

        };

        url = self.generateUrl("ItxStandardWalletGetQRCardsJSON", params, true);

        self.request({
            "url": url,
            "onSuccess": function(bJson){
                var json= self.evalJSON(bJson);
                if(json.walletQRCards&&json.walletQRCards.length>0){
                    aOptions.showCardView(self.evalJSON(bJson));
                }else{
                    if (intentos < self.iAsyncPaymentPollingTries) {
                        intentos++;
                        setTimeout(function(){self.getWalletQrCards(aOptions, aJson, intentos )}, self.iAsyncPaymentPollingInterval);
                    } else {
                        aOptions.showErrorView();
                    }
                }
            },
            "onFailure": function() {
                if (intentos < self.iAsyncPaymentPollingTries) {
                    intentos++;
                    setTimeout(function(){self.getWalletQrCards(aOptions, aJson, intentos )}, self.iAsyncPaymentPollingInterval);
                } else {
                    aOptions.showErrorView();
                }
            }
        });

    };

    InditexClass.prototype.getUrlPolicy = function(aOptions) {

        var self=this;
        var path = "";

        if (window.location.protocol == 'https:') {
            path +=  self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            path +=  self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        versionLOPD = self.getPolicyVersion(aOptions.idPolicyType);

        path +=  self.iStoreJSON.details.urlPolicies + aOptions.idPolicyType + "/" + self.iLangId + "/" + versionLOPD.versionName + ".pdf";

        return path;
    };

    InditexClass.prototype.getPolicyVersion = function(idPolicyType) {

        var self = this;
        var version = '';

        jQuery.each(self.iStoreJSON.details.policyVersionList, function(key, policyElement) {
            if (policyElement.idPolicyType == idPolicyType){
                jQuery.each(policyElement.policyLangList, function(key, langElement) {
                    if (langElement.langId == self.iLangId){
                        version = langElement.versionList[0];
                    }
                });
            }
        });

        return version;
    };

    InditexClass.prototype.getPolicyVersionsAcceptedCurrentUser = function(aOptions){
        var self = this;
        Inditex.getUserJSON(function(user){
            if( user && user.identity && user.identity.userId){
                if(aOptions.policyTypesId){
                    self.getPolicyVersionsAcceptedByUserId({
                        "userId": user.identity.userId,
                        "policyTypesId": aOptions.policyTypesId,
                        "onSuccess": aOptions.onSuccess,
                        "onFailure": aOptions.onFailure
                    });
                }else{
                    self.getPolicyVersionsAcceptedByUserId({
                        "userId": user.identity.userId,
                        "onSuccess": aOptions.onSuccess,
                        "onFailure": aOptions.onFailure
                    });
                }
            }else{
                if(aOptions.onFailure){
                    aOptions.onFailure(user);
                }
            }
        });

    };

    InditexClass.prototype.getPolicyVersionsAcceptedByUserId = function(aOptions){
        var self = this;

        if(aOptions.policyTypesId && aOptions.policyTypesId != null && aOptions.policyTypesId != ''){
            var url = self.generateUrl("ItxStandardPolicyUserLOPDJSON", {
                "storeId": self.iStoreId,
                "languageId": self.iLangId,
                "userId": aOptions.userId,
                "policyTypesId": aOptions.policyTypesId
            }, true);

        }else{
            var url = self.generateUrl("ItxStandardPolicyUserLOPDJSON", {
                "storeId": self.iStoreId,
                "languageId": self.iLangId,
                "userId": aOptions.userId
            }, true);
        }

        self.request({
            "url": url,
            "method": "get",
            "onSuccess": function(text) {
                //Si va todo bien cacheo los datos.
                if (text != null && text != undefined) {
                    var uJson = self.evalJSON(text);
                    aOptions.onSuccess(uJson);
                }
            },
            "onFailure":function(text){
                if (text != null && text != undefined) {
                    var uJson = self.evalJSON(text);
                    if(aOptions.onFailure){
                        aOptions.onFailure(uJson);
                    }
                }
            }
        });


    };


    InditexClass.prototype.getStorePolicyVersionsOfType = function (idPolicyType){
        var self = this;
        var policyVersionList = null;

        jQuery.each(Inditex.iStoreJSON.details.policyVersionList, function(idx, obj) {
            /*Si se encuentra el tipo de politica que se desea recuperar, comprobar el idioma */
            if(obj.idPolicyType == idPolicyType){
                /*Recorro los diferentes idiomas para el tipo buscado*/
                jQuery.each(obj.policyLangList, function(idx, policyVersions) {
                    /*Si el tipo de politica tiene versiones para el idioma de navegacion*/
                    if(policyVersions.langId == Inditex.iLangId){
                        /*Recorro las diferentes versiones*/
                        policyVersionList = policyVersions.versionList;
                        return false;
                    }

                });
            }
        });
        return policyVersionList;
    };


    InditexClass.prototype.getLastVersionPolicyAcceptedByUser = function (typePolicyList,idPolicyType){
        var self = this;
        var recentAcceptedVersion;

        jQuery.each(typePolicyList, function(idx, type) {
            if(type.idPolicyType == idPolicyType){
                jQuery.each(type.policyLangList, function(idx, lang) {
                    if(lang.langId == Inditex.iLangId){
                        recentAcceptedVersion = lang.versionList[0] ;
                        return false;
                    }
                });
            }
        });

        return recentAcceptedVersion;

    };

    InditexClass.prototype.validateAcceptanceRequiredPolicyCurrentUser = function(aOptions){

        var self = this;

        Inditex.getUserJSON(function(user){
            if( user && user && user.identity.userId && user.userType && user.identity.userId== -1002 && user.userType == 'G' ){
                var policiesToAcceptance = [];
                var versionLis
                jQuery.each(aOptions.policyTypesId, function(idx, idPolicyType) {
                    versionList = self.getStorePolicyVersionsOfType(idPolicyType);
                    if(versionList == null || versionList.length <= 0){
                        //no se ha encontrado ninguna politica de ese tipo para la tienda
                        return;
                    }
                    policiesToAcceptance.push(versionList[0]);
                });
                aOptions.onSuccess(policiesToAcceptance);
            }else{
                self.getPolicyVersionsAcceptedCurrentUser({
                    "policyTypesId":aOptions.policyTypesId,
                    "onSuccess": function(acceptedPoliciesByUser){
                        self.validateAcceptanceRequiredPolicyCurrentUserLogic({
                            "acceptedPoliciesByUser":acceptedPoliciesByUser,
                            "policyTypesId":aOptions.policyTypesId,
                            "onSuccess":function(requireAcceptancePolicies){
                                aOptions.onSuccess(requireAcceptancePolicies);
                            },
                            "onFailure":function(e){
                                aOptions.onFailure(e);
                            }
                        });
                    },
                    "onFailure":function(e){
                        aOptions.onFailure(e);
                    }
                });
            }
        });

    };


    InditexClass.prototype.validateAcceptanceRequiredPolicyCurrentUserLogic = function(aOptions){
        var self = this;
        var policiesToAcceptance = [];

        if (aOptions.policyTypesId == null){
            return;
        }
        var index;

        jQuery.each(aOptions.policyTypesId, function(idx, idPolicyType) {
            var recentAcceptedVersionId = null;

            if(aOptions.acceptedPoliciesByUser != null && aOptions.acceptedPoliciesByUser.userId != null)
            {

                recentAcceptedVersion = self.getLastVersionPolicyAcceptedByUser(aOptions.acceptedPoliciesByUser.typePolicyList,idPolicyType);
            }


            if(Inditex.iStoreJSON.details.policyVersionList == null){
                /*Error, no se han recuperado las politicas*/
                return;
            }

            var versionList = self.getStorePolicyVersionsOfType(idPolicyType);
            if(versionList == null){
                //no se ha encontrado ninguna politica de ese tipo para la tienda
                return;
            }
            jQuery.each(versionList, function(idx, policyVersion) {
                if(recentAcceptedVersion == null || recentAcceptedVersion.policyVersionId == null){
                    /*Si el usuario no ha aceptado ninguna politica, deber aceptar la ultima version*/
                    policiesToAcceptance.push(policyVersion);
                    return false;
                }
                if ( policyVersion.policyVersionId == recentAcceptedVersion.policyVersionId){
                    /*Si ya la ha aceptado*/
                    return false;
                }
                /*Si no la ha aceptado y requiere aceptacion*/
                if(policyVersion.requireAcceptance == 1){
                    policiesToAcceptance.push(policyVersion);
                    return false;
                }
            });

        });
        aOptions.onSuccess(policiesToAcceptance);
    }

    InditexClass.prototype.validateNotifyRequiredPolicyCurrentUser = function(aOptions){

        var self = this;


        this.getPolicyVersionsAcceptedCurrentUser({
            "policyTypesId":aOptions.policyTypesId,
            "onSuccess": function(acceptedPoliciesByUser){
                self.validateNotifyRequiredPolicyCurrentUserLogic({
                    "acceptedPoliciesByUser":acceptedPoliciesByUser,
                    "policyTypesId":aOptions.policyTypesId,
                    "onSuccess": function(policiesRequiredNotify){
                        aOptions.onSuccess(policiesRequiredNotify);
                    },
                    "onFailure":function (e){
                        aOptions.onFailure(e);
                    }
                });
            },
            "onFailure":function(e){
                aOptions.onFailure(e);
            }
        });

    };



    InditexClass.prototype.validateNotifyRequiredPolicyCurrentUserLogic  =	function(aOptions){
        var self = this;
        var policiesToAcceptance = [];

        if (aOptions.policyTypesId  == null){
            return;
        }
        var index;
        jQuery.each(aOptions.policyTypesId, function(idx, idPolicyType) {

            var recentAcceptedVersion = null;

            if(aOptions.acceptedPoliciesByUser != null && aOptions.acceptedPoliciesByUser.userId != null)
            {

                recentAcceptedVersion = self.getLastVersionPolicyAcceptedByUser(aOptions.acceptedPoliciesByUser.typePolicyList,idPolicyType);
            }


            if(Inditex.iStoreJSON.details.policyVersionList == null){
                /*Error, no se han recuperado las politicas*/
                return;
            }

            var aux;

            var versionList = self.getStorePolicyVersionsOfType(idPolicyType);
            if(versionList == null){
                //no se ha encontrado ninguna politica de ese tipo para la tienda
                return;
            }
            jQuery.each(versionList, function(idx, policyVersion) {
                if(recentAcceptedVersion == null || recentAcceptedVersion.policyVersionId == null){
                    /*Si el usuario no ha aceptado ninguna politica, deber aceptar la ultima version*/
                    return;
                }
                if ( policyVersion.policyVersionId == recentAcceptedVersion.policyVersionId){
                    /*Si ya ha sido notificado*/
                    return;
                }
                /*Si no la ha aceptado y requiere aceptacion*/
                if(policyVersion.requireAcceptance == 1){
                    aux=null;
                    return;
                }
                if(policyVersion.requireAcceptance == 2 && aux == null){
                    aux = policyVersion;
                }
            });
            if(aux!=null){policiesToAcceptance.push(aux);}

        });
        aOptions.onSuccess(policiesToAcceptance);
    }

    InditexClass.prototype.validateAcceptanceAndNotifyRequiredPolicyCurrentUser = function(aOptions){

        var self = this;
        var result = [];

        Inditex.getUserJSON(function(user){
            if( user && user && user.identity.userId && user.userType && user.identity.userId== -1002 && user.userType == 'G' ){
                var policiesToAcceptance = [];
                var versionList;
                jQuery.each(aOptions.policyTypesId, function(idx, idPolicyType) {
                    versionList = self.getStorePolicyVersionsOfType(idPolicyType);
                    if(versionList == null || versionList.length <= 0){
                        //no se ha encontrado ninguna politica de ese tipo para la tienda
                        return;
                    }
                    policiesToAcceptance.push(versionList[0]);
                });
                aOptions.onSuccess(policiesToAcceptance,result);
            }else{
                self.getPolicyVersionsAcceptedCurrentUser({
                    "policyTypesId": aOptions.policyTypesId,
                    "onSuccess": function(acceptedPoliciesByUser){
                        self.validateAcceptanceRequiredPolicyCurrentUserLogic({
                            "acceptedPoliciesByUser": acceptedPoliciesByUser,
                            "policyTypesId":aOptions.policyTypesId,
                            "onSuccess": function(policiesRequiredAcceptance){
                                if (policiesRequiredAcceptance!= null ){
                                    if( policiesRequiredAcceptance.length != aOptions.policyTypesId.length){
                                        self.validateNotifyRequiredPolicyCurrentUserLogic({
                                            "acceptedPoliciesByUser":acceptedPoliciesByUser,
                                            "policyTypesId":aOptions.policyTypesId,
                                            "onSuccess": function(policiesRequiredNotify){
                                                aOptions.onSuccess(policiesRequiredAcceptance,policiesRequiredNotify);
                                            },
                                            "onFailure":function (e){
                                                aOptions.onFailure(e);
                                            }
                                        });
                                    }else{
                                        aOptions.onSuccess(policiesRequiredAcceptance,result);
                                    }

                                } else{
                                    self.validateNotifyRequiredPolicyCurrentUserLogic({
                                        "acceptedPoliciesByUser":acceptedPoliciesByUser,
                                        "policyTypesId":aOptions.policyTypesId,
                                        "onSuccess": function(policiesRequiredNotify){
                                            aOptions.onSuccess(policiesRequiredAcceptance,policiesRequiredNotify);
                                        },
                                        "onFailure":function (e){
                                            aOptions.onFailure(e);
                                        }
                                    });
                                }
                            },
                            "onFailure":function (e){
                                aOptions.onFailure(e);
                            }
                        });

                    },
                    "onFailure":function(e){
                        aOptions.onFailure(e);
                    }
                });
            }

        });
    };

    InditexClass.prototype.getSolrGridJSON = function(aProtocol, aPath, aData, aOnSuccess, aOnFailure) {
        var self = this;
        var url = "";

        if (self.iIsMockup) {
            url += "../../../../";
        } else {
            url += aProtocol;
            url += "//";

            if (self.iSolrPublicUrlServer === undefined) {
                throw "InditexClass.getSolrJSON: Missing attribute 'iSolrServer'.";
            }

            url += self.iSolrPublicUrlServer + "/";
        }

        url += aPath;

        Inditex.request({
            "url": url,
            "data": aData,
            "contentType": "application/json",
            "onSuccess": function(aText) {
                if (aOnSuccess) {
                    var solrJSON = Inditex.evalJSON(aText);
                    var respJSON = null;
                    if (solrJSON && solrJSON.response && solrJSON.response.docs && solrJSON.response.docs.length >0 && solrJSON.response.docs[0].content){
                        respJSON = solrJSON.response.docs[0].content;
                    }
                    aOnSuccess(respJSON);
                }
            },
            "onFailure": function(aStatus) {
                if (aOnFailure) {
                    aOnFailure(aStatus);
                }
            }
        });
    };

    InditexClass.prototype.getSolrCatalogProducts = function(aOptions) {
        var self = this;
        var path = "grid/select?wt=json&indent=false";
        if (self.iIsMockup) {
            path += ".json";
        }

        var query = "id:" + self.iStoreId + "#" + self.iCatalogId + "#" + aOptions.categoryId + "#" + self.iLangId + "#";

        //El ltimo nmero indica si es con o sin subcategoras.
        if(aOptions.withSubcategories){
            query += "1";
        } else {
            query += "0";
        }
        path += "&fq=" + encodeURIComponent(query) + "&q=" + encodeURIComponent("*:*");

        self.getSolrGridJSON(location.protocol, path, null, aOptions.onSuccess, aOptions.onFailure);
    };


    InditexClass.prototype.getSolrProductDetail = function(aOptions) {
        var self = this;
        var path = "product/select?wt=json&indent=false";
        if (self.iIsMockup) {
            path += ".json";
        }

        var catalogType = self.isMobilePath() ? 5 : 1;

        var query = "id:" + self.iStoreId + "#" + self.iCatalogId + "#" + aOptions.categoryId + "#" + aOptions.productId + "#" + self.iLangId + "#" + catalogType;

        path += "&fq=" + encodeURIComponent(query) + "&q=" + encodeURIComponent("*:*");

        self.getSolrGridJSON(location.protocol, path, null, aOptions.onSuccess, aOptions.onFailure);
    };

    InditexClass.prototype.getRestCatalogIndexProducts = function(aOptions) {
        var self = this;
        var path = "/catalog/store/" + self.iStoreId + "/" + self.iCatalogId
            + "/category/" + aOptions.categoryId + "/indexproductsolr";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        if(aOptions.typeCatalog){
            path += "&typeCatalog=" + aOptions.typeCatalog;
        }

        if(aOptions.withSubcategories){
            path += "&withSubcategories=" + aOptions.withSubcategories;
        }

        if(aOptions.index){
            path += "&index=" + aOptions.index;
        }

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };
    InditexClass.prototype.getRestOrderIdFromBarcode= function(aOptions) {
        var self = this;
        var path = "/order/store/" + self.iStoreId + "/barcode";
        if (self.iIsMockup) {
            path += ".json";
        }
        //path += "?languageId=" + self.iLangId;
        path += aOptions.barcode == undefined
            ? "" : "/" + aOptions.barcode;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);

    };

    InditexClass.prototype.getRestReturnReason = function(aOptions) {
        var self = this;

        var path = "/catalog/store/" + self.iStoreId + "/return-reason";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?languageId=" + self.iLangId;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess,
            aOptions.onFailure);
    };

    InditexClass.prototype.getRestOrderGiftTicket = function(aOptions) {
        var self;
        var url;
        self = this;

        url = self.generateUrl("ItxStandardOrderGiftTicketJSON", {
            "storeId": self.iStoreId,
            "langId": self.iLangId,
            "orderId": aOptions.orderId,
            "userId" : aOptions.userId
        }, true);

        self.request({
            "url": url,
            "onSuccess": function(aText) {
                aOptions.onSuccess(self.evalJSON(aText));
            },
            "onFailure": function(aStatus) {
                aOptions.onFailure(aStatus);
            }
        });

    };

    InditexClass.prototype.getXConfiguracion = function (aOptions) {

        var self = this;
        var path = "/oam/store/" + Inditex.iStoreId + "/xconfiguracion";
        var params = "?variable="+aOptions.parametro;

        path += params;

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess, aOptions.onFailure);
    };

    InditexClass.prototype.getKlarnaAccountDetailedInfo = function (aOptions) {

        var self = this;
        var path = "/order/store/" + self.iStoreId + "/order/" + aOptions.orderId + "/klarna";

        self.getRestJSON(location.protocol, 1, path, null, aOptions.onSuccess, aOptions.onFailure);
    };

    InditexClass.prototype._getProductVisibilityMapTypeTreshold = function(aProductArray, aStockArray) {
        var visibilityMapTypeTreshold = {};

        for (var i = 0; i < aStockArray.length; i++) {
            var stockDetailArray = aStockArray[i].stocks;

            for (var j = 0; j < stockDetailArray.length; j++) {
                var stockDetail = stockDetailArray[j];

                visibilityMapTypeTreshold[stockDetail.id] = stockDetail.typeThreshold;
            }
        }

        return visibilityMapTypeTreshold;
    };


    InditexClass.prototype._initBaiduMaps = function(aCallback) {

        head = document.getElementsByTagName("head")[0] || document.documentElement;
        if(!(head.children[0].src&&(head.children[0].src.indexOf("api.map.baidu.com/api")>-1))){
            var self = this;
            var head;
            var script;
            var done = false;
            var url;
            var params;
            if(aCallback){
                InditexClass.prototype._initBaiduMapsCallback=aCallback;
            }
            var d = new Date();
            var n = d.getTime();
            url = "http://api.map.baidu.com/api?v=2.0&ak="+ self.iBaiduMapsKey;
            if(aCallback){
                if((typeof InditexNew)=="undefined"){
                    url += "&callback=Inditex._initBaiduMapsCallback" ;
                }else{
                    url += "&callback=InditexNew._initBaiduMapsCallback" ;
                }
            }



            script = document.createElement("script");
            script.src = url;
            script.type = "text/javascript";
            script.onload = script.onreadystatechange = function() {
                if (!done) {
                    if (!this.readyState ||
                        this.readyState === "loaded" ||
                        this.readyState === "complete") {

                        done = true;
                        script.onload = script.onreadystatechange = null;
                        if (head && script.parentNode) {
                            // head.removeChild(script);
                        }


                    }
                }

            };

            head = document.getElementsByTagName("head")[0] || document.documentElement;
            if(!(head.children[0].src&&(head.children[0].src.indexOf("api.map.baidu.com/api")>-1))){
                head.insertBefore(script, head.firstChild);
            }
        }else{
            aCallback();
        }
    };


    InditexClass.prototype.getBaiduCoords = function(aCountry, aAddress, aCallback) {
        var self = this;

        self._initBaiduMaps(function() {

            var address = aAddress;

            var myGeo = new BMap.Geocoder();
            myGeo.getPoint(address, function(point){
                if(aCallback){
                    aCallback(point);
                }
            });


        });
    };
    InditexClass.prototype.getBaiduMapsMarkerSize= function(aCustomIcon){
        self=this;
        var img=new Image;
        var src;
        if(aCustomIcon){
            src=self.getBaiduMapsMarkerUrlAlt(false,aCustomIcon);
        }else{
            src=self.getBaiduMapsMarkerUrl(false);
        }
        img.src=src;
        img.onload=function(){
            self.baiduIconWidth=this.width;
            self.baiduIconHeight=this.height;
        };

    }


    InditexClass.prototype.getBaiduMapsMarkerUrl = function(aOn){

        var self = this;
        var result;

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        result += result[result.length -1] == '/' ? '' : '/';

        if(self.isMobilePath())
            result += "itxmobile/images/google_maps_marker_";
        else
            result += "itxstandard/images/google_maps_marker_";

        result += aOn ? "on" : "off";
        result += ".png";

        return result;
    }


    InditexClass.prototype.getBaiduMapsMarkerUrlAlt = function(aOn, aCustomIcon){

        var self = this;
        var result;

        if (window.location.protocol == 'https:') {
            result = self.iStoreJSON.details.staticUrl.replace("http:", "https:");
        } else {
            result = self.iStoreJSON.details.staticUrl.replace("https:", "http:");
        }

        result += result[result.length -1] == '/' ? '' : '/';

        if(self.isMobilePath())
            result += "itxmobile/images/" + aCustomIcon + '_' ;
        else
            result += "itxstandard/images/" + aCustomIcon + '_';

        result += aOn ? "on" : "off";
        result += ".png";

        return result;


    }

    InditexClass.prototype.translateGoogleToBaiduCoords = function(longitude,latitude, aCallback) {
        var url="http://api.map.baidu.com/ag/coord/convert?from=2&to=4&x=" +longitude + "&y=" +latitude;
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'jsonp',
        }).done(function(data) {
            var point = new BMap.Point(data.x, data.y);
            aCallback(point);
        }).fail(function(xhr, errorStatus, error) {

        });
    }

    InditexClass.prototype.initBaiduMaps = function(aContainer, aCountry, aAddress, aCallback, aCustomIcon ) {
        var self = this;
        self.getBaiduMapsMarkerSize(aCustomIcon);

        self.getBaiduCoords(aCountry, aAddress, function(aResult) {

            var map = {
                iMap: new  BMap.Map(aContainer, {
                    mapType: BMAP_NORMAL_MAP
                }),

                iMarkers: [],
                iWindows: [],

                addMark: function(index, latitude, longitude, text, onSuccess) {
                    var self = this;
                    var point= new BMap.Point(longitude,latitude);
                    if ((aCustomIcon == undefined || aCustomIcon == true)){
                        var customIcon = new BMap.Icon(Inditex.getBaiduMapsMarkerUrl(false),  new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight));
                        self.iMarkers[index] = new BMap.Marker(point,{
                            icon: customIcon
                        });
                    }
                    else{
                        if ((aCustomIcon == false)){

                            self.iMarkers[index] = new BMap.Marker(point);
                        }
                        else if(typeof aCustomIcon == "string"){
                            var customIcon = new BMap.Icon(Inditex.getBaiduMapsMarkerUrlAlt(false,aCustomIcon),new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight));
                            self.iMarkers[index] = new BMap.Marker(point,{
                                icon: customIcon
                            });
                        }
                    }
                    if(text&&text!=""){
                        self.iWindows[index] =  new BMap.InfoWindow(text);
                    }

                    self.iMarkers[index].addEventListener('click', function(e){
                        self.focusMark(index);
                        if (onSuccess) {
                            onSuccess(index);
                        }
                    });

                    self.iMap.addOverlay(self.iMarkers[index]);

                },

                focusMark: function(index) {
                    var self = this;

                    for(var i = 0; i < self.iMarkers.length; i++) {
                        if (i == index) {
                            if(self.iWindows[i]){
                                self.iMarkers[i].openInfoWindow(self.iWindows[i]);
                            }
                            if (!self.iMap.getBounds().containsPoint(self.iMarkers[i].getPosition())) {
                                self.iMap.panTo(self.iMarkers[i].getPosition());
                            }
                            if (aCustomIcon == undefined || aCustomIcon == true) {

                                self.iMarkers[i].setIcon(new BMap.Icon(Inditex.getBaiduMapsMarkerUrl(true),new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
                            }
                            else if (typeof aCustomIcon == "string") {
                                self.iMarkers[i].setIcon(new BMap.Icon(Inditex.getBaiduMapsMarkerUrlAlt(true,aCustomIcon),new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
                            }
                        } else {
                            self.iMarkers[i].closeInfoWindow();
                            if (aCustomIcon == undefined || aCustomIcon == true) {
                                self.iMarkers[i].setIcon(new BMap.Icon(Inditex.getBaiduMapsMarkerUrl(false),new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));

                            }

                            else if (typeof aCustomIcon == "string") {
                                self.iMarkers[i].setIcon(new BMap.Icon(Inditex.getBaiduMapsMarkerUrlAlt(false,aCustomIcon),new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));

                            }
                        }
                    }
                },
                clear: function() {
                    var self = this;

                    for (var i = 0; i < self.iWindows.length; i++) {
                        self.iWindows[i].close();
                    }
                    for (var i = 0; i < self.iMarkers.length; i++) {
                        self.iMap.removeOverlay(self.iMarkers[i]);
                    }
                    self.iMarkers.length = 0;
                    self.iWindows.length = 0;
                },
                focus: function() {
                    var self = this;

                    var bounds = new BMap.Bounds();

                    for (var i = 0; i < self.iMarkers.length; i++) {
                        if(self.iMarkers[i]){
                            bounds.extend(self.iMarkers[i].getPosition());
                        }
                    }
                    var boundPoints= new Array(bounds.getNorthEast(),bounds.getSouthWest());
                    self.iMap.setViewport(boundPoints);
                    if(self.iMap.getZoom() > 17) {
                        self.iMap.setZoom(17);
                    }
                }
            }
            if(aResult){
                var centerPoint= aResult;
                map.iMap.centerAndZoom(centerPoint,15);
            }else{
                var centerPoint=  new BMap.Point(116.404, 39.915);
                map.iMap.centerAndZoom(centerPoint,5);
            }
            map.iMap.addControl(new BMap.NavigationControl());
            map.iMap.addControl(new BMap.MapTypeControl());
            map.iMap.enablePinchToZoom();
            map.iMap.enableScrollWheelZoom();
            if(aCallback){
                aCallback(map);
            }

        });
    };

    InditexClass.prototype.getCategoryKeyByCategoryId = function(aCategoryJson, categoryId){
        var self = this;

        var categories = new Array();
        var categoryKey = null;
        var enc = false;

        if(aCategoryJson && aCategoryJson.categories.length>0){
            jQuery.each(aCategoryJson.categories,function(index,category){
                categories.push(category);
            });
        }

        while(categories.length>0 && !enc){
            var category = categories[0];
            if(category.id == categoryId){
                categoryKey = category.key;
                enc = true;
            }else{
                if(category.subcategories && category.subcategories.length>0){
                    jQuery.each(category.subcategories,function(index2,subcategory){
                        categories.push(subcategory);
                    });
                }
                categories.splice(0,1);
            }
        }

        return categoryKey;
    }


    InditexClass.prototype.getCategoryIdByCategoryKey = function(aCategoryJson, categoryKey){
        var self = this;

        var categories = new Array();
        var categoryId = null;
        var enc = false;

        if(aCategoryJson && aCategoryJson.categories.length>0){
            jQuery.each(aCategoryJson.categories,function(index,category){
                categories.push(category);
            });
        }

        while(categories.length>0 && !enc){
            var category = categories[0];
            if(category.key == categoryKey){
                categoryId = category.id;
                enc = true;
            }else{
                if(category.subcategories && category.subcategories.length>0){
                    jQuery.each(category.subcategories,function(index2,subcategory){
                        categories.push(subcategory);
                    });
                }
                categories.splice(0,1);
            }
        }

        return categoryId;
    }



    InditexClass.prototype._getECList = function() {return null};
    InditexClass.prototype._getECBrand = function() {return null};
    InditexClass.prototype._getECCategory = function() {return null};
    InditexClass.prototype._getECCategoryDataDB = function() {return null};

})(typeof __inditexInstanceName != "undefined" && __inditexInstanceName == "InditexNew" ? InditexNew : Inditex,
    typeof __inditexInstanceName != "undefined" && __inditexInstanceName == "InditexNew" ? InditexClasNew : InditexClass,
    typeof __inditexInstanceName != "undefined" && __inditexInstanceName == "InditexNew" ? 'WC_ITX_HEADERDATA_NEW' : 'WC_ITX_HEADERDATA')




;
/* END /Common/js/inditex-current.js (en_US) */

/* BEGIN /Common/js/shComp.js (en_US) */
function loadHash(e){if(typeof jQuery=='undefined'){var t=$(document.body).getElement("input[name=logonId]");var n=$(document.body).getElement("input[name=logonPassword]");var r=$(document.body).getElement("input[name=gc_token]");var i=CryptoJS.MD5(t.get("value"));var s=n.get("value");var o=getHash(i,s);r.set("value",o);e()}else{var t=jQuery("input[name=logonId]");var n=jQuery("input[name=logonPassword]");var r=jQuery("input[name=gc_token]");var i=CryptoJS.MD5(t.val());var s=n.val();var o=getHash(i,s);r.val(o);e()}}function loadGiftCardHash(callback){if(typeof jQuery=='undefined'){var barcodeId=$(document.body).getElement('input[name=barcode]');var captchaId=$(document.body).getElement('input[name=captcha]');var tokenHash=$(document.body).getElement('input[name=gc_token]');var valToHash=barcodeId.val()+Inditex.iStoreId.toString()+Inditex.iCatalogId.toString()+Inditex.iLangId.toString();var hash=CryptoJS.MD5(valToHash);var key=captchaId.val();var salida=getHash(hash,key);tokenHash.set('value',salida);callback()}else{var barcodeId=jQuery('input[name=barcode]');var captchaId=jQuery('input[name=captcha]');var tokenHash=jQuery('input[name=gc_token]');var valToHash=barcodeId.val()+Inditex.iStoreId.toString()+Inditex.iCatalogId.toString()+Inditex.iLangId.toString();var hash=CryptoJS.MD5(valToHash);var key=captchaId.val();var salida=getHash(hash,key);tokenHash.val(salida);callback()}} function getToken(e,t){var n=CryptoJS.MD5(e);var r=t;var i=getHash(n,r);return i}function getHash(e,t){var n=wordToByteArray(e.words);var i=toUTF8Array(t);var o=0;for(r=0;r<i.length;r++){o=parseInt(o)+parseInt(i[r])}o=Math.abs(o);for(b=0;b<n.length;b++){if(b%2==0){if(n[b]==127){n[b]=-128}else{n[b]=n[b]+1}}else{if(n[b]==-128){n[b]=127}else{n[b]=n[b]-1}}n[b]=parseInt(n[b]*o/127);while(n[b]>254){n[b]=parseInt(n[b]/127)}if(n[b]>127){n[b]=n[b]-127}while(n[b]<-254){n[b]=parseInt(n[b]/127)}if(n[b]<-127){n[b]=n[b]+127}}var u=n[0];var a=n[n.length-1];n[0]=a;n[n.length-1]=u;var f=[];if(n.length>8){for(c=0;c<8;c++){f[c]=n[c]}}var l="";var h=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];for(s=0;s<8;s++){var p=h[f[s]>>4&15]+h[f[s]&15];l=l+p}return l}function wordToByteArray(e){var t=[],n,r,i;for(r=0;r<e.length;++r){n=e[r];var s=n>>24&255;s=isNumberNeg(s);var o=n>>16&255;o=isNumberNeg(o);var u=n>>8&255;u=isNumberNeg(u);var a=n&255;a=isNumberNeg(a);t.push(s);t.push(o);t.push(u);t.push(a)}return t}function isNumberNeg(e){var t=e&128;t=t<<24;if((e|t)<0){e=e-256}return e}function toUTF8Array(e){var t=[];for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128)t.push(r);else if(r<2048){var i=192|r>>6;i=i-256;var s=128|r&63;s=s-256;t.push(i,s)}else if(r<55296||r>=57344){t.push(224|r>>12,128|r>>6&63,128|r&63)}else{n++;r=65536+((r&1023)<<10|e.charCodeAt(n)&1023);t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|r&63)}}return t};
/* END /Common/js/shComp.js (en_US) */

/* BEGIN /Common/js/md5.js (en_US) */
/*
 CryptoJS v3.1.2
 code.google.com/p/crypto-js
 (c) 2009-2013 by Jeff Mott. All rights reserved.
 code.google.com/p/crypto-js/wiki/License
 */
var CryptoJS=CryptoJS||function(s,p){var m={},l=m.lib={},n=function(){},r=l.Base={extend:function(b){n.prototype=this;var h=new n;b&&h.mixIn(b);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var b=this.extend();b.init.apply(b,arguments);return b},init:function(){},mixIn:function(b){for(var h in b)b.hasOwnProperty(h)&&(this[h]=b[h]);b.hasOwnProperty("toString")&&(this.toString=b.toString)},clone:function(){return this.init.prototype.extend(this)}},
        q=l.WordArray=r.extend({init:function(b,h){b=this.words=b||[];this.sigBytes=h!=p?h:4*b.length},toString:function(b){return(b||t).stringify(this)},concat:function(b){var h=this.words,a=b.words,j=this.sigBytes;b=b.sigBytes;this.clamp();if(j%4)for(var g=0;g<b;g++)h[j+g>>>2]|=(a[g>>>2]>>>24-8*(g%4)&255)<<24-8*((j+g)%4);else if(65535<a.length)for(g=0;g<b;g+=4)h[j+g>>>2]=a[g>>>2];else h.push.apply(h,a);this.sigBytes+=b;return this},clamp:function(){var b=this.words,h=this.sigBytes;b[h>>>2]&=4294967295<<
            32-8*(h%4);b.length=s.ceil(h/4)},clone:function(){var b=r.clone.call(this);b.words=this.words.slice(0);return b},random:function(b){for(var h=[],a=0;a<b;a+=4)h.push(4294967296*s.random()|0);return new q.init(h,b)}}),v=m.enc={},t=v.Hex={stringify:function(b){var a=b.words;b=b.sigBytes;for(var g=[],j=0;j<b;j++){var k=a[j>>>2]>>>24-8*(j%4)&255;g.push((k>>>4).toString(16));g.push((k&15).toString(16))}return g.join("")},parse:function(b){for(var a=b.length,g=[],j=0;j<a;j+=2)g[j>>>3]|=parseInt(b.substr(j,
                2),16)<<24-4*(j%8);return new q.init(g,a/2)}},a=v.Latin1={stringify:function(b){var a=b.words;b=b.sigBytes;for(var g=[],j=0;j<b;j++)g.push(String.fromCharCode(a[j>>>2]>>>24-8*(j%4)&255));return g.join("")},parse:function(b){for(var a=b.length,g=[],j=0;j<a;j++)g[j>>>2]|=(b.charCodeAt(j)&255)<<24-8*(j%4);return new q.init(g,a)}},u=v.Utf8={stringify:function(b){try{return decodeURIComponent(escape(a.stringify(b)))}catch(g){throw Error("Malformed UTF-8 data");}},parse:function(b){return a.parse(unescape(encodeURIComponent(b)))}},
        g=l.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new q.init;this._nDataBytes=0},_append:function(b){"string"==typeof b&&(b=u.parse(b));this._data.concat(b);this._nDataBytes+=b.sigBytes},_process:function(b){var a=this._data,g=a.words,j=a.sigBytes,k=this.blockSize,m=j/(4*k),m=b?s.ceil(m):s.max((m|0)-this._minBufferSize,0);b=m*k;j=s.min(4*b,j);if(b){for(var l=0;l<b;l+=k)this._doProcessBlock(g,l);l=g.splice(0,b);a.sigBytes-=j}return new q.init(l,j)},clone:function(){var b=r.clone.call(this);
            b._data=this._data.clone();return b},_minBufferSize:0});l.Hasher=g.extend({cfg:r.extend(),init:function(b){this.cfg=this.cfg.extend(b);this.reset()},reset:function(){g.reset.call(this);this._doReset()},update:function(b){this._append(b);this._process();return this},finalize:function(b){b&&this._append(b);return this._doFinalize()},blockSize:16,_createHelper:function(b){return function(a,g){return(new b.init(g)).finalize(a)}},_createHmacHelper:function(b){return function(a,g){return(new k.HMAC.init(b,
        g)).finalize(a)}}});var k=m.algo={};return m}(Math);
(function(s){function p(a,k,b,h,l,j,m){a=a+(k&b|~k&h)+l+m;return(a<<j|a>>>32-j)+k}function m(a,k,b,h,l,j,m){a=a+(k&h|b&~h)+l+m;return(a<<j|a>>>32-j)+k}function l(a,k,b,h,l,j,m){a=a+(k^b^h)+l+m;return(a<<j|a>>>32-j)+k}function n(a,k,b,h,l,j,m){a=a+(b^(k|~h))+l+m;return(a<<j|a>>>32-j)+k}for(var r=CryptoJS,q=r.lib,v=q.WordArray,t=q.Hasher,q=r.algo,a=[],u=0;64>u;u++)a[u]=4294967296*s.abs(s.sin(u+1))|0;q=q.MD5=t.extend({_doReset:function(){this._hash=new v.init([1732584193,4023233417,2562383102,271733878])},
    _doProcessBlock:function(g,k){for(var b=0;16>b;b++){var h=k+b,w=g[h];g[h]=(w<<8|w>>>24)&16711935|(w<<24|w>>>8)&4278255360}var b=this._hash.words,h=g[k+0],w=g[k+1],j=g[k+2],q=g[k+3],r=g[k+4],s=g[k+5],t=g[k+6],u=g[k+7],v=g[k+8],x=g[k+9],y=g[k+10],z=g[k+11],A=g[k+12],B=g[k+13],C=g[k+14],D=g[k+15],c=b[0],d=b[1],e=b[2],f=b[3],c=p(c,d,e,f,h,7,a[0]),f=p(f,c,d,e,w,12,a[1]),e=p(e,f,c,d,j,17,a[2]),d=p(d,e,f,c,q,22,a[3]),c=p(c,d,e,f,r,7,a[4]),f=p(f,c,d,e,s,12,a[5]),e=p(e,f,c,d,t,17,a[6]),d=p(d,e,f,c,u,22,a[7]),
        c=p(c,d,e,f,v,7,a[8]),f=p(f,c,d,e,x,12,a[9]),e=p(e,f,c,d,y,17,a[10]),d=p(d,e,f,c,z,22,a[11]),c=p(c,d,e,f,A,7,a[12]),f=p(f,c,d,e,B,12,a[13]),e=p(e,f,c,d,C,17,a[14]),d=p(d,e,f,c,D,22,a[15]),c=m(c,d,e,f,w,5,a[16]),f=m(f,c,d,e,t,9,a[17]),e=m(e,f,c,d,z,14,a[18]),d=m(d,e,f,c,h,20,a[19]),c=m(c,d,e,f,s,5,a[20]),f=m(f,c,d,e,y,9,a[21]),e=m(e,f,c,d,D,14,a[22]),d=m(d,e,f,c,r,20,a[23]),c=m(c,d,e,f,x,5,a[24]),f=m(f,c,d,e,C,9,a[25]),e=m(e,f,c,d,q,14,a[26]),d=m(d,e,f,c,v,20,a[27]),c=m(c,d,e,f,B,5,a[28]),f=m(f,c,
            d,e,j,9,a[29]),e=m(e,f,c,d,u,14,a[30]),d=m(d,e,f,c,A,20,a[31]),c=l(c,d,e,f,s,4,a[32]),f=l(f,c,d,e,v,11,a[33]),e=l(e,f,c,d,z,16,a[34]),d=l(d,e,f,c,C,23,a[35]),c=l(c,d,e,f,w,4,a[36]),f=l(f,c,d,e,r,11,a[37]),e=l(e,f,c,d,u,16,a[38]),d=l(d,e,f,c,y,23,a[39]),c=l(c,d,e,f,B,4,a[40]),f=l(f,c,d,e,h,11,a[41]),e=l(e,f,c,d,q,16,a[42]),d=l(d,e,f,c,t,23,a[43]),c=l(c,d,e,f,x,4,a[44]),f=l(f,c,d,e,A,11,a[45]),e=l(e,f,c,d,D,16,a[46]),d=l(d,e,f,c,j,23,a[47]),c=n(c,d,e,f,h,6,a[48]),f=n(f,c,d,e,u,10,a[49]),e=n(e,f,c,d,
            C,15,a[50]),d=n(d,e,f,c,s,21,a[51]),c=n(c,d,e,f,A,6,a[52]),f=n(f,c,d,e,q,10,a[53]),e=n(e,f,c,d,y,15,a[54]),d=n(d,e,f,c,w,21,a[55]),c=n(c,d,e,f,v,6,a[56]),f=n(f,c,d,e,D,10,a[57]),e=n(e,f,c,d,t,15,a[58]),d=n(d,e,f,c,B,21,a[59]),c=n(c,d,e,f,r,6,a[60]),f=n(f,c,d,e,z,10,a[61]),e=n(e,f,c,d,j,15,a[62]),d=n(d,e,f,c,x,21,a[63]);b[0]=b[0]+c|0;b[1]=b[1]+d|0;b[2]=b[2]+e|0;b[3]=b[3]+f|0},_doFinalize:function(){var a=this._data,k=a.words,b=8*this._nDataBytes,h=8*a.sigBytes;k[h>>>5]|=128<<24-h%32;var l=s.floor(b/
        4294967296);k[(h+64>>>9<<4)+15]=(l<<8|l>>>24)&16711935|(l<<24|l>>>8)&4278255360;k[(h+64>>>9<<4)+14]=(b<<8|b>>>24)&16711935|(b<<24|b>>>8)&4278255360;a.sigBytes=4*(k.length+1);this._process();a=this._hash;k=a.words;for(b=0;4>b;b++)h=k[b],k[b]=(h<<8|h>>>24)&16711935|(h<<24|h>>>8)&4278255360;return a},clone:function(){var a=t.clone.call(this);a._hash=this._hash.clone();return a}});r.MD5=t._createHelper(q);r.HmacMD5=t._createHmacHelper(q)})(Math);;
/* END /Common/js/md5.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/modernizr.min.js (en_US) */
/* Modernizr 2.6.2 (Custom Build) | MIT & BSD
 * Build: http://modernizr.com/download/#-geolocation-shiv-cssclasses-load
 */
;window.Modernizr=function(a,b,c){function u(a){j.cssText=a}function v(a,b){return u(prefixes.join(a+";")+(b||""))}function w(a,b){return typeof a===b}function x(a,b){return!!~(""+a).indexOf(b)}function y(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:w(f,"function")?f.bind(d||b):f}return!1}var d="2.6.2",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k,l={}.toString,m={},n={},o={},p=[],q=p.slice,r,s={}.hasOwnProperty,t;!w(s,"undefined")&&!w(s.call,"undefined")?t=function(a,b){return s.call(a,b)}:t=function(a,b){return b in a&&w(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=q.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(q.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(q.call(arguments)))};return e}),m.geolocation=function(){return"geolocation"in navigator};for(var z in m)t(m,z)&&(r=z.toLowerCase(),e[r]=m[z](),p.push((e[r]?"":"no-")+r));return e.addTest=function(a,b){if(typeof a=="object")for(var d in a)t(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,typeof f!="undefined"&&f&&(g.className+=" "+(b?"":"no-")+a),e[a]=b}return e},u(""),i=k=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return typeof a=="string"?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){c||(c=b);if(j)return c.createElement(a);f||(f=m(c));var g;return f.cache[a]?g=f.cache[a].cloneNode():e.test(a)?g=(f.cache[a]=f.createElem(a)).cloneNode():g=f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){a||(a=b);if(j)return a.createDocumentFragment();c=c||m(a);var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;for(;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,f,g="_html5shiv",h=0,i={},j;(function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=a.childNodes.length==1||function(){b.createElement("a");var a=b.createDocumentFragment();return typeof a.cloneNode=="undefined"||typeof a.createDocumentFragment=="undefined"||typeof a.createElement=="undefined"}()}catch(c){f=!0,j=!0}})();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,supportsUnknownElements:j,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version=d,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+p.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};;
/* END /DuttiNEWStorefrontAssetStore/js/lib/modernizr.min.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/jquery.validate.min.js (en_US) */
/*! jQuery Validation Plugin - v1.12.0 - 4/1/2014
 * http://jqueryvalidation.org/
 * Copyright (c) 2014 Jrn Zaefferer; Licensed MIT */
!function(a){a.extend(a.fn,{validate:function(b){if(!this.length)return void(b&&b.debug&&window.console&&console.warn("Nothing selected, can't validate, returning nothing."));var c=a.data(this[0],"validator");return c?c:(this.attr("novalidate","novalidate"),c=new a.validator(b,this[0]),a.data(this[0],"validator",c),c.settings.onsubmit&&(this.validateDelegate(":submit","click",function(b){c.settings.submitHandler&&(c.submitButton=b.target),a(b.target).hasClass("cancel")&&(c.cancelSubmit=!0),void 0!==a(b.target).attr("formnovalidate")&&(c.cancelSubmit=!0)}),this.submit(function(b){function d(){var d;return c.settings.submitHandler?(c.submitButton&&(d=a("<input type='hidden'/>").attr("name",c.submitButton.name).val(a(c.submitButton).val()).appendTo(c.currentForm)),c.settings.submitHandler.call(c,c.currentForm,b),c.submitButton&&d.remove(),!1):!0}return c.settings.debug&&b.preventDefault(),c.cancelSubmit?(c.cancelSubmit=!1,d()):c.form()?c.pendingRequest?(c.formSubmitted=!0,!1):d():(c.focusInvalid(),!1)})),c)},valid:function(){var b,c;return a(this[0]).is("form")?b=this.validate().form():(b=!0,c=a(this[0].form).validate(),this.each(function(){b=c.element(this)&&b})),b},removeAttrs:function(b){var c={},d=this;return a.each(b.split(/\s/),function(a,b){c[b]=d.attr(b),d.removeAttr(b)}),c},rules:function(b,c){var d,e,f,g,h,i,j=this[0];if(b)switch(d=a.data(j.form,"validator").settings,e=d.rules,f=a.validator.staticRules(j),b){case"add":a.extend(f,a.validator.normalizeRule(c)),delete f.messages,e[j.name]=f,c.messages&&(d.messages[j.name]=a.extend(d.messages[j.name],c.messages));break;case"remove":return c?(i={},a.each(c.split(/\s/),function(b,c){i[c]=f[c],delete f[c],"required"===c&&a(j).removeAttr("aria-required")}),i):(delete e[j.name],f)}return g=a.validator.normalizeRules(a.extend({},a.validator.classRules(j),a.validator.attributeRules(j),a.validator.dataRules(j),a.validator.staticRules(j)),j),g.required&&(h=g.required,delete g.required,g=a.extend({required:h},g),a(j).attr("aria-required","true")),g.remote&&(h=g.remote,delete g.remote,g=a.extend(g,{remote:h})),g}}),a.extend(a.expr[":"],{blank:function(b){return!a.trim(""+a(b).val())},filled:function(b){return!!a.trim(""+a(b).val())},unchecked:function(b){return!a(b).prop("checked")}}),a.validator=function(b,c){this.settings=a.extend(!0,{},a.validator.defaults,b),this.currentForm=c,this.init()},a.validator.format=function(b,c){return 1===arguments.length?function(){var c=a.makeArray(arguments);return c.unshift(b),a.validator.format.apply(this,c)}:(arguments.length>2&&c.constructor!==Array&&(c=a.makeArray(arguments).slice(1)),c.constructor!==Array&&(c=[c]),a.each(c,function(a,c){b=b.replace(new RegExp("\\{"+a+"\\}","g"),function(){return c})}),b)},a.extend(a.validator,{defaults:{messages:{},groups:{},rules:{},errorClass:"error",validClass:"valid",errorElement:"label",focusInvalid:!0,errorContainer:a([]),errorLabelContainer:a([]),onsubmit:!0,ignore:":hidden",ignoreTitle:!1,onfocusin:function(a){this.lastActive=a,this.settings.focusCleanup&&!this.blockFocusCleanup&&(this.settings.unhighlight&&this.settings.unhighlight.call(this,a,this.settings.errorClass,this.settings.validClass),this.addWrapper(this.errorsFor(a)).hide())},onfocusout:function(a){this.checkable(a)||!(a.name in this.submitted)&&this.optional(a)||this.element(a)},onkeyup:function(a,b){(9!==b.which||""!==this.elementValue(a))&&(a.name in this.submitted||a===this.lastElement)&&this.element(a)},onclick:function(a){a.name in this.submitted?this.element(a):a.parentNode.name in this.submitted&&this.element(a.parentNode)},highlight:function(b,c,d){"radio"===b.type?this.findByName(b.name).addClass(c).removeClass(d):a(b).addClass(c).removeClass(d)},unhighlight:function(b,c,d){"radio"===b.type?this.findByName(b.name).removeClass(c).addClass(d):a(b).removeClass(c).addClass(d)}},setDefaults:function(b){a.extend(a.validator.defaults,b)},messages:{required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",maxlength:a.validator.format("Please enter no more than {0} characters."),minlength:a.validator.format("Please enter at least {0} characters."),rangelength:a.validator.format("Please enter a value between {0} and {1} characters long."),range:a.validator.format("Please enter a value between {0} and {1}."),max:a.validator.format("Please enter a value less than or equal to {0}."),min:a.validator.format("Please enter a value greater than or equal to {0}.")},autoCreateRanges:!1,prototype:{init:function(){function b(b){var c=a.data(this[0].form,"validator"),d="on"+b.type.replace(/^validate/,""),e=c.settings;e[d]&&!this.is(e.ignore)&&e[d].call(c,this[0],b)}this.labelContainer=a(this.settings.errorLabelContainer),this.errorContext=this.labelContainer.length&&this.labelContainer||a(this.currentForm),this.containers=a(this.settings.errorContainer).add(this.settings.errorLabelContainer),this.submitted={},this.valueCache={},this.pendingRequest=0,this.pending={},this.invalid={},this.reset();var c,d=this.groups={};a.each(this.settings.groups,function(b,c){"string"==typeof c&&(c=c.split(/\s/)),a.each(c,function(a,c){d[c]=b})}),c=this.settings.rules,a.each(c,function(b,d){c[b]=a.validator.normalizeRule(d)}),a(this.currentForm).validateDelegate(":text, [type='password'], [type='file'], select, textarea, [type='number'], [type='search'] ,[type='tel'], [type='url'], [type='email'], [type='datetime'], [type='date'], [type='month'], [type='week'], [type='time'], [type='datetime-local'], [type='range'], [type='color'] ","focusin focusout keyup",b).validateDelegate("[type='radio'], [type='checkbox'], select, option","click",b),this.settings.invalidHandler&&a(this.currentForm).bind("invalid-form.validate",this.settings.invalidHandler),a(this.currentForm).find("[required], [data-rule-required], .required").attr("aria-required","true")},form:function(){return this.checkForm(),a.extend(this.submitted,this.errorMap),this.invalid=a.extend({},this.errorMap),this.valid()||a(this.currentForm).triggerHandler("invalid-form",[this]),this.showErrors(),this.valid()},checkForm:function(){this.prepareForm();for(var a=0,b=this.currentElements=this.elements();b[a];a++)this.check(b[a]);return this.valid()},element:function(b){var c=this.clean(b),d=this.validationTargetFor(c),e=!0;return this.lastElement=d,void 0===d?delete this.invalid[c.name]:(this.prepareElement(d),this.currentElements=a(d),e=this.check(d)!==!1,e?delete this.invalid[d.name]:this.invalid[d.name]=!0),a(b).attr("aria-invalid",!e),this.numberOfInvalids()||(this.toHide=this.toHide.add(this.containers)),this.showErrors(),e},showErrors:function(b){if(b){a.extend(this.errorMap,b),this.errorList=[];for(var c in b)this.errorList.push({message:b[c],element:this.findByName(c)[0]});this.successList=a.grep(this.successList,function(a){return!(a.name in b)})}this.settings.showErrors?this.settings.showErrors.call(this,this.errorMap,this.errorList):this.defaultShowErrors()},resetForm:function(){a.fn.resetForm&&a(this.currentForm).resetForm(),this.submitted={},this.lastElement=null,this.prepareForm(),this.hideErrors(),this.elements().removeClass(this.settings.errorClass).removeData("previousValue").removeAttr("aria-invalid")},numberOfInvalids:function(){return this.objectLength(this.invalid)},objectLength:function(a){var b,c=0;for(b in a)c++;return c},hideErrors:function(){this.addWrapper(this.toHide).hide()},valid:function(){return 0===this.size()},size:function(){return this.errorList.length},focusInvalid:function(){if(this.settings.focusInvalid)try{a(this.findLastActive()||this.errorList.length&&this.errorList[0].element||[]).filter(":visible").focus().trigger("focusin")}catch(b){}},findLastActive:function(){var b=this.lastActive;return b&&1===a.grep(this.errorList,function(a){return a.element.name===b.name}).length&&b},elements:function(){var b=this,c={};return a(this.currentForm).find("input, select, textarea").not(":submit, :reset, :image, [disabled]").not(this.settings.ignore).filter(function(){return!this.name&&b.settings.debug&&window.console&&console.error("%o has no name assigned",this),this.name in c||!b.objectLength(a(this).rules())?!1:(c[this.name]=!0,!0)})},clean:function(b){return a(b)[0]},errors:function(){var b=this.settings.errorClass.split(" ").join(".");return a(this.settings.errorElement+"."+b,this.errorContext)},reset:function(){this.successList=[],this.errorList=[],this.errorMap={},this.toShow=a([]),this.toHide=a([]),this.currentElements=a([])},prepareForm:function(){this.reset(),this.toHide=this.errors().add(this.containers)},prepareElement:function(a){this.reset(),this.toHide=this.errorsFor(a)},elementValue:function(b){var c,d=a(b),e=d.attr("type");return"radio"===e||"checkbox"===e?a("input[name='"+d.attr("name")+"']:checked").val():(c=d.val(),"string"==typeof c?c.replace(/\r/g,""):c)},check:function(b){b=this.validationTargetFor(this.clean(b));var c,d,e,f=a(b).rules(),g=a.map(f,function(a,b){return b}).length,h=!1,i=this.elementValue(b);for(d in f){e={method:d,parameters:f[d]};try{if(c=a.validator.methods[d].call(this,i,b,e.parameters),"dependency-mismatch"===c&&1===g){h=!0;continue}if(h=!1,"pending"===c)return void(this.toHide=this.toHide.not(this.errorsFor(b)));if(!c)return this.formatAndAdd(b,e),!1}catch(j){throw this.settings.debug&&window.console&&console.log("Exception occurred when checking element "+b.id+", check the '"+e.method+"' method.",j),j}}if(!h)return this.objectLength(f)&&this.successList.push(b),!0},customDataMessage:function(b,c){return a(b).data("msg"+c[0].toUpperCase()+c.substring(1).toLowerCase())||a(b).data("msg")},customMessage:function(a,b){var c=this.settings.messages[a];return c&&(c.constructor===String?c:c[b])},findDefined:function(){for(var a=0;a<arguments.length;a++)if(void 0!==arguments[a])return arguments[a];return void 0},defaultMessage:function(b,c){return this.findDefined(this.customMessage(b.name,c),this.customDataMessage(b,c),!this.settings.ignoreTitle&&b.title||void 0,a.validator.messages[c],"<strong>Warning: No message defined for "+b.name+"</strong>")},formatAndAdd:function(b,c){var d=this.defaultMessage(b,c.method),e=/\$?\{(\d+)\}/g;"function"==typeof d?d=d.call(this,c.parameters,b):e.test(d)&&(d=a.validator.format(d.replace(e,"{$1}"),c.parameters)),this.errorList.push({message:d,element:b,method:c.method}),this.errorMap[b.name]=d,this.submitted[b.name]=d},addWrapper:function(a){return this.settings.wrapper&&(a=a.add(a.parent(this.settings.wrapper))),a},defaultShowErrors:function(){var a,b,c;for(a=0;this.errorList[a];a++)c=this.errorList[a],this.settings.highlight&&this.settings.highlight.call(this,c.element,this.settings.errorClass,this.settings.validClass),this.showLabel(c.element,c.message);if(this.errorList.length&&(this.toShow=this.toShow.add(this.containers)),this.settings.success)for(a=0;this.successList[a];a++)this.showLabel(this.successList[a]);if(this.settings.unhighlight)for(a=0,b=this.validElements();b[a];a++)this.settings.unhighlight.call(this,b[a],this.settings.errorClass,this.settings.validClass);this.toHide=this.toHide.not(this.toShow),this.hideErrors(),this.addWrapper(this.toShow).show()},validElements:function(){return this.currentElements.not(this.invalidElements())},invalidElements:function(){return a(this.errorList).map(function(){return this.element})},showLabel:function(b,c){var d=this.errorsFor(b);d.length?(d.removeClass(this.settings.validClass).addClass(this.settings.errorClass),d.html(c)):(d=a("<"+this.settings.errorElement+">").attr("for",this.idOrName(b)).addClass(this.settings.errorClass).html(c||""),this.settings.wrapper&&(d=d.hide().show().wrap("<"+this.settings.wrapper+"/>").parent()),this.labelContainer.append(d).length||(this.settings.errorPlacement?this.settings.errorPlacement(d,a(b)):d.insertAfter(b))),!c&&this.settings.success&&(d.text(""),"string"==typeof this.settings.success?d.addClass(this.settings.success):this.settings.success(d,b)),this.toShow=this.toShow.add(d)},errorsFor:function(b){var c=this.idOrName(b);return this.errors().filter(function(){return a(this).attr("for")===c})},idOrName:function(a){return this.groups[a.name]||(this.checkable(a)?a.name:a.id||a.name)},validationTargetFor:function(a){return this.checkable(a)&&(a=this.findByName(a.name).not(this.settings.ignore)[0]),a},checkable:function(a){return/radio|checkbox/i.test(a.type)},findByName:function(b){return a(this.currentForm).find("[name='"+b+"']")},getLength:function(b,c){switch(c.nodeName.toLowerCase()){case"select":return a("option:selected",c).length;case"input":if(this.checkable(c))return this.findByName(c.name).filter(":checked").length}return b.length},depend:function(a,b){return this.dependTypes[typeof a]?this.dependTypes[typeof a](a,b):!0},dependTypes:{"boolean":function(a){return a},string:function(b,c){return!!a(b,c.form).length},"function":function(a,b){return a(b)}},optional:function(b){var c=this.elementValue(b);return!a.validator.methods.required.call(this,c,b)&&"dependency-mismatch"},startRequest:function(a){this.pending[a.name]||(this.pendingRequest++,this.pending[a.name]=!0)},stopRequest:function(b,c){this.pendingRequest--,this.pendingRequest<0&&(this.pendingRequest=0),delete this.pending[b.name],c&&0===this.pendingRequest&&this.formSubmitted&&this.form()?(a(this.currentForm).submit(),this.formSubmitted=!1):!c&&0===this.pendingRequest&&this.formSubmitted&&(a(this.currentForm).triggerHandler("invalid-form",[this]),this.formSubmitted=!1)},previousValue:function(b){return a.data(b,"previousValue")||a.data(b,"previousValue",{old:null,valid:!0,message:this.defaultMessage(b,"remote")})}},classRuleSettings:{required:{required:!0},email:{email:!0},url:{url:!0},date:{date:!0},dateISO:{dateISO:!0},number:{number:!0},digits:{digits:!0},creditcard:{creditcard:!0}},addClassRules:function(b,c){b.constructor===String?this.classRuleSettings[b]=c:a.extend(this.classRuleSettings,b)},classRules:function(b){var c={},d=a(b).attr("class");return d&&a.each(d.split(" "),function(){this in a.validator.classRuleSettings&&a.extend(c,a.validator.classRuleSettings[this])}),c},attributeRules:function(b){var c,d,e={},f=a(b),g=b.getAttribute("type");for(c in a.validator.methods)"required"===c?(d=b.getAttribute(c),""===d&&(d=!0),d=!!d):d=f.attr(c),/min|max/.test(c)&&(null===g||/number|range|text/.test(g))&&(d=Number(d)),d||0===d?e[c]=d:g===c&&"range"!==g&&(e[c]=!0);return e.maxlength&&/-1|2147483647|524288/.test(e.maxlength)&&delete e.maxlength,e},dataRules:function(b){var c,d,e={},f=a(b);for(c in a.validator.methods)d=f.data("rule"+c[0].toUpperCase()+c.substring(1).toLowerCase()),void 0!==d&&(e[c]=d);return e},staticRules:function(b){var c={},d=a.data(b.form,"validator");return d.settings.rules&&(c=a.validator.normalizeRule(d.settings.rules[b.name])||{}),c},normalizeRules:function(b,c){return a.each(b,function(d,e){if(e===!1)return void delete b[d];if(e.param||e.depends){var f=!0;switch(typeof e.depends){case"string":f=!!a(e.depends,c.form).length;break;case"function":f=e.depends.call(c,c)}f?b[d]=void 0!==e.param?e.param:!0:delete b[d]}}),a.each(b,function(d,e){b[d]=a.isFunction(e)?e(c):e}),a.each(["minlength","maxlength"],function(){b[this]&&(b[this]=Number(b[this]))}),a.each(["rangelength","range"],function(){var c;b[this]&&(a.isArray(b[this])?b[this]=[Number(b[this][0]),Number(b[this][1])]:"string"==typeof b[this]&&(c=b[this].split(/[\s,]+/),b[this]=[Number(c[0]),Number(c[1])]))}),a.validator.autoCreateRanges&&(b.min&&b.max&&(b.range=[b.min,b.max],delete b.min,delete b.max),b.minlength&&b.maxlength&&(b.rangelength=[b.minlength,b.maxlength],delete b.minlength,delete b.maxlength)),b},normalizeRule:function(b){if("string"==typeof b){var c={};a.each(b.split(/\s/),function(){c[this]=!0}),b=c}return b},addMethod:function(b,c,d){a.validator.methods[b]=c,a.validator.messages[b]=void 0!==d?d:a.validator.messages[b],c.length<3&&a.validator.addClassRules(b,a.validator.normalizeRule(b))},methods:{required:function(b,c,d){if(!this.depend(d,c))return"dependency-mismatch";if("select"===c.nodeName.toLowerCase()){var e=a(c).val();return e&&e.length>0}return this.checkable(c)?this.getLength(b,c)>0:a.trim(b).length>0},email:function(a,b){return this.optional(b)||/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(a)},url:function(a,b){return this.optional(b)||/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(a)},date:function(a,b){return this.optional(b)||!/Invalid|NaN/.test(new Date(a).toString())},dateISO:function(a,b){return this.optional(b)||/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(a)},number:function(a,b){return this.optional(b)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(a)},digits:function(a,b){return this.optional(b)||/^\d+$/.test(a)},creditcard:function(a,b){if(this.optional(b))return"dependency-mismatch";if(/[^0-9 \-]+/.test(a))return!1;var c,d,e=0,f=0,g=!1;if(a=a.replace(/\D/g,""),a.length<13||a.length>19)return!1;for(c=a.length-1;c>=0;c--)d=a.charAt(c),f=parseInt(d,10),g&&(f*=2)>9&&(f-=9),e+=f,g=!g;return e%10===0},minlength:function(b,c,d){var e=a.isArray(b)?b.length:this.getLength(a.trim(b),c);return this.optional(c)||e>=d},maxlength:function(b,c,d){var e=a.isArray(b)?b.length:this.getLength(a.trim(b),c);return this.optional(c)||d>=e},rangelength:function(b,c,d){var e=a.isArray(b)?b.length:this.getLength(a.trim(b),c);return this.optional(c)||e>=d[0]&&e<=d[1]},min:function(a,b,c){return this.optional(b)||a>=c},max:function(a,b,c){return this.optional(b)||c>=a},range:function(a,b,c){return this.optional(b)||a>=c[0]&&a<=c[1]},equalTo:function(b,c,d){var e=a(d);return this.settings.onfocusout&&e.unbind(".validate-equalTo").bind("blur.validate-equalTo",function(){a(c).valid()}),b===e.val()},remote:function(b,c,d){if(this.optional(c))return"dependency-mismatch";var e,f,g=this.previousValue(c);return this.settings.messages[c.name]||(this.settings.messages[c.name]={}),g.originalMessage=this.settings.messages[c.name].remote,this.settings.messages[c.name].remote=g.message,d="string"==typeof d&&{url:d}||d,g.old===b?g.valid:(g.old=b,e=this,this.startRequest(c),f={},f[c.name]=b,a.ajax(a.extend(!0,{url:d,mode:"abort",port:"validate"+c.name,dataType:"json",data:f,context:e.currentForm,success:function(d){var f,h,i,j=d===!0||"true"===d;e.settings.messages[c.name].remote=g.originalMessage,j?(i=e.formSubmitted,e.prepareElement(c),e.formSubmitted=i,e.successList.push(c),delete e.invalid[c.name],e.showErrors()):(f={},h=d||e.defaultMessage(c,"remote"),f[c.name]=g.message=a.isFunction(h)?h(b):h,e.invalid[c.name]=!0,e.showErrors(f)),g.valid=j,e.stopRequest(c,j)}},d)),"pending")}}}),a.format=function(){throw"$.format has been deprecated. Please use $.validator.format instead."}}(jQuery),function(a){var b,c={};a.ajaxPrefilter?a.ajaxPrefilter(function(a,b,d){var e=a.port;"abort"===a.mode&&(c[e]&&c[e].abort(),c[e]=d)}):(b=a.ajax,a.ajax=function(d){var e=("mode"in d?d:a.ajaxSettings).mode,f=("port"in d?d:a.ajaxSettings).port;return"abort"===e?(c[f]&&c[f].abort(),c[f]=b.apply(this,arguments),c[f]):b.apply(this,arguments)})}(jQuery),function(a){a.extend(a.fn,{validateDelegate:function(b,c,d){return this.bind(c,function(c){var e=a(c.target);return e.is(b)?d.apply(e,arguments):void 0})}})}(jQuery);;
/* END /DuttiNEWStorefrontAssetStore/js/lib/jquery.validate.min.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/jquery.form.js (en_US) */
/*!
 * jQuery Form Plugin
 * version: 2.82 (15-JUN-2011)
 * @requires jQuery v1.3.2 or later
 *
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
;(function($) {

    /*
     Usage Note:
     -----------
     Do not use both ajaxSubmit and ajaxForm on the same form.  These
     functions are intended to be exclusive.  Use ajaxSubmit if you want
     to bind your own submit handler to the form.  For example,

     $(document).ready(function() {
     $('#myForm').bind('submit', function(e) {
     e.preventDefault(); // <-- important
     $(this).ajaxSubmit({
     target: '#output'
     });
     });
     });

     Use ajaxForm when you want the plugin to manage all the event binding
     for you.  For example,

     $(document).ready(function() {
     $('#myForm').ajaxForm({
     target: '#output'
     });
     });

     When using ajaxForm, the ajaxSubmit function will be invoked for you
     at the appropriate time.
     */

    /**
     * ajaxSubmit() provides a mechanism for immediately submitting
     * an HTML form using AJAX.
     */
    $.fn.ajaxSubmit = function(options) {
        // fast fail if nothing selected (http://dev.jquery.com/ticket/2752)
        if (!this.length) {
            log('ajaxSubmit: skipping submit process - no element selected');
            return this;
        }

        var method, action, url, $form = this;;

        if (typeof options == 'function') {
            options = { success: options };
        }

        method = this.attr('method');
        action = this.attr('action');
        url = (typeof action === 'string') ? $.trim(action) : '';
        url = url || window.location.href || '';
        if (url) {
            // clean url (don't include hash vaue)
            url = (url.match(/^([^#]+)/)||[])[1];
        }

        options = $.extend(true, {
            url:  url,
            success: $.ajaxSettings.success,
            type: method || 'GET',
            iframeSrc: /^https/i.test(window.location.href || '') ? 'javascript:false' : 'about:blank'
        }, options);

        // hook for manipulating the form data before it is extracted;
        // convenient for use with rich editors like tinyMCE or FCKEditor
        var veto = {};
        this.trigger('form-pre-serialize', [this, options, veto]);
        if (veto.veto) {
            log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');
            return this;
        }

        // provide opportunity to alter form data before it is serialized
        if (options.beforeSerialize && options.beforeSerialize(this, options) === false) {
            log('ajaxSubmit: submit aborted via beforeSerialize callback');
            return this;
        }

        var n,v,a = this.formToArray(options.semantic);
        if (options.data) {
            options.extraData = options.data;
            for (n in options.data) {
                if(options.data[n] instanceof Array) {
                    for (var k in options.data[n]) {
                        a.push( { name: n, value: options.data[n][k] } );
                    }
                }
                else {
                    v = options.data[n];
                    v = $.isFunction(v) ? v() : v; // if value is fn, invoke it
                    a.push( { name: n, value: v } );
                }
            }
        }

        // give pre-submit callback an opportunity to abort the submit
        if (options.beforeSubmit && options.beforeSubmit(a, this, options) === false) {
            log('ajaxSubmit: submit aborted via beforeSubmit callback');
            return this;
        }

        // fire vetoable 'validate' event
        this.trigger('form-submit-validate', [a, this, options, veto]);
        if (veto.veto) {
            log('ajaxSubmit: submit vetoed via form-submit-validate trigger');
            return this;
        }

        var q = $.param(a);

        if (options.type.toUpperCase() == 'GET') {
            options.url += (options.url.indexOf('?') >= 0 ? '&' : '?') + q;
            options.data = null;  // data is null for 'get'
        }
        else {
            options.data = q; // data is the query string for 'post'
        }

        var callbacks = [];
        if (options.resetForm) {
            callbacks.push(function() { $form.resetForm(); });
        }
        if (options.clearForm) {
            callbacks.push(function() { $form.clearForm(); });
        }

        // perform a load on the target only if dataType is not provided
        if (!options.dataType && options.target) {
            var oldSuccess = options.success || function(){};
            callbacks.push(function(data) {
                var fn = options.replaceTarget ? 'replaceWith' : 'html';
                $(options.target)[fn](data).each(oldSuccess, arguments);
            });
        }
        else if (options.success) {
            callbacks.push(options.success);
        }

        options.success = function(data, status, xhr) { // jQuery 1.4+ passes xhr as 3rd arg
            var context = options.context || options;   // jQuery 1.4+ supports scope context 
            for (var i=0, max=callbacks.length; i < max; i++) {
                callbacks[i].apply(context, [data, status, xhr || $form, $form]);
            }
        };

        // are there files to upload?
        var fileInputs = $('input:file', this).length > 0;
        var mp = 'multipart/form-data';
        var multipart = ($form.attr('enctype') == mp || $form.attr('encoding') == mp);

        // options.iframe allows user to force iframe mode
        // 06-NOV-09: now defaulting to iframe mode if file input is detected
        if (options.iframe !== false && (fileInputs || options.iframe || multipart)) {
            // hack to fix Safari hang (thanks to Tim Molendijk for this)
            // see:  http://groups.google.com/group/jquery-dev/browse_thread/thread/36395b7ab510dd5d
            if (options.closeKeepAlive) {
                $.get(options.closeKeepAlive, function() { fileUpload(a); });
            }
            else {
                fileUpload(a);
            }
        }
        else {
            // IE7 massage (see issue 57)
            if ($.browser.msie && method == 'get') {
                var ieMeth = $form[0].getAttribute('method');
                if (typeof ieMeth === 'string')
                    options.type = ieMeth;
            }
            $.ajax(options);
        }

        // fire 'notify' event
        this.trigger('form-submit-notify', [this, options]);
        return this;


        // private function for handling file uploads (hat tip to YAHOO!)
        function fileUpload(a) {
            var form = $form[0], i, s, g, id, $io, io, xhr, sub, n, timedOut, timeoutHandle;

            if (a) {
                // ensure that every serialized input is still enabled
                for (i=0; i < a.length; i++) {
                    $(form[a[i].name]).attr('disabled', false);
                }
            }

            if ($(':input[name=submit],:input[id=submit]', form).length) {
                // if there is an input with a name or id of 'submit' then we won't be
                // able to invoke the submit fn on the form (at least not x-browser)
                //alert('Error: Form elements must not have name or id of "submit".');
                return;
            }

            s = $.extend(true, {}, $.ajaxSettings, options);
            s.context = s.context || s;
            id = 'jqFormIO' + (new Date().getTime());
            if (s.iframeTarget) {
                $io = $(s.iframeTarget);
                n = $io.attr('name');
                if (n == null)
                    $io.attr('name', id);
                else
                    id = n;
            }
            else {
                $io = $('<iframe name="' + id + '" src="'+ s.iframeSrc +'" />');
                $io.css({ position: 'absolute', top: '-1000px', left: '-1000px' });
            }
            io = $io[0];


            xhr = { // mock object
                aborted: 0,
                responseText: null,
                responseXML: null,
                status: 0,
                statusText: 'n/a',
                getAllResponseHeaders: function() {},
                getResponseHeader: function() {},
                setRequestHeader: function() {},
                abort: function(status) {
                    var e = (status === 'timeout' ? 'timeout' : 'aborted');
                    log('aborting upload... ' + e);
                    this.aborted = 1;
                    $io.attr('src', s.iframeSrc); // abort op in progress
                    xhr.error = e;
                    s.error && s.error.call(s.context, xhr, e, status);
                    g && $.event.trigger("ajaxError", [xhr, s, e]);
                    s.complete && s.complete.call(s.context, xhr, e);
                }
            };

            g = s.global;
            // trigger ajax global events so that activity/block indicators work like normal
            if (g && ! $.active++) {
                $.event.trigger("ajaxStart");
            }
            if (g) {
                $.event.trigger("ajaxSend", [xhr, s]);
            }

            if (s.beforeSend && s.beforeSend.call(s.context, xhr, s) === false) {
                if (s.global) {
                    $.active--;
                }
                return;
            }
            if (xhr.aborted) {
                return;
            }

            // add submitting element to data if we know it
            sub = form.clk;
            if (sub) {
                n = sub.name;
                if (n && !sub.disabled) {
                    s.extraData = s.extraData || {};
                    s.extraData[n] = sub.value;
                    if (sub.type == "image") {
                        s.extraData[n+'.x'] = form.clk_x;
                        s.extraData[n+'.y'] = form.clk_y;
                    }
                }
            }

            var CLIENT_TIMEOUT_ABORT = 1;
            var SERVER_ABORT = 2;

            function getDoc(frame) {
                var doc = frame.contentWindow ? frame.contentWindow.document : frame.contentDocument ? frame.contentDocument : frame.document;
                return doc;
            }

            // take a breath so that pending repaints get some cpu time before the upload starts
            function doSubmit() {
                // make sure form attrs are set
                var t = $form.attr('target'), a = $form.attr('action');

                // update form attrs in IE friendly way
                form.setAttribute('target',id);
                if (!method) {
                    form.setAttribute('method', 'POST');
                }
                if (a != s.url) {
                    form.setAttribute('action', s.url);
                }

                // ie borks in some cases when setting encoding
                if (! s.skipEncodingOverride && (!method || /post/i.test(method))) {
                    $form.attr({
                        encoding: 'multipart/form-data',
                        enctype:  'multipart/form-data'
                    });
                }

                // support timout
                if (s.timeout) {
                    timeoutHandle = setTimeout(function() { timedOut = true; cb(CLIENT_TIMEOUT_ABORT); }, s.timeout);
                }

                // look for server aborts
                function checkState() {
                    try {
                        var state = getDoc(io).readyState;
                        log('state = ' + state);
                        if (state.toLowerCase() == 'uninitialized')
                            setTimeout(checkState,50);
                    }
                    catch(e) {
                        log('Server abort: ' , e, ' (', e.name, ')');
                        cb(SERVER_ABORT);
                        timeoutHandle && clearTimeout(timeoutHandle);
                        timeoutHandle = undefined;
                    }
                }

                // add "extra" data to form if provided in options
                var extraInputs = [];
                try {
                    if (s.extraData) {
                        for (var n in s.extraData) {
                            extraInputs.push(
                                $('<input type="hidden" name="'+n+'" />').attr('value',s.extraData[n])
                                    .appendTo(form)[0]);
                        }
                    }

                    if (!s.iframeTarget) {
                        // add iframe to doc and submit the form
                        $io.appendTo('body');
                        io.attachEvent ? io.attachEvent('onload', cb) : io.addEventListener('load', cb, false);
                    }
                    setTimeout(checkState,15);
                    form.submit();
                }
                finally {
                    // reset attrs and remove "extra" input elements
                    form.setAttribute('action',a);
                    if(t) {
                        form.setAttribute('target', t);
                    } else {
                        $form.removeAttr('target');
                    }
                    $(extraInputs).remove();
                }
            }

            if (s.forceSync) {
                doSubmit();
            }
            else {
                setTimeout(doSubmit, 10); // this lets dom updates render
            }

            var data, doc, domCheckCount = 50, callbackProcessed;

            function cb(e) {
                if (xhr.aborted || callbackProcessed) {
                    return;
                }
                try {
                    doc = getDoc(io);
                }
                catch(ex) {
                    log('cannot access response document: ', ex);
                    e = SERVER_ABORT;
                }
                if (e === CLIENT_TIMEOUT_ABORT && xhr) {
                    xhr.abort('timeout');
                    return;
                }
                else if (e == SERVER_ABORT && xhr) {
                    xhr.abort('server abort');
                    return;
                }

                if (!doc || doc.location.href == s.iframeSrc) {
                    // response not received yet
                    if (!timedOut)
                        return;
                }
                io.detachEvent ? io.detachEvent('onload', cb) : io.removeEventListener('load', cb, false);

                var status = 'success', errMsg;
                try {
                    if (timedOut) {
                        throw 'timeout';
                    }

                    var isXml = s.dataType == 'xml' || doc.XMLDocument || $.isXMLDoc(doc);
                    log('isXml='+isXml);
                    if (!isXml && window.opera && (doc.body == null || doc.body.innerHTML == '')) {
                        if (--domCheckCount) {
                            // in some browsers (Opera) the iframe DOM is not always traversable when
                            // the onload callback fires, so we loop a bit to accommodate
                            log('requeing onLoad callback, DOM not available');
                            setTimeout(cb, 250);
                            return;
                        }
                        // let this fall through because server response could be an empty document
                        //log('Could not access iframe DOM after mutiple tries.');
                        //throw 'DOMException: not available';
                    }

                    //log('response detected');
                    var docRoot = doc.body ? doc.body : doc.documentElement;
                    xhr.responseText = docRoot ? docRoot.innerHTML : null;
                    xhr.responseXML = doc.XMLDocument ? doc.XMLDocument : doc;
                    if (isXml)
                        s.dataType = 'xml';
                    xhr.getResponseHeader = function(header){
                        var headers = {'content-type': s.dataType};
                        return headers[header];
                    };
                    // support for XHR 'status' & 'statusText' emulation :
                    if (docRoot) {
                        xhr.status = Number( docRoot.getAttribute('status') ) || xhr.status;
                        xhr.statusText = docRoot.getAttribute('statusText') || xhr.statusText;
                    }

                    var dt = s.dataType || '';
                    var scr = /(json|script|text)/.test(dt.toLowerCase());
                    if (scr || s.textarea) {
                        // see if user embedded response in textarea
                        var ta = doc.getElementsByTagName('textarea')[0];
                        if (ta) {
                            xhr.responseText = ta.value;
                            // support for XHR 'status' & 'statusText' emulation :
                            xhr.status = Number( ta.getAttribute('status') ) || xhr.status;
                            xhr.statusText = ta.getAttribute('statusText') || xhr.statusText;
                        }
                        else if (scr) {
                            // account for browsers injecting pre around json response
                            var pre = doc.getElementsByTagName('pre')[0];
                            var b = doc.getElementsByTagName('body')[0];
                            if (pre) {
                                xhr.responseText = pre.textContent ? pre.textContent : pre.innerHTML;
                            }
                            else if (b) {
                                xhr.responseText = b.innerHTML;
                            }
                        }
                    }
                    else if (s.dataType == 'xml' && !xhr.responseXML && xhr.responseText != null) {
                        xhr.responseXML = toXml(xhr.responseText);
                    }

                    try {
                        data = httpData(xhr, s.dataType, s);
                    }
                    catch (e) {
                        status = 'parsererror';
                        xhr.error = errMsg = (e || status);
                    }
                }
                catch (e) {
                    log('error caught: ',e);
                    status = 'error';
                    xhr.error = errMsg = (e || status);
                }

                if (xhr.aborted) {
                    log('upload aborted');
                    status = null;
                }

                if (xhr.status) { // we've set xhr.status
                    status = (xhr.status >= 200 && xhr.status < 300 || xhr.status === 304) ? 'success' : 'error';
                }

                // ordering of these callbacks/triggers is odd, but that's how $.ajax does it
                if (status === 'success') {
                    s.success && s.success.call(s.context, data, 'success', xhr);
                    g && $.event.trigger("ajaxSuccess", [xhr, s]);
                }
                else if (status) {
                    if (errMsg == undefined)
                        errMsg = xhr.statusText;
                    s.error && s.error.call(s.context, xhr, status, errMsg);
                    g && $.event.trigger("ajaxError", [xhr, s, errMsg]);
                }

                g && $.event.trigger("ajaxComplete", [xhr, s]);

                if (g && ! --$.active) {
                    $.event.trigger("ajaxStop");
                }

                s.complete && s.complete.call(s.context, xhr, status);

                callbackProcessed = true;
                if (s.timeout)
                    clearTimeout(timeoutHandle);

                // clean up
                setTimeout(function() {
                    if (!s.iframeTarget)
                        $io.remove();
                    xhr.responseXML = null;
                }, 100);
            }

            var toXml = $.parseXML || function(s, doc) { // use parseXML if available (jQuery 1.5+)
                    if (window.ActiveXObject) {
                        doc = new ActiveXObject('Microsoft.XMLDOM');
                        doc.async = 'false';
                        doc.loadXML(s);
                    }
                    else {
                        doc = (new DOMParser()).parseFromString(s, 'text/xml');
                    }
                    return (doc && doc.documentElement && doc.documentElement.nodeName != 'parsererror') ? doc : null;
                };
            var parseJSON = $.parseJSON || function(s) {
                    return window['eval']('(' + s + ')');
                };

            var httpData = function( xhr, type, s ) { // mostly lifted from jq1.4.4

                var ct = xhr.getResponseHeader('content-type') || '',
                    xml = type === 'xml' || !type && ct.indexOf('xml') >= 0,
                    data = xml ? xhr.responseXML : xhr.responseText;

                if (xml && data.documentElement.nodeName === 'parsererror') {
                    $.error && $.error('parsererror');
                }
                if (s && s.dataFilter) {
                    data = s.dataFilter(data, type);
                }
                if (typeof data === 'string') {
                    if (type === 'json' || !type && ct.indexOf('json') >= 0) {
                        data = parseJSON(data);
                    } else if (type === "script" || !type && ct.indexOf("javascript") >= 0) {
                        $.globalEval(data);
                    }
                }
                return data;
            };
        }
    };

    /**
     * ajaxForm() provides a mechanism for fully automating form submission.
     *
     * The advantages of using this method instead of ajaxSubmit() are:
     *
     * 1: This method will include coordinates for <input type="image" /> elements (if the element
     *	is used to submit the form).
     * 2. This method will include the submit element's name/value data (for the element that was
     *	used to submit the form).
     * 3. This method binds the submit() method to the form for you.
     *
     * The options argument for ajaxForm works exactly as it does for ajaxSubmit.  ajaxForm merely
     * passes the options argument along after properly binding events for submit elements and
     * the form itself.
     */
    $.fn.ajaxForm = function(options) {
        // in jQuery 1.3+ we can fix mistakes with the ready state
        if (this.length === 0) {
            var o = { s: this.selector, c: this.context };
            if (!$.isReady && o.s) {
                log('DOM not ready, queuing ajaxForm');
                $(function() {
                    $(o.s,o.c).ajaxForm(options);
                });
                return this;
            }
            // is your DOM ready?  http://docs.jquery.com/Tutorials:Introducing_$(document).ready()
            log('terminating; zero elements found by selector' + ($.isReady ? '' : ' (DOM not ready)'));
            return this;
        }

        return this.ajaxFormUnbind().bind('submit.form-plugin', function(e) {
            if (!e.isDefaultPrevented()) { // if event has been canceled, don't proceed
                e.preventDefault();
                $(this).ajaxSubmit(options);
            }
        }).bind('click.form-plugin', function(e) {
            var target = e.target;
            var $el = $(target);
            if (!($el.is(":submit,input:image"))) {
                // is this a child element of the submit el?  (ex: a span within a button)
                var t = $el.closest(':submit');
                if (t.length == 0) {
                    return;
                }
                target = t[0];
            }
            var form = this;
            form.clk = target;
            if (target.type == 'image') {
                if (e.offsetX != undefined) {
                    form.clk_x = e.offsetX;
                    form.clk_y = e.offsetY;
                } else if (typeof $.fn.offset == 'function') { // try to use dimensions plugin
                    var offset = $el.offset();
                    form.clk_x = e.pageX - offset.left;
                    form.clk_y = e.pageY - offset.top;
                } else {
                    form.clk_x = e.pageX - target.offsetLeft;
                    form.clk_y = e.pageY - target.offsetTop;
                }
            }
            // clear form vars
            setTimeout(function() { form.clk = form.clk_x = form.clk_y = null; }, 100);
        });
    };

// ajaxFormUnbind unbinds the event handlers that were bound by ajaxForm
    $.fn.ajaxFormUnbind = function() {
        return this.unbind('submit.form-plugin click.form-plugin');
    };

    /**
     * formToArray() gathers form element data into an array of objects that can
     * be passed to any of the following ajax functions: $.get, $.post, or load.
     * Each object in the array has both a 'name' and 'value' property.  An example of
     * an array for a simple login form might be:
     *
     * [ { name: 'username', value: 'jresig' }, { name: 'password', value: 'secret' } ]
     *
     * It is this array that is passed to pre-submit callback functions provided to the
     * ajaxSubmit() and ajaxForm() methods.
     */
    $.fn.formToArray = function(semantic) {
        var a = [];
        if (this.length === 0) {
            return a;
        }

        var form = this[0];
        var els = semantic ? form.getElementsByTagName('*') : form.elements;
        if (!els) {
            return a;
        }

        var i,j,n,v,el,max,jmax;
        for(i=0, max=els.length; i < max; i++) {
            el = els[i];
            n = el.name;
            if (!n) {
                continue;
            }

            if (semantic && form.clk && el.type == "image") {
                // handle image inputs on the fly when semantic == true
                if(!el.disabled && form.clk == el) {
                    a.push({name: n, value: $(el).val()});
                    a.push({name: n+'.x', value: form.clk_x}, {name: n+'.y', value: form.clk_y});
                }
                continue;
            }

            v = $.fieldValue(el, true);
            if (v && v.constructor == Array) {
                for(j=0, jmax=v.length; j < jmax; j++) {
                    a.push({name: n, value: v[j]});
                }
            }
            else if (v !== null && typeof v != 'undefined') {
                a.push({name: n, value: v});
            }
        }

        if (!semantic && form.clk) {
            // input type=='image' are not found in elements array! handle it here
            var $input = $(form.clk), input = $input[0];
            n = input.name;
            if (n && !input.disabled && input.type == 'image') {
                a.push({name: n, value: $input.val()});
                a.push({name: n+'.x', value: form.clk_x}, {name: n+'.y', value: form.clk_y});
            }
        }
        return a;
    };

    /**
     * Serializes form data into a 'submittable' string. This method will return a string
     * in the format: name1=value1&amp;name2=value2
     */
    $.fn.formSerialize = function(semantic) {
        //hand off to jQuery.param for proper encoding
        return $.param(this.formToArray(semantic));
    };

    /**
     * Serializes all field elements in the jQuery object into a query string.
     * This method will return a string in the format: name1=value1&amp;name2=value2
     */
    $.fn.fieldSerialize = function(successful) {
        var a = [];
        this.each(function() {
            var n = this.name;
            if (!n) {
                return;
            }
            var v = $.fieldValue(this, successful);
            if (v && v.constructor == Array) {
                for (var i=0,max=v.length; i < max; i++) {
                    a.push({name: n, value: v[i]});
                }
            }
            else if (v !== null && typeof v != 'undefined') {
                a.push({name: this.name, value: v});
            }
        });
        //hand off to jQuery.param for proper encoding
        return $.param(a);
    };

    /**
     * Returns the value(s) of the element in the matched set.  For example, consider the following form:
     *
     *  <form><fieldset>
     *	  <input name="A" type="text" />
     *	  <input name="A" type="text" />
     *	  <input name="B" type="checkbox" value="B1" />
     *	  <input name="B" type="checkbox" value="B2"/>
     *	  <input name="C" type="radio" value="C1" />
     *	  <input name="C" type="radio" value="C2" />
     *  </fieldset></form>
     *
     *  var v = $(':text').fieldValue();
     *  // if no values are entered into the text inputs
     *  v == ['','']
     *  // if values entered into the text inputs are 'foo' and 'bar'
     *  v == ['foo','bar']
     *
     *  var v = $(':checkbox').fieldValue();
     *  // if neither checkbox is checked
     *  v === undefined
     *  // if both checkboxes are checked
     *  v == ['B1', 'B2']
     *
     *  var v = $(':radio').fieldValue();
     *  // if neither radio is checked
     *  v === undefined
     *  // if first radio is checked
     *  v == ['C1']
     *
     * The successful argument controls whether or not the field element must be 'successful'
     * (per http://www.w3.org/TR/html4/interact/forms.html#successful-controls).
     * The default value of the successful argument is true.  If this value is false the value(s)
     * for each element is returned.
     *
     * Note: This method *always* returns an array.  If no valid value can be determined the
     *	   array will be empty, otherwise it will contain one or more values.
     */
    $.fn.fieldValue = function(successful) {
        for (var val=[], i=0, max=this.length; i < max; i++) {
            var el = this[i];
            var v = $.fieldValue(el, successful);
            if (v === null || typeof v == 'undefined' || (v.constructor == Array && !v.length)) {
                continue;
            }
            v.constructor == Array ? $.merge(val, v) : val.push(v);
        }
        return val;
    };

    /**
     * Returns the value of the field element.
     */
    $.fieldValue = function(el, successful) {
        var n = el.name, t = el.type, tag = el.tagName.toLowerCase();
        if (successful === undefined) {
            successful = true;
        }

        if (successful && (!n || el.disabled || t == 'reset' || t == 'button' ||
            (t == 'checkbox' || t == 'radio') && !el.checked ||
            (t == 'submit' || t == 'image') && el.form && el.form.clk != el ||
            tag == 'select' && el.selectedIndex == -1)) {
            return null;
        }

        if (tag == 'select') {
            var index = el.selectedIndex;
            if (index < 0) {
                return null;
            }
            var a = [], ops = el.options;
            var one = (t == 'select-one');
            var max = (one ? index+1 : ops.length);
            for(var i=(one ? index : 0); i < max; i++) {
                var op = ops[i];
                if (op.selected) {
                    var v = op.value;
                    if (!v) { // extra pain for IE...
                        v = (op.attributes && op.attributes['value'] && !(op.attributes['value'].specified)) ? op.text : op.value;
                    }
                    if (one) {
                        return v;
                    }
                    a.push(v);
                }
            }
            return a;
        }
        return $(el).val();
    };

    /**
     * Clears the form data.  Takes the following actions on the form's input fields:
     *  - input text fields will have their 'value' property set to the empty string
     *  - select elements will have their 'selectedIndex' property set to -1
     *  - checkbox and radio inputs will have their 'checked' property set to false
     *  - inputs of type submit, button, reset, and hidden will *not* be effected
     *  - button elements will *not* be effected
     */
    $.fn.clearForm = function() {
        return this.each(function() {
            $('input,select,textarea', this).clearFields();
        });
    };

    /**
     * Clears the selected form elements.
     */
    $.fn.clearFields = $.fn.clearInputs = function() {
        var re = /^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i; // 'hidden' is not in this list
        return this.each(function() {
            var t = this.type, tag = this.tagName.toLowerCase();
            if (re.test(t) || tag == 'textarea') {
                this.value = '';
            }
            else if (t == 'checkbox' || t == 'radio') {
                this.checked = false;
            }
            else if (tag == 'select') {
                this.selectedIndex = -1;
            }
        });
    };

    /**
     * Resets the form data.  Causes all form elements to be reset to their original value.
     */
    $.fn.resetForm = function() {
        return this.each(function() {
            // guard against an input with the name of 'reset'
            // note that IE reports the reset function as an 'object'
            if (typeof this.reset == 'function' || (typeof this.reset == 'object' && !this.reset.nodeType)) {
                this.reset();
            }
        });
    };

    /**
     * Enables or disables any matching elements.
     */
    $.fn.enable = function(b) {
        if (b === undefined) {
            b = true;
        }
        return this.each(function() {
            this.disabled = !b;
        });
    };

    /**
     * Checks/unchecks any matching checkboxes or radio buttons and
     * selects/deselects and matching option elements.
     */
    $.fn.selected = function(select) {
        if (select === undefined) {
            select = true;
        }
        return this.each(function() {
            var t = this.type;
            if (t == 'checkbox' || t == 'radio') {
                this.checked = select;
            }
            else if (this.tagName.toLowerCase() == 'option') {
                var $sel = $(this).parent('select');
                if (select && $sel[0] && $sel[0].type == 'select-one') {
                    // deselect all other options
                    $sel.find('option').selected(false);
                }
                this.selected = select;
            }
        });
    };

// helper fn for console logging
    function log() {

    };

})(jQuery);
;
/* END /DuttiNEWStorefrontAssetStore/js/lib/jquery.form.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/json2.js (en_US) */
/*
 json2.js
 2011-10-19

 Public Domain.

 NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.

 See http://www.JSON.org/js.html


 This code should be minified before deployment.
 See http://javascript.crockford.com/jsmin.html

 USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO
 NOT CONTROL.


 This file creates a global JSON object containing two methods: stringify
 and parse.

 JSON.stringify(value, replacer, space)
 value any JavaScript value, usually an object or array.

 replacer an optional parameter that determines how object
 values are stringified for objects. It can be a
 function or an array of strings.

 space an optional parameter that specifies the indentation
 of nested structures. If it is omitted, the text will
 be packed without extra whitespace. If it is a number,
 it will specify the number of spaces to indent at each
 level. If it is a string (such as '\t' or '&nbsp;'),
 it contains the characters used to indent at each level.

 This method produces a JSON text from a JavaScript value.

 When an object value is found, if the object contains a toJSON
 method, its toJSON method will be called and the result will be
 stringified. A toJSON method does not serialize: it returns the
 value represented by the name/value pair that should be serialized,
 or undefined if nothing should be serialized. The toJSON method
 will be passed the key associated with the value, and this will be
 bound to the value

 For example, this would serialize Dates as ISO strings.

 Date.prototype.toJSON = function (key) {
 function f(n) {
 // Format integers to have at least two digits.
 return n < 10 ? '0' + n : n;
 }

 return this.getUTCFullYear() + '-' +
 f(this.getUTCMonth() + 1) + '-' +
 f(this.getUTCDate()) + 'T' +
 f(this.getUTCHours()) + ':' +
 f(this.getUTCMinutes()) + ':' +
 f(this.getUTCSeconds()) + 'Z';
 };

 You can provide an optional replacer method. It will be passed the
 key and value of each member, with this bound to the containing
 object. The value that is returned from your method will be
 serialized. If your method returns undefined, then the member will
 be excluded from the serialization.

 If the replacer parameter is an array of strings, then it will be
 used to select the members to be serialized. It filters the results
 such that only members with keys listed in the replacer array are
 stringified.

 Values that do not have JSON representations, such as undefined or
 functions, will not be serialized. Such values in objects will be
 dropped; in arrays they will be replaced with null. You can use
 a replacer function to replace those with JSON values.
 JSON.stringify(undefined) returns undefined.

 The optional space parameter produces a stringification of the
 value that is filled with line breaks and indentation to make it
 easier to read.

 If the space parameter is a non-empty string, then that string will
 be used for indentation. If the space parameter is a number, then
 the indentation will be that many spaces.

 Example:

 text = JSON.stringify(['e', {pluribus: 'unum'}]);
 // text is '["e",{"pluribus":"unum"}]'


 text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');
 // text is '[\n\t"e",\n\t{\n\t\t"pluribus": "unum"\n\t}\n]'

 text = JSON.stringify([new Date()], function (key, value) {
 return this[key] instanceof Date ?
 'Date(' + this[key] + ')' : value;
 });
 // text is '["Date(---current time---)"]'


 JSON.parse(text, reviver)
 This method parses a JSON text to produce an object or array.
 It can throw a SyntaxError exception.

 The optional reviver parameter is a function that can filter and
 transform the results. It receives each of the keys and values,
 and its return value is used instead of the original value.
 If it returns what it received, then the structure is not modified.
 If it returns undefined then the member is deleted.

 Example:

 // Parse the text. Values that look like ISO date strings will
 // be converted to Date objects.

 myData = JSON.parse(text, function (key, value) {
 var a;
 if (typeof value === 'string') {
 a =
 /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
 if (a) {
 return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],
 +a[5], +a[6]));
 }
 }
 return value;
 });

 myData = JSON.parse('["Date(09/09/2001)"]', function (key, value) {
 var d;
 if (typeof value === 'string' &&
 value.slice(0, 5) === 'Date(' &&
 value.slice(-1) === ')') {
 d = new Date(value.slice(5, -1));
 if (d) {
 return d;
 }
 }
 return value;
 });


 This is a reference implementation. You are free to copy, modify, or
 redistribute.
 */

/*jslint evil: true, regexp: true */

/*members "", "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
 call, charCodeAt, getUTCDate, getUTCFullYear, getUTCHours,
 getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join,
 lastIndex, length, parse, prototype, push, replace, slice, stringify,
 test, toJSON, toString, valueOf
 */


// Create a JSON object only if one does not already exist. We create the
// methods in a closure to avoid creating global variables.

var JSON;
if (!JSON) {
    JSON = {};
}

(function () {
    'use strict';

    function f(n) {
        // Format integers to have at least two digits.
        return n < 10 ? '0' + n : n;
    }

    if (typeof Date.prototype.toJSON !== 'function') {

        Date.prototype.toJSON = function (key) {

            return isFinite(this.valueOf())
                ? this.getUTCFullYear() + '-' +
            f(this.getUTCMonth() + 1) + '-' +
            f(this.getUTCDate()) + 'T' +
            f(this.getUTCHours()) + ':' +
            f(this.getUTCMinutes()) + ':' +
            f(this.getUTCSeconds()) + 'Z'
                : null;
        };

        String.prototype.toJSON =
            Number.prototype.toJSON =
                Boolean.prototype.toJSON = function (key) {
                    return this.valueOf();
                };
    }

    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap,
        indent,
        meta = { // table of character substitutions
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"' : '\\"',
            '\\': '\\\\'
        },
        rep;


    function quote(string) {

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe escape
// sequences.

        escapable.lastIndex = 0;
        return escapable.test(string) ? '"' + string.replace(escapable, function (a) {
            var c = meta[a];
            return typeof c === 'string'
                ? c
                : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + '"' : '"' + string + '"';
    }


    function str(key, holder) {

// Produce a string from holder[key].

        var i, // The loop counter.
            k, // The member key.
            v, // The member value.
            length,
            mind = gap,
            partial,
            value = holder[key];

// If the value has a toJSON method, call it to obtain a replacement value.

        if (value && typeof value === 'object' &&
            typeof value.toJSON === 'function') {
            value = value.toJSON(key);
        }

// If we were called with a replacer function, then call the replacer to
// obtain a replacement value.

        if (typeof rep === 'function') {
            value = rep.call(holder, key, value);
        }

// What happens next depends on the value's type.

        switch (typeof value) {
            case 'string':
                return quote(value);

            case 'number':

// JSON numbers must be finite. Encode non-finite numbers as null.

                return isFinite(value) ? String(value) : 'null';

            case 'boolean':
            case 'null':

// If the value is a boolean or null, convert it to a string. Note:
// typeof null does not produce 'null'. The case is included here in
// the remote chance that this gets fixed someday.

                return String(value);

// If the type is 'object', we might be dealing with an object or an array or
// null.

            case 'object':

// Due to a specification blunder in ECMAScript, typeof null is 'object',
// so watch out for that case.

                if (!value) {
                    return 'null';
                }

// Make an array to hold the partial results of stringifying this object value.

                gap += indent;
                partial = [];

// Is the value an array?

                if (Object.prototype.toString.apply(value) === '[object Array]') {

// The value is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                    length = value.length;
                    for (i = 0; i < length; i += 1) {
                        partial[i] = str(i, value) || 'null';
                    }

// Join all of the elements together, separated with commas, and wrap them in
// brackets.

                    v = partial.length === 0
                        ? '[]'
                        : gap
                        ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']'
                        : '[' + partial.join(',') + ']';
                    gap = mind;
                    return v;
                }

// If the replacer is an array, use it to select the members to be stringified.

                if (rep && typeof rep === 'object') {
                    length = rep.length;
                    for (i = 0; i < length; i += 1) {
                        if (typeof rep[i] === 'string') {
                            k = rep[i];
                            v = str(k, value);
                            if (v) {
                                partial.push(quote(k) + (gap ? ': ' : ':') + v);
                            }
                        }
                    }
                } else {

// Otherwise, iterate through all of the keys in the object.

                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = str(k, value);
                            if (v) {
                                partial.push(quote(k) + (gap ? ': ' : ':') + v);
                            }
                        }
                    }
                }

// Join all of the member texts together, separated with commas,
// and wrap them in braces.

                v = partial.length === 0
                    ? '{}'
                    : gap
                    ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}'
                    : '{' + partial.join(',') + '}';
                gap = mind;
                return v;
        }
    }

// If the JSON object does not yet have a stringify method, give it one.

    if (typeof JSON.stringify !== 'function') {
        JSON.stringify = function (value, replacer, space) {

// The stringify method takes a value and an optional replacer, and an optional
// space parameter, and returns a JSON text. The replacer can be a function
// that can replace values, or an array of strings that will select the keys.
// A default replacer method can be provided. Use of the space parameter can
// produce text that is more easily readable.

            var i;
            gap = '';
            indent = '';

// If the space parameter is a number, make an indent string containing that
// many spaces.

            if (typeof space === 'number') {
                for (i = 0; i < space; i += 1) {
                    indent += ' ';
                }

// If the space parameter is a string, it will be used as the indent string.

            } else if (typeof space === 'string') {
                indent = space;
            }

// If there is a replacer, it must be a function or an array.
// Otherwise, throw an error.

            rep = replacer;
            if (replacer && typeof replacer !== 'function' &&
                (typeof replacer !== 'object' ||
                typeof replacer.length !== 'number')) {
                throw new Error('JSON.stringify');
            }

// Make a fake root object containing our value under the key of ''.
// Return the result of stringifying the value.

            return str('', {'': value});
        };
    }


// If the JSON object does not yet have a parse method, give it one.

    if (typeof JSON.parse !== 'function') {
        JSON.parse = function (text, reviver) {

// The parse method takes a text and an optional reviver function, and returns
// a JavaScript value if the text is a valid JSON text.

            var j;

            function walk(holder, key) {

// The walk method is used to recursively walk the resulting structure so
// that modifications can be made.

                var k, v, value = holder[key];
                if (value && typeof value === 'object') {
                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = walk(value, k);
                            if (v !== undefined) {
                                value[k] = v;
                            } else {
                                delete value[k];
                            }
                        }
                    }
                }
                return reviver.call(holder, key, value);
            }


// Parsing happens in four stages. In the first stage, we replace certain
// Unicode characters with escape sequences. JavaScript handles many characters
// incorrectly, either silently deleting them, or treating them as line endings.

            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (a) {
                    return '\\u' +
                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                });
            }

// In the second stage, we run the text against regular expressions that look
// for non-JSON patterns. We are especially concerned with '()' and 'new'
// because they can cause invocation, and '=' because it can cause mutation.
// But just to be safe, we want to reject all unexpected forms.

// We split the second stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE's and Safari's regexp engines. First we
// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we
// replace all simple value tokens with ']' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or ']' or
// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.

            if (/^[\],:{}\s]*$/
                    .test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
                        .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
                        .replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {

// In the third stage we use the eval function to compile the text into a
// JavaScript structure. The '{' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                j = eval('(' + text + ')');

// In the optional fourth stage, we recursively walk the new structure, passing
// each name/value pair to a reviver function for possible transformation.

                return typeof reviver === 'function'
                    ? walk({'': j}, '')
                    : j;
            }

// If the text is not JSON parseable, then a SyntaxError is thrown.

            throw new SyntaxError('JSON.parse');
        };
    }
}());;
/* END /DuttiNEWStorefrontAssetStore/js/lib/json2.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/storetext.properties (en_US) */
Inditex.iProperties['features'] = "Characteristics ";
Inditex.iProperties['help_shop_process'] = "Help with the purchasing process  ";
Inditex.iProperties['newsletter_subscription_confirm_message'] = "We have sent you an email confirming your subscription to our newsletter.";
Inditex.iProperties['title_ref'] = "Ref. ";
Inditex.iProperties['formulario_enviado'] = "Form sent";
Inditex.iProperties['message'] = "Message * ";
Inditex.iProperties['model_sizes_women'] = "The model is *height* tall and is wearing size *size*.";
Inditex.iProperties['filter_color_title'] = "COLOUR ";
Inditex.iProperties['comments_suggestions'] = "Comments and suggestions. ";
Inditex.iProperties['your_mail'] = "Your e-mail address *";
Inditex.iProperties['choose_message_reason'] = "Select the purpose of your message ";
Inditex.iProperties['help'] = "Would you like some help?";
Inditex.iProperties['size_guide_virtusize'] = "FIND YOUR SIZE";
Inditex.iProperties['sizes'] = "Size  ";
Inditex.iProperties['mail_sended'] = "Your e-mail was sent successfully.";
Inditex.iProperties['name'] = "Name * ";
Inditex.iProperties['label_lookbook'] = "LOOKBOOK";
Inditex.iProperties['back_to_top'] = "Back to top";
Inditex.iProperties['volver_a'] = "Back to ";
Inditex.iProperties['privacy_policy'] = "Privacy policy ";
Inditex.iProperties['returnRusiapopup_title'] = "NECESSARY DOCUMENTS TO PROCESS YOUR RETURN";
Inditex.iProperties['collections'] = "Collection  ";
Inditex.iProperties['read_accept'] = "I have read and I accept the  ";
Inditex.iProperties['information_about_availability'] = "Information on item availability  ";
Inditex.iProperties['email'] = "Email address ";
Inditex.iProperties['compra_RU'] = "CONFIRM ORDER";
Inditex.iProperties['add_order'] = "Add to cart";
Inditex.iProperties['process_order'] = "Process order";
Inditex.iProperties['comp_footwear_3'] = "Outsole/Sole";
Inditex.iProperties['comp_footwear_2'] = "Lining";
Inditex.iProperties['comp_footwear_1'] = "Cut";
Inditex.iProperties['exit'] = "Exit";
Inditex.iProperties['filter_size_title'] = "SIZE";
Inditex.iProperties['ItxUserPasswordForgetView.msgconfirm'] = "You will receive an e-mail in a few minutes to reset your password.";
Inditex.iProperties['mail_friend'] = "Your friend's email address * ";
Inditex.iProperties['size_guide'] = "SIZE GUIDE";
Inditex.iProperties['related_products_list'] = "You might like";
Inditex.iProperties['talla'] = "Size ";
Inditex.iProperties['title_shipping'] = "Delivery ";
Inditex.iProperties['returnRusiapopup_confirm'] = "CONFIRM ";
Inditex.iProperties['returnRusiapopup_passport'] = "A copy of your passport.";
Inditex.iProperties['volver'] = "Back";
Inditex.iProperties['label_new'] = "NEW";
Inditex.iProperties['accept'] = "Accept";
Inditex.iProperties['one_size'] = "One size fits all";
Inditex.iProperties['share_mail_title'] = "Share item";
Inditex.iProperties['send'] = "Send";
Inditex.iProperties['compra'] = "AUTHORISE PAYMENT";
Inditex.iProperties['back_soon_message'] = "This item is temporarily out of stock. Enter your e-mail address and we will let you know when it is available again. ";
Inditex.iProperties['colors'] = "Colour  ";
Inditex.iProperties['order_tracking'] = "Tracking your order   ";
Inditex.iProperties['returnRusiapopup_bill'] = "The invoice for your order, marking the items you are returning.";
Inditex.iProperties['newsletter_subscription_confirm_title'] = "THANK YOU FOR SUBSCRIBING TO OUR NEWSLETTER";
Inditex.iProperties['shop'] = "Store REMINDER ";
Inditex.iProperties['shops_locator'] = "Shop finder ";
Inditex.iProperties['gratuito'] = "Free";
Inditex.iProperties['title_comp'] = "Fabric / Care";
Inditex.iProperties['available_product_alert_subscription_tooltip'] = "Let me know when it arrives";
Inditex.iProperties['compraDE'] = "AUTHORISE PAYMENT";
Inditex.iProperties['change_returns_policy'] = "Exchange and/or returns policy  ";
Inditex.iProperties['available_product_alert_subscription_success'] = "Your request has been processed correctly. Many thanks";
Inditex.iProperties['comming_soon_message'] = "This item is still unavailable.Enter your e-mail address and we will let you know when we receive it. ";
Inditex.iProperties['formulario_enviado_correcto'] = "The information has been sent correctly.";
Inditex.iProperties['ItxUserPasswordForgetView.msgconfirm2'] = "If you do not receive an e-mail, please enter your e-mail address again, checking that it is correct.";
Inditex.iProperties['more_colors'] = "+ COLOURS";
Inditex.iProperties['comp_clothing_3'] = "Inner";
Inditex.iProperties['comp_clothing_2'] = "Lining";
Inditex.iProperties['comp_clothing_1'] = "Outer";
Inditex.iProperties['adding'] = "Adding...";
Inditex.iProperties['corporative_information'] = "Corporate information  ";
Inditex.iProperties['autorizarCompra'] = "AUTHORISE PAYMENT";
Inditex.iProperties['autorizarCompra_RU'] = "CONFIRM ORDER";
Inditex.iProperties['returnRusiapopup_application'] = "The application form duly completed and signed.";
Inditex.iProperties['color'] = "Colour";
Inditex.iProperties['shops_locator_employment'] = "Employment  ";
Inditex.iProperties['testVirtuaSize'] = "Try our new service to find your size.";
Inditex.iProperties['store_availability'] = "Availability in store.";
Inditex.iProperties['precio_no_disponible'] = "Price N/A";
Inditex.iProperties['title_return'] = "Return ";
Inditex.iProperties['last_products_list'] = "Last items viewed";
Inditex.iProperties['qualities'] = "Quality";
Inditex.iProperties['business_colaboration'] = "Commercial partnership  ";
Inditex.iProperties['size_popup_title'] = "What size do you need?";
Inditex.iProperties['returnRusiapopup_text'] = "We remind your that in order to correctly process your return, the following must be included:";
Inditex.iProperties['ItxUserPasswordForgetView.titleconfirm'] = "RETRIEVE PASSWORD";
Inditex.iProperties['model_sizes_men'] = "The model is *height* tall and is wearing size *size*. ";
Inditex.iProperties['store_availability_IC'] = "Collect in store.";
Inditex.iProperties['store_availability_ES'] = "Collect in store.";
Inditex.iProperties['newsletter_unsubscribe_success_title'] = "Unsubscribed correctly";
Inditex.iProperties['newsletter_request_error_message'] = "We were unable to process your request. Please try later or contact our Customer Service department.";
Inditex.iProperties['newsletter_unsubscribe_success_subtitle'] = "We have sent you an e-mail confirming your unsubscription to our Newsletter service.";
;
/* END /DuttiNEWStorefrontAssetStore/storetext.properties (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/jquery.json-2.2.js (en_US) */
/*
 * jQuery JSON Plugin
 * version: 2.1 (2009-08-14)
 *
 * This document is licensed as free software under the terms of the
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 *
 * Brantley Harris wrote this plugin. It is based somewhat on the JSON.org 
 * website's http://www.json.org/json2.js, which proclaims:
 * "NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.", a sentiment that
 * I uphold.
 *
 * It is also influenced heavily by MochiKit's serializeJSON, which is 
 * copyrighted 2005 by Bob Ippolito.
 */

(function($) {
    /** jQuery.toJSON( json-serializble )
     Converts the given argument into a JSON respresentation.

     If an object has a "toJSON" function, that will be used to get the representation.
     Non-integer/string keys are skipped in the object, as are keys that point to a function.

     json-serializble:
     The *thing* to be converted.
     **/
    $.toJSON = function(o)
    {
        if (typeof(JSON) == 'object' && JSON.stringify)
            return JSON.stringify(o);

        var type = typeof(o);

        if (o === null)
            return "null";

        if (type == "undefined")
            return undefined;

        if (type == "number" || type == "boolean")
            return o + "";

        if (type == "string")
            return $.quoteString(o);

        if (type == 'object')
        {
            if (typeof o.toJSON == "function")
                return $.toJSON( o.toJSON() );

            if (o.constructor === Date)
            {
                var month = o.getUTCMonth() + 1;
                if (month < 10) month = '0' + month;

                var day = o.getUTCDate();
                if (day < 10) day = '0' + day;

                var year = o.getUTCFullYear();

                var hours = o.getUTCHours();
                if (hours < 10) hours = '0' + hours;

                var minutes = o.getUTCMinutes();
                if (minutes < 10) minutes = '0' + minutes;

                var seconds = o.getUTCSeconds();
                if (seconds < 10) seconds = '0' + seconds;

                var milli = o.getUTCMilliseconds();
                if (milli < 100) milli = '0' + milli;
                if (milli < 10) milli = '0' + milli;

                return '"' + year + '-' + month + '-' + day + 'T' +
                    hours + ':' + minutes + ':' + seconds +
                    '.' + milli + 'Z"';
            }

            if (o.constructor === Array)
            {
                var ret = [];
                for (var i = 0; i < o.length; i++)
                    ret.push( $.toJSON(o[i]) || "null" );

                return "[" + ret.join(",") + "]";
            }

            var pairs = [];
            for (var k in o) {
                var name;
                var type = typeof k;

                if (type == "number")
                    name = '"' + k + '"';
                else if (type == "string")
                    name = $.quoteString(k);
                else
                    continue;  //skip non-string or number keys

                if (typeof o[k] == "function")
                    continue;  //skip pairs where the value is a function.

                var val = $.toJSON(o[k]);

                pairs.push(name + ":" + val);
            }

            return "{" + pairs.join(", ") + "}";
        }
    };

    /** jQuery.evalJSON(src)
     Evaluates a given piece of json source.
     **/
    $.evalJSON = function(src)
    {
        if (typeof(JSON) == 'object' && JSON.parse)
            return JSON.parse(src);
        return eval("(" + src + ")");
    };

    /** jQuery.secureEvalJSON(src)
     Evals JSON in a way that is *more* secure.
     **/
    $.secureEvalJSON = function(src)
    {
        if (typeof(JSON) == 'object' && JSON.parse)
            return JSON.parse(src);

        var filtered = src;
        filtered = filtered.replace(/\\["\\\/bfnrtu]/g, '@');
        filtered = filtered.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']');
        filtered = filtered.replace(/(?:^|:|,)(?:\s*\[)+/g, '');

        if (/^[\],:{}\s]*$/.test(filtered))
            return eval("(" + src + ")");
        else
            throw new SyntaxError("Error parsing JSON, source is not valid.");
    };

    /** jQuery.quoteString(string)
     Returns a string-repr of a string, escaping quotes intelligently.
     Mostly a support function for toJSON.

     Examples:
     >>> jQuery.quoteString("apple")
     "apple"

     >>> jQuery.quoteString('"Where are we going?", she asked.')
     "\"Where are we going?\", she asked."
     **/
    $.quoteString = function(string)
    {
        if (string.match(_escapeable))
        {
            return '"' + string.replace(_escapeable, function (a)
                {
                    var c = _meta[a];
                    if (typeof c === 'string') return c;
                    c = a.charCodeAt();
                    return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
                }) + '"';
        }
        return '"' + string + '"';
    };

    var _escapeable = /["\\\x00-\x1f\x7f-\x9f]/g;

    var _meta = {
        '\b': '\\b',
        '\t': '\\t',
        '\n': '\\n',
        '\f': '\\f',
        '\r': '\\r',
        '"' : '\\"',
        '\\': '\\\\'
    };
})(jQuery);
;
/* END /DuttiNEWStorefrontAssetStore/js/jquery.json-2.2.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/jquery.easyxdm.js (en_US) */
/**
 * Plugin de jquery para usar la biblioteca de crossdomain easyXDM usando la api de ajax de jquery con el prefixo x.
 *
 * Para su buen funcionamiento necesita estar declarada la url del html que se utilizara como iframe para hacer las peticiones xdm
 * en la variable ajaxToolViewUrl antes de la inclusion del plugin:
 *
 * 	ajaxToolViewUrl = '${jspStoreImgDir}/ItxAjaxIFrameTool.html';
 *  ajaxToolViewUrl = (ajaxToolViewUrl.indexOf('https') == 0) ? ajaxToolViewUrl.replace('https','http') : ajaxToolViewUrl.replace('http','https');
 *
 * Los metodos implementados son xget, xpost, xgetScript y xgetJson estan implementados como wrapper de xajax.
 * No estan soportadas llamandas sincronas, acceso a la clase XmlHttpRequest, jsonp, protocolos distintos de protocolos http[s] y un largo etcetera.
 *
 * Autor: Samuel Rodriguez Perez
 *
 * Nota: Copia del fichero de Stradivarius, ya que esta m?s que testeado.
 *
 **/

;
(function() {

    var optionsArray = [];

    jQuery.extend({
        xget: function( url, data, callback, type ) {
            // shift arguments if data argument was omited

            if ( jQuery.isFunction( data ) ) {
                type = type || callback;
                callback = data;
                data = null;
            }

            return jQuery.xajax({
                type: "GET",
                url: url,
                data: data,
                success: callback,
                dataType: type
            });
        },

        xgetScript: function( url, callback ) {
            return jQuery.xget(url, null, callback, "script");
        },

        xgetJSON: function( url, data, callback ) {
            return jQuery.xget(url, data, callback, "json");
        },

        xpost: function( url, data, callback, type ) {
            // shift arguments if data argument was omited
            if ( jQuery.isFunction( data ) ) {
                type = type || callback;
                callback = data;
                data = {};
            }

            return jQuery.xajax({
                type: "POST",
                url: url,
                data: data,
                success: callback,
                dataType: type
            });
        },


        xajax: function(options) {
            var self = this;
            var optionUrlProtocol = options.url.replace(/^([a-z]*:).*/,'$1');

            if (window.location.protocol == optionUrlProtocol || options.url.indexOf(':')==-1) {
                if (!options.error) {
                    options.error = function(xhr) {
                        var header = xhr.getResponseHeader("Itx-Middleware-Header");
                        if (header == "REDIRECT") {
                            window.location.href = xhr.getResponseHeader("Itx-Middleware-RedirectUrl");
                        } else {
                            openStaticModal(Messages.errorTitle,Messages.error);
                        }
                    }
                }

                return jQuery.ajax(options);
            }

            var index = optionsArray.length;
            optionsArray[index] = options;

            var req = jQuery.toJSON({
                url: options.url,
                data: options.data,
                method: options.type ? options.type : 'GET',
                reqType: options.dataType ? options.dataType : 'html',
                identifier: index
            });

            if (this.crossAjaxSocket) {
                this.crossAjaxSocket.postMessage(req);
            } else {

                var bodyEl = document.getElementsByTagName("body")[0];

                this.crossAjaxSocket = new easyXDM.Socket({
                    swf: jsStoreImageDir + "/easyxdm.swf",
                    remote: ajaxToolViewUrl, // Se establece en ItxCommonHTMLHead.jsp de manera global: 'https://localhost/webapp/wcs/stores/servlet/AjaxIFrameToolView'
                    container: bodyEl,
                    props: {
                        style: {
                            width: '0px',
                            height: '0px',
                            'z-index': '-100'
                        }
                    },
                    onMessage: function(resp, origin) {
                        var resp = $.evalJSON(resp);
                        if (resp.status == 1) {
                            // Nos devuelve datos normales

                            var out = resp.text;
                            try {
                                out = $.evalJSON(resp.text);
                            }catch (err){
                            }

                            if (optionsArray[resp.identifier].success) {
                                optionsArray[resp.identifier].success(out);
                            }

                        } else if (resp.status == -2) {
                            window.location.href = resp.text;
                        } else {
                            openStaticModal(Messages.errorTitle,Messages.error);
                        }
                        if (optionsArray[resp.identifier].complete) {
                            optionsArray[resp.identifier].complete();
                        }
                    },
                    onReady: function() {
                        // Una vez que este socket este listo para trabajar, enviamos el mensaje
                        self.crossAjaxSocket.postMessage(req);
                    }
                });
            }
        }
    });
})();;
/* END /DuttiNEWStorefrontAssetStore/js/jquery.easyxdm.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/jquery.jscrollpane.js (en_US) */
/*!
 * jScrollPane - v2.0.0beta12 - 2012-05-14
 * http://jscrollpane.kelvinluck.com/
 *
 * Copyright (c) 2010 Kelvin Luck
 * Dual licensed under the MIT and GPL licenses.
 */

// Script: jScrollPane - cross browser customisable scrollbars
//
// *Version: 2.0.0beta12, Last updated: 2012-05-14*
//
// Project Home - http://jscrollpane.kelvinluck.com/
// GitHub       - http://github.com/vitch/jScrollPane
// Source       - http://github.com/vitch/jScrollPane/raw/master/script/jquery.jscrollpane.js
// (Minified)   - http://github.com/vitch/jScrollPane/raw/master/script/jquery.jscrollpane.min.js
//
// About: License
//
// Copyright (c) 2012 Kelvin Luck
// Dual licensed under the MIT or GPL Version 2 licenses.
// http://jscrollpane.kelvinluck.com/MIT-LICENSE.txt
// http://jscrollpane.kelvinluck.com/GPL-LICENSE.txt
//
// About: Examples
//
// All examples and demos are available through the jScrollPane example site at:
// http://jscrollpane.kelvinluck.com/
//
// About: Support and Testing
//
// This plugin is tested on the browsers below and has been found to work reliably on them. If you run
// into a problem on one of the supported browsers then please visit the support section on the jScrollPane
// website (http://jscrollpane.kelvinluck.com/) for more information on getting support. You are also
// welcome to fork the project on GitHub if you can contribute a fix for a given issue. 
//
// jQuery Versions - tested in 1.4.2+ - reported to work in 1.3.x
// Browsers Tested - Firefox 3.6.8, Safari 5, Opera 10.6, Chrome 5.0, IE 6, 7, 8
//
// About: Release History
//
// 2.0.0beta12 - (In progress)
// 2.0.0beta11 - (2012-05-14)
// 2.0.0beta10 - (2011-04-17) cleaner required size calculation, improved keyboard support, stickToBottom/Left, other small fixes
// 2.0.0beta9 - (2011-01-31) new API methods, bug fixes and correct keyboard support for FF/OSX
// 2.0.0beta8 - (2011-01-29) touchscreen support, improved keyboard support
// 2.0.0beta7 - (2011-01-23) scroll speed consistent (thanks Aivo Paas)
// 2.0.0beta6 - (2010-12-07) scrollToElement horizontal support
// 2.0.0beta5 - (2010-10-18) jQuery 1.4.3 support, various bug fixes
// 2.0.0beta4 - (2010-09-17) clickOnTrack support, bug fixes
// 2.0.0beta3 - (2010-08-27) Horizontal mousewheel, mwheelIntent, keyboard support, bug fixes
// 2.0.0beta2 - (2010-08-21) Bug fixes
// 2.0.0beta1 - (2010-08-17) Rewrite to follow modern best practices and enable horizontal scrolling, initially hidden
//							 elements and dynamically sized elements.
// 1.x - (2006-12-31 - 2010-07-31) Initial version, hosted at googlecode, deprecated

(function($,window,undefined){

    $.fn.jScrollPane = function(settings)
    {
        // JScrollPane "class" - public methods are available through $('selector').data('jsp')
        function JScrollPane(elem, s)
        {
            var settings, jsp = this, pane, paneWidth, paneHeight, container, contentWidth, contentHeight,
                percentInViewH, percentInViewV, isScrollableV, isScrollableH, verticalDrag, dragMaxY,
                verticalDragPosition, horizontalDrag, dragMaxX, horizontalDragPosition,
                verticalBar, verticalTrack, scrollbarWidth, verticalTrackHeight, verticalDragHeight, arrowUp, arrowDown,
                horizontalBar, horizontalTrack, horizontalTrackWidth, horizontalDragWidth, arrowLeft, arrowRight,
                reinitialiseInterval, originalPadding, originalPaddingTotalWidth, previousContentWidth,
                wasAtTop = true, wasAtLeft = true, wasAtBottom = false, wasAtRight = false,
                originalElement = elem.clone(false, false).empty(),
                mwEvent = $.fn.mwheelIntent ? 'mwheelIntent.jsp' : 'mousewheel.jsp';

            originalPadding = elem.css('paddingTop') + ' ' +
                elem.css('paddingRight') + ' ' +
                elem.css('paddingBottom') + ' ' +
                elem.css('paddingLeft');
            // originalPaddingTotalWidth =  (parseInt(elem.css('paddingLeft'), 10) || 0) +
            // (parseInt(elem.css('paddingRight'), 10) || 0);
            originalPaddingTotalWidth =  0;

            function initialise(s)
            {

                var /*firstChild, lastChild, */isMaintainingPositon, lastContentX, lastContentY,
                    hasContainingSpaceChanged, originalScrollTop, originalScrollLeft,
                    maintainAtBottom = false, maintainAtRight = false;

                settings = s;

                if (pane === undefined) {
                    originalScrollTop = elem.scrollTop();
                    originalScrollLeft = elem.scrollLeft();

                    elem.css(
                        {
                            overflow: 'hidden',
                            padding: 0
                        }
                    );
                    // TODO: Deal with where width/ height is 0 as it probably means the element is hidden and we should
                    // come back to it later and check once it is unhidden...
                    paneWidth = elem.innerWidth() + originalPaddingTotalWidth;
                    paneHeight = elem.innerHeight();

                    elem.width(paneWidth);

                    pane = $('<div class="jspPane" />').css('padding', originalPadding).append(elem.children());
                    container = $('<div class="jspContainer" />')
                        .css({
                            //COMENTADO
                            //'width': paneWidth + 'px',
                            'height': paneHeight + 'px'
                        }
                    ).append(pane).appendTo(elem);

                    /*
                     // Move any margins from the first and last children up to the container so they can still
                     // collapse with neighbouring elements as they would before jScrollPane 
                     firstChild = pane.find(':first-child');
                     lastChild = pane.find(':last-child');
                     elem.css(
                     {
                     'margin-top': firstChild.css('margin-top'),
                     'margin-bottom': lastChild.css('margin-bottom')
                     }
                     );
                     firstChild.css('margin-top', 0);
                     lastChild.css('margin-bottom', 0);
                     */
                } else {
                    elem.css('width', '');

                    maintainAtBottom = settings.stickToBottom && isCloseToBottom();
                    maintainAtRight  = settings.stickToRight  && isCloseToRight();

                    hasContainingSpaceChanged = elem.innerWidth() + originalPaddingTotalWidth != paneWidth || elem.outerHeight() != paneHeight;

                    if (hasContainingSpaceChanged) {
                        paneWidth = elem.innerWidth() + originalPaddingTotalWidth;
                        paneHeight = elem.innerHeight();
                        container.css({
                            width: paneWidth + 'px',
                            height: paneHeight + 'px'
                        });
                    }

                    // If nothing changed since last check...
                    if (!hasContainingSpaceChanged && previousContentWidth == contentWidth && pane.outerHeight() == contentHeight) {
                        elem.width(paneWidth);
                        return;
                    }
                    previousContentWidth = contentWidth;

                    pane.css('width', '');
                    elem.width(paneWidth);

                    container.find('>.jspVerticalBar,>.jspHorizontalBar').remove().end();
                }

                pane.css('overflow', 'auto');
                if (s.contentWidth) {
                    contentWidth = s.contentWidth;
                } else {
                    contentWidth = pane[0].scrollWidth;
                }
                contentHeight = pane[0].scrollHeight;
                pane.css('overflow', '');

                percentInViewH = contentWidth / paneWidth;
                percentInViewV = contentHeight / paneHeight;
                isScrollableV = percentInViewV > 1;
                isScrollableH = percentInViewH > 1;

                //console.log(paneWidth, paneHeight, contentWidth, contentHeight, percentInViewH, percentInViewV, isScrollableH, isScrollableV);

                if (!(isScrollableH || isScrollableV)) {
                    elem.removeClass('jspScrollable');
                    pane.css({
                        top: 0,
                        width: container.width() - originalPaddingTotalWidth
                    });
                    removeMousewheel();
                    removeFocusHandler();
                    removeKeyboardNav();
                    removeClickOnTrack();
                } else {
                    elem.addClass('jspScrollable');

                    isMaintainingPositon = settings.maintainPosition && (verticalDragPosition || horizontalDragPosition);
                    if (isMaintainingPositon) {
                        lastContentX = contentPositionX();
                        lastContentY = contentPositionY();
                    }

                    initialiseVerticalScroll();
                    initialiseHorizontalScroll();
                    resizeScrollbars();

                    if (isMaintainingPositon) {
                        scrollToX(maintainAtRight  ? (contentWidth  - paneWidth ) : lastContentX, false);
                        scrollToY(maintainAtBottom ? (contentHeight - paneHeight) : lastContentY, false);
                    }

                    initFocusHandler();
                    initMousewheel();
                    initTouch();

                    if (settings.enableKeyboardNavigation) {
                        initKeyboardNav();
                    }
                    if (settings.clickOnTrack) {
                        initClickOnTrack();
                    }

                    observeHash();
                    if (settings.hijackInternalLinks) {
                        hijackInternalLinks();
                    }
                }

                if (settings.autoReinitialise && !reinitialiseInterval) {
                    reinitialiseInterval = setInterval(
                        function()
                        {
                            initialise(settings);
                        },
                        settings.autoReinitialiseDelay
                    );
                } else if (!settings.autoReinitialise && reinitialiseInterval) {
                    clearInterval(reinitialiseInterval);
                }

                originalScrollTop && elem.scrollTop(0) && scrollToY(originalScrollTop, false);
                originalScrollLeft && elem.scrollLeft(0) && scrollToX(originalScrollLeft, false);

                elem.trigger('jsp-initialised', [isScrollableH || isScrollableV]);
            }

            function initialiseVerticalScroll()
            {
                if (isScrollableV) {

                    container.append(
                        $('<div class="jspVerticalBar" />').append(
                            $('<div class="jspCap jspCapTop" />'),
                            $('<div class="jspTrack" />').append(
                                $('<div class="jspDrag" />').append(
                                    $('<div class="jspDragTop" />'),
                                    $('<div class="jspDragBottom" />')
                                )
                            ),
                            $('<div class="jspCap jspCapBottom" />')
                        )
                    );

                    verticalBar = container.find('>.jspVerticalBar');
                    verticalTrack = verticalBar.find('>.jspTrack');
                    verticalDrag = verticalTrack.find('>.jspDrag');

                    if (settings.showArrows) {
                        arrowUp = $('<a class="jspArrow jspArrowUp" />').bind(
                            'mousedown.jsp', getArrowScroll(0, -1)
                        ).bind('click.jsp', nil);
                        arrowDown = $('<a class="jspArrow jspArrowDown" />').bind(
                            'mousedown.jsp', getArrowScroll(0, 1)
                        ).bind('click.jsp', nil);
                        if (settings.arrowScrollOnHover) {
                            arrowUp.bind('mouseover.jsp', getArrowScroll(0, -1, arrowUp));
                            arrowDown.bind('mouseover.jsp', getArrowScroll(0, 1, arrowDown));
                        }

                        appendArrows(verticalTrack, settings.verticalArrowPositions, arrowUp, arrowDown);
                    }

                    verticalTrackHeight = paneHeight;
                    container.find('>.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow').each(
                        function()
                        {
                            verticalTrackHeight -= $(this).outerHeight();
                        }
                    );


                    verticalDrag.hover(
                        function()
                        {
                            verticalDrag.addClass('jspHover');
                        },
                        function()
                        {
                            verticalDrag.removeClass('jspHover');
                        }
                    ).bind(
                        'mousedown.jsp',
                        function(e)
                        {
                            // Stop IE from allowing text selection
                            $('html').bind('dragstart.jsp selectstart.jsp', nil);

                            verticalDrag.addClass('jspActive');

                            var startY = e.pageY - verticalDrag.position().top;

                            $('html').bind(
                                'mousemove.jsp',
                                function(e)
                                {
                                    positionDragY(e.pageY - startY, false);
                                }
                            ).bind('mouseup.jsp mouseleave.jsp', cancelDrag);
                            return false;
                        }
                    );
                    sizeVerticalScrollbar();
                }
            }

            function sizeVerticalScrollbar()
            {
                verticalTrack.height(verticalTrackHeight + 'px');
                verticalDragPosition = 0;
                scrollbarWidth = settings.verticalGutter + verticalTrack.outerWidth();

                // Make the pane thinner to allow for the vertical scrollbar
                //COMENTADO
                //pane.width(paneWidth - scrollbarWidth - originalPaddingTotalWidth);

                // Add margin to the left of the pane if scrollbars are on that side (to position
                // the scrollbar on the left or right set it's left or right property in CSS)
                try {
                    if (verticalBar.position().left === 0 && pane.css('position') === 'absolute') {
                        pane.css('margin-left', scrollbarWidth + 'px');
                    }
                } catch (err) {
                }
            }

            function initialiseHorizontalScroll()
            {
                if (isScrollableH) {

                    // container.append(
                    // $('<div class="jspHorizontalBar" />').append(
                    // $('<div class="jspCap jspCapLeft" />'),
                    // $('<div class="jspTrack" />').append(
                    // $('<div class="jspDrag" />').append(
                    // $('<div class="jspDragLeft" />'),
                    // $('<div class="jspDragRight" />')
                    // )
                    // ),
                    // $('<div class="jspCap jspCapRight" />')
                    // )
                    // );

                    horizontalBar = container.find('>.jspHorizontalBar');
                    horizontalTrack = horizontalBar.find('>.jspTrack');
                    horizontalDrag = horizontalTrack.find('>.jspDrag');

                    if (settings.showArrows) {
                        arrowLeft = $('<a class="jspArrow jspArrowLeft" />').bind(
                            'mousedown.jsp', getArrowScroll(-1, 0)
                        ).bind('click.jsp', nil);
                        arrowRight = $('<a class="jspArrow jspArrowRight" />').bind(
                            'mousedown.jsp', getArrowScroll(1, 0)
                        ).bind('click.jsp', nil);
                        if (settings.arrowScrollOnHover) {
                            arrowLeft.bind('mouseover.jsp', getArrowScroll(-1, 0, arrowLeft));
                            arrowRight.bind('mouseover.jsp', getArrowScroll(1, 0, arrowRight));
                        }
                        appendArrows(horizontalTrack, settings.horizontalArrowPositions, arrowLeft, arrowRight);
                    }

                    horizontalDrag.hover(
                        function()
                        {
                            horizontalDrag.addClass('jspHover');
                        },
                        function()
                        {
                            horizontalDrag.removeClass('jspHover');
                        }
                    ).bind(
                        'mousedown.jsp',
                        function(e)
                        {
                            // Stop IE from allowing text selection
                            $('html').bind('dragstart.jsp selectstart.jsp', nil);

                            horizontalDrag.addClass('jspActive');

                            var startX = e.pageX - horizontalDrag.position().left;

                            $('html').bind(
                                'mousemove.jsp',
                                function(e)
                                {
                                    positionDragX(e.pageX - startX, false);
                                }
                            ).bind('mouseup.jsp mouseleave.jsp', cancelDrag);
                            return false;
                        }
                    );
                    horizontalTrackWidth = container.innerWidth();
                    sizeHorizontalScrollbar();
                }
            }

            function sizeHorizontalScrollbar()
            {
                container.find('>.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow').each(
                    function()
                    {
                        horizontalTrackWidth -= $(this).outerWidth();
                    }
                );

                horizontalTrack.width(horizontalTrackWidth + 'px');
                horizontalDragPosition = 0;
            }

            function resizeScrollbars()
            {
                if (isScrollableH && isScrollableV) {
                    var horizontalTrackHeight = horizontalTrack.outerHeight(),
                        verticalTrackWidth = verticalTrack.outerWidth();
                    verticalTrackHeight -= horizontalTrackHeight;
                    $(horizontalBar).find('>.jspCap:visible,>.jspArrow').each(
                        function()
                        {
                            horizontalTrackWidth += $(this).outerWidth();
                        }
                    );
                    horizontalTrackWidth -= verticalTrackWidth;
                    paneHeight -= verticalTrackWidth;
                    paneWidth -= horizontalTrackHeight;
                    horizontalTrack.parent().append(
                        $('<div class="jspCorner" />').css('width', horizontalTrackHeight + 'px')
                    );
                    sizeVerticalScrollbar();
                    sizeHorizontalScrollbar();
                }
                // reflow content
                if (isScrollableH) {
                    pane.width((container.outerWidth() - originalPaddingTotalWidth) + 'px');
                }
                contentHeight = pane.outerHeight();
                percentInViewV = contentHeight / paneHeight;

                if (isScrollableH) {
                    horizontalDragWidth = Math.ceil(1 / percentInViewH * horizontalTrackWidth);
                    if (horizontalDragWidth > settings.horizontalDragMaxWidth) {
                        horizontalDragWidth = settings.horizontalDragMaxWidth;
                    } else if (horizontalDragWidth < settings.horizontalDragMinWidth) {
                        horizontalDragWidth = settings.horizontalDragMinWidth;
                    }
                    horizontalDrag.width(horizontalDragWidth + 'px');
                    dragMaxX = horizontalTrackWidth - horizontalDragWidth;
                    _positionDragX(horizontalDragPosition); // To update the state for the arrow buttons
                }
                if (isScrollableV) {
                    verticalDragHeight = Math.ceil(1 / percentInViewV * verticalTrackHeight);
                    if (verticalDragHeight > settings.verticalDragMaxHeight) {
                        verticalDragHeight = settings.verticalDragMaxHeight;
                    } else if (verticalDragHeight < settings.verticalDragMinHeight) {
                        verticalDragHeight = settings.verticalDragMinHeight;
                    }
                    verticalDrag.height(verticalDragHeight + 'px');
                    dragMaxY = verticalTrackHeight - verticalDragHeight;
                    _positionDragY(verticalDragPosition); // To update the state for the arrow buttons
                }
            }

            function appendArrows(ele, p, a1, a2)
            {
                var p1 = "before", p2 = "after", aTemp;

                // Sniff for mac... Is there a better way to determine whether the arrows would naturally appear
                // at the top or the bottom of the bar?
                if (p == "os") {
                    p = /Mac/.test(navigator.platform) ? "after" : "split";
                }
                if (p == p1) {
                    p2 = p;
                } else if (p == p2) {
                    p1 = p;
                    aTemp = a1;
                    a1 = a2;
                    a2 = aTemp;
                }

                ele[p1](a1)[p2](a2);
            }

            function getArrowScroll(dirX, dirY, ele)
            {
                return function()
                {
                    arrowScroll(dirX, dirY, this, ele);
                    this.blur();
                    return false;
                };
            }

            function arrowScroll(dirX, dirY, arrow, ele)
            {
                arrow = $(arrow).addClass('jspActive');

                var eve,
                    scrollTimeout,
                    isFirst = true,
                    doScroll = function()
                    {
                        if (dirX !== 0) {
                            jsp.scrollByX(dirX * settings.arrowButtonSpeed);
                        }
                        if (dirY !== 0) {
                            jsp.scrollByY(dirY * settings.arrowButtonSpeed);
                        }
                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.arrowRepeatFreq);
                        isFirst = false;
                    };

                doScroll();

                eve = ele ? 'mouseout.jsp' : 'mouseup.jsp';
                ele = ele || $('html');
                ele.bind(
                    eve,
                    function()
                    {
                        arrow.removeClass('jspActive');
                        scrollTimeout && clearTimeout(scrollTimeout);
                        scrollTimeout = null;
                        ele.unbind(eve);
                    }
                );
            }

            function initClickOnTrack()
            {
                removeClickOnTrack();
                if (isScrollableV) {
                    verticalTrack.bind(
                        'mousedown.jsp',
                        function(e)
                        {
                            if (e.originalTarget === undefined || e.originalTarget == e.currentTarget) {
                                var clickedTrack = $(this),
                                    offset = clickedTrack.offset(),
                                    direction = e.pageY - offset.top - verticalDragPosition,
                                    scrollTimeout,
                                    isFirst = true,
                                    doScroll = function()
                                    {
                                        var offset = clickedTrack.offset(),
                                            pos = e.pageY - offset.top - verticalDragHeight / 2,
                                            contentDragY = paneHeight * settings.scrollPagePercent,
                                            dragY = dragMaxY * contentDragY / (contentHeight - paneHeight);
                                        if (direction < 0) {
                                            if (verticalDragPosition - dragY > pos) {
                                                jsp.scrollByY(-contentDragY);
                                            } else {
                                                positionDragY(pos);
                                            }
                                        } else if (direction > 0) {
                                            if (verticalDragPosition + dragY < pos) {
                                                jsp.scrollByY(contentDragY);
                                            } else {
                                                positionDragY(pos);
                                            }
                                        } else {
                                            cancelClick();
                                            return;
                                        }
                                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.trackClickRepeatFreq);
                                        isFirst = false;
                                    },
                                    cancelClick = function()
                                    {
                                        scrollTimeout && clearTimeout(scrollTimeout);
                                        scrollTimeout = null;
                                        $(document).unbind('mouseup.jsp', cancelClick);
                                    };
                                doScroll();
                                $(document).bind('mouseup.jsp', cancelClick);
                                return false;
                            }
                        }
                    );
                }

                if (isScrollableH) {
                    horizontalTrack.bind(
                        'mousedown.jsp',
                        function(e)
                        {
                            if (e.originalTarget === undefined || e.originalTarget == e.currentTarget) {
                                var clickedTrack = $(this),
                                    offset = clickedTrack.offset(),
                                    direction = e.pageX - offset.left - horizontalDragPosition,
                                    scrollTimeout,
                                    isFirst = true,
                                    doScroll = function()
                                    {
                                        var offset = clickedTrack.offset(),
                                            pos = e.pageX - offset.left - horizontalDragWidth / 2,
                                            contentDragX = paneWidth * settings.scrollPagePercent,
                                            dragX = dragMaxX * contentDragX / (contentWidth - paneWidth);
                                        if (direction < 0) {
                                            if (horizontalDragPosition - dragX > pos) {
                                                jsp.scrollByX(-contentDragX);
                                            } else {
                                                positionDragX(pos);
                                            }
                                        } else if (direction > 0) {
                                            if (horizontalDragPosition + dragX < pos) {
                                                jsp.scrollByX(contentDragX);
                                            } else {
                                                positionDragX(pos);
                                            }
                                        } else {
                                            cancelClick();
                                            return;
                                        }
                                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.trackClickRepeatFreq);
                                        isFirst = false;
                                    },
                                    cancelClick = function()
                                    {
                                        scrollTimeout && clearTimeout(scrollTimeout);
                                        scrollTimeout = null;
                                        $(document).unbind('mouseup.jsp', cancelClick);
                                    };
                                doScroll();
                                $(document).bind('mouseup.jsp', cancelClick);
                                return false;
                            }
                        }
                    );
                }
            }

            function removeClickOnTrack()
            {
                if (horizontalTrack) {
                    horizontalTrack.unbind('mousedown.jsp');
                }
                if (verticalTrack) {
                    verticalTrack.unbind('mousedown.jsp');
                }
            }

            function cancelDrag()
            {
                $('html').unbind('dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp');

                if (verticalDrag) {
                    verticalDrag.removeClass('jspActive');
                }
                if (horizontalDrag) {
                    horizontalDrag.removeClass('jspActive');
                }
            }

            function positionDragY(destY, animate)
            {
                if (!isScrollableV) {
                    return;
                }
                if (destY < 0) {
                    destY = 0;
                } else if (destY > dragMaxY) {
                    destY = dragMaxY;
                }

                // can't just check if(animate) because false is a valid value that could be passed in...
                if (animate === undefined) {
                    animate = settings.animateScroll;
                }
                if (animate) {
                    jsp.animate(verticalDrag, 'top', destY,	_positionDragY);
                } else {
                    verticalDrag.css('top', destY);
                    _positionDragY(destY);
                }

            }

            function _positionDragY(destY)
            {
                if (destY === undefined) {
                    destY = verticalDrag.position().top;
                }

                container.scrollTop(0);
                verticalDragPosition = destY;

                var isAtTop = verticalDragPosition === 0,
                    isAtBottom = verticalDragPosition == dragMaxY,
                    percentScrolled = destY/ dragMaxY,
                    destTop = -percentScrolled * (contentHeight - paneHeight);

                if (wasAtTop != isAtTop || wasAtBottom != isAtBottom) {
                    wasAtTop = isAtTop;
                    wasAtBottom = isAtBottom;
                    elem.trigger('jsp-arrow-change', [wasAtTop, wasAtBottom, wasAtLeft, wasAtRight]);
                }

                updateVerticalArrows(isAtTop, isAtBottom);
                pane.css('top', destTop);
                elem.trigger('jsp-scroll-y', [-destTop, isAtTop, isAtBottom]).trigger('scroll');
            }

            function positionDragX(destX, animate)
            {
                if (!isScrollableH) {
                    return;
                }
                if (destX < 0) {
                    destX = 0;
                } else if (destX > dragMaxX) {
                    destX = dragMaxX;
                }

                if (animate === undefined) {
                    animate = settings.animateScroll;
                }
                if (animate) {
                    jsp.animate(horizontalDrag, 'left', destX,	_positionDragX);
                } else {
                    horizontalDrag.css('left', destX);
                    _positionDragX(destX);
                }
            }

            function _positionDragX(destX)
            {
                if (destX === undefined) {
                    destX = horizontalDrag.position().left;
                }

                container.scrollTop(0);
                horizontalDragPosition = destX;

                var isAtLeft = horizontalDragPosition === 0,
                    isAtRight = horizontalDragPosition == dragMaxX,
                    percentScrolled = destX / dragMaxX,
                    destLeft = -percentScrolled * (contentWidth - paneWidth);

                if (wasAtLeft != isAtLeft || wasAtRight != isAtRight) {
                    wasAtLeft = isAtLeft;
                    wasAtRight = isAtRight;
                    elem.trigger('jsp-arrow-change', [wasAtTop, wasAtBottom, wasAtLeft, wasAtRight]);
                }

                updateHorizontalArrows(isAtLeft, isAtRight);
                pane.css('left', destLeft);
                elem.trigger('jsp-scroll-x', [-destLeft, isAtLeft, isAtRight]).trigger('scroll');
            }

            function updateVerticalArrows(isAtTop, isAtBottom)
            {
                if (settings.showArrows) {
                    arrowUp[isAtTop ? 'addClass' : 'removeClass']('jspDisabled');
                    arrowDown[isAtBottom ? 'addClass' : 'removeClass']('jspDisabled');
                }
            }

            function updateHorizontalArrows(isAtLeft, isAtRight)
            {
                if (settings.showArrows) {
                    arrowLeft[isAtLeft ? 'addClass' : 'removeClass']('jspDisabled');
                    arrowRight[isAtRight ? 'addClass' : 'removeClass']('jspDisabled');
                }
            }

            function scrollToY(destY, animate)
            {
                var percentScrolled = destY / (contentHeight - paneHeight);
                positionDragY(percentScrolled * dragMaxY, animate);
            }

            function scrollToX(destX, animate)
            {
                var percentScrolled = destX / (contentWidth - paneWidth);
                positionDragX(percentScrolled * dragMaxX, animate);
            }

            function scrollToElement(ele, stickToTop, animate)
            {
                var e, eleHeight, eleWidth, eleTop = 0, eleLeft = 0, viewportTop, viewportLeft, maxVisibleEleTop, maxVisibleEleLeft, destY, destX;

                // Legal hash values aren't necessarily legal jQuery selectors so we need to catch any
                // errors from the lookup...
                try {
                    e = $(ele);
                } catch (err) {
                    return;
                }
                eleHeight = e.outerHeight();
                eleWidth= e.outerWidth();

                container.scrollTop(0);
                container.scrollLeft(0);

                // loop through parents adding the offset top of any elements that are relatively positioned between
                // the focused element and the jspPane so we can get the true distance from the top
                // of the focused element to the top of the scrollpane...
                while (!e.is('.jspPane')) {
                    eleTop += e.position().top;
                    eleLeft += e.position().left;
                    e = e.offsetParent();
                    if (/^body|html$/i.test(e[0].nodeName)) {
                        // we ended up too high in the document structure. Quit!
                        return;
                    }
                }

                viewportTop = contentPositionY();
                maxVisibleEleTop = viewportTop + paneHeight;
                if (eleTop < viewportTop || stickToTop) { // element is above viewport
                    destY = eleTop - settings.verticalGutter;
                } else if (eleTop + eleHeight > maxVisibleEleTop) { // element is below viewport
                    destY = eleTop - paneHeight + eleHeight + settings.verticalGutter;
                }
                if (destY) {
                    scrollToY(destY, animate);
                }

                viewportLeft = contentPositionX();
                maxVisibleEleLeft = viewportLeft + paneWidth;
                if (eleLeft < viewportLeft || stickToTop) { // element is to the left of viewport
                    destX = eleLeft - settings.horizontalGutter;
                } else if (eleLeft + eleWidth > maxVisibleEleLeft) { // element is to the right viewport
                    destX = eleLeft - paneWidth + eleWidth + settings.horizontalGutter;
                }
                if (destX) {
                    scrollToX(destX, animate);
                }

            }

            function contentPositionX()
            {
                return -pane.position().left;
            }

            function contentPositionY()
            {
                return -pane.position().top;
            }

            function isCloseToBottom()
            {
                var scrollableHeight = contentHeight - paneHeight;
                return (scrollableHeight > 20) && (scrollableHeight - contentPositionY() < 10);
            }

            function isCloseToRight()
            {
                var scrollableWidth = contentWidth - paneWidth;
                return (scrollableWidth > 20) && (scrollableWidth - contentPositionX() < 10);
            }

            function initMousewheel()
            {
                container.unbind(mwEvent).bind(
                    mwEvent,
                    function (event, delta, deltaX, deltaY) {
                        var dX = horizontalDragPosition, dY = verticalDragPosition;
                        jsp.scrollBy(deltaX * settings.mouseWheelSpeed, -deltaY * settings.mouseWheelSpeed, false);
                        // return true if there was no movement so rest of screen can scroll
                        return dX == horizontalDragPosition && dY == verticalDragPosition;
                    }
                );
            }

            function removeMousewheel()
            {
                container.unbind(mwEvent);
            }

            function nil()
            {
                return false;
            }

            function initFocusHandler()
            {
                pane.find(':input,a').unbind('focus.jsp').bind(
                    'focus.jsp',
                    function(e)
                    {
                        scrollToElement(e.target, false);
                    }
                );
            }

            function removeFocusHandler()
            {
                pane.find(':input,a').unbind('focus.jsp');
            }

            function initKeyboardNav()
            {
                var keyDown, elementHasScrolled, validParents = [];
                isScrollableH && validParents.push(horizontalBar[0]);
                isScrollableV && validParents.push(verticalBar[0]);

                // IE also focuses elements that don't have tabindex set.
                pane.focus(
                    function()
                    {
                        elem.focus();
                    }
                );

                elem.attr('tabindex', 0)
                    .unbind('keydown.jsp keypress.jsp')
                    .bind(
                    'keydown.jsp',
                    function(e)
                    {
                        if (e.target !== this && !(validParents.length && $(e.target).closest(validParents).length)){
                            return;
                        }
                        var dX = horizontalDragPosition, dY = verticalDragPosition;
                        switch(e.keyCode) {
                            case 40: // down
                            case 38: // up
                            case 34: // page down
                            case 32: // space
                            case 33: // page up
                            case 39: // right
                            case 37: // left
                                keyDown = e.keyCode;
                                keyDownHandler();
                                break;
                            case 35: // end
                                scrollToY(contentHeight - paneHeight);
                                keyDown = null;
                                break;
                            case 36: // home
                                scrollToY(0);
                                keyDown = null;
                                break;
                        }

                        elementHasScrolled = e.keyCode == keyDown && dX != horizontalDragPosition || dY != verticalDragPosition;
                        return !elementHasScrolled;
                    }
                ).bind(
                    'keypress.jsp', // For FF/ OSX so that we can cancel the repeat key presses if the JSP scrolls...
                    function(e)
                    {
                        if (e.keyCode == keyDown) {
                            keyDownHandler();
                        }
                        return !elementHasScrolled;
                    }
                );

                if (settings.hideFocus) {
                    elem.css('outline', 'none');
                    if ('hideFocus' in container[0]){
                        elem.attr('hideFocus', true);
                    }
                } else {
                    elem.css('outline', '');
                    if ('hideFocus' in container[0]){
                        elem.attr('hideFocus', false);
                    }
                }

                function keyDownHandler()
                {
                    var dX = horizontalDragPosition, dY = verticalDragPosition;
                    switch(keyDown) {
                        case 40: // down
                            jsp.scrollByY(settings.keyboardSpeed, false);
                            break;
                        case 38: // up
                            jsp.scrollByY(-settings.keyboardSpeed, false);
                            break;
                        case 34: // page down
                        case 32: // space
                            jsp.scrollByY(paneHeight * settings.scrollPagePercent, false);
                            break;
                        case 33: // page up
                            jsp.scrollByY(-paneHeight * settings.scrollPagePercent, false);
                            break;
                        case 39: // right
                            jsp.scrollByX(settings.keyboardSpeed, false);
                            break;
                        case 37: // left
                            jsp.scrollByX(-settings.keyboardSpeed, false);
                            break;
                    }

                    elementHasScrolled = dX != horizontalDragPosition || dY != verticalDragPosition;
                    return elementHasScrolled;
                }
            }

            function removeKeyboardNav()
            {
                elem.attr('tabindex', '-1')
                    .removeAttr('tabindex')
                    .unbind('keydown.jsp keypress.jsp');
            }

            function observeHash()
            {
                if (location.hash && location.hash.length > 1) {
                    var e,
                        retryInt,
                        hash = escape(location.hash.substr(1)) // hash must be escaped to prevent XSS
                        ;
                    try {
                        e = $('#' + hash + ', a[name="' + hash + '"]');
                    } catch (err) {
                        return;
                    }

                    if (e.length && pane.find(hash)) {
                        // nasty workaround but it appears to take a little while before the hash has done its thing
                        // to the rendered page so we just wait until the container's scrollTop has been messed up.
                        if (container.scrollTop() === 0) {
                            retryInt = setInterval(
                                function()
                                {
                                    if (container.scrollTop() > 0) {
                                        scrollToElement(e, true);
                                        $(document).scrollTop(container.position().top);
                                        clearInterval(retryInt);
                                    }
                                },
                                50
                            );
                        } else {
                            scrollToElement(e, true);
                            $(document).scrollTop(container.position().top);
                        }
                    }
                }
            }

            function hijackInternalLinks()
            {
                // only register the link handler once
                if ($(document.body).data('jspHijack')) {
                    return;
                }

                // remember that the handler was bound
                $(document.body).data('jspHijack', true);

                // use live handler to also capture newly created links
                $(document.body).delegate('a[href*=#]', 'click', function(event) {
                    // does the link point to the same page?
                    // this also takes care of cases with a <base>-Tag or Links not starting with the hash #
                    // e.g. <a href="index.html#test"> when the current url already is index.html
                    var href = this.href.substr(0, this.href.indexOf('#')),
                        locationHref = location.href,
                        hash,
                        element,
                        container,
                        jsp,
                        scrollTop,
                        elementTop;
                    if (location.href.indexOf('#') !== -1) {
                        locationHref = location.href.substr(0, location.href.indexOf('#'));
                    }
                    if (href !== locationHref) {
                        // the link points to another page
                        return;
                    }

                    // check if jScrollPane should handle this click event
                    hash = escape(this.href.substr(this.href.indexOf('#') + 1));

                    // find the element on the page
                    element;
                    try {
                        element = $('#' + hash + ', a[name="' + hash + '"]');
                    } catch (e) {
                        // hash is not a valid jQuery identifier
                        return;
                    }

                    if (!element.length) {
                        // this link does not point to an element on this page
                        return;
                    }

                    container = element.closest('.jspScrollable');
                    jsp = container.data('jsp');

                    // jsp might be another jsp instance than the one, that bound this event
                    // remember: this event is only bound once for all instances.
                    jsp.scrollToElement(element, true);

                    if (container[0].scrollIntoView) {
                        // also scroll to the top of the container (if it is not visible)
                        scrollTop = $(window).scrollTop();
                        elementTop = element.offset().top;
                        if (elementTop < scrollTop || elementTop > scrollTop + $(window).height()) {
                            container[0].scrollIntoView();
                        }
                    }

                    // jsp handled this event, prevent the browser default (scrolling :P)
                    event.preventDefault();
                });
            }

            // Init touch on iPad, iPhone, iPod, Android
            function initTouch()
            {
                var startX,
                    startY,
                    touchStartX,
                    touchStartY,
                    moved,
                    moving = false;

                container.unbind('touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick').bind(
                    'touchstart.jsp',
                    function(e)
                    {
                        var touch = e.originalEvent.touches[0];
                        startX = contentPositionX();
                        startY = contentPositionY();
                        touchStartX = touch.pageX;
                        touchStartY = touch.pageY;
                        moved = false;
                        moving = true;
                    }
                ).bind(
                    'touchmove.jsp',
                    function(ev)
                    {
                        if(!moving) {
                            return;
                        }

                        var touchPos = ev.originalEvent.touches[0],
                            dX = horizontalDragPosition, dY = verticalDragPosition;

                        jsp.scrollTo(startX + touchStartX - touchPos.pageX, startY + touchStartY - touchPos.pageY);

                        moved = moved || Math.abs(touchStartX - touchPos.pageX) > 5 || Math.abs(touchStartY - touchPos.pageY) > 5;

                        // return true if there was no movement so rest of screen can scroll
                        return dX == horizontalDragPosition && dY == verticalDragPosition;
                    }
                ).bind(
                    'touchend.jsp',
                    function(e)
                    {
                        moving = false;
                        /*if(moved) {
                         return false;
                         }*/
                    }
                ).bind(
                    'click.jsp-touchclick',
                    function(e)
                    {
                        if(moved) {
                            moved = false;
                            return false;
                        }
                    }
                );
            }

            function destroy(){
                var currentY = contentPositionY(),
                    currentX = contentPositionX();
                elem.removeClass('jspScrollable').unbind('.jsp');
                elem.replaceWith(originalElement.append(pane.children()));
                originalElement.scrollTop(currentY);
                originalElement.scrollLeft(currentX);

                // clear reinitialize timer if active
                if (reinitialiseInterval) {
                    clearInterval(reinitialiseInterval);
                }
            }

            // Public API
            $.extend(
                jsp,
                {
                    // Reinitialises the scroll pane (if it's internal dimensions have changed since the last time it
                    // was initialised). The settings object which is passed in will override any settings from the
                    // previous time it was initialised - if you don't pass any settings then the ones from the previous
                    // initialisation will be used.
                    reinitialise: function(s)
                    {
                        s = $.extend({}, settings, s);
                        initialise(s);
                    },
                    // Scrolls the specified element (a jQuery object, DOM node or jQuery selector string) into view so
                    // that it can be seen within the viewport. If stickToTop is true then the element will appear at
                    // the top of the viewport, if it is false then the viewport will scroll as little as possible to
                    // show the element. You can also specify if you want animation to occur. If you don't provide this
                    // argument then the animateScroll value from the settings object is used instead.
                    scrollToElement: function(ele, stickToTop, animate)
                    {
                        scrollToElement(ele, stickToTop, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinates within the content are at the top left
                    // of the viewport. animate is optional and if not passed then the value of animateScroll from
                    // the settings object this jScrollPane was initialised with is used.
                    scrollTo: function(destX, destY, animate)
                    {
                        scrollToX(destX, animate);
                        scrollToY(destY, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinate within the content is at the left of the
                    // viewport. animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    scrollToX: function(destX, animate)
                    {
                        scrollToX(destX, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinate within the content is at the top of the
                    // viewport. animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    scrollToY: function(destY, animate)
                    {
                        scrollToY(destY, animate);
                    },
                    // Scrolls the pane to the specified percentage of its maximum horizontal scroll position. animate
                    // is optional and if not passed then the value of animateScroll from the settings object this
                    // jScrollPane was initialised with is used.
                    scrollToPercentX: function(destPercentX, animate)
                    {
                        scrollToX(destPercentX * (contentWidth - paneWidth), animate);
                    },
                    // Scrolls the pane to the specified percentage of its maximum vertical scroll position. animate
                    // is optional and if not passed then the value of animateScroll from the settings object this
                    // jScrollPane was initialised with is used.
                    scrollToPercentY: function(destPercentY, animate)
                    {
                        scrollToY(destPercentY * (contentHeight - paneHeight), animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollBy: function(deltaX, deltaY, animate)
                    {
                        jsp.scrollByX(deltaX, animate);
                        jsp.scrollByY(deltaY, animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollByX: function(deltaX, animate)
                    {
                        var destX = contentPositionX() + Math[deltaX<0 ? 'floor' : 'ceil'](deltaX),
                            percentScrolled = destX / (contentWidth - paneWidth);
                        positionDragX(percentScrolled * dragMaxX, animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollByY: function(deltaY, animate)
                    {
                        var destY = contentPositionY() + Math[deltaY<0 ? 'floor' : 'ceil'](deltaY),
                            percentScrolled = destY / (contentHeight - paneHeight);
                        positionDragY(percentScrolled * dragMaxY, animate);
                    },
                    // Positions the horizontal drag at the specified x position (and updates the viewport to reflect
                    // this). animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    positionDragX: function(x, animate)
                    {
                        positionDragX(x, animate);
                    },
                    // Positions the vertical drag at the specified y position (and updates the viewport to reflect
                    // this). animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    positionDragY: function(y, animate)
                    {
                        positionDragY(y, animate);
                    },
                    // This method is called when jScrollPane is trying to animate to a new position. You can override
                    // it if you want to provide advanced animation functionality. It is passed the following arguments:
                    //  * ele          - the element whose position is being animated
                    //  * prop         - the property that is being animated
                    //  * value        - the value it's being animated to
                    //  * stepCallback - a function that you must execute each time you update the value of the property
                    // You can use the default implementation (below) as a starting point for your own implementation.
                    animate: function(ele, prop, value, stepCallback)
                    {
                        var params = {};
                        params[prop] = value;
                        ele.animate(
                            params,
                            {
                                'duration'	: settings.animateDuration,
                                'easing'	: settings.animateEase,
                                'queue'		: false,
                                'step'		: stepCallback
                            }
                        );
                    },
                    // Returns the current x position of the viewport with regards to the content pane.
                    getContentPositionX: function()
                    {
                        return contentPositionX();
                    },
                    // Returns the current y position of the viewport with regards to the content pane.
                    getContentPositionY: function()
                    {
                        return contentPositionY();
                    },
                    // Returns the width of the content within the scroll pane.
                    getContentWidth: function()
                    {
                        return contentWidth;
                    },
                    // Returns the height of the content within the scroll pane.
                    getContentHeight: function()
                    {
                        return contentHeight;
                    },
                    // Returns the horizontal position of the viewport within the pane content.
                    getPercentScrolledX: function()
                    {
                        return contentPositionX() / (contentWidth - paneWidth);
                    },
                    // Returns the vertical position of the viewport within the pane content.
                    getPercentScrolledY: function()
                    {
                        return contentPositionY() / (contentHeight - paneHeight);
                    },
                    // Returns whether or not this scrollpane has a horizontal scrollbar.
                    getIsScrollableH: function()
                    {
                        return isScrollableH;
                    },
                    // Returns whether or not this scrollpane has a vertical scrollbar.
                    getIsScrollableV: function()
                    {
                        return isScrollableV;
                    },
                    // Gets a reference to the content pane. It is important that you use this method if you want to
                    // edit the content of your jScrollPane as if you access the element directly then you may have some
                    // problems (as your original element has had additional elements for the scrollbars etc added into
                    // it).
                    getContentPane: function()
                    {
                        return pane;
                    },
                    // Scrolls this jScrollPane down as far as it can currently scroll. If animate isn't passed then the
                    // animateScroll value from settings is used instead.
                    scrollToBottom: function(animate)
                    {
                        positionDragY(dragMaxY, animate);
                    },
                    // Hijacks the links on the page which link to content inside the scrollpane. If you have changed
                    // the content of your page (e.g. via AJAX) and want to make sure any new anchor links to the
                    // contents of your scroll pane will work then call this function.
                    hijackInternalLinks: $.noop,
                    // Removes the jScrollPane and returns the page to the state it was in before jScrollPane was
                    // initialised.
                    destroy: function()
                    {
                        destroy();
                    }
                }
            );

            initialise(s);
        }

        // Pluginifying code...
        settings = $.extend({}, $.fn.jScrollPane.defaults, settings);

        // Apply default speed
        $.each(['mouseWheelSpeed', 'arrowButtonSpeed', 'trackClickSpeed', 'keyboardSpeed'], function() {
            settings[this] = settings[this] || settings.speed;
        });

        return this.each(
            function()
            {
                var elem = $(this), jspApi = elem.data('jsp');
                if (jspApi) {
                    jspApi.reinitialise(settings);
                } else {
                    jspApi = new JScrollPane(elem, settings);
                    elem.data('jsp', jspApi);
                }
            }
        );
    };

    $.fn.jScrollPane.defaults = {
        showArrows					: false,
        maintainPosition			: true,
        stickToBottom				: false,
        stickToRight				: false,
        clickOnTrack				: true,
        autoReinitialise			: false,
        autoReinitialiseDelay		: 500,
        verticalDragMinHeight		: 0,
        verticalDragMaxHeight		: 99999,
        horizontalDragMinWidth		: 0,
        horizontalDragMaxWidth		: 99999,
        contentWidth				: undefined,
        animateScroll				: false,
        animateDuration				: 300,
        animateEase					: 'linear',
        hijackInternalLinks			: false,
        verticalGutter				: 4,
        horizontalGutter			: 4,
        mouseWheelSpeed				: 0,
        arrowButtonSpeed			: 0,
        arrowRepeatFreq				: 50,
        arrowScrollOnHover			: false,
        trackClickSpeed				: 0,
        trackClickRepeatFreq		: 70,
        verticalArrowPositions		: 'split',
        horizontalArrowPositions	: 'split',
        enableKeyboardNavigation	: true,
        hideFocus					: false,
        keyboardSpeed				: 0,
        initialDelay                : 300,        // Delay before starting repeating
        speed						: 30,		// Default speed when others falsey
        scrollPagePercent			: .8		// Percent of visible area scrolled when pageUp/Down or track area pressed
    };

})(jQuery,this);

;
/* END /DuttiNEWStorefrontAssetStore/js/jquery.jscrollpane.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/jquery.mousewheel.js (en_US) */
/*! Copyright (c) 2011 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.6
 * 
 * Requires: 1.2.2+
 */

(function($) {

    var types = ['DOMMouseScroll', 'mousewheel','tap'];

    if ($.event.fixHooks) {
        for ( var i=types.length; i; ) {
            $.event.fixHooks[ types[--i] ] = $.event.mouseHooks;
        }
    }

    $.event.special.mousewheel = {
        setup: function() {
            if ( this.addEventListener ) {
                for ( var i=types.length; i; ) {
                    this.addEventListener( types[--i], handler, false );
                }
            } else {
                this.onmousewheel = handler;
            }
        },

        teardown: function() {
            if ( this.removeEventListener ) {
                for ( var i=types.length; i; ) {
                    this.removeEventListener( types[--i], handler, false );
                }
            } else {
                this.onmousewheel = null;
            }
        }
    };

    $.fn.extend({
        mousewheel: function(fn) {
            return fn ? this.bind("mousewheel", fn) : this.trigger("mousewheel");
        },

        unmousewheel: function(fn) {
            return this.unbind("mousewheel", fn);
        }
    });


    function handler(event) {
        var orgEvent = event || window.event, args = [].slice.call( arguments, 1 ), delta = 0, returnValue = true, deltaX = 0, deltaY = 0;
        event = $.event.fix(orgEvent);
        event.preventDefault();
        event.type = "mousewheel";

        // Old school scrollwheel delta
        if ( orgEvent.wheelDelta ) { delta = orgEvent.wheelDelta/120; }
        if ( orgEvent.detail     ) { delta = -orgEvent.detail/3; }

        // New school multidimensional scroll (touchpads) deltas
        deltaY = delta;

        // Gecko
        if ( orgEvent.axis !== undefined && orgEvent.axis === orgEvent.HORIZONTAL_AXIS ) {
            deltaY = 0;
            deltaX = -1*delta;
        }

        // Webkit
        if ( orgEvent.wheelDeltaY !== undefined ) { deltaY = orgEvent.wheelDeltaY/120; }
        if ( orgEvent.wheelDeltaX !== undefined ) { deltaX = -1*orgEvent.wheelDeltaX/120; }

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

})(jQuery);
;
/* END /DuttiNEWStorefrontAssetStore/js/jquery.mousewheel.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/lib/jquery-ui-191.js (en_US) */
/*! jQuery UI - v1.9.1 - 2012-11-12
 * http://jqueryui.com
 * Includes: jquery.ui.core.js, jquery.ui.datepicker.js, jquery.ui.effect.js
 * Copyright (c) 2012 jQuery Foundation and other contributors Licensed MIT */

(function(e,t){function i(t,n){var r,i,o,u=t.nodeName.toLowerCase();return"area"===u?(r=t.parentNode,i=r.name,!t.href||!i||r.nodeName.toLowerCase()!=="map"?!1:(o=e("img[usemap=#"+i+"]")[0],!!o&&s(o))):(/input|select|textarea|button|object/.test(u)?!t.disabled:"a"===u?t.href||n:n)&&s(t)}function s(t){return e.expr.filters.visible(t)&&!e(t).parents().andSelf().filter(function(){return e.css(this,"visibility")==="hidden"}).length}var n=0,r=/^ui-id-\d+$/;e.ui=e.ui||{};if(e.ui.version)return;e.extend(e.ui,{version:"1.9.1",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),e.fn.extend({_focus:e.fn.focus,focus:function(t,n){return typeof t=="number"?this.each(function(){var r=this;setTimeout(function(){e(r).focus(),n&&n.call(r)},t)}):this._focus.apply(this,arguments)},scrollParent:function(){var t;return e.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?t=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0):t=this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(n){if(n!==t)return this.css("zIndex",n);if(this.length){var r=e(this[0]),i,s;while(r.length&&r[0]!==document){i=r.css("position");if(i==="absolute"||i==="relative"||i==="fixed"){s=parseInt(r.css("zIndex"),10);if(!isNaN(s)&&s!==0)return s}r=r.parent()}}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++n)})},removeUniqueId:function(){return this.each(function(){r.test(this.id)&&e(this).removeAttr("id")})}}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(n,r){function u(t,n,r,s){return e.each(i,function(){n-=parseFloat(e.css(t,"padding"+this))||0,r&&(n-=parseFloat(e.css(t,"border"+this+"Width"))||0),s&&(n-=parseFloat(e.css(t,"margin"+this))||0)}),n}var i=r==="Width"?["Left","Right"]:["Top","Bottom"],s=r.toLowerCase(),o={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};e.fn["inner"+r]=function(n){return n===t?o["inner"+r].call(this):this.each(function(){e(this).css(s,u(this,n)+"px")})},e.fn["outer"+r]=function(t,n){return typeof t!="number"?o["outer"+r].call(this,t):this.each(function(){e(this).css(s,u(this,t,!0,n)+"px")})}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(n){return!!e.data(n,t)}}):function(t,n,r){return!!e.data(t,r[3])},focusable:function(t){return i(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var n=e.attr(t,"tabindex"),r=isNaN(n);return(r||n>=0)&&i(t,!r)}}),e(function(){var t=document.body,n=t.appendChild(n=document.createElement("div"));n.offsetHeight,e.extend(n.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),e.support.minHeight=n.offsetHeight===100,e.support.selectstart="onselectstart"in n,t.removeChild(n).style.display="none"}),function(){var t=/msie ([\w.]+)/.exec(navigator.userAgent.toLowerCase())||[];e.ui.ie=t.length?!0:!1,e.ui.ie6=parseFloat(t[1],10)===6}(),e.fn.extend({disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),e.extend(e.ui,{plugin:{add:function(t,n,r){var i,s=e.ui[t].prototype;for(i in r)s.plugins[i]=s.plugins[i]||[],s.plugins[i].push([n,r[i]])},call:function(e,t,n){var r,i=e.plugins[t];if(!i||!e.element[0].parentNode||e.element[0].parentNode.nodeType===11)return;for(r=0;r<i.length;r++)e.options[i[r][0]]&&i[r][1].apply(e.element,n)}},contains:e.contains,hasScroll:function(t,n){if(e(t).css("overflow")==="hidden")return!1;var r=n&&n==="left"?"scrollLeft":"scrollTop",i=!1;return t[r]>0?!0:(t[r]=1,i=t[r]>0,t[r]=0,i)},isOverAxis:function(e,t,n){return e>t&&e<t+n},isOver:function(t,n,r,i,s,o){return e.ui.isOverAxis(t,r,s)&&e.ui.isOverAxis(n,i,o)}})})(jQuery);(function($,undefined){function Datepicker(){this.debug=!1,this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.dpDiv=bindHover($('<div id="'+this._mainDivId+'" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>'))}function bindHover(e){var t="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return e.delegate(t,"mouseout",function(){$(this).removeClass("ui-state-hover"),this.className.indexOf("ui-datepicker-prev")!=-1&&$(this).removeClass("ui-datepicker-prev-hover"),this.className.indexOf("ui-datepicker-next")!=-1&&$(this).removeClass("ui-datepicker-next-hover")}).delegate(t,"mouseover",function(){$.datepicker._isDisabledDatepicker(instActive.inline?e.parent()[0]:instActive.input[0])||($(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),$(this).addClass("ui-state-hover"),this.className.indexOf("ui-datepicker-prev")!=-1&&$(this).addClass("ui-datepicker-prev-hover"),this.className.indexOf("ui-datepicker-next")!=-1&&$(this).addClass("ui-datepicker-next-hover"))})}function extendRemove(e,t){$.extend(e,t);for(var n in t)if(t[n]==null||t[n]==undefined)e[n]=t[n];return e}$.extend($.ui,{datepicker:{version:"1.9.1"}});var PROP_NAME="datepicker",dpuuid=(new Date).getTime(),instActive;$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,log:function(){this.debug&&console.log.apply("",arguments)},_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(e){return extendRemove(this._defaults,e||{}),this},_attachDatepicker:function(target,settings){var inlineSettings=null;for(var attrName in this._defaults){var attrValue=target.getAttribute("date:"+attrName);if(attrValue){inlineSettings=inlineSettings||{};try{inlineSettings[attrName]=eval(attrValue)}catch(err){inlineSettings[attrName]=attrValue}}}var nodeName=target.nodeName.toLowerCase(),inline=nodeName=="div"||nodeName=="span";target.id||(this.uuid+=1,target.id="dp"+this.uuid);var inst=this._newInst($(target),inline);inst.settings=$.extend({},settings||{},inlineSettings||{}),nodeName=="input"?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)},_newInst:function(e,t){var n=e[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1");return{id:n,input:e,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:t,dpDiv:t?bindHover($('<div class="'+this._inlineClass+' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>')):this.dpDiv}},_connectDatepicker:function(e,t){var n=$(e);t.append=$([]),t.trigger=$([]);if(n.hasClass(this.markerClassName))return;this._attachments(n,t),n.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp).bind("setData.datepicker",function(e,n,r){t.settings[n]=r}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),this._autoSize(t),$.data(e,PROP_NAME,t),t.settings.disabled&&this._disableDatepicker(e)},_attachments:function(e,t){var n=this._get(t,"appendText"),r=this._get(t,"isRTL");t.append&&t.append.remove(),n&&(t.append=$('<span class="'+this._appendClass+'">'+n+"</span>"),e[r?"before":"after"](t.append)),e.unbind("focus",this._showDatepicker),t.trigger&&t.trigger.remove();var i=this._get(t,"showOn");(i=="focus"||i=="both")&&e.focus(this._showDatepicker);if(i=="button"||i=="both"){var s=this._get(t,"buttonText"),o=this._get(t,"buttonImage");t.trigger=$(this._get(t,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:o,alt:s,title:s}):$('<button type="button"></button>').addClass(this._triggerClass).html(o==""?s:$("<img/>").attr({src:o,alt:s,title:s}))),e[r?"before":"after"](t.trigger),t.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput==e[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!=e[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(e[0])):$.datepicker._showDatepicker(e[0]),!1})}},_autoSize:function(e){if(this._get(e,"autoSize")&&!e.inline){var t=new Date(2009,11,20),n=this._get(e,"dateFormat");if(n.match(/[DM]/)){var r=function(e){var t=0,n=0;for(var r=0;r<e.length;r++)e[r].length>t&&(t=e[r].length,n=r);return n};t.setMonth(r(this._get(e,n.match(/MM/)?"monthNames":"monthNamesShort"))),t.setDate(r(this._get(e,n.match(/DD/)?"dayNames":"dayNamesShort"))+20-t.getDay())}e.input.attr("size",this._formatDate(e,t).length)}},_inlineDatepicker:function(e,t){var n=$(e);if(n.hasClass(this.markerClassName))return;n.addClass(this.markerClassName).append(t.dpDiv).bind("setData.datepicker",function(e,n,r){t.settings[n]=r}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),$.data(e,PROP_NAME,t),this._setDate(t,this._getDefaultDate(t),!0),this._updateDatepicker(t),this._updateAlternate(t),t.settings.disabled&&this._disableDatepicker(e),t.dpDiv.css("display","block")},_dialogDatepicker:function(e,t,n,r,i){var s=this._dialogInst;if(!s){this.uuid+=1;var o="dp"+this.uuid;this._dialogInput=$('<input type="text" id="'+o+'" style="position: absolute; top: -100px; width: 0px;"/>'),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),s=this._dialogInst=this._newInst(this._dialogInput,!1),s.settings={},$.data(this._dialogInput[0],PROP_NAME,s)}extendRemove(s.settings,r||{}),t=t&&t.constructor==Date?this._formatDate(s,t):t,this._dialogInput.val(t),this._pos=i?i.length?i:[i.pageX,i.pageY]:null;if(!this._pos){var u=document.documentElement.clientWidth,a=document.documentElement.clientHeight,f=document.documentElement.scrollLeft||document.body.scrollLeft,l=document.documentElement.scrollTop||document.body.scrollTop;this._pos=[u/2-100+f,a/2-150+l]}return this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),s.settings.onSelect=n,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],PROP_NAME,s),this},_destroyDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();$.removeData(e,PROP_NAME),r=="input"?(n.append.remove(),n.trigger.remove(),t.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):(r=="div"||r=="span")&&t.removeClass(this.markerClassName).empty()},_enableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();if(r=="input")e.disabled=!1,n.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""});else if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);i.children().removeClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t})},_disableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName))return;var r=e.nodeName.toLowerCase();if(r=="input")e.disabled=!0,n.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"});else if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);i.children().addClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t}),this._disabledInputs[this._disabledInputs.length]=e},_isDisabledDatepicker:function(e){if(!e)return!1;for(var t=0;t<this._disabledInputs.length;t++)if(this._disabledInputs[t]==e)return!0;return!1},_getInst:function(e){try{return $.data(e,PROP_NAME)}catch(t){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(e,t,n){var r=this._getInst(e);if(arguments.length==2&&typeof t=="string")return t=="defaults"?$.extend({},$.datepicker._defaults):r?t=="all"?$.extend({},r.settings):this._get(r,t):null;var i=t||{};typeof t=="string"&&(i={},i[t]=n);if(r){this._curInst==r&&this._hideDatepicker();var s=this._getDateDatepicker(e,!0),o=this._getMinMaxDate(r,"min"),u=this._getMinMaxDate(r,"max");extendRemove(r.settings,i),o!==null&&i.dateFormat!==undefined&&i.minDate===undefined&&(r.settings.minDate=this._formatDate(r,o)),u!==null&&i.dateFormat!==undefined&&i.maxDate===undefined&&(r.settings.maxDate=this._formatDate(r,u)),this._attachments($(e),r),this._autoSize(r),this._setDate(r,s),this._updateAlternate(r),this._updateDatepicker(r)}},_changeDatepicker:function(e,t,n){this._optionDatepicker(e,t,n)},_refreshDatepicker:function(e){var t=this._getInst(e);t&&this._updateDatepicker(t)},_setDateDatepicker:function(e,t){var n=this._getInst(e);n&&(this._setDate(n,t),this._updateDatepicker(n),this._updateAlternate(n))},_getDateDatepicker:function(e,t){var n=this._getInst(e);return n&&!n.inline&&this._setDateFromField(n,t),n?this._getDate(n):null},_doKeyDown:function(e){var t=$.datepicker._getInst(e.target),n=!0,r=t.dpDiv.is(".ui-datepicker-rtl");t._keyEvent=!0;if($.datepicker._datepickerShowing)switch(e.keyCode){case 9:$.datepicker._hideDatepicker(),n=!1;break;case 13:var i=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",t.dpDiv);i[0]&&$.datepicker._selectDay(e.target,t.selectedMonth,t.selectedYear,i[0]);var s=$.datepicker._get(t,"onSelect");if(s){var o=$.datepicker._formatDate(t);s.apply(t.input?t.input[0]:null,[o,t])}else $.datepicker._hideDatepicker();return!1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");break;case 34:$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");break;case 35:(e.ctrlKey||e.metaKey)&&$.datepicker._clearDate(e.target),n=e.ctrlKey||e.metaKey;break;case 36:(e.ctrlKey||e.metaKey)&&$.datepicker._gotoToday(e.target),n=e.ctrlKey||e.metaKey;break;case 37:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?1:-1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");break;case 38:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,-7,"D"),n=e.ctrlKey||e.metaKey;break;case 39:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?-1:1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");break;case 40:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,7,"D"),n=e.ctrlKey||e.metaKey;break;default:n=!1}else e.keyCode==36&&e.ctrlKey?$.datepicker._showDatepicker(this):n=!1;n&&(e.preventDefault(),e.stopPropagation())},_doKeyPress:function(e){var t=$.datepicker._getInst(e.target);if($.datepicker._get(t,"constrainInput")){var n=$.datepicker._possibleChars($.datepicker._get(t,"dateFormat")),r=String.fromCharCode(e.charCode==undefined?e.keyCode:e.charCode);return e.ctrlKey||e.metaKey||r<" "||!n||n.indexOf(r)>-1}},_doKeyUp:function(e){var t=$.datepicker._getInst(e.target);if(t.input.val()!=t.lastVal)try{var n=$.datepicker.parseDate($.datepicker._get(t,"dateFormat"),t.input?t.input.val():null,$.datepicker._getFormatConfig(t));n&&($.datepicker._setDateFromField(t),$.datepicker._updateAlternate(t),$.datepicker._updateDatepicker(t))}catch(r){$.datepicker.log(r)}return!0},_showDatepicker:function(e){e=e.target||e,e.nodeName.toLowerCase()!="input"&&(e=$("input",e.parentNode)[0]);if($.datepicker._isDisabledDatepicker(e)||$.datepicker._lastInput==e)return;var t=$.datepicker._getInst(e);$.datepicker._curInst&&$.datepicker._curInst!=t&&($.datepicker._curInst.dpDiv.stop(!0,!0),t&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0]));var n=$.datepicker._get(t,"beforeShow"),r=n?n.apply(e,[e,t]):{};if(r===!1)return;extendRemove(t.settings,r),t.lastVal=null,$.datepicker._lastInput=e,$.datepicker._setDateFromField(t),$.datepicker._inDialog&&(e.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(e),$.datepicker._pos[1]+=e.offsetHeight);var i=!1;$(e).parents().each(function(){return i|=$(this).css("position")=="fixed",!i});var s={left:$.datepicker._pos[0],top:$.datepicker._pos[1]};$.datepicker._pos=null,t.dpDiv.empty(),t.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(t),s=$.datepicker._checkOffset(t,s,i),t.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":i?"fixed":"absolute",display:"none",left:s.left+"px",top:s.top+"px"});if(!t.inline){var o=$.datepicker._get(t,"showAnim"),u=$.datepicker._get(t,"duration"),a=function(){var e=t.dpDiv.find("iframe.ui-datepicker-cover");if(!!e.length){var n=$.datepicker._getBorders(t.dpDiv);e.css({left:-n[0],top:-n[1],width:t.dpDiv.outerWidth(),height:t.dpDiv.outerHeight()})}};t.dpDiv.zIndex($(e).zIndex()+1),$.datepicker._datepickerShowing=!0,$.effects&&($.effects.effect[o]||$.effects[o])?t.dpDiv.show(o,$.datepicker._get(t,"showOptions"),u,a):t.dpDiv[o||"show"](o?u:null,a),(!o||!u)&&a(),t.input.is(":visible")&&!t.input.is(":disabled")&&t.input.focus(),$.datepicker._curInst=t}},_updateDatepicker:function(e){this.maxRows=4;var t=$.datepicker._getBorders(e.dpDiv);instActive=e,e.dpDiv.empty().append(this._generateHTML(e)),this._attachHandlers(e);var n=e.dpDiv.find("iframe.ui-datepicker-cover");!n.length||n.css({left:-t[0],top:-t[1],width:e.dpDiv.outerWidth(),height:e.dpDiv.outerHeight()}),e.dpDiv.find("."+this._dayOverClass+" a").mouseover();var r=this._getNumberOfMonths(e),i=r[1],s=17;e.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),i>1&&e.dpDiv.addClass("ui-datepicker-multi-"+i).css("width",s*i+"em"),e.dpDiv[(r[0]!=1||r[1]!=1?"add":"remove")+"Class"]("ui-datepicker-multi"),e.dpDiv[(this._get(e,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),e==$.datepicker._curInst&&$.datepicker._datepickerShowing&&e.input&&e.input.is(":visible")&&!e.input.is(":disabled")&&e.input[0]!=document.activeElement&&e.input.focus();if(e.yearshtml){var o=e.yearshtml;setTimeout(function(){o===e.yearshtml&&e.yearshtml&&e.dpDiv.find("select.ui-datepicker-year:first").replaceWith(e.yearshtml),o=e.yearshtml=null},0)}},_getBorders:function(e){var t=function(e){return{thin:1,medium:2,thick:3}[e]||e};return[parseFloat(t(e.css("border-left-width"))),parseFloat(t(e.css("border-top-width")))]},_checkOffset:function(e,t,n){var r=e.dpDiv.outerWidth(),i=e.dpDiv.outerHeight(),s=e.input?e.input.outerWidth():0,o=e.input?e.input.outerHeight():0,u=document.documentElement.clientWidth+(n?0:$(document).scrollLeft()),a=document.documentElement.clientHeight+(n?0:$(document).scrollTop());return t.left-=this._get(e,"isRTL")?r-s:0,t.left-=n&&t.left==e.input.offset().left?$(document).scrollLeft():0,t.top-=n&&t.top==e.input.offset().top+o?$(document).scrollTop():0,t.left-=Math.min(t.left,t.left+r>u&&u>r?Math.abs(t.left+r-u):0),t.top-=Math.min(t.top,t.top+i>a&&a>i?Math.abs(i+o):0),t},_findPos:function(e){var t=this._getInst(e),n=this._get(t,"isRTL");while(e&&(e.type=="hidden"||e.nodeType!=1||$.expr.filters.hidden(e)))e=e[n?"previousSibling":"nextSibling"];var r=$(e).offset();return[r.left,r.top]},_hideDatepicker:function(e){var t=this._curInst;if(!t||e&&t!=$.data(e,PROP_NAME))return;if(this._datepickerShowing){var n=this._get(t,"showAnim"),r=this._get(t,"duration"),i=function(){$.datepicker._tidyDialog(t)};$.effects&&($.effects.effect[n]||$.effects[n])?t.dpDiv.hide(n,$.datepicker._get(t,"showOptions"),r,i):t.dpDiv[n=="slideDown"?"slideUp":n=="fadeIn"?"fadeOut":"hide"](n?r:null,i),n||i(),this._datepickerShowing=!1;var s=this._get(t,"onClose");s&&s.apply(t.input?t.input[0]:null,[t.input?t.input.val():"",t]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1}},_tidyDialog:function(e){e.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(e){if(!$.datepicker._curInst)return;var t=$(e.target),n=$.datepicker._getInst(t[0]);(t[0].id!=$.datepicker._mainDivId&&t.parents("#"+$.datepicker._mainDivId).length==0&&!t.hasClass($.datepicker.markerClassName)&&!t.closest("."+$.datepicker._triggerClass).length&&$.datepicker._datepickerShowing&&(!$.datepicker._inDialog||!$.blockUI)||t.hasClass($.datepicker.markerClassName)&&$.datepicker._curInst!=n)&&$.datepicker._hideDatepicker()},_adjustDate:function(e,t,n){var r=$(e),i=this._getInst(r[0]);if(this._isDisabledDatepicker(r[0]))return;this._adjustInstDate(i,t+(n=="M"?this._get(i,"showCurrentAtPos"):0),n),this._updateDatepicker(i)},_gotoToday:function(e){var t=$(e),n=this._getInst(t[0]);if(this._get(n,"gotoCurrent")&&n.currentDay)n.selectedDay=n.currentDay,n.drawMonth=n.selectedMonth=n.currentMonth,n.drawYear=n.selectedYear=n.currentYear;else{var r=new Date;n.selectedDay=r.getDate(),n.drawMonth=n.selectedMonth=r.getMonth(),n.drawYear=n.selectedYear=r.getFullYear()}this._notifyChange(n),this._adjustDate(t)},_selectMonthYear:function(e,t,n){var r=$(e),i=this._getInst(r[0]);i["selected"+(n=="M"?"Month":"Year")]=i["draw"+(n=="M"?"Month":"Year")]=parseInt(t.options[t.selectedIndex].value,10),this._notifyChange(i),this._adjustDate(r)},_selectDay:function(e,t,n,r){var i=$(e);if($(r).hasClass(this._unselectableClass)||this._isDisabledDatepicker(i[0]))return;var s=this._getInst(i[0]);s.selectedDay=s.currentDay=$("a",r).html(),s.selectedMonth=s.currentMonth=t,s.selectedYear=s.currentYear=n,this._selectDate(e,this._formatDate(s,s.currentDay,s.currentMonth,s.currentYear))},_clearDate:function(e){var t=$(e),n=this._getInst(t[0]);this._selectDate(t,"")},_selectDate:function(e,t){var n=$(e),r=this._getInst(n[0]);t=t!=null?t:this._formatDate(r),r.input&&r.input.val(t),this._updateAlternate(r);var i=this._get(r,"onSelect");i?i.apply(r.input?r.input[0]:null,[t,r]):r.input&&r.input.trigger("change"),r.inline?this._updateDatepicker(r):(this._hideDatepicker(),this._lastInput=r.input[0],typeof r.input[0]!="object"&&r.input.focus(),this._lastInput=null)},_updateAlternate:function(e){var t=this._get(e,"altField");if(t){var n=this._get(e,"altFormat")||this._get(e,"dateFormat"),r=this._getDate(e),i=this.formatDate(n,r,this._getFormatConfig(e));$(t).each(function(){$(this).val(i)})}},noWeekends:function(e){var t=e.getDay();return[t>0&&t<6,""]},iso8601Week:function(e){var t=new Date(e.getTime());t.setDate(t.getDate()+4-(t.getDay()||7));var n=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((n-t)/864e5)/7)+1},parseDate:function(e,t,n){if(e==null||t==null)throw"Invalid arguments";t=typeof t=="object"?t.toString():t+"";if(t=="")return null;var r=(n?n.shortYearCutoff:null)||this._defaults.shortYearCutoff;r=typeof r!="string"?r:(new Date).getFullYear()%100+parseInt(r,10);var i=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,s=(n?n.dayNames:null)||this._defaults.dayNames,o=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,u=(n?n.monthNames:null)||this._defaults.monthNames,a=-1,f=-1,l=-1,c=-1,h=!1,p=function(t){var n=y+1<e.length&&e.charAt(y+1)==t;return n&&y++,n},d=function(e){var n=p(e),r=e=="@"?14:e=="!"?20:e=="y"&&n?4:e=="o"?3:2,i=new RegExp("^\\d{1,"+r+"}"),s=t.substring(g).match(i);if(!s)throw"Missing number at position "+g;return g+=s[0].length,parseInt(s[0],10)},v=function(e,n,r){var i=$.map(p(e)?r:n,function(e,t){return[[t,e]]}).sort(function(e,t){return-(e[1].length-t[1].length)}),s=-1;$.each(i,function(e,n){var r=n[1];if(t.substr(g,r.length).toLowerCase()==r.toLowerCase())return s=n[0],g+=r.length,!1});if(s!=-1)return s+1;throw"Unknown name at position "+g},m=function(){if(t.charAt(g)!=e.charAt(y))throw"Unexpected literal at position "+g;g++},g=0;for(var y=0;y<e.length;y++)if(h)e.charAt(y)=="'"&&!p("'")?h=!1:m();else switch(e.charAt(y)){case"d":l=d("d");break;case"D":v("D",i,s);break;case"o":c=d("o");break;case"m":f=d("m");break;case"M":f=v("M",o,u);break;case"y":a=d("y");break;case"@":var b=new Date(d("@"));a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();break;case"!":var b=new Date((d("!")-this._ticksTo1970)/1e4);a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();break;case"'":p("'")?m():h=!0;break;default:m()}if(g<t.length){var w=t.substr(g);if(!/^\s+/.test(w))throw"Extra/unparsed characters found in date: "+w}a==-1?a=(new Date).getFullYear():a<100&&(a+=(new Date).getFullYear()-(new Date).getFullYear()%100+(a<=r?0:-100));if(c>-1){f=1,l=c;do{var E=this._getDaysInMonth(a,f-1);if(l<=E)break;f++,l-=E}while(!0)}var b=this._daylightSavingAdjust(new Date(a,f-1,l));if(b.getFullYear()!=a||b.getMonth()+1!=f||b.getDate()!=l)throw"Invalid date";return b},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*24*60*60*1e7,formatDate:function(e,t,n){if(!t)return"";var r=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,i=(n?n.dayNames:null)||this._defaults.dayNames,s=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,o=(n?n.monthNames:null)||this._defaults.monthNames,u=function(t){var n=h+1<e.length&&e.charAt(h+1)==t;return n&&h++,n},a=function(e,t,n){var r=""+t;if(u(e))while(r.length<n)r="0"+r;return r},f=function(e,t,n,r){return u(e)?r[t]:n[t]},l="",c=!1;if(t)for(var h=0;h<e.length;h++)if(c)e.charAt(h)=="'"&&!u("'")?c=!1:l+=e.charAt(h);else switch(e.charAt(h)){case"d":l+=a("d",t.getDate(),2);break;case"D":l+=f("D",t.getDay(),r,i);break;case"o":l+=a("o",Math.round(((new Date(t.getFullYear(),t.getMonth(),t.getDate())).getTime()-(new Date(t.getFullYear(),0,0)).getTime())/864e5),3);break;case"m":l+=a("m",t.getMonth()+1,2);break;case"M":l+=f("M",t.getMonth(),s,o);break;case"y":l+=u("y")?t.getFullYear():(t.getYear()%100<10?"0":"")+t.getYear()%100;break;case"@":l+=t.getTime();break;case"!":l+=t.getTime()*1e4+this._ticksTo1970;break;case"'":u("'")?l+="'":c=!0;break;default:l+=e.charAt(h)}return l},_possibleChars:function(e){var t="",n=!1,r=function(t){var n=i+1<e.length&&e.charAt(i+1)==t;return n&&i++,n};for(var i=0;i<e.length;i++)if(n)e.charAt(i)=="'"&&!r("'")?n=!1:t+=e.charAt(i);else switch(e.charAt(i)){case"d":case"m":case"y":case"@":t+="0123456789";break;case"D":case"M":return null;case"'":r("'")?t+="'":n=!0;break;default:t+=e.charAt(i)}return t},_get:function(e,t){return e.settings[t]!==undefined?e.settings[t]:this._defaults[t]},_setDateFromField:function(e,t){if(e.input.val()==e.lastVal)return;var n=this._get(e,"dateFormat"),r=e.lastVal=e.input?e.input.val():null,i,s;i=s=this._getDefaultDate(e);var o=this._getFormatConfig(e);try{i=this.parseDate(n,r,o)||s}catch(u){this.log(u),r=t?"":r}e.selectedDay=i.getDate(),e.drawMonth=e.selectedMonth=i.getMonth(),e.drawYear=e.selectedYear=i.getFullYear(),e.currentDay=r?i.getDate():0,e.currentMonth=r?i.getMonth():0,e.currentYear=r?i.getFullYear():0,this._adjustInstDate(e)},_getDefaultDate:function(e){return this._restrictMinMax(e,this._determineDate(e,this._get(e,"defaultDate"),new Date))},_determineDate:function(e,t,n){var r=function(e){var t=new Date;return t.setDate(t.getDate()+e),t},i=function(t){try{return $.datepicker.parseDate($.datepicker._get(e,"dateFormat"),t,$.datepicker._getFormatConfig(e))}catch(n){}var r=(t.toLowerCase().match(/^c/)?$.datepicker._getDate(e):null)||new Date,i=r.getFullYear(),s=r.getMonth(),o=r.getDate(),u=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,a=u.exec(t);while(a){switch(a[2]||"d"){case"d":case"D":o+=parseInt(a[1],10);break;case"w":case"W":o+=parseInt(a[1],10)*7;break;case"m":case"M":s+=parseInt(a[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s));break;case"y":case"Y":i+=parseInt(a[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s))}a=u.exec(t)}return new Date(i,s,o)},s=t==null||t===""?n:typeof t=="string"?i(t):typeof t=="number"?isNaN(t)?n:r(t):new Date(t.getTime());return s=s&&s.toString()=="Invalid Date"?n:s,s&&(s.setHours(0),s.setMinutes(0),s.setSeconds(0),s.setMilliseconds(0)),this._daylightSavingAdjust(s)},_daylightSavingAdjust:function(e){return e?(e.setHours(e.getHours()>12?e.getHours()+2:0),e):null},_setDate:function(e,t,n){var r=!t,i=e.selectedMonth,s=e.selectedYear,o=this._restrictMinMax(e,this._determineDate(e,t,new Date));e.selectedDay=e.currentDay=o.getDate(),e.drawMonth=e.selectedMonth=e.currentMonth=o.getMonth(),e.drawYear=e.selectedYear=e.currentYear=o.getFullYear(),(i!=e.selectedMonth||s!=e.selectedYear)&&!n&&this._notifyChange(e),this._adjustInstDate(e),e.input&&e.input.val(r?"":this._formatDate(e))},_getDate:function(e){var t=!e.currentYear||e.input&&e.input.val()==""?null:this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));return t},_attachHandlers:function(e){var t=this._get(e,"stepMonths"),n="#"+e.id.replace(/\\\\/g,"\\");e.dpDiv.find("[data-handler]").map(function(){var e={prev:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,-t,"M")},next:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,+t,"M")},hide:function(){window["DP_jQuery_"+dpuuid].datepicker._hideDatepicker()},today:function(){window["DP_jQuery_"+dpuuid].datepicker._gotoToday(n)},selectDay:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectDay(n,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"M"),!1},selectYear:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"Y"),!1}};$(this).bind(this.getAttribute("data-event"),e[this.getAttribute("data-handler")])})},_generateHTML:function(e){var t=new Date;t=this._daylightSavingAdjust(new Date(t.getFullYear(),t.getMonth(),t.getDate()));var n=this._get(e,"isRTL"),r=this._get(e,"showButtonPanel"),i=this._get(e,"hideIfNoPrevNext"),s=this._get(e,"navigationAsDateFormat"),o=this._getNumberOfMonths(e),u=this._get(e,"showCurrentAtPos"),a=this._get(e,"stepMonths"),f=o[0]!=1||o[1]!=1,l=this._daylightSavingAdjust(e.currentDay?new Date(e.currentYear,e.currentMonth,e.currentDay):new Date(9999,9,9)),c=this._getMinMaxDate(e,"min"),h=this._getMinMaxDate(e,"max"),p=e.drawMonth-u,d=e.drawYear;p<0&&(p+=12,d--);if(h){var v=this._daylightSavingAdjust(new Date(h.getFullYear(),h.getMonth()-o[0]*o[1]+1,h.getDate()));v=c&&v<c?c:v;while(this._daylightSavingAdjust(new Date(d,p,1))>v)p--,p<0&&(p=11,d--)}e.drawMonth=p,e.drawYear=d;var m=this._get(e,"prevText");m=s?this.formatDate(m,this._daylightSavingAdjust(new Date(d,p-a,1)),this._getFormatConfig(e)):m;var g=this._canAdjustMonth(e,-1,d,p)?'<a class="ui-datepicker-prev ui-corner-all" data-handler="prev" data-event="click" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>":i?"":'<a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>",y=this._get(e,"nextText");y=s?this.formatDate(y,this._daylightSavingAdjust(new Date(d,p+a,1)),this._getFormatConfig(e)):y;var b=this._canAdjustMonth(e,1,d,p)?'<a class="ui-datepicker-next ui-corner-all" data-handler="next" data-event="click" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>":i?"":'<a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>",w=this._get(e,"currentText"),E=this._get(e,"gotoCurrent")&&e.currentDay?l:t;w=s?this.formatDate(w,E,this._getFormatConfig(e)):w;var S=e.inline?"":'<button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" data-handler="hide" data-event="click">'+this._get(e,"closeText")+"</button>",x=r?'<div class="ui-datepicker-buttonpane ui-widget-content">'+(n?S:"")+(this._isInRange(e,E)?'<button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" data-handler="today" data-event="click">'+w+"</button>":"")+(n?"":S)+"</div>":"",T=parseInt(this._get(e,"firstDay"),10);T=isNaN(T)?0:T;var N=this._get(e,"showWeek"),C=this._get(e,"dayNames"),k=this._get(e,"dayNamesShort"),L=this._get(e,"dayNamesMin"),A=this._get(e,"monthNames"),O=this._get(e,"monthNamesShort"),M=this._get(e,"beforeShowDay"),_=this._get(e,"showOtherMonths"),D=this._get(e,"selectOtherMonths"),P=this._get(e,"calculateWeek")||this.iso8601Week,H=this._getDefaultDate(e),B="";for(var j=0;j<o[0];j++){var F="";this.maxRows=4;for(var I=0;I<o[1];I++){var q=this._daylightSavingAdjust(new Date(d,p,e.selectedDay)),R=" ui-corner-all",U="";if(f){U+='<div class="ui-datepicker-group';if(o[1]>1)switch(I){case 0:U+=" ui-datepicker-group-first",R=" ui-corner-"+(n?"right":"left");break;case o[1]-1:U+=" ui-datepicker-group-last",R=" ui-corner-"+(n?"left":"right");break;default:U+=" ui-datepicker-group-middle",R=""}U+='">'}U+='<div class="ui-datepicker-header ui-widget-header ui-helper-clearfix'+R+'">'+(/all|left/.test(R)&&j==0?n?b:g:"")+(/all|right/.test(R)&&j==0?n?g:b:"")+this._generateMonthYearHeader(e,p,d,c,h,j>0||I>0,A,O)+'</div><table class="ui-datepicker-calendar"><thead>'+"<tr>";var z=N?'<th class="ui-datepicker-week-col">'+this._get(e,"weekHeader")+"</th>":"";for(var W=0;W<7;W++){var X=(W+T)%7;z+="<th"+((W+T+6)%7>=5?' class="ui-datepicker-week-end"':"")+">"+'<span title="'+C[X]+'">'+L[X]+"</span></th>"}U+=z+"</tr></thead><tbody>";var V=this._getDaysInMonth(d,p);d==e.selectedYear&&p==e.selectedMonth&&(e.selectedDay=Math.min(e.selectedDay,V));var J=(this._getFirstDayOfMonth(d,p)-T+7)%7,K=Math.ceil((J+V)/7),Q=f?this.maxRows>K?this.maxRows:K:K;this.maxRows=Q;var G=this._daylightSavingAdjust(new Date(d,p,1-J));for(var Y=0;Y<Q;Y++){U+="<tr>";var Z=N?'<td class="ui-datepicker-week-col">'+this._get(e,"calculateWeek")(G)+"</td>":"";for(var W=0;W<7;W++){var et=M?M.apply(e.input?e.input[0]:null,[G]):[!0,""],tt=G.getMonth()!=p,nt=tt&&!D||!et[0]||c&&G<c||h&&G>h;Z+='<td class="'+((W+T+6)%7>=5?" ui-datepicker-week-end":"")+(tt?" ui-datepicker-other-month":"")+(G.getTime()==q.getTime()&&p==e.selectedMonth&&e._keyEvent||H.getTime()==G.getTime()&&H.getTime()==q.getTime()?" "+this._dayOverClass:"")+(nt?" "+this._unselectableClass+" ui-state-disabled":"")+(tt&&!_?"":" "+et[1]+(G.getTime()==l.getTime()?" "+this._currentClass:"")+(G.getTime()==t.getTime()?" ui-datepicker-today":""))+'"'+((!tt||_)&&et[2]?' title="'+et[2]+'"':"")+(nt?"":' data-handler="selectDay" data-event="click" data-month="'+G.getMonth()+'" data-year="'+G.getFullYear()+'"')+">"+(tt&&!_?"&#xa0;":nt?'<span class="ui-state-default">'+G.getDate()+"</span>":'<a class="ui-state-default'+(G.getTime()==t.getTime()?" ui-state-highlight":"")+(G.getTime()==l.getTime()?" ui-state-active":"")+(tt?" ui-priority-secondary":"")+'" href="#">'+G.getDate()+"</a>")+"</td>",G.setDate(G.getDate()+1),G=this._daylightSavingAdjust(G)}U+=Z+"</tr>"}p++,p>11&&(p=0,d++),U+="</tbody></table>"+(f?"</div>"+(o[0]>0&&I==o[1]-1?'<div class="ui-datepicker-row-break"></div>':""):""),F+=U}B+=F}return B+=x+($.ui.ie6&&!e.inline?'<iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"></iframe>':""),e._keyEvent=!1,B},_generateMonthYearHeader:function(e,t,n,r,i,s,o,u){var a=this._get(e,"changeMonth"),f=this._get(e,"changeYear"),l=this._get(e,"showMonthAfterYear"),c='<div class="ui-datepicker-title">',h="";if(s||!a)h+='<span class="ui-datepicker-month">'+o[t]+"</span>";else{var p=r&&r.getFullYear()==n,d=i&&i.getFullYear()==n;h+='<select class="ui-datepicker-month" data-handler="selectMonth" data-event="change">';for(var v=0;v<12;v++)(!p||v>=r.getMonth())&&(!d||v<=i.getMonth())&&(h+='<option value="'+v+'"'+(v==t?' selected="selected"':"")+">"+u[v]+"</option>");h+="</select>"}l||(c+=h+(s||!a||!f?"&#xa0;":""));if(!e.yearshtml){e.yearshtml="";if(s||!f)c+='<span class="ui-datepicker-year">'+n+"</span>";else{var m=this._get(e,"yearRange").split(":"),g=(new Date).getFullYear(),y=function(e){var t=e.match(/c[+-].*/)?n+parseInt(e.substring(1),10):e.match(/[+-].*/)?g+parseInt(e,10):parseInt(e,10);return isNaN(t)?g:t},b=y(m[0]),w=Math.max(b,y(m[1]||""));b=r?Math.max(b,r.getFullYear()):b,w=i?Math.min(w,i.getFullYear()):w,e.yearshtml+='<select class="ui-datepicker-year" data-handler="selectYear" data-event="change">';for(;b<=w;b++)e.yearshtml+='<option value="'+b+'"'+(b==n?' selected="selected"':"")+">"+b+"</option>";e.yearshtml+="</select>",c+=e.yearshtml,e.yearshtml=null}}return c+=this._get(e,"yearSuffix"),l&&(c+=(s||!a||!f?"&#xa0;":"")+h),c+="</div>",c},_adjustInstDate:function(e,t,n){var r=e.drawYear+(n=="Y"?t:0),i=e.drawMonth+(n=="M"?t:0),s=Math.min(e.selectedDay,this._getDaysInMonth(r,i))+(n=="D"?t:0),o=this._restrictMinMax(e,this._daylightSavingAdjust(new Date(r,i,s)));e.selectedDay=o.getDate(),e.drawMonth=e.selectedMonth=o.getMonth(),e.drawYear=e.selectedYear=o.getFullYear(),(n=="M"||n=="Y")&&this._notifyChange(e)},_restrictMinMax:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max"),i=n&&t<n?n:t;return i=r&&i>r?r:i,i},_notifyChange:function(e){var t=this._get(e,"onChangeMonthYear");t&&t.apply(e.input?e.input[0]:null,[e.selectedYear,e.selectedMonth+1,e])},_getNumberOfMonths:function(e){var t=this._get(e,"numberOfMonths");return t==null?[1,1]:typeof t=="number"?[1,t]:t},_getMinMaxDate:function(e,t){return this._determineDate(e,this._get(e,t+"Date"),null)},_getDaysInMonth:function(e,t){return 32-this._daylightSavingAdjust(new Date(e,t,32)).getDate()},_getFirstDayOfMonth:function(e,t){return(new Date(e,t,1)).getDay()},_canAdjustMonth:function(e,t,n,r){var i=this._getNumberOfMonths(e),s=this._daylightSavingAdjust(new Date(n,r+(t<0?t:i[0]*i[1]),1));return t<0&&s.setDate(this._getDaysInMonth(s.getFullYear(),s.getMonth())),this._isInRange(e,s)},_isInRange:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max");return(!n||t.getTime()>=n.getTime())&&(!r||t.getTime()<=r.getTime())},_getFormatConfig:function(e){var t=this._get(e,"shortYearCutoff");return t=typeof t!="string"?t:(new Date).getFullYear()%100+parseInt(t,10),{shortYearCutoff:t,dayNamesShort:this._get(e,"dayNamesShort"),dayNames:this._get(e,"dayNames"),monthNamesShort:this._get(e,"monthNamesShort"),monthNames:this._get(e,"monthNames")}},_formatDate:function(e,t,n,r){t||(e.currentDay=e.selectedDay,e.currentMonth=e.selectedMonth,e.currentYear=e.selectedYear);var i=t?typeof t=="object"?t:this._daylightSavingAdjust(new Date(r,n,t)):this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));return this.formatDate(this._get(e,"dateFormat"),i,this._getFormatConfig(e))}}),$.fn.datepicker=function(e){if(!this.length)return this;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick).find(document.body).append($.datepicker.dpDiv),$.datepicker.initialized=!0);var t=Array.prototype.slice.call(arguments,1);return typeof e!="string"||e!="isDisabled"&&e!="getDate"&&e!="widget"?e=="option"&&arguments.length==2&&typeof arguments[1]=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t)):this.each(function(){typeof e=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this].concat(t)):$.datepicker._attachDatepicker(this,e)}):$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.9.1",window["DP_jQuery_"+dpuuid]=$})(jQuery);jQuery.effects||function(e,t){var n=e.uiBackCompat!==!1,r="ui-effects-";e.effects={effect:{}},function(t,n){function p(e,t,n){var r=a[t.type]||{};return e==null?n||!t.def?null:t.def:(e=r.floor?~~e:parseFloat(e),isNaN(e)?t.def:r.mod?(e+r.mod)%r.mod:0>e?0:r.max<e?r.max:e)}function d(e){var n=o(),r=n._rgba=[];return e=e.toLowerCase(),h(s,function(t,i){var s,o=i.re.exec(e),a=o&&i.parse(o),f=i.space||"rgba";if(a)return s=n[f](a),n[u[f].cache]=s[u[f].cache],r=n._rgba=s._rgba,!1}),r.length?(r.join()==="0,0,0,0"&&t.extend(r,c.transparent),n):c[e]}function v(e,t,n){return n=(n+1)%1,n*6<1?e+(t-e)*n*6:n*2<1?t:n*3<2?e+(t-e)*(2/3-n)*6:e}var r="backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor".split(" "),i=/^([\-+])=\s*(\d+\.?\d*)/,s=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1]*2.55,e[2]*2.55,e[3]*2.55,e[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(e){return[e[1],e[2]/100,e[3]/100,e[4]]}}],o=t.Color=function(e,n,r,i){return new t.Color.fn.parse(e,n,r,i)},u={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},a={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},f=o.support={},l=t("<p>")[0],c,h=t.each;l.style.cssText="background-color:rgba(1,1,1,.5)",f.rgba=l.style.backgroundColor.indexOf("rgba")>-1,h(u,function(e,t){t.cache="_"+e,t.props.alpha={idx:3,type:"percent",def:1}}),o.fn=t.extend(o.prototype,{parse:function(r,i,s,a){if(r===n)return this._rgba=[null,null,null,null],this;if(r.jquery||r.nodeType)r=t(r).css(i),i=n;var f=this,l=t.type(r),v=this._rgba=[];i!==n&&(r=[r,i,s,a],l="array");if(l==="string")return this.parse(d(r)||c._default);if(l==="array")return h(u.rgba.props,function(e,t){v[t.idx]=p(r[t.idx],t)}),this;if(l==="object")return r instanceof o?h(u,function(e,t){r[t.cache]&&(f[t.cache]=r[t.cache].slice())}):h(u,function(t,n){var i=n.cache;h(n.props,function(e,t){if(!f[i]&&n.to){if(e==="alpha"||r[e]==null)return;f[i]=n.to(f._rgba)}f[i][t.idx]=p(r[e],t,!0)}),f[i]&&e.inArray(null,f[i].slice(0,3))<0&&(f[i][3]=1,n.from&&(f._rgba=n.from(f[i])))}),this},is:function(e){var t=o(e),n=!0,r=this;return h(u,function(e,i){var s,o=t[i.cache];return o&&(s=r[i.cache]||i.to&&i.to(r._rgba)||[],h(i.props,function(e,t){if(o[t.idx]!=null)return n=o[t.idx]===s[t.idx],n})),n}),n},_space:function(){var e=[],t=this;return h(u,function(n,r){t[r.cache]&&e.push(n)}),e.pop()},transition:function(e,t){var n=o(e),r=n._space(),i=u[r],s=this.alpha()===0?o("transparent"):this,f=s[i.cache]||i.to(s._rgba),l=f.slice();return n=n[i.cache],h(i.props,function(e,r){var i=r.idx,s=f[i],o=n[i],u=a[r.type]||{};if(o===null)return;s===null?l[i]=o:(u.mod&&(o-s>u.mod/2?s+=u.mod:s-o>u.mod/2&&(s-=u.mod)),l[i]=p((o-s)*t+s,r))}),this[r](l)},blend:function(e){if(this._rgba[3]===1)return this;var n=this._rgba.slice(),r=n.pop(),i=o(e)._rgba;return o(t.map(n,function(e,t){return(1-r)*i[t]+r*e}))},toRgbaString:function(){var e="rgba(",n=t.map(this._rgba,function(e,t){return e==null?t>2?1:0:e});return n[3]===1&&(n.pop(),e="rgb("),e+n.join()+")"},toHslaString:function(){var e="hsla(",n=t.map(this.hsla(),function(e,t){return e==null&&(e=t>2?1:0),t&&t<3&&(e=Math.round(e*100)+"%"),e});return n[3]===1&&(n.pop(),e="hsl("),e+n.join()+")"},toHexString:function(e){var n=this._rgba.slice(),r=n.pop();return e&&n.push(~~(r*255)),"#"+t.map(n,function(e){return e=(e||0).toString(16),e.length===1?"0"+e:e}).join("")},toString:function(){return this._rgba[3]===0?"transparent":this.toRgbaString()}}),o.fn.parse.prototype=o.fn,u.hsla.to=function(e){if(e[0]==null||e[1]==null||e[2]==null)return[null,null,null,e[3]];var t=e[0]/255,n=e[1]/255,r=e[2]/255,i=e[3],s=Math.max(t,n,r),o=Math.min(t,n,r),u=s-o,a=s+o,f=a*.5,l,c;return o===s?l=0:t===s?l=60*(n-r)/u+360:n===s?l=60*(r-t)/u+120:l=60*(t-n)/u+240,f===0||f===1?c=f:f<=.5?c=u/a:c=u/(2-a),[Math.round(l)%360,c,f,i==null?1:i]},u.hsla.from=function(e){if(e[0]==null||e[1]==null||e[2]==null)return[null,null,null,e[3]];var t=e[0]/360,n=e[1],r=e[2],i=e[3],s=r<=.5?r*(1+n):r+n-r*n,o=2*r-s;return[Math.round(v(o,s,t+1/3)*255),Math.round(v(o,s,t)*255),Math.round(v(o,s,t-1/3)*255),i]},h(u,function(e,r){var s=r.props,u=r.cache,a=r.to,f=r.from;o.fn[e]=function(e){a&&!this[u]&&(this[u]=a(this._rgba));if(e===n)return this[u].slice();var r,i=t.type(e),l=i==="array"||i==="object"?e:arguments,c=this[u].slice();return h(s,function(e,t){var n=l[i==="object"?e:t.idx];n==null&&(n=c[t.idx]),c[t.idx]=p(n,t)}),f?(r=o(f(c)),r[u]=c,r):o(c)},h(s,function(n,r){if(o.fn[n])return;o.fn[n]=function(s){var o=t.type(s),u=n==="alpha"?this._hsla?"hsla":"rgba":e,a=this[u](),f=a[r.idx],l;return o==="undefined"?f:(o==="function"&&(s=s.call(this,f),o=t.type(s)),s==null&&r.empty?this:(o==="string"&&(l=i.exec(s),l&&(s=f+parseFloat(l[2])*(l[1]==="+"?1:-1))),a[r.idx]=s,this[u](a)))}})}),h(r,function(e,n){t.cssHooks[n]={set:function(e,r){var i,s,u="";if(t.type(r)!=="string"||(i=d(r))){r=o(i||r);if(!f.rgba&&r._rgba[3]!==1){s=n==="backgroundColor"?e.parentNode:e;while((u===""||u==="transparent")&&s&&s.style)try{u=t.css(s,"backgroundColor"),s=s.parentNode}catch(a){}r=r.blend(u&&u!=="transparent"?u:"_default")}r=r.toRgbaString()}try{e.style[n]=r}catch(l){}}},t.fx.step[n]=function(e){e.colorInit||(e.start=o(e.elem,n),e.end=o(e.end),e.colorInit=!0),t.cssHooks[n].set(e.elem,e.start.transition(e.end,e.pos))}}),t.cssHooks.borderColor={expand:function(e){var t={};return h(["Top","Right","Bottom","Left"],function(n,r){t["border"+r+"Color"]=e}),t}},c=t.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(jQuery),function(){function i(){var t=this.ownerDocument.defaultView?this.ownerDocument.defaultView.getComputedStyle(this,null):this.currentStyle,n={},r,i;if(t&&t.length&&t[0]&&t[t[0]]){i=t.length;while(i--)r=t[i],typeof t[r]=="string"&&(n[e.camelCase(r)]=t[r])}else for(r in t)typeof t[r]=="string"&&(n[r]=t[r]);return n}function s(t,n){var i={},s,o;for(s in n)o=n[s],t[s]!==o&&!r[s]&&(e.fx.step[s]||!isNaN(parseFloat(o)))&&(i[s]=o);return i}var n=["add","remove","toggle"],r={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};e.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(t,n){e.fx.step[n]=function(e){if(e.end!=="none"&&!e.setAttr||e.pos===1&&!e.setAttr)jQuery.style(e.elem,n,e.end),e.setAttr=!0}}),e.effects.animateClass=function(t,r,o,u){var a=e.speed(r,o,u);return this.queue(function(){var r=e(this),o=r.attr("class")||"",u,f=a.children?r.find("*").andSelf():r;f=f.map(function(){var t=e(this);return{el:t,start:i.call(this)}}),u=function(){e.each(n,function(e,n){t[n]&&r[n+"Class"](t[n])})},u(),f=f.map(function(){return this.end=i.call(this.el[0]),this.diff=s(this.start,this.end),this}),r.attr("class",o),f=f.map(function(){var t=this,n=e.Deferred(),r=jQuery.extend({},a,{queue:!1,complete:function(){n.resolve(t)}});return this.el.animate(this.diff,r),n.promise()}),e.when.apply(e,f.get()).done(function(){u(),e.each(arguments,function(){var t=this.el;e.each(this.diff,function(e){t.css(e,"")})}),a.complete.call(r[0])})})},e.fn.extend({_addClass:e.fn.addClass,addClass:function(t,n,r,i){return n?e.effects.animateClass.call(this,{add:t},n,r,i):this._addClass(t)},_removeClass:e.fn.removeClass,removeClass:function(t,n,r,i){return n?e.effects.animateClass.call(this,{remove:t},n,r,i):this._removeClass(t)},_toggleClass:e.fn.toggleClass,toggleClass:function(n,r,i,s,o){return typeof r=="boolean"||r===t?i?e.effects.animateClass.call(this,r?{add:n}:{remove:n},i,s,o):this._toggleClass(n,r):e.effects.animateClass.call(this,{toggle:n},r,i,s)},switchClass:function(t,n,r,i,s){return e.effects.animateClass.call(this,{add:n,remove:t},r,i,s)}})}(),function(){function i(t,n,r,i){e.isPlainObject(t)&&(n=t,t=t.effect),t={effect:t},n==null&&(n={}),e.isFunction(n)&&(i=n,r=null,n={});if(typeof n=="number"||e.fx.speeds[n])i=r,r=n,n={};return e.isFunction(r)&&(i=r,r=null),n&&e.extend(t,n),r=r||n.duration,t.duration=e.fx.off?0:typeof r=="number"?r:r in e.fx.speeds?e.fx.speeds[r]:e.fx.speeds._default,t.complete=i||n.complete,t}function s(t){return!t||typeof t=="number"||e.fx.speeds[t]?!0:typeof t=="string"&&!e.effects.effect[t]?n&&e.effects[t]?!1:!0:!1}e.extend(e.effects,{version:"1.9.1",save:function(e,t){for(var n=0;n<t.length;n++)t[n]!==null&&e.data(r+t[n],e[0].style[t[n]])},restore:function(e,n){var i,s;for(s=0;s<n.length;s++)n[s]!==null&&(i=e.data(r+n[s]),i===t&&(i=""),e.css(n[s],i))},setMode:function(e,t){return t==="toggle"&&(t=e.is(":hidden")?"show":"hide"),t},getBaseline:function(e,t){var n,r;switch(e[0]){case"top":n=0;break;case"middle":n=.5;break;case"bottom":n=1;break;default:n=e[0]/t.height}switch(e[1]){case"left":r=0;break;case"center":r=.5;break;case"right":r=1;break;default:r=e[1]/t.width}return{x:r,y:n}},createWrapper:function(t){if(t.parent().is(".ui-effects-wrapper"))return t.parent();var n={width:t.outerWidth(!0),height:t.outerHeight(!0),"float":t.css("float")},r=e("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),i={width:t.width(),height:t.height()},s=document.activeElement;try{s.id}catch(o){s=document.body}return t.wrap(r),(t[0]===s||e.contains(t[0],s))&&e(s).focus(),r=t.parent(),t.css("position")==="static"?(r.css({position:"relative"}),t.css({position:"relative"})):(e.extend(n,{position:t.css("position"),zIndex:t.css("z-index")}),e.each(["top","left","bottom","right"],function(e,r){n[r]=t.css(r),isNaN(parseInt(n[r],10))&&(n[r]="auto")}),t.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),t.css(i),r.css(n).show()},removeWrapper:function(t){var n=document.activeElement;return t.parent().is(".ui-effects-wrapper")&&(t.parent().replaceWith(t),(t[0]===n||e.contains(t[0],n))&&e(n).focus()),t},setTransition:function(t,n,r,i){return i=i||{},e.each(n,function(e,n){var s=t.cssUnit(n);s[0]>0&&(i[n]=s[0]*r+s[1])}),i}}),e.fn.extend({effect:function(){function a(n){function u(){e.isFunction(i)&&i.call(r[0]),e.isFunction(n)&&n()}var r=e(this),i=t.complete,s=t.mode;(r.is(":hidden")?s==="hide":s==="show")?u():o.call(r[0],t,u)}var t=i.apply(this,arguments),r=t.mode,s=t.queue,o=e.effects.effect[t.effect],u=!o&&n&&e.effects[t.effect];return e.fx.off||!o&&!u?r?this[r](t.duration,t.complete):this.each(function(){t.complete&&t.complete.call(this)}):o?s===!1?this.each(a):this.queue(s||"fx",a):u.call(this,{options:t,duration:t.duration,callback:t.complete,mode:t.mode})},_show:e.fn.show,show:function(e){if(s(e))return this._show.apply(this,arguments);var t=i.apply(this,arguments);return t.mode="show",this.effect.call(this,t)},_hide:e.fn.hide,hide:function(e){if(s(e))return this._hide.apply(this,arguments);var t=i.apply(this,arguments);return t.mode="hide",this.effect.call(this,t)},__toggle:e.fn.toggle,toggle:function(t){if(s(t)||typeof t=="boolean"||e.isFunction(t))return this.__toggle.apply(this,arguments);var n=i.apply(this,arguments);return n.mode="toggle",this.effect.call(this,n)},cssUnit:function(t){var n=this.css(t),r=[];return e.each(["em","px","%","pt"],function(e,t){n.indexOf(t)>0&&(r=[parseFloat(n),t])}),r}})}(),function(){var t={};e.each(["Quad","Cubic","Quart","Quint","Expo"],function(e,n){t[n]=function(t){return Math.pow(t,e+2)}}),e.extend(t,{Sine:function(e){return 1-Math.cos(e*Math.PI/2)},Circ:function(e){return 1-Math.sqrt(1-e*e)},Elastic:function(e){return e===0||e===1?e:-Math.pow(2,8*(e-1))*Math.sin(((e-1)*80-7.5)*Math.PI/15)},Back:function(e){return e*e*(3*e-2)},Bounce:function(e){var t,n=4;while(e<((t=Math.pow(2,--n))-1)/11);return 1/Math.pow(4,3-n)-7.5625*Math.pow((t*3-2)/22-e,2)}}),e.each(t,function(t,n){e.easing["easeIn"+t]=n,e.easing["easeOut"+t]=function(e){return 1-n(1-e)},e.easing["easeInOut"+t]=function(e){return e<.5?n(e*2)/2:1-n(e*-2+2)/2}})}()}(jQuery);

(function ($) {

    $.extend($.ui, { timepicker: { version: "0.3.1"} });

    var PROP_NAME = 'timepicker',
        tpuuid = new Date().getTime();

    /* Time picker manager.
     Use the singleton instance of this class, $.timepicker, to interact with the time picker.
     Settings for (groups of) time pickers are maintained in an instance object,
     allowing multiple different settings on the same page. */

    function Timepicker() {
        this.debug = true; // Change this to true to start debugging
        this._curInst = null; // The current instance in use
        this._disabledInputs = []; // List of time picker inputs that have been disabled
        this._timepickerShowing = false; // True if the popup picker is showing , false if not
        this._inDialog = false; // True if showing within a "dialog", false if not
        this._dialogClass = 'ui-timepicker-dialog'; // The name of the dialog marker class
        this._mainDivId = 'ui-timepicker-div'; // The ID of the main timepicker division
        this._inlineClass = 'ui-timepicker-inline'; // The name of the inline marker class
        this._currentClass = 'ui-timepicker-current'; // The name of the current hour / minutes marker class
        this._dayOverClass = 'ui-timepicker-days-cell-over'; // The name of the day hover marker class

        this.regional = []; // Available regional settings, indexed by language code
        this.regional[''] = { // Default regional settings
            hourText: Messages.hourText,           // Display text for hours section
            minuteText: Messages.minuteText,       // Display text for minutes link
            amPmText: ['AM', 'PM'],     // Display text for AM PM
            closeButtonText: 'Done',        // Text for the confirmation button (ok button)
            nowButtonText: 'Now',           // Text for the now button
            deselectButtonText: 'Deselect'  // Text for the deselect button
        };
        this._defaults = { // Global defaults for all the time picker instances
            showOn: 'focus',    // 'focus' for popup on focus,
                                // 'button' for trigger button, or 'both' for either (not yet implemented)
            button: null,                   // 'button' element that will trigger the timepicker
            showAnim: 'fadeIn',             // Name of jQuery animation for popup
            showOptions: {},                // Options for enhanced animations
            appendText: '',                 // Display text following the input box, e.g. showing the format

            beforeShow: null,               // Define a callback function executed before the timepicker is shown
            onSelect: null,                 // Define a callback function when a hour / minutes is selected
            onClose: null,                  // Define a callback function when the timepicker is closed

            timeSeparator: ':',             // The character to use to separate hours and minutes.
            periodSeparator: ' ',           // The character to use to separate the time from the time period.
            showPeriod: false,              // Define whether or not to show AM/PM with selected time
            showPeriodLabels: true,         // Show the AM/PM labels on the left of the time picker
            showLeadingZero: true,          // Define whether or not to show a leading zero for hours < 10. [true/false]
            showMinutesLeadingZero: true,   // Define whether or not to show a leading zero for minutes < 10.
            altField: '',                   // Selector for an alternate field to store selected time into
            defaultTime: 'now',             // Used as default time when input field is empty or for inline timePicker
                                            // (set to 'now' for the current time, '' for no highlighted time)
            myPosition: 'left top',         // Position of the dialog relative to the input.
                                            // see the position utility for more info : http://jqueryui.com/demos/position/
            atPosition: 'left bottom',      // Position of the input element to match
                                            // Note : if the position utility is not loaded, the timepicker will attach left top to left bottom
            //NEW: 2011-02-03
            onHourShow: null,			    // callback for enabling / disabling on selectable hours  ex : function(hour) { return true; }
            onMinuteShow: null,             // callback for enabling / disabling on time selection  ex : function(hour,minute) { return true; }

            hours: {
                starts: 0,                  // first displayed hour
                ends: 23                    // last displayed hour
            },
            minutes: {
                starts: 0,                  // first displayed minute
                ends: 55,                   // last displayed minute
                interval: 5                 // interval of displayed minutes
            },
            rows: 4,                        // number of rows for the input tables, minimum 2, makes more sense if you use multiple of 2
            // 2011-08-05 0.2.4
            showHours: true,                // display the hours section of the dialog
            showMinutes: true,              // display the minute section of the dialog
            optionalMinutes: false,         // optionally parse inputs of whole hours with minutes omitted

            // buttons
            showCloseButton: false,         // shows an OK button to confirm the edit
            showNowButton: false,           // Shows the 'now' button
            showDeselectButton: false       // Shows the deselect time button

        };
        $.extend(this._defaults, this.regional['']);

        this.tpDiv = $('<div id="' + this._mainDivId + '" class="ui-timepicker ui-widget ui-helper-clearfix ui-corner-all " style="display: none"></div>');
    }

    $.extend(Timepicker.prototype, {
        /* Class name added to elements to indicate already configured with a time picker. */
        markerClassName: 'hasTimepicker',

        /* Debug logging (if enabled). */
        log: function () {
            if (this.debug)
                console.log.apply('', arguments);
        },

        _widgetTimepicker: function () {
            return this.tpDiv;
        },

        /* Override the default settings for all instances of the time picker.
         @param  settings  object - the new settings to use as defaults (anonymous object)
         @return the manager object */
        setDefaults: function (settings) {
            extendRemove(this._defaults, settings || {});
            return this;
        },

        /* Attach the time picker to a jQuery selection.
         @param  target    element - the target input field or division or span
         @param  settings  object - the new settings to use for this time picker instance (anonymous) */
        _attachTimepicker: function (target, settings) {
            // check for settings on the control itself - in namespace 'time:'
            var inlineSettings = null;
            for (var attrName in this._defaults) {
                var attrValue = target.getAttribute('time:' + attrName);
                if (attrValue) {
                    inlineSettings = inlineSettings || {};
                    try {
                        inlineSettings[attrName] = eval(attrValue);
                    } catch (err) {
                        inlineSettings[attrName] = attrValue;
                    }
                }
            }
            var nodeName = target.nodeName.toLowerCase();
            var inline = (nodeName == 'div' || nodeName == 'span');

            if (!target.id) {
                this.uuid += 1;
                target.id = 'tp' + this.uuid;
            }
            var inst = this._newInst($(target), inline);
            inst.settings = $.extend({}, settings || {}, inlineSettings || {});
            if (nodeName == 'input') {
                this._connectTimepicker(target, inst);
                // init inst.hours and inst.minutes from the input value
                this._setTimeFromField(inst);
            } else if (inline) {
                this._inlineTimepicker(target, inst);
            }


        },

        /* Create a new instance object. */
        _newInst: function (target, inline) {
            var id = target[0].id.replace(/([^A-Za-z0-9_-])/g, '\\\\$1'); // escape jQuery meta chars
            return {
                id: id, input: target, // associated target
                inline: inline, // is timepicker inline or not :
                tpDiv: (!inline ? this.tpDiv : // presentation div
                    $('<div class="' + this._inlineClass + ' ui-timepicker ui-widget  ui-helper-clearfix"></div>'))
            };
        },

        /* Attach the time picker to an input field. */
        _connectTimepicker: function (target, inst) {
            var input = $(target);
            inst.append = $([]);
            inst.trigger = $([]);
            if (input.hasClass(this.markerClassName)) { return; }
            this._attachments(input, inst);
            input.addClass(this.markerClassName).
                keydown(this._doKeyDown).
                keyup(this._doKeyUp).
                bind("setData.timepicker", function (event, key, value) {
                    inst.settings[key] = value;
                }).
                bind("getData.timepicker", function (event, key) {
                    return this._get(inst, key);
                });
            $.data(target, PROP_NAME, inst);
        },

        /* Handle keystrokes. */
        _doKeyDown: function (event) {
            var inst = $.timepicker._getInst(event.target);
            var handled = true;
            inst._keyEvent = true;
            if ($.timepicker._timepickerShowing) {
                switch (event.keyCode) {
                    case 9: $.timepicker._hideTimepicker();
                        handled = false;
                        break; // hide on tab out
                    case 13:
                        $.timepicker._updateSelectedValue(inst);
                        $.timepicker._hideTimepicker();

                        return false; // don't submit the form
                        break; // select the value on enter
                    case 27: $.timepicker._hideTimepicker();
                        break; // hide on escape
                    default: handled = false;
                }
            }
            else if (event.keyCode == 36 && event.ctrlKey) { // display the time picker on ctrl+home
                $.timepicker._showTimepicker(this);
            }
            else {
                handled = false;
            }
            if (handled) {
                event.preventDefault();
                event.stopPropagation();
            }
        },

        /* Update selected time on keyUp */
        /* Added verion 0.0.5 */
        _doKeyUp: function (event) {
            var inst = $.timepicker._getInst(event.target);
            $.timepicker._setTimeFromField(inst);
            $.timepicker._updateTimepicker(inst);
        },

        /* Make attachments based on settings. */
        _attachments: function (input, inst) {
            var appendText = this._get(inst, 'appendText');
            var isRTL = this._get(inst, 'isRTL');
            if (inst.append) { inst.append.remove(); }
            if (appendText) {
                inst.append = $('<span class="' + this._appendClass + '">' + appendText + '</span>');
                input[isRTL ? 'before' : 'after'](inst.append);
            }
            input.unbind('focus.timepicker', this._showTimepicker);
            input.unbind('click.timepicker', this._adjustZIndex);

            if (inst.trigger) { inst.trigger.remove(); }

            var showOn = this._get(inst, 'showOn');
            if (showOn == 'focus' || showOn == 'both') { // pop-up time picker when in the marked field
                input.bind("focus.timepicker", this._showTimepicker);
                input.bind("click.timepicker", this._adjustZIndex);
            }
            if (showOn == 'button' || showOn == 'both') { // pop-up time picker when 'button' element is clicked
                var button = this._get(inst, 'button');
                $(button).bind("click.timepicker", function () {
                    if ($.timepicker._timepickerShowing && $.timepicker._lastInput == input[0]) {
                        $.timepicker._hideTimepicker();
                    } else if (!inst.input.is(':disabled')) {
                        $.timepicker._showTimepicker(input[0]);
                    }
                    return false;
                });

            }
        },


        /* Attach an inline time picker to a div. */
        _inlineTimepicker: function(target, inst) {
            var divSpan = $(target);
            if (divSpan.hasClass(this.markerClassName))
                return;
            divSpan.addClass(this.markerClassName).append(inst.tpDiv).
                bind("setData.timepicker", function(event, key, value){
                    inst.settings[key] = value;
                }).bind("getData.timepicker", function(event, key){
                    return this._get(inst, key);
                });
            $.data(target, PROP_NAME, inst);

            this._setTimeFromField(inst);
            this._updateTimepicker(inst);
            inst.tpDiv.show();
        },

        _adjustZIndex: function(input) {
            input = input.target || input;
            var inst = $.timepicker._getInst(input);
            inst.tpDiv.css('zIndex', $.timepicker._getZIndex(input) +1);
        },

        /* Pop-up the time picker for a given input field.
         @param  input  element - the input field attached to the time picker or
         event - if triggered by focus */
        _showTimepicker: function (input) {
            input = input.target || input;
            if (input.nodeName.toLowerCase() != 'input') { input = $('input', input.parentNode)[0]; } // find from button/image trigger

            if ($.timepicker._isDisabledTimepicker(input) || $.timepicker._lastInput == input) { return; } // already here

            // fix v 0.0.8 - close current timepicker before showing another one
            $.timepicker._hideTimepicker();

            var inst = $.timepicker._getInst(input);
            if ($.timepicker._curInst && $.timepicker._curInst != inst) {
                $.timepicker._curInst.tpDiv.stop(true, true);
            }
            var beforeShow = $.timepicker._get(inst, 'beforeShow');
            extendRemove(inst.settings, (beforeShow ? beforeShow.apply(input, [input, inst]) : {}));
            inst.lastVal = null;
            $.timepicker._lastInput = input;

            $.timepicker._setTimeFromField(inst);

            // calculate default position
            if ($.timepicker._inDialog) { input.value = ''; } // hide cursor
            if (!$.timepicker._pos) { // position below input
                $.timepicker._pos = $.timepicker._findPos(input);
                $.timepicker._pos[1] += input.offsetHeight; // add the height
            }
            var isFixed = false;
            $(input).parents().each(function () {
                isFixed |= $(this).css('position') == 'fixed';
                return !isFixed;
            });
            if (isFixed && $.browser.opera) { // correction for Opera when fixed and scrolled
                $.timepicker._pos[0] -= document.documentElement.scrollLeft;
                $.timepicker._pos[1] -= document.documentElement.scrollTop;
            }

            var offset = { left: $.timepicker._pos[0], top: $.timepicker._pos[1] };

            $.timepicker._pos = null;
            // determine sizing offscreen
            inst.tpDiv.css({ position: 'absolute', display: 'block', top: '-1000px' });
            $.timepicker._updateTimepicker(inst);


            // position with the ui position utility, if loaded
            if ( ( ! inst.inline )  && ( typeof $.ui.position == 'object' ) ) {
                inst.tpDiv.position({
                    of: inst.input,
                    my: $.timepicker._get( inst, 'myPosition' ),
                    at: $.timepicker._get( inst, 'atPosition' ),
                    // offset: $( "#offset" ).val(),
                    // using: using,
                    collision: 'flip'
                });
                var offset = inst.tpDiv.offset();
                $.timepicker._pos = [offset.top, offset.left];
            }


            // reset clicked state
            inst._hoursClicked = false;
            inst._minutesClicked = false;

            // fix width for dynamic number of time pickers
            // and adjust position before showing
            offset = $.timepicker._checkOffset(inst, offset, isFixed);
            inst.tpDiv.css({ position: ($.timepicker._inDialog && $.blockUI ?
                'static' : (isFixed ? 'fixed' : 'absolute')), display: 'none',
                left: offset.left + 'px', top: offset.top + 'px'
            });
            if ( ! inst.inline ) {
                var showAnim = $.timepicker._get(inst, 'showAnim');
                var duration = $.timepicker._get(inst, 'duration');

                var postProcess = function () {
                    $.timepicker._timepickerShowing = true;
                    var borders = $.timepicker._getBorders(inst.tpDiv);
                    inst.tpDiv.find('iframe.ui-timepicker-cover'). // IE6- only
                        css({ left: -borders[0], top: -borders[1],
                            width: inst.tpDiv.outerWidth(), height: inst.tpDiv.outerHeight()
                        });
                };

                // Fixed the zIndex problem for real (I hope) - FG - v 0.2.9
                $.timepicker._adjustZIndex(input);
                //inst.tpDiv.css('zIndex', $.timepicker._getZIndex(input) +1);

                if ($.effects && $.effects[showAnim]) {
                    inst.tpDiv.show(showAnim, $.timepicker._get(inst, 'showOptions'), duration, postProcess);
                }
                else {
                    inst.tpDiv[showAnim || 'show']((showAnim ? duration : null), postProcess);
                }
                if (!showAnim || !duration) { postProcess(); }
                if (inst.input.is(':visible') && !inst.input.is(':disabled')) { inst.input.focus(); }
                $.timepicker._curInst = inst;
            }
        },

        // This is a copy of the zIndex function of UI core 1.8.??
        // Copied in the timepicker to stay backward compatible.
        _getZIndex: function (target) {
            var elem = $( target ), position, value;
            while ( elem.length && elem[ 0 ] !== document ) {
                position = elem.css( "position" );
                if ( position === "absolute" || position === "relative" || position === "fixed" ) {
                    value = parseInt( elem.css( "zIndex" ), 10 );
                    if ( !isNaN( value ) && value !== 0 ) {
                        return value;
                    }
                }
                elem = elem.parent();
            }
        },

        /* Refresh the time picker
         @param   target  element - The target input field or inline container element. */
        _refreshTimepicker: function(target) {
            var inst = this._getInst(target);
            if (inst) {
                this._updateTimepicker(inst);
            }
        },


        /* Generate the time picker content. */
        _updateTimepicker: function (inst) {
            inst.tpDiv.empty().append(this._generateHTML(inst));
            this._rebindDialogEvents(inst);

        },

        _rebindDialogEvents: function (inst) {
            var borders = $.timepicker._getBorders(inst.tpDiv),
                self = this;
            inst.tpDiv
                .find('iframe.ui-timepicker-cover') // IE6- only
                .css({ left: -borders[0], top: -borders[1],
                    width: inst.tpDiv.outerWidth(), height: inst.tpDiv.outerHeight()
                })
                .end()
                // after the picker html is appended bind the click & double click events (faster in IE this way
                // then letting the browser interpret the inline events)
                // the binding for the minute cells also exists in _updateMinuteDisplay
                .find('.ui-timepicker-minute-cell')
                .unbind()
                .bind("click", { fromDoubleClick:false }, $.proxy($.timepicker.selectMinutes, this))
                .bind("dblclick", { fromDoubleClick:true }, $.proxy($.timepicker.selectMinutes, this))
                .end()
                .find('.ui-timepicker-hour-cell')
                .unbind()
                .bind("click", { fromDoubleClick:false }, $.proxy($.timepicker.selectHours, this))
                .bind("dblclick", { fromDoubleClick:true }, $.proxy($.timepicker.selectHours, this))
                .end()
                .find('.ui-timepicker td a')
                .unbind()
                .bind('mouseout', function () {
                    $(this).removeClass('ui-state-hover');
                    if (this.className.indexOf('ui-timepicker-prev') != -1) $(this).removeClass('ui-timepicker-prev-hover');
                    if (this.className.indexOf('ui-timepicker-next') != -1) $(this).removeClass('ui-timepicker-next-hover');
                })
                .bind('mouseover', function () {
                    if ( ! self._isDisabledTimepicker(inst.inline ? inst.tpDiv.parent()[0] : inst.input[0])) {
                        $(this).parents('.ui-timepicker-calendar').find('a').removeClass('ui-state-hover');
                        $(this).addClass('ui-state-hover');
                        if (this.className.indexOf('ui-timepicker-prev') != -1) $(this).addClass('ui-timepicker-prev-hover');
                        if (this.className.indexOf('ui-timepicker-next') != -1) $(this).addClass('ui-timepicker-next-hover');
                    }
                })
                .end()
                .find('.' + this._dayOverClass + ' a')
                .trigger('mouseover')
                .end()
                .find('.ui-timepicker-now').bind("click", function(e) {
                    $.timepicker.selectNow(e);
                }).end()
                .find('.ui-timepicker-deselect').bind("click",function(e) {
                    $.timepicker.deselectTime(e);
                }).end()
                .find('.ui-timepicker-close').bind("click",function(e) {
                    $.timepicker._hideTimepicker();
                }).end();
        },

        /* Generate the HTML for the current state of the time picker. */
        _generateHTML: function (inst) {

            var h, m, row, col, html, hoursHtml, minutesHtml = '',
                showPeriod = (this._get(inst, 'showPeriod') == true),
                showPeriodLabels = (this._get(inst, 'showPeriodLabels') == true),
                showLeadingZero = (this._get(inst, 'showLeadingZero') == true),
                showHours = (this._get(inst, 'showHours') == true),
                showMinutes = (this._get(inst, 'showMinutes') == true),
                amPmText = this._get(inst, 'amPmText'),
                rows = this._get(inst, 'rows'),
                amRows = 0,
                pmRows = 0,
                amItems = 0,
                pmItems = 0,
                amFirstRow = 0,
                pmFirstRow = 0,
                hours = Array(),
                hours_options = this._get(inst, 'hours'),
                hoursPerRow = null,
                hourCounter = 0,
                hourLabel = this._get(inst, 'hourText'),
                showCloseButton = this._get(inst, 'showCloseButton'),
                closeButtonText = this._get(inst, 'closeButtonText'),
                showNowButton = this._get(inst, 'showNowButton'),
                nowButtonText = this._get(inst, 'nowButtonText'),
                showDeselectButton = this._get(inst, 'showDeselectButton'),
                deselectButtonText = this._get(inst, 'deselectButtonText'),
                showButtonPanel = showCloseButton || showNowButton || showDeselectButton;



            // prepare all hours and minutes, makes it easier to distribute by rows
            for (h = hours_options.starts; h <= hours_options.ends; h++) {
                hours.push (h);
            }
            hoursPerRow = Math.ceil(hours.length / rows); // always round up

            if (showPeriodLabels) {
                for (hourCounter = 0; hourCounter < hours.length; hourCounter++) {
                    if (hours[hourCounter] < 12) {
                        amItems++;
                    }
                    else {
                        pmItems++;
                    }
                }
                hourCounter = 0;

                amRows = Math.floor(amItems / hours.length * rows);
                pmRows = Math.floor(pmItems / hours.length * rows);

                // assign the extra row to the period that is more densly populated
                if (rows != amRows + pmRows) {
                    // Make sure: AM Has Items and either PM Does Not, AM has no rows yet, or AM is more dense
                    if (amItems && (!pmItems || !amRows || (pmRows && amItems / amRows >= pmItems / pmRows))) {
                        amRows++;
                    } else {
                        pmRows++;
                    }
                }
                amFirstRow = Math.min(amRows, 1);
                pmFirstRow = amRows + 1;
                hoursPerRow = Math.ceil(Math.max(amItems / amRows, pmItems / pmRows));
            }


            html = '<table class="ui-timepicker-table ui-widget-content ui-corner-all"><tr>';

            if (showHours) {

                html += '<td class="ui-timepicker-hours">' +
                    '<div class="ui-timepicker-title ui-widget-header ui-helper-clearfix ui-corner-all">' +
                    hourLabel +
                    '</div>' +
                    '<table class="ui-timepicker">';

                for (row = 1; row <= rows; row++) {
                    html += '<tr>';
                    // AM
                    if (row == amFirstRow && showPeriodLabels) {
                        html += '<th rowspan="' + amRows.toString() + '" class="periods" scope="row">' + amPmText[0] + '</th>';
                    }
                    // PM
                    if (row == pmFirstRow && showPeriodLabels) {
                        html += '<th rowspan="' + pmRows.toString() + '" class="periods" scope="row">' + amPmText[1] + '</th>';
                    }
                    for (col = 1; col <= hoursPerRow; col++) {
                        if (showPeriodLabels && row < pmFirstRow && hours[hourCounter] >= 12) {
                            html += this._generateHTMLHourCell(inst, undefined, showPeriod, showLeadingZero);
                        } else {
                            html += this._generateHTMLHourCell(inst, hours[hourCounter], showPeriod, showLeadingZero);
                            hourCounter++;
                        }
                    }
                    html += '</tr>';
                }
                html += '</tr></table>' + // Close the hours cells table
                    '</td>';          // Close the Hour td
            }

            if (showMinutes) {
                html += '<td class="ui-timepicker-minutes">';
                html += this._generateHTMLMinutes(inst);
                html += '</td>';
            }

            html += '</tr>';


            if (showButtonPanel) {
                var buttonPanel = '<tr><td colspan="3"><div class="ui-timepicker-buttonpane ui-widget-content">';
                if (showNowButton) {
                    buttonPanel += '<button type="button" class="ui-timepicker-now ui-state-default ui-corner-all" '
                        + ' data-timepicker-instance-id="#' + inst.id.replace(/\\\\/g,"\\") + '" >'
                        + nowButtonText + '</button>';
                }
                if (showDeselectButton) {
                    buttonPanel += '<button type="button" class="ui-timepicker-deselect ui-state-default ui-corner-all" '
                        + ' data-timepicker-instance-id="#' + inst.id.replace(/\\\\/g,"\\") + '" >'
                        + deselectButtonText + '</button>';
                }
                if (showCloseButton) {
                    buttonPanel += '<button type="button" class="ui-timepicker-close ui-state-default ui-corner-all" '
                        + ' data-timepicker-instance-id="#' + inst.id.replace(/\\\\/g,"\\") + '" >'
                        + closeButtonText + '</button>';
                }

                html += buttonPanel + '</div></td></tr>';
            }
            html += '</table>';

            /* IE6 IFRAME FIX (taken from datepicker 1.5.3, fixed in 0.1.2 */
            html += ($.browser.msie && parseInt($.browser.version,10) < 7 && !inst.inline ?
                '<iframe src="javascript:false;" class="ui-timepicker-cover" frameborder="0"></iframe>' : '');

            return html;
        },

        /* Special function that update the minutes selection in currently visible timepicker
         * called on hour selection when onMinuteShow is defined  */
        _updateMinuteDisplay: function (inst) {
            var newHtml = this._generateHTMLMinutes(inst);
            inst.tpDiv.find('td.ui-timepicker-minutes').html(newHtml);
            this._rebindDialogEvents(inst);
            // after the picker html is appended bind the click & double click events (faster in IE this way
            // then letting the browser interpret the inline events)
            // yes I know, duplicate code, sorry
            /*                .find('.ui-timepicker-minute-cell')
             .bind("click", { fromDoubleClick:false }, $.proxy($.timepicker.selectMinutes, this))
             .bind("dblclick", { fromDoubleClick:true }, $.proxy($.timepicker.selectMinutes, this));
             */

        },

        /*
         * Generate the minutes table
         * This is separated from the _generateHTML function because is can be called separately (when hours changes)
         */
        _generateHTMLMinutes: function (inst) {

            var m, row, html = '',
                rows = this._get(inst, 'rows'),
                minutes = Array(),
                minutes_options = this._get(inst, 'minutes'),
                minutesPerRow = null,
                minuteCounter = 0,
                showMinutesLeadingZero = (this._get(inst, 'showMinutesLeadingZero') == true),
                onMinuteShow = this._get(inst, 'onMinuteShow'),
                minuteLabel = this._get(inst, 'minuteText');

            if ( ! minutes_options.starts) {
                minutes_options.starts = 0;
            }
            if ( ! minutes_options.ends) {
                minutes_options.ends = 59;
            }
            for (m = minutes_options.starts; m <= minutes_options.ends; m += minutes_options.interval) {
                minutes.push(m);
            }
            minutesPerRow = Math.round(minutes.length / rows + 0.49); // always round up

            /*
             * The minutes table
             */
            // if currently selected minute is not enabled, we have a problem and need to select a new minute.
            if (onMinuteShow &&
                (onMinuteShow.apply((inst.input ? inst.input[0] : null), [inst.hours , inst.minutes]) == false) ) {
                // loop minutes and select first available
                for (minuteCounter = 0; minuteCounter < minutes.length; minuteCounter += 1) {
                    m = minutes[minuteCounter];
                    if (onMinuteShow.apply((inst.input ? inst.input[0] : null), [inst.hours, m])) {
                        inst.minutes = m;
                        break;
                    }
                }
            }



            html += '<div class="ui-timepicker-title ui-widget-header ui-helper-clearfix ui-corner-all">' +
                minuteLabel +
                '</div>' +
                '<table class="ui-timepicker">';

            minuteCounter = 0;
            for (row = 1; row <= rows; row++) {
                html += '<tr>';
                while (minuteCounter < row * minutesPerRow) {
                    var m = minutes[minuteCounter];
                    var displayText = '';
                    if (m !== undefined ) {
                        displayText = (m < 10) && showMinutesLeadingZero ? "0" + m.toString() : m.toString();
                    }
                    html += this._generateHTMLMinuteCell(inst, m, displayText);
                    minuteCounter++;
                }
                html += '</tr>';
            }

            html += '</table>';

            return html;
        },

        /* Generate the content of a "Hour" cell */
        _generateHTMLHourCell: function (inst, hour, showPeriod, showLeadingZero) {

            var displayHour = hour;
            if ((hour > 12) && showPeriod) {
                displayHour = hour - 12;
            }
            if ((displayHour == 0) && showPeriod) {
                displayHour = 12;
            }
            if ((displayHour < 10) && showLeadingZero) {
                displayHour = '0' + displayHour;
            }

            var html = "";
            var enabled = true;
            var onHourShow = this._get(inst, 'onHourShow');		//custom callback

            if (hour == undefined) {
                html = '<td><span class="ui-state-default ui-state-disabled">&nbsp;</span></td>';
                return html;
            }

            if (onHourShow) {
                enabled = onHourShow.apply((inst.input ? inst.input[0] : null), [hour]);
            }

            if (enabled) {
                html = '<td class="ui-timepicker-hour-cell" data-timepicker-instance-id="#' + inst.id.replace(/\\\\/g,"\\") + '" data-hour="' + hour.toString() + '">' +
                    '<a class="ui-state-default ' +
                    (hour == inst.hours ? 'ui-state-active' : '') +
                    '">' +
                    displayHour.toString() +
                    '</a></td>';
            }
            else {
                html =
                    '<td>' +
                    '<span class="ui-state-default ui-state-disabled ' +
                    (hour == inst.hours ? ' ui-state-active ' : ' ') +
                    '">' +
                    displayHour.toString() +
                    '</span>' +
                    '</td>';
            }
            return html;
        },

        /* Generate the content of a "Hour" cell */
        _generateHTMLMinuteCell: function (inst, minute, displayText) {
            var html = "";
            var enabled = true;
            var onMinuteShow = this._get(inst, 'onMinuteShow');		//custom callback
            if (onMinuteShow) {
                //NEW: 2011-02-03  we should give the hour as a parameter as well!
                enabled = onMinuteShow.apply((inst.input ? inst.input[0] : null), [inst.hours,minute]);		//trigger callback
            }

            if (minute == undefined) {
                html = '<td><span class="ui-state-default ui-state-disabled">&nbsp;</span></td>';
                return html;
            }

            if (enabled) {
                html = '<td class="ui-timepicker-minute-cell" data-timepicker-instance-id="#' + inst.id.replace(/\\\\/g,"\\") + '" data-minute="' + minute.toString() + '" >' +
                    '<a class="ui-state-default ' +
                    (minute == inst.minutes ? 'ui-state-active' : '') +
                    '" >' +
                    displayText +
                    '</a></td>';
            }
            else {

                html = '<td>' +
                    '<span class="ui-state-default ui-state-disabled" >' +
                    displayText +
                    '</span>' +
                    '</td>';
            }
            return html;
        },


        /* Detach a timepicker from its control.
         @param  target    element - the target input field or division or span */
        _destroyTimepicker: function(target) {
            var $target = $(target);
            var inst = $.data(target, PROP_NAME);
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            var nodeName = target.nodeName.toLowerCase();
            $.removeData(target, PROP_NAME);
            if (nodeName == 'input') {
                inst.append.remove();
                inst.trigger.remove();
                $target.removeClass(this.markerClassName)
                    .unbind('focus.timepicker', this._showTimepicker)
                    .unbind('click.timepicker', this._adjustZIndex);
            } else if (nodeName == 'div' || nodeName == 'span')
                $target.removeClass(this.markerClassName).empty();
        },

        /* Enable the date picker to a jQuery selection.
         @param  target    element - the target input field or division or span */
        _enableTimepicker: function(target) {
            var $target = $(target),
                target_id = $target.attr('id'),
                inst = $.data(target, PROP_NAME);

            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            var nodeName = target.nodeName.toLowerCase();
            if (nodeName == 'input') {
                target.disabled = false;
                var button = this._get(inst, 'button');
                $(button).removeClass('ui-state-disabled').disabled = false;
                inst.trigger.filter('button').
                    each(function() { this.disabled = false; }).end();
            }
            else if (nodeName == 'div' || nodeName == 'span') {
                var inline = $target.children('.' + this._inlineClass);
                inline.children().removeClass('ui-state-disabled');
                inline.find('button').each(
                    function() { this.disabled = false }
                )
            }
            this._disabledInputs = $.map(this._disabledInputs,
                function(value) { return (value == target_id ? null : value); }); // delete entry
        },

        /* Disable the time picker to a jQuery selection.
         @param  target    element - the target input field or division or span */
        _disableTimepicker: function(target) {
            var $target = $(target);
            var inst = $.data(target, PROP_NAME);
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            var nodeName = target.nodeName.toLowerCase();
            if (nodeName == 'input') {
                var button = this._get(inst, 'button');

                $(button).addClass('ui-state-disabled').disabled = true;
                target.disabled = true;

                inst.trigger.filter('button').
                    each(function() { this.disabled = true; }).end();

            }
            else if (nodeName == 'div' || nodeName == 'span') {
                var inline = $target.children('.' + this._inlineClass);
                inline.children().addClass('ui-state-disabled');
                inline.find('button').each(
                    function() { this.disabled = true }
                )

            }
            this._disabledInputs = $.map(this._disabledInputs,
                function(value) { return (value == target ? null : value); }); // delete entry
            this._disabledInputs[this._disabledInputs.length] = $target.attr('id');
        },

        /* Is the first field in a jQuery collection disabled as a timepicker?
         @param  target_id element - the target input field or division or span
         @return boolean - true if disabled, false if enabled */
        _isDisabledTimepicker: function (target_id) {
            if ( ! target_id) { return false; }
            for (var i = 0; i < this._disabledInputs.length; i++) {
                if (this._disabledInputs[i] == target_id) { return true; }
            }
            return false;
        },

        /* Check positioning to remain on screen. */
        _checkOffset: function (inst, offset, isFixed) {
            var tpWidth = inst.tpDiv.outerWidth();
            var tpHeight = inst.tpDiv.outerHeight();
            var inputWidth = inst.input ? inst.input.outerWidth() : 0;
            var inputHeight = inst.input ? inst.input.outerHeight() : 0;
            var viewWidth = document.documentElement.clientWidth + $(document).scrollLeft();
            var viewHeight = document.documentElement.clientHeight + $(document).scrollTop();

            offset.left -= (this._get(inst, 'isRTL') ? (tpWidth - inputWidth) : 0);
            offset.left -= (isFixed && offset.left == inst.input.offset().left) ? $(document).scrollLeft() : 0;
            offset.top -= (isFixed && offset.top == (inst.input.offset().top + inputHeight)) ? $(document).scrollTop() : 0;

            // now check if datepicker is showing outside window viewport - move to a better place if so.
            offset.left -= Math.min(offset.left, (offset.left + tpWidth > viewWidth && viewWidth > tpWidth) ?
                Math.abs(offset.left + tpWidth - viewWidth) : 0);
            offset.top -= Math.min(offset.top, (offset.top + tpHeight > viewHeight && viewHeight > tpHeight) ?
                Math.abs(tpHeight + inputHeight) : 0);

            return offset;
        },

        /* Find an object's position on the screen. */
        _findPos: function (obj) {
            var inst = this._getInst(obj);
            var isRTL = this._get(inst, 'isRTL');
            while (obj && (obj.type == 'hidden' || obj.nodeType != 1)) {
                obj = obj[isRTL ? 'previousSibling' : 'nextSibling'];
            }
            var position = $(obj).offset();
            return [position.left, position.top];
        },

        /* Retrieve the size of left and top borders for an element.
         @param  elem  (jQuery object) the element of interest
         @return  (number[2]) the left and top borders */
        _getBorders: function (elem) {
            var convert = function (value) {
                return { thin: 1, medium: 2, thick: 3}[value] || value;
            };
            return [parseFloat(convert(elem.css('border-left-width'))),
                parseFloat(convert(elem.css('border-top-width')))];
        },


        /* Close time picker if clicked elsewhere. */
        _checkExternalClick: function (event) {
            if (!$.timepicker._curInst) { return; }
            var $target = $(event.target);
            if ($target[0].id != $.timepicker._mainDivId &&
                $target.parents('#' + $.timepicker._mainDivId).length == 0 &&
                !$target.hasClass($.timepicker.markerClassName) &&
                !$target.hasClass($.timepicker._triggerClass) &&
                $.timepicker._timepickerShowing && !($.timepicker._inDialog && $.blockUI))
                $.timepicker._hideTimepicker();
        },

        /* Hide the time picker from view.
         @param  input  element - the input field attached to the time picker */
        _hideTimepicker: function (input) {
            var inst = this._curInst;
            if (!inst || (input && inst != $.data(input, PROP_NAME))) { return; }
            if (this._timepickerShowing) {
                var showAnim = this._get(inst, 'showAnim');
                var duration = this._get(inst, 'duration');
                var postProcess = function () {
                    $.timepicker._tidyDialog(inst);
                    this._curInst = null;
                };
                if ($.effects && $.effects[showAnim]) {
                    inst.tpDiv.hide(showAnim, $.timepicker._get(inst, 'showOptions'), duration, postProcess);
                }
                else {
                    inst.tpDiv[(showAnim == 'slideDown' ? 'slideUp' :
                        (showAnim == 'fadeIn' ? 'fadeOut' : 'hide'))]((showAnim ? duration : null), postProcess);
                }
                if (!showAnim) { postProcess(); }

                this._timepickerShowing = false;

                this._lastInput = null;
                if (this._inDialog) {
                    this._dialogInput.css({ position: 'absolute', left: '0', top: '-100px' });
                    if ($.blockUI) {
                        $.unblockUI();
                        $('body').append(this.tpDiv);
                    }
                }
                this._inDialog = false;

                var onClose = this._get(inst, 'onClose');
                if (onClose) {
                    onClose.apply(
                        (inst.input ? inst.input[0] : null),
                        [(inst.input ? inst.input.val() : ''), inst]);  // trigger custom callback
                }

            }
        },



        /* Tidy up after a dialog display. */
        _tidyDialog: function (inst) {
            inst.tpDiv.removeClass(this._dialogClass).unbind('.ui-timepicker');
        },

        /* Retrieve the instance data for the target control.
         @param  target  element - the target input field or division or span
         @return  object - the associated instance data
         @throws  error if a jQuery problem getting data */
        _getInst: function (target) {
            try {
                return $.data(target, PROP_NAME);
            }
            catch (err) {
                throw 'Missing instance data for this timepicker';
            }
        },

        /* Get a setting value, defaulting if necessary. */
        _get: function (inst, name) {
            return inst.settings[name] !== undefined ?
                inst.settings[name] : this._defaults[name];
        },

        /* Parse existing time and initialise time picker. */
        _setTimeFromField: function (inst) {
            if (inst.input.val() == inst.lastVal) { return; }
            var defaultTime = this._get(inst, 'defaultTime');

            var timeToParse = defaultTime == 'now' ? this._getCurrentTimeRounded(inst) : defaultTime;
            if ((inst.inline == false) && (inst.input.val() != '')) { timeToParse = inst.input.val() }

            if (timeToParse instanceof Date) {
                inst.hours = timeToParse.getHours();
                inst.minutes = timeToParse.getMinutes();
            } else {
                var timeVal = inst.lastVal = timeToParse;
                if (timeToParse == '') {
                    inst.hours = -1;
                    inst.minutes = -1;
                } else {
                    var time = this.parseTime(inst, timeVal);
                    inst.hours = time.hours;
                    inst.minutes = time.minutes;
                }
            }


            $.timepicker._updateTimepicker(inst);
        },

        /* Update or retrieve the settings for an existing time picker.
         @param  target  element - the target input field or division or span
         @param  name    object - the new settings to update or
         string - the name of the setting to change or retrieve,
         when retrieving also 'all' for all instance settings or
         'defaults' for all global defaults
         @param  value   any - the new value for the setting
         (omit if above is an object or to retrieve a value) */
        _optionTimepicker: function(target, name, value) {
            var inst = this._getInst(target);
            if (arguments.length == 2 && typeof name == 'string') {
                return (name == 'defaults' ? $.extend({}, $.timepicker._defaults) :
                    (inst ? (name == 'all' ? $.extend({}, inst.settings) :
                        this._get(inst, name)) : null));
            }
            var settings = name || {};
            if (typeof name == 'string') {
                settings = {};
                settings[name] = value;
            }
            if (inst) {
                if (this._curInst == inst) {
                    this._hideTimepicker();
                }
                extendRemove(inst.settings, settings);
                this._updateTimepicker(inst);
            }
        },


        /* Set the time for a jQuery selection.
         @param  target  element - the target input field or division or span
         @param  time    String - the new time */
        _setTimeTimepicker: function(target, time) {
            var inst = this._getInst(target);
            if (inst) {
                this._setTime(inst, time);
                this._updateTimepicker(inst);
                this._updateAlternate(inst, time);
            }
        },

        /* Set the time directly. */
        _setTime: function(inst, time, noChange) {
            var origHours = inst.hours;
            var origMinutes = inst.minutes;
            var time = this.parseTime(inst, time);
            inst.hours = time.hours;
            inst.minutes = time.minutes;

            if ((origHours != inst.hours || origMinutes != inst.minuts) && !noChange) {
                inst.input.trigger('change');
            }
            this._updateTimepicker(inst);
            this._updateSelectedValue(inst);
        },

        /* Return the current time, ready to be parsed, rounded to the closest 5 minute */
        _getCurrentTimeRounded: function (inst) {
            var currentTime = new Date(),
                currentMinutes = currentTime.getMinutes(),
            // round to closest 5
                adjustedMinutes = Math.round( currentMinutes / 5 ) * 5;
            currentTime.setMinutes(adjustedMinutes);
            return currentTime;
        },

        /*
         * Parse a time string into hours and minutes
         */
        parseTime: function (inst, timeVal) {
            var retVal = new Object();
            retVal.hours = -1;
            retVal.minutes = -1;

            var timeSeparator = this._get(inst, 'timeSeparator'),
                amPmText = this._get(inst, 'amPmText'),
                showHours = this._get(inst, 'showHours'),
                showMinutes = this._get(inst, 'showMinutes'),
                optionalMinutes = this._get(inst, 'optionalMinutes'),
                showPeriod = (this._get(inst, 'showPeriod') == true),
                p = timeVal.indexOf(timeSeparator);

            // check if time separator found
            if (p != -1) {
                retVal.hours = parseInt(timeVal.substr(0, p), 10);
                retVal.minutes = parseInt(timeVal.substr(p + 1), 10);
            }
            // check for hours only
            else if ( (showHours) && ( !showMinutes || optionalMinutes ) ) {
                retVal.hours = parseInt(timeVal, 10);
            }
            // check for minutes only
            else if ( ( ! showHours) && (showMinutes) ) {
                retVal.minutes = parseInt(timeVal, 10);
            }

            if (showHours) {
                var timeValUpper = timeVal.toUpperCase();
                if ((retVal.hours < 12) && (showPeriod) && (timeValUpper.indexOf(amPmText[1].toUpperCase()) != -1)) {
                    retVal.hours += 12;
                }
                // fix for 12 AM
                if ((retVal.hours == 12) && (showPeriod) && (timeValUpper.indexOf(amPmText[0].toUpperCase()) != -1)) {
                    retVal.hours = 0;
                }
            }

            return retVal;
        },

        selectNow: function(event) {
            var id = $(event.target).attr("data-timepicker-instance-id"),
                $target = $(id),
                inst = this._getInst($target[0]);
            //if (!inst || (input && inst != $.data(input, PROP_NAME))) { return; }
            var currentTime = new Date();
            inst.hours = currentTime.getHours();
            inst.minutes = currentTime.getMinutes();
            this._updateSelectedValue(inst);
            this._updateTimepicker(inst);
            this._hideTimepicker();
        },

        deselectTime: function(event) {
            var id = $(event.target).attr("data-timepicker-instance-id"),
                $target = $(id),
                inst = this._getInst($target[0]);
            inst.hours = -1;
            inst.minutes = -1;
            this._updateSelectedValue(inst);
            this._hideTimepicker();
        },


        selectHours: function (event) {
            var $td = $(event.currentTarget),
                id = $td.attr("data-timepicker-instance-id"),
                newHours = parseInt($td.attr("data-hour")),
                fromDoubleClick = event.data.fromDoubleClick,
                $target = $(id),
                inst = this._getInst($target[0]),
                showMinutes = (this._get(inst, 'showMinutes') == true);

            // don't select if disabled
            if ( $.timepicker._isDisabledTimepicker($target.attr('id')) ) { return false }

            $td.parents('.ui-timepicker-hours:first').find('a').removeClass('ui-state-active');
            $td.children('a').addClass('ui-state-active');
            inst.hours = newHours;

            // added for onMinuteShow callback
            var onMinuteShow = this._get(inst, 'onMinuteShow');
            if (onMinuteShow) {
                // this will trigger a callback on selected hour to make sure selected minute is allowed. 
                this._updateMinuteDisplay(inst);
            }

            this._updateSelectedValue(inst);

            inst._hoursClicked = true;
            if ((inst._minutesClicked) || (fromDoubleClick) || (showMinutes == false)) {
                $.timepicker._hideTimepicker();
            }
            // return false because if used inline, prevent the url to change to a hashtag
            return false;
        },

        selectMinutes: function (event) {
            var $td = $(event.currentTarget),
                id = $td.attr("data-timepicker-instance-id"),
                newMinutes = parseInt($td.attr("data-minute")),
                fromDoubleClick = event.data.fromDoubleClick,
                $target = $(id),
                inst = this._getInst($target[0]),
                showHours = (this._get(inst, 'showHours') == true);

            // don't select if disabled
            if ( $.timepicker._isDisabledTimepicker($target.attr('id')) ) { return false }

            $td.parents('.ui-timepicker-minutes:first').find('a').removeClass('ui-state-active');
            $td.children('a').addClass('ui-state-active');

            inst.minutes = newMinutes;
            this._updateSelectedValue(inst);

            inst._minutesClicked = true;
            if ((inst._hoursClicked) || (fromDoubleClick) || (showHours == false)) {
                $.timepicker._hideTimepicker();
                // return false because if used inline, prevent the url to change to a hashtag
                return false;
            }

            // return false because if used inline, prevent the url to change to a hashtag
            return false;
        },

        _updateSelectedValue: function (inst) {
            var newTime = this._getParsedTime(inst);
            if (inst.input) {
                inst.input.val(newTime);
                inst.input.trigger('change');
            }
            var onSelect = this._get(inst, 'onSelect');
            if (onSelect) { onSelect.apply((inst.input ? inst.input[0] : null), [newTime, inst]); } // trigger custom callback
            this._updateAlternate(inst, newTime);
            return newTime;
        },

        /* this function process selected time and return it parsed according to instance options */
        _getParsedTime: function(inst) {

            if (inst.hours == -1 && inst.minutes == -1) {
                return '';
            }

            // default to 0 AM if hours is not valid
            if ((inst.hours < inst.hours.starts) || (inst.hours > inst.hours.ends )) { inst.hours = 0; }
            // default to 0 minutes if minute is not valid
            if ((inst.minutes < inst.minutes.starts) || (inst.minutes > inst.minutes.ends)) { inst.minutes = 0; }

            var period = "",
                showPeriod = (this._get(inst, 'showPeriod') == true),
                showLeadingZero = (this._get(inst, 'showLeadingZero') == true),
                showHours = (this._get(inst, 'showHours') == true),
                showMinutes = (this._get(inst, 'showMinutes') == true),
                optionalMinutes = (this._get(inst, 'optionalMinutes') == true),
                amPmText = this._get(inst, 'amPmText'),
                selectedHours = inst.hours ? inst.hours : 0,
                selectedMinutes = inst.minutes ? inst.minutes : 0,
                displayHours = selectedHours ? selectedHours : 0,
                parsedTime = '';

            if (showPeriod) {
                if (inst.hours == 0) {
                    displayHours = 12;
                }
                if (inst.hours < 12) {
                    period = amPmText[0];
                }
                else {
                    period = amPmText[1];
                    if (displayHours > 12) {
                        displayHours -= 12;
                    }
                }
            }

            var h = displayHours.toString();
            if (showLeadingZero && (displayHours < 10)) { h = '0' + h; }

            var m = selectedMinutes.toString();
            if (selectedMinutes < 10) { m = '0' + m; }

            if (showHours) {
                parsedTime += h;
            }
            if (showHours && showMinutes && (!optionalMinutes || m != 0)) {
                parsedTime += this._get(inst, 'timeSeparator');
            }
            if (showMinutes && (!optionalMinutes || m != 0)) {
                parsedTime += m;
            }
            if (showHours) {
                if (period.length > 0) { parsedTime += this._get(inst, 'periodSeparator') + period; }
            }

            return parsedTime;
        },

        /* Update any alternate field to synchronise with the main field. */
        _updateAlternate: function(inst, newTime) {
            var altField = this._get(inst, 'altField');
            if (altField) { // update alternate field too
                $(altField).each(function(i,e) {
                    $(e).val(newTime);
                });
            }
        },

        /* This might look unused but it's called by the $.fn.timepicker function with param getTime */
        /* added v 0.2.3 - gitHub issue #5 - Thanks edanuff */
        _getTimeTimepicker : function(input) {
            var inst = this._getInst(input);
            return this._getParsedTime(inst);
        },
        _getHourTimepicker: function(input) {
            var inst = this._getInst(input);
            if ( inst == undefined) { return -1; }
            return inst.hours;
        },
        _getMinuteTimepicker: function(input) {
            var inst= this._getInst(input);
            if ( inst == undefined) { return -1; }
            return inst.minutes;
        }

    });



    /* Invoke the timepicker functionality.
     @param  options  string - a command, optionally followed by additional parameters or
     Object - settings for attaching new timepicker functionality
     @return  jQuery object */
    $.fn.timepicker = function (options) {

        /* Initialise the time picker. */
        if (!$.timepicker.initialized) {
            $(document).mousedown($.timepicker._checkExternalClick).
                find('body').append($.timepicker.tpDiv);
            $.timepicker.initialized = true;
        }



        var otherArgs = Array.prototype.slice.call(arguments, 1);
        if (typeof options == 'string' && (options == 'getTime' || options == 'getHour' || options == 'getMinute' ))
            return $.timepicker['_' + options + 'Timepicker'].
                apply($.timepicker, [this[0]].concat(otherArgs));
        if (options == 'option' && arguments.length == 2 && typeof arguments[1] == 'string')
            return $.timepicker['_' + options + 'Timepicker'].
                apply($.timepicker, [this[0]].concat(otherArgs));
        return this.each(function () {
            typeof options == 'string' ?
                $.timepicker['_' + options + 'Timepicker'].
                    apply($.timepicker, [this].concat(otherArgs)) :
                $.timepicker._attachTimepicker(this, options);
        });
    };

    /* jQuery extend now ignores nulls! */
    function extendRemove(target, props) {
        $.extend(target, props);
        for (var name in props)
            if (props[name] == null || props[name] == undefined)
                target[name] = props[name];
        return target;
    };

    $.timepicker = new Timepicker(); // singleton instance
    $.timepicker.initialized = false;
    $.timepicker.uuid = new Date().getTime();
    $.timepicker.version = "0.3.1";

    // Workaround for #4055
    // Add another global to avoid noConflict issues with inline event handlers
    window['TP_jQuery_' + tpuuid] = $;

})(jQuery);;
/* END /DuttiNEWStorefrontAssetStore/js/lib/jquery-ui-191.js (en_US) */

/* BEGIN /js/itx-messages-util.js (en_US) */

/**
 * Mtodo que se encarga de buscar el contenido de una key en los Messages de javascript.
 * Primero busca la key que se le pasa como parmetro ms "_[Cdigo del pas]" y si no encuentra esta key
 * busca la key sin concatenarle el cdigo del pas.
 * Para que funcione correctamente tiene que existir la variable Messages con los texto y la variable countryCode de javascript.
 * En dutti se est utilizando y se ha creado la variable countryCode en el fichero ItxCommonJS.jspf
 */
function getMessage(key){
    var newMessage = eval('Messages.' +key + '_' + Inditex.iStoreJSON.countryCode);

    if(newMessage == null || newMessage == '' || newMessage =="undefined"){
        newMessage = eval('Messages.' +key);
    }
    return newMessage;
};;
/* END /js/itx-messages-util.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/global.js (en_US) */
var OFFSET_AYUDA = 20;
var altoText = 0;
var api = null;

/**
 * Ajusta la imagen al tamano de la pantalla sin hacer overflow
 */
function fitToBox(im, div) {
    var imAR = im.attr("height") / im.attr("width");
    var bgAR = div.height() / div.width();
    if(imAR > bgAR) {
        im.attr("width", div.width());
        im.attr("height", div.width() * imAR);
    } else {
        im.attr("height", div.height());
        im.attr("width", div.height() / imAR);
    }
    div.css("position", "fixed");
    div.css("overflow", "hidden");
    im.css("position", "absolute");
    im.css("left", (div.width() - im.attr("width")) / 2);
    im.css("top", 0);

    if (isIPad() && !isIPad_5()){
        $('#content').height(document.height);
        $('#backgroundimage').height(document.height);
        fitFooter();
    }

    im.show();
};

//Setea la clase 'in' al objecto backgroundimage
function init() {
    $('#backgroundimage').addClass('in');
}

//Setea propiedades al input de Newsletter
function nlInputBinds() {
    $('#nl_input').bind({
        'focus' : function() {
            $(this).addClass('active');
            if($(this).val() == $(this).attr('original')) {
                $(this).val('');
            }
        },
        'blur' : function() {
            if($(this).val() == '') {
                $(this).val($(this).attr('original'));
            }
            $(this).removeClass('active');
        }
    });
    $("#nl_input").keypress(function(event) {
        if(event.which == 13) {
            checkEmail($(this).val());
        }
    });
}

/**
 * Setea propiedades al input de busqueda
 */
function searchInputBinds(){
    $("#search_input").keypress(function(event) {
        if(event.which == 13) {
            var inputSearch = $('#search_input');
            var url = Inditex.generateUrl("ItxSolrSearchingDataCmd", {
                storeId: Inditex.iStoreId,
                langId: Inditex.iLangId,
                catalogId: Inditex.iCatalogId,
                searchTerm: inputSearch.val()
            }, false);
            window.location = url;
        }
    });
}

/**
 * Funcion que comprueba si un mail es correcto
 **/
function checkEmailSimple(email) {
    var regex = /[a-zA-Z0-9\._%\+\-]+\@[a-zA-Z0-9\.\-]+\.[a-zA-Z]{2,4}/;
    return regex.test(email);
}

/**TODO: al abrir una modal deberamos pasarle tambin la funcion que valida el formulario **/
/**
 * Funcion que comprueba si un mail es correcto
 * y muestra un mensaje de exito o error.
 */
function checkEmail(email) {
    //var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

    var inputForm = $("#newslettersForm");
    var urlForm = inputForm.attr("value");

    openGenericModal(urlForm, email, onReadyNewLetterError, 200, null);
}

function validatePassrecoverTunel(object) {
    if(checkEmailSimple(object.value)) {
        $('.error').hide();
        return true;
    } else {
        $('.error').show();
        return false;
    }
}

function onReadyNewLetterError(email) {
    $('#email').attr('value', email);
    Inditex.trackPage( 'Suscripcion_Newsletter',true);
    $('.privatePolicyNewsletter a').bind('click',function(){
        Inditex.trackEvent('Newsletter','Ver_politica_de_privacidad', null, true);
    })
}



/*
 *
 * Desplazamiento de los paneles de ayuda y cuenta
 *
 */
var ayuda_timer;
var ayuda = false;

function ayudaBinds() {

    $('#ayuda_but').click(function() {
        mostrarCuenta(false);
        clearTimeout(ayuda_timer);
        if(!ayuda) {
            mostrarAyuda(true);
            ayuda = true;
        }
    });

    $('#ayuda_but').mouseleave(function() {
        ayuda_timer = setTimeout(function() {
            mostrarAyuda(false);
        }, 300);
    });

    $('#ayuda').mouseenter(function() {
        clearTimeout(ayuda_timer);
        ayuda = true;
    });

    $('#ayuda').mouseleave(function() {
        ayuda_timer = setTimeout(function() {
            mostrarAyuda(false);
        }, 300);
    });
}


function fixPositionDropDownMenu(boton, panel){
    var liBoton = boton.parent();
    var left = liBoton.offset().left;
    var widthLiBoton = liBoton.width();
    var widthAyuda = panel.width();
    panel.css('left', left+widthLiBoton-widthAyuda+OFFSET_AYUDA);
}

function mostrarAyuda(show) {
    var liCuenta = $("#ayuda_but").parent();

    if(show) {
        liCuenta.addClass("cabeceraButtonSelected");
        fixPositionDropDownMenu($("#ayuda_but"), $("#ayuda"));
        $("#ayuda").slideDown();
        Inditex.ga(function(tracker) {
            $("#ayuda").data('page', tracker.get('page'));
            Inditex.trackPage( "Header/Ayuda",true);
        });

    } else {
        liCuenta.removeClass("cabeceraButtonSelected");
        $("#ayuda").slideUp();
        if ($("#ayuda").data('page')!==undefined) {
            Inditex.ga('set','page',$("#ayuda").data('page'));
        }
    }
    ayuda = show;
}

function mostrarCuenta(show) {
    var liAyuda = $("#cuenta_but").parent();

    if(show) {
        liAyuda.addClass("cabeceraButtonSelected");
        fixPositionDropDownMenu($("#cuenta_but"), $("#cuenta"));
        $("#cuenta").slideDown();
        Inditex.trackPage( "Identificate/Accede_Cuenta",{page:false});
    } else {
        liAyuda.removeClass("cabeceraButtonSelected");
        $("#cuenta").slideUp();
    }
    cuenta = show;
}

function out_ayuda() {
    $('#ayuda').stop().animate({
        'top' : -$('#ayuda').height() - 50
    }, 300);
    ayuda = false;
}

var cuenta_timer;
var cuenta = false;
function cuentaBinds() {
    $('#cuenta_but').click(function() {
        mostrarAyuda(false);
        clearTimeout(cuenta_timer);
        if(!cuenta) {
            mostrarCuenta(true);
        }
    });

    $('#cuenta_but').mouseleave(function() {
        cuenta_timer = setTimeout(function() {
            mostrarCuenta(false);
        }, 300);
    });

    $('#cuenta').mouseenter(function() {
        clearTimeout(cuenta_timer);
        cuenta = true;
    });

    $('#cuenta').mouseleave(function() {
        ayuda_timer = setTimeout(function() {
            mostrarCuenta(false);
        }, 300);
    });
}

function out_cuenta() {
    $('#cuenta').stop().animate({
        'top' : -$('#cuenta').height() - 200
    }, 1000);
    cuenta = false;
}

function cuenta_info() {
    alert('formulario de registro')
}

/**
 * Metodo que aade eventos para el control de los tooltips
 */
function tooltipBinds() {
    //Aplicamos efectos a todos los objetos que tienen el class tooltip
    $('.tooltip').bind('mouseenter', function() {
        $('#tooltip').css({
            'left' : 0,
            'top' : 26
        });
        //Al div oculto con id tooltip le aadimos el texto del atributo
        // rel del objeto sobre el que pasamos el raton por encima
        $('#tooltip').text($(this).attr('rel'));

        if(($(this).offset().left + $('#tooltip').width()) > $(window).width()) {
            $('#tooltip').css({
                'left' : $(window).width() - $('#tooltip').width() - 15,
                'top' : $(this).offset().top + $(this).height() + 8
            });
        } else {
            $('#tooltip').css({
                'left' : $(this).offset().left,
                'top' : $(this).offset().top + $(this).height() + 8
            });
        }
        ($.browser.msie)?$('#tooltip').show():$('#tooltip').stop(true, true).fadeIn('slow');
    });
    $('.tooltip').bind('mouseleave', function() {
        ($.browser.msie)?$('#tooltip').hide():$('#tooltip').stop(true, true).fadeOut();
    });
}

function formatNumber(numero, decimales) {
    numeroFormateado = parseFloat(numero);
    numeroFormateado = numeroFormateado.toFixed(decimales) + '';
    return numeroFormateado.replace('.', Inditex.iNumberFormatDecimalChar);
}

function formatPrice(numero, decimales,moneda) {
    return formatNumber(numero, decimales) +moneda;
}

function formatCurPrice(numero, decimales,moneda) {
    numeroFormateado = parseFloat(numero);
    numeroFormateado = numeroFormateado.toFixed(decimales) + '';
    parteEntera = parseInt(numeroFormateado);
    var noDecimals = (decimales=="0");

    posParteDecimal = numeroFormateado.indexOf('.') +1;
    parteDecimal= numeroFormateado.substring(posParteDecimal,numeroFormateado.lenght);

    if (Inditex.iNumberFormatGroupingChar){
        parteEntera = parteEntera.toString();
        var miles=new RegExp("(-?[0-9]+)([0-9]{3})");
        while(miles.test(parteEntera)) {
            parteEntera=parteEntera.replace(miles, "$1" + Inditex.iNumberFormatGroupingChar + "$2");
        }
    }

    if(symbolPosition) {
        return moneda + parteEntera +(noDecimals ? "":'<span class="decimal">' + Inditex.iNumberFormatDecimalChar + parteDecimal + '<\/span>');
    } else {
        return parteEntera + (noDecimals ? " " : '<span class="decimal">' + Inditex.iNumberFormatDecimalChar + parteDecimal + '<\/span>' )+moneda;
    }
}

function formatCurPercent(numero, decimales) {
    numeroFormateado = parseFloat(numero);
    numeroFormateado = numeroFormateado.toFixed(decimales) + '';
    parteEntera = parseInt(numero);

    posParteDecimal = numeroFormateado.indexOf('.') +1;
    parteDecimal= numeroFormateado.substring(posParteDecimal,numeroFormateado.lenght);

    return parteEntera + ',' + parteDecimal + '%';
}


/**
 * Comprueba si un string es un numero
 */
function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}


function loadRadiosAndChecks() {
    var jRadio = null;

    $(':radio:not(.converted),:checkbox:not(.converted)').each(function() {
        if(this.type == 'radio')
            loadRadiosAndChecksAux(this, "radio", true);
        else
            loadRadiosAndChecksAux(this, "check", false);
    });
}

function loadRadiosAndChecksDevo() {
    var jRadio = null;

    $(':radio:not(.converted),:checkbox:not(.converted)').each(function() {
        if(this.type == 'radio')
            loadRadiosAndChecksAuxDevo(this, "radio", true);
        else
            loadRadiosAndChecksAuxDevo(this, "check", false);
    });
}

/** eventClickUnCheck = indica si queremos que se ejecute el click al demarcar el check **/
function loadRadiosAndChecksNew(eventClickUnCheck) {
    var jRadio = null;

    $(':radio:not(.converted),:checkbox:not(.converted)').each(function() {
        if(this.type == 'radio')
            loadRadiosAndChecksAuxNew(this, "radio", true, eventClickUnCheck);
        else
            loadRadiosAndChecksAuxNew(this, "check", false, eventClickUnCheck);
    });
}





function loadRadiosAndChecksAux(inputElement, cssClass, isRadio) {
    var jInputElement = $(inputElement);
    var newImg = document.createElement('a');

    //if (this.id != null) newImg.setAttribute('id', "radio_"+this.id);
    newImg.id = cssClass+"_"+inputElement.id;
    newImg.className = cssClass;
    //newImg.setAttribute('src', (inputElement.checked)?imgOn:imgOff);

    jInputElement.css({
        'visibility' : 'hidden',
        'position'	: 'absolute',
        'width':'0'
    });
    jInputElement.after(newImg);
    var jImg = null;
    var jInputElementAux = null;
    $(newImg).on( "click", function(event) {
        jImg = $(this);
        jInputElementAux = jImg.prev()[0];
        if(isRadio) {
            $(":radio[name='" + jInputElementAux.name + "']").each(function() {
                // Deseleccionamos todos los radios
                checkUncheckRadioButton(false, this);
            });
        }
        var checkInput = isRadio || !inputElement.checked;
        // Marcamos/Desmarcamos el actual
        checkUncheckRadioButton(checkInput, jInputElementAux);
        // Es posible que el radio tuviese un evento de onClick
        if(isRadio)
            $("#" + jInputElementAux.id).click();
    });
    jInputElement.addClass("converted");

}

function loadRadiosAndChecksAuxDevo(inputElement, cssClass, isRadio) {
    var jInputElement = $(inputElement);
    var newImg = document.createElement('a');

    //if (this.id != null) newImg.setAttribute('id', "radio_"+this.id);
    newImg.id = cssClass+"_"+inputElement.id;
    newImg.className = cssClass;
    //newImg.setAttribute('src', (inputElement.checked)?imgOn:imgOff);

    jInputElement.css({
        'visibility' : 'hidden',
        'position'	: 'absolute',
        'width':'0'
    });
    jInputElement.after(newImg);
    var jImg = null;
    var jInputElementAux = null;

    jInputElement.addClass("converted");

}

function loadRadiosAndChecksAuxNew(inputElement, cssClass, isRadio, eventClickUnCheck) {
    var jInputElement = $(inputElement);
    var newImg = document.createElement('a');

    //if (this.id != null) newImg.setAttribute('id', "radio_"+this.id);
    newImg.id = cssClass+"_"+inputElement.id;
    newImg.className = cssClass;
    //newImg.setAttribute('src', (inputElement.checked)?imgOn:imgOff);

    jInputElement.css({
        'visibility' : 'hidden',
        'position'	: 'absolute',
        'width':'0'
    });
    jInputElement.after(newImg);
    var jImg = null;
    var jInputElementAux = null;
    $(newImg).on( "click", function(event) {
        jImg = $(this);
        jInputElementAux = jImg.prev()[0];

        if (event.clientX) {
            $(this).data('evento','mouse');
            $(jInputElementAux).data('evento','mouse');
        } else {
            $(this).data('evento','code');
            $(jInputElementAux).data('evento','code');
        }

        if(isRadio) {
            $(":radio[name='" + jInputElementAux.name + "']").each(function() {
                // Deseleccionamos todos los radios
                checkUncheckRadioButtonNew(false, this, eventClickUnCheck);
            });
        }
        var checkInput = isRadio || !inputElement.checked;
        // Marcamos/Desmarcamos el actual
        checkUncheckRadioButtonNew(checkInput, jInputElementAux, true);
    });
    jInputElement.addClass("converted");

}


function checkUncheckRadioButton(check, radio) {
    var jRadio = $(radio);
    var jImg = jRadio.next();
    if(check) {
        $(jImg).addClass('active');
    } else {
        $(jImg).removeClass('active');
    }
    radio.checked = check;
    $(radio).trigger('change');
}

function checkUncheckRadioButtonNew(check, radio, eventClickUnCheck) {
    var jRadio = $(radio);
    var jImg = jRadio.next();
    if(check) {
        $(jImg).addClass('active');
    } else {
        $(jImg).removeClass('active');
    }

    if(eventClickUnCheck && check && !radio.checked) {
        radio.click();
    }
    radio.checked = check;
}

function removeValueFromFieldOnClick(fieldId) {
    var field = $('#' + fieldId);
    field.bind('click', function() {
        field.attr('value', '');
        field.unbind('click');
    });
}

function removeValueFromFieldOnClickSpecific(field) {
    field.bind('click', function() {
        field.attr('value', '');
        field.unbind('click');
    });
}

function removeValueFromFieldOnClickByName(fieldName) {
    $("[name^=" + fieldName + "]").each(function(){
        $(this).bind('click', function() {
            $(this).attr('value', '');
            $(this).unbind('click');
        });
    });
}


function gotoHome(skipTrack) {
    if (Inditex&&(!skipTrack)){
        Inditex.trackEvent('Header','Logo_MD',null,{hitCallback:function(){
            window.location = iHomeUrl;
        }});
    }else{
        window.location = iHomeUrl;
    }


}

/**
 * Oculta un posible overflow en la pagina
 */
function bodyHtmlOverflowX() {
    $('body,html').css('overflow-x', 'hidden');
}


/**
 * Metodo que hace submit de un form al presionar Enter en un input
 */
function submitFormOnEnter(){
    $('form').each(function() {
        $('input').keypress(function(e) {
            // Enter pressed?
            if(e.which == 13) {
                $(this.form).submit();
            }
        });
    });
}




function scrollDiv(divId, elementToId){
    $("#"+divId).scrollTo($("#"+elementToId).position().top);
}



/**
 * Muestra el menu de usuario una vez autenticado
 */
function showUserMenu(userName){
    updateNameUserMenu(userName);
    cuentaLoggedBinds();
}

/**
 * Actualiza el nombre del usuario autenticado en el Menu
 */
function updateNameUserMenu(userName){
    $('#cuenta_logged').hide();
    $('#cuenta_but').parent().hide();
    $('#user_but').html($('<div>').text(userName).html() + ' <a onclick="logout()">'+Messages.off+'</a>');
    $('#user_but').after();
    $('#user_but').parent().show();
}

function checkSubmitGestionarDireccion () {
    if ($("#gestionarDireccion").valid()) {
        $(".boton .acc_butt").removeAttr("onclick");
        $('#gestionarDireccion').submit();
        document.activeElement.blur();
        updateNameUserMenu(document.getElementById('nombre').value + ' ' +document.getElementById('apellidos').value);
    }
}

/**
 * Desloguea al usuario
 */
function logout(){
    var urlLogout = $('#urlLogout').val();
    $('#cuenta_but').parent().show();
    $('#user_but').parent().hide();
    $('#cuenta_logged').hide();
    if (Inditex)
        Inditex.trackEvent('Cabecera','logout');
    jQuery.xajax({
        url: urlLogout,
        type: 'get',
        success: function(data) {
            window.location = iHomeUrl
        }
    });
}


var cuenta_logged_timer;
var cuenta_logged = false;
function cuentaLoggedBinds() {
    $('#user_but').click(function() {

        mostrarAyuda(false);
        clearTimeout(cuenta_logged_timer);
        if(!cuenta_logged) {
            mostrarCuentaLogged(true);
            if (Inditex)
                Inditex.trackEvent('Cabecera','mi_cuenta');
        }
    });

    $('#user_but').unbind('mouseleave');
    $('#user_but').mouseleave(function() {
        cuenta_logged_timer = setTimeout(function() {
            mostrarCuentaLogged(false);
        }, 300);
    });
    $('#cuenta_logged').unbind('mouseenter'); //Borro el anterior evento mouseenter
    $('#cuenta_logged').mouseenter(function() {
        clearTimeout(cuenta_logged_timer);
        cuenta_logged = true;
    });
    $('#cuenta_logged').unbind('mouseleave'); //Borro el anterior evento mouseleave
    $('#cuenta_logged').mouseleave(function() {
        cuenta_logged_timer = setTimeout(function() {
            mostrarCuentaLogged(false);
            cuenta_logged = false;
        }, 300);
    });
    $('#cuenta_logged ul li a').unbind('click'); //Borro el anterior evento click
    $('#cuenta_logged ul li a').click(function(){
        var url = $("#urlHomeGeneral").attr("value");
        openLargeModal(url, $(this).attr('id'), showMiCuentaOption, null,0.8);
    })

}

/*
 * Muestra/oculta el menu de opciones del usuario autenticado
 */
function mostrarCuentaLogged(show) {
    var liPadre = $("#user_but").parent();

    if(show) {
        liPadre.addClass("cabeceraButtonSelected");
        fixPositionDropDownMenu($("#user_but"), $("#cuenta_logged"));
        $("#cuenta_logged").slideDown();
        Inditex.trackPage( "Mi_Cuenta/Menu_Desplegable",{'page':false});
    } else {
        liPadre.removeClass("cabeceraButtonSelected");
        $("#cuenta_logged").slideUp();
    }
    cuenta = show;
}

/**
 * Abre la modald e mi cuenta con la pgina que el usuario
 * seleccion en desde el menu del header
 */
function showMiCuentaOption(id){
    $("#logo").click(gotoHome);

    //recuperamos la url
    var input = $("input[id=" + id + ']');
    var url = input.attr("value");

    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(data) {

            var li = $("#menu_modal li[id=" + id + ']');

            // Seleccionamos el elemento del menu
            li.find("a").addClass("activeSection");
            var menuLi = $("#menu_modal li");
            menuLi.each(function() {
                var li = $(this);
                li.click(function() {
                    selectMenuElement(li);
                });
            });

            $('#content_micuenta').html(data);

            // Configura google analytics
            if (Inditex) {
                Inditex.initHtml();
                var gaLogicu = $('#content_micuenta .data-ga-logic-universal').attr('data-ga-logic-universal');
                if (gaLogicu) {
                    Inditex.trackPage( gaLogicu,true);
                } else {
                    gaLogicu = $('#content_micuenta .data-ga-logic-universal').attr('data-ga-logic-universal-tunel');
                    if (gaLogicu) {
                        if (gaLogicu.match(/\/$/) && extraPageview.match(/^\//)) {
                            gaLogicu = gaLogicu.substr(0, gaLogicu.length-1);
                        }
                        Inditex.trackPage( gaLogicu+extraPageview,true);
                    }
                }
            }

            var initFunction = window["init_" + id];
            if(initFunction != null) {
                initFunction.apply();
                setScroll();
            }
        }
    });

    setCSSPaddingContent();

}

function extractPrefix(phone){
    if (phone==null) return "";
    var pos = phone.indexOf(' ');
    return phone.substr(0,pos);
}

function extractPhone(phone){
    if (phone==null) return "";
    var pos = phone.indexOf(' ');
    return phone.substr(pos + 1);
}

function seleccionaSeccionFooter(seccion){
    $(".foot").removeClass("active");
    $("#"+seccion).addClass("active");
}

/**
 * Metodo que calcula el alto del texto para las cajas
 *  de moreinfo
 */
function resizeContent(changePadding){
    var altoBody = $("body").height();
    var topText = 0;
    if ($(".text")[0]){
        topText = $(".text")[0].offsetTop;
    }
    var duttiDivSize = ($("body").height()-($("body").height()*0.14)-22);


    if(altoText == 0)
        altoText = $(".text").height();

    if ($.browser.msie  && (parseInt($.browser.version, 10) === 7 )){
        var maxAlto = altoBody - topText - 320;
        if(changePadding){
            $("#duttidiv").css("padding-right",36);
        }
    } else {
        var maxAlto = altoBody - topText - 300;
    }

    $(".int").css("height",maxAlto-201);
    $(".text").css("max-height",maxAlto);
    $("#duttidiv").css("height",maxAlto);
    if(api!=null)
        api.scrollTo(0,0,false);
    var element = $("#duttidiv").find(".text").jScrollPane();
    api = element.data('jsp');


}

/**
 * Selecciona un elemento de un select customizado
 */
function changeCustomSelect(element, form) {
    var v = $(element).attr('v');
    var s = $(element).attr('s');
    $(form).find('select[title=' + s + ']').val(v);
    $(form).find('select[title=' + s + ']').change();
    $(form).find('#select-inner-name-' + s).html($(element).html());
}

/**
 * Metodo que calcula el ancho del arbol segun la resolucion
 */
function widthArbol(){
    var resultado = $("body").width() - 270;
    $("#arbol").css("width",resultado);
}

function isIPad(){
    if(navigator.userAgent.match(/iPad/i) != null){
        return true;
    }else{ return false;}
}

function isIPad_5(){

    if((navigator.userAgent.match(/iPad/i) != null) && (navigator.userAgent.match(/CPU OS 5/)!= null)){
        return true;
    }else{ return false;}
}
function isTouchDevice(){
    return ('ontouchstart' in document.documentElement);
}

function touchScroll(id){
    if(isTouchDevice()){ //if touch events exist...
        var el=document.getElementById(id);
        var scrollStartPos=0;



        $("#"+id).bind("touchstart click", function(event) {

            if(event.type == 'touchstart'){

                scrollStartPos=this.scrollTop+event.originalEvent.touches[0].pageY;

            }
        });

        $("#"+id).bind("touchmove", function(event) {

            this.scrollTop=scrollStartPos-event.originalEvent.touches[0].pageY;
            event.preventDefault();
        });


    }
}

function restNewsletter() {
    $('#nl_input').fadeOut();
    $('#nl_text').fadeIn();
}

function isChrome(){
    if(navigator.userAgent.match(/Chrome/i) != null) {
        return true;
    }else{ return false;}
}

/***********************
 * BUSCADOR DE TIENDAS *
 ***********************/


function get_tiendas(page,todoPais){

    var url;

    if (todoPais== undefined) {
        todoPais= 'true';
    }

    if (page==undefined || page!='tunel') {
        url=DUTTI_STORE_LOCATOR_PAGE_URL_NO_TUNEL;
        if (page=="devolucion"){
            Inditex.trackEvent ('Mi_cuenta','Devolucion' ,'Tienda_localizar', true);
        }

        window.modaltiendas = new Modal('tiendas' ,url +'&page=' + page + '&todoPais=' + todoPais, {openCallback:function(){
            if (page=="footer") {
                Inditex.trackPage( "Tiendas/Buscador_inicio/",true);
            } else if (page=="devolucion") {
                Inditex.trackPage( "Mi_Cuenta/Pedidos_Realizados/Devolucion_Pedido/Buscador_Tienda",true);
            }
        }});
    }
    else{
        url=DUTTI_STORE_LOCATOR_PAGE_URL;
        window.modaltiendas = new Modal('tiendas' ,url +'&page=' + page + '&todoPais=' + todoPais, {openCallback:function(){
            if (page=="tunel") {
                Inditex.trackPage( "Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador"+extraPageview,true);
            }
        }});
    }
    window.modaltiendas.create();
}
function Modal(id , include, opts) {
    var modal;
    $('.modalcont').remove();
    $('.modalbg').remove();
    this.create = function(){
        $('<div />' , { 'id' : id, 'class' : 'modal_window' }).appendTo('body');
        this.bg = $('<div />' , { 'class' : 'modalbg' }).appendTo('#'+id);
        this.cont = $('<div />' , { 'class' : 'modalcont' }).appendTo('#'+id);
        this.inner = $('<div />' , { 'class' : 'modalinner' }).appendTo(this.cont);
        this.closebut = $('<a />' , { 'class' : 'modalclose' }).appendTo(this.cont);
        modal = $('#'+id);
        this.bg.bind('click' , this.closemodal)
        this.closebut.bind('click' , this.closemodal)
        this.inner.load(include , this.openmodal)
    }

    this.openmodal = function(){
        Inditex.ga(function(tracker) {
            var defaultPage = tracker.get('page');
            modal.data('page',defaultPage);
        });
        modal.fadeIn();
        if (opts && opts.openCallback) {
            opts.openCallback();
        }
    }
    this.closemodal = function(){
        var previusPage = modal.data('page');
        modal.fadeOut();
        if (previusPage!==undefined) {
            Inditex.ga('set', 'page', previusPage);
        }
    }
}

function MapTooltip(content) {
    this.content = content;
    this.getProj=function getProj(){
        return this.getProjection();
    }
}


function initTooltip(content,footer){
    MapTooltip.prototype = new google.maps.OverlayView();
    if(footer){
        MapTooltip.prototype.onAdd = onAddTooltipFooter;
    }else{
        MapTooltip.prototype.onAdd = onAddTooltip;
    }

    MapTooltip.prototype.draw = onDrawTooltip;
    MapTooltip.prototype.onRemove = onRemoveTooltip;

    google.maps.event.addListener(mapa.iMap, 'idle', function() {
        projection = tiendaTooltip.getProjection();
    })

    tiendaTooltip = new MapTooltip(content);
    tiendaTooltip.setMap(mapa.iMap);
    return tiendaTooltip;
}

function MapBaiduTooltip( content){
    this.content = content;
}

function initBaiduTooltip(content,footer){

    MapBaiduTooltip.prototype = new BMap.Overlay();
    MapBaiduTooltip.prototype.initialize = function(map){
        this._map = map;
    }
    if(footer){
        MapBaiduTooltip.prototype.draw = onDrawBaiduTooltipFooter;
    }else{
        MapBaiduTooltip.prototype.draw = onDrawBaiduTooltip;
    }



    tiendaTooltip = new MapBaiduTooltip(content);
    mapa.iMap.addOverlay(tiendaTooltip);
    return tiendaTooltip;
}

function onDrawTooltip() {

    var overlayProjection = this.getProjection();

    if (tiendaSeleccionada){
        var pos = tiendaSeleccionada.marcador.getPosition();
        var p = overlayProjection.fromLatLngToContainerPixel(pos);

        var div = this.content;
        var jDiv = $(div);

        var posX = p.x-jDiv.width()/2-20;
        var posY = p.y-jDiv.height()-50;
        div.style.left = posX + 'px';
        div.style.top = posY+ 10 + 'px';

        jDiv.show();

    }
}

function onDrawBaiduTooltip() {

    if (tiendaSeleccionada){
        getTooltipHTML(tiendaSeleccionada)
        var pos = tiendaSeleccionada.marcador.getPosition();
        var p = mapa.iMap.pointToOverlayPixel(pos);

        // Resize the image's DIV to fit the indicated dimensions.
        // var div = this.div_;
        var div = this.content;
        var jDiv = $(div);
        var posX = p.x-jDiv.width()/2-20;
        var posY = p.y-jDiv.height()-50;
        div.style.left = posX + 'px';
        div.style.top = posY + 10 + 'px';
        mapa.iMap.getPanes().labelPane.appendChild(div);
    }
}

function onDrawBaiduTooltipFooter() {

    if (tiendaSeleccionada){
        getTooltipHTMLFooter(tiendaSeleccionada)
        var pos = tiendaSeleccionada.marcador.getPosition();
        var p = mapa.iMap.pointToOverlayPixel(pos);

        // Resize the image's DIV to fit the indicated dimensions.
        // var div = this.div_;
        var div = this.content;
        var jDiv = $(div);
        var posX = p.x-jDiv.width()/2-20;
        var posY = p.y-jDiv.height()-50;
        div.style.left = posX + 'px';
        div.style.top = posY + 10 + 'px';
        mapa.iMap.getPanes().labelPane.appendChild(div);

    }
}

function clearMarcadores(){
    mapa.clear();

}




function initializeMap(footer) {
    var map_id;
    if(footer){
        map_id="mapcanvas";
    }else{
        map_id="map_canvas";
    }
    var canvas = document.getElementById(map_id);
    var paisISO = $("#pais option:selected").val();
    var address = $("#pais option:selected").text();
    if (canvas != null) {
        if(Inditex.iStoreJSON.countryCode=="CN"&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""){
            Inditex.initBaiduMaps(map_id, paisISO, address, function(aMap) {
                mapa=aMap;

                var contenidohideTiendaTooltiptip = document.getElementById("mapa_tooltip");
                var tooltipDiv = document.getElementById("mapa_tooltip");
                initBaiduTooltip(tooltipDiv,footer);

                $("#tooltipClose").click(hideTiendaTooltip);
            },"icono-dutti");
        }else{
            Inditex.initGoogleMaps(map_id, paisISO,address, function(aMap) {
                mapa=aMap;
                paintMap(aMap);

                var contenidohideTiendaTooltiptip = document.getElementById("mapa_tooltip");
                var tooltipDiv = document.getElementById("mapa_tooltip");
                initTooltip(tooltipDiv,footer);

                $("#tooltipClose").click(hideTiendaTooltip);
            },"icono-dutti");
        }

        return true;
    } else {
        return false;
    }
}

function paintMap(aMap) {

    var gs = [{
        stylers : [{
            saturation : -100
        }]
    }];
    aMap.iMap.mapTypes.set('gs', new google.maps.StyledMapType(gs, {
        map: aMap.iMap,
        name: 'Grayscale'
    }));
    aMap.iMap.setMapTypeId('gs');

}
;
/* END /DuttiNEWStorefrontAssetStore/js/global.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/plugins.js (en_US) */
window.log = function f(){ log.history = log.history || []; log.history.push(arguments); if(this.console) { var args = arguments, newarr; args.callee = args.callee.caller; newarr = [].slice.call(args); if (typeof console.log === 'object') log.apply.call(console.log, console, newarr); else console.log.apply(console, newarr);}};
(function(a){function b(){}for(var c="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(","),d;!!(d=c.pop());){a[d]=a[d]||b;}})
(function(){try{console.log();return window.console;}catch(a){return (window.console={});}}());


/*!
 * jQuery UI 1.8.18
 *
 * Copyright 2011, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI
 */(function(a,b){function d(b){return!a(b).parents().andSelf().filter(function(){return a.curCSS(this,"visibility")==="hidden"||a.expr.filters.hidden(this)}).length}function c(b,c){var e=b.nodeName.toLowerCase();if("area"===e){var f=b.parentNode,g=f.name,h;if(!b.href||!g||f.nodeName.toLowerCase()!=="map")return!1;h=a("img[usemap=#"+g+"]")[0];return!!h&&d(h)}return(/input|select|textarea|button|object/.test(e)?!b.disabled:"a"==e?b.href||c:c)&&d(b)}a.ui=a.ui||{};a.ui.version||(a.extend(a.ui,{version:"1.8.18",keyCode:{ALT:18,BACKSPACE:8,CAPS_LOCK:20,COMMA:188,COMMAND:91,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91}}),a.fn.extend({propAttr:a.fn.prop||a.fn.attr,_focus:a.fn.focus,focus:function(b,c){return typeof b=="number"?this.each(function(){var d=this;setTimeout(function(){a(d).focus(),c&&c.call(d)},b)}):this._focus.apply(this,arguments)},scrollParent:function(){var b;a.browser.msie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?b=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(a.curCSS(this,"position",1))&&/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0):b=this.parents().filter(function(){return/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0);return/fixed/.test(this.css("position"))||!b.length?a(document):b},zIndex:function(c){if(c!==b)return this.css("zIndex",c);if(this.length){var d=a(this[0]),e,f;while(d.length&&d[0]!==document){e=d.css("position");if(e==="absolute"||e==="relative"||e==="fixed"){f=parseInt(d.css("zIndex"),10);if(!isNaN(f)&&f!==0)return f}d=d.parent()}}return 0},disableSelection:function(){return this.bind((a.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(a){a.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),a.each(["Width","Height"],function(c,d){function h(b,c,d,f){a.each(e,function(){c-=parseFloat(a.curCSS(b,"padding"+this,!0))||0,d&&(c-=parseFloat(a.curCSS(b,"border"+this+"Width",!0))||0),f&&(c-=parseFloat(a.curCSS(b,"margin"+this,!0))||0)});return c}var e=d==="Width"?["Left","Right"]:["Top","Bottom"],f=d.toLowerCase(),g={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn["inner"+d]=function(c){if(c===b)return g["inner"+d].call(this);return this.each(function(){a(this).css(f,h(this,c)+"px")})},a.fn["outer"+d]=function(b,c){if(typeof b!="number")return g["outer"+d].call(this,b);return this.each(function(){a(this).css(f,h(this,b,!0,c)+"px")})}}),a.extend(a.expr[":"],{data:function(b,c,d){return!!a.data(b,d[3])},focusable:function(b){return c(b,!isNaN(a.attr(b,"tabindex")))},tabbable:function(b){var d=a.attr(b,"tabindex"),e=isNaN(d);return(e||d>=0)&&c(b,!e)}}),a(function(){var b=document.body,c=b.appendChild(c=document.createElement("div"));c.offsetHeight,a.extend(c.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),a.support.minHeight=c.offsetHeight===100,a.support.selectstart="onselectstart"in c,b.removeChild(c).style.display="none"}),a.extend(a.ui,{plugin:{add:function(b,c,d){var e=a.ui[b].prototype;for(var f in d)e.plugins[f]=e.plugins[f]||[],e.plugins[f].push([c,d[f]])},call:function(a,b,c){var d=a.plugins[b];if(!!d&&!!a.element[0].parentNode)for(var e=0;e<d.length;e++)a.options[d[e][0]]&&d[e][1].apply(a.element,c)}},contains:function(a,b){return document.compareDocumentPosition?a.compareDocumentPosition(b)&16:a!==b&&a.contains(b)},hasScroll:function(b,c){if(a(b).css("overflow")==="hidden")return!1;var d=c&&c==="left"?"scrollLeft":"scrollTop",e=!1;if(b[d]>0)return!0;b[d]=1,e=b[d]>0,b[d]=0;return e},isOverAxis:function(a,b,c){return a>b&&a<b+c},isOver:function(b,c,d,e,f,g){return a.ui.isOverAxis(b,d,f)&&a.ui.isOverAxis(c,e,g)}}))})(jQuery);/*
 * jQuery UI Effects 1.8.18
 *
 * Copyright 2011, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/
 */jQuery.effects||function(a,b){function l(b){if(!b||typeof b=="number"||a.fx.speeds[b])return!0;if(typeof b=="string"&&!a.effects[b])return!0;return!1}function k(b,c,d,e){typeof b=="object"&&(e=c,d=null,c=b,b=c.effect),a.isFunction(c)&&(e=c,d=null,c={});if(typeof c=="number"||a.fx.speeds[c])e=d,d=c,c={};a.isFunction(d)&&(e=d,d=null),c=c||{},d=d||c.duration,d=a.fx.off?0:typeof d=="number"?d:d in a.fx.speeds?a.fx.speeds[d]:a.fx.speeds._default,e=e||c.complete;return[b,c,d,e]}function j(a,b){var c={_:0},d;for(d in b)a[d]!=b[d]&&(c[d]=b[d]);return c}function i(b){var c,d;for(c in b)d=b[c],(d==null||a.isFunction(d)||c in g||/scrollbar/.test(c)||!/color/i.test(c)&&isNaN(parseFloat(d)))&&delete b[c];return b}function h(){var a=document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle,b={},c,d;if(a&&a.length&&a[0]&&a[a[0]]){var e=a.length;while(e--)c=a[e],typeof a[c]=="string"&&(d=c.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),b[d]=a[c])}else for(c in a)typeof a[c]=="string"&&(b[c]=a[c]);return b}function d(b,d){var e;do{e=a.curCSS(b,d);if(e!=""&&e!="transparent"||a.nodeName(b,"body"))break;d="backgroundColor"}while(b=b.parentNode);return c(e)}function c(b){var c;if(b&&b.constructor==Array&&b.length==3)return b;if(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)];if(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))return[parseFloat(c[1])*2.55,parseFloat(c[2])*2.55,parseFloat(c[3])*2.55];if(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))return[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)];if(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))return[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)];if(c=/rgba\(0, 0, 0, 0\)/.exec(b))return e.transparent;return e[a.trim(b).toLowerCase()]}a.effects={},a.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","borderColor","color","outlineColor"],function(b,e){a.fx.step[e]=function(a){a.colorInit||(a.start=d(a.elem,e),a.end=c(a.end),a.colorInit=!0),a.elem.style[e]="rgb("+Math.max(Math.min(parseInt(a.pos*(a.end[0]-a.start[0])+a.start[0],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[1]-a.start[1])+a.start[1],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[2]-a.start[2])+a.start[2],10),255),0)+")"}});var e={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]},f=["add","remove","toggle"],g={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};a.effects.animateClass=function(b,c,d,e){a.isFunction(d)&&(e=d,d=null);return this.queue(function(){var g=a(this),k=g.attr("style")||" ",l=i(h.call(this)),m,n=g.attr("class");a.each(f,function(a,c){b[c]&&g[c+"Class"](b[c])}),m=i(h.call(this)),g.attr("class",n),g.animate(j(l,m),{queue:!1,duration:c,easing:d,complete:function(){a.each(f,function(a,c){b[c]&&g[c+"Class"](b[c])}),typeof g.attr("style")=="object"?(g.attr("style").cssText="",g.attr("style").cssText=k):g.attr("style",k),e&&e.apply(this,arguments),a.dequeue(this)}})})},a.fn.extend({_addClass:a.fn.addClass,addClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{add:b},c,d,e]):this._addClass(b)},_removeClass:a.fn.removeClass,removeClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{remove:b},c,d,e]):this._removeClass(b)},_toggleClass:a.fn.toggleClass,toggleClass:function(c,d,e,f,g){return typeof d=="boolean"||d===b?e?a.effects.animateClass.apply(this,[d?{add:c}:{remove:c},e,f,g]):this._toggleClass(c,d):a.effects.animateClass.apply(this,[{toggle:c},d,e,f])},switchClass:function(b,c,d,e,f){return a.effects.animateClass.apply(this,[{add:c,remove:b},d,e,f])}}),a.extend(a.effects,{version:"1.8.18",save:function(a,b){for(var c=0;c<b.length;c++)b[c]!==null&&a.data("ec.storage."+b[c],a[0].style[b[c]])},restore:function(a,b){for(var c=0;c<b.length;c++)b[c]!==null&&a.css(b[c],a.data("ec.storage."+b[c]))},setMode:function(a,b){b=="toggle"&&(b=a.is(":hidden")?"show":"hide");return b},getBaseline:function(a,b){var c,d;switch(a[0]){case"top":c=0;break;case"middle":c=.5;break;case"bottom":c=1;break;default:c=a[0]/b.height}switch(a[1]){case"left":d=0;break;case"center":d=.5;break;case"right":d=1;break;default:d=a[1]/b.width}return{x:d,y:c}},createWrapper:function(b){if(b.parent().is(".ui-effects-wrapper"))return b.parent();var c={width:b.outerWidth(!0),height:b.outerHeight(!0),"float":b.css("float")},d=a("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),e=document.activeElement;b.wrap(d),(b[0]===e||a.contains(b[0],e))&&a(e).focus(),d=b.parent(),b.css("position")=="static"?(d.css({position:"relative"}),b.css({position:"relative"})):(a.extend(c,{position:b.css("position"),zIndex:b.css("z-index")}),a.each(["top","left","bottom","right"],function(a,d){c[d]=b.css(d),isNaN(parseInt(c[d],10))&&(c[d]="auto")}),b.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"}));return d.css(c).show()},removeWrapper:function(b){var c,d=document.activeElement;if(b.parent().is(".ui-effects-wrapper")){c=b.parent().replaceWith(b),(b[0]===d||a.contains(b[0],d))&&a(d).focus();return c}return b},setTransition:function(b,c,d,e){e=e||{},a.each(c,function(a,c){unit=b.cssUnit(c),unit[0]>0&&(e[c]=unit[0]*d+unit[1])});return e}}),a.fn.extend({effect:function(b,c,d,e){var f=k.apply(this,arguments),g={options:f[1],duration:f[2],callback:f[3]},h=g.options.mode,i=a.effects[b];if(a.fx.off||!i)return h?this[h](g.duration,g.callback):this.each(function(){g.callback&&g.callback.call(this)});return i.call(this,g)},_show:a.fn.show,show:function(a){if(l(a))return this._show.apply(this,arguments);var b=k.apply(this,arguments);b[1].mode="show";return this.effect.apply(this,b)},_hide:a.fn.hide,hide:function(a){if(l(a))return this._hide.apply(this,arguments);var b=k.apply(this,arguments);b[1].mode="hide";return this.effect.apply(this,b)},__toggle:a.fn.toggle,toggle:function(b){if(l(b)||typeof b=="boolean"||a.isFunction(b))return this.__toggle.apply(this,arguments);var c=k.apply(this,arguments);c[1].mode="toggle";return this.effect.apply(this,c)},cssUnit:function(b){var c=this.css(b),d=[];a.each(["em","px","%","pt"],function(a,b){c.indexOf(b)>0&&(d=[parseFloat(c),b])});return d}}),a.easing.jswing=a.easing.swing,a.extend(a.easing,{def:"easeOutQuad",swing:function(b,c,d,e,f){return a.easing[a.easing.def](b,c,d,e,f)},easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c},easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c},easeInOutQuad:function(a,b,c,d,e){if((b/=e/2)<1)return d/2*b*b+c;return-d/2*(--b*(b-2)-1)+c},easeInCubic:function(a,b,c,d,e){return d*(b/=e)*b*b+c},easeOutCubic:function(a,b,c,d,e){return d*((b=b/e-1)*b*b+1)+c},easeInOutCubic:function(a,b,c,d,e){if((b/=e/2)<1)return d/2*b*b*b+c;return d/2*((b-=2)*b*b+2)+c},easeInQuart:function(a,b,c,d,e){return d*(b/=e)*b*b*b+c},easeOutQuart:function(a,b,c,d,e){return-d*((b=b/e-1)*b*b*b-1)+c},easeInOutQuart:function(a,b,c,d,e){if((b/=e/2)<1)return d/2*b*b*b*b+c;return-d/2*((b-=2)*b*b*b-2)+c},easeInQuint:function(a,b,c,d,e){return d*(b/=e)*b*b*b*b+c},easeOutQuint:function(a,b,c,d,e){return d*((b=b/e-1)*b*b*b*b+1)+c},easeInOutQuint:function(a,b,c,d,e){if((b/=e/2)<1)return d/2*b*b*b*b*b+c;return d/2*((b-=2)*b*b*b*b+2)+c},easeInSine:function(a,b,c,d,e){return-d*Math.cos(b/e*(Math.PI/2))+d+c},easeOutSine:function(a,b,c,d,e){return d*Math.sin(b/e*(Math.PI/2))+c},easeInOutSine:function(a,b,c,d,e){return-d/2*(Math.cos(Math.PI*b/e)-1)+c},easeInExpo:function(a,b,c,d,e){return b==0?c:d*Math.pow(2,10*(b/e-1))+c},easeOutExpo:function(a,b,c,d,e){return b==e?c+d:d*(-Math.pow(2,-10*b/e)+1)+c},easeInOutExpo:function(a,b,c,d,e){if(b==0)return c;if(b==e)return c+d;if((b/=e/2)<1)return d/2*Math.pow(2,10*(b-1))+c;return d/2*(-Math.pow(2,-10*--b)+2)+c},easeInCirc:function(a,b,c,d,e){return-d*(Math.sqrt(1-(b/=e)*b)-1)+c},easeOutCirc:function(a,b,c,d,e){return d*Math.sqrt(1-(b=b/e-1)*b)+c},easeInOutCirc:function(a,b,c,d,e){if((b/=e/2)<1)return-d/2*(Math.sqrt(1-b*b)-1)+c;return d/2*(Math.sqrt(1-(b-=2)*b)+1)+c},easeInElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e)==1)return c+d;g||(g=e*.3);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return-(h*Math.pow(2,10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g))+c},easeOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e)==1)return c+d;g||(g=e*.3);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return h*Math.pow(2,-10*b)*Math.sin((b*e-f)*2*Math.PI/g)+d+c},easeInOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e/2)==2)return c+d;g||(g=e*.3*1.5);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);if(b<1)return-0.5*h*Math.pow(2,10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g)+c;return h*Math.pow(2,-10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g)*.5+d+c},easeInBack:function(a,c,d,e,f,g){g==b&&(g=1.70158);return e*(c/=f)*c*((g+1)*c-g)+d},easeOutBack:function(a,c,d,e,f,g){g==b&&(g=1.70158);return e*((c=c/f-1)*c*((g+1)*c+g)+1)+d},easeInOutBack:function(a,c,d,e,f,g){g==b&&(g=1.70158);if((c/=f/2)<1)return e/2*c*c*(((g*=1.525)+1)*c-g)+d;return e/2*((c-=2)*c*(((g*=1.525)+1)*c+g)+2)+d},easeInBounce:function(b,c,d,e,f){return e-a.easing.easeOutBounce(b,f-c,0,e,f)+d},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?d*7.5625*b*b+c:b<2/2.75?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:b<2.5/2.75?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c},easeInOutBounce:function(b,c,d,e,f){if(c<f/2)return a.easing.easeInBounce(b,c*2,0,e,f)*.5+d;return a.easing.easeOutBounce(b,c*2-f,0,e,f)*.5+e*.5+d}})}(jQuery);

/**
 * jQuery.ScrollTo - Easy element scrolling using jQuery.
 * Copyright (c) 2007-2009 Ariel Flesler - aflesler(at)gmail(dot)com | http://flesler.blogspot.com
 * Dual licensed under MIT and GPL.
 * Date: 5/25/2009
 * @author Ariel Flesler
 * @version 1.4.2
 *
 * http://flesler.blogspot.com/2007/10/jqueryscrollto.html
 */
;(function(d){var k=d.scrollTo=function(a,i,e){d(window).scrollTo(a,i,e)};k.defaults={axis:'xy',duration:parseFloat(d.fn.jquery)>=1.3?0:1};k.window=function(a){return d(window)._scrollable()};d.fn._scrollable=function(){return this.map(function(){var a=this,i=!a.nodeName||d.inArray(a.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!i)return a;var e=(a.contentWindow||a).document||a.ownerDocument||a;return d.browser.safari||e.compatMode=='BackCompat'?e.body:e.documentElement})};d.fn.scrollTo=function(n,j,b){if(typeof j=='object'){b=j;j=0}if(typeof b=='function')b={onAfter:b};if(n=='max')n=9e9;b=d.extend({},k.defaults,b);j=j||b.speed||b.duration;b.queue=b.queue&&b.axis.length>1;if(b.queue)j/=2;b.offset=p(b.offset);b.over=p(b.over);return this._scrollable().each(function(){var q=this,r=d(q),f=n,s,g={},u=r.is('html,body');switch(typeof f){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(f)){f=p(f);break}f=d(f,this);case'object':if(f.is||f.style)s=(f=d(f)).offset()}d.each(b.axis.split(''),function(a,i){var e=i=='x'?'Left':'Top',h=e.toLowerCase(),c='scroll'+e,l=q[c],m=k.max(q,i);if(s){g[c]=s[h]+(u?0:l-r.offset()[h]);if(b.margin){g[c]-=parseInt(f.css('margin'+e))||0;g[c]-=parseInt(f.css('border'+e+'Width'))||0}g[c]+=b.offset[h]||0;if(b.over[h])g[c]+=f[i=='x'?'width':'height']()*b.over[h]}else{var o=f[h];g[c]=o.slice&&o.slice(-1)=='%'?parseFloat(o)/100*m:o}if(/^\d+$/.test(g[c]))g[c]=g[c]<=0?0:Math.min(g[c],m);if(!a&&b.queue){if(l!=g[c])t(b.onAfterFirst);delete g[c]}});t(b.onAfter);function t(a){r.animate(g,j,b.easing,a&&function(){a.call(this,n,b)})}}).end()};k.max=function(a,i){var e=i=='x'?'Width':'Height',h='scroll'+e;if(!d(a).is('html,body'))return a[h]-d(a)[e.toLowerCase()]();var c='client'+e,l=a.ownerDocument.documentElement,m=a.ownerDocument.body;return Math.max(l[h],m[h])-Math.min(l[c],m[c])};function p(a){return typeof a=='object'?a:{top:a,left:a}}})(jQuery);;
/* END /DuttiNEWStorefrontAssetStore/js/plugins.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/cookieManager.js (en_US) */
/**
 * Metodo que genera una cookie
 * nombre: Nombre de la cookie
 * valor: Valor de la cookie
 * exdays: das en los que expirar la cookie
 */
function setCookie(nombre, valor, exdays, urlPath) {
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    var c_value = escape(valor) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
    var path = urlPath ? '; path=' + (urlPath) : '';
    document.cookie = nombre + "=" + c_value + path;

}

/**
 * Metodo que recupera el valor de una cookie
 */
function getCookie(nombre) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for( i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if(x == nombre) {
            return unescape(y);
        }
    }
    return null;
}


/**
 * Metodo que elimina una cookie
 */
function removeCookie(nombre) {
    var d = new Date();
    document.cookie = nombre+"=1;expires=" + d.toGMTString() + ";" + ";";

}

function unique(list) {
    var result = [];
    $.each(list, function(i, e) {
        if ($.inArray(e, result) == -1) result.push(e);
    });
    return result;
}
;
/* END /DuttiNEWStorefrontAssetStore/js/cookieManager.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Dutti.js (en_US) */
InditexClass.prototype.cacheShippingMethodsByZipCode = {};
InditexClass.prototype.cacheShippingMethodsRestrictedByZipCode = {};
$.validator.defaults.errorElement='p';

function escapeHtml(text) {
    return (text==null?'':$('<div/>').text(text).html());
}

function updateUserMenu(json){

    items = $('.b ul li');
    if(!Inditex.iStoreJSON.isOpenForSale){
        return;
    }

    if($('#shopcart')){
        $('#shopcart').addClass('last');
    }

    $('#shopcart').css({'display' : 'block'});
    if (json.userType == 'G') {
        $("#unregisteredUserMenuItem").css({'display' : 'block'});
        $("#userLogued").css({'display' : 'none'});
        //NO mostrar opciones wallet, tarjetas y baja de wallet
        $("#bajaWalletHeader").css({'display' : 'none'});
        $("#gestionTarjetasHeader").css({'display' : 'none'});

    } else {

        $("#unregisteredUserMenuItem").css({'display' : 'none'});

        $('#cuenta_logged').hide();
        $('#cuenta_but').parent().hide();

        var nameLogged = $("#user_but");
        if (nameLogged) {
            var newName = escapeHtml((json.firstName + ' ' + json.lastName).toUpperCase());
            var nameLogout = $('#msgLogout').val();
            nameLogged.html(newName + ' <a onclick="logout()">'+ nameLogout +'</a>');
        }

        $('#user_but').after();
        $('#user_but').parent().show();
        cuentaLoggedBinds();
        //mostrar opciones wallet, tarjetas y baja de wallet

        if (json.isWalletUser == true){
            $("#bajaWalletHeader").css({'display' : 'block'});
            $("#gestionTarjetasHeader").css({'display' : 'block'});
        }
        else
        {
            $("#bajaWalletHeader").css({'display' : 'none'});
            $("#gestionTarjetasHeader").css({'display' : 'none'});
        }
    }
    var count = 0;
    $.each(json.shopCart.items, function(i,j){
        if(j.reference !== "XGIFTSKU"){
            count += j.quantity;
        }
    });

    $('#bag_count').html(count);

    var link = $('#shoppingCartURL').attr('value');

    //Dependiendo del n?mero de unidades el carrito puede ser clicable
    if(count>0){
        $('#bag').fadeIn();
        $('#shopcart a').attr('href',link);
        Inditex.clickItxOrderManageCmd($('#shopcart a'));
    }else{
        $('#shopcart a').attr('href','#');
    }
    // si no hay productos:
    if(parseInt($('#bag_count').html()) == 0) {
        $('.wicon.bag').css('padding-left', 0);
    } else {
        $('.wicon.bag').css('padding-left', 14);
    }
}

function readDate(field, day, month, year){
    if(field == null || day == null || month == null || year == null){
        return;
    }
    var birthdate = field.val().split("/");
    var formatDateEval = getMessage('formatDateForEvaluation').split("/");
    if (birthdate.length == 3 && formatDateEval.length == birthdate.length) {
        var parameterName;
        for( var i = 0; i < formatDateEval.length;i++){
            parameterName = formatDateEval[i];
            if(parameterName == 'dd'){
                day.val(birthdate[i]);
            }
            if(parameterName == 'mm'){
                month.val(birthdate[i]);
            }
            if(parameterName == 'aaaa'){
                year.val(birthdate[i]);
            }
        }
    }
}

function writeDate(field,value){
    if(field == null || value == null){
        return;
    }
    var birthdate = value.split("/");
    var formatDateEval = getMessage('formatDateForEvaluation').split("/");
    var result = '';
    if (birthdate.length == 3 && formatDateEval.length == birthdate.length) {
        for( var i = 0; i < formatDateEval.length;i++){
            var parameterName = formatDateEval[i];
            if(parameterName == 'dd'){
                result += birthdate[0] + '/';
            }
            if(parameterName == 'mm'){
                result += birthdate[1] + '/';
            }
            if(parameterName == 'aaaa'){
                result += birthdate[2] + '/';
            }
        }
        //se elimina la ?ltima barra introducida
        field.val( result.substring(0, result.length-1));
    }
}

InditexClass.prototype.drawHeader = function() {
    var self = this;
    self.getUserJSON(function(json) {
        $('#iUserType').val(json.userType);
        new ItxHeaderDisplayTunelClass();
        //Para la pagina de confirmacion compra como invitado
        if ($("#esSeguimientoPedido").length > 0) { //si existe este input, estamos en la pagina de confirmacion 

            if ( $("#isUserGuest").attr('value')=="true" || $("#esSeguimientoPedido").attr('value')=="true" ) {
                $("#unregisteredUserMenuItem").attr('style','display:none;');
            }

        }
    });
};

InditexClass.prototype.popupHtml = function(aHtml, aWidth, aHeight, aCallback) {
    var idModal = 'itx_popup_modal'

    var overlayId = 's_overlay';
    var alreadyOverlay = false;

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    closeModalNoCallback();
    $('<div/>', {
        'id' : overlayId,
        'class' : 'transp',
        'style' : 'height:' + aHeight + 'px; width:' + aWidth + 'px'
    }).appendTo('body');
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#' + overlayId);
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });

    //Creamos modal
    $('<div/>', {
        'id' : idModal
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#'+ idModal).append(aHtml);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : aWidth,
            'height' : aHeight
        })
    })
    setTimeout(function() {
        $('#'+idModal).fadeIn();
    }, 300)

    $('#' + overlayId).css('left', 0).fadeIn(function() {
        $('#close_overlay').bind('click', function() {
            closeModal(this);
        });
    })

    $('#' + overlayId).find('#close_modal').bind('click', function() {
        closeModal(this);
    });

    if (aCallback) {
        aCallback(this);
    }
};

InditexClass.prototype.getNumOfProducts = function(cart) {
    if (cart == undefined)
        cart='shopCart';
    var self = this;
    var json =self._readUserJSON();
    if (json) {
        return json[cart].items.length;
    }
    return 0;
};

InditexClass.prototype.hasProductInCart = function(cart, item) {
    var self = this;
    var json =self._readUserJSON();
    if (json) {
        var arrayItems= json[cart].items;
        for ( var i = 0; i < arrayItems.length; i++) {
            if (arrayItems[i].id == item) {
                return true;
            }
        }
    }
    return false;

};

InditexClass.prototype.hasProductInWishCart = function(item) {
    return this.hasProductInCart('wishCart', item);
};

InditexClass.prototype.hasProductInShopCart = function(item) {
    return this.hasProductInCart('shopCart', item);
};


/*
 InditexClass.prototype.generateUrl = function(aProtocol, aAction, aParams) {
 var url = aProtocol + "//" + Inditex.iDomainName 
 + "/webapp/wcs/stores/servlet/" + aAction;

 var first = true;
 for (var i in aParams) {
 url += (first ? "?" : "&") + i + "=" + encodeURIComponent(aParams[i]);
 first = false;
 }

 return url;
 };
 */
InditexClass.prototype.checkMiddleName = function checkMiddleName(middleName) {
    return (Inditex.iStoreJSON.details.isMiddleName && $.trim(middleName) != "");
}

//2? FASE DE LA INTEGRACION
InditexClass.prototype.getShippingMethodsByZipCode = function(zipCode) {
    var self = this;

    if (!self.cacheShippingMethodsByZipCode[zipCode]) {
        var path = "/order/store/" + self.iStoreId + "/"+ self.iCatalogId+"/shipping";
        if (self.iIsMockup) {
            path += ".json";
        }
        path += "?zipCode=" + zipCode + "&searchType=0";
        Inditex.iAjaxAsync = false;
        self.getRestJSON(location.protocol, 1, path, null,
            function(text){
                self.cacheShippingMethodsByZipCode[zipCode] = text;
            },
            function(text){
                console.log('Error al recuperar los m?todos de env?o para un c?digo postal');
            }
        );
        Inditex.iAjaxAsync = true;
    }
    return self.cacheShippingMethodsByZipCode[zipCode];
};

//2? FASE DE LA INTEGRACION
InditexClass.prototype.getShippingMethodsRestrictedByZipCode = function(zipCode,aOnSuccess,aOnFailure) {
    var self = this;
    if (!self.cacheShippingMethodsRestrictedByZipCode[zipCode]) {
        var json;
        var path = "/order/store/" + self.iStoreId + "/"+ self.iCatalogId+"/shipping";
        path += "?zipCode=" + zipCode + "&searchType=1";
        self.getRestJSON(
            location.protocol,
            1,
            path,
            null,
            function(aText){
                Inditex.cacheShippingMethodsRestrictedByZipCode[zipCode] = aText;
                if (aOnSuccess) {
                    aOnSuccess(aText);
                }
            },
            aOnFailure);
    } else {
//		console.log("cacheShippingMethodsRestrictedByZipCode:");
//		console.log(self.cacheShippingMethodsRestrictedByZipCode[zipCode]);
        aOnSuccess(self.cacheShippingMethodsRestrictedByZipCode[zipCode]);
    }
};

$(document).ready(function(){
    if (navigator.userAgent.indexOf('MSIE') !== -1 || navigator.appVersion.indexOf('Trident/') > 0) {
        $('[placeholder]').each(function () {
            $(this).placeholder();
        });
    };
});
;
/* END /DuttiNEWStorefrontAssetStore/js/Dutti.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/modalPlugin.js (en_US) */
function trackPageAndAddScroll(data) {
    Inditex.trackPage( data[0],true);
    addScroll(data[1]);
}

function addScroll(divId){
    if (divId.length > 1){
        if(!isIPad())
            $("#"+divId[1]).find("#"+divId[0]).jScrollPane();
        else
            $("#"+divId[1]).find("#"+divId[0]).css({'overflow':'auto'});
    }else{
        if(!isIPad())
            $("#"+divId[0]).jScrollPane();
        else
            $("#"+divId[0]).css({'overflow':'auto'});
    }
}

function openBigModal(url, params, onReady, top, height) {
    openModalAux(url, params, onReady, "big_modal", top, height);
}

function openGenericModal(url, params, onReady, top, height, secondary, secondary_popupCesta, userCloseCallback) {
    openModalAux(url, params, onReady, "general_modal", top, height, secondary, secondary_popupCesta, userCloseCallback);
}

function openGenericModalReserva(url, params, onReady, top, height, secondary) {
    openModalAuxReserva(url, params, onReady, "general_modal", top, height, secondary);
}

function openFormModal(url, params, onReady, top, height, userCloseCallback) {
    openModalAux(url, params, onReady, "general_modal", top, height,false,false, userCloseCallback);
}

function openLargeModal(url, params, onReady, top, height) {
    openModalAux(url, params, onReady, "large_modal", top, height);
}

function openOneClickModal(url, params, onReady, top, height) {
    openOneClickModalAux(url, params, onReady, "large_modal", top, height);
}


function openMiniModal(url, params, onReady, top, height) {
    openModalAux(url, params, onReady, "mini_modal", top, height);
}

function openGenericModalPassword(url, params, onReady, top, height, secondary) {
    openModalAux(url, params, onReady, "general_modal", top, height, secondary);
}

/*
 *
 * Ventana modal generica
 *
 */
function openModalAux(url, params, onReady, divId, top, height, secondary, secondary_popupCesta, userCloseCallback) {
    if(divId == null)
        divId = "general_modal";

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        overlayId = 's_over_overlay';
        alreadyOverlay = true;
        divId = "general_modal_sec";
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE ");
    var myTop;
    if (msie > 0){
        myTop = $(window).height();
    }else {
        myTop = window.innerHeight;
    }

    if(!secondary) {
        closeModalNoCallback();

        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + myTop + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');


        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + myTop + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#s_overlay');
        $('<div/>', {
            'id' : 'close_over_overlay'
        }).appendTo('#' + overlayId);
    }
    if((!secondary_popupCesta)&&($('.overlay_bg_cesta').length>0)){
        var previusPage =$('.overlay_bg_cesta').data('page');
        if(previusPage!==undefined){
            $('#' + overlayId).data('page',previusPage);
        }
    }else{
        Inditex.ga(function(tracker) {
            var defaultPage = tracker.get('page');
            $('#' + overlayId).data('page',defaultPage);
        });
    }

    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'style' :(height!= null)? 'overflow:hidden':'overflow:auto'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal
    jQuery.xajax({
        url: url,
        type: "get",
        dataType: 'html',
        success: function(data) {
            $('#'+divId).html(data);
            var gaLogic = $('.data-ga-logic-universal',$('#'+divId)).attr('data-ga-logic-universal');
            if (gaLogic) {
                Inditex.trackPage( gaLogic,true);
            } else {
                gaLogicu = $('.data-ga-logic-universal',$('#'+divId)).attr('data-ga-logic-universal-tunel');
                if (gaLogicu && typeof extraPageview!="undefined") {
                    if (gaLogicu.match(/\/$/) && extraPageview.match(/^\//)) {
                        gaLogicu = gaLogicu.substr(0, gaLogicu.length-1);
                    }
                    Inditex.trackPage( gaLogicu+extraPageview,true);
                }
            }
            if(!secondary) {
                $('#' + overlayId).find('#close_modal').bind('click', function(e) {
                    closeModal(this,e.which?userCloseCallback:null);
                });
            } else {
                $('#' + overlayId).find('#close_modal').bind('click', function(e) {
                    closeSecondaryModal(this,e.which?userCloseCallback:null);
                });
            }

            calculatedHeight = (height != null ? myTop * height : myTop);

            if(height != null) {
                $('#' + divId).css({
                    'height' : calculatedHeight
                });
                if(top == null) {
                    $('#' + divId).css({
                        'top' : (myTop - calculatedHeight) / 4
                    });
                    //$('#' + divId).offset({top: (myTop - calculatedHeight) /2});
                }
            }

            if(top != null) {
                $('#' + divId).css({
                    'top' : myTop / 2 - top
                });
            } else {

            }
            $(window).bind('resize', function() {
                $('#s_overlay').css({
                    'width' : $(window).width(),
                    'height' : myTop
                })
                $('#'+overlayId).css({
                    'width' : $(window).width(),
                    'height' : myTop
                })
                if(top != null) {
                    $('#' + divId).css({
                        'top' : calculatedHeight / 2 - top
                    });
                }
            })
            if(!secondary_popupCesta){
                closePopupCestaNoCallback();
            }
            setTimeout(function() {
                $('#' + divId).find("#scrollable").css({
                    'height' : calculatedHeight
                });
                $('#' + divId).fadeIn(function(){
                });
                if((onReady != null) && (onReady != undefined))
                    onReady(params);

            }, 300)
            if(!secondary) {
                $('#' + overlayId).css('left', 0).fadeIn(function() {
                    $('#close_overlay').bind('click', function(e) {
                        closeModal(this,e.which?userCloseCallback:null);
                    });
                })
            } else {
                // $('#'+overlayId).css('left', 0).fadeIn(function() {
                // $('#close_over_overlay').bind('click', function() {
                // closeSecondaryModal(this);
                // });
                // })
                $('#' + overlayId).css('left', 0).show();
                $('#close_over_overlay').bind('click', function(e) {
                    closeSecondaryModal(this,e.which?userCloseCallback:null);
                });
            }
            if(isIPad() && !isIPad_5()){

                $('body').height(document.height);
                $('body').css({'position':'relative'});
                $('#'+overlayId).css({'position':'absolute'});
            }
            if(jQuery('input[name^=address1]').length > 0){
                jQuery('input[name^=address1]').attr('maxlength',100);
            }
            if(jQuery('input[name^=address2]').length > 0){
                jQuery('input[name^=address2]').attr('maxlength',50);
            }
        }
    });
}

function openModalAuxReserva(url, params, onReady, divId, top, height, secondary) {
    if(divId == null)
        divId = "general_modal";

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        overlayId = 's_over_overlay';
        alreadyOverlay = true;
        divId = "general_modal_sec";
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#s_overlay');
        $('<div/>', {
            'id' : 'close_over_overlay'
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'class' : 'general_modal_reserva_store',
        'style' :(height!= null)? 'overflow:hidden':'overflow:auto'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal
    jQuery.xajax({
        url: url,
        type: "get",
        dataType: 'html',
        success: function(data) {
            $('#'+divId).html(data);
            if(!secondary) {
                $('#' + overlayId).find('#close_modal').bind('click', function() {
                    closeModal(this);
                });
            } else {
                $('#' + overlayId).find('#close_modal').bind('click', function() {
                    closeSecondaryModal(this);
                });
            }

            calculatedHeight = (height != null ? $(window).height() * height : $(window).height());

            if(height != null) {
                $('#' + divId).css({
                    'height' : calculatedHeight
                });
                if(top == null) {
                    $('#' + divId).css({
                        'top' : ($(window).height() - calculatedHeight) / 4
                    });
                    //$('#' + divId).offset({top: ($(window).height() - calculatedHeight) /2});
                }
            }

            if(top != null) {
                $('#' + divId).css({
                    'top' : $(window).height() / 2 - top
                });
            } else {

            }
            $(window).bind('resize', function() {
                $('#s_overlay').css({
                    'width' : $(window).width(),
                    'height' : $(window).height()
                })
                $('#'+overlayId).css({
                    'width' : $(window).width(),
                    'height' : $(window).height()
                })
                if(top != null) {
                    $('#' + divId).css({
                        'top' : calculatedHeight / 2 - top
                    });
                }
            })
            setTimeout(function() {

                $('#' + divId).find("#scrollable").css({
                    'height' : calculatedHeight
                });
                $('#' + divId).fadeIn(function(){
                });
                if((onReady != null) && (onReady != undefined))
                    onReady(params);

            }, 300)
            if(!secondary) {
                $('#' + overlayId).css('left', 0).fadeIn(function() {
                    $('#close_overlay').bind('click', function() {
                        closeModal(this);
                    });
                })
            } else {
                // $('#'+overlayId).css('left', 0).fadeIn(function() {
                // $('#close_over_overlay').bind('click', function() {
                // closeSecondaryModal(this);
                // });
                // })
                $('#' + overlayId).css('left', 0).show();
                $('#close_over_overlay').bind('click', function() {
                    closeSecondaryModal(this);
                });
            }
            if(isIPad() && !isIPad_5()){

                $('body').height(document.height);
                $('body').css({'position':'relative'});
                $('#'+overlayId).css({'position':'absolute'});
            }

            var symbolPosition = DUTTI_PRICE_SUFFIX_POS.length==0;
            if (!symbolPosition)
                moneda = DUTTI_PRICE_SUFFIX_POS;
            else
                moneda=DUTTI_PRICE_PREFIX_POS;

            $('.moneda').html (moneda);
        }
    });
}

/* Cargar nueva pagina en modal ya abierta */
function openGenericModalWihtoutEffect(url, params, onReady, divId, callback, closeCallback) {

    //ocultamos la modal actual
    $('#' + divId).fadeOut();
    // Meter aqu los contenidos del modal
    setTimeout(function() {
        //se carga la nueva pgina y se muestra

        jQuery.xajax({
            url: url,
            type: "get",
            dataType: 'html',
            success: function(data) {

                $('#' + divId).html(data);
                var gaLogic = $('.data-ga-logic-universal',$('#'+divId)).attr('data-ga-logic-universal');
                if (gaLogic) {
                    Inditex.trackPage( gaLogic,true);
                } else {
                    gaLogicu = $('.data-ga-logic-universal',$('#'+divId)).attr('data-ga-logic-universal-tunel');
                    if (gaLogicu && typeof extraPageview!="undefined") {
                        if (gaLogicu.match(/\/$/) && extraPageview.match(/^\//)) {
                            gaLogicu = gaLogicu.substr(0, gaLogicu.length-1);
                        }
                        Inditex.trackPage( gaLogicu+extraPageview,true);
                    }
                }

                $('#' + divId).fadeIn(function() {

                    $('#close_modal').bind('click', function() {
                        closeModal(this,closeCallback);
                    });
                    $('#close_overlay').unbind('click').bind('click', function(e) {
                        closeModal(this,closeCallback);
                    });
                });

                if((callback != null) && (callback != undefined)) {
                    callback();
                }
            }
        });
    }, 300)

    if((onReady != null) && (onReady != undefined))
        onReady(params);
}


/**
 * Muestra una modal estandar con titulo y mensaje (para modales que obtienen mensaje de JSON)
 */
function openStaticModal(titulo, mensaje, secondary, onClose) {
    var modal = '<p class="title">' + titulo + '</p><p>' + mensaje + '</p><a id="close_modal" href="javascript:void(0)" class="close_modal">&nbsp;</a>';

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        if($("#s_over_overlay").size() > 0){
            overlayId = 's_over_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_ter";
            oldOverlayId = "s_over_overlay" ;
            closeOverlayId = "close_over_over_overlay";
        }else{
            overlayId = 's_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_sec";
            oldOverlayId = "s_overlay";
            closeOverlayId = "close_over_overlay";
        }
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#'+oldOverlayId);
        $('<div/>', {
            'id' : closeOverlayId
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //Creamos modal
    $('<div/>', {
        'id' : 'static_modal'
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#static_modal').html(modal);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#static_modal').fadeIn();
    }, 300)
    if(!secondary) {
        $('#' + overlayId).css('left', 0).fadeIn(function() {
            $('#close_overlay').bind('click', function() {
                if (onClose != null) onClose();
                closeModal(this);
            });
        })
    } else {
        $('#' + overlayId).css('left', 0).show();
        $('#'+closeOverlayId).bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }

    if(!secondary) {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeModal(this);
        });
    } else {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }
}


/**
 * Muestra una modal estandar con titulo y mensaje (para modales que obtienen mensaje de JSON)
 */
function openStaticHtmlModal(modal, idModal, secondary, onClose) {

    if (idModal == null) {
        idModal = 'static_modal'
    }

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        if($("#s_over_overlay").size() > 0){
            overlayId = 's_over_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_ter";
            oldOverlayId = "s_over_overlay" ;
            closeOverlayId = "close_over_over_overlay";
        }else{
            overlayId = 's_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_sec";
            oldOverlayId = "s_overlay";
            closeOverlayId = "close_over_overlay";
        }
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#'+oldOverlayId);
        $('<div/>', {
            'id' : closeOverlayId
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //Creamos modal
    $('<div/>', {
        'id' : idModal
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#'+ idModal).html(modal);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#'+idModal).fadeIn();
    }, 300)
    if(!secondary) {
        $('#' + overlayId).css('left', 0).fadeIn(function() {
            $('#close_overlay').bind('click', function() {
                if (onClose != null) onClose();
                closeModal(this);
            });
        })
    } else {
        $('#' + overlayId).css('left', 0).show();
        $('#'+closeOverlayId).bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }

    if(!secondary) {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeModal(this);
        });
    } else {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }
}

/**
 * Muestra una modal estandar con titulo y mensaje (para modales que obtienen mensaje de JSON y necesitan ancho)
 */
function openStaticModalPassword(titulo, mensaje, secondary, onClose, width) {
    var modal = '<p class="title">' + titulo + '</p><p>' + mensaje + '</p><a id="close_modal" href="javascript:void(0)" class="close_modal">&nbsp;</a>';

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        if($("#s_over_overlay").size() > 0){
            overlayId = 's_over_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_ter";
            oldOverlayId = "s_over_overlay" ;
            closeOverlayId = "close_over_over_overlay";
        }else{
            overlayId = 's_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_sec";
            oldOverlayId = "s_overlay";
            closeOverlayId = "close_over_overlay";
        }
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#'+oldOverlayId);
        $('<div/>', {
            'id' : closeOverlayId
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //Creamos modal
    $('<div/>', {
        'id' : 'static_modal'
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#static_modal').html(modal);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#static_modal').fadeIn();
        $('#static_modal').css('position','absolute');
        $('#static_modal').css('left','50%');
        $('#static_modal').css('top','97px');
        $('#static_modal').css('width','660px');
        $('#static_modal').css('margin-left','-340px');
        $('#static_modal').css('padding-top','50px');
        $('#static_modal').css('padding-bottom','50px');

        $('#titlePasswordUpdate').css('font-family','Georgia,"Times New Roman",Times,serif');
        $('#titlePasswordUpdate').css('margin-bottom','15px');
        $('#titlePasswordUpdate').css('text-align','center');
        $('#titlePasswordUpdate').css('width','90%');

        $('#titlePasswordUpdate').css('font-size', '12px');
        $('#titlePasswordUpdate').css('margin-left','35px');
        $('#titlePasswordUpdate').css('margin-top', '0');

        $('#mensaje').css('font-size', '12px');
        $('#mensaje').css('margin-left','35px');
        $('#mensaje').css('margin-top', '0');
    }, 300)
    if(!secondary) {
        $('#' + overlayId).css('left', 0).fadeIn(function() {
            $('#close_overlay').bind('click', function() {
                if (onClose != null) onClose();
                closeModal(this);
            });
        })
    } else {
        $('#' + overlayId).css('left', 0).show();
        $('#'+closeOverlayId).bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }

    if(!secondary) {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeModal(this);
        });
    } else {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }
}

function closeModalNoCallback() {
    var previusPage = $('#s_overlay').data('page');
    $('#s_overlay').remove();
    if (previusPage!==undefined) {
        Inditex.ga('set', 'page', previusPage);
    }
}

function closeModal(element,callback) {
    var previusPage = $('#s_overlay').data('page');
    $('#s_overlay').fadeOut(function() {
        $(this).remove();
        folding = false;
    })
    if (typeof callback === "function") {
        callback();
    }
    if (previusPage!==undefined) {
        Inditex.ga('set', 'page', previusPage);
    }
}

function closePopupCestaNoCallback() {
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var overlay= $('.overlay_bg_cesta');
    var popup = $('.popupHtmlCesta');
    overlay.fadeOut(function(){
        $(this).remove();
        popup.remove();
        if(isiPad) {
            $('body').css({'overflow': 'initial', 'position': 'initial'});
        }
    });
}

function closePopupCesta(popup,overlay, callback) {
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var previusPage = overlay.data('page');
    popup.hide();
    overlay.fadeOut(function(){
        $(this).remove();
        popup.remove();
        if(isiPad) {
            $('body').css({'overflow': 'initial', 'position': 'initial'});
        }
    });
    if (typeof callback === "function") {
        callback();
    }
    if (previusPage!==undefined) {
        Inditex.ga('set', 'page', previusPage);
    }
}

function closeSecondaryModal(element,callback) {
    var previusPage = $('#s_over_overlay').data('page');
    // $('#s_over_overlay').fadeOut(function() {
    // $(this).remove();
    // });
    $('#s_over_overlay').hide();
    $('#s_over_overlay').remove();
    if (callback) {
        callback();
    }
    if (previusPage!==undefined) {
        Inditex.ga('set', 'page', previusPage);
    }
}



/**
 * Valida formulario para acceder a tu cuenta
 */
function validateLogin(formElem, url, type) {

    var url = $("#urlDetallesReserva").val();

    $(formElem).validate({
        submitHandler : function(form) {
            //Se abre la modal de mi cuenta
            var formRegister = $("#formLogin");
            jQuery.xajax({
                url: formRegister.attr("action"),
                type: 'post',
                data: formRegister.serialize(),
                success: function(jsonRequest) {

                    if ((jsonRequest) && ((jsonRequest.errorKey==undefined) || (jsonRequest.errorKey==null))) {
                        Inditex.getUserJSON(function(user){
                            if (Inditex) {
                                Inditex.trackPage("Identificate/Envio_OK");
                                if (type=='booking') {
                                    Inditex.trackEvent( "Consulta_stock", "Iniciar_sesion_ok",null,{dimension19:user.isWalletUser?'Si':'No'});
                                } else {
                                    Inditex.trackEvent( "Iniciar_sesion", "Iniciar_sesion_ok",null,{dimension19:user.isWalletUser?'Si':'No'});
                                }
                            }

                            if (jsonRequest.data.passwordExpired == "1") {
                                openModalCambioPasswordExpired($('#urlResetPassword').val(),null,200,null, $('#captchaURL').val(), null);
                            } else {
                                if(type == 'booking'){
                                    Inditex.drawHeader();
                                    var url = $("#urlDetallesReserva").val();
                                    openGenericModalReserva(url,null,function(){Inditex.trackPage( 'Ficha_producto/'+partNumber+'/Consulta_stock/Reservar_talla/Solicitud_confirmacion',true)},200,null);


                                }
                                else{
                                    Inditex.drawHeader();

                                    closeModal(this.window);

                                    if ($(".boton_login").length>0) { // si nos hemos registrado desde el seguimiento de pedido de usuario guest
                                        $(".boton_login").hide ();
                                        openStaticModal(Messages.titleSendToFriend, Messages.asociacionDePedidoACuentaOK, false);
                                    }

                                    if (jsonRequest.data.middleName=="-1") {
                                        openStaticModal(Messages.middleNameTitle,Messages.middleNameText, false);
                                    }
                                }

                                //Si nos logueamos en el tunel de compra
                                if($("#pasos li.active").length){
                                    if((/paso2/.test($("#pasos li.active").attr('class'))) || (/paso3/.test($("#pasos li.active").attr('class'))) || (/paso4/.test($("#pasos li.active").attr('class'))) ) {

                                        //Si somos usarios invitados (compra sin registro), redireccionamos a la cesta d ela compra desde cualquier paso en el que estemos
                                        if ($("#isUserGuest").attr('value')=="true") {

                                            Inditex.orderManage({'url':$('#shoppingCartURL').attr('value')})
                                        }
                                        else { //Si no est? habilitada la compra sin registro y estamos en el paso 2 y nos logueamos en la cabecera, redireccionamos al siguiente paso (metodos de envio)
                                            if( (/paso2/.test($("#pasos li.active").attr('class'))) ) {
                                                window.location.href = $("#OrderShippingUrl").attr('value');
                                            }
                                        }
                                    }
                                }
                                if (typeof shopCartJSON != 'undefined'){

                                    var url= Inditex.generateUrl("ShopCartJSON", {
                                        "storeId": Inditex.iStoreId,
                                        "langId": Inditex.iLangId,
                                        "catalogId": Inditex.iCatalogId
                                    },true);

                                    Inditex.request({
                                        "url": url,
                                        "method": "get",
                                        "onSuccess": function(text) {
                                            var aJsonResponse = Inditex.evalJSON(text);
                                            shopCartJSON = aJsonResponse;

                                            var hasGiftPacking;
                                            var textoChanged = false;
                                            if (shopCartJSON.isGift == "true") hasGiftPacking=true;
                                            else hasGiftPacking = false;
                                            var isAGift = hasGiftPacking || ((shopCartJSON.description != undefined) && (shopCartJSON.description != null) && (jQuery.trim(shopCartJSON.description) != ""));
                                            cargarCesta();
                                        },
                                        "onFailure": function(text) {
                                            showError(ITX_TEXT_GENERIC_PROBLEM);
                                        }
                                    });
                                }
                            }
                        });
                    } else{
                        if (Inditex) {
                            Inditex.trackPage("Identificate/Envio_Error_KO");
                            if (type=='booking') {
                                Inditex.trackEvent( "Consulta_stock", "Iniciar_sesion_error",Inditex.codeError(jsonRequest.errorKey,jsonRequest.errorMessage),true);
                            } else {
                                Inditex.trackEvent( "Iniciar_sesion", "Iniciar_sesion_error",Inditex.codeError(jsonRequest.errorKey,jsonRequest.errorMessage),{dimension19:'unknown'});
                            }
                        }
                        if (jsonRequest.data.passwordExpired == "1") {
                            openModalCambioPasswordExpired($('#urlResetPassword').val(),null,200,null, $('#captchaURL').val(), null);
                        } else {
                            openStaticModal("ERROR", jsonRequest.errorMessage.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace("_supportPhone_",Inditex.iStoreJSON.details.supportPhone), true);
                        }
                    }
                }
            });
        },
        rules : {
            logonId : {
                required : true,
                email : true
            },
            logonPassword : {
                required : true
            }
        },
        messages : {
            logonId : Messages.logonId,
            logonPassword : Messages.logonPassword
        }
    });
}



function openModalCambioPasswordExpired(urlResetPassword, onReady,top, height, urlCaptcha, urlRedirect){
    divId='general_modal';
    var formCambioPass = '<form id="updatePasswordFormExpired" method="post" action="'+ urlResetPassword +'">'+
        '<p class="title">'+Messages.changePasswordExpiredTitle+'</p>'+
        '<p>'+Messages.changePasswordExpiredMessage+'</p>'+
        '<div id="modificar_pass">' +
        '<div class="block first">' +
        '<label>'+Messages.changePasswordExpiredPassActual+'</label>'+
        '<input type="password" name="logonPasswordOld" id="logonPasswordOld"/>'+
        '</div>' +
        '<div class="block two">' +
        '<div class="column">' +
        '<label>'+Messages.changePasswordExpiredNewPass+'</label>'+
        '<input type="password" name="logonPassword" id="logonPassword"/>'+
        '</div>'+
        '<div class="column">' +
        '<label>'+Messages.changePasswordExpiredVerifyPass+'</label>'+
        '<input type="password" name="logonPasswordVerify" id="logonPasswordVerify"/>'+
        '</div>'+
        '</div>'+
        '<div class="block">' +
        '<label>'+Messages.changePasswordExpiredCaptcha+'</label>'+
        '<img id="captchaImg" class="captcha" src="'+ urlCaptcha +'" alt="captcha" style="width:60%;margin-bottom:5px;"/>'+
        '<input type="text" id="captcha" name="captcha"/>'+
        '</div>'+
        '</div>'+
        '<span class="info_campo">'+Messages.camposObligatorios+'</span>'+
        '<div class="boton"  style="margin-top:5px;">'+
//							 '<a class="acc_butt l" href="javascript:void(0)" onclick="openGenericModalWihtoutEffect('+vueltaAtras+',null, null, general_modal)">'+Messages.recoverVolver+'</a>'+
        '<div class="">'+
        '<a class="acc_butt main" id="updatePasswordBtn" onclick="$(this).closest(updatePasswordFormExpired).submit();" href="javascript:void(0)">'+Messages.submit+'</a>'+
        '</div>'+
        '</div>'+
        '</form><a id="close_modal" class="close_modal" href="javascript:void(0)"> </a>';

    if(divId == null)
        divId = "general_modal";
    var overlayId;
    var alreadyOverlay = false;


    overlayId = 's_overlay';
    alreadyOverlay = false;


    closeModalNoCallback();
    $('<div/>', {
        'id' : overlayId,
        'class' : 'transp',
        'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
    }).appendTo('body');
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#' + overlayId);
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });

    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'style' :(height!= null)? 'overflow:hidden':'overflow:auto'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal

    $('#'+divId).html(formCambioPass);

    $('#' + overlayId).find('#close_modal').bind('click', function() {
        closeModal(this);
    });


    calculatedHeight = (height != null ? $(window).height() * height : $(window).height());

    if(height != null) {
        $('#' + divId).css({
            'height' : calculatedHeight
        });
        if(top == null) {
            $('#' + divId).css({
                'top' : ($(window).height() - calculatedHeight) / 4
            });
            //$('#' + divId).offset({top: ($(window).height() - calculatedHeight) /2});
        }
    }

    if(top != null) {
        $('#' + divId).css({
            'top' : $(window).height() / 2 - top
        });
    } else {

    }
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
        if(top != null) {
            $('#' + divId).css({
                'top' : calculatedHeight / 2 - top
            });
        }
    })
    setTimeout(function() {

        $('#' + divId).find("#scrollable").css({
            'height' : calculatedHeight
        });
        $('#' + divId).fadeIn(function(){
        });
        if((onReady != null) && (onReady != undefined))
            onReady(params);

    }, 300)

    $('#' + overlayId).css('left', 0).fadeIn(function() {
        $('#close_overlay').bind('click', function() {
            closeModal(this);
        });
    })


    $("#updatePasswordFormExpired").validate({
        submitHandler : function(form) {
            var form = $("#updatePasswordFormExpired");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                dataType: 'json',
                data: form.serialize(),
                success: function(data) {
                    $('#captchaImg').attr('src',urlCaptcha+"&t="+new Date().getTime());
                    if ((data) && ((data.errorKey==undefined) || (data.errorKey==null))) {
                        if (urlRedirect == null) {
                            window.location.href = window.location.href;
                        } else {
                            window.location.href = urlRedirect;
                        }
                    } else {
                        openStaticModal('ERROR', data.errorMessage, true);
                    }

                }
            });
        },
        rules : {
            logonPasswordOld : {
                validPassword: true,
                required : true,
                minlength : 8
            },
            logonPassword : {
                validNewPassword: true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                required : true,
                minlength : 8,
                equalTo : "#logonPassword"
            }
        },
        messages : {
            logonPasswordOld : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPassword : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPasswordVerify : {
                required : Messages.required,
                minlength : Messages.minlength,
                equalTo : Messages.equalTo
            }
        }

    });
}


/**
 * Carga el evento click de la busqueda en el tag a.
 */
function loadClickUrlSearch() {
    var aSearch = $('#search_a');
    aSearch.click(function() {
        var inputSearch = $('#search_input');
        var aSearch = $('#search_a');
        var url = Inditex.generateUrl("ItxSolrSearchingDataCmd", {
            storeId: Inditex.iStoreId,
            langId: Inditex.iLangId,
            catalogId: Inditex.iCatalogId,
            searchTerm: inputSearch.val()
        }, false);
        aSearch.attr('href', url);
    });
}

function containPendingTransfers(){

    Inditex.getUserJSON(function(userInfo) {

        var returnedOrders = userInfo.pendingTransfers;

        if(returnedOrders.length == 0){
            $("#liTranferenciaManual").remove();
            $("#menu_modal #tranferenciaManual").remove();
        }

    })



}

/**
 * Valida el formulario de registro de cuenta
 */
function initRegister() {
    //removeValueFromFieldOnClick("fechaNacimiento");
    removeValueFromFieldOnClickSpecific($("#miCuentaForm #fechaNacimiento"));
    $("#r_pers2").click(function(event) {
        event.preventDefault();
        $("#scrollable").find("div[name=datosEmpresa]").hide();
        if(!isIPad()){
            var element = $("#scrollable").jScrollPane();
        }
        else{
            $("#scrollable").css({'overflow':'auto'});
        }

    });
    $("#r_emp2").click(function(event) {
        event.preventDefault();
        $("#scrollable").find("div[name=datosEmpresa]").show();
        // if($('#tunel')[0] != undefined)
        // fitFooterBottom($('#tunel'));
        if(!isIPad()){
            var element = $("#scrollable").jScrollPane();
        }
        else{
            $("#scrollable").css({'overflow':'auto'});
        }

    });

    $("#r_pers2").next().click();
}


/**
 * Valida el formulario de registro de cuenta
 */
function validateRegister(url) {
    $("#miCuentaForm").validate({
        submitHandler: function(form) {
            var formRegister = $("#miCuentaForm");
            jQuery.xajax({
                url: formRegister.attr("action"),
                type: 'post',
                data: formRegister.serialize(),
                success: function(data) {
                    if (typeof(data) == "string") {
                        data = JSON.parse(data);
                    }
                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage("Identificate/Registrarse/Envio_OK");
                            Inditex.trackEvent( "Crear_cuenta","Crear_cuenta_ok",null,true);
                        }

                        var registerBooking= $("#miCuentaForm #registerBooking").attr("value");

                        if(registerBooking == 'true'){
                            var url = $("#miCuentaForm #urlDetallesReserva").attr("value");
                            openGenericModalReserva(url,null,function(){Inditex.trackPage( 'Ficha_producto/'+partNumber+'/Consulta_stock/Reservar_talla/Solicitud_confirmacion',true)},200,null);
                            Inditex.drawHeader();
                        }
                        else{
                            Inditex.drawHeader();
                            closeModal(this.window);
                            if ($(".boton_login").length>0) { // si nos hemos registrado desde el seguimiento de pedido de usuario guest
                                $(".boton_login").hide ();
                                openStaticModal(Messages.titleSendToFriend, Messages.asociacionDePedidoACuentaOK, false);
                            }
                        }

                        //Si nos registramos en el tunel de compra	
                        if($("#pasos li.active").length){
                            if( (/paso2/.test($("#pasos li.active").attr('class'))) || (/paso3/.test($("#pasos li.active").attr('class'))) || (/paso4/.test($("#pasos li.active").attr('class'))) ) {
                                if ($("#isUserGuest").attr('value')=="true") {

                                    Inditex.orderManage({'url':$('#shoppingCartURL').attr('value')})
                                }
                                else { //Si no est? habilitada la compra sin registro y estamos en el paso 2 y nos registramos en la cabecera, redireccionamos al siguiente paso (metodos de envio)
                                    if( (/paso2/.test($("#pasos li.active").attr('class'))) ) {
                                        window.location.href = $("#OrderShippingUrl").attr('value');
                                    }
                                }
                            }
                        }
                    } else {
                        if (Inditex) {
                            Inditex.trackPage("Identificate/Registrarse/Envio_Error_" + data.type);
                            Inditex.trackEvent( "Crear_cuenta","Crear_cuenta_error",Inditex.codeError(data.key,data.errorMessage),true);
                        }
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });
        },
        invalidHandler: function(event, validator) {
            onResizeModal();
        },
        rules : {
            sexo : "required",
            firstName: "required",
            middleName: "required",
            privatePolicy : "required",
            lastName: "required",
            city: "required",
            birthDate : {
                requiredChangeClassLocalDate : true
            },
            zipCode: {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            state:"itxSelect",
            country:"required",
            phone1Prefix : {
                validPrefixRegister : true,
                required : true
            },
            phone1 : {
                validatePhoneRegister : true//,
                //required : true
            },
            phone2 : {
                validatePhone : true
            },
            phone2Prefix : {
                validPrefix : true
            },
            city : "required",
            email1 : {
                required : true,
                email : true
            },
            email2 : {
                required : true,
                email : true,
                equalTo : "#miCuentaForm #email"
            },
            logonPassword : {
                validSecurePassword : true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                validSecurePassword : true,
                required : true,
                minlength : 8,
                equalTo : "#miCuentaForm #password"
            },
            nif :{
                required: function(element){
                    if  ($("#miCuentaForm #empresa").length && $("#miCuentaForm #empresa").val() !== ''){
                        return true;
                    }else{
                        return false;
                    }
                },
                validateNif:  function(element){
                    if  ($("#miCuentaForm #empresa").length && $("#miCuentaForm #empresa").val() !== ''){
                        return true;
                    }else{
                        return false;
                    }
                }
            }
        },
        messages: {
            sexo : Messages.sexo,
            firstName : Messages.required,
            nif : {
                required:Messages.required
            },
            middleName : Messages.requiredMiddleName,
            lastName: Messages.lastName,
            birthDate : Messages.bithDate,


            zipCode : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },

            state: Messages.state,
            country: Messages.country,
            city: Messages.city,
            phone1: {
                required: Messages.required,
                validatePhone: eval('Messages.phone_' + iCountry)
            },
            phone2: eval('Messages.phone_' + iCountry),
            email1: Messages.email1,
            email2: {
                required: Messages.required,
                email: Messages.email1,
                equalTo: Messages.emailEqualTo
            },
            logonPassword: {
                validNewPassword: Messages.validNewPassword,
                required: Messages.validNewPassword,
                minlength: Messages.validNewPassword
            },
            logonPasswordVerify: {
                validNewPassword: Messages.validNewPassword,
                required: Messages.validNewPassword,
                minlength:Messages.validNewPassword,
                equalTo: Messages.equalTo
            },
            nif: {
                required:Messages.required,
                validateNif:Messages.nifIncorrecto
            }
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=nif]").rules("remove");

        $("input[name=nif]").rules("add", {
            required: function(element){
                if  ($("#miCuentaForm #empresa").length && $("#miCuentaForm #empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            validateNifCif:  function(element){
                if  ($("#miCuentaForm #empresa").length && $("#miCuentaForm #empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            messages: {
                required:Messages.required,
                validateNifCif:Messages.nifIncorrectoMX
            }
        });

    }

    if (iCountry == "US") {
        $("input[name=address1]").rules("add", {
            required: true,
            maxlength: 35,
            messages: {
                required: Messages.address1
                //maxlength: "long"
            }
        });
    } else  {
        $("input[name=address1]").rules("add", {
            required: true,
            messages: {
                required: Messages.address1
            }
        });
    }
}

/**
 * Valida el formulario de suscripci?n en la newsletter
 */
function validateNewsletter(url) {
    $("#signNewsletter").validate({
        submitHandler: function(form) {

            var formNewsletter = $("#signNewsletter");
            jQuery.xajax({
                url: formNewsletter.attr("action"),
                type: 'post',
                data: formNewsletter.serialize(),
                success: function(data) {

                    if (!data.errorMessage) {
                        Inditex.trackEvent('Newsletter','Email_ok', null, true);
                        closeModal(this.window);
                        openGenericModal(url,null,null,200,null);
                    } else {
                        Inditex.trackEvent('Newsletter','Email_error', Inditex.codeError(data.errorMessage), true);
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });
        },

        rules : {
            privacyPolicy : "required",
            mail : {
                required : true,
                email : true
            }
        },
        messages: {
            mail: Messages.email1
        }
    });

}

/**
 * Valida el email para los formularios de recuperar password
 */
function validateRecuperarPass2(formElem) {
    formElem.validate({
        submitHandler : function(form) {
            //accion a ejecutar en el submit del formulario
            var formRegister = $("#recuperarPassForm2");
            jQuery.xajax({
                url: formRegister.attr("action"),
                dataType: 'json',
                data: formRegister.serialize(),
                success: function(data) {

                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage("Identificate/Contrasena_Olvidada/Envio_OK");
                            //Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_ok",null,true);
                        }
                        closeModal(this.window);
                    } else {
                        if (Inditex) {
                            Inditex.trackPage("Identificate/Contrasena_Olvidada/Envio_Error_" + data.type);
                            //Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_error",data.errorKey+"-"+data.errorMessage,true);
                        }
                        openStaticModal($("#tituloError").val(), data.message.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>'), true);
                    }

                }
            });
        },
        rules : {
            password : {
                validPassword : true,
                required : true,
                minlength : 8
            },
            retypedPassword : {
                required : true,
                minlength : 8,
                equalTo : "#passwnew"
            }

        },
        messages : {
            password : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            retypedPassword : {
                required : Messages.required,
                minlength : Messages.minlength,
                equalTo : Messages.equalTo
            }
        }
    });
}




function openModalWithContentMSpot(nameMSpot, nombreCookie) {

    var cookie = getCookie('WC_Popup_Dutti_' + nombreCookie);

    if (cookie == null || cookie == '0' ) {

        var url = $("#configurableModalPopupViewURL").attr("value")+ "&emsName=" + nameMSpot;

        var panelObject = new Object();
        popUpPanel.initialize(url, '#divConfigurablePopup', 'cierre', null, panelObject);

    }

}

function checkCookie(nombreCookie){

    var cookie = getCookie('WC_Popup_Dutti_' + nombreCookie);

    if (cookie == null || cookie == '0') {
        cookie = '1';
    }
    else{
        cookie = '0';
    }
    setCookie('WC_Popup_Dutti_' + nombreCookie, cookie, 1,'/');

}


/*
 *
 * Ventana modal One click
 *
 */
function openOneClickModalAux(url, params, onReady, divId, top, height, secondary) {
    if(divId == null)
        divId = "large_modal";

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        overlayId = 's_over_overlay';
        alreadyOverlay = true;
        divId = "general_modal_sec";
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + ($(window).height()) + 'px; width:' + $(window).width() + 'px;opacity:' + 1
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px;opacity:' + 1
        }).appendTo('#s_overlay');
        $('<div/>', {
            'id' : 'close_over_overlay'
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'style' :(height!= null)? 'overflow:hidden':'overflow:hidden'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal
    jQuery.xajax({
        url: url,
        type: "get",
        dataType: 'html',
        error: function(){
            //openLargeModal
            openWalletErrorStaticModal(Messages.cRTitulo,Messages.errorOneClick);
            $('#botonContinuar').attr('style', 'display:block');
            $('#botonCompraRapida').attr('style', 'display:none');

        },
        success: function(data) {
            $('#'+divId).html(data);

            var tipoAlias = $("#aliasWallet").text();
            var tipoTarjeta = $("#typeWallet").text();

            $("#morePaymentInfo").remove();

            //Recupero los datos wallet para el usuario wallet
            Inditex.getRestWalletGetWalletCards({
                onSuccess: function(aJson) {
                    if (aJson && aJson.walletCards && aJson.walletCards.length > 0){

                        $.each(aJson.walletCards, function(index, card) {

                            if(card.alias == tipoAlias){

                                if(card.requestPaymentDetails == "1"){

                                    if(card.paymentCode == "7"){

                                        var modalidades = '<label>'+Messages.modalidadPago+'</label>'+'<div class="block">'+
                                            '<div class="multidrop single required" title="modalidadPagoAffinityMoreInfo">' +
                                            '<select id="cardMode_0" name="modalidadPagoAffinityMoreInfo" title="modalidadPagoAffinityMoreInfo" >';

                                        for (var i=0; i<card.paymentModes.length; i++) {
                                            modalidades+='<option value="';
                                            modalidades+=card.paymentModes[i].id;
                                            modalidades+='">';
                                            modalidades+=card.paymentModes[i].name;
                                            modalidades+='</option>';
                                        }

                                        modalidades+='</select></div>';



                                        var more_info = "<div id='morePaymentInfo'><p>"+Messages.verifyTarjet+"</p><div class='row'><label>"+Messages.numeroTarjeta+"</label><input type='text' id='numeroTarjeta' name='numeroTarjeta' onchange='ocultarValidacionCampo(\"numCardRequired\");'><span id='numCardRequired' class='error' style='display:none; float:none; font-size: 10px;' for='numCardRequired'>"+Messages.required+"</span><div class='clearfix'></div><div id='modalidades'></div></div></div>";

                                        $("#paymentData").append(more_info);
                                        $("#morePaymentInfo").find("#modalidades").html(modalidades);

                                        selectBinds();

                                        if(card.paymentModes.length>0){
                                            $("#select-inner-name-modalidadPagoAffinityMoreInfo").css('width','200px');
                                            $("#select-inner-name-modalidadPagoAffinityMoreInfo").text(card.paymentModes[0].name);
                                        }




                                    }else{

                                        var more_info = "<div id='morePaymentInfo'><p>"+Messages.verifyTarjet+"</p><div class='row'><label>"+Messages.codigoSeg+"</label><input type='text' class='wid1' id='codigoSeguridad' name='codigoSeguridad' onchange='ocultarValidacionCampo(\"codigoSeguridadRequired\");'> <span id='codigoSeguridadRequired' class='error' style='display:none; float:none; font-size: 10px;' for='codigoSeguridadRequire'>"+Messages.required+"</span><p class='infor'><a class='a_info' href='javascript:void(0)' onClick='desplegarCVV();'>"+Messages.queEsCodigoSeg+"</a></p></div></div>";
                                        $("#paymentData").append(more_info);

                                    }

                                }

                                else if(card.paymentCode == "7"){
                                    var modalidades = '<label>'+Messages.modalidadPago+'</label>'+'<div class="block">'+
                                        '<div class="multidrop single required" title="modalidadPagoAffinityMoreInfo">' +
                                        '<select id="cardMode_0" name="modalidadPagoAffinityMoreInfo" title="modalidadPagoAffinityMoreInfo" >';

                                    for (var i=0; i<card.paymentModes.length; i++) {
                                        modalidades+='<option value="';
                                        modalidades+=card.paymentModes[i].id;
                                        modalidades+='">';
                                        modalidades+=card.paymentModes[i].name;
                                        modalidades+='</option>';
                                    }

                                    modalidades+='</select></div>';

                                    var more_info = "<div id='morePaymentInfo'><div class='row'><div id='modalidades'></div></div></div>";

                                    $("#paymentData").append(more_info);

                                    $("#morePaymentInfo").find("#modalidades").html(modalidades);

                                    selectBinds();

                                    if(card.paymentModes.length>0){
                                        $("#select-inner-name-modalidadPagoAffinityMoreInfo").css('width','200px');
                                        $("#select-inner-name-modalidadPagoAffinityMoreInfo").text(card.paymentModes[0].name);
                                    }
                                }

                            }

                        });
                    }
                },
                onFailure: function(aStatus) {

                }
            });

















            if(!secondary) {
                $('#' + overlayId).find('#close_modal').bind('click', function() {
                    closeModal(this);
                });
            } else {
                $('#' + overlayId).find('#close_modal').bind('click', function() {
                    closeSecondaryModal(this);
                });
            }

            calculatedHeight = (height != null ? $(window).height() * height : $(window).height()-100);

            if(height != null) {
                $('#' + divId).css({
                    'height' : calculatedHeight
                });
                if(top == null) {
                    $('#' + divId).css({
                        'top' : ($(window).height() - calculatedHeight) / 4
                    });
                    //$('#' + divId).offset({top: ($(window).height() - calculatedHeight) /2});
                }
            }

            if(top != null) {
                $('#' + divId).css({
                    'top' : $(window).height() / 2 - top -18,
                    'height' : calculatedHeight-50
                });
            } else {

            }
            $(window).bind('resize', function() {
                $('#s_overlay').css({
                    'width' : $(window).width(),
                    'height' : $(window).height()
                })
                $('#'+overlayId).css({
                    'width' : $(window).width(),
                    'height' : $(window).height()
                })
                if(top == null) {
                    $('#' + divId).css({
                        'top' : ($(window).height() - calculatedHeight) / 4
                    });
                }
            })
            setTimeout(function() {

                $('#' + divId).find("#scrollable").css({
                    'height' : calculatedHeight-50
                });
                $('#' + divId).fadeIn(function(){
                });
                if(!isIPad()){
                    var element = $("#scrollable").jScrollPane();
                }
                else{
                    $("#scrollable").css({'overflow':'auto'});
                }
                if((onReady != null) && (onReady != undefined))
                    onReady(params);

            }, 300)
            if(!secondary) {
                $('#' + overlayId).css('left', 0).fadeIn(function() {
                    $('#close_overlay').bind('click', function() {
                        closeModal(this);
                    });
                })
            } else {
                // $('#'+overlayId).css('left', 0).fadeIn(function() {
                // $('#close_over_overlay').bind('click', function() {
                // closeSecondaryModal(this);
                // });
                // })
                $('#' + overlayId).css('left', 0).show();
                $('#close_over_overlay').bind('click', function() {
                    closeSecondaryModal(this);
                });
            }
            if(isIPad() && !isIPad_5()){

                $('body').height(document.height);
                $('body').css({'position':'relative'});
                $('#'+overlayId).css({'position':'absolute'});
            }
            $('#large_modal').css({'opacity':'1'});
        }
    });

}

/**
 * Muestra una modal general con titulo y mensaje (para modales que obtienen mensaje de JSON)
 */
function openPasswordUpdateGeneralModal(titulo, mensaje, secondary, onClose) {
    var modal = '<p id="titlePasswordUpdate" class="title">' + titulo + '</p><p id="mensaje">' + mensaje + '</p><a id="close_modal" href="javascript:void(0)" class="close_modal">&nbsp;</a>';

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        if($("#s_over_overlay").size() > 0){
            overlayId = 's_over_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_ter";
            oldOverlayId = "s_over_overlay" ;
            closeOverlayId = "close_over_over_overlay";
        }else{
            overlayId = 's_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_sec";
            oldOverlayId = "s_overlay";
            closeOverlayId = "close_over_overlay";
        }
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#'+oldOverlayId);
        $('<div/>', {
            'id' : closeOverlayId
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //Creamos modal
    $('<div/>', {
        'id' : 'static_modal'
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#static_modal').html(modal);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#static_modal').fadeIn();
        $('#static_modal').css('position','absolute');
        $('#static_modal').css('left','50%');
        $('#static_modal').css('top','97px');
        $('#static_modal').css('width','660px');
        $('#static_modal').css('margin-left','-340px');
        $('#static_modal').css('padding-top','50px');
        $('#static_modal').css('padding-bottom','50px');

        $('#titlePasswordUpdate').css('font-family','Georgia,"Times New Roman",Times,serif');
        $('#titlePasswordUpdate').css('margin-bottom','15px');
        $('#titlePasswordUpdate').css('text-align','center');
        $('#titlePasswordUpdate').css('width','90%');

        $('#titlePasswordUpdate').css('font-size', '12px');
        $('#titlePasswordUpdate').css('margin-left','35px');
        $('#titlePasswordUpdate').css('margin-top', '0');

        $('#mensaje').css('font-size', '12px');
        $('#mensaje').css('margin-left','35px');
        $('#mensaje').css('margin-top', '0');
    }, 300)
    if(!secondary) {
        $('#' + overlayId).css('left', 0).fadeIn(function() {
            $('#close_overlay').bind('click', function() {
                if (onClose != null) onClose();
                closeModal(this);
            });
        })
    } else {
        $('#' + overlayId).css('left', 0).show();
        $('#'+closeOverlayId).bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }

    if(!secondary) {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeModal(this);
        });
    } else {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }
}


/**
 * Muestra una modal estandar con titulo y mensaje (error compra rapida)
 */
function openWalletErrorStaticModal(titulo, mensaje, secondary, onClose) {
    var modal = '<br/><div id="scrollable"><a id="close_modal" href="javascript:void(0)" class="close_modal">&nbsp;</a><div id="compra_rapida_confirmacion">'+
        '<p class="title">' + titulo + '</p><div class="content"><p>' + mensaje + '</p><a style="float:right;" class="add_art" href="javascript:enviarError();" >CONTINUAR</a></div></div></div>';

    if(secondary != true)
        secondary = false;
    var overlayId;
    var alreadyOverlay = false;

    if(!secondary) {
        overlayId = 's_overlay';
        alreadyOverlay = false;
    } else {
        if($("#s_over_overlay").size() > 0){
            overlayId = 's_over_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_ter";
            oldOverlayId = "s_over_overlay" ;
            closeOverlayId = "close_over_over_overlay";
        }else{
            overlayId = 's_over_overlay';
            alreadyOverlay = true;
            divId = "general_modal_sec";
            oldOverlayId = "s_overlay";
            closeOverlayId = "close_over_overlay";
        }
    }

    // crea div #overlay
    //Si ya existe, le a?ade otra capa al overlay existente
    if(!secondary) {
        closeModalNoCallback();
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('body');
        $('<div/>', {
            'id' : 'close_overlay'
        }).appendTo('#' + overlayId);
    } else {
        $('<div/>', {
            'id' : overlayId,
            'class' : 'transp',
            'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
        }).appendTo('#'+oldOverlayId);
        $('<div/>', {
            'id' : closeOverlayId
        }).appendTo('#' + overlayId);
    }
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });
    //Creamos modal
    $('<div/>', {
        'id' : 'large_modal'
    }).appendTo('#' + overlayId);

    // Meter aqu? los contenidos del modal
    $('#large_modal').html(modal);
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#large_modal').fadeIn();
        $('#large_modal').css('position','absolute');
        $('#large_modal').css('top','40px');
        $('#large_modal').css('height','391.2px');

    }, 300)
    if(!secondary) {
        $('#' + overlayId).css('left', 0).fadeIn(function() {
            $('#close_overlay').bind('click', function() {
                if (onClose != null) onClose();
                closeModal(this);
            });
        })
    } else {
        $('#' + overlayId).css('left', 0).show();
        $('#'+closeOverlayId).bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }

    if(!secondary) {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeModal(this);
        });
    } else {
        $('#' + overlayId).find('#close_modal').bind('click', function() {
            if (onClose != null) onClose();
            closeSecondaryModal(this);
        });
    }
}

function popupCestaUrl(aHtml, aWidth, aHeight, aCallback, trackPageName, userCloseCallback) {
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    if(isiPad) {
        $('body').css({'overflow': 'hidden', 'position': 'fixed'});
    }
    if(((aHtml.indexOf('id="popPupProduct"') != -1) && ($(".popupHtmlCesta").length != 0 ))||((aHtml.indexOf('id="popupContacto"') != -1) && ($("#popupContacto").length != 0 ))){ // al hacer 2 clicks seguidos para abrir un popup de producto hay que evitar doble popup porque fallaba
        return;
    }else{
        var overlay = $('<div />' , {
            'class' : 'overlay_bg_cesta'
        }).bind("click", function(e){
            closePopupCesta(popup,overlay,e.which?userCloseCallback:null);
        }).appendTo($("body"));


        var popup = $('<div />' , {
            'class' : 'popupHtmlCesta',
            'html' : aHtml
        }).appendTo($("body"));

        Inditex.ga(function(tracker) {
            var defaultPage = tracker.get('page');
            overlay.data('page',defaultPage);
        });
        if (trackPageName) {
            Inditex.trackPage( trackPageName,true);
        }

        var close = $('<div />' , {
            'class' : 'close'
        }).bind("click", function(e,trigger){
            closePopupCesta(popup,overlay,e.which?userCloseCallback:null);
        }).appendTo(popup);

        $(close).css('background-image','url("'+Inditex.getStaticResourceUrl('images/detail/icons/close_icon.png')+'")');

        popup.css("width", aWidth);
        popup.css("height", aHeight);

        popup.css("margin-top", - popup.height() / 2 + "px");

        $( window ).resize(function() {
            popup.css("margin-top", - popup.height() / 2 + "px");
        });

        popup.show();
        overlay.fadeIn();
        if (aCallback) {
            aCallback(this);
        }
    }
};

function enviarError(){
    document.location.href=shopCartJSON.linkOrderShipping;
}


/**
 * Valida el c?digo de seguridad y el nuevo
 * pass para confirm cambiar password
 */
function validateRecuperarPassConfirm(formElem) {
    formElem.validate({
        submitHandler : function(form) {





            $('#general_modal').fadeOut();
            $()
            // Meter aqu los contenidos del modal
            setTimeout(function() {
                //se carga la nueva pgina y se muestra
                var form = $("#recuperarPassConfirmForm");
                jQuery.xajax({
                    url: form.attr("action"),
                    type: "post",
                    dataType: 'json',
                    data: form.serialize(),
                    success: function(data) {
                        $('#s_overlay').css('display', 'none');

                        if ((data) && ((data.errorKey==undefined) || (data.errorKey==null))) {
                            openStaticModal(Messages.titlePassword,Messages.msgPassword, false);
                        }else{
                            openStaticModal("ERROR",data.errorMessage, true);
                        }
                    }
                });
            }, 300)


        },
        rules : {
            /*
             codigo_seguridad : {
             required : true,
             minlength : 6
             },
             */
            newPassword : {
                validNewPassword : true,
                required : true,
                minlength : 8
            },
            retypedNewPassword : {
                required : true,
                minlength : 8,
                equalTo : "#newPassword"
            }
        },
        messages : {
            /*
             codigo_seguridad : {
             required : "Debe rellenar este campo",
             //minlength : "Debe tener al menos 6 caracteres"
             minlength : "Formato no v?lido"
             },
             */
            newPassword : {
                required : Messages.required,
                //minlength : "Debe tener al menos 6 caracteres"
                minlength : Messages.validRecuperarPassword
            },
            retypedNewPassword : {
                required : Messages.required,
                //minlength : "Debe tener al menos 6 caracteres",
                minlength : Messages.validRecuperarPassword,
                equalTo : Messages.equalTo
            }
        }
    });
}

function cargaDireccionfacturacionUsuarioGuest () {

    removeValueFromFieldOnClick("fechaNacimiento");

    $("#miCuentaForm #nombre").attr ('value',billingAddressJSON.firstName);
    $("#miCuentaForm #nombre").attr('disabled',true);

    $("#miCuentaForm #apellidos").attr ('value',billingAddressJSON.lastName);
    $("#miCuentaForm #apellidos").attr('disabled',true);

    if (iCountry=='RU') {

        $("#miCuentaForm #middlename").attr ('value',billingAddressJSON.middleName);
        $("#miCuentaForm #middlename").attr('disabled',true);
    }

    $("#miCuentaForm #prefijo").attr('disabled',true);

    var phone1=billingAddressJSON.phone1.split(' ');
    $("#miCuentaForm #telefono").attr ('value',phone1[1]);
    $("#miCuentaForm #telefono").attr('disabled',true);

    $("#miCuentaForm #prefijo2").attr('disabled',true);

    if (billingAddressJSON.phone2!=null) {
        var phone2=billingAddressJSON.phone2.split(' ');
        $("#miCuentaForm #telefono2").attr ('value',phone2[1]);
        $("#miCuentaForm #telefono2").attr('disabled',true);
    }

    $("#miCuentaForm #email").attr ('value',billingAddressJSON.email);
    $("#miCuentaForm #email").attr('disabled',true);

    $("#miCuentaForm #email2").attr ('value',billingAddressJSON.email);
    $("#miCuentaForm #email2").attr('disabled',true);

    if (billingAddressJSON.type != "individual") { // es empresa
        $("#miCuentaForm #dir").attr ('value',billingAddressJSON.street);
        $("#miCuentaForm #dir").attr('disabled',true);

        $("#miCuentaForm #dir2").attr ('value',billingAddressJSON.street2);
        $("#miCuentaForm #dir2").attr('disabled',true);

        $("#miCuentaForm #localidad").attr ('value',billingAddressJSON.city);
        $("#miCuentaForm #localidad").attr('disabled',true);

        $("#miCuentaForm #provincia option[value="+billingAddressJSON.stateISO+"]").attr("selected",true);

        /*
         var titleProvincia =  $("#miCuentaForm #provincia").attr('title');
         changeCustomSelect($("#miCuentaForm").find('#select-'+ titleProvincia+' li[v=' + billingAddressJSON.stateISO + ']'), $("#miCuentaForm"));
         $("#miCuentaForm").find('#select-'+ titleProvincia).attr('disabled',true);
         */

        $(".multidrop.single.tunelcuenta").remove();

        $('form#miCuentaForm > div:eq(4) > .block:eq(0)').append("<input type='text' id='provinciaDisabled' name='stateDisabled' value='"+billingAddressJSON.state+"' disabled='disabled' />");
        $('form#miCuentaForm > div:eq(4) > .block:eq(0)').append("<input type='hidden' id='provincia' name='state' value='"+billingAddressJSON.stateISO+"' />");

        $("#miCuentaForm #cp").attr ('value',billingAddressJSON.zipCode);
        $("#miCuentaForm #cp").attr('disabled',true);

        if ($("#miCuentaForm #empresa").length>0) { //si esta activado el registro como empresa en la tienda

            $("#miCuentaForm #empresa").attr ('value',billingAddressJSON.nameCompany);
            $("#miCuentaForm #empresa").attr('disabled',true);

            $("#miCuentaForm #nif").attr ('value',billingAddressJSON.nif);
            $("#miCuentaForm #nif").attr('disabled',true);
        }
    }
};
/* END /DuttiNEWStorefrontAssetStore/js/modalPlugin.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/validatorExtension.js (en_US) */
/**
 * Metodos personalizados para la validacion de formularios
 */

function validLocalDate(value){
    chunks = value.split('/');
    if(chunks.length != 3)
        return false;
    //1. Comprobamos que es una fecha valida,
    var formatDateEval = getMessage('formatDateForEvaluation').split("/");
    var day, month, year;
    if (chunks.length == 3 && formatDateEval.length == chunks.length) {
        var parameterName;
        for( var i = 0; i < formatDateEval.length;i++){
            parameterName = formatDateEval[i];
            if(parameterName == 'dd'){
                day = chunks[i];
            }
            if(parameterName == 'mm'){
                month = chunks[i];
            }
            if(parameterName == 'aaaa'){
                year=chunks[i];
            }
        }
    }
    date = new Date(year, parseInt(month,10) - 1, day);
    valid = (parseInt(day,10) == date.getDate() && (parseInt(month,10) - 1 == date.getMonth()) && parseInt(year,10) == date.getFullYear())
    //2. Comprobamos que es una fecha anterior a la actual

    if(valid && date <= new Date())
        return value.match(/^\d\d?\/\d\d?\/\d\d\d\d$/);
    else
        return false;
}

function validDateKlarna(value){
    pattern = /(\d{2})(\d{2})(\d{4})/;

    if(value.length != 8)
        return false;

    valueFormat = value.replace(pattern,'$1-$2-$3');
    chunks = valueFormat.split('-');

    date = new Date(chunks[2], parseInt(chunks[1],10) - 1, chunks[0]);
    valid = (parseInt(chunks[0],10) == date.getDate() && (parseInt(chunks[1],10) - 1 == date.getMonth()) && parseInt(chunks[2],10) == date.getFullYear())

    if(valid && date <= new Date()) {
        return value.match(/^(\d{2})(\d{2})(\d{4})$/);
    } else {
        return false;
    }
}

function validDateKlarnaNL(value){
    pattern = /(\d{2})(\d{2})(\d{4})/;

    if(value.length != 8)
        return false;

    valueFormat = value.replace(pattern,'$1-$2-$3');
    chunks = valueFormat.split('-');

    date = new Date(chunks[2], parseInt(chunks[0],10) - 1, chunks[1]);
    valid = (parseInt(chunks[1],10) == date.getDate() && (parseInt(chunks[0],10) - 1 == date.getMonth()) && parseInt(chunks[2],10) == date.getFullYear())

    if(valid && date <= new Date()) {
        return value.match(/^(\d{2})(\d{2})(\d{4})$/);
    } else {
        return false;
    }
}

function validCaducidadDate(value){
    chunks = value.split('/');
    if(chunks.length != 2 ) return false;

    var ano = new Date();
    ano = ano.getFullYear();
    ano = ano.toString().substring(0, 2);
    ano = ano + chunks[1];

    //1. Comprobamos que es una fecha valida,
    date = new Date(ano, parseInt(chunks[0],10) - 1);
    valid = ((parseInt(chunks[0],10) - 1 == date.getMonth()) && parseInt(ano,10) == date.getFullYear())
    //2. Comprobamos que es una fecha mayor a la actual(vale el mes en curso), por eso no le restamos una unidad al mes
    date = new Date(ano, parseInt(chunks[0],10));
    if (!valid || date < new Date()){
        return false;
    }else{
        value =  chunks[0] + "/" + ano;
        return value.match(/^\d\d?\/\d\d\d\d$/);
    }
}

function validateAlias(value){
    var num = value.replace(/[^0-9]/g,"").length;
    if (num > 8){
        return false;
    }
    else {
        return true;
    }
}

$.validator.addMethod("localDate", function(value, element) {

    return validLocalDate(value);


}, Messages.formatoFecha);

$.validator.addMethod("validarDropBox", function(value, element) {

    var zeros = "";
    var lengthIdentifier = value.length
    if (value.length < 10){
        for (var i=0;i<10-lengthIdentifier;i++){
            zeros = zeros + 0;
        }
        value = zeros + value;
    }

    if (value.length != 10 || isNaN(value)) {
        return false;
    }

    // Paso 1
    var valorPaso1 = 0;
    for (var i=8; i>=0; i=i-2) {
        valorPaso1 = valorPaso1 + parseInt(value.charAt(i));
    }

    // Paso 2
    var valorPaso2 = valorPaso1 * 4;

    // Paso 3
    var valorPaso3 = 0;
    for (var i=7; i>=1; i=i-2) {
        valorPaso3 = valorPaso3 + parseInt(value.charAt(i));
    }

    // Paso 4
    var valorPaso4 = valorPaso3 * 9;

    // Paso 5
    var valorPaso5 = valorPaso2 + valorPaso4;

    var valorPaso6 = parseInt(valorPaso5) + parseInt(value.charAt(9));
    if (valorPaso6 % 10 == 0) {
        return true;
    } else {
        return false;
    }

}, Messages.errorIdentificadorDB);



$.validator.addMethod("requiredChangeClass", function(value, element) {

    var cps = {
        ES:'^[0-9]{5}$',
        ESCN:'^[0-9]{5}$',
        IC:'^[0-9]{5}$',
        FR:'^[0-9]{5}$',
        DE:'^[0-9]{5}$',
        IT:'^[0-9]{5}$',
        PT:'^[0-9]{4}(-[0-9]{3})?(\\s.*)?$',
        GB:'^(GIR 0AA|[A-PR-UWYZ]([0-9]{1,2}|([A-HK-Y][0-9]|[A-HK-Y][0-9]([0-9]|[ABEHMNPRV-Y]))|[0-9][A-HJKS-UW]) [0-9][ABD-HJLNP-UW-Z]{2})$',
        AT:'^[0-9]{4}$',
        IE:'^.*$',
        BE:'^[0-9]{4}$',
        NL:'^[0-9]{4}[A-Z]{2}$',
        LU:'^[0-9]{4}$',
        GR:'^[0-9]{5}$',
        SE:'^(?:SE-?)?[0-9]{5}$',
        DK:'^[0-9]{4}$',
        MC:'^[0-9]{5}$',
        CH:'^[0-9]{4}$',
        NO:'^[0-9]{4}$',
        PL:'^[0-9]{2}-[0-9]{3}$',
        US:'^[0-9]{5}$',
        CA:'^[ABCEGHJKLMNPRSTVXY][0-9][A-Z]\\s?[0-9][A-Z][0-9]$',
        RU:'^[0-9]{6}$',
        MX:'^[0-9]{5}$',
        RO:'^[0-9]{6}$'
    };
    var txtExp = cps[iCountry];
    if (txtExp == null) {
        txtExp = '^\\w{1,50}$';  //Cualquier cosa
    }

    var er = new RegExp(txtExp, 'gi');

    if(er.test(value)){
        $(element).parent().find("#cpInfo").show();
        return true;
    } else {
        $(element).parent().find("#cpInfo").hide();
        return false;
    }
}, Messages.zipCode);


$.validator.addMethod("requiredChangeClassRestrictedCP", function(value, element) {
    var zipCodeRestricted = null;
    if ((typeof(ValidationRules)!="undefined") && (ValidationRules != null) && (typeof(ValidationRules.zipCodesRestricted)!="undefined")) {
        zipCodeRestricted = ValidationRules.zipCodesRestricted;
    }
    if(zipCodeRestricted != null  && zipCodeRestricted != ''){
        var er = new RegExp(zipCodeRestricted, 'gi');
        if(er.test(value)){
            $(element).parent().find("#cpInfo").hide();
            return false;
        } else {
            $(element).parent().find("#cpInfo").hide();
            return true;
        }
    } else {
        $(element).parent().find("#cpInfo").hide();
        return true;
    }
}, Messages.restrictedZipcode);


$.validator.addMethod("requiredChangeClassRestrictedCPRusia", function(value, element) {


    var zipCodeRestrictedRusia=$("#MD2_Var_Restricted_CP").attr("value");
    if(zipCodeRestrictedRusia != null  && zipCodeRestrictedRusia != ''){
        var er = new RegExp(zipCodeRestrictedRusia, 'gi');
        if(er.test(value)){
            $(element).parent().find("#cpInfo").hide();
            return false;
        } else {
            $(element).parent().find("#cpInfo").hide();
            return true;
        }
    } else {
        $(element).parent().find("#cpInfo").hide();
        return true;
    }


}, Messages.restrictedZipcodeRusia);

$.validator.addMethod("requiredChangeClassLocalDate", function(value, element) {

    if (validLocalDate(value)) {
        $(element).parent().find("#fechaInfo").show();
        return true;
    } else {
        $(element).parent().find("#fechaInfo").hide();
        return false;
    }
}, Messages.birthDate);


$.validator.addMethod("requiredChangeClassCaducidadDate", function(value, element) {

    if (validCaducidadDate(value)) {
        $(element).parent().find("#fechaInfo").show();
        return true;
    } else {
        $(element).parent().find("#fechaInfo").hide();
        return false;
    }
}, Messages.birthDate);

$.validator.addMethod("requiredChangeClassAlias", function(value, element) {

    if (validateAlias(value)) {
        $(element).parent().find("#walletInfo").hide();
        return true;
    } else {
        $(element).parent().find("#walletInfo").show();
        return false;
    }
}, Messages.alias);

$.validator.addMethod("itxSelect", function(value, element) {
    if(value!=''){
        $(element).parent().next().removeClass('multidropIE7')
        return true;
    } else{
        $(element).parent().next().addClass('multidropIE7');
        return false;
    }
},Messages.state);

$.validator.addMethod("cajasChangeClass", function(value, element) {

    if(isNumber(value)) {
        $("#cajasInfo").show();
        return true;
    } else {
        $("#cajasInfo").hide();
        return false;
    }
}, Messages.ItxMyAccountOrderReturnAddressView_validate_inpnumcaj);

$.validator.addMethod("validPassword", function(value, element) {

    var result = /\d/.test(value) && /[A-Z\u0410-\u042F]/.test(value) && /[a-z\u0430-\u044F]/.test(value) ;
    return result;

}, Messages.validPassword);

$.validator.addMethod("validSecurePassword", function(value, element) {

    var result = /\d/.test(value) && /[A-Z\u0410-\u042F]/.test(value) && /[a-z\u0430-\u044F]/.test(value) ;
    return result;

}, Messages.validNewPassword);

$.validator.addMethod("validNewPassword", function(value, element) {

    var result = /\d/.test(value) && /[A-Z\u0410-\u042F]/.test(value) && /[a-z\u0430-\u044F]/.test(value) ;
    return result;

}, Messages.validNewPassword);

$.validator.addMethod("validPrefix", function(value, element) {

    var result = /^\+\d{1,3}/.test(value) || value=="";
    return result;

}, "Debe introducir un prefijo");

$.validator.addMethod("validatePhone", function(value, element) {

    var rphs = {
        AT:'^(\\d{1,14}){0,1}$',
        BE:'^(\\d{1,10}){0,1}$',
        CH:'^(\\d{1,13}){0,1}$',
        DE:'^(\\d{1,14}){0,1}$',
        DK:'^(\\d{1,9}){0,1}$',
        ES:'^(\\d{1,9}){0,1}$',
        ESCN:'^(\\d{1,9}){0,1}$',
        FR:'^(\\d{1,10}){0,1}$',
        GB:'^(\\d{1,11}){0,1}$',
        GR:'^(\\d{1,10}){0,1}$',
        IC:'^(\\d{1,9}){0,1}$',
        IE:'^(\\d{1,12}){0,1}$',
        IT:'^(\\d{1,12}){0,1}$',
        LU:'^(\\d{1,12}){0,1}$',
        MC:'^(\\d{1,10}){0,1}$',
        NL:'^(\\d{1,11}){0,1}$',
        NO:'^(\\d{1,9}){0,1}$',
        PL:'^(\\d{1,10}){0,1}$',
        PT:'^(\\d{1,12}){0,1}$',
        SE:'^(\\d{1,14}){0,1}$',
        US:'^(\\d{1,12}){0,1}$',
        RU:'^(\\d{1,10}){0,1}$',
        MX:'^(\\d{1,10}){0,1}$',
        RO:'^(\\d{1,10}){0,1}$'
    };

    var txtExp = rphs[iCountry];

    if (txtExp == null) {
        txtExp = '^(\\d{1,50}){0,1}$';  //Como es un pais generico le pongo una validacion general (solo numero sin limite de longitud)
    }
    var er = new RegExp(txtExp, 'gi');

    return er.test(value);

}, Messages.phone);

$.validator.addMethod("validPrefixRegister", function(value, element) {

    var result = /^\+\d{1,3}/.test(value) || value=="";
    if (result) {

        $("#tlfInfo").show();
        return true;
    }
    else {

        $("#tlfInfo").hide();
        return false;
    }

}, "Debe introducir un prefijo");

$.validator.addMethod("validatePhoneRegister", function(value, element) {

    var rphs = {
        AT:'^(\\d{1,14}){0,1}$',
        BE:'^(\\d{1,10}){0,1}$',
        CH:'^(\\d{1,13}){0,1}$',
        DE:'^(\\d{1,14}){0,1}$',
        DK:'^(\\d{1,9}){0,1}$',
        ES:'^(\\d{1,9}){0,1}$',
        ESCN:'^(\\d{1,9}){0,1}$',
        FR:'^(\\d{1,10}){0,1}$',
        GB:'^(\\d{1,11}){0,1}$',
        GR:'^(\\d{1,10}){0,1}$',
        IC:'^(\\d{1,9}){0,1}$',
        IE:'^(\\d{1,12}){0,1}$',
        IT:'^(\\d{1,12}){0,1}$',
        LU:'^(\\d{1,12}){0,1}$',
        MC:'^(\\d{1,10}){0,1}$',
        NL:'^(\\d{1,11}){0,1}$',
        NO:'^(\\d{1,9}){0,1}$',
        PL:'^(\\d{1,10}){0,1}$',
        PT:'^(\\d{1,12}){0,1}$',
        SE:'^(\\d{1,14}){0,1}$',
        US:'^(\\d{1,12}){0,1}$',
        RU:'^(\\d{1,10}){0,1}$',
        MX:'^(\\d{1,10}){0,1}$',
        RO:'^(\\d{1,10}){0,1}$'
    };

    var txtExp = rphs[iCountry];

    if (txtExp == null) {
        txtExp = '^(\\d{1,50}){0,1}$';  //Como es un pais generico le pongo una validacion general (solo numero sin limite de longitud)
    }
    var er = new RegExp(txtExp, 'gi');

    if (er.test(value) && value!="") {

        $("#tlfInfo").show();
        return true;
    }
    else {

        $("#tlfInfo").hide();
        return false;
    }

}, Messages.phone);

/*
 * jQuery creditcard2 extension for the jQuery Validation plugin (http://plugins.jquery.com/project/validate).
 * Ported from http://www.braemoor.co.uk/software/creditcard.shtml by John Gardner, with some enhancements.
 *
 * Author: Jack Killpatrick
 * Copyright (c) 2010 iHwy, Inc.
 *
 * Version 1.0.1 (1/12/2010)
 * Tested with jquery 1.2.6, but will probably work with earlier versions.
 *
 * History:
 * 1.0.0 - released 2008-11-17
 * 1.0.1 - released 2010-01-12 -> updated card prefixes based on data at: http://en.wikipedia.org/wiki/Credit_card_number and added support for LaserCard
 *
 * Visit http://www.ihwy.com/labs/jquery-validate-credit-card-extension.aspx for usage information
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */

$.validator.addMethod("creditcard2", function(value, element, param) {
    var index = element.id.substring(11,12);
    var cardName = param.cards[index].type;
    if (cardName == null)
        return false;

    if (cardName.indexOf ("_")!= -1){
        cardName = cardName.substring(0,cardName.indexOf("_"));

    }

    var cards = new Array();
    cards[0] = { cardName: "Visa", lengths: "16", prefixes: "4", checkdigit: true };
    cards[1] = { cardName: "MasterCard", lengths: "16", prefixes: "5", checkdigit: true };
    cards[2] = { cardName: "DinersClubCS", lengths: "14,16", prefixes: "305,36,38,54,55", checkdigit: true };
    cards[3] = { cardName: "CarteBlanche", lengths: "14", prefixes: "300,301,302,303,304,305", checkdigit: true };
    cards[4] = { cardName: "AmEx", lengths: "15",prefixes: "", checkdigit: true };
    cards[5] = { cardName: "DiscoverCS", lengths: "16", prefixes: "6011,622,64,65", checkdigit: true };
    cards[6] = { cardName: "JCBCS", lengths: "16", prefixes: "35", checkdigit: true };
    cards[7] = { cardName: "enRoute", lengths: "15", prefixes: "2014,2149", checkdigit: true };
    cards[8] = { cardName: "Solo", lengths: "16,18,19", prefixes: "6334, 6767", checkdigit: true };
    cards[9] = { cardName: "Switch", lengths: "16,18,19", prefixes: "4903,4905,4911,4936,564182,633110,6333,6759", checkdigit: true };
    cards[10] = { cardName: "Maestro", lengths: "12,13,14,15,16,18,19", prefixes: "5018,5020,5038,6304,6759,6761", checkdigit: true };
    cards[11] = { cardName: "VisaElectron", lengths: "16", prefixes: "417500,4917,4913,4508,4844", checkdigit: true };
    cards[12] = { cardName: "LaserCard", lengths: "16,17,18,19", prefixes: "6304,6706,6771,6709", checkdigit: true };
    cards[13] = { cardName: "GiftCard",lengths:"16" ,prefixes: "", checkdigit: false };
    cards[14] = { cardName: "Affinity",lengths:"16" , prefixes: "", checkdigit: false };
    cards[15] = { cardName: "AffinityES",lengths:"16",prefixes: "", checkdigit: false };
    cards[16] = { cardName: "VisaCS", lengths: "16", prefixes: "4", checkdigit: true };
    cards[17] = { cardName: "MasterCardCS", lengths: "16", prefixes: "5", checkdigit: true };
    cards[18] = { cardName: "AmExCS", lengths: "15",prefixes: "", checkdigit: true };
    cards[19] = { cardName: "PayPal"};
    cards[20] = { cardName: "PayPalES"};
    cards[21] = { cardName: "DinersClub", lengths: "14,16", prefixes: "305,36,38,54,55", checkdigit: true };
    cards[22] = { cardName: "JCB", lengths: "16", prefixes: "35", checkdigit: true };
    cards[23] = { cardName: "Discover", lengths: "16", prefixes: "6011,622,64,65", checkdigit: true };
    cards[24] = { cardName: "Discount",lengths:"16" ,prefixes: "", checkdigit: false };
    cards[25] = { cardName: "VISAInstallments", lengths: "16", prefixes: "4", checkdigit: true };
    cards[26] = { cardName: "MasterCardInstallments",lengths: "16", prefixes: "5", checkdigit: true };
    cards[27] = { cardName: "AffinityInstallments",lengths: "16", prefixes: "4", checkdigit: true };

    var cardType = -1;
    for (var i = 0; i < cards.length; i++) {
        if (cardName.toLowerCase() == cards[i].cardName.toLowerCase()) {
            cardType = i;
            break;
        }
    }

    if (cardType == 19)  { return true; } // temporal para Paypal
    if (cardType == 20)  { return true; } // temporal para Paypal

    if (cardType == -1) { return false; } // card type not found

    value = value.replace(/[\s-]/g, ""); // remove spaces and dashes
    if (value.length == 0) { return false; } // no length

    var cardNo = value;
    var cardexp = /^[0-9]{13,19}$/;
    if (!cardexp.exec(cardNo)) { return false; } // has chars or wrong length

    cardNo = cardNo.replace(/\D/g, ""); // strip down to digits

    if (cards[cardType].checkdigit) {
        var checksum = 0;
        var mychar = "";
        var j = 1;

        var calc;
        for (i = cardNo.length - 1; i >= 0; i--) {
            calc = Number(cardNo.charAt(i)) * j;
            if (calc > 9) {
                checksum = checksum + 1;
                calc = calc - 10;
            }
            checksum = checksum + calc;
            if (j == 1) { j = 2 } else { j = 1 };
        }

        if (checksum % 10 != 0) { return false; } // not mod10
    }

    var lengthValid = false;
    var prefixValid = false;
    var prefix = new Array();
    var lengths = new Array();

    prefix = cards[cardType].prefixes.split(",");
    for (i = 0; i < prefix.length; i++) {
        var exp = new RegExp("^" + prefix[i]);
        if (exp.test(cardNo)) prefixValid = true;
    }
    if (!prefixValid) { return false; } // invalid prefix

    lengths = cards[cardType].lengths.split(",");
    for (j = 0; j < lengths.length; j++) {
        if (cardNo.length == lengths[j]) lengthValid = true;
    }
    if (!lengthValid) { return false; } // wrong length

    return true;
}, jQuery.validator.messages.creditcard);


$.validator.addMethod("nif", function(value, element,
                                      param) {
    if (!value.match(/^\d{1}/)) {
        var pares = 0;
        var impares = 0;
        var suma;
        var ultima;
        var unumero;
        var uletra = new Array("J", "A", "B", "C", "D", "E",
            "F", "G", "H", "I");
        /*
         * var letraDesc= new Array("A"="Sociedad
         * Annima","B"="Sociedad de responsabilidad
         * limitada","C"="Sociedad colectiva","D"="Sociedad
         * comanditaria", "E"="Comunidad de bienes","F"=
         * "Sociedad
         * cooperativa","G"="Asociacin","H"="Comunidad de
         * propietarios", "K"="Formato antiguo","L"="Formato
         * antiguo","M"="Formato antiguo","N"="Formato antiguo",
         * "P"="Corporacin local","Q"="Organismo
         * autnomo","S"="Organo de la administracin");
         */
        var xxx;

        value = value.toUpperCase();

        var regular = new RegExp(
            /^[ABCDEFGHKLMNPQS]\d\d\d\d\d\d\d[0-9,A-J]$/g);
        if (!regular.exec(value))
            return false;

        ultima = value.substr(8, 1);

        for ( var cont = 1; cont < 7; cont++) {
            xxx = (2 * parseInt(value.substr(cont++, 1)))
                    .toString()
                + "0";
            impares += parseInt(xxx.substr(0, 1))
                + parseInt(xxx.substr(1, 1));
            pares += parseInt(value.substr(cont, 1));
        }
        xxx = (2 * parseInt(value.substr(cont, 1))).toString()
            + "0";
        impares += parseInt(xxx.substr(0, 1))
            + parseInt(xxx.substr(1, 1));

        suma = (pares + impares).toString();
        unumero = parseInt(suma.substr(suma.length - 1, 1));
        unumero = (10 - unumero).toString();
        if (unumero == 10)
            unumero = 0;

        if ((ultima == unumero) || (ultima == uletra[unumero]))
        /* $("input#surname.text").html('Sociedad'); */
            return true;
        else
            return false;
    } else {
        var nif = value;
        numero = nif.substr(0, nif.length - 1);
        var let1 = nif.substr(nif.length - 1, 1).toUpperCase();
        numero = numero % 23;
        letra = "TRWAGMYFPDXBNJZSQVHLCKET";
        letra = letra.substring(numero, numero + 1);
        if (letra != let1)
            return false;
        else
            return true;
    }
}, "No v?lido. CIF L000000000 ? NIF 00000000L");


$.validator.addMethod("validateNif", function(value, element,
                                              param) {
    var nifs = {
        RU:'^[0-9]{10}$',
        MX:'^((([A-Z\u00D1&]{4})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3})))$'
    };
    if(value){
        var code = $("#storeCountryABBR").val();
        if (nifs[code]) {
            var er = new RegExp(nifs[code], 'gi');
            return er.test($.trim(value));
        }
    }
    return true;
}, Messages.nifIncorrecto);

$.validator.addMethod("validateNifCif", function(value, element,
                                                 isCif) {

    var nifs = {
        RU:'^[0-9]{10}$',
        MX:'^((([A-Z\u00D1&]{4})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{4})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3})))$'
    };
    var cifs = {
        MX:'^((([A-Z\u00D1&]{3})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{3})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{3})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|' +
        '(([A-Z\u00D1&]{3})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3})))$'
    };

    if(isCif){
        if(!value){
            return false;
        }else{
            var er = new RegExp(cifs[iCountry], 'gi');
            if( er.test($.trim(value))){
                return true;
            }else{
                return false;
            }
        }
    }else{
        if(value){

            if (nifs[iCountry]) {
                var er = new RegExp(nifs[iCountry], 'gi');
                return er.test($.trim(value));
            }
        }
        return true;
    }

}, Messages.nifIncorrecto);

$.validator.addMethod("validateBIC", function(value, element,param) {
    var er = new RegExp("^\\d{9}$");
    return er.test(value);
}, Messages.ItxMyAccountOrderReturnPaymentView_validate_bic);

$.validator.addMethod("validateINN", function(value, element,param) {
    var er = new RegExp("^\\d{10}$");
    return er.test(value);
}, Messages.ItxMyAccountOrderReturnPaymentView_validate_inn);

$.validator.addMethod("validateCCC", function(value, element,param) {
    var er = new RegExp("^\\d{20}$");
    return er.test(value);
}, Messages.ItxMyAccountOrderReturnPaymentView_validate_numCuenta);
;
/* END /DuttiNEWStorefrontAssetStore/js/validatorExtension.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Navigation/Main/detalleCommon.js (en_US) */
/**
 * En este Javascript se incluir?n todas las funcionalidades javascript que sean comunes al detalle de producto normal y en popup.
 *
 */

//Esta variable es un array bidimensional color/talla que contendr? la informaci?n de todas las tallas de un producto.
var tallasSinHermanados = null;
//Esta variable es un array que almacenar? el inventario para cada catentry, la clave ser? el catentryId y el valor su inventario.
var stockByCatentry = null;


/**
 * Metodo que pinta una talla en el listado de tallas en funcion de si tiene o no stock
 *
 * talla: Objeto JSON con los datos de la talla
 * stocks: stock de cada sku del producto
 */
function printSize(talla, stocks,isBackSoon,listaSkuBackSoon,showProductNoStock, single, isComingSoon, listaSkuComingSoon) {
    inventory = checkSell(stocks, talla.id);

    if(talla.desc){
        return printSizeWithStock(talla, inventory,isBackSoon,listaSkuBackSoon,showProductNoStock, single, isComingSoon, listaSkuComingSoon);
    }else{
        return '';
    }

}

/**
 * Metodo que pinta la talla segun su stock y el backson
 *
 * talla: Objeto JSON con los datos de la talla
 * stocks: stock de cada sku del producto
 */
function printSizeWithStock(talla, stocks, isBackSoon , listaSkuBackSoon,showProductNoStock, single, isComingSoon, listaSkuComingSoon) {
    var talla_desc = talla.desc;
    if(single){
        talla_desc = Messages.tallaunica;
    }

    if(!DUTTI_STORE_IS_OPEN){
        return ('<span class="size unavailable">' + talla_desc + '</span>');
    }else{
        if(stocks) {

            if(single){
                return ('<span class="size active" id_size="' + talla.idTalla+'" size="' + talla.id + '">' + talla_desc + '</span>');
            }else{
                return ('<span class="size" id_size="' + talla.idTalla+'" size="' + talla.id + '">' + talla_desc + '</span>');
            }


        } else {

            if (listaSkuBackSoon.indexOf('[') != -1) {
                listaSkuBackSoon = getSkus(listaSkuBackSoon);
                listaSkuBackSoon.replace(' ','')
            }

            var listaSkuBackSoonArray = new Array();
            if(listaSkuBackSoon.length > 0)
                listaSkuBackSoonArray  = listaSkuBackSoon.split(',');
            var skuBackSoon = 'false';
            for (i = 0; i < listaSkuBackSoonArray.length; i++) {
                if (( parseInt(listaSkuBackSoonArray[i]) == parseInt(talla.id)))
                    skuBackSoon = 'true';
            }

            if (listaSkuComingSoon.indexOf('[') != -1) {
                listaSkuComingSoon = getSkus(listaSkuComingSoon);
                listaSkuComingSoon.replace(' ','')
            }

            var listaSkuComingSoonArray = new Array();
            if(listaSkuComingSoon.length > 0){
                listaSkuComingSoonArray = listaSkuComingSoon.split(',');
                var posProductId = listaSkuComingSoonArray.indexOf(productJSON.productId);
                if(posProductId!=-1){
                    listaSkuComingSoonArray.splice(posProductId,1)
                }
            }
            var skuComingSoon = 'false';
            for (i = 0; i < listaSkuComingSoonArray.length; i++) {
                if (( parseInt(listaSkuComingSoonArray[i]) == parseInt(talla.id)))
                    skuComingSoon = 'true';
            }

            var skuHasInventory = 'false';
            for (i = 0; i < skuBackSoonArray.length; i++) {
                if (( parseInt(skuBackSoonArray[i]) == parseInt(talla.id)))
                    skuHasInventory = 'true';
            }

            var skuNotInventory = 'false';
            for (i = 0; i < skuComingSoonArray.length; i++) {
                if (( parseInt(skuComingSoonArray[i]) == parseInt(talla.id)))
                    skuNotInventory = 'true';
            }

            if (((isBackSoon == 'true') && (isComingSoon == 'true'))){

                if ((skuHasInventory == 'true') || (skuBackSoon == 'true')) {
                    return ('<span class="size soon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                } else if ((skuNotInventory == 'true') || (skuComingSoon == 'true')){
                    return ('<span class="size comingSoon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                } else {
                    if (showProductNoStock == 'true') {
                        return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        return ('');
                    }
                }

            } else if ((isBackSoon == 'true') && (isComingSoon == 'false')) {
                if (listaSkuBackSoonArray.length > 0) {
                    if (skuBackSoon == 'true') {
                        return ('<span class="size soon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        if (showProductNoStock == 'true') {
                            return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                        } else {
                            return ('');
                        }
                    }
                } else {
                    if (skuHasInventory == 'true') {
                        return ('<span class="size soon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        if (showProductNoStock == 'true') {
                            return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                        } else {
                            return ('');
                        }
                    }
                }
            } else if ((isBackSoon == 'false') && (isComingSoon == 'true')) {
                if (listaSkuComingSoonArray.length > 0) {
                    if (skuComingSoon == 'true') {
                        return ('<span class="size comingSoon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        if (showProductNoStock == 'true') {
                            return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                        } else {
                            return ('');
                        }
                    }
                } else {
                    if (skuNotInventory == 'true') {
                        return ('<span class="size comingSoon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        if (showProductNoStock == 'true') {
                            return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                        } else {
                            return ('');
                        }
                    }
                }
            } else {
                if ((isBackSoon == 'true') || (skuBackSoon == 'true')) {
                    return ('<span class="size soon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                } else if ((isComingSoon == 'true') || (skuComingSoon == 'true')) {
                    return ('<span class="size comingSoon unavailable" onclick="outstock(this)" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                }else {
                    if (showProductNoStock == 'true') {
                        return ('<span class="size unavailable tooltip" rel="'+Messages.notSize+'" id_size="' + talla.idTalla+'" size="' + talla.id + '">'+ talla_desc +'</span>');
                    } else {
                        return ('');
                    }

                }
            }
        }
    }
}




/**
 * M?todo que a partir del JSON con todas las tallas de un producto y el JSON con el stock de todas las
 * tallas del producto, elimina las tallas duplicadas por hermanados, qued?ndose con la que tiene m?s stock.
 * Al final de su ejecuci?n devuelve un array con todos los cantentrys del producto sin los catentrys que duplican tallas.
 */
function getQuitandoTallasHermanadas(tallasColores,stocks){
    var tallasTemp = {};//Contendr? las tallas sin los hermanados
    var partNumber = null; //El partnumber del catentry que actualmente se est? procesando
    var color = null; //El color del catentry que actualmente se est? procesando
    var talla = null; //El talla del catentry que actualmente se est? procesando
    var stockActualTalla = null; //Stock que tiene el catentry que actualmente se tiene asociado a una talla
    var stockNuevaTalla= null; //Stock que tiene el nuevo catentry que se ha encontrado para una talla para la que ya se ha asociado un catentry
    var stockByCatentry = null;


    if(stocks != null && stocks.items != null){
        stockByCatentry = crearHashInventory(stocks.items);
    }

    $.each(tallasColores, function (posColores,tallasColor){
        var contador = 0;
        $.each(tallasColor.sizes,function(posTallas,datosTalla){
            partNumber = datosTalla.partNumber;
            if(!partNumber || partNumber.length < 13){
                return true;
            }
            color= partNumber.substring(8,11);
            talla= partNumber.substring(11,13);

            if(!tallasTemp[color]){
                tallasTemp[color] = {};
            }

            if(tallasTemp[color][talla] && stockByCatentry){
                if (stockByCatentry[tallasTemp[color][talla].id] == null) {
                    stockActualTalla = '0';
                } else {
                    stockActualTalla = stockByCatentry[tallasTemp[color][talla].id];
                }

                if (stockByCatentry[datosTalla.id] == null) {
                    stockNuevaTalla = '0';
                } else {
                    stockNuevaTalla = stockByCatentry[datosTalla.id];
                }
                if(Number(stockActualTalla) < Number(stockNuevaTalla)){
                    datosTalla.idTalla = talla;
                    datosTalla.posicion = contador;
                    tallasTemp[color][talla]= datosTalla;
                    contador++;
                }
            }else{
                datosTalla.idTalla = talla;
                datosTalla.posicion = contador;
                tallasTemp[color][talla]= datosTalla;
                contador++;
            }
        });
    });


    tallasTemp = orderColorSizes(tallasTemp);
    return tallasTemp;
}


/**
 * M?todo que recorre cada uno de los colores y convierte su conjunto de objetos de tallas en
 * un array de tallas y ordena el array seg?n el atributo posici?n.
 * Se devuelve la nueva estructura, el objeto original pasado por par?metro no se modifica.
 */
function orderColorSizes(tallasColores) {
    var resTallasColores = new Object();
    $.each(tallasColores, function (posColores,tallasColor){
        var i, j, aux;
        var resTallasColor = $.map(tallasColor, function(k, v) {
            return [k];
        });
        for(i=0;i<resTallasColor.length-1;i++) {
            for(j=i+1;j<resTallasColor.length;j++) {
                if(resTallasColor[i].posicion>resTallasColor[j].posicion) {
                    aux=resTallasColor[i];
                    resTallasColor[i]=resTallasColor[j];
                    resTallasColor[j]=aux;
                }
            }
        }
        resTallasColores[posColores] = resTallasColor;
    });
    return resTallasColores;
}


/**
 * M?todo que a partir del JSON de stock, crea otro JSON donde la clave es el catentryId y el value el stock, para
 * as? localizar m?s f?cilmente el stck de un catentry.
 *
 */
function crearHashInventory(stocks){
    if( !stocks || stocks.length <= 0){
        return null;
    }
    var stockHash;
    var JSONtemp ={};
    var length = stocks.length;
    $.each(stocks,function(pos,element){
        JSONtemp[element.id]= element.inventory ;
    });

    return JSONtemp;
}
;
/* END /DuttiNEWStorefrontAssetStore/js/Navigation/Main/detalleCommon.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Navigation/Util/ItxSocialNetworkController.js (en_US) */


var listMeta = document.getElementsByTagName('meta');
var title = "";
var description = "";
var urlActual = "";
var urlImage = "";
var productIdActual;

function initializeSocialNetwork (options){

    var controller = this;

    switch (options)
    {
        case 0: //Detalle de producto o detalle de Bundle

            urlImage = $('#socialShareImage').val();
            urlActual = controller.escapeUrl( $('#socialShare').val());
            if (typeof productJSON != "undefined") {
                productIdActual = productJSON.productId;
            }

            for(var i=0; i<listMeta.length; i++){
                if(listMeta[i].getAttribute('name') == 'title'){
                    title = listMeta[i].getAttribute('content');
                }
                if(listMeta[i].getAttribute('name') == 'description'){
                    description = listMeta[i].getAttribute('content');
                }

            }

            break;
    }

}
function weibo(){
    if(Inditex)
        Inditex.trackEvent('Ficha_Producto','share','weibo');
    shareWeibo(urlActual,title,urlImage);
}

function vkontakte(){
    if(Inditex)
        Inditex.trackEvent('Ficha_Producto','share','vkontakte');
    share_vkontakte();
}

function share_vkontakte() {
    var url = 'http://vk.com/share.php?url=';
    url += encodeURIComponent(document.location.href);
    url += '&title='+encodeURIComponent($('title').html());
    url += '&description='+encodeURIComponent($('meta[name=description]').attr('content'));
    //url += '&photos=';
    window.open(url);
}

function facebook(){
    if(Inditex)
        Inditex.trackEvent('Ficha_Producto','share','facebook');
    shareFacebook (title,description,urlImage,urlActual,productIdActual);
}
function twitter(){
    if(Inditex)
        Inditex.trackEvent('Ficha_Producto','share','twitter');
    shareTwitter(title,urlActual);
}
function tuenti (){
    shareTuenti(urlActual);
}
function pinterest (){
    if(Inditex)
        Inditex.trackEvent('Ficha_Producto','share','pinterest');
    sharePinterest();
}

function shareWeibo(link, title, image){
    window.open("http://service.weibo.com/share/share.php?url="+link+"&appkey=&title="+title+"&pic="+image+"&ralateUid=&language=");
}
function shareFacebook (title,description,image,link, productId){
    var url = Inditex.generateUrl("ItxStandardShareProxyPage", {
        "categoryId" : Inditex.iCategoryId,
        "productId" : productId,
        "storeId": Inditex.iStoreId,
        "title":title,
        "description":description,
        "image":image
    });
    window.open("http://www.facebook.com/sharer.php?u="+encodeURIComponent(url));
}

function shareTwitter(title,link){
    window.open("http://twitter.com/share?text="+title+"&url="+link);
}
function shareFancy(title,link,image){
    window.open("http://www.thefancy.com/fancyit?ItemURL="+link+"&Title="+title+"&Category=Women&ImageURL="+image);
}
function shareTuenti(link){
    window.open("http://www.tuenti.com/share?url="+link);
}
function shareGoogle(url){

    var href = 'https://plus.google.com/share?url='+url;
    window.open(href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');

}

function sharePinterest(){

    var e=document.createElement('script');
    e.setAttribute('type','text/javascript');
    e.setAttribute('charset','UTF-8');
    e.setAttribute('src','http://assets.pinterest.com/js/pinmarklet.js?r='+Math.random()*99999999);
    document.body.appendChild(e);
}

function escapeUrl(cadena) {
    var chars = [ ' ', '<', '>', '#', '%', '~', '/', '|', ';', ':', '@', '=', '?', '&' ];
    var source = cadena;
    var dest="";
    for (var i=0; i<source.length; i++) {
        var c = source.charAt(i);
        var found = 0;
        for (var j=0; (!found) && (j<chars.length); j++) {
            if (chars[j] == c) {
                found = 1;
            }
        }
        if (found) {
            dest += "%" + source.charCodeAt(i).toString(16);
        } else {
            if(source.charAt(i) != '"'){
                dest += c;
            }
        }
    }
    return dest;
}
;
/* END /DuttiNEWStorefrontAssetStore/js/Navigation/Util/ItxSocialNetworkController.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/miCuenta.js (en_US) */
var lastClickedLink = null;
var dForm = null;
var moneda;
var symbolPosition;
var nextCardHash;

function initMiCuenta(callback) {
    $("#logo").click(gotoHome);
    $(".activeSection").removeClass("activeSection");

    var menuLi = $("#menu_modal li");
    menuLi.each(function() {
        var li = $(this);
        li.click(function() {
            selectMenuElement(li);
        });
    });
    setTimeout(function() {
        var url = $("#urlHome").attr("value");
        jQuery.xajax({
            url: url,
            type: "post",
            dataType: 'html',
            success: function(data) {
                init_miCuentaHome();
                if(callback != null)
                    callback();
            }
        });

    }, 300);
    setCSSPaddingContent();
}

function selectMenuElement(li) {
    // Deseleccionamos los elementos del menu
    $("#menu_modal a").each(function() {
        $(this).removeClass("activeSection");
    });
    // Seleccionamos el elemento del menu
    li.find("a").addClass("activeSection");

    // Cargamos el contenido
    var id = li.attr("id");
    var input = $("input[id=" + id + ']')
    var url = input.attr("value");

    //Para que funcione el HTTPS
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(data) {
            $('#content_micuenta').html(data);
            var gaLogicu = $('#content_micuenta .data-ga-logic-universal').attr('data-ga-logic-universal');
            if (gaLogicu) {
                Inditex.trackPage( gaLogicu,true);
            } else {
                gaLogicu = $('#content_micuenta .data-ga-logic-universal').attr('data-ga-logic-universal-tunel');
                if (gaLogicu) {
                    if (gaLogicu.match(/\/$/) && extraPageview.match(/^\//)) {
                        gaLogicu = gaLogicu.substr(0, gaLogicu.length-1);
                    }
                    Inditex.trackPage( gaLogicu+extraPageview,true);
                }
            }
            setScroll();
            var initFunction = window["init_" + id];
            if(initFunction != null) {
                initFunction.apply();
                setScroll();
            }
        }
    });
    $('#content_micuenta').css("height", "");
}

function hideContentAux() {
    $(".miCuentaAux").hide();
    $(".miCuentaPrincipal").show();
    setScroll();

}

function loadContentAux(url) {
    $("#content_aux").load(url, function() {
        $(".miCuentaPrincipal").hide();
        $(".miCuentaAux").show();
    });
}

function init_miCuentaHome() {
    setCSSPaddingContent()
}

function init_datosAcceso() {

    $("#updatePasswordForm").validate({
        submitHandler : function(form) {

            var form = $("#updatePasswordForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                data: form.serialize(),
                success: function(data) {
                    if (typeof(data) == "string") {
                        data = JSON.parse(data);
                    }
                    $('#captchaImg').attr('src',$('#captchaURL').attr('value')+"&t="+new Date().getTime());

                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Acceso/Modificar_Contrasena/Envio_OK");
                            Inditex.trackEvent( "Mi_cuenta","modificar_datos_acceso_ok",null,true);
                        }
                        openStaticModal(Messages.titlePassword, Messages.msgPassword, true);
                    } else {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Acceso/Modificar_Contrasena/Envio_Error_" + data.type);
                            Inditex.trackEvent( "Mi_cuenta","modificar_datos_acceso_error",Inditex.codeError(data.key,data.errorMessage),true);
                        }
                        openStaticModal(data.title, data.errorMessage, true);
                    }

                }
            });
        },
        rules : {
            logonPasswordOld : {
                validPassword: true,
                required : true,
                minlength : 6
            },
            logonPassword : {
                validNewPassword: true,
                validPassword: true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                validNewPassword: true,
                required : true,
                minlength : 8,
                equalTo : "#password1"
            }
        },
        messages : {
            logonPasswordOld : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPassword : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPasswordVerify : {
                required : Messages.required,
                minlength : Messages.minlength,
                equalTo : Messages.equalTo
            }
        }

    });
    $("#updatePasswordBtn").click(function() {
        $("#updatePasswordForm").submit();

    });

    $("#updateMailForm").validate({
        submitHandler : function(form) {
            var form = $("#updateMailForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                data: form.serialize(),
                success: function(data) {
                    if (typeof(data) == "string") {
                        data = JSON.parse(data);
                    }
                    //Actualizo el email en el popup
                    $('#emailActual').html($('#email1').val());

                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Acceso/Modificar_Contrasena/Envio_OK");
                            Inditex.trackEvent( "Mi_cuenta","modificar_datos_acceso_ok",null,true);
                        }
                        openStaticModal(Messages.titleMail, Messages.msgMail, true);
                    } else {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Acceso/Modificar_Mail/Envio_Error_" + data.type);
                            Inditex.trackEvent( "Mi_cuenta","modificar_datos_acceso_error",Inditex.codeError(data.key,data.errorMessage),true);
                        }
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });

        },
        rules : {
            logonPasswordOld : {
                required : true,
                minlength : 6
            },
            email_1 : {
                required : true,
                email : true
            },
            email_2 : {
                required : true,
                email : true,
                equalTo : "#email1"
            }
        },
        messages : {
            logonPasswordOld : Messages.logonPasswordOld,
            email_1 : Messages.email_1,
            email_2 : Messages.email_2
        }
    });
    $("#updateMailBtn").click(function() {
        $("#updateMailForm").submit();
    });
}

function setDatosPersonalesBtnClick () {
    $("#datosPersonalesBtn").attr("onclick","javascript:prepararFormulario1();enviarFormulario1();");
}

function init_datosPersonales() {
    loadRadiosAndChecksNew(false);
    selectBinds(149, 'px');

    var url = $("#datosPersonalesJSON").attr("value");

    //loadDatosPersonales('data/datospersonales.json')
    loadDatosPersonales(url)

    $("#tipoDatosPersonales_persona").click(function() {
        cambioDatosPersonalesParticular();
    });

    $("#tipoDatosPersonales_empresa").click(function() {
        cambioDatosPersonalesEmpresa();
    });





    $.validator.addMethod("localDate", function(value, element) {
        chunks = value.split('/');
        if(chunks.length != 3)
            return false;
        date = new Date(chunks[2], chunks[1], chunks[0])
        return value.match(/^\d\d?\/\d\d?\/\d\d\d\d$/);
    }, "Por favor introduzca una fecha en el formato dd/mm/aaaa");

    $("#datosPersonalesForm").validate({
        submitHandler : function(form) {
            var form = $("#datosPersonalesForm");
            $("#datosPersonalesForm #datosPersonalesBtn").removeAttr("onclick");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                data: form.serialize(),
                dataType: 'json',
                success: function(data) {
                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Personales/Envio_OK");
                            Inditex.trackEvent( "Mi_cuenta","modificar_personales_acceso_ok",null,true);
                        }

                        //Actualizo el nombre y apellido del usuario autenticado en el Menu, porque puede haber cambiado.
                        Inditex.drawHeader();

                        openStaticModal(Messages.titleUpdate, Messages.msgUpdate, true);

                    } else {
                        if (Inditex) {
                            Inditex.trackPage("Mi_Cuenta/Datos_Personales/Envio_Error_" + data.type);
                            Inditex.trackEvent( "Mi_cuenta","modificar_personales_acceso_error",Inditex.codeError(data.key,data.errorMessage),true);
                        }
                        openStaticModal(data.title, data.errorMessage, true);
                    }

                    setTimeout(function() {
                        setDatosPersonalesBtnClick ();
                    }, 1000);
                }
            });

        },
        rules : {
            requiredTipo : {
                required : function() {
                    return $("input[name=tipoDatosPersonales]:checked").length == 1;
                }
            },
            firstName : "required",
            middleName: "required",
            lastName : "required",
            birthDate : {
                requiredChangeClassLocalDate : true
            },
            phone1Prefix :{
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            phone2 : {
                validatePhone : true
            },
            phone2Prefix :{
                validPrefix : true
            },
            zipCode : "requiredChangeClass",
            state : "itxSelect",
            country1 : "required",
            city : "required",
            sexo : "required",
            nif :{
                required: function(element){
                    if  ($("#empresa").length && $("#empresa").val() !== ''){
                        return true;
                    }else{
                        return false;
                    }
                },
                validateNif:  function(element){
                    if  ($("#empresa").length && $("#empresa").val() !== ''){
                        return true;
                    }else{
                        return false;
                    }
                }
            }
        },
        messages : {
            requiredTipo : Messages.requiredTipo,
            firstName : Messages.required,
            middleName : Messages.requiredMiddleName,
            lastName : Messages.required,
            birthDate : Messages.birthDate,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            phone2 : eval('Messages.phone_' + iCountry),
            zipCode : eval('Messages.zipCode_' + iCountry),
            city : Messages.required,
            state : Messages.state,
            country1 : Messages.country,
            nif : {
                required: Messages.required,
                validateNif: Messages.nifIncorrecto
            }
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=nif]").rules("remove");

        $("input[name=nif]").rules("add", {
            required: function(element){
                if  ($("#empresa").length && $("#empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            validateNifCif:  function(element){
                if  ($("#empresa").length && $("#empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            messages: {
                required:Messages.required,
                validateNifCif:Messages.nifIncorrectoMX
            }
        });

    }

    if (iCountry == "US") {
        $("input[name=address1]").rules("add", {
            required: true,
            maxlength: 35,
            messages: {
                required: Messages.address
                //maxlength: "long"
            }
        });
    } else  {
        $("input[name=address1]").rules("add", {
            required: true,
            messages: {
                required: Messages.address
            }
        });
    }


    /*$("#datosPersonalesBtn").click(function() {
     $("#datosPersonalesForm").submit();
     });*/

    $("#datosEmpresaForm").validate({
        submitHandler : function(form) {
            var form = $("#datosEmpresaForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                data: form.serialize(),
                success: function(data) {

                    //Actualizo el nombre y apellido del usuario autenticado en el Menu, porque puede haber cambiado.
                    Inditex.drawHeader();

                    openStaticModal(Messages.titleUpdate, Messages.msgUpdate, true);

                    if (data.status > 0) {
                        if (Inditex)
                            Inditex.trackPage("Mi_Cuenta/Datos_Personales/Envio_OK");
//							openStaticModal(Messages.titleUpdate, Messages.msgUpdate, true);
                    } else {
                        if (Inditex)
                            Inditex.trackPage("Mi_Cuenta/Datos_Personales/Envio_Error_" + data.type);
//							openStaticModal(data.title, data.errorMessage, true);	
                    }

                }
            });
        },
        rules : {
            requiredTipo : {
                required : function() {
                    return $("input[name=tipoDatosPersonales]:checked").length == 1;
                }
            },
            nif :{
                required:true,
                validateNif: true
            } ,
            companyName : "required",
            firstName : "required",
            lastName : "required",
            birthDate2 : {
                requiredChangeClassLocalDate : true
            },
            phone1Prefix :{
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            phone2Prefix :{
                validPrefix : true
            },
            phone2 : {
                validatePhone : true
            },

            zipCode : "requiredChangeClass",
            provincia2 : "itxSelect",
            pais : "required",
            city : "required",
            sexo : "required"
        },
        messages : {
            companyName : Messages.required,
            nif : {
                required:Messages.required,
                validateNif: Messages.nifIncorrecto
            },
            requiredTipo : Messages.requiredTipo,
            firstName : Messages.required,
            lastName : Messages.required,
            birthDate2 : Messages.birthDate,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            phone2 : eval('Messages.phone_' + iCountry),
            zipCode : eval('Messages.zipCode_' + iCountry),
            city : Messages.required,
            provincia : Messages.state,
            pais : Messages.country
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=nif]").rules("remove");

        $("input[name=nif]").rules("add", {
            required: function(element){
                if  ($("#empresa").length && $("#empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            validateNifCif:  function(element){
                if  ($("#empresa").length && $("#empresa").val() !== ''){
                    return true;
                }else{
                    return false;
                }
            },
            messages: {
                required:Messages.required,
                validateNifCif:Messages.nifIncorrectoMX
            }
        });

    }

    if (iCountry == "US") {
        $("input[name=address1]").rules("add", {
            required: true,
            maxlength: 35,
            messages: {
                required: Messages.address
                //maxlength: "long"
            }
        });
    } else  {
        $("input[name=address1]").rules("add", {
            required: true,
            messages: {
                required: Messages.address
            }
        });
    }


    $('#check_newsletter').on('click', function(){

        Inditex.getUserJSON(function(aJson) {

            var email_value = aJson.email;
            var poli_priv = $('input[name="newsletter"]').is(':checked');

            if ($('input[name="newsletter"]').is(':checked')) {

                var url = Inditex.generateUrl('SubscribeNewslettersCmd', {
                    "storeId"				: Inditex.iStoreId,
                    "catalogId"				: Inditex.iCatalogId,
                    "langId"				: Inditex.iLangId,
                    "categoryId"			: Inditex.iCategoryId,
                    "mail"					: email_value,
                    "viewTaskName"			: "NoURL",
                    "viewname"				: "ItxResponseJSON",
                    "errorViewName"			: "ItxDynamicError",
                    "newslettersName"		: "newsletterGeneral",
                    "privacyPolicy"			: "on"
                }, true);

                Inditex.request({
                    "url": url,
                    "onSuccess": function(aText) {
                        openStaticModal(Messages.contacta_newsletter_alta_titulo, Messages.contacta_newsletter_alta_mensaje, true);
                    },
                    "onFailure": function(aText) {
                        showError(ITX_TEXT_GENERIC_PROBLEM);
                    }
                });
            } else {

                var url = Inditex.generateUrl('UnsubscribeNewslettersCmd', {
                    "storeId"				: Inditex.iStoreId,
                    "catalogId"				: Inditex.iCatalogId,
                    "langId"				: Inditex.iLangId,
                    "categoryId"			: Inditex.iCategoryId,
                    "mail"					: email_value,
                    "viewTaskName"			: "NoURL",
                    "viewname"				: "ItxResponseJSON",
                    "errorViewName"			: "ItxDynamicError",
                    "newslettersName"		: "newsletterGeneral"
                }, true);

                Inditex.request({
                    "url": url,
                    "onSuccess": function(aText) {
                        openStaticModal(Messages.contacta_newsletter_baja_titulo, Messages.contacta_newsletter_baja_mensaje, true);
                    },
                    "onFailure": function(aText) {
                        showError(ITX_TEXT_GENERIC_PROBLEM);
                    }
                });
            }

        });


    })

    /*$("#datosEmpresaBtn").click(function() {
     $("#datosEmpresaForm").submit();
     });*/
    setCSSPaddingContent();
    jQuery('input[name^=address1]').attr('maxlength',100);
    jQuery('input[name^=address2]').attr('maxlength',50);
}

function init_datosEnvio() {
    lastClickedLink = null;
    var url = $("#datosEnvioJSON").attr("value");

    //loadDirecciones('data/libroDirecciones.json');
    loadDirecciones(url);

}

function init_pedidosRealizados() {
    var urlOrderRequested = $("#iOrderRequestedUrl").attr('value');

    //Busco y pinto los pedidos realizados
    jQuery.xajax({
        url: urlOrderRequested,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSON(respHtml);
            //Borro el contenido anterior.
            $("#content_micuenta").find("#tablaPedidos").empty();
            $.each(dataJSON, function(l, orderRequested) {

                symbolPosition = orderRequested.currencySuffix.length==0;
                if (!symbolPosition)
                    moneda = orderRequested.currencySuffix;
                else
                    moneda=orderRequested.currencyPrefix;
                paintOrderRequested(orderRequested);
            });

            if (Inditex.iStoreJSON.details.eInvoiceEnabled&&Inditex.iStoreJSON.details.eInvoiceEnabled!="0"){
                $(".efactura.request").click(function() {
                    var element= this;
                    jQuery.xajax({
                        url: $("#datosPersonalesJSON").val(),
                        dataType: 'json',
                        success: function(data) {
                            if(data.nif&&data.nif!=""){
                                Inditex.restRequestInvoice({
                                    orderId: element.getAttribute("data-order"),
                                    onSuccess: function(aJson) {
                                        if (!aJson.errorKey ) {
                                            openStaticModal(Messages.ItxMyAccountOrderRequestedView_order_ebill_title,Messages.ItxMyAccountOrderRequestedView_order_ebill_requested, true);
                                        }else {
                                            showError(aJson.errorMessage);
                                        }
                                    },
                                    onFailure: function(aStatus) {
                                        showError(ITX_TEXT_GENERIC_PROBLEM);
                                    }
                                });
                            }else{
                                openStaticModal(Messages.ItxMyAccountOrderRequestedView_order_ebill_title,Messages.ItxMyAccountOrderRequestedView_order_ebill_no_nif, true);
                            }
                        }});

                });
                $(".efactura.pending").click(function() {
                    openStaticModal(Messages.ItxMyAccountOrderRequestedView_order_ebill_title, Messages.ItxMyAccountOrderRequestedView_order_ebill_pending, true);
                });
                $(".efactura.notavailable").click(function() {
                    openStaticModal(Messages.ItxMyAccountOrderRequestedView_order_ebill_title, Messages.ItxMyAccountOrderRequestedView_order_ebill_notavailable, true);
                });
            }

            //para ajustar el scroll.
            setScroll();
        }
    });

    setCSSPaddingContent();
}

function init_tiendasFavoritas() {
    idsTiendasMiCuenta = new Array();
    var urlLocator = $("#iStoreLocatorMyAccountPageUrl").attr('value');
    var urlLocatorFav = $("#iShopsUrl").attr('value');

    // Primero ejecuto para pintar las tiendas favoritas
    jQuery.xajax({
        url: urlLocatorFav,
        type: "post",
        dataType: 'json',
        success: function(respHtml) {

            var dataJSON = getResponseJSON(respHtml);
            $.each(dataJSON.favouriteStores, function(l, tienda) {
                onAddTiendaFavorita(tienda);
            });

            // Segundo pinto el localizador de tienda.
            jQuery.xajax({
                url: urlLocator,
                type: "post",
                dataType: 'html',
                success: function(data) {
                    $('#seleccionarTiendaDiv').html(data);
                    $('#closePopupLoc').remove(); //Tengo que borrar el close de la pagina ya lo tengo en el popup

                    //inicializar el mapa
                    setTimeout(function(){initSeleccionarTienda({onAddTienda: onAddTiendaFavorita});}, 1000);
                    $(".deleteTienda").click(deleteTienda);

                    //para ajustar el scroll.
                    setScroll();
                }
            });
        }
    });

    setCSSPaddingContent();
}

var idsTiendasMiCuenta = null;

function escapeHtml(text) {
    return (text==null?'':$('<div/>').text(text).html());
}

function onAddTiendaFavorita(tienda) {
    if (Inditex)
        Inditex.trackEvent('Tiendas','favoritos');


    if(indexOf(idsTiendasMiCuenta, tienda) < 0){

        //si cargamos la pagina al insertar algo
        var cargaNormal=1;
        if(typeof tienda.id != 'undefined'){
            cargaNormal=0;
            //si solo estamos cargando la p?gina
        }

        if (cargaNormal==0){
            idsTiendasMiCuenta.push(tienda.id);
        }
        else{
            idsTiendasMiCuenta.push(tienda.physicalStoreId);
        }
        var tr = document.createElement("tr");
        var td = null;
        var p = null;
        td = document.createElement("td");
        var input = document.createElement("input");
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "physicalStoreId");
        if (cargaNormal==0){
            input.setAttribute("value", tienda.id);
        }
        else{
            input.setAttribute("value", tienda.physicalStoreId);
        }
        p = document.createElement("p");
        p.className = "deleteTienda";
        p.innerHTML = "x";
        if (cargaNormal==1){
            $(p).click(deleteTienda);
        }
        td.appendChild(input);
        td.appendChild(p);
        tr.appendChild(td);

        // city address name
        // Name
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = escapeHtml(tienda.city);
        td.appendChild(p);
        tr.appendChild(td);

        // Provincia
        td = document.createElement("td");
        p = document.createElement("p");
        if (cargaNormal==0){
            p.innerHTML = escapeHtml(tienda.state);
        }
        else{
            p.innerHTML = escapeHtml(tienda.city);
        }
        td.appendChild(p);
        tr.appendChild(td);

        // Phone
        td = document.createElement("td");
        p = document.createElement("p");
        if (cargaNormal==0){
            p.innerHTML = tienda.phones[0];
        }
        else{
            p.innerHTML = tienda.phone1;
        }
        td.appendChild(p);
        tr.appendChild(td);

        // Address
        td = document.createElement("td");
        p = document.createElement("p");
        if (cargaNormal==0){
            p.innerHTML = escapeHtml(tienda.addressLines[0]);
        }
        else{
            p.innerHTML = escapeHtml(tienda.address);
        }
        td.appendChild(p);
        tr.appendChild(td);

        $("#content_micuenta").find("#tablaPedidos").append(tr);
        $("#large_modal").scrollTo(0);
        $(window).resize();
    }
}

function deleteTienda(element) {
    if (Inditex) {
        Inditex.trackEvent( "Mi_cuenta","Tiendas_favoritas_eliminar",null,true);
    }
    var tr = $(this).parent().parent();
    var input = tr.find('input[name=\"physicalStoreId\"]');
    var elemento=$(this);
    jQuery.xajax({
        url: $('#iRemoveUrl').val(),
        type: "post",
        dataType: 'json',
        data: "physicalStoreId="+input.val(),
        success: function(data) {
            if (data.status > 0) {
                eliminaFavoritoVisualmente(elemento);
            }
            else{
                openStaticModal(data.title, data.errorMessage, true);
            }


        }
    });
}


function eliminaFavoritoVisualmente(elemento){
    elemento.parent().parent().remove();
}


function init_devolucionDomicilio_paso1(url) {
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            $('#content_micuenta').html(respHtml);

            var urlOrderReturnSelectItem = $("#iOrderReturnSelectItemJSONURL").attr('value');

            //Busco y pinto los pedidos realizados
            jQuery.xajax({
                url: urlOrderReturnSelectItem,
                type: "post",
                dataType: 'html',
                success: function(respHtml) {
                    var dataJSON = getResponseJSON(respHtml);
                    loadDetallePedidoDevolver(dataJSON);


                    loadRadiosAndChecksDevo();
                    detalleDevolucionBinds();


                    $('#btContinue').click(function() {
                        var urlOrderAddressURL = $("#iOrderReturnAddressViewURL").attr('value');
                        validateProducts(urlOrderAddressURL, url);
                    });

                    //para ajustar el scroll.
                    setScroll();
                }
            });
        }
    });

    setCSSPaddingContent();
}

//Variable global (JSON) que contien la informacion del pedido a devolver.
var orderReturnResponse = {"orderId":"null", "dateOrder": "null", "listItems": new Array(),
    "address": {"firstName": "null",
        "lastName": "null",
        "street": "null",
        "street2": "null",
        "city": "null",
        "zipCode": "null",
        "state": "null",
        "stateISO": "null",
        "country": "null",
        "countryISO": "null",
        "phone1": "null",
        "phone2": "null",
        "colony":"null",
        "municipality": "null",
        "numcaj": "null"},

    "cod": 	   {
        "iAssociatedPaymentMethod": null,
        "iFirstNameCod": "null",
        "iAddress1Cod": "null",
        "iCityCod": "null",
        "iStateCod": "null",
        "iZipCodeCod": "null",
        "iPhoneNumberPrefix": "null",
        "iPhoneNumber": "null",
        "iCccFirstName": "null",
        "ibankName": "null",
        "iCcc": "null",
        "iBankInn": "null",
        "iBankBic": "null",
        "iCccLastName": "null",
        "iLastNameCod": "null"
    }

};


function init_devolucionDomicilio() {
    //Reinicio por defecto el JSON con los valores del pedido.
    orderReturnResponse = {"orderId":"null", "dateOrder": "null", "listItems": new Array(),
        "address": {"firstName": "null",
            "lastName": "null",
            "street": "null",
            "street2": "null",
            "city": "null",
            "zipCode": "null",
            "state": "null",
            "stateISO": "null",
            "country": "null",
            "countryISO": "null",
            "phone1": "null",
            "phone2": "null",
            "colony": "null",
            "municipality": "null",
            "numcaj": "null"},

        "cod": 	   {
            "iAssociatedPaymentMethod": null,
            "iFirstNameCod": "null",
            "iAddress1Cod": "null",
            "iStateCod": "null",
            "iZipCodeCod": "null",
            "iPhoneNumberPrefix": "null",
            "iPhoneNumber": "null",
            "iCccFirstName": "null",
            "ibankName": "null",
            "iCcc": "null",
            "iBankInn": "null",
            "iBankBic": "null",
            "iCccLastName": "null",
            "iLastNameCod": "null"}
    };
    var urlOrderReturn = $("#iOrderReturnUrl").attr('value');

    //Busco y pinto los pedidos par devolver
    jQuery.xajax({
        url: urlOrderReturn,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSON(respHtml);
            $.each(dataJSON, function(l, orderReturn) {
                paintOrderReturn(orderReturn);
            });

            //para ajustar el scroll.
            setScroll();
        }
    });

    setCSSPaddingContent();
}

function init_devolucionDomicilio_paso2(url, urlPaso1, urlPaso2) {
    $("#devoForm").validate({
        submitHandler : function(form) {

            orderReturnResponse.address.firstName = $("#devoForm").find('#inpname').val();
            if (Inditex.iStoreJSON.details.isMiddleName) {
                orderReturnResponse.address.middleName = $("#devoForm").find('#inpmiddlename').val();
            }
            orderReturnResponse.address.lastName = $("#devoForm").find('#inpapellid').val();
            orderReturnResponse.address.street = $("#devoForm").find('#inpdirec').val();
            orderReturnResponse.address.street2 = $("#devoForm").find('#inpdirec2').val();
            orderReturnResponse.address.city = $("#devoForm").find('#inplocal').val();
            orderReturnResponse.address.zipCode = $("#devoForm").find('#inpcp').val();
            orderReturnResponse.address.stateISO = $("#devoForm").find('#inpprovi').val();
            orderReturnResponse.address.state = $("#devoForm").find('#inpprovi').find("option:selected").text();
            orderReturnResponse.address.country = $("#devoForm").find('#inppais').val();
            orderReturnResponse.address.countryISO = $("#devoForm").find('#inppaisISO').val();
            orderReturnResponse.address.phone1 = $("#devoForm").find('#inpprefijo').val() + ' ' +  $("#devoForm").find('#inpmovil').val()
            orderReturnResponse.address.phone2 = $("#devoForm").find('#inpprefijo2').val() + ' ' +  $("#devoForm").find('#inptlfn').val()
            if($("#devoForm").find('#colony')&&$("#devoForm").find('#colony').length>0){
                orderReturnResponse.address.colony= $("#devoForm").find('#colony').val();
            }
            if($("#devoForm").find('#municipality')&&$("#devoForm").find('#municipality').length>0){
                orderReturnResponse.address.municipality= $("#devoForm").find('#municipality').val();
            }
            orderReturnResponse.address.numcaj = $("#devoForm").find('#inpnumcaj').val();


            jQuery.xajax({
                url: url,
                type: "post",
                dataType: 'html',
                success: function(respHtml) {
                    $('#content_micuenta').html(respHtml);

                    //Cargo el click en el paso1
                    $("#paso1").click(function() {
                        init_devolucionDomicilio_paso1(urlPaso1);
                    });

                    //Cargo el click en el paso2
                    $("#paso2").click(function() {
                        execOrderReturnAddress(urlPaso2, urlPaso1);
                    });

                    loadDataOrderReturnConfirm();

                    $('#orderReturnEnd').click(function() {
                        saveOrderRetrunConfirm();
                    });

                    //para ajustar el scroll.
                    setScroll();

                    var tipoDevolucion= $("#tipoDevolucion").attr('value');

                    if(tipoDevolucion == 'COD'){
                        var urlOrderConfirmView = $("#iOrderReturnConfirmViewURL").attr('value');
                        init_devolucionDomicilio_paso3_ru(urlOrderConfirmView, urlPaso1, urlPaso2, url);

                        var priceTotal = loadDetallePedidoDevolverConfirm(orderReturnResponse);
                        $("#orderNumber").attr("value",orderReturnResponse.orderId);
                        $("#importeSpan").html(formatCurPrice(priceTotal, 2,moneda));
                        $("#importe").attr("value",$("#importeSpan").text());

                    }

                }
            });
        },
        rules : {
            inpname : "required",
            inpmiddlename : "required",
            inpapellid : "required",
            inpdirec : "required",
            inpcp : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true, "requiredChangeClassRestrictedCPRusia" : true},
            inpprovi : "itxSelect",
            inplocal :  "required",
            inpprefijo : {
                validPrefix : true,
                required : true
            },
            inpmovil : {
                required : true,
                validatePhone : true
            },
            inpprefijo2 : {
                validPrefix : true
            },
            inptlfn : {
                validatePhone : true
            },
            inpnumcaj : "cajasChangeClass"
        },
        messages : {
            inpname : Messages.ItxMyAccountOrderReturnAddressView_validate_inpname,
            inpmiddlename : Messages.ItxMyAccountOrderReturnAddressView_validate_inpmiddlename,
            inpapellid : Messages.ItxMyAccountOrderReturnAddressView_validate_inpapellid,
            inpdirec : Messages.ItxMyAccountOrderReturnAddressView_validate_inpdirec,
            inpprovi : Messages.ItxMyAccountOrderReturnAddressView_validate_inpprovi,
            inplocal : Messages.city,
            inpmovil : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            inptlfn : eval('Messages.phone_' + iCountry),
            inpnumcaj : Messages.ItxMyAccountOrderReturnAddressView_validate_inpnumcaj,
            inpcp : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode,
                "requiredChangeClassRestrictedCPRusia" : Messages.restrictedZipcodeRusia
            }
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
    }

    $("#confirmDevoBut").click(function() {
        $("#devoForm").submit();
    });
    setCSSPaddingContent();
    if(jQuery('input[name^=inpdirec]').length > 0){
        jQuery('input[name^=inpdirec]').attr('maxlength',100);
    }
}

function init_devolucionDomicilio_paso3_ru(url, urlPaso1, urlPaso2, urlPaso3) {
    $("#devoForm").validate({
        submitHandler : function(form) {

            orderReturnResponse.cod.iFirstNameCod = $("#devoForm").find('#iFirstNameCod').val() + "#" + $("#devoForm").find('#iMiddlenameCodGP').val();
            orderReturnResponse.cod.iAddress1Cod = $("#devoForm").find('#iAddress1Cod').val();
            orderReturnResponse.cod.iStateCod = $("#devoForm").find('#iStateCod').val();
            orderReturnResponse.cod.iPhoneNumberPrefix = $("#devoForm").find('#iPhoneNumberPrefix').val();
            orderReturnResponse.cod.iPhoneNumber = $("#devoForm").find('#iPhoneNumber').val();
            orderReturnResponse.cod.iZipCodeCod = $("#devoForm").find('#iZipCodeCod').val();
            orderReturnResponse.cod.iLastNameCod = $("#devoForm").find('#iLastNameCod').val();
            orderReturnResponse.cod.iCityCod = $("#devoForm").find('#iCityCod').val();

            orderReturnResponse.cod.iCccFirstName = $("#devoForm").find('#iCccFirstName').val() + "#" + $("#devoForm").find('#iMiddlenameCodTB').val();
            orderReturnResponse.cod.ibankName = $("#devoForm").find('#ibankName').val();
            orderReturnResponse.cod.iCcc = $("#devoForm").find('#iCcc').val();
            orderReturnResponse.cod.iBankInn = $("#devoForm").find('#iBankInn').val();
            orderReturnResponse.cod.iBankBic = $("#devoForm").find('#iBankBic').val();
            orderReturnResponse.cod.iCccLastName = $("#devoForm").find('#iCccLastName').val();








            jQuery.xajax({
                url: url,
                type: "post",
                dataType: 'html',
                success: function(respHtml) {
                    $('#content_micuenta').html(respHtml);

                    //Cargo el click en el paso1
                    $("#paso1").click(function() {
                        init_devolucionDomicilio_paso1(urlPaso1);
                    });

                    //Cargo el click en el paso2
                    $("#paso2").click(function() {
                        execOrderReturnAddress(urlPaso2, urlPaso1);
                    });

                    //Cargo el click en el paso3
                    $("#paso3").click(function() {
                        execOrderReturnPayment(urlPaso3, urlPaso1, urlPaso2);
                    });

                    loadDataOrderReturnConfirm();

                    $('#orderReturnEnd').click(function() {
                        saveOrderRetrunConfirm();
                    });

                    //para ajustar el scroll.
                    setScroll();
                }
            });



        },
        rules : {

            iFirstNameCod :  {
                required: true,
                maxlength: 62
            },
            iAddress1Cod :  {
                required: true,
                maxlength: 128
            },
            iStateCod :  {
                required: true,
                maxlength: 128
            },
            iCityCod :  {
                required: true,
                maxlength: 128
            },
            iZipCodeCod : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            inpname : "required",
            ibankName : {
                required: true,
                maxlength: 128
            },
            iCcc        :  {
                required: true,
                validateCCC : true
            },
            iBankBic : {
                required: true,
                validateBIC : true
            },
            iBankInn : {
                required: true,
                validateINN : true
            },
            iPhoneNumber : {
                required : true,
                number : true,
                validatePhone : true
            },
            iPhoneNumberPrefix : {
                validPrefix : true,
                required : true
            },

            iCccFirstName : {
                required: true,
                maxlength: 62
            },
            iMiddlenameCodGP :  {
                required: true,
                maxlength: 62
            },
            iCccLastName : {
                required: true,
                maxlength: 128
            },
            iLastNameCod :  {
                required: true,
                maxlength: 128
            },
            iMiddlenameCodTB : {
                required: true,
                maxlength: 62
            },

        },
        messages : {
            iFirstNameCod : Messages.ItxMyAccountOrderReturnPaymentView_validate_inpname,
            iAddress1Cod : Messages.ItxMyAccountOrderReturnPaymentView_validate_inpdirec,
            iStateCod : Messages.ItxMyAccountOrderReturnPaymentView_validate_inplocal,
            iCityCod : Messages.ItxMyAccountOrderReturnPaymentView_validate_inplocal,
            iZipCodeCod : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },
            iPhoneNumber : Messages.ItxMyAccountOrderReturnPaymentView_validate_inptlfn,
            inpname : Messages.ItxMyAccountOrderReturnPaymentView_validate_inpname,
            ibankName : Messages.ItxMyAccountOrderReturnPaymentView_validate_bankName,
            numCuenta : Messages.ItxMyAccountOrderReturnPaymentView_validate_numCuenta,
            iBankInn : Messages.ItxMyAccountOrderReturnPaymentView_validate_inn,
            iBankBic : Messages.ItxMyAccountOrderReturnPaymentView_validate_bic,
            inpcp : Messages.ItxMyAccountOrderReturnPaymentView_validate_inpcp,

            iCccFirstName: Messages.ItxMyAccountOrderReturnPaymentView_validate_inpname,
            iMiddlenameCodGP:Messages.ItxMyAccountOrderReturnPaymentView_validate_middlename,
            iMiddlenameCodTB:Messages.ItxMyAccountOrderReturnPaymentView_validate_middlename,
            iCccLastName:Messages.ItxMyAccountOrderReturnPaymentView_validate_inpapellid,
            iLastNameCod:Messages.ItxMyAccountOrderReturnPaymentView_validate_inpapellid



        }
    });

    $("#datos_cobro input[type=radio]").click(function() {
        if($(this).val() == 'giro') {
            $('.transferencia_bancaria').hide();
            $('.giro_postal').show();
            orderReturnResponse.cod.iAssociatedPaymentMethod = "2";
        } else {
            $('.giro_postal').hide();
            $('.transferencia_bancaria').show();
            orderReturnResponse.cod.iAssociatedPaymentMethod = "1";
        }
    });
    $('#tipo_giro').click();

    $("#datos_cobro .acc_butt").click(function() {
        $("#devoForm").submit();
    });
    setCSSPaddingContent();
}


function init_transferencia_manual() {


    $("#datosCobroTransferenciaManual").hide();
    $("#tranfenciaManualListadostep2").hide();
    $("#listadoDevolucionesManual").show();
    $("#tranfenciaManualListadostep1").show();


    Inditex.getUserJSON(function(userInfo) {

        var returnedOrders = userInfo.pendingTransfers;

        for (var i = 0; i < Inditex.iXRMAList.length; i++) {

            var rma = Inditex.iXRMAList[i];

            if (inArray(rma.id.toString(), returnedOrders)) {

                var html = "<tr>";

                html += "<td>" + rma.date + "</td>" +
                    "<td>" +  rma.id + "</td>" +
                    "<td>" + Inditex.formatPrice(rma.total) + "</td>" +
                    "<td class='right'><div class='boton2'><a href='#' class='acc_butt' rel='" + rma.id.toString() + "'>"+ Messages.solicitarDevolucion +"</a></div></td>";

                html += "<tr>";


                $('#tablaDevolucionesManual').append(html);
            }

        }

        $("#tablaDevolucionesManual .acc_butt").click(function() {

            var value = $(this).attr('rel');

            $("#rmaId").val(value);
            $("#listadoDevolucionesManual").hide();
            $("#tranfenciaManualListadostep1").hide();
            $("#datosCobroTransferenciaManual").show();
            $("#tranfenciaManualListadostep2").show();
        });

    })









    $("#datosCobroTransferenciaManual").validate({

        submitHandler : function(form) {

            var setManualTransferURL = Inditex.generateUrl('ItxStandardAddManualTransferRequestCmd', {
                'storeId'			: Inditex.iStoreId,
                'langId'			: Inditex.iLangId,
                'catalogId'			: Inditex.iCatalogId,
                'rmaId'				: $("#datosCobroTransferenciaManual input[name=rmaId]").val(),
                'firstName'			: $("#datosCobroTransferenciaManual input[name=name]").val(),
                'lastName'			: $("#datosCobroTransferenciaManual input[name=last_name]").val(),
                'iban'				: $("#datosCobroTransferenciaManual input[name=iban]").val(),
                'swift'				: $("#datosCobroTransferenciaManual input[name=swift]").val(),
                'bank'				: $("#datosCobroTransferenciaManual input[name=bank]").val(),
                'viewname'			: 'ItxStandardJSON',
                'errorViewName'		: 'ItxStandardJSON'
            }, true);

            Inditex.request({
                "url": setManualTransferURL,
                "onSuccess": function(aText) {
                    if (aText) {
                        var aJson = Inditex.evalJSON(aText);
                        if (!aJson.errorKey) {
                            showMiCuentaOption("urlTransferOK");
                        }else {
                            showError(ITX_TEXT_GENERIC_PROBLEM);
                        }
                    }
                },
                "onFailure": function(aText) {
                    showError(ITX_TEXT_GENERIC_PROBLEM);
                }
            });
        },


        rules : {
            name : "required",
            last_name : "required",
            bank : "required",
            iban : "required",
            swift : "required"
        },
        messages : {
            name : Messages.nameManualTransfer,
            last_name : Messages.surNameManualTransfer,
            bank : Messages.bankManualTransfer,
            iban : Messages.required,
            swift : Messages.required
        }
    });




    $("#datosCobroTransferenciaManual .acc_butt").click(function() {
        $("#datosCobroTransferenciaManual").submit();
    });
}


inArray = function(el, Arr) {

    var isInArray = false;

    for (var i = 0; i < Arr.length; i++) {
        if (Arr[i] == el) {

            isInArray = true;
        }
    }

    return isInArray;
}













/** funcion que graba en base de datos la devolcion de los articulos **/
function saveOrderRetrunConfirm() {
    var urlOrderReturnEndCmd = $("#iOrderReturnEndCmdURL").attr('value');
    var returnItems = '';
    var returnReason = '';
    var lista = orderReturnResponse.listItems;
    for( i = 0; i < lista.length; i++) {
        var orderItem = lista[i];
        if (i == 0) {
            returnItems = orderItem.orderItemId + '_' + orderItem.quantity ;
            returnReason = orderItem.orderItemId +  '_' + orderItem.reasonReturn;
        } else {
            returnItems = returnItems + ',' + orderItem.orderItemId + '_' + orderItem.quantity;
            returnReason =returnReason + ','+ orderItem.orderItemId + '_' + orderItem.reasonReturn;
        }
    }

    urlOrderReturnEndCmd = urlOrderReturnEndCmd;
    var data = 'orderId=' + orderReturnResponse.orderId
        + '&firstName=' + encodeURIComponent(orderReturnResponse.address.firstName)
        + '&middleName=' + ((Inditex.iStoreJSON.details.isMiddleName) ? (encodeURIComponent(orderReturnResponse.address.middleName)) : "" )
        + '&lastName=' + encodeURIComponent(orderReturnResponse.address.lastName)
        + '&zipCode=' + encodeURIComponent(orderReturnResponse.address.zipCode)
        + '&address1=' + encodeURIComponent(orderReturnResponse.address.street)
        + '&address2=' + encodeURIComponent(orderReturnResponse.address.street2)
        + '&country=' + orderReturnResponse.address.countryISO
        + '&state=' + orderReturnResponse.address.stateISO
        + '&city=' + encodeURIComponent(orderReturnResponse.address.city)
        + '&phone1Prefix=' + orderReturnResponse.address.phone1.split(" ")[0].replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
        + '&phone1Number=' + orderReturnResponse.address.phone1.split(" ")[1]
        + '&phone2Prefix=' + orderReturnResponse.address.phone2.split(" ")[0].replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
        + '&phone2Number=' + orderReturnResponse.address.phone2.split(" ")[1]
        + '&colony=' + encodeURIComponent(orderReturnResponse.address.colony)
        + '&municipality=' + encodeURIComponent(orderReturnResponse.address.municipality)
        + '&numBoxes=' + encodeURIComponent(orderReturnResponse.address.numcaj)
        + '&returnItems=' + returnItems
        + '&returnItemsReasonId=' + returnReason
        + '&associatedPaymentMethod=' + encodeURIComponent(orderReturnResponse.cod.iAssociatedPaymentMethod == null ? "" : orderReturnResponse.cod.iAssociatedPaymentMethod)
        + '&iFirstNameCod=' + encodeURIComponent(orderReturnResponse.cod.iFirstNameCod)
        + '&iAddress1Cod=' + encodeURIComponent(orderReturnResponse.cod.iAddress1Cod)
        + '&iStateCod=' + encodeURIComponent(orderReturnResponse.cod.iStateCod)
        + '&iZipCodeCod=' + encodeURIComponent(orderReturnResponse.cod.iZipCodeCod)
        + '&iPhoneNumberPrefix=' + orderReturnResponse.cod.iPhoneNumberPrefix.split(" ")[0].replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
        + '&iPhoneNumber=' + encodeURIComponent(orderReturnResponse.cod.iPhoneNumber)
        + '&iCccFirstName=' + encodeURIComponent(orderReturnResponse.cod.iCccFirstName)
        + '&ibankName=' + encodeURIComponent(orderReturnResponse.cod.ibankName)
        + '&iCcc=' + encodeURIComponent(orderReturnResponse.cod.iCcc)
        + '&iBankInn=' + encodeURIComponent(orderReturnResponse.cod.iBankInn)
        + '&iBankBic=' + encodeURIComponent(orderReturnResponse.cod.iBankBic)
        + '&iCccLastName=' + encodeURIComponent(orderReturnResponse.cod.iCccLastName)
        + '&iLastNameCod=' + encodeURIComponent(orderReturnResponse.cod.iLastNameCod)
        + '&iCityCod=' + encodeURIComponent(orderReturnResponse.cod.iCityCod);


    jQuery.xajax({
        url: urlOrderReturnEndCmd,
        type: "post",
        dataType: 'html',
        data: data,
        success: function(respHtml) {
            openStaticModal(Messages.ItxMyAccountOrderReturnConfirmView_end_title, Messages.ItxMyAccountOrderReturnConfirmView_end_menssage, true);
            $("#s_over_overlay").find('#close_modal').bind('click', function() {
                showMiCuentaOption ("miCuentaHome");
            });
        }
    });


}

/**
 * Binds para los botones +- en la seleccion de productos a devolver
 */
function detalleDevolucionBinds() {
    $('#content_micuenta .mas').off();
    $(document).on('click', '#content_micuenta .mas', function () {

        $('a[id^="radio"]').bind('click',function(){

            $(this).parent().parent().find('a').removeClass('active');
            $(this).addClass('active');

            this.click();
            this.checked = true;
        });

        var currPriceValue = parseInt($(this).prev().attr('value'));

        var tr = $(this).parent("div").parent("td").parent("tr");
        motivo_devolucion(currPriceValue + 1 , $(this));
        var quantityMax = $(tr).find("input[class=\"quantity\"]").attr("id");

        if ((currPriceValue + 1) <= quantityMax) {
            $('#content_micuenta span#maxQuantity').hide();
            $(this).prev().attr('value', currPriceValue + 1);
            recalcularTotalProduct($(this));
        } else {
            var messageValidacion = Messages.ItxMyAccountOrderReturnSelectItemView_validate_maxquantity_parte1
                + $(tr).find("td[id=\"desc\"]").find("p").text()
                + Messages.ItxMyAccountOrderReturnSelectItemView_validate_maxquantity_parte2;
            $('#content_micuenta span#maxQuantity').text(messageValidacion);
            $('#content_micuenta span#maxQuantity').show();
        }
    });
    $('#content_micuenta .menos').off();
    $(document).on('click', '#content_micuenta .menos', function () {
        var currPriceValue = parseInt($(this).next().attr('value'));
        if(currPriceValue > 0) {
            $('#content_micuenta span#maxQuantity').hide();
            $(this).next().attr('value', currPriceValue - 1);
            motivo_devolucion(currPriceValue - 1 , $(this));
            recalcularTotalProduct($(this));
        }
    });
}

/**
 * Oculta o muestra el bot?n de 'elegir motivo' de devoluci?n
 */
function motivo_devolucion(ammount, selector){
    if(ammount > 0){
        selector.parents('tr').find('.boton4').fadeIn();
        $('.devoMotivo a.radio').off('mouseup').on('mouseup' , function(){
            $(this).parents('.devoMotivo').slideUp();
        })

    }else{
        selector.parents('tr').find('.boton4').fadeOut();
        $('.devoMotivo a.radio').unbind('click')
    }

}



/**
 * Calcula el importe segn las unidades que se devuelven de un producto
 */
function recalcularTotalProduct(element) {
    var unitPrice = parseFloat(element.parent().parent().parent().attr('unitPrice'), 2);
    var quantity = parseInt(element.parent().find('.quantity').attr('value'));
    //valor a visualizar
    element.parent().parent().parent().find('.product_total').html(formatCurPrice(unitPrice * quantity, 2,moneda));
}

/**
 * Comprueba que se va a devolver al menos una unidad de cada producto
 */
function validateProducts(url, urlPaso1) {
    var continuar = false;
    $.each($('#content_micuenta input.quantity'), function(key, input) {
        if(parseInt($(input).val()) >= 1 && isNumber($(input).val())) {
            //Ref. 
            //Guardo en el JSON global todos los orderItems que va devolver el usuario. 
            var tr = $(input).parent("div").parent("td").parent("tr");
            var orderItemId = $(tr).attr("id");
            var imageSrc = $(tr).find("td[id=\"image\"]").find("img").attr("src");
            var description =$(tr).find("td[id=\"desc\"]").find("p").text();
            var reference = $(tr).find("td[id=\"desc\"]").find("span").text();
            var cutColorName = $(tr).find("td[id=\"cutColorName\"]").find("p").text();
            var size = $(tr).find("td[id=\"size\"]").find("p").text();
            var unitPrice = $(tr).find("td[id=\"unitPrice\"]").find("p").attr("id");

            if (! $(tr).find("td[id=\"reasonReturn\"]").find("a.radio.active")[0]){
                continuar = false;
            } else {
                var reasonReturn = $(tr).find("td[id=\"reasonReturn\"]").find("a.radio.active")[0].id.replace('radio_','');


                var orderItemJSON = '{"orderItemId": "'+  orderItemId + '", '
                    + '"image": "' + imageSrc + '", '
                    + '"description": "' + description + '", '
                    + '"reference": "' + reference + '", '
                    + '"cutColorName": "' + cutColorName + '", '
                    + '"size": "' + size + '", '
                    + '"quantity": "' + $(input).val() + '", '
                    + '"reasonReturn": "' + reasonReturn + '", '
                    + '"unitPrice": "' + unitPrice + '"}';
                orderReturnResponse.listItems.push(jQuery.parseJSON(orderItemJSON));
                continuar = true;
            }
        }
    });

    if ($('input.quantity').parents('tr').find('a.radio.active').length < 1){
        continuar = false;
    }

    if(continuar) {
        $('#content_micuenta span#mumQuantity').hide();
        execOrderReturnAddress(url, urlPaso1);
    } else {
        $('#content_micuenta span#mumQuantity').show();
    }
}

/** Metdo que hace que presentemos el paso 2 de la devolucion para poner la direccion de recogida **/
function execOrderReturnAddress(url, urlPaso1) {
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            $('#content_micuenta').html(respHtml);

            //Cargo el click en el paso1
            $("#paso1").click(function() {
                init_devolucionDomicilio_paso1(urlPaso1);
            });

            var urlOrderAddressJSON= $("#iOrderReturnAddressJSONURL").attr('value');
            //Cargar los datos personales del JSON.
            jQuery.xajax({
                url: urlOrderAddressJSON,
                type: "post",
                dataType: 'html',
                success: function(respHtml) {
                    var dataJSON = getResponseJSON(respHtml);
                    //Transformo el combo 
                    selectBindsCuenta(21,'%','76%');

                    //cargar los datos personales para devolver el pedido.
                    loadDatosPersonalesOrderReturn(dataJSON);

                    var tipoDevolucion= $("#tipoDevolucion").attr('value');
                    var urlVistaSiguiente = "";

                    if(tipoDevolucion == 'COD'){
                        urlVistaSiguiente = $("#iOrderReturnPaymentViewURL").attr('value');
                    }
                    else{
                        urlVistaSiguiente = $("#iOrderReturnConfirmViewURL").attr('value');
                    }

                    // validate the form when it is submitted
                    init_devolucionDomicilio_paso2(urlVistaSiguiente, urlPaso1, url);

                    //para ajustar el scroll.
                    setScroll();
                }
            });

        }
    });
}


/** Metdo que hace que presentemos el paso 3 de la devolucion para poner la direccion de recogida **/
function execOrderReturnPayment(url, urlPaso1, urlPaso2) {
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            $('#content_micuenta').html(respHtml);

            //Cargo el click en el paso1
            $("#paso1").click(function() {
                init_devolucionDomicilio_paso1(urlPaso1);
            });

            //Cargo el click en el paso1
            $("#paso2").click(function() {
                execOrderReturnAddress(urlPaso2);
            });

            var urlOrderConfirmView = $("#iOrderReturnConfirmViewURL").attr('value');
            init_devolucionDomicilio_paso3_ru(urlOrderConfirmView, urlPaso1, urlPaso2, url);

            var priceTotal = loadDetallePedidoDevolverConfirm(orderReturnResponse);
            $("#orderNumber").attr("value",orderReturnResponse.orderId);
            $("#importeSpan").html(formatCurPrice(priceTotal, 2,moneda));
            $("#importe").attr("value",$("#importeSpan").text());

        }
    });
}

/**
 * Muestra/oculta el div para seleccionar un motivo de devolucion
 */
function slideMotivo(element) {
    var initPadding = $("#content_micuenta").css("padding-bottom");
    $('a.accion').not(element).removeClass('activo');
    //$('.devoMotivo').not(element.next()).slideUp();
    element.next().css({
        'top' : element.position().top + $('#large_modal').scrollTop() + element.height() + 3
    });
    element.toggleClass('activo');
    //element.next().slideToggle();

    element.next().slideToggle(function(){
        //$("#scrollable").jScrollPane();
        var desplegable_max_y = $(this).outerHeight() + $(this).position().top;
        var content_max_y = $('#content_micuenta').outerHeight() + $('#content_micuenta').position().top;
        var dif = desplegable_max_y - content_max_y ;
        console.log('desplegable max_y -> '+ desplegable_max_y);
        console.log('content max_y -> '+ content_max_y);
        console.log('dif -> '+ dif);

        if(dif > 0){
            $('#content_micuenta').css('padding-bottom' , (parseInt(initPadding) + dif));
            console.log('add padding -> '+ (parseInt(initPadding) + dif));
            $("#scrollable").jScrollPane();
        }else{
            $('#content_micuenta').css('padding-bottom' , (parseInt(initPadding)));
            console.log('remove padding -> '+ (parseInt(initPadding)) );
            $("#scrollable").jScrollPane();
        }
    });

}

/**
 * Metodo que aade efectos al select multidrop del mi cuenta
 */
function selectBindsCuenta(selectWidth, units, selectInnerWidth) {

    if(isIPad()){
        //$("select").width('175px');
        $("select").css({'font-size':'12px'});
    }
    else{
        $('.multidrop').not('.loaded').each(function() {
            $(this).css({
                'visibility' : 'hidden',
                'position' : 'absolute'
            });
            //Se aade la clase loaded para marcarlo como cargado
            $(this).addClass('loaded');
            var md_name = 'multidrop-' + $(this).attr('title');
            $('<div/>', {
                'id' : 'multidrop-' + $(this).attr('title'),
                'class' : 'md-multidrop ' + $(this).attr('class'),
                'style' : (selectWidth != null && units == '%') ? 'width: ' + selectWidth + '%;' : ''
            }).insertAfter($(this));
            var md_obj = $('#multidrop-' + $(this).attr('title'))
            //Se buscan los selects
            $(this).children('select').each(function() {
                var name = $(this).attr('title');
                $('<div/>', {
                    'id' : 'select-' + name,
                    'class' : 'md-select',
                    'style' : (selectWidth != null && units == '%') ? 'width: 100%;' : ''
                }).appendTo(md_obj);
                $('<div/>', {
                    'id' : 'select-inner-' + name,
                    'class' : 'md-select-inner',
                    'style' : 'width: ' + selectInnerWidth
                }).appendTo($('#select-' + name));
                $('<div/>', {
                    'id' : 'select-inner-name-' + name,
                    'class' : 'md-select-inner-title',
                    'html' : name
                }).appendTo($('#select-inner-' + name));
                $('<ul/>', {
                    'id' : 'select-ul-' + name,
                    'class' : 'md-select-ul'
                }).appendTo($('#select-' + name));
                //Para cada option sde genera un li
                $(this).children('option').each(function() {
                    $('<li/>', {
                        'class' : 'md-select-ul-li',
                        'html' : $(this).html(),
                        'v' : $(this).attr('value'),
                        's' : name
                    }).appendTo($('#select-ul-' + name));
                })
            })
            $('<br/>', {
                'class' : 'clearf'
            }).appendTo(md_obj);
            md_obj.find('.md-select:first').addClass('first');
            md_obj.find('.md-select:last').addClass('last');
        })

        $('.md-select').bind('click', function() {
            over = true;
            open_select($(this));

        })
        $('.md-select').find('div#enclosing-provincia').bind('mouseleave', function() {
            var obj = $(this).parent();
            over = false;
            $(this).stop(true,true).slideUp('slow', function() {
                obj.removeClass('active');
                obj.removeClass('slided');
                folding = false;
            });
        })

        $('.md-select-ul-li').bind('click', function() {
            var v = $(this).attr('v');
            var s = $(this).attr('s');
            $('select[title=' + s + ']').val(v);
            $('select[title=' + s + ']').change();
            $('select[title=' + s + ']').click();
            $('#select-inner-name-' + s).html($(this).html());
        })
    }
}

function removePaddingContent() {
    $('#content_micuenta').addClass('sinPadding');
}

function setCSSPaddingContent() {
    $('#content_micuenta').removeClass('sinPadding');
}

/**
 * Metodo que carga datos del json de Resumen de pedido
 */
function loadResumen(url) {
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSON(respHtml);
            $("#numeroDetallePedido").html(dataJSON.resumenPedido.orderId);
            $("#estadoDetallePedido").html(dataJSON.detallePedido.state);
            $("#fechaEstDetallePedido").html(dataJSON.resumenPedido.estDate+ '*');
            $("#fechaDetallePedido").html(dataJSON.resumenPedido.date);
            if (!!dataJSON.resumenPedido.url) {
                $("#trackingPedidoUrl").attr("href",dataJSON.resumenPedido.url);
            } else {
                $("#trackingPedidoUrl").attr("href","javascript:void(0)");
            }
            $("#trackingDetallePedido").html(dataJSON.resumenPedido.tracking);
            $("#envioDetallePedido").html(dataJSON.resumenPedido.shipMode);
            $("#transporteDetallePedido").html(dataJSON.resumenPedido.courier);
            loadMigaDePan(dataJSON);
            loadDireccionEnvio(dataJSON.shippingAddress);
            loadDireccionFacturacion(dataJSON.billingAddress);
            /* si es TR Virtual se oculta */
            if (dataJSON.detallePedido.isTRVirtual == "true"){
                $("#detalle_pedido").find('td.ocultable').hide();
            }
            loadDetallePedido(dataJSON.detallePedido);

            //le doy tiempo a que pinte todo.
            setTimeout(function() {
                //para ajustar el scroll.
                setScroll();
            }, 500);
        }
    });
}

/**
 *
 */
function loadMigaDePan(dataJSON) {

    if (dataJSON.detallePedido.status == 'X' || dataJSON.detallePedido.status == 'N') {
        var template = '<div class="error">'+ItxMyAccountOrderRequestedDetailsView.order.cancel.message+'</div>';
        $("#pasos.pedido").html(template);
    } else if (dataJSON.detallePedido.shippingModeTypeId == 2) {
        // Tipo de envio MAIL para tarjeta regalo virtual
        var template =
                '<ul>'+
                '<li class="paso1 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.process+'</a><br></li>' +
                '<li class="paso2 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.charged+'</a><br></li>'+
                '<li class="paso3 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.delivered+'</a><br></li>'+
                '</ul>'
            ;

        $("#pasos.pedido").html(template);

        switch(dataJSON.detallePedido.status) {
            case 'F':
            case 'A':
            case 'L':
            case 'E':
            case 'M':
                $("#pasos.pedido .paso1").addClass('active');
                break;
            case 'R':
            case 'S':
                $("#pasos.pedido .paso1").addClass('active');
                $("#pasos.pedido .paso2").addClass('active');
                break;
            case 'D':
                $("#pasos.pedido .paso1").addClass('active');
                $("#pasos.pedido .paso2").addClass('active');
                $("#pasos.pedido .paso3").addClass('active');
                break;
        }

        $('#pasos.pedido ul').css({'width' : $('#pasos.pedido ul li').width() * $('#pasos.pedido ul li').length});

    } else {

        var paso4text = ItxMyAccountOrderRequestedDetailsView.order.delivered;
        if (dataJSON.detallePedido.status == 'O')
            paso4text = ItxMyAccountOrderRequestedDetailsView.order.halfdelivered

        var template =
                '<ul>'+
                '<li class="paso1 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.process+'</a><br></li>' +
                '<li class="paso2 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.charged+'</a><br></li>'+
                '<li class="paso3 detalle"><a style="padding-top:0" href="javascript:void(0)">'+ItxMyAccountOrderRequestedDetailsView.order.transport+'</a><br></li>'+
                '<li class="paso4 detalle"><a style="padding-top:0" href="javascript:void(0)">'+paso4text+'</a><br></li>' +
                '</ul>'
            ;

        $("div.ms").show();
        $("#pasos.pedido").html(template);

        switch(dataJSON.detallePedido.status) {
            case 'F':
            case 'A':
            case 'L':
            case 'E':
            case 'M':
            case 'G':
                $("#pasos.pedido .paso1").addClass('active');
                break;
            case 'R':
            case 'S':
                $("#pasos.pedido .paso1").addClass('active');
                $("#pasos.pedido .paso2").addClass('active');
                break;
            case 'D':
                $("#pasos.pedido .paso1").addClass('active');
                $("#pasos.pedido .paso2").addClass('active');
                $("#pasos.pedido .paso3").addClass('active');
                break;
            case 'K':
            case 'U':
            case 'O':
                $("#pasos.pedido .paso1").addClass('active');
                $("#pasos.pedido .paso2").addClass('active');
                $("#pasos.pedido .paso3").addClass('active');
                $("#pasos.pedido .paso4").addClass('active');
                break;
        }

        $('#pasos.pedido ul').css({'width' : $('#pasos.pedido ul li').width() * $('#pasos.pedido ul li').length});
    }
}

/**
 * Metodo que carga datos del json de Direccion de envio
 */
function loadDireccionEnvio(data) {
    loadAddress(data, 'shippingAddressDetalle');
    setScroll();
}

/**
 * Metodo que carga datos del json de Direccion de facturacion
 */
function loadDireccionFacturacion(data) {
    loadAddress(data, 'billingAddressDetalle');
    setScroll();
}

/**
 * Metodo que carga datos del json de Detalle de pedido
 */
function loadDetallePedido(data) {
    var contenido = '';
    lista = data.listItems;
    contenido = '<tr class="nom">' + '<td colspan="2"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_order + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_color + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_quantity + '</p></td>' + '<td style="width:100px;"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_total + '</p></td>' + '</tr>';
    for( i = 0; i < lista.length; i++) {
        producto = lista[i];
        contenido += '<tr>' + '<td id="image">' + '  <img src="' + producto.image + '" width="70px" />' + '</td>' + '<td>' + '	<p>' + producto.description + '</p>' + '    <span>Ref. ' + producto.reference + '</span>' + '</td>' + '<td class="center">' + '	<p>' + producto.cutColorName + '</p>' + '</td>' + '<td class="center">' + ' 	<p>' + producto.size + '</p>' + ' </td>' + '<td class="center">' + '	<p>' + formatNumber(producto.quantity, 0) + '</p>' + '</td>' + '<td class="right">' + ' 	<p>' + formatCurPrice(producto.unitPrice * producto.quantity, data.decimals,moneda) + '</p>' + ' </td>' + '</tr>';
    }
    contenido += '<tr class="noborde sepTopMin">' + '<td colspan="5" class="right"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_footer_subtotal + '</p></td>' + '<td class="right juanss"><p><strong id="totalArticlesPrice" sinFormato="' + data.totalProductPrice + '">' + formatCurPrice(data.totalProductPrice, data.decimals,moneda) + '</strong></p></td>' + '</tr>' ;

    if(data.isGift === "true"){
        contenido +='<tr class="noborde antesDesc">'+
            '<td colspan="5" class="right"><p id="giftPriceDesc">'+Messages.ItxMyAccountOrderRequestedDetailsView_gift_packing+'</p></td>'+
            '<td class="right"><p><strong id="giftPriceAmount" sinFormato=" '+ data.giftPrice+'">'+ formatCurPrice(data.giftPrice,data.decimals,moneda) +'</strong></p></td>'+
            '</tr>';
    }

    if(data.isStoreTaxesIncluded == '0' && data.productTaxes != '-1'){

        if (data.tipoDesgloseImpuestos=='1') {

            contenido += '<tr class="noborde antesDesc miCuenta">' +
                '<td colspan="5" class="right"><p>'+
                Messages.ItxMyAccountOrderRequestedDetailsView_order_footer_impuestos +
                '</p></td>' +
                '<td class="right"><p><strong id="impuestos" sinFormato="' + data.productTaxes + '"> <strong id="shippingPrice">' +
                formatCurPrice(data.productTaxes, 2,moneda) +
                '</strong></p></td>' +
                '</tr>';
        }


        if (data.tipoDesgloseImpuestos=='2') {

            for (var j=0;j < data.invoiceVatDetailsData.length; j++) {

                t=data.invoiceVatDetailsData[j].invoiceVatDataVatType+' '+ formatCurPercent(data.invoiceVatDetailsData[j].invoiceVatDataVatRate,2);
                contenido +='<tr class="noborde">'+
                    '<td colspan="5" class="right"><p>'+t+'</p></td>'+
                    '<td class="right"><p><strong sinFormato="' + data.invoiceVatDetailsData[j].taxes + '">'+ formatCurPrice(data.invoiceVatDetailsData[j].taxes,data.decimals,moneda) +'</strong></p></td>'+
                    '</tr>';
            }

            contenido +='<tr class="noborde">'+
                '<td colspan="5" class="right"><p>'+getMessage("impuestosTotalArticulos")+'</p></td>'+
                '<td class="right"><p><strong id="totalArticlesSalesTax" sinFormato="' + data.productTaxes + '">'+ formatCurPrice(data.productTaxes,data.decimals,moneda) +'</strong></p></td>'+
                '</tr>';
        }

    }

    contenido += '<tr class="noborde antesDesc miCuenta">' + '<td colspan="5" class="right"><p>' + data.shippingMode + '</p></td>' + '<td class="right"><p><strong id="shippingPrice">' + formatCurPrice(data.shippingPrice, data.decimals,moneda) + '</strong></p></td>' + '</tr>';

    $.each(data.discounts, function(l, discount) {
        //$('#cuerpoTablaDetalle').append('<tr descuento="-1.5" class="noborde descuento descuentoFirst descuentoLast"><td colspan="5" class="right"><p>DESCUENTO DEL 2%</p></td><td class="right"><p><strong>-1<span class="decimal">,50</span>&nbsp;&nbsp;</strong></p></td></tr>');
        if(l == 0) {
            contenido +='<tr class="noborde descuento descuentoFirst">' + '<td colspan="5" class="right"><p>' + discount.description + '</p></td>' + '<td class="right"><p><strong id="shippingPrice">' + formatCurPrice(discount.amount, data.decimals,moneda) + '</strong></p></td>' + '</tr>';
        } else {
            if(l == data.discounts.length-1) {
                contenido +='<tr class="noborde descuento descuentoLast">' + '<td colspan="5" class="right"><p>' + discount.description + '</p></td>' + '<td class="right"><p><strong id="shippingPrice">' + formatCurPrice(discount.amount, data.decimals,moneda) + '</strong></p></td>' + '</tr>';
            } else {
                contenido +='<tr class="noborde descuento">' + '<td colspan="5" class="right"><p>' + discount.description + '</p></td>' + '<td class="right"><p><strong id="shippingPrice">' + formatCurPrice(discount.amount, data.decimals,moneda) + '</strong></p></td>' + '</tr>';
            }
        }
    });

    $("#cuerpoTablaDetalle").html(contenido);
    $("#totalPriceDetalle").html(formatCurPrice(data.totalPrice, data.decimals,moneda));
    $("#totalPriceDetalle span.decimal").addClass('white');
    $('#estadoDetallePedido').html(data.state);
    $(".miCuentaPrincipal").hide();
    $(".miCuentaAux").show();
    setScroll();
}


function cerrarMotivos(obj){
    $(obj).parent().slideUp();
    $('a.accion').removeClass("activo");

}

/**
 * Metodo que carga datos del json de Detalle de pedido
 */
function loadDetallePedidoDevolver(data) {
    var contenido = '';
    lista = data.listItems;
    listaReason = data.reasonReturn;


    for( i = 0; i < lista.length; i++) {
        var reason = '';
        var quantity  = "0";
        producto = lista[i];

        //Si nos ha pulsado la opcion 1, hay que poner como lo teniamos.
        var lsOrderReturnResponse = orderReturnResponse.listItems;
        for( j = 0; j < lsOrderReturnResponse.length; j++) {
            productoResponse = lsOrderReturnResponse[i];
            if (producto.orderItemId == productoResponse.orderItemId) {
                quantity = productoResponse.quantity;
            }
        }

        /*A?adimos una columna mas*/

        $('.articulosdevolver1').find('tr').append('<th class="thbot">&nbsp;</th>')

        for( m = 0; m < listaReason.length; m++) {
            reason += '<li><input type="radio" name="motivo_'+j+'" id="'+listaReason[m].option+'" style="display: none;">'
                + '<label>'+ listaReason[m].reason +'</label><br style="clear:both"></li>';
        }


        contenido += '<tr id="' + producto.orderItemId + '">'
            + '<td id="image">' + '  <img src="' + producto.image + '"  width="70px" />' + '</td>'
            + '<td id="desc" class="left">' + '	<p>' + producto.description + '</p>' + '    <span>Ref. ' + producto.reference + '</span>' + '</td>'
            + '<td id="cutColorName">' + '	<p>' + producto.cutColorName + '</p>' + '</td>'
            + '<td id="size" class="center">' + ' 	<p>' + producto.size + '</p>' + ' </td>'
            + '<td><div class="contadores"><img class="menos" src="' + DUTTI_STATIC_CONTENT_PATH + '/img/ico_menos.png"><input id="' +producto.quantity + '" class="quantity" type="text" value="'+ quantity + '" readonly="true"/><img class="mas" src="' + DUTTI_STATIC_CONTENT_PATH + '/img/ico_mas.png"></div></td>'
            + '<td id="unitPrice">' + '<p id="' + producto.unitPrice+ '">' + formatCurPrice(producto.unitPrice * producto.quantity, 2,moneda) + '</p>' + ' </td>'
            + '<td id="reasonReturn" class="right"><div class="boton4"  style="display:none"><a class="accion" onclick="slideMotivo($(this))" href="javascript:void(0)">'+Messages.elegirMotivo+'</a>'
            + '<span class="devoMotivo"><a class="close" onclick="cerrarMotivos(this)" href="javascript:void(0);">&nbsp;</a>'
            + '<span class="devoCont"><ul class="opt_check">'
            + reason +'</ul></span></span></div></td>'
            + '</tr>';
    }
    //quantity

    //Borro los orderItems seleccionados la ultima vez ya que se van a elegir otros.
    orderReturnResponse.listItems = new Array();

    $("#tablaPedidos").html(contenido);
}

/**
 * Metodo que carga datos del json de Detalle de pedido
 */
function loadDetallePedidoDevolverConfirm(data) {
    var contenido = '';
    lista = data.listItems;
    var priceTotal = 0;

    for( i = 0; i < lista.length; i++) {
        producto = lista[i];
        contenido += '<tr id="' + producto.orderItemId + '">'
            + '<td id="image">' + '  <img src="' + producto.image + '"  width="70px" />' + '</td>'
            + '<td id="desc" class="left">' + '	<p>' + producto.description + '</p>' + '    <span>Ref. ' + producto.reference + '</span>' + '</td>'
            + '<td id="cutColorName">' + '	<p>' + producto.cutColorName + '</p>' + '</td>'
            + '<td id="size" class="center">' + ' 	<p>' + producto.size + '</p>' + ' </td>'
            + '<td id="quantity"><p>' + producto.quantity + '</p></td>'
            + '<td id="unitPrice">' + '<p id="' + producto.unitPrice+ '">' + formatCurPrice(producto.unitPrice * producto.quantity, 2,moneda) + '</p>' + ' </td>'
            + '</tr>';
        //Hacemos la suma de todos los productos a devolver.
        priceTotal =  priceTotal + (producto.unitPrice * producto.quantity);
    }

    $("#tablaPedidos").html(contenido);
    return priceTotal;
}

/**
 * Metodo que carga datos de la pagina de confirmacion de la devolucion
 */
function loadDataOrderReturnConfirm() {

    $('span[id=\"orderData\"]').text(orderReturnResponse.dateOrder);
    $('span[id=\"orderId\"]').text(orderReturnResponse.orderId)
    $('span[id=\"numCaja\"]').text(orderReturnResponse.address.numcaj);

    var priceTotal = loadDetallePedidoDevolverConfirm(orderReturnResponse);
    $('span[id=\"totalDevolucion\"]').html(formatCurPrice(priceTotal, 2,moneda));//formatCurPrice(priceTotal, 2)

    $('span[id=\"name\"]').text(orderReturnResponse.address.firstName + ' ' + ((Inditex.iStoreJSON.details.isMiddleName && orderReturnResponse.address.middleName != null && orderReturnResponse.address.middleName != '') ? (orderReturnResponse.address.middleName + ' ') : '') + orderReturnResponse.address.lastName);
    $('span[id=\"address\"]').text(orderReturnResponse.address.street + ' ' + orderReturnResponse.address.street2);
    $('span[id=\"state\"]').text(orderReturnResponse.address.zipCode + ' ' + orderReturnResponse.address.state);
    $('span[id=\"country\"]').text(orderReturnResponse.address.country);
    $('span[id=\"phono\"]').text(orderReturnResponse.address.phone1);
    if($('span[id=\"colonia-municipio\"]')&&$('span[id=\"colonia-municipio\"]').length>0){
        $('span[id=\"colonia-municipio\"]').text(orderReturnResponse.address.colony+" "+orderReturnResponse.address.municipality);
    }
}


/**
 * Carga la pgina de detalle y comienza la secuencia
 *  de carga de los JSON del detalle
 */
function loadDetallePedidoPage(url) {

    Inditex.trackEvent( "Mi_cuenta","Pedidos_realizados_ver_detalle",null,true);
    //Cargo la pagina de detalle del pedido.
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            // 0. Cargo el html de la pagina de detalle
            $("#content_aux").html(respHtml);

            // 1. Cargo los datos del pedido mediante un JSON
            var urlOrderRequestedDetailsJSON = $("#iOrderRequestedDetailsJSONURL").attr('value');
            loadResumen(urlOrderRequestedDetailsJSON);

            // 2. Pongo aqui esto porque creo que es mas correcto.
            // 2.1 -- Pongo el  javascript de volver para cerrar el detalle.
            $(".volverPedidosRealizados").click(function(){
                hideContentAux();
            });

            // 2.2 -- Oculto los pedidos realizados y muestro el detalle del pedido.
            $(".miCuentaPrincipal").hide();
            $(".miCuentaAux").show();
        }
    });

}

/**
 * Carga los datos de direccion de un json dentro
 *  de un elemento html concreto
 */
function loadAddress(data, id) {

    if(data.type == 'individual' || data.type == 'particular') {
        $("#" + id).find("[name=nombre]").replaceWith('<p name="nombre">' + escapeHtml(data.firstName) + (Inditex.checkMiddleName(data.middleName) ? ' '+escapeHtml(data.middleName):'') + ' ' + escapeHtml(data.lastName) + '</p>');
    } else {
        $("#" + id).find("[name=nombre]").replaceWith('<p name="nombre">' + escapeHtml(data.nameCompany) + '</p>');
    }

    $("#" + id).find("[name=direccion]").replaceWith('<p name="direccion">' + escapeHtml(data.street) + ' ' + escapeHtml(data.street2) + ' ' + escapeHtml(data.city) + '</p>');

    $("#" + id).find("[name=cp]").replaceWith('<p name="cp">' + data.zipCode + '</p>');
    if (data.state!=null)
        $("#" + id).find("[name=ciudad]").replaceWith('<p name="ciudad">' + data.state + '</p>');
    else
        $("#" + id).find("[name=ciudad]").attr ('style','display:none;');
    $("#" + id).find("[name=pais]").replaceWith('<p name="pais">' + data.country + '</p>');
    $("#" + id).find("[name=telefono]").replaceWith('<p name="telefono">' + data.phone1 + '</p>');
}

/**
 * Carga de datos personales del usuario a partir del json
 *  datospersonales.json
 */
function loadDatosPersonales(url) {
    jQuery.xajax({
        url: url,
        dataType: 'json',
        success: function(data) {

            var form = null;

            form = $('#datosPersonalesForm');
            //suponemos que la fecha ya viene en formato dd/mm/aaaa
            writeDate(form.find('#fechaNacimiento'),data.date);
            form.find('#cp').val(data.zipCode);
            $("#radio_tipoDatosPersonales_persona").addClass('active');
            changeCustomSelect(form.find('#select-ul-Provincia li[v=' + data.state + ']'), form);
            if(data.gender == "M") {
                form.find('#radio_r_men').click();
            } else if(data.gender == "F") {
                form.find('#radio_r_women').click();
            }

            form.find('#nif').val(data.nif);
            form.find('#empresa').val(data.nameCompany);
            form.find('#nombre').val(data.firstName);
            if(Inditex.checkMiddleName(data.middleName)) {
                form.find('#middleName').val(data.middleName);
            }
            form.find('#apellido').val(data.lastName);
            form.find('#direccion').val(data.street);
            form.find('#direccion2').val(data.street2);
            form.find('#localidad').val(data.city);
            //suponemos que el formato del telefono es prefijo_espacio_numero
            if (data.phone1 != null && data.phone1 != undefined){
                form.find('#prefijo').val(data.phone1.split(" ")[0]);
                form.find('#telefono').val(data.phone1.split(" ")[1]);
            }
            if (data.phone2 != null && data.phone2 != undefined){
                form.find('#prefijo2').val(data.phone2.split(" ")[0]);
                form.find('#telefono2').val(data.phone2.split(" ")[1]);
            }

            if(form.find('#colony')&&form.find('#colony').length>0){
                form.find('#colony').val(data.colony);
            }

            if(form.find('#municipality')&&form.find('#municipality').length>0){
                form.find('#municipality').val(data.municipality);
            }
            if(form.find('#newsletter')&&form.find('#newsletter').length>0){
                if(data.sectionNewsletter){
                    form.find('#newsletter').attr("checked",true);
                }
            }

            if ($('input[name="newsletter"]').is(':checked')) {
                $('#check_newsletter').addClass('active');
            } else {
                $('#check_newsletter').removeClass('active');
            }
            setScroll();
        }
    });
}


/** ponemos en el popup los datos personales si es una persona el usuario registrado */
function cambioDatosPersonalesParticular() {
    var formPersona = $('#datosPersonalesForm');
    var formEmpresa = $('#datosEmpresaForm');
    //suponemos que la fecha ya viene en formato dd/mm/aaaa
    formPersona.find('#fechaNacimiento').val(formEmpresa.find('#fechaNacimiento2').val());
    formPersona.find('#cp').val(formEmpresa.find('#cp2').val());
    var state = formEmpresa.find('#provincia2').val();
    changeCustomSelect(formPersona.find('#select-ul-Provincia li[v=' + state + ']'), formPersona);
    //$("input[name=tipoDatosPersonales]:checked")
    if (formEmpresa.find('#radio_r_men2').hasClass('active')) {
        formPersona.find('#radio_r_men').click();
    } else {
        formPersona.find('#radio_r_women').click();
    }

    formPersona.find('#nombre').val(formEmpresa.find('#nombre').val());
    formPersona.find('#apellido').val(formEmpresa.find('#apellido').val());
    formPersona.find('#direccion').val(formEmpresa.find('#direccion').val());
    formPersona.find('#direccion2').val(formEmpresa.find('#direccion2').val());
    formPersona.find('#localidad').val(formEmpresa.find('#localidad').val());

    formPersona.find('#prefijo').val(formEmpresa.find('#prefijo').val());
    formPersona.find('#telefono').val(formEmpresa.find('#telefono').val());

    formPersona.find('#prefijo2').val(formEmpresa.find('#prefijo2').val());
    formPersona.find('#telefono2').val(formEmpresa.find('#telefono2').val());

    $("#datosEmpresaDiv").hide();
    $("#datosPersonalesDiv").show();
}

/** ponemos en el popup los datos personales si es una empresa el usuario registrado */
function cambioDatosPersonalesEmpresa() {
    var formPersona = $('#datosPersonalesForm');
    var formEmpresa = $('#datosEmpresaForm');
    formEmpresa.find('#fechaNacimiento2').val(formPersona.find('#fechaNacimiento').val());
    formEmpresa.find('#cp2').val(formPersona.find('#cp').val());
    var state = formPersona.find('#provincia').val();
    changeCustomSelect(formEmpresa.find('#select-ul-provincia li[v=' + state + ']'), formEmpresa);
    if (formPersona.find('#radio_r_men').hasClass('active')) {
        formEmpresa.find('#radio_r_men2').click();
    } else {
        formEmpresa.find('#radio_r_women2').click();
    }

    formEmpresa.find('#nombre').val(formPersona.find('#nombre').val());
    formEmpresa.find('#apellido').val(formPersona.find('#apellido').val());
    formEmpresa.find('#direccion').val(formPersona.find('#direccion').val());
    formEmpresa.find('#direccion2').val(formPersona.find('#direccion2').val());
    formEmpresa.find('#localidad').val(formPersona.find('#localidad').val());

    formEmpresa.find('#prefijo').val(formPersona.find('#prefijo').val());
    formEmpresa.find('#telefono').val(formPersona.find('#telefono').val());


    formEmpresa.find('#prefijo2').val(formPersona.find('#prefijo2').val());
    formEmpresa.find('#telefono2').val(formPersona.find('#telefono2').val());

    $("#datosPersonalesDiv").hide();
    $("#datosEmpresaDiv").show();
}



/**
 * Carga de datos personales del usuario para la devolucion de un pedido.
 * Hago esto porque los id del los inputs son diferente a  los que hay en
 * datos personales de mi cuenta
 */
function loadDatosPersonalesOrderReturn(data) {
    var form = $('#devoForm');
    var numCajas = '';

    //Si en este campo tenemos algo, esto siginfica que ya hemos puesto datos en el direccion de
    //recogida y por lo tantos seguimos mostrando estos datos.
    if (orderReturnResponse.address.firstName != "null") {
        data = orderReturnResponse.address;
        //OJO tengo cambiar el contendio de state por stateISO
        data.state = orderReturnResponse.address.stateISO;
        //OJO si ya he editdos los datos he puesto el numero de cajas
        numCajas = data.numcaj;
    }




    form.find('#inpname').val(data.firstName);
    if (Inditex.iStoreJSON.details.isMiddleName) {
        form.find('#inpmiddlename').val(data.middleName);
    }
    form.find('#inpapellid').val(data.lastName);
    form.find('#inpdirec').val(data.street);
    form.find('#inpdirec2').val(data.street2);
    form.find('#inplocal').val(data.city);
    form.find('#inpcp').val(data.zipCode);
    changeCustomSelect(form.find('#select-ul-provincia li[v=' + data.state + ']'), form);

    //suponemos que el formato del telefono es prefijo_espacio_numero
    form.find('#inpprefijo').val(data.phone1.split(" ")[0]);
    form.find('#inpmovil').val(data.phone1.split(" ")[1]);
    if (data.phone2 != null && data.phone2 != '') {
        form.find('#inpprefijo2').val(data.phone2.split(" ")[0]);
        form.find('#inptlfn').val(data.phone2.split(" ")[1]);
    }
    if(form.find('#colony')&&form.find('#colony').length>0){
        form.find('#colony').val(data.colony);
    }
    if(form.find('#municipality')&&form.find('#municipality').length>0){
        form.find('#municipality').val(data.municipality);
    }

    form.find('#inpnumcaj').val(numCajas);

}


/**
 * Carga las direcciones del usuario
 */
function loadDirecciones(url) {

    jQuery.xajax({
        url: url,
        dataType: 'json',
        success: function(data) {


            var direccionForm = $("#direccionForm");
            var form = null;
            lista = data.contacts;
            direcciones = '';
            // Si el usuario es wallet, la primera direccion la obviamos ya que es la de facturacion.
            var i;
            var isWalletUser = Inditex._readUserJSON().isWalletUser;
            if (isWalletUser) {
                i = 1;
            }
            else {
                i = 0;
            }
            for(i;i<lista.length;i++){
                element=lista[i];

                if (element.fax2 != 'DP' && element.fax2 != 'DB') {
                    direcciones +=
                        '<tr>' +
                        '<td>' +
                            /*'<a class="cruz" href="javascript:void(0)">&nbsp;</a>' +*/
                        '<a class="cruz" href="javascript:void(0)" onclick="cargarDireccionModal(\'' + escape(JSON.stringify(element)) + '\')">&nbsp;</a>' +
                        '</td>' +
                        '<td>' +
                        '<p>' + ((element.type == 'particular')?escapeHtml(element.firstName) + ' ' + (Inditex.checkMiddleName(element.middleName)?escapeHtml(element.middleName):"") + ' ' + escapeHtml(element.lastName) :escapeHtml(element.nameCompany)) + '</p>' +
                        '</td>' +
                        '<td>' +
                        '<p>' + escapeHtml(element.addressName) + '</p>' +
                        '</td>' +
                        '<td>' +
                        '<p>' + escapeHtml(element.address1) + '</p>' +
                        '</td>' +
                        '<td class="center">' +
                        '<p>' + element.phone1 + '</p>' +
                        '</td>' +
                        '<td class="right">' +
                        '<a class="accion modificarDireccion typeUpdate" id="' + element.contactId + '" onclick="dForm.resetForm();showModalDireccion(this,\'' + escape(JSON.stringify(element)) + '\' );" href="javascript:void(0)">'+Messages.updateAddress+'</a>' +
                        '</td>' +
                        '</tr>';
                }

                //Hay que hacer aqu? la carga din?mica del input porque al querer eliminar una direcci?n no se carga el formulario
                if ($("#direccionForm").find("#addressId").length == 0) {
                    if (element != null){
                        var inputAddreesId = '<input type="hidden" name="addressId" id="addressId" value="'+element.addressId+'"/>';
                        $("#direccionForm").append('<input type="hidden" name="addressId" id="addressId" value="'+element.addressId+'"/>');
                    }
                } else {
                    $("#direccionForm").find("#addressId").attr('value',element!= null?element.addressId:'');
                }

            }

            direcciones +=
                '<tr class="noborde">'+
                '<td colspan="5">&nbsp;</td>'+
                '<td class="right">'+
                '<a class="accion modificarDireccion typeAdd" onclick="dForm.resetForm();cargarDireccionModal(null);showModalDireccion(this);" href="javascript:void(0)">'+Messages.addAddress+'</a>'+
                '</td>'+
                '</tr>';

            $("#datosEnvioDireccion").html(direcciones);

            selectBinds(93,'%');

            $('.typeUpdate').click(function() {
                $('.typeAdd').removeClass('add');
                $('.typeUpdate').addClass('update');

            });

            $('.typeAdd').click(function() {
                $('.typeUpdate').removeClass('update');
                $('.typeAdd').addClass('add');

            });

            $(".cruz").click(function() {
                $('.typeAdd').removeClass('add');
                $('.typeUpdate').removeClass('update');

                var form = $("#direccionForm");
                var action = $("#deleteURL").attr("value");
                form.attr('action',action);

                Inditex.orderManage({
                    customRequest: jQuery.xajax,
                    url: form.attr("action"),
                    type: 'post',
                    data: form.serialize(),
                    success: function(respHtml) {
                        var data = getResponseJSON(respHtml);
                        if (data.status > 0) {
                            if (Inditex)
                                Inditex.trackPage("Mi_Cuenta/Direcciones/Eliminar_Direccion/Envio_OK");
                            //openStaticModal(Messages.titleDataSend, Messages.msgDataSend, true);
                            var url = $("#datosEnvioJSON").attr("value");
                            loadDirecciones(url);
                        } else {
                            if (Inditex)
                                Inditex.trackPage("Mi_Cuenta/Direcciones/Eliminar_Direccion/Envio_Error_" + data.type);
                            openStaticModal(data.title, data.message, true);
                        }
                    }
                });

                $(this).parent().parent().remove();

            });

            $("#close_dir").click(function() {
                $('#dir_mod').slideUp();
            });
            dForm = $(direccionForm).validate({
                submitHandler : function(form) {
                    var form = $("#direccionForm");

                    var iLogicChunk = "/Mi_Cuenta/Direcciones";
                    var iAccion = "";

                    if ($('.typeAdd').hasClass('add')){
                        $('.typeAdd').removeClass('add');
                        var action = $("#addURL").attr("value");
                        form.attr('action',action);

                        iLogicChunk += "/Nueva_Direccion";

                        $("#direccionForm").find("#addressId").remove();

                        //Inditex.trackEvent( "Mi_cuenta","aadir_nueva_direccin",null,true);
                        iAccion = "anadir_nueva_direccion";

                    }else if($(".typeUpdate").hasClass('update')){
                        $(".typeUpdate").removeClass('update');
                        var action = $("#updateURL").attr("value");
                        form.attr('action',action);

                        iLogicChunk += "/Editar_Direccion";

                        //Inditex.trackEvent( "Mi_cuenta","modificar_datos_envio",null,true);
                        iAccion = "modificar_datos_envio";
                    }

                    $("#direccionForm #guardarDireccionBtn #butt").removeAttr("onclick");

                    Inditex.orderManage({
                        customRequest: jQuery.xajax,
                        url: form.attr("action"),
                        type: 'post',
                        data: form.serialize(),
                        success: function(respHtml) {
                            var data = getResponseJSON(respHtml);
                            //openStaticModal(Messages.titleDataSend, Messages.msgDataSend, true);

                            if (data.status > 0) {
                                if (Inditex) {
                                    Inditex.trackPage(iLogicChunk +"/Envio_OK");
                                    Inditex.trackEvent( "Mi_cuenta",iAccion+"_ok",null,true);
                                }
                                openStaticModal(Messages.titleDataSend, Messages.msgDataSend, true);
                            } else {
                                if (Inditex) {
                                    Inditex.trackPage(iLogicChunk +"/Envio_Error_" + data.type);
                                    Inditex.trackEvent( "Mi_cuenta",iAccion+"_error",Inditex.codeError(data.key,data.errorMessage),true);
                                }

                                if(!data.message){
                                    openStaticModal(data.title, data.errorMessage, true);
                                }else{
                                    openStaticModal(data.title, data.message, true);
                                }

                            }
                            setTimeout(function() {
                                $('#dir_mod').slideUp();
                            }, 800);
                            var url = $("#datosEnvioJSON").attr("value");
                            loadDirecciones(url);

                            $("#direccionForm #guardarDireccionBtn #butt").attr("onclick","javascript:enviarFormulario();");
                        }
                    });

                },
                rules : {
                    addressName : "required",
                    firstName : "required",
                    middleName : "required",
                    lastName : "required",
                    address1 : "required",
                    city : "required",
                    zipCode : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
                    phone1Prefix :{
                        validPrefix : true,
                        required : true
                    },
                    phone1 : {
                        required : true,
                        validatePhone : true
                    },
                    phone2 : {
                        validatePhone : true
                    },
                    phone2Prefix :{
                        validPrefix : true
                    },
                    state : "itxSelect",
                    country : "required"
                },
                messages : {
                    addressName : Messages.required,
                    firstName : Messages.required,
                    middleName : Messages.requiredMiddleName,
                    lastName : Messages.required,
                    address1 : Messages.address,
                    city : Messages.required,
                    zipCode : {
                        "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                        "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
                    },
                    apellido : Messages.required,
                    fechaNacimiento : Messages.birthDate,
                    phone1 : {
                        required: Messages.required,
                        validatePhone : eval('Messages.phone_' + iCountry)
                    },
                    phone2 : eval('Messages.phone_' + iCountry),
                    state : Messages.state,
                    country : Messages.country
                }
            });

            if (iCountry == "MX") {
                $("input[name=colony]").rules("add", {
                    required: true,
                    messages: {
                        required: Messages.required
                        //maxlength: "long"
                    }
                });
                $("input[name=municipality]").rules("add", {
                    required: true,
                    messages: {
                        required: Messages.required
                        //maxlength: "long"
                    }
                });
            }

            /*$("#guardarDireccionBtn").click(function() {
             direccionForm.submit();
             });*/
            setCSSPaddingContent();

            setScroll();
        }
    });

}


function cargarDireccionModal(object){

    if(object!=null){
        element = JSON.parse(unescape(object));
        /*if(element.isBillingAddress)
         $("#direccionForm").find("#nombreDireccion").attr('disabled',true);
         else
         $("#direccionForm").find("#nombreDireccion").attr('disabled',false);*/
    }
    else {
        //$("#direccionForm").find("#nombreDireccion").attr('disabled',false);
    }

    $("#direccionForm").find("#nombreDireccion").attr('value',object!= null?element.addressName:'');
    $("#direccionForm").find("#nombre").attr('value',object!= null?element.firstName:'');
    if (Inditex.iStoreJSON.details.isMiddleName) {
        $("#direccionForm").find("#middleName").attr('value',object!= null && Inditex.checkMiddleName(element.middleName)?element.middleName:'');
    }
    $("#direccionForm").find("#apellidos").attr('value',object!= null?element.lastName:'');
    $("#direccionForm").find("#direccion").attr('value',object!= null?element.address1:'');
    $("#direccionForm").find("#direccion2").attr('value',object!= null?element.address2:'');
    $("#direccionForm").find("#localidad").attr('value',object!= null?element.city:'');
    $("#direccionForm").find("#cp").attr('value',object!= null?element.zipCode:'');
    if($("#direccionForm").find("#colony")&&$("#direccionForm").find("#colony").length>0){
        $("#direccionForm").find("#colony").attr('value',object!= null?element.colony:'');
    }
    if($("#direccionForm").find("#municipality")&&$("#direccionForm").find("#municipality").length>0){
        $("#direccionForm").find("#municipality").attr('value',object!= null?element.municipality:'');
    }

    if (object != null){
        changeCustomSelect($("#direccionForm").find('#select-ul-provincia li[v=' + element.state + ']'), $("#direccionForm"));
    } else {
        changeCustomSelect($("#direccionForm").find('#select-ul-provincia li[v=]'), $("#direccionForm"));
    }

    $("#direccionForm").find("#prefijo").attr('value',object!= null?extractPrefix(element.phone1):DUTTI_PREFIX_STORE);
    $("#direccionForm").find("#telefono").attr('value',object!= null?extractPhone(element.phone1):'');
    $("#direccionForm").find("#prefijo2").attr('value',object!= null?extractPrefix(element.phone2):DUTTI_PREFIX_STORE);
    $("#direccionForm").find("#telefono2").attr('value',object!= null?extractPhone(element.phone2):'');

    if ($("#direccionForm").find("#addressId").length == 0) {
        if (object != null){
            var inputAddreesId = '<input type="hidden" name="addressId" id="addressId" value="'+element.contactId+'"/>';
            //$("#direccionForm").html($("#direccionForm").html() + inputAddreesId);
            $("#direccionForm").append('<input type="hidden" name="addressId" id="addressId" value="'+element.contactId+'"/>');
        }
    } else {
        $("#direccionForm").find("#addressId").attr('value',object!= null?element.contactId:'');
    }

}
function showModalDireccion(element, object){
    if(!isIPad()){
        var dirDiv = $('#dir_mod');

        var link = $(element);
        var placeHolder = link.parent();
        var isVisibleDiv = $("#dir_mod:visible").size() == 1;
        // Ocultamos las filas
        $(".modificarDireccion").removeClass("activo");
        if(lastClickedLink != null && lastClickedLink != element && isVisibleDiv){
            if(isVisibleDiv && link.hasClass('typeUpdate')){
                Inditex.trackEvent( "Mi_cuenta","modificar_datos_envio",null,true);
            }
            dirDiv.slideUp(function(){
                cargarDireccionModal(object);
                showModalAux(element,isVisibleDiv);
                sh = $("#content_micuenta").height() - 400 ;
                $("#content_micuenta").height(sh);
                return;
            });
        }
        else {
            cargarDireccionModal(object);
            showModalAux(element,isVisibleDiv);
            if(!isVisibleDiv && link.hasClass('typeUpdate')){
                Inditex.trackEvent( "Mi_cuenta","modificar_datos_envio",null,true);
            }
            Inditex.trackPage( "Mi_Cuenta/Datos_envio/anadir_direcion",true);
        }
    }
    else{
        openGenericModal(direccionIpad,object , cargarCamposDireccionMiCuentaIpad,null,0.8, true);
    }
    jQuery('input[name^=address1]').attr('maxlength',100);
    jQuery('input[name^=address2]').attr('maxlength',50);
}

function showModalAux(element,isVisibleDiv) {
    var dirDiv = $('#dir_mod');
    var link = $(element);
    var placeHolder = link.parent();
    var isVisibleDiv = $("#dir_mod:visible").size() == 1;
    // Si es necesario, mostramos el contenido del form en el sitio correcto
    if(lastClickedLink == null || lastClickedLink != element || !isVisibleDiv) {
        lastClickedLink = element;
        link.addClass('activo');
        //dirDiv.appendTo(placeHolder);
        diferencia = 0;
        if(!isIPad()){
            diferencia = offsetInicial - $(".jspPane").offset().top;
        }
        if($.browser.msie && (parseInt($.browser.version, 10) === 7)){
            $('#dir_mod')[0].style.top = link.parent().offset().top+ diferencia;
        }
        else{
            $('#dir_mod').offset({top: link.parent().offset().top + diferencia});
        }
        dirDiv.slideDown('slow');
        sh = $("#content_micuenta").height() + 400;
        $("#content_micuenta").height(sh);

    } else {
        dirDiv.slideUp();
        sh = $("#content_micuenta").height() - 400 ;
        $("#content_micuenta").height(sh);
    }
    if(!isIPad()){
        setTimeout(function(){
            $("#scrollable").jScrollPane();
        },500);
    }

}

/**
 * Selecciona un elemento de un select customizado
 */
function changeCustomSelect(element, form) {
    var v = $(element).attr('v');
    var s = $(element).attr('s');
    $(form).find('select[title=' + s + ']').val(v);
    $(form).find('select[title=' + s + ']').change();
    $(form).find('#select-inner-name-' + s).html($(element).html());


}

/** Pintamos los pedidos realizados en mi cuenta **/
function paintOrderRequested(orderRequested) {
    var tr = document.createElement("tr");
    var td = null;
    var p = null;

    //td Fecha del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderRequested.date;
    td.appendChild(p);
    tr.appendChild(td);

    // td Id Pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderRequested.id;
    td.appendChild(p);
    tr.appendChild(td);

    // td estado del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderRequested.status;
    td.appendChild(p);
    tr.appendChild(td);

    // td precio del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = formatCurPrice(orderRequested.amount, orderRequested.decimals,moneda);
    td.appendChild(p);
    tr.appendChild(td);

    //Botones de acciones
    td = document.createElement("td");
    td.className = "right";
    var div1 = document.createElement("div");
    div1.className = "boton2";

    //Se hace asi por IExplore es la unica forma que lo interpreta bien.
    var a1text = "<a href=\"javascript:void(0)\" "
        + " onClick=\"loadDetallePedidoPage('" +orderRequested.url.details + "')\" "
        + " class=\"acc_butt verDetalle\">" + Messages.ItxMyAccountOrderRequestedView_order_show_detail + "</a>";
    $(div1).html(a1text);
    td.appendChild(div1);

    if (Inditex.iStoreJSON.details.eInvoiceEnabled&&Inditex.iStoreJSON.details.eInvoiceEnabled!="0"){

        if(orderRequested.eInvoiceStatus){
            var div2 = document.createElement("div");
            div2.className = "boton2 efactura "+orderRequested.eInvoiceStatus;
            div2.setAttribute("data-order",orderRequested.id);
            var msg="";
            var action="javascript:void(0)";
            switch (orderRequested.eInvoiceStatus) {
                case 'request':
                    msg=Messages.ItxMyAccountOrderRequestedView_order_request_ebill;
                    break;
                case 'pending':
                    msg=Messages.ItxMyAccountOrderRequestedView_order_show_ebill;
                    break;
                case 'created':
                    msg=Messages.ItxMyAccountOrderRequestedView_order_show_ebill;
                    if ($.trim(orderRequested.url.bill) != '') {
                        action=orderRequested.url.bill;
                    }
                    break;
                case 'notavailable':
                    msg=Messages.ItxMyAccountOrderRequestedView_order_show_ebill;
                    break;
                default:
                    msg=Messages.ItxMyAccountOrderRequestedView_order_show_ebill;
                    break;

            }
            var a2text = '<a href="'+action+'" class="acc_butt">'
                + msg + '</a>';
            $(div2).html(a2text);
            td.appendChild(div2);
        }

    }
    else if (orderRequested.url.bill != null) {

        var verPdf = $("#verFacturasPdf").attr("value");

        if ($.trim(orderRequested.url.bill) != '') {

            if(verPdf && verPdf == 'true'){
                var div2 = document.createElement("div");
                div2.className = "boton2";
                //Se hace asi por IExplore es la unica forma que lo interpreta bien.
                var a2text = '<a href="' + orderRequested.url.bill + '" class="acc_butt">'
                    + Messages.ItxMyAccountOrderRequestedView_order_show_bill + '</a>';
                $(div2).html(a2text);
                td.appendChild(div2);
            }

        }
    }

    tr.appendChild(td);


    $("#content_micuenta").find("#tablaPedidos").append(tr);
    $("#large_modal").scrollTo(0);
    $(window).resize();

}

/** Pintamos los pedidos para devolver en mi cuenta **/
function paintOrderReturn(orderReturn) {
    var tr = document.createElement("tr");
    var td = null;
    var p = null;

    //td Fecha del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderReturn.date;
    td.appendChild(p);
    tr.appendChild(td);

    // td Id Pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderReturn.id;
    td.appendChild(p);
    tr.appendChild(td);

    // td estado del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderReturn.status;
    td.appendChild(p);
    tr.appendChild(td);

    // td precio del pedido
    td = document.createElement("td");
    p = document.createElement("p");
    p.innerHTML = orderReturn.amount;
    td.appendChild(p);
    tr.appendChild(td);



    //Botones de acciones
    td = document.createElement("td");
    // Si es un pedido con env?o a tienda (isSendShop = true) no creamos el bot?n de DEVOLVER
    if (orderReturn.isSendShop == 'false'){
        td.className = "right";
        var div = document.createElement("div");
        div.className = "boton2";

        //Se hace asi por IExplore es la unica forma que lo interpreta bien.
        var atext = "<a href=\"javascript:void(0)\" "
            +" onClick=\"Inditex.trackEvent( 'Mi_cuenta','Devolucion_devolver','"+ orderReturn.id +"',true);orderReturnResponse.orderId = '"+ orderReturn.id +"';orderReturnResponse.dateOrder = '"+ orderReturn.date+ "';init_devolucionDomicilio_paso1('" +orderReturn.url.details+ "');\" "
            +" class=\"acc_butt verDetalle\">" + Messages.ItxMyAccountOrderReturnView_return + "</a>";
        $(div).html(atext);

        td.appendChild(div);
    }
    tr.appendChild(td);


    $("#content_micuenta").find("#tablaPedidos").append(tr);
    $("#large_modal").scrollTo(0);
    $(window).resize();

}

/** Funcion que no retonar la respuesta de Servidor en un JSON **/
function getResponseJSON(respHtml) {
    var type = typeof respHtml;
    var dataJSON = null;
    if (type == 'string') {
        dataJSON = jQuery.parseJSON(respHtml);
    } else {
        dataJSON = respHtml;
    }
    return dataJSON;
}

function cargarCamposDireccionMiCuentaIpad(object){

    form = $("#gestionarDireccion");
    if (object!= null){
        element = JSON.parse(unescape(object));
        $("#titleGestionarDirecciones").html(Messages.updateAddress);
        $("#gestionarDireccion #addressId").attr('value',element.contactId);
        $("#gestionarDireccion #addressId").attr('name', 'addressId');
        $("#gestionarDireccion #addressName").attr('value',element.addressName);
        if(element.isBillingAddress == 'true'){
            $("#gestionarDireccion #addressName").attr('disabled',true);
            form[0].action = $('#updateBillingURL').attr('value');
        }else {
            form[0].action = $('#updateURL').attr('value');
        }
        if (Inditex.checkMiddleName(element.middleName)) {
            $("#gestionarDireccion #middleName").attr('value',element.middleName);
        }
        $("#gestionarDireccion #nombre").attr('value',element.firstName);
        $("#gestionarDireccion #apellidos").attr('value',element.lastName);
        $("#gestionarDireccion #direccion").attr('value',element.address1);
        $("#gestionarDireccion #direccion2").attr('value',element.address2);
        $("#gestionarDireccion #localidad").attr('value',element.city);
        $("#gestionarDireccion #cp").attr('value',element.zipCode);
        $("#gestionarDireccion #provincia").attr('value',element.state);
        var titleProvincia = $("#gestionarDireccion #provincia").attr('title');
        changeCustomSelect(form.find('#select-'+titleProvincia+' li[v=' + element.state + ']'), form);
        $("#gestionarDireccion #prefijo").attr('value',extractPrefix(element.phone1));
        $("#gestionarDireccion #telefono").attr('value',extractPhone(element.phone1));
        $("#gestionarDireccion #prefijo2").attr('value',extractPrefix(element.phone2));
        $("#gestionarDireccion #telefono2").attr('value',extractPhone(element.phone2));
        $("#gestionarDireccion #pais").attr('value',element.country);
        if($("#gestionarDireccion #colony")&&$("#gestionarDireccion #colony").length>0){
            $("#gestionarDireccion #colony").attr('value',element.colony);
        }
        if($("#gestionarDireccion #municipality")&&$("#gestionarDireccion #municipality").length>0){
            $("#gestionarDireccion #municipality").attr('value',element.municipality);
        }
    }


}

/**
 * Despliega men?s de m?todo de devoluci?n
 */
function unfold(target){
    if (target.hasClass("active")) {
        return;
    }
    $('.trig_but.active').removeClass('active');
    target.addClass('active');
    //$('.trig_but:not(.active)').next().slideUp();
    $('.trig_but:not(.active)').next().slideUp(function(){
        $("#scrollable").jScrollPane();
    });
    setTimeout(function(){
        //$('.trig_but.active').next().slideDown();
        $('.trig_but.active').next().slideDown(function(){
            $("#scrollable").jScrollPane();
        });
    }, 1);
    if ($("#tiendasFooter",target.next()).length>0) {
        Inditex.trackEvent( "Mi_cuenta","Devolucion","Tienda_desplegar",true);
    } else if ($("#devolucionDomicilio",target.next()).length>0) {
        Inditex.trackEvent( "Mi_cuenta","Devolucion","Domicilio_desplegar",true);
    }
}


function loadDevolucionDomicilio() {
    //Cargo la pagina de devoluci?n a domicilio
    var url = $("#devolucionDomicilio").attr("value");
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            $('#content_micuenta').html(respHtml);
            init_devolucionDomicilio();
        }
    });
    Inditex.trackEvent( "Mi_cuenta","Devolucion","Domicilio_solicitar",true);
}

function init_devolucionMSpot(){
    // No hace nada con el Marketing Spot
}

function init_gestionTarjetas() {
    var urlOrderRequested = $("#iCardsRequestedUrl").attr('value');

    //Busco y pinto los pedidos realizados
    jQuery.xajax({
        url: urlOrderRequested,
        type: "post",
        dataType: 'json',
        success: function(data) {
            var dataJSON = getResponseJSON(data);
            //Borro el contenido anterior.
            $("#content_micuenta").find("#tablaPedidos").empty();
            $.each(dataJSON, function(l, orderRequested) {
                //paintOrderRequested(orderRequested);
                paintWalletCard(orderRequested);
            });

            //para ajustar el scroll.
            setScroll();
        }
    });

    setCSSPaddingContent();
}

/** Pintamos los pedidos realizados en mi cuenta **/
function paintWalletCard(orderRequested) {
    for (a=0;a<orderRequested.length;a++){
        var tr = document.createElement("tr");
        var td = null;
        var p = null;
        var elemento = null;

        td = document.createElement("td");

        var input = document.createElement("input");
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "hash");
        input.setAttribute("id", "hash");
        input.setAttribute("value", orderRequested[a].hash);

        p = document.createElement("p");
        p.className = "deleteTarjeta";
        p.innerHTML = "x";
        $(p).click(deleteTarjeta);
        td.appendChild(input);
        td.appendChild(p);
        tr.appendChild(td);

        //td Fecha del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].alias;
        td.appendChild(p);
        tr.appendChild(td);

        // td Id Pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].printablePan;
        td.appendChild(p);
        tr.appendChild(td);

        // td estado del pedido
        td = document.createElement("td");
        elemento = document.createElement("center");

        p = document.createElement("p");
        p.innerHTML = orderRequested[a].paymentCodeName;
        elemento.appendChild(p);
        td.appendChild(elemento);
        tr.appendChild(td);




        //td Fecha del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.className = "principalCard";
        if (orderRequested[a].defaultCard){
            p.innerHTML = "<input class='radio' type='radio' name='check[]' id='check[]' checked/>";
        }else{
            p.innerHTML = "<input class='radio' type='radio' name='check[]' id='check[]'/>";
        }
        $(p).click(principalCard);
        td.appendChild(p);
        tr.appendChild(td);

        $("#content_micuenta").find("#tablaPedidos").append(tr);
    }

}

function principalCard(element){

    var urlOrderPrincipal = $("#iDefaultCardUrl").attr('value');
    var tr = $(this).parent().parent();
    var input = tr.find('input[name=\"hash\"]');
    var elemento=$(this);

    //Busco y pinto los pedidos realizados
    jQuery.xajax({
        url: urlOrderPrincipal,
        type: "post",
        dataType: 'json',
        data: "hash="+input.attr('value'),
        success: function(data) {
            if (data.status > 0) {

                init_gestionTarjetas();
            }
            else{
                openStaticModal(data.title, data.errorMessage, true);
            }
        }
    });

    setCSSPaddingContent();
}


function cierraVentanaAbreLogin(loginUrl){
    openGenericModal(loginUrl,null, null,200, null);
}

function initFormRecoverValidate(source) {

    $("#botonReseteo").click(function() {
        $("#recuperarPassForm").submit();
    });
    $("#recuperarPassForm").validate({
        submitHandler : function(form) {
            var form = $("#recuperarPassForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: "post",
                dataType: 'json',
                data: form.serialize(),
                success: function(data) {
                    if ((data) && ((data.errorKey==undefined) || (data.errorKey==null))) {
                        if (source=="inicio") {
                            Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_ok",null,true);
                        } else if (source=="tunel") {
                            Inditex.trackEvent( categoryEvent,"Restablecer_Contrasena_respuesta_ok",null,true);
                        }

                        var resetPasswordConfirmViewUrl = Inditex.generateUrl('resetPasswordConfirmView',
                            {
                                "storeId"			: Inditex.iStoreId,
                                "langId"			: Inditex.iLangId,
                                "catalogId"			: Inditex.iCatalogId,
                            },
                            true
                        );
                        openGenericModalWihtoutEffect(resetPasswordConfirmViewUrl, null, null, 'general_modal',function(){
                            if (source=="inicio") {
                                Inditex.trackPage( "Identificate/Restablecer_Contrasena/Actualizado",{'page':false});
                            } else if (source=="tunel") {
                                Inditex.trackPage( "Cesta_de_Compra/Identificate/Restablecer_Contrasena/Actualizado",{'page':false});
                            }

                        });

                        //Correcion para cerrar el popup en la cesta, esta mal la generacion general del popup ya que en la
                        //cesta coincide haber dos elementos con id="close_modal"
                        setTimeout(function() {
                            $('.close_modal').each(function() {
                                $( this ).bind('click', function() {
                                    closeModal(this);
                                });
                            });
                        }, 1000);
                    } else {

                        if (Inditex) {
                            Inditex.trackPage("Identificate/Contrasena_Olvidada/Envio_Error_" + data.key);
                            if (source=="inicio") {
                                Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_error",Inditex.codeError(data.errorKey,data.errorMessage),true);
                            } else if (source=="tunel") {
                                Inditex.trackEvent( categoryEvent,"Restablecer_Contrasena_respuesta_error",Inditex.codeError(data.errorKey,data.errorMessage),true);
                            }
                        }
                        openStaticModal("ERROR",data.errorMessage, true);

                    }
                }
            });
        },
        rules : {
            email : {
                required : true,
                email : true
            }
        },
        messages : {
            email : {
                required : Messages.required,
                email: Messages.email
            }
        }
    });
}

function initFormRecoverValidateMiCuenta(source) {

    //$('#loginModal').parent().animate();

    $('#reset-password input').on('change', function() {
        if($(this).is(':checked')) {
            $('#recuperarConExito').empty();
            $('form#recuperarPassForm #email').val('');
            $('#reset-password-form').slideDown(function() {
                Inditex.trackEvent('Iniciar_sesion','Recuperar_Contrasena_Desplegar', null, true);
                $('#loginModal').parent().animate({'margin-top': '-' + ($('#loginModal').parent().outerHeight() / 4) + 'px' });
            });
        } else {
            $('#reset-password-form').slideUp(function() {
                $('#recuperarPassForm #email').removeAttr('value');
                Inditex.trackEvent('Iniciar_sesion','Recuperar_Contrasena_cerrar', null, true);
                $('#loginModal').parent().animate({'margin-top': '-' + ($('#loginModal').parent().outerHeight() / 4) + 'px' });
            });
        }
    });

    $("#recuperarPassForm").validate({
        submitHandler : function(form) {

            $('#recuperarConExito').empty();
            var element = '#recuperarConExito';
            var title = '<div class="sub-title">' + Inditex.msg("ItxUserPasswordForgetView.titleconfirm") + '</div>';
            var msg = '<div>' + Inditex.msg("ItxUserPasswordForgetView.msgconfirm") + '</br>' + Inditex.msg("ItxUserPasswordForgetView.msgconfirm2") + '<div>';
            $(element).append(title).append(msg);

            $('#loginModal').parent().animate({ 'margin-top': '-' + ($('#loginModal').parent().outerHeight() / 4) + 'px' });
            $('#recuperarConExito').show();

            var form = $("#recuperarPassForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: "post",
                dataType: 'json',
                data: form.serialize(),
                success: function(data) {
                    if ((data) && ((data.errorKey==undefined) || (data.errorKey==null))) {
                        if (source=="inicio") {
                            Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_ok_email_enviado",null,true);
                        } else if (source=="tunel") {
                            Inditex.trackEvent( categoryEvent,"Restablecer_Contrasena_respuesta_ok",null,true);
                        }


                    } else {

                        if (Inditex) {
                            Inditex.trackPage("Identificate/Contrasena_Olvidada/Envio_Error_" + data.key);
                            if (source=="inicio") {
                                Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_error",Inditex.codeError(data.errorKey,data.errorMessage),true);
                            } else if (source=="tunel") {
                                Inditex.trackEvent( categoryEvent,"Restablecer_Contrasena_respuesta_error",Inditex.codeError(data.errorKey,data.errorMessage),true);
                            }
                        }

                    }
                }
            });
        },
        invalidHandler:function(form) {
            Inditex.trackEvent( "Iniciar_sesion","Recuperar_Contrasena_error",Inditex.codeError('error_validacion_formulario'),true);
        }
        ,
        rules : {
            email : {
                required : true,
                email : true
            }
        },
        messages : {
            email : {
                required : Messages.required,
                email: Messages.email
            }
        }
    });
}

function llamadaRecuperar(){

    var formulario = $("#recoverPassword");
    var urlOrderRequested = $("#actionFormulario").attr('value');
    alert (formulario.serialize());

    //debugger;
    jQuery.xajax({
        url: urlOrderRequested,
        type: 'post',
        dataType: 'json',
        data: formulario.serialize(),
        success: function(data) {

        }
    });
}

function init_reservaTienda() {

    //bind para mostrar pagina de detalle de pedido
    var opts = {
        "from":"reserva"
    }

    Inditex.getRestBookingGetBookingsByUserCmd({
        onSuccess: function(reservaTiendaJSON) {
            //alert(reservaTiendaJSON);
            if (reservaTiendaJSON){
                loadReservas(reservaTiendaJSON);
            }

        },
        onFailure: function(aStatus) {
            //Inditex.xOpenErrorPopUp(350,290);
        }
    });


}




/**
 * Carga las reservas a partir del json
 */
function loadReservas(data) {


    $('#tablaPedidos').empty();

    var updatablePanel = $('#tablaPedidos');
    var innerHTML ="";

    var verReserva = $("#verReserva").attr("value");

    var urlConsultaEstado = document.getElementById('userAccountReservationStateURL').value;

    for ( var i = 0; i < data.bookings.length; i++){

        var fecha = data.bookings[i].startDate.split(" ")[0];

        var tr = '<tr>';
        var tdFecha = '<td>'+fecha+'</td>';
        var tdNumber = '<td>'+data.bookings[i].locator+'</td>';
        var tdEstado = '<td>';
        if(data.bookings[i].bookingStoreItems.length>0){
            if(data.bookings[i].bookingStoreItems[0].bookingStatus<4){
                tdEstado+=$("#status_"+data.bookings[i].bookingStoreItems[0].bookingStatus).val();
            }else{
                tdEstado+=$("#status_4").val();
            }
        }
        tdEstado+='</td><td>';
        var tdClose = '</td>';
        var trClose = '</tr>';

        var contentUrlConsult = urlConsultaEstado.replace("_bookingId_", data.bookings[i].id);

        var botonConsulta = '<div class="boton2"><a href="'+contentUrlConsult+'" class="acc_butt verReserva">' + verReserva + '</a></div>';

        var tdBotones = botonConsulta + tdClose;

        innerHTML = innerHTML + tr + tdFecha + tdNumber + tdEstado + tdBotones + trClose;

    }
    updatablePanel.html(innerHTML);

    updatablePanel.find('.verReserva').each(function(){
        $(this).click(function(event){
            event.preventDefault();
            loadDetallePedidoReserva($(this).attr('href'));

        });
    });

}


/**
 * Carga la p?gina de detalle y comienza la secuencia
 *  de carga de los JSON del detalle
 */
function loadDetallePedidoReserva(url) {


    //Cargo la pagina de detalle de la reserva.
    jQuery.xajax({
        url: url,
        type: "post",
        dataType: 'html',
        success: function(respHtml) {
            // 0. Cargo el html de la pagina de detalle
            $("#content_aux").html(respHtml);
            // 1 -- Oculto las reservas realizadas y muestro el detalle de la reserva.
            $(".miCuentaPrincipal").hide();
            $(".miCuentaAux").show();


            $("#volverListadoReservas").click(function(){
                hideContentAux();
            });

            Inditex.getRestBookingGetBookingById({
                bookingId: $("#bookingId").attr("value"),
                onSuccess: function(data) {
                    //alert(bookingDetail);
                    if (data){
                        var numberBooking = data.locator;
                        var nameStore = data.bookingStoreItems[0].bamStore.name;
                        var nameStreet = data.bookingStoreItems[0].bamStore.addressLines[0];
                        var postalCode = data.bookingStoreItems[0].bamStore.zipCode;
                        var city = data.bookingStoreItems[0].bamStore.city;
                        var dateBooking = data.startDate.split(" ")[0];
                        var phone = data.bookingStoreItems[0].bamStore.phones[0];

                        $("#numberBooking").html(numberBooking);
                        $("#nameStore").html(nameStore);
                        $("#nameStreet").html(nameStreet);
                        $("#postalCode").html(postalCode);
                        $("#city").html(city);
                        $("#dateBooking").html(dateBooking);

                        $("#nameStore1").html(nameStore);
                        $("#nameStreet1").html(nameStreet);
                        $("#postalCode1").html(postalCode);
                        $("#city1").html(city);

                        $("#phone").html(phone);


                        //$("#informationMessage").html($("#notAvaiable").attr("value"));


                        // 1. Cargo los datos del pedido mediante un JSON
                        var url = $("#detailsProductJSONURL").attr('value');

                        var contenido = '';

                        var stateBooking = $("#stateBooking").attr("value");

                        contenido = '<tr class="nom">' + '<td colspan="2"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_order + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_color + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size + '</p></td>' + '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_quantity + '</p></td>' + '<td><p>'+ stateBooking + '</p></td>' + '<td style="width:100px;"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_total + '</p></td>' + '</tr>';
                        $("#cuerpoTablaDetalle").append(contenido);
                        contenido = "";

                        var contador = 0;
                        var tamano = data.bookingStoreItems.length;
                        var precioTotal = 0;

                        contador = cargarReserva(data,contador,url,precioTotal);

                        var estado = data.bookingStoreItems[0].bookingStatus;

                        if(estado == "0"){
                            var cancelarReserva = $("#cancelarReserva").attr("value");
                            var botonCancelar = '<a href="javascript:void(0);" class="acc_butt cancelarReserva" data-bookingId="' + data.id  + '">' + cancelarReserva + '</a>';
                            $("#cancelBooking").html(botonCancelar);
                        }


                        $(".cancelarReserva").click(function(event){
                            event.preventDefault();

                            Inditex.getRestBookingDeleteBookingById({
                                bookingId: $(this).attr("data-bookingId"),
                                onSuccess: function(data) {
                                    var mensaje = "";
                                    if(data.data.status == 1){
                                        if(document.getElementById('itxUserAccountCancelBooking').value != null
                                            && document.getElementById('itxUserAccountCancelBooking').value.indexOf("?") == -1) {
                                            mensaje = document.getElementById('itxUserAccountCancelBooking').value + "?mensaje=OK";
                                        } else {
                                            mensaje = document.getElementById('itxUserAccountCancelBooking').value + "&mensaje=OK";
                                        }
                                    }
                                    else if(data.errorKey){
                                        if(document.getElementById('itxUserAccountCancelBooking').value != null
                                            && document.getElementById('itxUserAccountCancelBooking').value.indexOf("?") == -1) {
                                            mensaje = document.getElementById('itxUserAccountCancelBooking').value + "?mensaje=ERROR";
                                        } else {
                                            mensaje = document.getElementById('itxUserAccountCancelBooking').value + "&mensaje=ERROR";
                                        }
                                    }

                                    openFormModal(mensaje,null,null,null,0.1);
                                },
                                onFailure: function(aStatus) {
                                    // Inditex.xOpenErrorPopUp(350,290);
                                }
                            });
                        });

                    }

                },
                onFailure: function(aStatus) {
                    // Inditex.xOpenErrorPopUp(350,290);
                }
            });


        }
    });

}


function cargarReserva(json,contador,url,precioTotal){


    var tamano = json.bookingStoreItems.length;

    var bookingStoreItems = json.bookingStoreItems[contador];
    var catentry = bookingStoreItems.catentry;

    var reference = catentry.reference.substring(0, 1) + "/" + catentry.reference.substring(1, 5) + "/" + catentry.reference.substring(5, 8) + "/" + catentry.reference.substring(8, 11) + "/" + catentry.reference.substring(11, 13);

    var catNameEncoded = encodeURIComponent(catentry.name);
    var urlFormatted = url
        .replace("_description_", catNameEncoded)
        .replace("_reference_", reference)
        .replace("_size_", catentry.size)
        .replace("_quantity_", bookingStoreItems.unitsOrdered)
        .replace("_status_", bookingStoreItems.bookingStatus)
        .replace("_price_", catentry.price)
        .replace("_catentry_", catentry.id)
        .replace("_partNumber_", catentry.reference.split("-")[0]);


    jQuery.xajax({
        url: urlFormatted,
        type: "post",
        dataType: 'json',
        success: function(data) {

            symbolPosition = data.currencySuffix.length==0;

            if (!symbolPosition)
                moneda = data.currencySuffix;
            else
                moneda=data.currencyPrefix;

            var contenido = '<tr>' + '<td id="image">' + '  <img src="' + data.image + '" width="70px" />' + '</td>' + '<td>' + '	<p>' + data.description + '</p>' + '    <span>Ref. ' + data.reference + '</span>' + '</td>' + '<td class="center">' + '	<p>' + data.color + '</p>' + '</td>' + '<td class="center">' + ' 	<p>' + data.size + '</p>' + ' </td>' + '<td class="center">' + '	<p>' + formatNumber(data.quantity, 0) + '</p>' + '</td>' + '<td class="center">' + '	<p>' + data.status + '</p>' + '</td>' + '<td class="right">' + ' 	<p>' + Inditex.formatPrice(data.price) + '</p>' + ' </td>' + '</tr>';
            $("#cuerpoTablaDetalle").append(contenido);
            contenido = "";

            precioTotal = precioTotal + (parseFloat(data.price) * data.quantity);

            contador++;

            if(contador < tamano){
                cargarReserva(json,contador,url,precioTotal);
            }
            else{

                setTimeout(function() {

                    contenido = '<tr class="noborde sepTopMin">' + '<td colspan="6" class="right"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_footer_subtotal + '</p></td>' + '<td class="right"><p><strong id="totalArticlesPrice" sinFormato="' + precioTotal + '">' +   Inditex.formatPrice(precioTotal) + '</strong></p></td>' + '</tr>' ;

                    $("#cuerpoTablaDetalle").append(contenido);
                    $("#totalPriceDetalle").html(formatCurPrice(precioTotal, 2,moneda));
                    $("#totalPriceDetalle span.decimal").addClass('white');
                    $(".miCuentaPrincipal").hide();
                    $(".miCuentaAux").show();
                    //para ajustar el scroll.
                    setScroll();
                }, 500);

            }

        }
    });





}

function eliminaFavoritoVisualmente(elemento){
    elemento.parent().parent().remove();
}

function init_gestionTarjetas() {
    var urlOrderRequested = $("#iCardsRequestedUrl").attr('value');

    //Busco y pinto los pedidos realizados
    jQuery.xajax({
        url: urlOrderRequested,
        type: "post",
        dataType: 'json',
        success: function(data) {
            var dataJSON = getResponseJSON(data);
            //Borro el contenido anterior.
            $("#content_micuenta").find("#tablaPedidos").empty();
            $.each(dataJSON, function(l, orderRequested) {
                //paintOrderRequested(orderRequested);
                paintWalletCard(orderRequested);
            });

            //para ajustar el scroll.
            setScroll();
        }
    });

    setCSSPaddingContent();
}

/** Pintamos los pedidos realizados en mi cuenta **/
function paintWalletCard(orderRequested) {
    for (a=0;a<orderRequested.length;a++){
        var tr = document.createElement("tr");
        var td = null;
        var p = null;

        td = document.createElement("td");

        var input = document.createElement("input");
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "hash");
        input.setAttribute("id", "hash");
        input.setAttribute("value", orderRequested[a].hash);

        p = document.createElement("p");
        p.className = "deleteTarjeta";
        p.innerHTML = "x";
        $(p).click(deleteTarjeta);
        td.appendChild(input);
        td.appendChild(p);
        tr.appendChild(td);

        //td Fecha del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].alias;
        td.appendChild(p);
        tr.appendChild(td);

        // td Id Pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].printablePan;

        td.appendChild(p);
        tr.appendChild(td);

        // td estado del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].paymentCodeName;
        td.appendChild(p);
        tr.appendChild(td);

        // td precio del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.innerHTML = orderRequested[a].expireMonth + "/" + orderRequested[a].expireYear;
        td.appendChild(p);
        tr.appendChild(td);


        //td Fecha del pedido
        td = document.createElement("td");
        p = document.createElement("p");
        p.className = "principalCard";
        if (orderRequested[a].defaultCard){
            p.innerHTML = "<input class='radio_' type='radio' name='check[]' id='check[]' checked/>";
        }else{
            p.innerHTML = "<input class='radio_' type='radio' name='check[]' id='check[]'/>";
        }
        $(p).click(principalCard);
        td.appendChild(p);
        tr.appendChild(td);

        $("#content_micuenta").find("#tablaPedidos").append(tr);
    }

}

function principalCard(element){

    var urlOrderPrincipal = $("#iDefaultCardUrl").attr('value');
    var tr = $(this).parent().parent();
    var input = tr.find('input[name=\"hash\"]');
    var elemento=$(this);

    jQuery.xajax({
        url: urlOrderPrincipal,
        type: "post",
        dataType: 'json',
        data: "hash="+input.attr('value'),
        success: function(data) {
            if (data.status > 0) {

                init_gestionTarjetas();
            }
            else{
                openStaticModal(data.title, data.errorMessage, true);
            }
        }
    });

    setCSSPaddingContent();
}

function deleteTarjeta(element){

    var urlOrderBorrado = $("#iRemoveCardUrl").attr('value');
    var tr = $(this).parent().parent();
    var input = tr.find('input[name=\"hash\"]');
    var elemento=$(this);

    nextCardHash = elemento.parent().parent().next().find('input[name=\"hash\"]').val();

    if ($('.deleteTarjeta').get().length < 2){

        var authToken = $('input[name=authToken]');

        jQuery.xajax({
            "url": Inditex.generateUrl("ItxStandardUnlinkWalletUserCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId
            },true),
            "type": "post",
            "dataType": 'json',
            "data": authToken.serialize(),
            "success": function(data) {
                if (data.status > 0) {
                    if (Inditex) {
                        Inditex.trackPage("Mi_Cuenta/Baja_Wallet/Envio_OK");
                    }
                    openStaticModal(Messages.titleBajaWallet, Messages.msgBajaWallet, true,desWalletizaView());
                    $('.dvabajo').remove();

                } else {
                    if (Inditex) {
                        Inditex.trackPage("Mi_Cuenta/Baja_Wallet/Envio_Error_" + data.type);
                    }

                    openStaticModal(data.title, data.errorMessage, true);
                }
            }
        });

    } else {

        if ($('#tablaPedidos').find('input[class=radio_]:checked').val() == 'on') {

            var urlOrderBorrado = $("#iRemoveCardUrl").attr('value');

            jQuery.xajax({
                url: urlOrderBorrado,
                type: "post",
                dataType: 'json',
                data: "hash="+input.attr('value'),
                success: function(data) {
                    if (data.status > 0) {
                        elemento.parent().parent().remove();

                        var urlOrderPrincipal = $("#iDefaultCardUrl").attr('value');
                        jQuery.xajax({
                            url: urlOrderPrincipal,
                            type: "post",
                            dataType: 'json',
                            data: "hash="+nextCardHash,
                            success: function(data) {
                                if (data.status > 0) {

                                    init_gestionTarjetas();
                                }
                                else{
                                    openStaticModal(data.title, data.errorMessage, true);
                                }
                            }
                        });

                        setCSSPaddingContent();
                    }
                    else{
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });


        } else {

            var urlOrderBorrado = $("#iRemoveCardUrl").attr('value');

            jQuery.xajax({
                url: urlOrderBorrado,
                type: "post",
                dataType: 'json',
                data: "hash="+input.attr('value'),
                success: function(data) {
                    if (data.status > 0) {
                        elemento.parent().parent().remove();
                    }
                    else{
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });
        }
    }


}

function desWalletizaView(){
    $('#bajaWalletHeader').remove();
    $('li[data-delete-if-no-wallet="1"]').remove();
    $('#gestionTarjetasHeader').remove();
}



;
/* END /DuttiNEWStorefrontAssetStore/js/miCuenta.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/seleccionarTienda.js (en_US) */
var TOOLTIP_OFFSET = 80;
var tiendaSeleccionada = null;
var stockStoreSeleccionada = null;
var detalleTiendaDireccion = null;
var detalleTienda = null;
var tiendas = null;
var marcadores = null;
var resultList = null;
var mapa = null;
var seleccionarTiendaParams = null;
var tiendaTooltip = null;
var createLinkSeleccionar = true;
var paisISO;

function check_selected_size(){

    if($('.size_holder input:checked').length){

        var followingUrl=$('#followingUrl').val();
        var followingTracking = $('#followingTracking').val();
        var tallas='';
        var primero=true;
        var tallasDesc='';
        var partNumbers='';

        $('.tallaselector input').each(function(){

            if ( $(this).is(':checked') ) {

                //alert ( $(this).attr('value') );
                if (!primero) {

                    tallas+='$';
                    tallasDesc+='$';
                    partNumbers+='$';
                }
                else {

                    primero=false;
                }


                tallas+=$(this).attr('value');
                tallasDesc+=$(this).attr('desc');
                partNumbers+=$(this).attr('partNumber');
            }
        });

        Inditex.trackEvent( 'Consulta_stock','Reservar',partNumbers,{'page':'Ficha_producto/'+partNumber+'/Detalle/Consulta_stock/Lista_Mapa'});
        var tiendaSelected=$('.tiendaSelected').attr('id');

        followingUrl+='&physicalStoreId='+tiendaSelected;

        followingUrl+='&tallas='+tallas;
        followingUrl+='&tallasDesc='+tallasDesc;
        followingUrl+='&partNumbers='+partNumbers;

        followingUrl=followingUrl.substring(0, followingUrl.indexOf("partNumber"))+followingUrl.substring(followingUrl.indexOf("storeId"))+"&partNumber="+$(this).attr('partNumber');

        //$('#tiendastalla').remove();
        window.modaltiendastalla.closemodal();

        //removeCookie('WC_Popup_Dutti_Booking_User');
        $(".popupHtmlCesta").css("z-index","9999");
        //setCookie('WC_Popup_Dutti_Booking_User', tallas, 1,'/');
        openGenericModalReserva(followingUrl,null,function(){
            Inditex.trackPage( followingTracking,true);
        },200,null);
    }
    else{

        $('.sizecheck').fadeIn()
    }
}

function initSeleccionarTiendaReserva(params) {
    _initSeleccionarTiendaReserva(params)
}

function _initSeleccionarTiendaReserva(params) {

    var controle = this;

    $('.error_msg').hide();
    $(".no_reserva_en_tienda").hide();

    //ECOMDUTI-2253
    var partNumber = $('#partNumber').attr('value');
    var lsPartNumber = partNumber.split("-");
    var partNumberColor = lsPartNumber[0];

    tiendaSeleccionada = null;
    tiendaTooltip = null;
    if (params == null || params.onAddTienda == null) {
        createLinkSeleccionar = false;
        $("#pais").removeAttr('disabled');
        params.onAddTienda = function(tienda) {
            alert("Add Tienda " + tienda.name);
        }
    } else {
        $("#pais").attr('disabled', 'true');
        createLinkSeleccionar = true;
    }
    seleccionarTiendaParams = params;
    resultList = document.getElementById("resultList");
    detalleTienda = document.getElementById("detalleTienda");
    detalleTiendaDireccion = document.getElementById("detalleTiendaDireccion");
    // Inicializamos mapa
    if (initializeMapReserva()) {
        $(".acc_butt").click(function() {
            controle.resultList.innerHTML = "";
            $(detalleTienda).hide();
            setTimeout(function() {
                //$('#buscarTiendasForm').submit();
                //paisISO = $("#pais option:selected").val();
                paisISO = $("#pais").val();
                var address = $('input[name="ubicacion"]').val();
                if (address != ""){
                    if (Inditex){
                        Inditex.trackEvent('Ficha_Producto','buscar_stock',partNumber);
                        Inditex.trackEvent( 'Consulta_stock','Buscar_Tiendas',paisISO+'-'+address,true);
                    }
                }
                Inditex.getGoogleCoords(
                    paisISO,
                    address,
                    function(aResult){
                        if (aResult) {
                            loadJSONPhysicalStoreReserva(aResult);
                        }
                    }
                );


            }, 1000);
        });
        $("#ubicacion").keypress(function(e) {
            if(e.keyCode == 13) {
                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    //paisISO = $("#pais option:selected").val();
                    paisISO = $("#pais").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex){
                            Inditex.trackEvent('Ficha_Producto','buscar_stock',partNumber);
                            Inditex.trackEvent( 'Consulta_stock','Buscar_Tiendas',paisISO+'-'+address,true);
                        }
                    }
                    controle.getCorderMapReserva(address, paisISO, loadJSONPhysicalStoreReserva);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            }
        });
    }
}

function initializeMapReserva(params) {
    var canvas = document.getElementById("mapcanvas");
    var paisISO = $("#pais").val();
    var address = $('#input_pais').val();
    if (canvas != null) {

        Inditex.initGoogleMaps('mapcanvas', paisISO,address, function(aMap) {
            mapa=aMap;
            var gs = [{
                stylers : [{
                    saturation : -100
                }]
            }];
            aMap.iMap.mapTypes.set('gs', new google.maps.StyledMapType(gs, {
                map: aMap.iMap,
                name: 'Grayscale'
            }));
            aMap.iMap.setMapTypeId('gs');

            var contenidohideTiendaTooltiptip = document.getElementById("mapa_tooltip");
            var tooltipDiv = document.getElementById("mapa_tooltip");
            initTooltipReserva(tooltipDiv);
            $("#tooltipClose").bind('click', function(){
                hideTiendaTooltip();
                for (var i = 0; i < aMap.iMarkers.length; i++) {
                    aMap.iMarkers[i].setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png");
                }
            });
        },"icono-dutti");
        return true;
    } else {
        return false;
    }
}

function initSeleccionarTienda(params){
    _initSeleccionarTienda(params);
}

function _initSeleccionarTienda(params){
    // Para resetear la seleccion de tinda anterior
    // y que cuando se entre no aparezca un toolTip informativo de 
    // la ultima tienda seleccionada
    tiendaSeleccionada = null;
    tiendaTooltip = null;

    var controle = this;

    if (params==null || params.onAddTienda==null){
        createLinkSeleccionar = false;
        params.onAddTienda = function(tienda){alert("Add Tienda "+tienda.name);}
    }
    else{
        createLinkSeleccionar = true;
    }
    seleccionarTiendaParams=params;
    resultList = document.getElementById("resultList");
    detalleTienda = document.getElementById("detalleTienda");
    detalleTiendaDireccion = document.getElementById("detalleTiendaDireccion");
    //$("#dvlistad").slideUp('slow');

    // Inicializamos mapa
    setTimeout(function() {
        if (initializeMap()){

            // $.getJSON("data/ItxPhysicalStoreListJSON.json", loadTiendas);
            $(".acc_butt").click(function() {
                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex) {
                            Inditex.trackEvent('Tiendas','formulario',address);
                            Inditex.trackEvent( 'Mi_cuenta','Tiendas_favoritas_buscar',$.trim($("#pais option:selected").val())+"-"+ address,true);
                        }
                    }

                    Inditex.getGoogleCoords(
                        paisISO,
                        address,
                        function(aResult) {
                            if (aResult) {
                                loadJSONPhysicalStore(aResult);
                            }
                        }
                    );


                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });

            $("#ubicacion").keypress(function(e) {
                if(e.keyCode == 13) {
                    $(".acc_butt").click();
                }
            });

            $("#buscarTiendasForm").bind("submit", function(event) {
                event.stopPropagation();
                event.preventDefault();

                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex) {
                            Inditex.trackEvent('Tiendas','formulario',address);
                            Inditex.trackEvent( 'Mi_cuenta','Tiendas_favoritas_buscar',$.trim($("#pais option:selected").text())+"-"+address,true);
                        }
                    }
                    controle.getCorderMap(address, paisISO, loadJSONPhysicalStore);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });
        }
    }, 500);
}

function initSeleccionarTiendaTunel(params){
    _initSeleccionarTiendaTunel(params);
}

function _initSeleccionarTiendaTunel(params){
    // Para resetear la seleccion de tinda anterior
    // y que cuando se entre no aparezca un toolTip informativo de 
    // la ultima tienda seleccionada
    tiendaSeleccionada = null;
    tiendaTooltip = null;

    var controle = this;

    createLinkSeleccionar = true;
    seleccionarTiendaParams=params;
    resultList = document.getElementById("resultList");
    detalleTienda = document.getElementById("detalleTienda");
    detalleTiendaDireccion = document.getElementById("detalleTiendaDireccion");
    //$("#dvlistad").slideUp('slow');

    // Inicializamos mapa
    setTimeout(function() {
        if (initializeMap()){
            // Inicializamos los datos

            // $.getJSON("data/ItxPhysicalStoreListJSON.json", loadTiendas);
            $(".acc_butt").click(function() {
                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex)
                            Inditex.trackEvent('Tiendas','formulario', address);
                    }
                    controle.getCorderMap(address, paisISO, loadJSONPhysicalStoreTunel);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });

            $("#ubicacion").keypress(function(e) {
                if(e.keyCode == 13) {
                    $(".acc_butt").click();
                }
            });
        }
    }, 500);
}

/** Funci?n para encontrar la latitud y longitud del direcci?n que se especifica
 *  Como la funcion geocode de googel es asincrona tengo que pasar la funcion que
 *  queremos que se ejecute despues de encontrar la longitud y latitud.
 *
 *  Es una forma de hacer sincorono el metodo geocode.
 *
 **/
function getCorderMap(address, paisISO, callback) {

    //Esto si es necesario.  Ya que canarias googel map retorna  como region "ES" no "ESCN" que propia de Inditex
    if (paisISO == "ESCN" || paisISO == "IC") {
        paisISO = "ES";
    }

    Inditex.getGoogleCoords(
        paisISO,
        address,
        function(aResult) {
            if (aResult) {
                var latitud = aResult.geometry.location.lat();
                var longitud = aResult.geometry.location.lng();
                callback.call(this, latitud,longitud);
                encontrado = 1;
            }
        }
    );
}

function getCorderMapReserva(address, paisISO, callback) {

    //Esto si es necesario.  Ya que canarias googel map retorna  como region "ES" no "ESCN" que propia de Inditex
    if (paisISO == "ESCN" || paisISO == "IC") {
        paisISO = "ES";
    }

    Inditex.getGoogleCoords(
        paisISO,
        address,
        function(aResult) {
            if (aResult) {
                var latitud = aResult.geometry.location.lat();
                var longitud = aResult.geometry.location.lng();
                callback.call(this, aResult);
                encontrado = 1;
            }
            if (encontrado == 0){
                $('#results_header').hide();
                //$('#total_tiendas').html('0 ');
                $('.error_msg').show();
                $('#scrollable').hide();
            }

        }
    );

}



/** Funcion que se encaraga de cargar un JSON con las tiendas fisicas mas proximas a
 *  la longitud y latiutd que le pasamos.
 *
 * **/

function loadJSONPhysicalStoreReserva(aResult) {
    var latitude, longitude;

    latitude = aResult.geometry.location.lat();
    longitude = aResult.geometry.location.lng();


    //alert('loadJSONPhysicalStore' + latlng);
    var url = $('#iSearchUrl').attr('value');
    url = url.replace("_latitude_", latitude).replace("_longitude_",longitude);
    //Situamos el mapa en la poblaci?n de b?squeda
    mapa.iMap.setZoom(15);
    mapa.iMap.panTo(new google.maps.LatLng(latitude,longitude));
    //lo hacemos mediante POST para poder crear una pagina HTML y procesar los datos 
    // la respuesta la convertimos en un JSON y los pintamos en el mapa.
    // Lo suyo es utilizar el metodo $.getJSON pero no consigo hacer funcionar correctamente la JSP
    //loadTiendasReserva(latlng.lat(),latlng.lng());

    loadTiendasReserva(latitude,longitude);

}

function loadJSONPhysicalStore(aResult) {
    var latitude = aResult.geometry.location.lat();
    var longitude = aResult.geometry.location.lng();
    //alert('loadJSONPhysicalStore' + latlng);
    var url = $('#buscarTiendasForm').attr('action');
    url = url + "&latitude=" + latitude + "&longitude=" + longitude;
    //lo hacemos mediante POST para poder crear una pagina HTML y procesar los datos 
    // la respuesta la convertimos en un JSON y los pintamos en el mapa.
    // Lo suyo es utilizar el metodo $.getJSON pero no consigo hacer funcionar correctamente la JSP
    mapa.iMap.setZoom(15);
    mapa.iMap.panTo(new google.maps.LatLng(latitude,longitude));
    jQuery.xajax({
        url: url,
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSONBuscadorTienda(respHtml);
            loadTiendas(dataJSON);

            //Actualizamos el scroll por si es necesario.
            setScroll();
        }
    });
}

/** Funcion que se encaraga de cargar un JSON con las tiendas fisicas mas proximas a
 *  la longitud y latiutd que le pasamos.
 *
 * **/
function loadJSONPhysicalStoreTunel(latlng) {
    //alert('loadJSONPhysicalStore' + latlng);
    var url = $('#buscarTiendasForm').attr('action');
    url = url + "&latitude=" + latlng.lat() + "&longitude=" + latlng.lng();
    //lo hacemos mediante POST para poder crear una pagina HTML y procesar los datos 
    // la respuesta la convertimos en un JSON y los pintamos en el mapa.
    // Lo suyo es utilizar el metodo $.getJSON pero no consigo hacer funcionar correctamente la JSP
    jQuery.xajax({
        url: url,
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSONBuscadorTienda(respHtml);
            loadTiendas(dataJSON,false, true);

            //Actualizamos el scroll por si es necesario.
            setScroll();
        }
    });
}


function initTooltipReserva(content){
    MapTooltip.prototype = new google.maps.OverlayView();
    MapTooltip.prototype.initialize = function(){

    };
    MapTooltip.prototype.onAdd = onAddTooltipReserva;
    MapTooltip.prototype.draw = onDrawTooltip;
    MapTooltip.prototype.onRemove = onRemoveTooltip;

    google.maps.event.addListener(mapa.iMap, 'idle', function() {
        // Get projection
        projection = tiendaTooltip.getProjection();
    })

    // Inicializamos el Tooltip
    // var swBound = new google.maps.LatLng(43.741892, -8.393555);
    // var neBound = new google.maps.LatLng(43.341892, -8.393555);
    // var bounds = new google.maps.LatLngBounds(swBound, neBound);
    tiendaTooltip = new MapTooltip(content);
    tiendaTooltip.setMap(mapa.iMap);
    return tiendaTooltip;
}


function seleccionarTiendaReserva(tienda, linea, stockStore) {
    tiendaSeleccionada = tienda;
    stockStoreSeleccionada = stockStore;
    var html = tienda.addressLines[0] + "<br />" + tienda.zipCode + " " + tienda.city + "<br />";
    if (tienda.phones[0] != null && tienda.phones[0] != '') {
        html += "Tel. " + tienda.phones[0];
    }
    tienda.sections = tienda.sections.replace("1",  seleccionarTiendaParams.sections1);
    tienda.sections = tienda.sections.replace("2",  seleccionarTiendaParams.sections2);
    tienda.sections = tienda.sections.replace("3",  seleccionarTiendaParams.sections3);
    tienda.sections = tienda.sections.replace(/,/g, " / ");
    html += "<br />( " + tienda.sections + " )";
    //html += '<br><a id="verEnMapa" onclick="onClickMarcador(tiendaSeleccionada.marcador,tiendaSeleccionada);" href="#">VER EN EL MAPA</a>';
    //element = JSON.stringify(tienda);
    //link = '<div class="bot_sig tiendas"><a href="javascript:void(0)" id="seleccionarTiendaBtn" onclick="addTienda(\'' + escape(element) + '\');closeModal(this, true);">SELECCIONAR TIENDA</a></div>';
    //$(detalleTiendaDireccion).html(html);
    $('.detalletienda.active').removeClass('active')
    setTimeout(function() {
        if (!$(linea).children('.detalletienda').length) {
            $('<div />', {
                'html': html,
                'class': 'detalletienda active'
            }).appendTo(linea).hide().slideDown(function() {
                setScroll()
            });
        }
    }, 1)
    setTimeout(function() {
        $('.detalletienda:not(.active)').slideUp(function() {
            setScroll()
            $(this).parent().removeClass('tiendaSelected')
            $(this).remove()
        })
    }, 2)
    if (createLinkSeleccionar) {
        var divAddTienda = document.createElement("div");
        divAddTienda.className = "boton3";
        var linkAddTienda = document.createElement("a");
        linkAddTienda.href = "javascript:void(0)";
        linkAddTienda.id = "seleccionarTiendaBtn";
        linkAddTienda.className = "acc_butt tienda";
        linkAddTienda.innerHTML = "SELECCIONAR TIENDA";
        $(linkAddTienda).click(function() {
            seleccionarTiendaParams.onAddTienda(tienda);
        });
        divAddTienda.appendChild(linkAddTienda);
        detalleTiendaDireccion.appendChild(divAddTienda);
        $(window).resize();
    }
    //html += link;
    $(".tienda").removeClass("tiendaSelected");
    $(linea).addClass("tiendaSelected");
    $(detalleTienda).show();

    var unidades =0;
    for (var i = 0; i < stockStore.length; i++){
        unidades += stockStore[i].quantity;
    }
    Inditex.trackEvent('Ficha_Producto', 'consultar_stock_lista', partNumber+", unidades disponibles "+unidades);

}

function onClickMarcadorReserva(marcador, tiendaClickada) {
    for (var i = 0; i < mapa.iMarkers.length; i++) {
        mapa.iMarkers[i].setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png");
    }
    var pos = marcador.getPosition();
    var overlayProjection = tiendaTooltip.getProjection();
    if (overlayProjection != null) {
        var punto = overlayProjection.fromLatLngToContainerPixel(pos);
        punto.y = punto.y - 100;
        pos = overlayProjection.fromContainerPixelToLatLng(punto);
    }
    activemarker = marcador;
    marcador.setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png");
    mapa.iMap.panTo(pos);
    //seleccionarTienda(tiendaClickada, document.getElementById(tiendaClickada.id));
    tiendaTooltip.setMap(mapa.iMap);
}

function getTiendaLineReserva(tienda, stockStore) {
    var linea = document.createElement("li");
    linea.id = tienda.id;
    linea.className = "tienda columns";
    var span = document.createElement("span");
    span.className = "spnsel";
    span.innerHTML = tienda.city +' - '+tienda.name;
    $(linea).click(function() {
        Inditex.trackEvent( 'Consulta_stock','Lista_desplegar',tienda.id,{'page':'Ficha_producto/'+partNumber+'/Detalle/Consulta_stock/Lista_Mapa'});
        $(span).toggleClass('active');
        //if(!$(linea).hasClass('tiendaSelected')){
        seleccionarTiendaReserva(tienda, linea, stockStore);
        onClickMarcadorReserva(tienda.marcador, tienda, stockStore);
        //}
    });
    //span.appendChild(link);
    linea.appendChild(span);
    // addResulLine.
    return linea;
}

function getTiendaLine(tienda) {
    var linea = document.createElement("li");
    linea.id = tienda.physicalStoreId;
    linea.className = "tienda columns";
    var span = document.createElement("span");
    span.className="spnsel";
    span.innerHTML = tienda.city +' - '+ tienda.name;

    $(linea).click(function() {
        if (Inditex)
            Inditex.trackEvent('Tiendas','ver_en_mapa');
        seleccionarTienda(tienda, linea);
        onClickMarcador(tienda.marcador, tienda);
    });
    //span.appendChild(link);
    linea.appendChild(span);
    // addResulLine.

    return linea;
}

function seleccionarTienda(tienda, linea) {
    // alert("Seleccionada la tienda "+tienda.name);
    tiendaSeleccionada = tienda;
    var html = "<li><span>" +tienda.city+' - '+ tienda.name + "<br />" + tienda.address + "<br />"
        + tienda.postalCode + " " + tienda.city + "<br />";
    if (tienda.phone1  != null && tienda.phone1 != '') {
        html = html + tienda.phone1 + "<br />" ;
    }
    tienda.sections = tienda.sections.replace("1",  seleccionarTiendaParams.sections1);
    tienda.sections = tienda.sections.replace("2",  seleccionarTiendaParams.sections2);
    tienda.sections = tienda.sections.replace("3",  seleccionarTiendaParams.sections3);
    tienda.sections = tienda.sections.replace(/,/g, " / ");
    html = html +  "( " + tienda.sections + " )" ;

    html +="</span></li>";
    if(Inditex.iStoreJSON.countryCode=="CN"&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""){
        html+= '<li><a id="verEnMapa" onclick="if (Inditex) Inditex.trackEvent(\'Tiendas\', \'ver_en_mapa\'); onClickMarcadorBaidu(tiendaSeleccionada.marcador,tiendaSeleccionada);" href="#">' + Messages.showStoreMap + '</a></li>';
    }else{
        html+= '<li><a id="verEnMapa" onclick="if (Inditex) Inditex.trackEvent(\'Tiendas\', \'ver_en_mapa\'); onClickMarcador(tiendaSeleccionada.marcador,tiendaSeleccionada);" href="#">' + Messages.showStoreMap + '</a></li>';

    }
    //element = JSON.stringify(tienda);
    //link = '<div class="bot_sig tiendas"><a href="javascript:void(0)" id="seleccionarTiendaBtn" onclick="addTienda(\'' + escape(element) + '\');closeModal(this, true);">SELECCIONAR TIENDA</a></div>';
    $(detalleTiendaDireccion).html(html);

    if (createLinkSeleccionar){
        var divAddTienda = document.createElement("div");
        divAddTienda.className="boton3";
        var linkAddTienda = document.createElement("a");
        linkAddTienda.href="javascript:void(0)";
        linkAddTienda.id="seleccionarTiendaBtn";
        linkAddTienda.className = "acc_butt tienda";
        linkAddTienda.innerHTML= Messages.selectShop;
        $(linkAddTienda).click(function(){
            Inditex.trackEvent( 'Mi_cuenta','Tiendas_favoritas_seleccionar',$.trim($("#pais option:selected").val())+"-"+$('input[name="ubicacion"]').val(),true);

            if((maxUserFavouriteStores>=0)&&(idsTiendasMiCuenta.length>=maxUserFavouriteStores)) {
                openStaticModal("ERROR", Messages.maxUserFavouriteStores+" ("+maxUserFavouriteStores+")", false);
            }
            else{
                var urlEnviar = $('#iAddUrl').val();
                jQuery.xajax({
                    url: urlEnviar,
                    type: "post",
                    dataType: 'json',
                    data: "physicalStoreId="+tienda.physicalStoreId,
                    success: function(aJson) {

                        if ((aJson) && ((aJson.errorKey==undefined) || (aJson.errorKey==null))) {
                            if (Inditex) {
                                Inditex.trackEvent('Tiendas','seleccionar');
                            }
                            seleccionarTiendaParams.onAddTienda(tienda);
                        }
                        else {

                            if (aJson.errorKey=="_ERR_MAX_USER_FAVOURITE_STORES") {
                                openStaticModal("ERROR", aJson.errorMessage, false);
                            }
                            else {
                                showError(ITX_TEXT_GENERIC_PROBLEM);
                            }
                        }
                    }
                });
            }


        });
        divAddTienda.appendChild(linkAddTienda);
        detalleTiendaDireccion.appendChild(divAddTienda);
        $(window).resize();


    }
    //html += link;
    $(".tienda").removeClass("tiendaSelected");

    $(linea).addClass("tiendaSelected");

    //para ajustar el scroll.
    if ($('#scrollable')) {
        setScroll();
    }
    $(detalleTienda).show();


}


function loadTiendasReserva(l1,l2) {
    var self = this;

    var idPartNumber = $('#partNumber').attr('value');
    var stockSizeJSON = null;

    Inditex.getRestStockPhysicalStores({
        "latitude":l1,
        "longitude":l2,
        "max": 20,
        "min": 20,
        "urlRest": $('#iRestStockPhysicalStoreUrl').attr('value'),
        "urlStockSotre": Inditex.iURLStockStore,
        "partNumber": idPartNumber,
        "onSuccess": function(aJson) {
            //self.stockSizeJSON = jQuery.parseJSON('{"stocks":[{"datatype":"stock","physicalStoreId":4609,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":419,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105}]},{"datatype":"stock","physicalStoreId":4104,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":4200,"sizeStocks":[{"datatype":"sizeStock","sizeId":2,"quantity":1,"size":102},{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":432,"sizeStocks":[{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":-1,"size":105}]},{"datatype":"stock","physicalStoreId":4560,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103}]},{"datatype":"stock","physicalStoreId":4625,"sizeStocks":[{"datatype":"sizeStock","sizeId":2,"quantity":0,"size":102},{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":402,"sizeStocks":[{"datatype":"sizeStock","sizeId":2,"quantity":1,"size":102},{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":1,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":434,"sizeStocks":[{"datatype":"sizeStock","sizeId":2,"quantity":0,"size":102},{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":-2,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":1,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":4402,"sizeStocks":[{"datatype":"sizeStock","sizeId":2,"quantity":1,"size":102},{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":-1,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":4660,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":-1,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":1,"size":106}]},{"datatype":"stock","physicalStoreId":404,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":1,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":405,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":-1,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":1,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]},{"datatype":"stock","physicalStoreId":4344,"sizeStocks":[{"datatype":"sizeStock","sizeId":3,"quantity":0,"size":103},{"datatype":"sizeStock","sizeId":4,"quantity":0,"size":104},{"datatype":"sizeStock","sizeId":5,"quantity":0,"size":105},{"datatype":"sizeStock","sizeId":6,"quantity":0,"size":106}]}]}');
            self.stockSizeJSON = getResponseJSONBuscadorTienda(aJson);
            if (self.stockSizeJSON && self.stockSizeJSON.infoPhysicalStore && self.stockSizeJSON.infoPhysicalStore.closerStores.length > 0) {
                Inditex.trackPage( 'Ficha_producto/'+partNumber+'/Detalle/Consulta_stock/Lista_Mapa',{'page':false});
                //self.updateResults(self.infoStore.closerStores,stockSize.stocks,container);

                $('#shopform .error_msg').hide();
                $('#scrollable').show();
                $('#results_header').show();
                //$("#dvlistad").slideUp('slow');
                tiendas = new Array();
                var marcador = null;

                var bounds = new google.maps.LatLngBounds();
                clearMarcadores();
                $("#dvlistad").show();
                // $(window).trigger('resize');
                // $(window).resize();
                var total_tiendas = 0;
                $.each(self.stockSizeJSON.infoPhysicalStore.closerStores, function(l, tienda) {

                    var restrictedSectionStockQuery = tienda.restrictedStocksections.split(',');
                    if(tienda.receiveStockQuery){
                        if(tienda.restrictedStocksections.length == 0 || (tienda.restrictedStocksections.length > 0 && restrictedSectionStockQuery.indexOf(Inditex.iXProductJSON.section) <0)){

                            bounds.extend(new google.maps.LatLng(tienda.latitude, tienda.longitude));
                            var stockSizeStore = self.stockSizeJSON.storeStock.stocks;
                            var stockSizeFind = null;
                            for (var phs = 0; phs < stockSizeStore.length; phs++) {
                                if (tienda.id == stockSizeStore[phs].physicalStoreId) {
                                    stockSizeFind = stockSizeStore[phs].sizeStocks;
                                }
                            }

                            if(stockSizeFind!=null){

                                var totalquantity = 0;
                                for (var i = 0; i < stockSizeFind.length; i++) {
                                    totalquantity +=stockSizeFind[i].quantity;
                                }

                                if(totalquantity > 0){
                                    total_tiendas++;
                                    tiendas.push(tienda);

                                    resultList.appendChild(getTiendaLineReserva(tienda, stockSizeFind));
                                    mapa.addMark(total_tiendas-1, tienda.latitude, tienda.longitude, "", function(aIndex) {});
                                    tienda.marcador = mapa.iMarkers[total_tiendas-1];

                                    google.maps.event.addListener(mapa.iMarkers[total_tiendas-1], 'click', function() {
                                        Inditex.trackEvent( 'Consulta_stock','Mapa_desplegar',tienda.id,{'page':'Ficha_producto/'+partNumber+'/Detalle/Consulta_stock/Lista_Mapa'});
                                        onClickMarcadorReserva(tienda.marcador, tienda, stockSizeFind);

                                        var unidades =0;
                                        for (var i = 0; i < stockSizeFind.length; i++){
                                            unidades += stockSizeFind[i].quantity;
                                        }
                                        Inditex.trackEvent('Ficha_Producto', 'consultar_stock_mapa', partNumber+", unidades disponibles "+unidades);

                                    });
                                    google.maps.event.addListener(mapa.iMap, 'zoom_changed', hideTiendaTooltip);
                                    google.maps.event.addListener(mapa.iMap, 'resize', hideTiendaTooltip);
                                    google.maps.event.addListener(mapa.iMap, 'projection_changed', hideTiendaTooltip);
                                    google.maps.event.addListener(mapa.iMap, 'dragstart', hideTiendaTooltip);
                                    google.maps.event.addListener(mapa.iMap, 'center_changed', hideTiendaTooltip);
                                    google.maps.event.addListener(mapa.iMap, 'bounds_changed', hideTiendaTooltip);

                                }
                            }
                        }
                    }
                });

                if (total_tiendas == 0){
                    $('#results_header').hide();
                    $('#results_header_noResult').show();
                    $('#noResult').html(Messages.noResults);
                }
                else{
                    mapa.focus();
                    $('#results_header_noResult').hide();
                    $('#results_header').show();
                    $('#total_tiendas').html(total_tiendas+' ');

                }

                //$('#resultList').jScrollPane();
                setScroll();
            }
        }
    });


}

function loadTiendas(dataTiendas,footer, tunel) {

    var mismoPais = 0;
    tiendas = new Array();
    clearMarcadores();

    $("#dvlistad").show();
    var tiendas_china=0;
    var total_tiendas=0;
    $.each(dataTiendas, function(l, tienda) {

        if (paisISO == tienda.country) {
            mismoPais = 1;
        } else {
            mismoPais = 0;
        }

        if (mismoPais == 1) {
            tiendas.push(tienda);
            if(footer){
                resultList.appendChild(getTiendaLineFooter(tienda,footer));
            }else{
                resultList.appendChild(getTiendaLine(tienda));
            }

            total_tiendas++;
            var  tiendaClickada = tienda;
            var marcadorActual;
            if(Inditex.iStoreJSON.countryCode=="CN"&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""){
                Inditex.translateGoogleToBaiduCoords(tienda.longitude, tienda.latitude,function(point){
                    tiendas_china++;
                    tiendaClickada.longitude=point.lng;
                    tiendaClickada.latitude=point.lat;
                    mapa.addMark(
                        tiendas_china-1,
                        point.lat,
                        point.lng,
                        "");
                    marcadorActual = mapa.iMarkers[tiendas_china-1];
                    tienda.marcador = marcadorActual;
                    mapa.iMarkers[tiendas_china-1].removeEventListener('click');
                    mapa.iMarkers[tiendas_china-1].addEventListener('click',function() {
                        if(footer){
                            onClickMarcadorBaiduFooter(marcadorActual, tiendaClickada);
                        }else{
                            onClickMarcadorBaidu(marcadorActual, tiendaClickada);
                        }

                    });
                    mapa.iMap.addEventListener('zoomend', function(){
                        hideTiendaTooltip();
                    });
                    mapa.iMap.addEventListener('resize', function(){
                        hideTiendaTooltip();
                    });
                    mapa.iMap.addEventListener('dragstart', function(){
                        hideTiendaTooltip();
                    });
                    mapa.iMap.addEventListener('dragend', function(){
                        hideTiendaTooltip();
                    });
                    mapa.focus();
                });
            }else{

                mapa.addMark(
                    total_tiendas-1,
                    tienda.latitude,
                    tienda.longitude,
                    "");
                marcadorActual = mapa.iMarkers[total_tiendas-1];
                tienda.marcador = marcadorActual;

                google.maps.event.addListener(mapa.iMarkers[total_tiendas-1], 'click', function(){
                    if(footer){
                        onClickMarcadorFooter(marcadorActual, tiendaClickada);
                    }else{
                        onClickMarcador(marcadorActual, tiendaClickada);
                    }
                    if (footer=="footer") {
                        Inditex.trackEvent( "Tiendas","Desplegar_Mapa",tiendaClickada.physicalStoreId,{'page':'Stores/Tiendas/Lista_Mapa'});
                    } else if (footer=="tunel") {
                        Inditex.trackEvent( categoryEvent,"Envio_Tiendas_Buscador_Mapa_Desplegar",tiendaClickada.physicalStoreId,{'page':"Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador/Lista_Mapa"+extraPageview});
                    }
                });


                google.maps.event.addListener(mapa.iMap, 'zoom_changed', hideTiendaTooltip);
                google.maps.event.addListener(mapa.iMap, 'resize', hideTiendaTooltip);
                google.maps.event.addListener(mapa.iMap, 'projection_changed', hideTiendaTooltip);
                google.maps.event.addListener(mapa.iMap, 'dragstart', hideTiendaTooltip);
                google.maps.event.addListener(mapa.iMap, 'center_changed', hideTiendaTooltip);
                google.maps.event.addListener(mapa.iMap, 'bounds_changed', hideTiendaTooltip);
            }

            if((Inditex.iStoreJSON.countryCode!="CN")||(!Inditex.iBaiduMapsKey)){
                mapa.focus();
            }
            if(!footer){
                $(window).resize();
            }

        }
    });
    if(!footer){
        $(window).resize();
        mapa.focus();
        //$("#dvlistad").slideDown('slow', alert);

        var idModal = $("#s_overlay  div")[1].id;
        //scrollDiv(idModal, "dvlistad");
    }else{
        $('#total_tiendas').html(total_tiendas+' ');
        if((Inditex.iStoreJSON.countryCode!="CN")&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""&&(total_tiendas>0)){
            mapa.focus();
        }
        setScroll();
    }
    if (footer=="footer") {
        Inditex.trackPage( "Tiendas/Lista_Mapa", {'page':false});
    } else if (footer=="tunel") {
        Inditex.trackPage( "Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador/Lista_Mapa"+extraPageview, {'page':false});
    }
}

function onClickMarcador(marcador, tiendaClickada) {

    for (var i = 0; i < mapa.iMarkers.length; i++ ) {
        mapa.iMarkers[i].setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png");
    }
    var pos = marcador.getPosition();
    var overlayProjection = tiendaTooltip.getProjection();
    if (overlayProjection!=null){
        var punto = overlayProjection.fromLatLngToContainerPixel(pos);
        punto.y = punto.y-TOOLTIP_OFFSET;
        pos = overlayProjection.fromContainerPixelToLatLng(punto)
    }


    marcador.setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png");
    mapa.iMap.panTo(pos);
    seleccionarTienda(tiendaClickada, document.getElementById(tiendaClickada.physicalStoreId));
    tiendaTooltip.setMap(mapa.iMap);
    $(tiendaTooltip.content).show();
}

function onClickMarcadorBaidu(marcador, tiendaClickada) {

    for (var i = 0; i < mapa.iMarkers.length; i++ ) {
        new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png",  new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight));
        mapa.iMarkers[i].setIcon(new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png",new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
    }
    var pos = marcador.getPosition();

    marcador.setIcon(new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png",new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
    seleccionarTienda(tiendaClickada, document.getElementById(tiendaClickada.physicalStoreId));
    tiendaTooltip.show();
    $(tiendaTooltip.content).show();
    mapa.iMap.panTo(pos);
}

function onClickMarcadorReserva(marcador, tiendaClickada, stockStore) {
    for (var i = 0; i < mapa.iMarkers.length; i++ ) {
        mapa.iMarkers[i].setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png");
    }

    var pos = marcador.getPosition();
    var overlayProjection = tiendaTooltip.getProjection();
    if (overlayProjection!=null){
        var punto = overlayProjection.fromLatLngToContainerPixel(pos);
        punto.y = punto.y-TOOLTIP_OFFSET;
        pos = overlayProjection.fromContainerPixelToLatLng(punto)
    }

    marcador.setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png");
    mapa.iMap.panTo(pos);
    seleccionarTiendaReserva(tiendaClickada, document.getElementById(tiendaClickada.id), stockStore);
    tiendaTooltip.setMap(mapa.iMap);
}



function onRemoveTooltip() {
    $(this.content).hide();
    //this.div_.parentNode.removeChild(this.div_);
    //this.div_ = null;
}

function onAddTooltip() {
    // alert("onAdd");
    // Create the DIV and set some basic attributes.
    var div = getTooltipHTML(tiendaSeleccionada);
    /* div.style.border = "none";
     div.style.borderWidth = "0px";
     div.style.position = "absolute";

     // Create an content element and attach it to the DIV.
     var content = document.createElement("span");
     content.innerHTML = this.content_;
     content.style.width = "100%";
     content.style.height = "100%";
     div.appendChild(content);
     //div.appendChild(content_);

     // Set the overlay's div_ property to this DIV
     this.div_ = div;


     // We add an overlay to a map via one of the map's panes.
     // We'll add this overlay to the overlayImage pane.
     var panes = this.getPanes();
     panes.overlayLayer.appendChild(div);*/
}

function onAddTooltipReserva() {
    // alert("onAdd");
    // Create the DIV and set some basic attributes.
    var div = getTooltipHTMLReserva(tiendaSeleccionada, stockStoreSeleccionada);
    /* div.style.border = "none";
     div.style.borderWidth = "0px";
     div.style.position = "absolute";

     // Create an content element and attach it to the DIV.
     var content = document.createElement("span");
     content.innerHTML = this.content_;
     content.style.width = "100%";
     content.style.height = "100%";
     div.appendChild(content);
     //div.appendChild(content_);

     // Set the overlay's div_ property to this DIV
     this.div_ = div;


     // We add an overlay to a map via one of the map's panes.
     // We'll add this overlay to the overlayImage pane.
     var panes = this.getPanes();
     panes.overlayLayer.appendChild(div);*/
}

/*
 function getTooltipHTMLReserva(tienda, stockSize){
 var tiendaName = "&nbsp;";
 var tiendaAddress = "&nbsp;";
 var tiendaPostalCode = "&nbsp;";
 var tiendaCity = "&nbsp;";
 var tiendaSections = "&nbsp;";
 var allowBooking=true;
 var recibeBooking="";

 var idPartNumber = $('#partNumber').attr('value');
 var lsPartNumberData = idPartNumber.split("-");
 var campaign = null;
 if(lsPartNumberData.length>0){
 campaign = lsPartNumberData[1];
 }

 var seasons = $("#iSeasonBooking").val().split(",");
 var allowSeason = true;
 if(seasons.length > 0 && $("#iSeasonBooking").val().length > 0 )
 allowSeason = seasons.indexOf(campaign)>=0;

 if (tienda!=null){
 tiendaName = tienda.name;
 tiendaPostalCode = tienda.zipCode;
 tiendaCity = tienda.city;
 tienda.sections = tienda.sections.replace("1",  seleccionarTiendaParams.sections1);
 tienda.sections = tienda.sections.replace("2",  seleccionarTiendaParams.sections2);
 tienda.sections = tienda.sections.replace("3",  seleccionarTiendaParams.sections3);
 tienda.sections = tienda.sections.replace(/,/g, " / ");
 tiendaSections = tienda.sections;
 tiendaAddress = tienda.addressLines[0];
 if (typeof (ITXBookingJson) != "undefined") {
 allowBooking = (ITXBookingJson.visibleBooking =="true" || ITXBookingJson.userAllowBooking == "true");
 }
 recibeBooking = tienda.receiveBooking;


 if (Inditex){
 var lsPartNumber = partNumber.split("-");
 var color = $('.active').attr('color_reserva');
 var partNumberColor = lsPartNumber[0] + color;
 Inditex.trackEvent('/Ficha_Producto', 'consultar_stock', "tienda_"+tienda.id+"/product_"+partNumberColor);
 }
 }

 $("#mapa_tooltip").find(".title_tooltip").html(tiendaName);
 $("#mapa_tooltip").find("#mCalle").html(tiendaAddress);
 $("#mapa_tooltip").find("#mCp").html(tiendaPostalCode + ' ' + tiendaCity);
 $("#mapa_tooltip").find("#mSeccion").html(tiendaSections);

 $("#mapa_tooltip").find(".tallaselector").html('');
 $("#mapa_tooltip").find(".tallaselector").html('<div class="size_holder title" style="height:65px;">Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size</div>');

 var tallasHtml="<div class='size_holder title'>"+Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size+"</div>";
 var catentryList = new Array() ;
 var contTallas = 0;		

 var q=0;
 var fila=0;

 var activo=$('.active').attr('color_reserva');

 for (var x = 0; x < productJSON.colors.length; x++) {

 if (productJSON.colors[x].idColor==activo) {

 for (var z = 0; z < productJSON.colors[x].sizes.length; z++) {


 if (stockSize != null) {
 for(var s = 0 ; s < stockSize.length; s++) {
 if (productJSON.colors[x].sizes[z].idTallaFied4==stockSize[s].size) {

 if (allowBooking==true && recibeBooking==true && stockSize[s].quantity > 0 && allowSeason==true) {
 tallasHtml+='<div class="size_holder';
 if(stockSize[s].quantity >= 3){
 tallasHtml+=' high';
 }else if(stockSize[s].quantity >= 1){
 tallasHtml+=' low';
 }
 tallasHtml+='"><a id="check_'+productJSON.colors[x].sizes[z].id+'" rel_input="'+productJSON.colors[x].sizes[z].id+'" class="check"></a><input style="visibility: hidden; position: absolute; width: 0px;" id="input_'+productJSON.colors[x].sizes[z].id+'" type="checkbox" value="'+productJSON.colors[x].sizes[z].id+'" desc="'+productJSON.colors[x].sizes[z].desc+'" partNumber="'+productJSON.colors[x].sizes[z].partNumber+'"><span>'+productJSON.colors[x].sizes[z].desc+'</span></div>';
 }
 else {
 tallasHtml+='<div class="size_holder nochecks';
 if(stockSize[s].quantity >= 3){
 tallasHtml+=' high';
 }else if(stockSize[s].quantity >= 1){
 tallasHtml+=' low';
 }else if(stockSize[s].quantity <= 0)
 tallasHtml+=' not_available';
 tallasHtml+='">'+productJSON.colors[x].sizes[z].desc+'<input type="checkbox" style="visibility: hidden;display:none;"></div>';
 }								
 }	
 }
 }

 fila++;
 }
 }
 }

 tallasHtml+='<br style="clear:both">';

 tallasHtml+='<div class="sizes_color_caption">';
 tallasHtml+=	'<ul>';
 tallasHtml+=		'<li>';
 tallasHtml+=			'<span class="high">high</span><p>'+Messages.highStock+'</p>';
 tallasHtml+=		'</li>';
 tallasHtml+=		'<li>';
 tallasHtml+=			'<span class="low">medium</span><p>'+Messages.lowStock+'</p>';
 tallasHtml+=		'</li>';
 tallasHtml+=		'<li>';
 tallasHtml+=			'<span class="not_available">low</span><p>'+Messages.withoutStock+'</p>';
 tallasHtml+=		'</li>';
 tallasHtml+=	'</ul>';
 tallasHtml+='</div>';
 tallasHtml+='<br style="clear:both">';

 $("#mapa_tooltip").find(".tallaselector").html(tallasHtml);


 if (allowBooking==true && recibeBooking==true && allowSeason==true) {

 //$(".tallaselector").hide();	
 $("#selectSize").show();

 }
 else {

 //$(".tallaselector").show();		
 $("#selectSize").hide();
 }

 if (allowBooking==true && recibeBooking==false) {

 $(".no_reserva_en_tienda").show();
 }
 else{

 $(".no_reserva_en_tienda").hide();
 }

 //Lo ocultamos siempre
 $(".no_reserva_en_tienda").hide();

 //Comportamientos

 $(".check").click(function() {

 var id=$(this).attr('rel_input');

 if ( $('#input_'+id).is(':checked') ) {

 $(this).removeClass ('active');
 $('#input_'+id).attr("checked", false);
 }
 else {

 $('#input_'+id).attr("checked", true);
 $(this).addClass ('active');
 }

 });		
 }
 */

function getTooltipHTMLReserva(tienda, stockSize){
    var tiendaName = "&nbsp;";
    var tiendaAddress = "&nbsp;";
    var tiendaPostalCode = "&nbsp;";
    var tiendaCity = "&nbsp;";
    var tiendaSections = "&nbsp;";
    var tiendaPhone = "&nbsp;";
    var allowBooking=true;
    var recibeBooking="";

    var idPartNumber = $('#partNumber').attr('value');
    var lsPartNumberData = idPartNumber.split("-");
    var campaign = null;
    if(lsPartNumberData.length>0){
        campaign = lsPartNumberData[1];
    }

    var seasons = $("#iSeasonBooking").val().split(",");
    var allowSeason = true;
    if(seasons.length > 0 && $("#iSeasonBooking").val().length > 0 )
        allowSeason = seasons.indexOf(campaign)>=0;

    if (tienda!=null){
        tiendaName = tienda.name;
        tiendaPostalCode = tienda.zipCode;
        tiendaCity = tienda.city;

        if (tienda.phones[0] != null && tienda.phones[0] != '') {
            tiendaPhone = tienda.phones[0];
        }
        tienda.sections = tienda.sections.replace("1",  seleccionarTiendaParams.sections1);
        tienda.sections = tienda.sections.replace("2",  seleccionarTiendaParams.sections2);
        tienda.sections = tienda.sections.replace("3",  seleccionarTiendaParams.sections3);
        tienda.sections = tienda.sections.replace(/,/g, " / ");
        tiendaSections = tienda.sections;
        tiendaAddress = tienda.addressLines[0];
        if (typeof (ITXBookingJson) != "undefined") {
            allowBooking = (ITXBookingJson.visibleBooking =="true" || ITXBookingJson.userAllowBooking == "true");
        }
        recibeBooking = tienda.receiveBooking;


        if (Inditex){
            var lsPartNumber = partNumber.split("-");
            var activo=$("li.color-thumb.selected").attr ("data-color-id");
            var partNumberColor = lsPartNumber[0] + activo;
        }
    }

    $("#mapa_tooltip").find(".title_tooltip").html(tiendaName);
    $("#mapa_tooltip").find("#mCalle").html(tiendaAddress);
    $("#mapa_tooltip").find("#mCp").html(tiendaPostalCode + ' ' + tiendaCity);
    $("#mapa_tooltip").find("#mTelefono").html(tiendaPhone);
    $("#mapa_tooltip").find("#mSeccion").html(tiendaSections);

    $("#mapa_tooltip").find(".tallaselector").html('');
    $("#mapa_tooltip").find(".tallaselector").html('<div class="size_holder title" style="height:65px;">Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size</div>');

    var tallasHtml="<div class='size_holder title'>"+Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size+"</div>";
    var catentryList = new Array() ;
    var contTallas = 0;

    var q=0;
    var fila=0;

    var activo=$("li.color-thumb.selected").attr ("data-color-id");

    for (var x = 0; x < Inditex.iXProductJSON.detail.colors.length; x++) {

        if (Inditex.iXProductJSON.detail.colors[x].id==activo) {

            for (var z = 0; z < Inditex.iXProductJSON.detail.colors[x].sizes.length; z++) {


                if (stockSize != null) {
                    for(var s = 0 ; s < stockSize.length; s++) {
                        if (Inditex.iXProductJSON.detail.colors[x].sizes[z].mastersSizeId==stockSize[s].size) {

                            if (allowBooking==true && recibeBooking==true && stockSize[s].quantity > 0 && allowSeason==true) {
                                tallasHtml+='<div class="size_holder';
                                if(stockSize[s].quantity >= 3){
                                    tallasHtml+=' high';
                                }else if(stockSize[s].quantity >= 1){
                                    tallasHtml+=' low';
                                }
                                //tallasHtml+='"><a id="check_'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" rel_input="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" class="check"></a><input style="visibility: hidden; position: absolute; width: 0px;" id="input_'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" type="checkbox" value="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" desc="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'" partNumber="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].partnumber+'"><span>'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'</span></div>';
                                tallasHtml+='"><input id="check_'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" type="radio" value="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].sku+'" desc="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'" partNumber="'+Inditex.iXProductJSON.detail.colors[x].sizes[z].partnumber+'" name="size"><span>'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'</span></div>';
                            }
                            else {
                                tallasHtml+='<div class="size_holder nochecks';
                                if(stockSize[s].quantity >= 3){
                                    tallasHtml+=' high';
                                }else if(stockSize[s].quantity >= 1){
                                    tallasHtml+=' low';
                                }else if(stockSize[s].quantity <= 0)
                                    tallasHtml+=' not_available';
                                //tallasHtml+='">'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'<input type="checkbox" style="visibility: hidden;display:none;"></div>';
                                tallasHtml+='">'+Inditex.iXProductJSON.detail.colors[x].sizes[z].name+'</div>';
                            }
                        }
                    }
                }

                fila++;
            }
        }
    }

    tallasHtml+='<br style="clear:both">';

    tallasHtml+='<div class="sizes_color_caption">';
    tallasHtml+=	'<ul>';
    tallasHtml+=		'<li>';
    tallasHtml+=			'<span class="high">high</span><p>'+Messages.highStock+'</p>';
    tallasHtml+=		'</li>';
    tallasHtml+=		'<li>';
    tallasHtml+=			'<span class="low">medium</span><p>'+Messages.lowStock+'</p>';
    tallasHtml+=		'</li>';
    tallasHtml+=		'<li>';
    tallasHtml+=			'<span class="not_available">low</span><p>'+Messages.withoutStock+'</p>';
    tallasHtml+=		'</li>';
    tallasHtml+=	'</ul>';
    tallasHtml+='</div>';
    tallasHtml+='<br style="clear:both">';

    $("#mapa_tooltip").find(".tallaselector").html(tallasHtml);


    if (allowBooking==true && recibeBooking==true && allowSeason==true) {

        //$(".tallaselector").hide();	
        $("#selectSize").show();

    }
    else {

        //$(".tallaselector").show();		
        $("#selectSize").hide();
    }

    if (allowBooking==true && recibeBooking==false) {

        $(".no_reserva_en_tienda").show();
    }
    else{

        $(".no_reserva_en_tienda").hide();
    }

    //Lo ocultamos siempre
    $(".no_reserva_en_tienda").hide();

    //Comportamientos
    loadRadiosAndChecksNew(false);
    /*$(".check").click(function() {

     var id=$(this).attr('rel_input');

     if ( $('#input_'+id).is(':checked') ) {
     //if ( $('#input_'+id).attr('checked')!=undefined &&  $('#input_'+id).attr('checked')=="checked" ) {

     $(this).removeClass ('active');
     $('#input_'+id).attr("checked", false);
     }
     else {

     $(this).addClass ('active');
     $('#input_'+id).attr("checked", true);
     }

     });	*/
}

function getTooltipHTML(tienda){
    var tiendaName = "&nbsp;";
    //var tiendaAddress = "&nbsp;";
    var tiendaPostalCode = "&nbsp;";
    var tiendaCity = "&nbsp;";
    var tiendaSections = "&nbsp;";

    if (tienda!=null){
        tiendaName = tienda.name;
        tiendaPostalCode = tienda.postalCode;
        tiendaCity = tienda.city;
        tienda.sections = tienda.sections.replace("1",  seleccionarTiendaParams.sections1);
        tienda.sections = tienda.sections.replace("2",  seleccionarTiendaParams.sections2);
        tienda.sections = tienda.sections.replace("3",  seleccionarTiendaParams.sections3);
        tienda.sections = tienda.sections.replace(/,/g, " / ");
        tiendaSections = tienda.sections;
        tiendaAddress = tienda.address;
    }
    //$("#mapa_tooltip").find(".title_tooltip").html(tiendaName);
    $("#mapa_tooltip").find("#mCalle").html(tiendaName);
    $("#mapa_tooltip").find("#mCp").html(tiendaPostalCode + ' ' + tiendaCity);
    $("#mapa_tooltip").find("#mSeccion").html(tiendaSections);
    // var mapaTooltipDiv = document.getElementById("mapa_tooltip");
    // var closeModal = document.createElement("a");
    // closeModal.href="javascript:void(0)";
    // closeModal.className="close_modal";
    // closeModal.innerHTML="&nbsp;";
    // mapaTooltipDiv.appendChild(closeModal);
// 		
    // var p = document.createElement("p");
    // p.className="title_tooltip";
    // p.innerHTML=tienda.name;
    // mapaTooltipDiv.appendChild(p);
// 		
    // p = document.createElement("p");
    // p.innerHTML=tienda.address;
    // mapaTooltipDiv.appendChild(p);
// 		
    // p = document.createElement("p");
    // p.innerHTML=tienda.postalCode+" "+tienda.city;
    // mapaTooltipDiv.appendChild(p);
// 		
    // p = document.createElement("p");
    // p.innerHTML=tienda.postalCode;
    // mapaTooltipDiv.appendChild(p);
// 		
    // return mapaTooltipDiv;
}

function hideTiendaTooltip(){
    $(tiendaTooltip.content).hide();
}


/** Funcion que no retonar la respuesta de Servidor en un JSON **/
function getResponseJSONBuscadorTienda(respHtml) {
    var type = typeof respHtml;
    var dataJSON = null;
    if (type == 'string') {
        dataJSON = jQuery.parseJSON(respHtml);
    } else {
        dataJSON = respHtml;
    }
    return dataJSON;
}

function enviarFormularioReserva () {
    $("#tramitarReserva").get(0).onclick=null;
    var fullName = $("#formTramitarReserva #fullName").val();
    var email = $("#formTramitarReserva #email").val();
    var phone = $("#formTramitarReserva #phoneNumber").val();
    var captcha = $("#formTramitarReserva #capchaBooking").val();

    var numAllBookingItems = $('input[name=bookingStoreItems_bamStoreId]').length;

    var bamStoreId = new Array();
    var catentryId = new Array();
    var unitsOrdered = new Array();

    for (var i =0; i < numAllBookingItems; i++) {
        bamStoreId.push($("#bookingStoreItems_" + i + "_bamStoreId").val());
        unitsOrdered.push($("#bookingStoreItems_" + i + "_unitsOrdered").val());
        catentryId.push($("#bookingStoreItems_" + i + "_catentryId").val());
    }

    Inditex.getRestBookingAddBookingCmd({
        captcha: captcha,
        email: email,
        fullName: fullName,
        phone: phone,
        bamStoreId: bamStoreId,
        catentryId: catentryId,
        unitsOrdered: unitsOrdered,
        onSuccess: function(aJson) {
            if ((aJson) && ((aJson.errorKey==undefined) || (aJson.errorKey==null))) {
                var titulo  = $('#tituloReservaOK').attr('value');
                var mensaje  = $('#mensajeReservaOK').attr('value');
                //openFormModal('includes/modales/confirmaReserva.html',null,null,null,0.1);
                var partNumbers = $('#partNumbers').val();
                Inditex.trackEvent( 'Consulta_stock','Reserva_confirmacion_ok',partNumbers,true);
                Inditex.trackPage( 'Ficha_producto/'+partNumber+'/Consulta_stock/Reservar_talla/Confirmada',{'page':false});
                openStaticModal(titulo, mensaje, false, function(){
                    Inditex.trackEvent( 'Consulta_stock','Aceptar_y_cerrar',partNumbers,{'page':'Ficha_producto/'+partNumber+'/Consulta_stock/Reservar_talla/Confirmada'});
                });
            } else {
                var titulo  = $('#tituloReservaKO').attr('value');
                var mensaje  = $('#errorGenerico').attr('value');
                //mostrarMensaje(mensaje);
                Inditex.trackEvent( 'Consulta_stock','Reserva_confirmacion_error',Inditex.codeError(aJson.errorKey,aJson.errorMessage),true);
                openStaticModal(titulo, mensaje, false);
            }
        },
        onFailure: function(aStatus) {
            var titulo  = $('#tituloReservaKO').attr('value');
            var mensaje  = $('#errorGenerico').attr('value');
            //mostrarMensaje(mensaje);
            Inditex.trackEvent( 'Consulta_stock','Reserva_confirmacion_error',Inditex.codeError(aStatus,mensaje),true);
            openStaticModal('', mensaje, false);
        }
    });


}
;
/* END /DuttiNEWStorefrontAssetStore/js/seleccionarTienda.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/newsletter.js (en_US) */
function initNewsletter(){

    $("#suscripcionForm").validate({
        submitHandler : function(form) {
            var form = $("#suscripcionForm");
            var ploy = $('#politica').val();
            var valPoly = 'false';
            if (ploy == 'on') {
                valPoly = 'true';
            }

            jQuery.xajax({
                url: form.attr("action") + '&privacyPolicy=' + valPoly,
                type: 'post',
                data: form.serialize(),
                success: function(data) {
                    var dataJSON = getResponseJSON(data);

                    if (dataJSON.type == "OK") {
                        openStaticModal(Messages.contacta_newsletter_alta_titulo, Messages.contacta_newsletter_alta_mensaje, false);
                        Inditex.trackEvent( "Menu","Newsletter_alta_ok",null,true);
                    } else {
                        openStaticModal(Messages.contacta_newsletter_alta_titulo, dataJSON.mensaje, false);
                        Inditex.trackEvent( "Menu","Newsletter_alta_error",Inditex.codeError(dataJSON.type,dataJSON.mensaje),true);
                    }
                },
                error: function(xhr){
                    Inditex.trackEvent( "Menu","Newsletter_alta_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                }
            });
        },
        rules : {
            politica:"required",
            mail : {
                required : true,
                email : true
            }
        },
        messages : {
            mail : Messages.contacta_newsletter_validar_email
        }
    });

    $("#bajaSuscripcionForm").validate({
        submitHandler : function(form) {
            var form = $("#bajaSuscripcionForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                data: form.serialize(),
                success: function(data) {
                    var dataJSON = getResponseJSON(data);

                    if (dataJSON.type == "OK") {
                        openStaticModal(Messages.contacta_newsletter_baja_titulo, Messages.contacta_newsletter_baja_mensaje, false);
                        Inditex.trackEvent( "Menu","Newsletter_baja_ok",null,true);
                    } else {
                        openStaticModal(Messages.contacta_newsletter_baja_titulo, dataJSON.mensaje, false);
                        Inditex.trackEvent( "Menu","Newsletter_baja_error",Inditex.codeError(dataJSON.type,dataJSON.mensaje),true);
                    }
                }
            });
        },
        rules : {
            mail : {
                required : true,
                email : true
            }
        },
        messages : {
            mail : Messages.contacta_newsletter_validar_email
        }
    })

}


/** Funcion que no retonar la respuesta de Servidor en un JSON **/
function getResponseJSON(respHtml) {
    var type = typeof respHtml;
    var dataJSON = null;
    if (type == 'string') {
        dataJSON = jQuery.parseJSON(respHtml);
    } else {
        dataJSON = respHtml;
    }
    return dataJSON;
}
;
/* END /DuttiNEWStorefrontAssetStore/js/newsletter.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/novedades.js (en_US) */
function initNovedades(){
    $("#arbol ul li").each(function(){
        $(this).bind('click',function(){
            activo = $("#arbol ul li.activo");
            //Ahora mismo siempre es el mismo el activo que el clickado, porque el overlay no permite clickar otro, pero lo dejo preparado por si en un futuro se permite.
            if(activo[0] != $(this)[0]){
                $('#s_overlay').fadeOut();
                resizeFold(activo, $(this));
                Inditex.trackEvent( "Noticias","noticia_"+($(this).index()+1),null,true);
            }
        });
    });

    $("#arbol ul li .close").each(function(){
        $(this).bind('click',function(){
            $('#s_overlay').fadeOut();
            resizeFold($("#arbol ul li.activo"),$(this).parent().parent());
            Inditex.trackEvent( "Noticias","noticia_"+($(this).closest("li").index()+1),"cerrar",true);
        })
    });
}


function resizeFold(activo, element){

    widthFolded =  activo.attr('wf');
    heightFolded = activo.attr('hf');


    //La llamada al showElement es para mostrar el elemento clickado una vez ocultado el actual. Ahora mismo no puede darse el caso, pero queda listo para un futuro			
    //Si se tiene que encoger a lo ancho ...
    if(widthFolded > 0)
        activo.find(".capa").animate({width: widthFolded + 'px'}, 'slow', function(){ activo.find(".descripcion").hide();element.find(".close").hide();activo.removeClass('activo');showElement(element,activo);});
    //... a lo alto ...
    else if (heightFolded > 0)
        activo.find(".capa").animate({height: heightFolded + 'px'}, 'slow', function(){ activo.find(".descripcion").hide();element.find(".close").hide();activo.removeClass('activo');showElement(element,activo);});
    //.. y si es la primera vez simplemente mostramos el clickado
    else showElement(element,activo);



}

function resizeUnfold(element){
    $("#menu").css({'z-index':0});
    widthUnFolded =  element.attr('wu');
    heightUnFolded = element.attr('hu');

    if(widthUnFolded > 0)
        element.find(".capa").animate({width: widthUnFolded + 'px'}, 'slow', function(){element.find(".descripcion").show();element.find(".descripcion").jScrollPane();element.find(".close").show();});
    else
        element.find(".capa").animate({height: heightUnFolded + 'px'}, 'slow', function(){element.find(".descripcion").show();element.find(".descripcion").jScrollPane();element.find(".close").show();});

}

function showElement(element, activo){
    if(element[0] != activo[0]){
        element.addClass('activo');
        resizeUnfold($(element));
        addOverlay(element);
    }

}


function addOverlay(element){
    if(isIPad() && !isIPad_5()){
        $('body').height(document.height);
    }

    $('#s_overlay').remove();
    $('<div/>', {
        'id' : 's_overlay',
        'class' : 'transp',
        'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
    }).appendTo(element.parent());
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#s_overlay');
    //$("#s_overlay").html(ul);
    $('#s_overlay').css('left', 0).fadeIn(
        function() {
            $('#close_overlay').bind('click', function() {
                $(".activo .close").click();
                // $('#s_overlay').fadeOut(function() {
// 				
                // // $(this).remove();
                // // if(changeOverflow) {
                // // $('body , html').css('overflow', 'visible');
                // // }
                // })
            });
        }
    );

    if(isIPad() && !isIPad_5()){
        $('#s_overlay').css({'position':'absolute'});
        $('#s_overlay').css({'left':'-250px'});
        $('#s_overlay').css({'width': document.width + 'px !important'});
    }


}
;
/* END /DuttiNEWStorefrontAssetStore/js/novedades.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/contacto.js (en_US) */



function initContacto(typeContact, urlContactOnline, urlContactStore, urlContactView){



    if (typeContact == 1 || typeContact == null) {
        drawOldContactOnline();
        validateOldContactOnline(urlContactOnline);
    }

    if (typeContact == 2) {
        drawOldContactStore();
        validateOldContactStore(urlContactStore, urlContactView);
    }

    if (typeContact == 3) {
        drawContact();
        validateContact(urlContactOnline, urlContactStore, urlContactView);
    }

    $("#limpiar").bind("click", function(){
        //Borro todos los input menos el prefijo que le pongo su valor por defecto
        $('input[type=text]').each(function(){
            if ($(this).attr('id') == "phonePrefix") {
                $(this).val(DUTTI_PREFIX_STORE);
            } else {
                $(this).val('');
            }
        });
        $('textarea').each(function(){
            $(this).val('');
        });

        changeCustomSelect($(".md-select-ul li[v=]"), $("#descrMotivoForm"));
    });


    $("#enviar").bind("click", function(){
        $("#descrMotivoForm").submit();
    });

}

function drawOldContactOnline() {
    var contenido = $('#contentContactDinamic');

    var title = $('<p class="title">' + msgContact["title"]  + '</p>');
    contenido.append(title);

    var formulario = $('<form id="descrMotivoForm" action="" accept-charset="UTF-8" method="post" onsubmit="javascript:prepararTelefono()"></form>');
    contenido.append(formulario);


    var rowName = $('<div class="row"></div>');
    formulario.append(rowName);
    var rowNameBlock= $('<div class="block"></div>');
    rowName.append(rowNameBlock);
    var rowNameBlockLabel = $('<label>'+ msgContact["name"] + '</label>');
    var rowNameBlockInput = $('<input type="text" id="name" name="name" />');
    rowNameBlock.append(rowNameBlockLabel);
    rowNameBlock.append(rowNameBlockInput);

    var rowSurNameBlockSin= $('<div class="block sin"></div>');
    rowName.append(rowSurNameBlockSin);
    var rowSurNameBlockLabel = $('<label>'+ msgContact["surname"] + '</label>');
    var rowSurNameBlockInput = $('<input type="text" id="surname" name="surname" />');
    rowSurNameBlockSin.append(rowSurNameBlockLabel);
    rowSurNameBlockSin.append(rowSurNameBlockInput);

    var rowPhone = $('<div class="row"></div>');
    formulario.append(rowPhone);
    var rowPhoneBlock= $('<div class="block telefono"></div>');
    rowPhone.append(rowPhoneBlock);
    var rowPhoneBlockLabel = $('<label>'+ msgContact["phone"] + '</label>');
    var rowPhoneBlockInputPre = $('<input type="text" id="phone1Prefix" name="phone1Prefix" class="prefijo" value="'+ DUTTI_PREFIX_STORE +'"/>');
    var rowPhoneBlockInputPhono = $('<input type="text" id="phone1" name="phone1" class="telefono" value=""/>');
    var rowPersonPhoneBlock1InputHiddenPhono = $('<input type="hidden" id="phone1Complet" name="phone1Complet" class="telefono"/>');
    var rowPhoneBlockError = $('<p class="error" for="prefijo" style="display: none;margin-top: 10px;"></p>');
    rowPhoneBlock.append(rowPhoneBlockLabel);
    rowPhoneBlock.append(rowPhoneBlockInputPre);
    rowPhoneBlock.append(rowPhoneBlockInputPhono);
    rowPhoneBlock.append(rowPersonPhoneBlock1InputHiddenPhono);
    rowPhoneBlock.append(rowPhoneBlockError);

    var rowEmailBlockSin= $('<div class="block sin"></div>');
    rowPhone.append(rowEmailBlockSin);
    var rowEmailBlockLabel = $('<label>'+ msgContact["email"] + '</label>');
    var rowEmailBlockInput = $(' <input type="text" id="email" name="email" />');
    rowEmailBlockSin.append(rowEmailBlockLabel);
    rowEmailBlockSin.append(rowEmailBlockInput);


    var rowTema= $('<div class="row hg55"></div>');
    formulario.append(rowTema);
    var rowTemaBlock= $('<div class="block zindex"></div>');
    rowTema.append(rowTemaBlock);
    var rowTemaBlockLabel = $('<label>'+ msgContact["theme"] + '</label>');
    rowTemaBlock.append(rowTemaBlockLabel);
    var rowTemaBlockDivSelect = $('<div class="multidrop single tunelcuenta" title="'+ msgContact["optionOnlinetheme"] + '"></div>');
    rowTemaBlock.append(rowTemaBlockDivSelect);
    var rowTemaBlockSelect = $('<select id="tema" name="comboTopicHidden" title="'+ msgContact["optionOnlinetheme"] + '" ></select>');
    rowTemaBlockDivSelect.append(rowTemaBlockSelect);
    var rowTemaBlockOptionDefualt = $('<option value="">'+ msgContact["optionOnlinetheme"] + '</option>');
    var rowTemaBlockOptionHelp = $('<option value="HELP">'+ msgContact["optionOnlineHelp"] + '</option>');
    var rowTemaBlockOptionCustomer = $('<option value="CUSTOMER">'+ msgContact["optionOnlineCustomer"] + '</option>');
    var rowTemaBlockOptionOrder = $('<option value="ORDERS">'+ msgContact["optionOnlineOrder"] + '</option>');
    var rowTemaBlockOptionProduct = $('<option value="PRODUCT">'+ msgContact["optionOnlineProduct"] + '</option>');
    rowTemaBlockSelect.append(rowTemaBlockOptionDefualt);
    rowTemaBlockSelect.append(rowTemaBlockOptionHelp);
    rowTemaBlockSelect.append(rowTemaBlockOptionCustomer);
    rowTemaBlockSelect.append(rowTemaBlockOptionOrder);
    rowTemaBlockSelect.append(rowTemaBlockOptionProduct);

    var rowTemaP = $('<p for="tema" class="error" style="display:none;margin-top:22px;">'+ msgContact["msgtema"] + '"</p>');
    rowTema.append(rowTemaP);


    var rowAsunto= $('<div class="row"></div>');
    formulario.append(rowAsunto);
    var rowAsuntoBlock= $('<div class="block all"></div>');
    rowAsunto.append(rowAsuntoBlock);
    var rowAsuntoBlockLabel = $('<label>'+ msgContact["subject"] + '</label>');
    var rowAsuntoBlockInput = $('<input type="text" id="subject" name="subject" />');
    rowAsuntoBlock.append(rowAsuntoBlockLabel);
    rowAsuntoBlock.append(rowAsuntoBlockInput);


    var rowMensaje= $('<div class="row"></div>');
    formulario.append(rowMensaje);
    var rowMensajeBlock= $('<div class="block txtrea"></div>');
    rowMensaje.append(rowMensajeBlock);
    var rowMensajeBlockLabel = $('<label>'+ msgContact["msg"] + '</label>');
    var rowMensajeBlockInput = $(' <textarea name="note" id="note" rows="0" cols="0"></textarea>');
    rowMensajeBlock.append(rowMensajeBlockLabel);
    rowMensajeBlock.append(rowMensajeBlockInput);

    var rowTextObligatorio = $('<span class="info_campo">' + msgContact["obligatory"] + '</span>');
    formulario.append(rowTextObligatorio);

    var urlPrivacyPolicy = Inditex.generateUrl('PrivacyPolicy',
        {
            "storeId"			: Inditex.iStoreId,
            "langId"			: Inditex.iLangId,
            "catalogId"			: Inditex.iCatalogId
        },
        true
    );


    var rowPoliticaBlock = $('<div class="rowPol"></div>');
    formulario.append(rowPoliticaBlock);
    var rowPoliticaBlockInput = $('<input type="checkbox" name="privacy" id="privacy"/>');
    var rowPoliticaBlockLabel = $('<label>' + msgContact["privacy1"] + ' <a onclick="openGenericModal(\'' +urlPrivacyPolicy + '\',[\'scrollable\',\'general_modal_sec\'], addScroll, null, 0.8, true);" href="javascript:void(0)">' + msgContact["privacy2"] + '</a></label>');
    var rowPoliticaBlockInputError = $('<p for="privacy" class="error" style="display:none;">' + msgContact["privacy3"] + '</p>');
    rowPoliticaBlock.append(rowPoliticaBlockInput);
    rowPoliticaBlock.append(rowPoliticaBlockLabel);
    rowPoliticaBlock.append(rowPoliticaBlockInputError);

    var inputSubmit = $('<input type="submit" style="float:right;height:1px;right:1003px;width:1px;height:1px;position:absolute;" />');
    formulario.append(inputSubmit);

    var rowAcciones = $('<div class="boton" style="margin-top:5px;"></div>');
    formulario.append(rowAcciones);
    var rowAccionesHrefSend = $('<a href="javascript:void(0)" class="acc_butt" id="enviar">'+ msgContact["send"] + '</a>');
    var rowAccionesHrefClear = $('<a href="javascript:void(0)" class="acc_butt" id="limpiar">'+ msgContact["clear"] + '</a>');
    rowAcciones.append(rowAccionesHrefSend);
    rowAcciones.append(rowAccionesHrefClear);

    loadRadiosAndChecks();
}

function drawOldContactStore() {
    var contenido = $('#contentContactDinamic');

    var title = $('<p class="title">' + msgContact["title"]  + '</p>');
    contenido.append(title);



    var formulario = $('<form id="descrMotivoForm" action="" accept-charset="UTF-8" method="post" onsubmit="javascript:prepararTelefono()"></form>');
    contenido.append(formulario);


    var hiddenViewname = $('<input type="hidden" name="viewname" value="ItxResponseJSON" />');
    var hiddenViewTaskname = $('<input type="hidden" name="viewTaskName" value="ItxResponseJSON" />');
    var hiddenErrorViewname = $('<input type="hidden" name="errorViewName" value="ItxResponseJSON" />');
    var hiddenIdBuzon = $('<input type="hidden" name="id_buzon" value="8" />');
    var hiddenExisto = $('<input type="hidden" name="exito" value="${ResponseJSON}" />');
    var hiddenIdioma = $('<input type="hidden" name="lenguaje" value="" />');
    var hiddenIdPais = $('<input type="hidden" name="id_pais" value="" />');


    formulario.append(hiddenViewname);
    formulario.append(hiddenViewTaskname);
    formulario.append(hiddenErrorViewname);
    formulario.append(hiddenIdBuzon);
    formulario.append(hiddenExisto);
    formulario.append(hiddenIdioma);
    formulario.append(hiddenIdPais);


    var rowName = $('<div class="row"></div>');
    formulario.append(rowName);
    var rowNameBlock= $('<div class="block"></div>');
    rowName.append(rowNameBlock);
    var rowNameBlockLabel = $('<label>'+ msgContact["name"] + '</label>');
    var rowNameBlockInput = $('<input type="text" id="name" name="name" />');
    rowNameBlock.append(rowNameBlockLabel);
    rowNameBlock.append(rowNameBlockInput);

    var rowSurNameBlockSin= $('<div class="block sin"></div>');
    rowName.append(rowSurNameBlockSin);
    var rowSurNameBlockLabel = $('<label>'+ msgContact["surname"] + '</label>');
    var rowSurNameBlockInput = $('<input type="text" id="surname" name="surname" />');
    rowSurNameBlockSin.append(rowSurNameBlockLabel);
    rowSurNameBlockSin.append(rowSurNameBlockInput);

    var rowPhone = $('<div class="row"></div>');
    formulario.append(rowPhone);
    var rowPhoneBlock= $('<div class="block telefono"></div>');
    rowPhone.append(rowPhoneBlock);
    var rowPhoneBlockLabel = $('<label>'+ msgContact["phone"] + '</label>');
    var rowPhoneBlockInputPre = $('<input type="text" id="phone1Prefix" name="phone1Prefix" class="prefijo" value="'+ DUTTI_PREFIX_STORE +'"/>');
    var rowPhoneBlockInputPhono = $('<input type="text" id="phone1" name="phone1" class="telefono" value="" />');
    var rowPersonPhoneBlock1InputHiddenPhono = $('<input type="hidden" id="phone1Complet" name="phone1Complet" class="telefono"/>');
    var rowPhoneBlockError = $('<p class="error" for="prefijo" style="display: none;margin-top: 10px;"></p>');
    rowPhoneBlock.append(rowPhoneBlockLabel);
    rowPhoneBlock.append(rowPhoneBlockInputPre);
    rowPhoneBlock.append(rowPhoneBlockInputPhono);
    rowPhoneBlock.append(rowPersonPhoneBlock1InputHiddenPhono);
    rowPhoneBlock.append(rowPhoneBlockError);

    var rowEmailBlockSin= $('<div class="block sin"></div>');
    rowPhone.append(rowEmailBlockSin);
    var rowEmailBlockLabel = $('<label>'+ msgContact["email"] + '</label>');
    var rowEmailBlockInput = $(' <input type="text" id="email" name="email" />');
    rowEmailBlockSin.append(rowEmailBlockLabel);
    rowEmailBlockSin.append(rowEmailBlockInput);


    var rowTema= $('<div class="row hg55"></div>');
    formulario.append(rowTema);
    var rowTemaBlock= $('<div class="block zindex"></div>');
    rowTema.append(rowTemaBlock);
    var rowTemaBlockLabel = $('<label>'+ msgContact["theme"] + '</label>');
    rowTemaBlock.append(rowTemaBlockLabel);
    var rowTemaBlockDivSelect = $('<div class="multidrop single tunelcuenta" title="'+ msgContact["optionOnlinetheme"] + '"></div>');
    rowTemaBlock.append(rowTemaBlockDivSelect);
    var rowTemaBlockSelect = $('<select id="tema" name="comboTopicHidden" title="'+ msgContact["optionOnlinetheme"] + '" ></select>');
    rowTemaBlockDivSelect.append(rowTemaBlockSelect);
    var rowTemaBlockOptionDefualt = $('<option value="">'+ msgContact["optionOnlinetheme"] + '</option>');
    var rowTemaBlockOption1 = $('<option value="1">'+ msgContact["optionStore64"] + '</option>');
    var rowTemaBlockOption2 = $('<option value="2">'+ msgContact["optionStore65"] + '</option>');
    var rowTemaBlockOption3 = $('<option value="3">'+ msgContact["optionStore66"] + '</option>');
    var rowTemaBlockOption4 = $('<option value="4">'+ msgContact["optionStore67"] + '</option>');
    var rowTemaBlockOption5 = $('<option value="5">'+ msgContact["optionStore68"] + '</option>');
    var rowTemaBlockOption6 = $('<option value="6">'+ msgContact["optionStore69"] + '</option>');
    var rowTemaBlockOption7 = $('<option value="7">'+ msgContact["optionStore70"] + '</option>');
    var rowTemaBlockOption8 = $('<option value="8">'+ msgContact["optionStore71"] + '</option>');
    var rowTemaBlockOption9 = $('<option value="9">'+ msgContact["optionStore72"] + '</option>');
    rowTemaBlockSelect.append(rowTemaBlockOptionDefualt);
    rowTemaBlockSelect.append(rowTemaBlockOption1);
    rowTemaBlockSelect.append(rowTemaBlockOption2);
    rowTemaBlockSelect.append(rowTemaBlockOption3);
    rowTemaBlockSelect.append(rowTemaBlockOption4);
    rowTemaBlockSelect.append(rowTemaBlockOption5);
    rowTemaBlockSelect.append(rowTemaBlockOption6);
    rowTemaBlockSelect.append(rowTemaBlockOption7);
    rowTemaBlockSelect.append(rowTemaBlockOption8);
    rowTemaBlockSelect.append(rowTemaBlockOption9);

    var rowTemaP = $('<p for="tema" class="error" style="display:none;margin-top:22px;">'+ msgContact["msgtema"] + '"</p>');
    rowTema.append(rowTemaP);


    var rowAsunto= $('<div class="row"></div>');
    formulario.append(rowAsunto);
    var rowAsuntoBlock= $('<div class="block all"></div>');
    rowAsunto.append(rowAsuntoBlock);
    var rowAsuntoBlockLabel = $('<label>'+ msgContact["subject"] + '</label>');
    var rowAsuntoBlockInput = $('<input type="text" id="subject" name="subject" />');
    rowAsuntoBlock.append(rowAsuntoBlockLabel);
    rowAsuntoBlock.append(rowAsuntoBlockInput);


    var rowMensaje= $('<div class="row"></div>');
    formulario.append(rowMensaje);
    var rowMensajeBlock= $('<div class="block txtrea"></div>');
    rowMensaje.append(rowMensajeBlock);
    var rowMensajeBlockLabel = $('<label>'+ msgContact["msg"] + '</label>');
    var rowMensajeBlockInput = $(' <textarea name="note" id="note" rows="0" cols="0"></textarea>');
    rowMensajeBlock.append(rowMensajeBlockLabel);
    rowMensajeBlock.append(rowMensajeBlockInput);

    var rowTextObligatorio = $('<span class="info_campo">' + msgContact["obligatory"] + '</span>');
    formulario.append(rowTextObligatorio);

    var urlPrivacyPolicy = Inditex.generateUrl('PrivacyPolicy',
        {
            "storeId"			: Inditex.iStoreId,
            "langId"			: Inditex.iLangId,
            "catalogId"			: Inditex.iCatalogId
        },
        true
    );

    var rowPoliticaBlock = $('<div class="rowPol"></div>');
    formulario.append(rowPoliticaBlock);
    var rowPoliticaBlockInput = $('<input type="checkbox" name="privacy" id="privacy"/>');
    var rowPoliticaBlockLabel = $('<label>' + msgContact["privacy1"] + ' <a onclick="openGenericModal(\'' +urlPrivacyPolicy + '\',[\'scrollable\',\'general_modal_sec\'], addScroll, null, 0.8, true);" href="javascript:void(0)">' + msgContact["privacy2"] + '</a></label>');
    var rowPoliticaBlockInputError = $('<p for="privacy" class="error" style="display:none;">' + msgContact["privacy3"] + '</p>');
    rowPoliticaBlock.append(rowPoliticaBlockInput);
    rowPoliticaBlock.append(rowPoliticaBlockLabel);
    rowPoliticaBlock.append(rowPoliticaBlockInputError);

    var inputSubmit = $('<input type="submit" style="float:right;height:1px;right:1003px;width:1px;height:1px;position:absolute;" />');
    formulario.append(inputSubmit);

    var rowAcciones = $('<div class="boton" style="margin-top:5px;"></div>');
    formulario.append(rowAcciones);
    var rowAccionesHrefSend = $('<a href="javascript:void(0)" class="acc_butt" id="enviar">'+ msgContact["send"] + '</a>');
    var rowAccionesHrefClear = $('<a href="javascript:void(0)" class="acc_butt" id="limpiar">'+ msgContact["clear"] + '</a>');
    rowAcciones.append(rowAccionesHrefSend);
    rowAcciones.append(rowAccionesHrefClear);

    loadRadiosAndChecks();
}

function drawContact() {

    var scrollable = $('<div id="scrollable"></div>');

    var contenido = $('#contentContactDinamic');

    var title = $('<p class="title data-ga-logic-universal" data-ga-logic-universal="/Menu/Contacta/Email/Formulario">' + msgContact["title"]  + '</p>');
    scrollable.append(title);

    var formulario = $('<form id="descrMotivoForm" action="" accept-charset="UTF-8" method="post" onsubmit="javascript:prepararTelefono()"></form>');
    scrollable.append(formulario);

    var rowOption = $('<div class="row"></div>');
    formulario.append(rowOption);
    //var rowOptionMotivo = $('<input type="hidden" name="motive" />');
    //rowOption.append(rowOptionMotivo);

    if (Inditex.iStoreJSON.isOpenForSale) {
        var rowOptionBlockOnline= $('<div class="block list"></div>');
        rowOption.append(rowOptionBlockOnline);
        var rowOptionBlockOnlineTitle = $('<span>'+ msgContact["titleOnline"] + '</span>');
        rowOptionBlockOnline.append(rowOptionBlockOnlineTitle);


        var optionUlOnline = $('<ul></ul>');
        rowOptionBlockOnline.append(optionUlOnline);
        var optionLiHelpOnline = $('<li></li>');
        optionUlOnline.append(optionLiHelpOnline);
        var optionLiHelpRadioOnline = $('<input type="radio" id="buying_process" name="motive" value="0" />');
        var optionLiHelpLabelOnline = $('<label>'+ msgContact["optionOnline0"] + '</label>');
        optionLiHelpOnline.append(optionLiHelpRadioOnline);
        optionLiHelpOnline.append(optionLiHelpLabelOnline);

        var optionLiTrackingOnline = $('<li></li>');
        optionUlOnline.append(optionLiTrackingOnline);
        var optionLiTrackingRadioOnline = $('<input type="radio" id="order_tracking" name="motive" value="1" />');
        var optionLiTrackingLabelOnline = $('<label>'+ msgContact["optionOnline1"] + '</label>');
        optionLiTrackingOnline.append(optionLiTrackingRadioOnline);
        optionLiTrackingOnline.append(optionLiTrackingLabelOnline);

        var optionLiProductOnline = $('<li></li>');
        optionUlOnline.append(optionLiProductOnline);
        var optionLiProductRadioOnline = $('<input type="radio" id="item_availability_on" name="motive" value="2" />');
        var optionLiProductLabelOnline = $('<label>'+ msgContact["optionOnline2"] + '</label>');
        optionLiProductOnline.append(optionLiProductRadioOnline);
        optionLiProductOnline.append(optionLiProductLabelOnline);

        var optionLiCommentsOnline = $('<li></li>');
        optionUlOnline.append(optionLiCommentsOnline);
        var optionLiCommentsRadioOnline = $('<input type="radio" id="comments_on" name="motive" value="3" />');
        var optionLiCommentsLabelOnline = $('<label>'+ msgContact["optionOnline3"] + '</label>');
        optionLiCommentsOnline.append(optionLiCommentsRadioOnline);
        optionLiCommentsOnline.append(optionLiCommentsLabelOnline);
    }

    var rowOptionBlockTienda= $('<div class="block sin list"></div>');
    rowOption.append(rowOptionBlockTienda);
    var rowOptionBlockOnlineTitle = $('<span>'+ msgContact["titleStore"] + '</span>');
    rowOptionBlockTienda.append(rowOptionBlockOnlineTitle);

    var optionUlStore = $('<ul></ul>');
    rowOptionBlockTienda.append(optionUlStore);
    var optionLiAvailabilityStore = $('<li></li>');
    optionUlStore.append(optionLiAvailabilityStore);
    var optionLiAvailabilityRadioStore = $('<input type="radio" id="item_availability_off" name="motive" value="5"/>');
    var optionLiAvailabilityLabelStore = $('<label>'+ msgContact["optionStore5"] + '</label>');
    optionLiAvailabilityStore.append(optionLiAvailabilityRadioStore);
    optionLiAvailabilityStore.append(optionLiAvailabilityLabelStore);

    var optionLiPolicyStore = $('<li></li>');
    optionUlStore.append(optionLiPolicyStore);
    var optionLiPolicyRadioStore = $('<input type="radio" id="change_return_policy" name="motive" value="6" />');
    var optionLiPolicyLabelStore = $('<label>'+ msgContact["optionStore6"] + '</label>');
    optionLiPolicyStore.append(optionLiPolicyRadioStore);
    optionLiPolicyStore.append(optionLiPolicyLabelStore);

    var optionLiLocatorStore = $('<li></li>');
    optionUlStore.append(optionLiLocatorStore);
    var optionLiLocatorRadioStore = $('<input type="radio" id="store_locator" name="motive" value="7" />');
    var optionLiLocatorLabelStore = $('<label>'+ msgContact["optionStore7"] + '</label>');
    optionLiLocatorStore.append(optionLiLocatorRadioStore);
    optionLiLocatorStore.append(optionLiLocatorLabelStore);

    var optionLiCollaborationStore = $('<li></li>');
    optionUlStore.append(optionLiCollaborationStore);
    var optionLiCollaborationRadioStore = $('<input type="radio" id="commercila_collaboration" name="motive" value="8" />');
    var optionLiCollaborationLabelStore = $('<label>'+ msgContact["optionStore8"] + '</label>');
    optionLiCollaborationStore.append(optionLiCollaborationRadioStore);
    optionLiCollaborationStore.append(optionLiCollaborationLabelStore);

    var optionLiInfoStore = $('<li></li>');
    optionUlStore.append(optionLiInfoStore);
    var optionLiInfoRadioStore = $('<input type="radio" id="corporate_info" name="motive" value="9" />');
    var optionLiInfoLabelStore = $('<label>'+ msgContact["optionStore9"] + '</label>');
    optionLiInfoStore.append(optionLiInfoRadioStore);
    optionLiInfoStore.append(optionLiInfoLabelStore);

    var optionLiEmploymentStore = $('<li></li>');
    optionUlStore.append(optionLiEmploymentStore);
    var optionLiEmploymentRadioStore = $('<input type="radio" id="employment" name="motive" value="10" />');
    var optionLiEmploymentLabelStore = $('<label>'+  msgContact["optionStore10"] + '</label>');
    optionLiEmploymentStore.append(optionLiEmploymentRadioStore);
    optionLiEmploymentStore.append(optionLiEmploymentLabelStore);

    var optionLiCommentsStore = $('<li></li>');
    optionUlStore.append(optionLiCommentsStore);
    var optionLiCommentsRadioStore = $('<input type="radio" id="comments_off" name="motive" value="11" />');
    var optionLiCommentsLabelStore = $('<label>'+ msgContact["optionStore11"] + '</label>');
    optionLiCommentsStore.append(optionLiCommentsRadioStore);
    optionLiCommentsStore.append(optionLiCommentsLabelStore);




    var rowInfo = $('<div class="more-info-block"></div>');
    formulario.append(rowInfo);

    var errorMotive = $('<p class="error" for="motive" generated="true"></p>');
    rowInfo.append(errorMotive);
    var mSpotContacto = $('#mspotContacto');
    if (mSpotContacto) {
        rowInfo.append(mSpotContacto.html());
    }


    var rowPersonName = $('<div class="row"></div>');
    formulario.append(rowPersonName);
    var rowPersonNameBlock1 = $('<div class="block"></div>');
    rowPersonName.append(rowPersonNameBlock1);
    var rowPersonNameBlock1Label = $('<label>'+ msgContact["name"] + '</label>');
    rowPersonNameBlock1.append(rowPersonNameBlock1Label);
    var rowPersonNameBlock1Input = $('<input type="text" id="name" name="name" />');
    rowPersonNameBlock1.append(rowPersonNameBlock1Input);
    var rowPersonNameBlock2 = $('<div class="block sin"></div>');
    rowPersonName.append(rowPersonNameBlock2);
    var rowPersonNameBlock2Label = $('<label>'+ msgContact["surname"] + '</label>');
    rowPersonNameBlock2.append(rowPersonNameBlock2Label);
    var rowPersonNameBlock2Input = $('<input type="text" id="surname" name="surname" />');
    rowPersonNameBlock2.append(rowPersonNameBlock2Input);

    var rowPersonPhone = $('<div class="row"></div>');
    formulario.append(rowPersonPhone);
    var rowPersonPhoneBlock1 = $('<div class="block telefono"></div>');
    rowPersonPhone.append(rowPersonPhoneBlock1);
    var rowPersonPhoneBlock1Label = $('<label>'+ msgContact["phone"] + '</label>');
    rowPersonPhoneBlock1.append(rowPersonPhoneBlock1Label);
    var rowPersonPhoneBlock1InputPre = $('<input type="text" id="phone1Prefix" name="phone1Prefix" class="prefijo" value="'+ DUTTI_PREFIX_STORE +'"/>');
    var rowPersonPhoneBlock1InputPhono = $('<input type="text" id="phone1" name="phone1" class="telefono"/>');
    var rowPersonPhoneBlock1InputHiddenPhono = $('<input type="hidden" id="phone1Complet" name="phone1Complet" class="telefono"/>');
    var rowPersonPhoneBlock1InputError = $('<p class="error" for="prefijo" style="display: none;margin-top: 10px;"></p>');
    rowPersonPhoneBlock1.append(rowPersonPhoneBlock1InputPre);
    rowPersonPhoneBlock1.append(rowPersonPhoneBlock1InputPhono);
    rowPersonPhoneBlock1.append(rowPersonPhoneBlock1InputHiddenPhono);
    rowPersonPhoneBlock1.append(rowPersonPhoneBlock1InputError);
    var rowPersonPhoneBlock2 = $('<div class="block sin"></div>');
    rowPersonPhone.append(rowPersonPhoneBlock2);
    var rowPersonPhoneBlock2Label = $('<label>'+ msgContact["email"] + '</label>');
    rowPersonPhoneBlock2.append(rowPersonPhoneBlock2Label);
    var rowPersonPhoneBlock2Input = $('<input type="text" id="email" name="email" />');
    rowPersonPhoneBlock2.append(rowPersonPhoneBlock2Input);

    var rowPersonAsunto = $('<div class="row"></div>');
    formulario.append(rowPersonAsunto);
    var rowPersonAsuntoBlock = $('<div class="block all"></div>');
    rowPersonAsunto.append(rowPersonAsuntoBlock);
    var rowPersonAsuntoLabel = $('<label>'+ msgContact["subject"] + '</label>');
    rowPersonAsuntoBlock.append(rowPersonAsuntoLabel);
    var rowPersonAsuntoInput = $('<input type="text" id="subject" name="subject" />');
    rowPersonAsuntoBlock.append(rowPersonAsuntoInput);


    var rowPersonMensaje = $('<div class="row"></div>');
    formulario.append(rowPersonMensaje);
    var rowPersonMensajeBlock = $('<div class="block txtrea"></div>');
    rowPersonMensaje.append(rowPersonMensajeBlock);
    var rowPersonMensajeLabel = $('<label>'+ msgContact["msg"] + '</label>');
    rowPersonMensajeBlock.append(rowPersonMensajeLabel);
    var rowPersonMensajeInput = $('<textarea name="note" id="note" rows="0" cols="0"></textarea>');
    rowPersonMensajeBlock.append(rowPersonMensajeInput);

    var rowTextObligatorio = $('<span class="info_campo">' + msgContact["obligatory"] + '</span>');
    formulario.append(rowTextObligatorio);


    var urlPrivacyPolicy = Inditex.generateUrl('PrivacyPolicy',
        {
            "storeId"			: Inditex.iStoreId,
            "langId"			: Inditex.iLangId,
            "catalogId"			: Inditex.iCatalogId
        },
        true
    );


    var rowPoliticaBlock = $('<div class="rowPol"></div>');
    formulario.append(rowPoliticaBlock);
    var rowPoliticaBlockInput = $('<input type="checkbox" name="privacy" id="privacy"/>');
    var rowPoliticaBlockLabel = $('<label>' + msgContact["privacy1"] + ' <a onclick="openGenericModal(\'' + urlPrivacyPolicy + '\',[\'scrollable\',\'general_modal_sec\'], function(){Inditex.trackPage( \'Menu/Contacta/Email/Politica_de_privacidad\',true);addScroll();}, null, 0.8, true);" href="javascript:void(0)">' + msgContact["privacy2"] + '</a></label>');
    var rowPoliticaBlockInputError = $('<p for="privacy" class="error" style="display:none;">' + msgContact["privacy3"] + '</p>');
    rowPoliticaBlock.append(rowPoliticaBlockInput);
    rowPoliticaBlock.append(rowPoliticaBlockLabel);
    rowPoliticaBlock.append(rowPoliticaBlockInputError);

    var rowAcciones = $('<div class="boton" style="margin-top:5px;">');
    formulario.append(rowAcciones);
    var rowAccionesButton = $('<a href="javascript:void(0)" class="acc_butt" id="enviar">'+ msgContact["send"] + '</a>');
    rowAcciones.append(rowAccionesButton);
    var rowAccionesHref = $('<a href="javascript:void(0)" class="acc_butt" id="limpiar">'+ msgContact["clear"] + '</a>');
    rowAcciones.append(rowAccionesHref);

    contenido.append(scrollable);

    loadRadiosAndChecks();
    $("#general_modal").css('max-height','700px');
    setScroll();
}

function validateOldContactOnline(url) {
    $("#descrMotivoForm").validate({
        submitHandler : function(form) {

            var tema = $('input[name=motive]:checked').val();
            if (tema == undefined || tema == null) {
                tema = $('select[name=comboTopicHidden] option:selected').val();
            }


            var data = "comboTopicHidden=" + encodeURIComponent(tema);
            data += "&name=" + encodeURIComponent($('#name').val());
            data += "&surname=" + encodeURIComponent($('#surname').val());
            data += "&phone1Prefix=" + encodeURIComponent($('#phone1Prefix').val());
            data += "&phone1=" + encodeURIComponent($('#phone1').val());
            data += "&email=" + encodeURIComponent($('#email').val());
            data += "&subject=" + encodeURIComponent($('#subject').val());
            data += "&note=" + encodeURIComponent($('#note').val());
            data += "&countryABBR=" + encodeURIComponent(Inditex.iGaIsoCountry);
            data += "&viewname=" + encodeURIComponent('ItxResponseJSON');
            data += "&viewTaskName=" + encodeURIComponent('ItxResponseJSON');
            data += "&errorViewName=" + encodeURIComponent('ItxResponseJSON');

            var form = $("#descrMotivoForm");
            jQuery.xajax({
                url: url,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function(data) {

                    if (data.status > 0) {
                        closeModal($('#general_modal'));
                        openStaticModal(Messages.titleContact, Messages.msgContact, true);
                        Inditex.trackEvent( "Header","ayuda_email_ok",null,true);
                    } else {
                        openStaticModal(Messages.titleContactError, Messages.msgContactError, true);
                        Inditex.trackEvent( "Header","ayuda_email_error",Inditex.codeError(data.key,data.message),true);
                    }
                },
                error: function(xhr) {
                    Inditex.trackEvent( "Header","ayuda_email_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                }
            });
        },
        rules : {
            name : "required",
            surname : "required",
            middleName : "required",
            privacy : "required",
            phone1Prefix : {
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            email : {
                required : true,
                email : true
            },
            subject : "required",
            note : "required",
            comboTopicHidden: "itxSelect"
        },
        messages : {
            name : Messages.required,
            surname : Messages.lastName,
            middleName : Messages.requiredMiddleName,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            email : Messages.email1,
            subject : Messages.asunto,
            note: Messages.cuerpo,
            comboTopicHidden: Messages.tema

        }
    });
}

function validateOldContactStore(url, urlContactView) {
    $("#descrMotivoForm").validate({
        submitHandler : function(form) {

            var data = "id_tema=" + encodeURIComponent($('input[name=motive]:checked').val());
            data += "&nombre=" + encodeURIComponent($('#name').val());
            data += "&apellidos=" + encodeURIComponent($('#surname').val());
            data += "&telefono=" + encodeURIComponent($('#phone1Prefix').val()) + " " + encodeURIComponent($('#phone1').val());
            data += "&email=" + encodeURIComponent($('#email').val());
            data += "&asunto=" + encodeURIComponent($('#subject').val());
            data += "&cuerpo=" + encodeURIComponent($('#note').val());
            data += "&id_pais=" + encodeURIComponent(Inditex.iGaIsoCountry);
            data += "&id_buzon=" + encodeURIComponent('8');
            data += "&exito=" + encodeURIComponent(urlContactView);
            if (Inditex.iLangId = -5) {
                data += "&lenguaje=" + encodeURIComponent('es');
            } else {
                data += "&lenguaje=" + encodeURIComponent('en');
            }
            var form = $("#descrMotivoForm");
            jQuery.xajax({
                url: url,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function(data) {

                    if (data.status > 0) {
                        closeModal($('#general_modal'));
                        openStaticModal(Messages.titleContact, Messages.msgContact, true);
                    } else {
                        openStaticModal(Messages.titleContactError, Messages.msgContactError, true);
                    }
                }
            });

        },
        rules : {
            name : "required",
            surname : "required",
            phone1Prefix : {
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            email : {
                required : true,
                email : true
            },
            subject : "required",
            note : "required",
            comboTopicHidden: "itxSelect",
            privacy : "required"
        },
        messages : {
            name : Messages.required,
            surname : Messages.lastName,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            email : Messages.email1,
            subject : Messages.asunto,
            note: Messages.cuerpo,
            comboTopicHidden: Messages.tema

        }
    });
}

function validateContact(urlOnline, urlStore, urlContactView) {
    $("#descrMotivoForm").validate({
        submitHandler : function(form) {

            var url = "";
            var data = "";
            if ($('input[name=motive]:checked').val() > 3) {
                url = urlOnline;

                var option = "optionStore" + $('input[name=motive]:checked').val();
                var tema = msgContact[option];
                data = "comboTopicHidden=" + encodeURIComponent(tema);
                data += "&name=" + encodeURIComponent($('#name').val());
                data += "&surname=" + encodeURIComponent($('#surname').val());
                data += "&phone1Prefix=" + encodeURIComponent($('#phone1Prefix').val());
                data += "&phone1=" + encodeURIComponent($('#phone1').val());
                data += "&email=" + encodeURIComponent($('#email').val());
                data += "&subject=[EMPRESA] " + encodeURIComponent($('#subject').val());
                data += "&note=" + encodeURIComponent($('#note').val());
                data += "&countryABBR=" + encodeURIComponent(Inditex.iGaIsoCountry);
                data += "&viewname=" + encodeURIComponent('ItxResponseJSON');
                data += "&viewTaskName=" + encodeURIComponent('ItxResponseJSON');
                data += "&errorViewName=" + encodeURIComponent('ItxResponseJSON');

            } else {
                url = urlOnline;

                var option = "optionOnline" + $('input[name=motive]:checked').val();
                var tema = msgContact[option];
                data = "comboTopicHidden=" + encodeURIComponent(tema);
                data += "&name=" + encodeURIComponent($('#name').val());
                data += "&surname=" + encodeURIComponent($('#surname').val());
                data += "&phone1Prefix=" + encodeURIComponent($('#phone1Prefix').val());
                data += "&phone1=" + encodeURIComponent($('#phone1').val());
                data += "&email=" + encodeURIComponent($('#email').val());
                data += "&subject=[PARTICULARES] " + encodeURIComponent($('#subject').val());
                data += "&note=" + encodeURIComponent($('#note').val());
                data += "&countryABBR=" + encodeURIComponent(Inditex.iGaIsoCountry);
                data += "&viewname=" + encodeURIComponent('ItxResponseJSON');
                data += "&viewTaskName=" + encodeURIComponent('ItxResponseJSON');
                data += "&errorViewName=" + encodeURIComponent('ItxResponseJSON');
            }

            var form = $("#descrMotivoForm");
            jQuery.xajax({
                url: url,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function(data) {

                    if (data.status > 0) {
                        closeModal($('#general_modal'));
                        openStaticModal(Messages.titleContact, Messages.msgContact, true);
                        Inditex.trackEvent( "Contacta","formulario_ok",null,true);
                    } else {
                        openStaticModal(Messages.titleContactError, Messages.msgContactError, true);
                        Inditex.trackEvent( "Contacta","formulario_error",Inditex.codeError(data.key,data.message),true);
                    }
                }
            });
        },
        rules : {
            motive : "required",
            name : "required",
            surname : "required",
            phone1Prefix : {
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            email : {
                required : true,
                email : true
            },
            subject : "required",
            note : "required",
            privacy : "required"
        },
        messages : {
            motive : Messages.selectRadiobutton,
            name : Messages.required,
            surname : Messages.lastName,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            email : Messages.email1,
            subject : Messages.asunto,
            note: Messages.cuerpo

        }
    });
}
function prepararTelefono() {
    var telefono = $('#prefijo').val() + $('#telefono').val();
    $('#telefonoComplet').attr('value',telefono);
};
/* END /DuttiNEWStorefrontAssetStore/js/contacto.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_1.js (en_US) */
var codigoPromocion = '';
var errorStock = 0;
var moneda;
var symbolPosition;

function loadPaso_1(){
    if (Inditex)
        Inditex.trackEvent('/Cabecera','minicesta','ir_a_cesta');

    //el carrito desde la cesta no puede ser clicable
    $('#shopcart a').click( function(){
        return false;
    });

    if(shopCartJSON.hasPersonalize=="true"){
        $("#personalize").show();
    }else{
        $("#personalize").remove();
    }

    symbolPosition = shopCartJSON.currencySuffix.length==0;
    if (!symbolPosition)
        moneda = shopCartJSON.currencySuffix;
    else
        moneda=shopCartJSON.currencyPrefix;

    decimals = shopCartJSON.decimalPlaces;

    load_productsTunel(shopCartJSON);
    detallePedidoBinds();
    jQuery(window).bind('resize', function(e){
        if (e.target==window) {
            fitFooterBottomTunel($('#tunel'));
        }
    });



    if(!isIPad()){
        $("#regalo").bind("click", function(){
            $('#textoRegalo').focus();
        });
        $("#giftOptionsPack").bind("click", function(){
            $('.tarjeta').show();
            $('.info').show();
            $('#textoRegalo').focus();
        });
        $('#giftOptionsMessage').bind("click", function(){
            $('#textoRegalo').focus();
        });
        $("#giftOptionsNone").bind("click", function(){
            $('#textoRegalo').blur();
        });
    }
    else{
        document.addEventListener("touchmove", function(){
            $('#textoRegalo').blur();
        }, false);
        $("#tunel").bind("click", function(){
            $('#textoRegalo').focusout();
        });
    }

    $("#botonContinuar").click(function(event){
        event.preventDefault();
        if(errorStock>0) {
            Inditex.trackEvent( categoryEvent,"Tramitar_pedido",null,true);
            openStaticModal(Messages.aviso, Messages.errorStock, false);
        } else {
            Inditex.trackEvent( categoryEvent,"Tramitar_pedido",{
                'hitCallback':function(){
                    if(isAGift&&textoChanged) {
                        var textoRegalo = $('#textoRegalo');
                        var textoRegalo=$("#textoRegalo");
                        var lineas = textoRegalo.val().split("\n");
                        var urlTicket= Inditex.generateUrl("ItxOrderManageCmd", {
                            "storeId": Inditex.iStoreId,
                            "langId": Inditex.iLangId,
                            "catalogId": Inditex.iCatalogId,
                            "action": "addGiftTicket",
                            "viewname": "ItxStandardJSON",
                            "errorViewName": "ItxStandardJSON"
                        },true);
                        var url= Inditex.generateUrl("ItxOrderManageCmd", {
                            "storeId": Inditex.iStoreId,
                            "langId": Inditex.iLangId,
                            "catalogId": Inditex.iCatalogId,
                            "action":"addGiftPackingText",
                            "viewname":"ShopCartJSON",
                            "errorViewName":"ShopCartJSON"
                        },true);
                        Inditex.orderManage({
                            url: urlTicket,
                            onSuccess: function(data) {
                                Inditex.orderManage({
                                    url: url+"&text="+encodeURIComponent(textoRegalo[0].value),
                                    onSuccess:function(data){
                                        if ( $('#iUserType').attr('value') != 'G'){
                                            document.location.href=shopCartJSON.linkOrderShipping;
                                        } else {
                                            document.location.href = $('#iUrlLogon').attr('value');
                                        }
                                    },
                                    onFailure:function (){
                                    }
                                });
                            }
                        });
                    } else {
                        if ( $('#iUserType').attr('value') != 'G'){
                            document.location.href=shopCartJSON.linkOrderShipping;
                        } else {
                            document.location.href = $('#iUrlLogon').attr('value');
                        }
                    }
                }
            },true);

        }

    });

    $('#botonCompraRapida').click(function(e) {
        Inditex.trackEvent( 'Cesta_de_Compra_Rapida','Compra_rapida',null,{});
        if(isAGift&&textoChanged) {
            var textoRegalo = $('#textoRegalo');
            var textoRegalo=$("#textoRegalo");
            var lineas = textoRegalo.val().split("\n");
            var urlTicket= Inditex.generateUrl("ItxOrderManageCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "action": "addGiftTicket",
                "viewname": "ItxStandardJSON",
                "errorViewName": "ItxStandardJSON"
            },true);
            var url= Inditex.generateUrl("ItxOrderManageCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "action":"addGiftPackingText",
                "viewname":"ShopCartJSON",
                "errorViewName":"ShopCartJSON"
            },true);
            Inditex.orderManage({
                url: urlTicket,
                onSuccess: function(data) {
                    Inditex.orderManage({
                        url: url+"&text="+encodeURIComponent(textoRegalo[0].value),
                        onSuccess:function(data){
                            openModalCompraRapida();
                        },
                        onFailure:function (){
                        }
                    });
                }
            });
        }else openModalCompraRapida();
    });


    loadRadiosAndChecks();
    if ($('.cruz').length <=0){
        cargarCestaVacia();
        $('#bag').fadeOut();
    }

}

/**
 * Metodo que carga los datos generales del producto
 */
function load_productsTunel(data) {

    //Llamada ajax que recupera y parsea a json la url pasada
    //$.getJSON(url, function(data) {
    detalle = data;
    //seteo nombre del producto
    $('#tablaPedidos').html(getProducts(data));
    if(data.listItems.length > 0){
        ocultarCestaVacia();
    }
    $('tfoot').html(getTotal(data));
    // Metodo temporal para demo de error por falta de stock. No usar en produccion
    mockError(data);
    mockErrorGiftCard(data);
    //});
    $('.basket-items-amount').html((parseInt($('.basket-items-amount').html())) + 1);
    $('#bag').fadeIn();
    if ($('.cruz').length <=0){
        cargarCestaVacia();
        $('#bag').fadeOut();
    }
    colocarBordes();
    colocarBordesPromo();

    setTimeout(function(){
        fitFooterBottomTunel($('#tunel'));
    },800);


}

function sendGoogleAnalyticsData(data) {
    if (Inditex) {

        var lista = data.listItems;
        var total = 0;
        var disponible = 0;
        for(i=0;i< lista.length;i++){
            if (lista[i]== undefined)
                continue;
            total++;
            if (parseInt(lista[i].currentInventory) >= parseInt(lista[i].quantity))
                disponible++;
        }
        Inditex.trackPage("/Cesta_de_Compra/Lista_de_Productos/Total_"+total+"/Disponible_"+disponible+"/NoDisponible_"+(total-disponible));
    }
}

function loadPromotions(url){
    codigoPromocion=$('#codPromocion').val();
    if (Inditex)
        Inditex.trackEvent('/Cesta_de_Compra','promocion_activar');
    url= url+ '&action=addPromoCode&code=' + encodeURIComponent(codigoPromocion);
    Inditex.orderManage({
        url: url,
        dataType :'json',
        onSuccess:function(textData){
            jsonData = Inditex.evalJSON(textData);
            if (jsonData.type){
                if ((jsonData.type == "1") || (jsonData.type == "2")) {
                    openStaticModal(jsonData.title, jsonData.errorMessage, false);
                    Inditex.trackEvent( categoryEvent,'codigo_promocional_error',Inditex.codeError(jsonData.key,jsonData.errorMessage),true);
                }
            } else {
                load_productsTunel(jsonData);
                if(codigoPromocion!=""){
                    Inditex.getUserJSON(function(user){
                        if (user.isWalletUser) {
                            Inditex.trackEvent( categoryEvent,'codigo_promocional_ok',null,{});
                        } else {
                            Inditex.trackEvent( categoryEvent,'codigo_promocional_ok','ok',{});
                        }
                    });
                }

            }
        }
    });
}

function getProducts(data){

    var tallaUnica = $('#textoTallaUnica').val();
    var contenido ='';
    lista = data.listItems;
    $(shopCartJSON).data('lista',lista);
    var cantidadTotal = -1;
    for(i=0;i< lista.length;i++){
        producto = lista[i];
        if (producto != undefined) {
            cantidadTotal  = parseInt(producto.quantity) + cantidadTotal;
            producto.linkAdd = "'" +producto.linkAdd+ "'" ;
            producto.linkDelete = "'" +producto.linkDelete+ "'" ;
            producto.linkDeleteAll = "'" + producto.linkDeleteAll+ "'" ;
            var partnumber_sin_talla = producto.reference.sub
            //data.addPromotion = "'" + data.addPromotion+ "'" ;
            contenido += '<tr>' +
                '<td class="a6">' +
                '	<a onclick="updateCantidadProd('+producto.linkDeleteAll +'); trackingCambiarCantidad('+producto.quantity+',\''+categoryEvent+'\','+i+',\'eliminar\')" class="cruz" href="#" >&nbsp;</a>' +
                '  <img  style="cursor: pointer" src="' + producto.image + '" onclick="cargaPopUpProducto('+producto.productId+',true)" width="55px;" />' +
                '</td>' +
                '<td>' +
                '	<p class="descr"  onclick="cargaPopUpProducto('+producto.productId+',true)" style="cursor: pointer">' + producto.description + '</p>' +
                '    <span class="ref">Ref. ' + producto.reference + '</span>' +
                '    <input type="hidden" value="' + producto.linkProduct + '"/>' +
                '</td>' ;
            if (producto.esTrajetaRegalo == "false") {
                contenido += '<td class="center">' +
                    '	<p>' + producto.cutColorName + '</p>' +
                    '</td>' +
                    '<td class="center">';

                if(producto.numSizes == '1'){
                    contenido +='<p>' + tallaUnica + '</p>';
                }
                else{
                    contenido +='<p>' + producto.size + '</p>';
                }

                contenido += ' </td>' +
                    ' <td class="center">' +
                    '	<div class="contadores">' +
                    ' <a onclick="updateCantidadProd('+producto.linkDelete +'); trackingCambiarCantidad(1,\''+categoryEvent+'\','+i+',\'decrementar\');" class="eliminar" href="#" >'+
                    '   	<img src= "'+DUTTI_STATIC_CONTENT_PATH+'/img/ico_menos.png" class="menos"/>' +
                    ' </a> '+
                    '		<input type="text" class="quantity" value="' + formatNumber(producto.quantity,0) + '"  readonly="true"/>' +
                    ' <a  onclick="updateCantidadProd('+producto.linkAdd +'); trackingCambiarCantidad(1,\''+categoryEvent+'\','+i+',\'incrementar\');" class="aniadir" href="#">'+
                    '        <img src="'+DUTTI_STATIC_CONTENT_PATH+'/img/ico_mas.png" class="mas"/>' +
                    ' </a> '+
                    '    </div>' ;
            } else {
                contenido +=
                    '<td class="center">' +
                    '	<p></p>' +
                    '</td>' +
                    '<td class="center">' +
                    ' 	<p></p>' +
                    ' </td>' +
                    ' <td class="center">' +
                    '	<div class="contadores2">' +
                    '		<input type="text" class="quantity" value="' + formatNumber(producto.quantity,0) + '"  readonly="true" style=" text-align: center"/>' +
                    '    </div>' ;
            }
            contenido +=
                '</td>' +
                '<td class="right">' +
                ' 	<p class="totalProduct">' + formatCurPrice((producto.unitPrice * producto.quantity),decimals,moneda) + '</p>' +
                '	<input type="hidden" id="unitPrice" value="' + producto.unitPrice  + '"/>'	+
                '   <input type="hidden" class="totalProductDec" value="' + (producto.unitPrice * producto.quantity)  + '"/>'+
                '</td>' +

                '</tr>';
        }


    }


    contenido += '<tr class="noborde sepTop">'+
        '<td colspan="5" class="right"><p>'+Messages.totalArticulos+'</p></td>'+
        '<td class="right"><p><strong id="totalProducts">' + formatCurPrice(data.totalProductPrice,decimals,moneda) + '</strong></p></td>'+
        '</tr>';

    if (data.isGift == "true") {
        contenido+='<tr id="envoltorio_regalo" class="noborde">'+
                //TODO: check hardcoded literal
            '<td colspan="5" class="right"><p>'+Messages.envoltorioRegalo+'</p></td>'+
            '<td class="right">' +
            '<p><strong>' + formatCurPrice(data.giftPrice,decimals,moneda) +'</strong></p>' +
            '<input type="hidden" id="giftPriceDec" value="' + data.giftPrice  + '"/>' +
            '</td>'+
            '</tr>';
    }
    if (data.tieneTarjetaVirtual == "false") {

        contenido += '<tr  id="titGastosEnvio" class="noborde gastos">'+
            '<td colspan="5" class="right"><p>'+Messages.gastosEnvio+'</p></td>'+
            '<td class="right">' +
            '<p><strong>' + formatCurPrice(data.shippingPrice,decimals,moneda) +'</strong></p>' +
            '<input type="hidden" id="shippingPriceDec" value="' + data.shippingPrice  + '"/>' +
            '</td>'+
            '</tr>';


        for (var j=0; j<data.promotions.length;j++){
            contenido +=	'<tr id="inicioDescuentos" class=" noborde promo">'+
                '<td colspan="1" class="right"><a class="cruzDescuento" onclick="updateCantidadProd(\''+data.promotions[j].removeUrl+'\'); Inditex.trackEvent( categoryEvent,\'codigo_promocional_quitar\',null,true);" href="javascript:void(0)">&nbsp;</a></td>'+
                '<td colspan="4" class="right"><p>'+data.promotions[j].description+'</p></td>'+
                '<td class="right">' +
                '<p><strong></strong></p>' +
                '<input type="hidden" id="shippingPriceDec" value=""/>' +
                '</td>'+
                '</tr>';
            colocarBordesPromo();
            //fitFooterBottomTunel($('#tunel'));
            //addDiscount(data.discounts[j].description,data.discounts[j].amount);
        };
        for (var j=0; j<data.discounts.length;j++){
            contenido +=	'<tr class=" noborde descuento">'+
                '<td colspan="5" class="right"><p>'+data.discounts[j].longDescription+'</p></td>'+
                '<td class="right">' +
                '<p><strong>' + formatCurPrice(data.discounts[j].amount,decimals,moneda) +'</strong></p>' +
                '<input type="hidden" id="shippingPriceDec" value="' + data.discounts[j].amount  + '"/>' +
                '</td>'+
                '</tr>';
            colocarBordes();
            //fitFooterBottomTunel($('#tunel'));
            //addDiscount(data.discounts[j].description,data.discounts[j].amount);
        };
    }


    if ($('#iUserType').val() == 'G')// usuario Guest
    {
        Inditex.getMarketingSpot({
            name: 'MD2_ESpot_MensajeCodigoPromocional',
            onSuccess: function(mensajePromo) {  //MD2_ESpot_MensajeCodigoPromocional
                if(mensajePromo.trim().length > 0){
                    var text="<tr class='noborde selectDesc' id='inicioDescuentos'><td class='right' colspan='6'>"+mensajePromo+"</td><tr class='noborde'><td colspan='6' class='right'></td></tr><td class='right'></td>";
                    $(text).insertAfter("#titGastosEnvio");
                }
                contenido +=
                    '<tr class="noborde selectDesc" id="inicioDescuentos">'+
                    '<td class="right" colspan="5">'+
                    '</td>'+
                    '<tr class="noborde"><td colspan="5" class="right"></td></tr>'
                '<td class="right">' +
                '</td>'+
                '</tr>';
            },
            onFailure: function(text) {
            }
        });
    }
    else if($('#iUserType').val() == 'R'){ // usuario Registrado
        contenido +=
            '<tr class="noborde selectDesc" id="inicioDescuentos">'+
            '<td class="right" colspan="5">'+
            '	<a href="javascript:void(0)" id="promocion" class="accion" onclick="$(this).toggleClass(\'activo\');$(\'#cod,#cod_precio\').toggle();fitFooterBottomTunel($(\'#tunel\'));">'+Messages.promocion+'</a>'+
            '</td>'+
            '<tr class="noborde"><td colspan="5" class="right">' +
            '   <div id="cod">'+
            '    	<input type="text" id="codPromocion" value="'+ codigoPromocion +  '"/>'+
            '    	<a href="#" class="accept_cod" onclick="loadPromotions(\''+data.addPromotion+'\');return false">' +Messages.aceptar+ '</a>'+
            '    </div>' +
            '</td></tr>'
        '<td class="right">' +
        '	<p id="cod_precio"><strong id="totalAdjustment"></strong></p>' +
        '	<input type="hidden" id="totalAdjustmentDec" value="' + parseFloat(data.totalAdjustment.substr(1,data.totalAdjustment.length)) + '"/>'
        '</td>'+
        '</tr>';
    }


    $('.wicon.bag').animate({
        'padding-left' : 14
    }, 300);
    $('.basket-items-amount').html(cantidadTotal);
    $('#bag').fadeIn();

    if (data.tieneTarjetaVirtual == "true") {
        $('.boxtitle').fadeOut();
        $('.accion').fadeOut();

    }

    return contenido;

}


/**
 * Metodo que a?ade una fila a los descuentos
 */
function addDiscount(descripcion,cantidad){
    var descuento = '';
    if (descripcion != null && cantidad != null){
        descuento = '<tr class="noborde descuento" descuento="' + cantidad + '">' +
            '<td class="right"><a class="cruzDescuento" href="javascript:void(0)">&nbsp;</a></td>' +
            '<td colspan="4" class="right"><p>' + descripcion.toUpperCase() + '</p></td>' +
            '<td class="right"><p><strong>' + formatCurPrice(cantidad,decimals,moneda) + '</strong></p></td>' +
            '</tr>';
        var descuentoActual = parseFloat($('#totalAdjustmentDec').val(),decimals);
        descuentoActual = descuentoActual + parseFloat(cantidad,decimals);
        $('#totalAdjustmentDec').val(descuentoActual);
        $('#inicioDescuentos').addClass('selectDesc');
        $('#titGastosEnvio').addClass('gastos');
        recalcularTotales();
    }
    $('#inicioDescuentos').before(descuento);
    colocarBordes();
    colocarBordesPromo();
    fitFooterBottomTunel($('#tunel'));

}

function colocarBordes(){
    $('.noborde.descuento').removeClass('descuentoFirst');
    $('.noborde.descuento').removeClass('descuentoLast');
    $('.noborde.descuento').first().addClass('descuentoFirst');
    $('.noborde.descuento').last().addClass('descuentoLast');
}


function colocarBordesPromo(){
    $('.noborde.promo').removeClass('descuentoFirst');
    $('.noborde.promo').removeClass('descuentoLast');
    $('.noborde.promo').first().addClass('descuentoFirst');
    $('.noborde.promo').last().addClass('descuentoLast');
}



function getTotal(data){

    return '<tr>'+
        ' 	<td colspan="5" class="right"><p>'+Messages.totalcompra+'</p></td>'+
        '    <td class="right" style="width:10%;">' +
        '        <p id="total">' + ((data.tieneTarjetaVirtual=="true") ? formatCurPrice(data.totalProductPrice,decimals,moneda) : formatCurPrice(data.totalPrice,decimals,moneda)) +'</p>' +
        '		<input type="hidden" id="totalDec" value="' + data.totalPrice + '"/>' +
        '    </td>'+
        ' </tr>';
}

function detallePedidoBinds(){


    $("#codPromocion").off();
    $(document).on('keypress', '#codPromocion', function (event) {
        if(event.which == 13) {
            loadPromotions('data/promocion.json');
        }
    });

    removeValueFromFieldOnClick("textoRegalo");
    var textoRegalo = $('#textoRegalo');
    textoRegalo.limit('200', '#charsLeft');
    var tieneItemRegalo = 0;
    // var maxNumChars = 3;
    textoRegalo.keypress(function(event){
        var lineas = textoRegalo.val().split("\n");
        /* if (textoRegalo.val() != "") {
         tieneItemRegalo = 1;

         } else {
         tieneItemRegalo = 0;
         }*/
        /* si no esta vacio se a?ade itemRegalo */

        /*
         for(var i=0; i<lineas.length; i++){
         if (lineas[i].length>maxNumChars-1 && lineas[i].length[maxNumChars-1]!="\n"){
         textoRegalo.val(textoRegalo.val()+"\n");
         return true;
         }
         }*/

        // Controlamos que no haya ms de 10 lineas
        var numLineas = lineas.length;
        if (event.which == 13 ) {
            numLineas++;
        }
        return numLineas<=10;
    });




    if($('#totalAdjustmentDec').attr('value') != '' && parseInt($('#totalAdjustmentDec').attr('value'))!=0 && $('#totalAdjustmentDec').attr('value') != undefined){
        setTimeout(function() {
            $('#promocion').click();
        }, 200);
    }

}

function updateCantidadProd(updateURL){

    Inditex.orderManage({
        url: updateURL,
        onSuccess: function(textData){
            jsonData = Inditex.evalJSON(textData);
            load_productsTunel(jsonData);
            if ($('.cruz').length <=0){
                cargarCestaVacia();
                $('#bag').fadeOut();
            }
            if(jsonData.hasPersonalize=="true"){
                $("#personalize").show();
            }else{
                $("#personalize").remove();
            }
        }
    });

}


function recalcularTotalesProduct(element){
    var unitPrice = parseFloat(element.parent().parent().parent().find('#unitPrice').attr('value'),2);
    var quantity = parseInt(element.parent().parent().parent().find('.quantity').attr('value'));
    //valor a visualizar
    element.parent().parent().parent().find('.totalProduct').html(formatCurPrice(unitPrice * quantity ,decimals,moneda));
    //hidden para calcular
    element.parent().parent().parent().find('.totalProductDec').attr('value', unitPrice * quantity);
    recalcularTotales();
}


function recalcularTotales(){
    var totalPrice = 0;
    $('.totalProductDec').each(function(){
        totalPrice += parseFloat($(this).attr('value'),2);
    });
    $('#totalProducts').html(formatCurPrice(totalPrice, decimals,moneda));

    var shippingPrice =  parseFloat($('#shippingPriceDec').attr('value'),2);
    var totalAdjustment = parseFloat($('#totalAdjustmentDec').attr('value'),2);
    totalPrice += shippingPrice + totalAdjustment;

    $('#total').html(formatCurPrice(totalPrice, decimals,moneda));
    $('#totalDec').attr('value',totalPrice);
}


/*
 *
 * Ventana modal con confirmacin de adherencia a newsletter
 *
 */
function codigoPromocionalInvalido() {
    var changeOverflow = ($('body').css('overflow') == 'hidden') ? false : true;
    $('body,html').css('overflow', 'hidden');
    // crea div #overlay
    $('<div/>', {
        'id' : 's_overlay',
        'class' : 'transp',
        'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
    }).appendTo('body');
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#s_overlay');
    $('<div/>', {
        'id' : 'news_confirm'
    }).appendTo('#s_overlay')
    // Meter aqu los contenidos del modal
    $('#news_confirm').css('padding-top','30px');
    $('#news_confirm').html('')
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
    })
    setTimeout(function() {
        $('#news_confirm').fadeIn();
    }, 300)
    $('#s_overlay').css('left', 0).fadeIn(function() {
        $('#close_overlay').bind('click', function() {
            $('#s_overlay').fadeOut(function() {
                $(this).remove();
                if(changeOverflow) {
                    $('body , html').css('overflow', 'visible');
                }
            })
        });
        $('#close_newsconfirm').bind('click', function() {
            $('#s_overlay').fadeOut(function() {
                $(this).remove();
                if(changeOverflow) {
                    $('body , html').css('overflow', 'visible');
                }
            })
        });
    })
}

function cargarCestaVacia(){
    $("#conArticulos").hide();
    $(".bot_sig").hide();
    $(".add_art").css('margin-left', '43%');
    $("#sinArticulos").show();
    $("#mSpotSinArticulos").show();
}

function ocultarCestaVacia(){
    $("#conArticulos").show();
    $(".bot_sig").show();
    $(".add_art").css('margin-left', '0%');
    if ($("#sinArticulos")!= undefined && $("#sinArticulos")!= null){
        $("#sinArticulos").hide();
    }
    if ($("#mSpotSinArticulos")!= undefined && $("#mSpotSinArticulos")!= null){
        $("#mSpotSinArticulos").hide();
    }
}

//limitar textArea y actualziar campo
(function($){
    $.fn.extend({
        limit: function(limit,element) {

            var interval, f;
            var self = $(this);

            $(this).focus(function(){
                interval = window.setInterval(substring,100);
            });

            $(this).blur(function(){
                clearInterval(interval);
                substring();
            });

            substringFunction = "function substring(){ var val = $(self).val(); var length = 0; if (val != null) {var length = val.length};if(length > limit){$(self).val($(self).val().substring(0,limit));}";
            if(typeof element != 'undefined')
                substringFunction += "if($(element).html() != limit-length){$(element).html((limit-length<=0)?'0':limit-length);}"

            substringFunction += "}";

            eval(substringFunction);



            substring();

        }
    });
})(jQuery);

/**
 * Funcion que muestra un mensaje de fuera de stock en el primer producto.
 * Esta funcin es de ejemplo y solo se usa mientras no sabemos como obtener el stock en el paso 1
 */
function mockError(data){
    //Reseteo la variable.
    errorStock = 0;

    lista = data.listItems;
    for(i=0;i< lista.length;i++){
        producto = lista[i];
        if ( producto != undefined ) {
            if(Number(producto.quantity)> Number(producto.currentInventory)){
                var stock = '' +  Number(producto.currentInventory);
                var newAdvice='<p class="error">'+Messages.errorStock+stock +'</p>';
                $($('#tablaPedidos tr td')[6*i+1]).append(newAdvice) ;
                errorStock++;
            }
            else if((producto.quantityIndom != 'false') && (Number(producto.quantity)> Number(producto.quantityIndom))){
                var stock = '' +  Number(producto.quantityIndom);
                var newAdvice='<p class="error">'+Messages.errorStock+stock +'</p>';
                $($('#tablaPedidos tr td')[6*i+1]).append(newAdvice) ;
                errorStock++;
            }


        }
    }
}

function mockErrorGiftCard(data){

    lista = data.listItems;

    var hasVirtualGiftCardSku = false;
    var hasMoreProduct = false;

    for(i=0;i< lista.length;i++){
        producto = lista[i];
        if ( producto != undefined ) {
            if (/^51[0-9]+/.test(producto.reference)){
                hasVirtualGiftCardSku = true;
                $("#shipModeDP").val("false");
            }else{
                hasMoreProduct = true;
            }
        }
    }
    if (hasVirtualGiftCardSku && hasMoreProduct ) {
        $('.bot_sig').hide();
        openStaticModal(Messages.aviso, Messages.errorTarjetaVirtual, false);
        for(i=0;i< lista.length;i++){
            producto = lista[i];
            if ( producto != undefined ) {
                if (/^51[0-9]+/.test(producto.reference)) {
                    var newAdvice='<p class="error">'+Messages.errorTarjetaVirtual+'</p>';
                    $($('#tablaPedidos tr td')[6*i+1]).append(newAdvice) ;
                    errorStock++;
                }
            }
        }
    }else{
        $('.bot_sig').show();
    }
}

function addGift(packing, text){


    if (Inditex && text) {
        Inditex.trackEvent('/Cesta_de_Compra','envolver_para_regalo','habilitar');
        Inditex.trackEvent( categoryEvent,'Regalo_si',null,true);
    }
    if (Inditex &&!text) {
        Inditex.trackEvent('/Cesta_de_Compra','envolver_para_regalo','inhabilitar');
        Inditex.trackEvent( categoryEvent,'Regalo_no',null,true);
    }

    fitFooterBottomTunel($('#tunel'));
    var viewname = errorViewName = "ShopCartJSON";

    var urlTicket= Inditex.generateUrl("ItxOrderManageCmd", {
        "storeId": Inditex.iStoreId,
        "langId": Inditex.iLangId,
        "catalogId": Inditex.iCatalogId,
        "action": "addGiftTicket",
        "viewname": "ItxStandardJSON",
        "errorViewName": "ItxStandardJSON"
    },true);

    if(packing){

        var url= Inditex.generateUrl("ItxOrderManageCmd", {
            "storeId": Inditex.iStoreId,
            "langId": Inditex.iLangId,
            "catalogId": Inditex.iCatalogId,
            "action":"addGiftPacking",
            "viewname":"ShopCartJSON",
            "errorViewName":"ShopCartJSON"
        },true);

        Inditex.orderManage({
            url: urlTicket,
            onSuccess: function(textData){
                Inditex.orderManage({
                    url: url,
                    onSuccess: function(textData){
                        jsonData = Inditex.evalJSON(textData);
                        load_productsTunel(jsonData);
                        if ($('.cruz').length <=0){
                            cargarCestaVacia();
                            $('#bag').fadeOut();
                        }
                        if(jsonData.hasPersonalize=="true"){
                            $("#personalize").show();
                        }else{
                            $("#personalize").remove();
                        }
                        isAGift=true;
                        hasGiftPacking=true;
                    }
                });
            }
        });
    }else if(text){
        if(hasGiftPacking){
            var url= Inditex.generateUrl("ItxOrderManageCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "action":"removeGiftPacking",
                "viewname":"ShopCartJSON",
                "errorViewName":"ShopCartJSON"
            },true);
            Inditex.orderManage({
                url: url,
                onSuccess: function(textData){
                    jsonData = Inditex.evalJSON(textData);
                    load_productsTunel(jsonData);
                    if ($('.cruz').length <=0){
                        cargarCestaVacia();
                        $('#bag').fadeOut();
                    }
                    if(jsonData.hasPersonalize=="true"){
                        $("#personalize").show();
                    }else{
                        $("#personalize").remove();
                    }

                    isAGift=true;
                    hasGiftPacking=false;
                }
            });
        }else{
            isAGift=true;
            hasGiftPacking=false;
        }
    }else{
        if(isAGift){
            var url= Inditex.generateUrl("ItxOrderManageCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "action":"removeGiftPackingAndText",
                "viewname":"ShopCartJSON",
                "errorViewName":"ShopCartJSON"
            },true);
            var urlTicketRemove= Inditex.generateUrl("ItxOrderManageCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "action": "removeGiftTicket",
                "viewname": "ItxStandardJSON",
                "errorViewName": "ItxStandardJSON"
            },true);
            Inditex.orderManage({
                url: urlTicketRemove,
                onSuccess: function(textData){
                    Inditex.orderManage({
                        url: url,
                        onSuccess: function(textData){
                            jsonData = Inditex.evalJSON(textData);
                            load_productsTunel(jsonData);
                            if ($('.cruz').length <=0){
                                cargarCestaVacia();
                                $('#bag').fadeOut();
                            }
                            if(jsonData.hasPersonalize=="true"){
                                $("#personalize").show();
                            }else{
                                $("#personalize").remove();
                            }
                            $("#textoRegalo").unbind("change");
                        }
                    });
                }
            });

        }
        hasGiftPacking=false;
        isAGift=false;
    }
}


/**
 *	Pantalla que se abrira de en el momento que el usuario pulse sobre el bot?n de compra r?pida dentro de la cesta
 *	El m?todo de pago es Wallet y la compra se hara con la tarjeta principal de todas las que el usuario tenga almacenadas.
 */
function openModalCompraRapida() {

    var url = Inditex.generateUrl("ItxStandardOneClickPreviewCmd", {
        "storeId": Inditex.iStoreId,
        "langId": Inditex.iLangId,
        "catalogId": Inditex.iCatalogId,
        "viewname": "ItxStandardOneClickPreviewView"
    }, true);

    var onReady = null;

    if (Inditex.iStoreJSON.countryCode == "MX") {

        onReady = function () {

            var paymentCodeName = $("#responseDataCcardPaymentCodeName").val();

            var paymentCode = $("#responseDataCardPaymentCode").val();

            var contenedorForm = $('#paymentData');

            if (paymentCode == "1")
                paymentCodeName = "VISAInstallments";
            if (paymentCode == "2")
                paymentCodeName = "MasterCardInstallments";
            if (paymentCodeName.indexOf('Installments') != -1)
                installmentsUpdate(contenedorForm, paymentCodeName);

            Inditex.trackPage( "Cesta_de_Compra/Resumen/Compra_rapida",true);
        };
    } else {
        onReady = function () {
            Inditex.trackPage( "Cesta_de_Compra/Resumen/Compra_rapida",true);
        };
    }

    openOneClickModal(url,null,onReady,null,0.8);
}

function installmentsUpdate (contenedorForm, paymentCodeName) {

    var comboModalidadPago = $('comboModalidadPago');
    if ((comboModalidadPago != undefined) && (comboModalidadPago != null)) {
        comboModalidadPago.remove();
    }
    var precioFinish = jQuery("#iTotalPriceDBPrice").val();

    Inditex.getRestOrderPaymentModes({
        number: "",
        amount: precioFinish,
        policy: paymentCodeName,
        vatin:  "",
        onSuccess: function(aJson) {
            if ((aJson != undefined) && (aJson != null) && (aJson != "")) {
                if (typeof(aJson)=="string") {
                    aJson = JSON.decode(aJson);
                }
                if ((aJson != undefined) && (aJson != null) && (aJson.paymentModes != undefined) && (aJson.paymentModes != null) && (aJson.paymentModes.length > 0)) {
                    var index = "0";
                    drawModalidadPago(contenedorForm, index, "", aJson);
                }
            }
        },
        onFailure: function(aJson) {
        }
    });
}

function drawModalidadPago (container, index, metodo, aJson) {

    var more_info = "<div id='morePaymentInfo' style='float:left;'><div class='row'><div id='modalidades' class='mx_compra_popup'><div class='block' style='visibility:hidden;width:100%;'>" +
        "<label>"+Messages.PaymentMethod+"</label>" +
        "<div class='multidrop single tunelcuenta' >" +
        "<select id='modalidadPagoAffinityMoreInfo' name='modalidadPagoAffinityMoreInfo' title='"+Messages.method+"' disabled='disabled'></select>" +
        "</div></div></div></div>";

    container.append(more_info);

    if (aJson.paymentModes.length > 0) {
        $("#modalidadPagoAffinityMoreInfo").empty();

        var opcion = '';

        for (var i=0;i<aJson.paymentModes.length; i++){
            var item = aJson.paymentModes[i];

            opcion += '<option name="'+item.name+'" value="'+item.id+'">' +item.name+'</option>';
        }

        $("#modalidadPagoAffinityMoreInfo").html(opcion);

        $("#modalidadPagoAffinityMoreInfo").removeAttr('disabled');
        $("#modalidadPagoAffinityMoreInfo").parent().parent().css('visibility','visible');

        selectBinds();
    } else {
        $("#modalidadPagoAffinityMoreInfo").empty();
        $("#modalidadPagoAffinityMoreInfo").attr('disabled');
        $("#modalidadPagoAffinityMoreInfo").parent().parent().css('visibility','hidden');
    }
}

function cargaPopUpProducto(productId,isTunel){
    var url = Inditex.generateUrl("ProductPopUpAjaxView", {
        "storeId": Inditex.iStoreId,
        "langId": Inditex.iLangId,
        "catalogId" : Inditex.iCatalogId,
        "categoryId": 0,
        "productId": productId
    },true);
    if (isTunel) {
        Inditex.getUserJSON(function(e){
            var productOrigin = null;
            $.each(e.shopCart.items,function(index,item){
                if (item.parentId==productId && item.origin) {
                    productOrigin = item.origin[0];
                    return;
                }
            });
            if (productOrigin==null) {
                Inditex._setECList("");
                Inditex._setECCategoryDataDB("");
                Inditex._setECParentId("");
                Inditex.request({
                    "url": url,
                    "onSuccess": function(aText) {
                        popupCestaUrl(aText, "919px", "604px");
                    }
                });
            } else {
                if (productOrigin.categoryType==null) productOrigin.categoryType = "";
                if (productOrigin.categoryData==null) productOrigin.categoryData = "";
                if (productOrigin.parentId==null) productOrigin.parentId = "";
                Inditex._setECList(productOrigin.categoryType);
                Inditex._setECCategoryDataDB(productOrigin.categoryData);
                Inditex._setECParentId(productOrigin.parentId);

                categorys = productOrigin.categoryData.split("#");
                var categoryId = (categorys.length>0?parseInt(categorys[0]):0);
                if (isNaN(categoryId)){
                    categoryId=0;
                }
                if ("BUSCADOR"==productOrigin.categoryType){
                    Inditex._setECBrand(productOrigin.categoryType);
                    Inditex._setECCategory("Buscador_"+(categorys.length>1?categorys[1]:''));
                    if (categorys.length>2) window.currentIndex = categorys[2]-1;
                    Inditex.request({
                        "url": url,
                        "onSuccess": function(aText) {
                            popupCestaUrl(aText, "919px", "604px");
                        }
                    });
                } else {
                    if (categorys.length>1) window.currentIndex = categorys[1]-1;
                    Inditex.getRestCatalogCategory({
                        categoryId: categoryId,
                        onSuccess:function(category){
                            if ("PRODUCTOS_RELACIONADOS"==productOrigin.categoryType
                                || "ULTIMOS_PRODUCTOS_VISTOS"==productOrigin.categoryType
                                || "ENTRADA EXTERNA"==productOrigin.categoryType
                                || "FICHA_PRODUCTO"==productOrigin.categoryType
                            ){
                                Inditex._setECBrand(productOrigin.categoryType);
                            } else  {
                                Inditex._setECBrand(category.nameEn?category.nameEn:"unknow");
                            }
                            Inditex._setECCategory(category.key?category.key.replace(new RegExp("[-_]","g"), "/"):"unknow");
                            Inditex.request({
                                "url": url,
                                "onSuccess": function(aText) {
                                    popupCestaUrl(aText, "919px", "604px");
                                }
                            });
                        },
                        onFailure:function(){
                            Inditex._setECBrand("unknow");
                            Inditex._setECCategory("unknow");
                            Inditex.request({
                                "url": url,
                                "onSuccess": function(aText) {
                                    popupCestaUrl(aText, "919px", "604px");
                                }
                            });
                        }
                    });
                }
            }
        });
    } else {
        Inditex.request({
            "url": url,
            "onSuccess": function(aText) {
                popupCestaUrl(aText, "919px", "604px");
            }
        });
    }
}

function trackingCambiarCantidad(quantity,categoryEvent,index, action) {
    var lista = $(shopCartJSON).data('lista');
    var product  = lista[index];
    var partnumber_sin_talla = product.partnumber.substring(0,11)+product.partnumber.substring(13);

    var setAction;
    if(action=='incrementar'){
        setAction= 'add';
    }else{
        setAction= 'remove';
    }
    if(action == 'eliminar'){
        Inditex.trackEvent('/',action);
    }else{
        Inditex.trackEvent('/Cesta_de_Compra',action);
    }
    if (Inditex.iEnableUniversalAnalytics) {
        Inditex.getUserJSON(function(e){
            var categoryType = 'unknow';
            var categoryData = 'unknow';
            var parentId = 0;
            $.each(e.shopCart.items,function(index,item){
                if (item.reference==product.partnumber) {
                    if (item.origin && item.origin.length>0) {
                        var productOrigin = item.origin[0];
                        categoryType = productOrigin.categoryType?productOrigin.categoryType:'unknow';
                        categoryData = productOrigin.categoryData?productOrigin.categoryData:'unknow';
                        parentId = productOrigin.parentId?productOrigin.parentId:item.parentId;
                    } else {
                        parentId = item.parentId;
                    }
                    return;
                }
            });
            var categorys = categoryData.split("#");
            var categoryId = parseInt(categorys[0]);
            if (isNaN(categoryId)){
                categoryId=0;
            }
            var position =0;
            if (categorys.length>1) {
                position = parseInt(categorys[categorys.length-1]);
            }
            Inditex.getRestCatalogProductDetail({
                categoryId:0,
                productId:parentId,
                onSuccess:function(json){
                    Inditex.getRestCatalogCategory({
                        categoryId: categoryId,
                        onSuccess:function(category){
                            var ecbrand = "unknow";
                            var eccategory = "unknow";
                            if ("BUSCADOR"==categoryType){
                                ecbrand=categoryType;
                                eccategory="Buscador_"+(categorys.length>1?categorys[1]:'');
                            } else {
                                if ("PRODUCTOS_RELACIONADOS"==categoryType
                                    || "ULTIMOS_PRODUCTOS_VISTOS"==categoryType
                                    || "ENTRADA EXTERNA"==categoryType
                                    || "FICHA_PRODUCTO"==categoryType
                                ){
                                    ecbrand=categoryType;
                                } else  {
                                    ecbrand=category.nameEn?category.nameEn:'unknow';
                                }
                                eccategory=category.key?category.key.replace(new RegExp("[-_]","g"), "/"):'unknow';
                            }
                            var partnumber_sin_talla = '';
                            if(json.type == 'ProductBean'){
                                partnumber_sin_talla = product.partnumber.substring(0,11)+json.detail.reference.substring(8);
                            }else{
                                for (var i=0; i<json.bundleProductSummaries.length; i++) {
                                    var productJSON = json.bundleProductSummaries[i];
                                    if (productJSON.id==product.productId) {
                                        partnumber_sin_talla = product.partnumber.substring(0,11)+productJSON.detail.reference.substring(8);
                                    }
                                }
                            }
                            Inditex.ga( 'ec:addProduct',{
                                'id': partnumber_sin_talla,
                                'name': json.name,
                                'list': categoryType,
                                'brand': ecbrand,
                                'category': eccategory,
                                'position': position,
                                'price': product.unitPrice,
                                'quantity': quantity
                            });
                            Inditex.ga( 'ec:setAction', setAction);
                            Inditex.trackEvent( categoryEvent,action, partnumber_sin_talla,true);
                        },
                        onFailure:function(){
                            Inditex.trackEvent( categoryEvent,action, partnumber_sin_talla,true);
                        }
                    });
                },
                onFailure:function(){
                    Inditex.trackEvent( categoryEvent,action, partnumber_sin_talla,true);
                }
            });
        });
    }
}
;
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_1.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_2.js (en_US) */
/**
 * Metodo que carga los datos generales del producto
 */
function loadPaso_2() {
    loadRadiosAndChecks();

    jQuery(window).bind('resize', function(e){
        if (e.target==window) {
            fitFooterBottomTunel($('#tunel'));
        }
    });
    removeValueFromFieldOnClick("fechaNacimiento");
    $.validator.setDefaults({
        submitHandler : function(form) {
        }
    });

    if ($('#typeJsp').attr('value')=='ItxStaticLogonGuestUserView') { //Estamos en esa jsp porque la tienda con usuario guest activado

        if ((navigator.userAgent.indexOf('Chrome') > -1) || (navigator.userAgent.indexOf("Safari") > -1))
            selectBinds(21.5,'%');
        else
            selectBinds(98,'%');

        loadValidatorsPaso2Guest();

        $("#r_pers").click(function(event) {
            event.preventDefault();
            $("#datosEmpresa").hide();
            $("#datosPersona").show();
            fitFooterBottomTunel($('#tunel'));
        });
        $("#r_emp").click(function(event) {
            event.preventDefault();
            $("#datosEmpresa").show();
            $("#datosPersona").hide();
            fitFooterBottomTunel($('#tunel'));
        });

        $("#r_pers").next().click();

        setTimeout(function(){
            fitFooterBottomTunel($('#tunel'));
        },800);
        submitFormOnEnter();

        if ($('#tieneYaDireccionFacturacion').length && $('#tieneYaDireccionFacturacion').attr('value')!="") {

            if ($('#tipoDatosFacturacion').attr('value')=="P") {
                cargaDatosPersona (guestUserBillingAddress);
            }
            else {
                cargaDatosEmpresa (guestUserBillingAddress);
            }
        }
    }
    else { // Estamos en esa jsp porque tienda con usuario guest desactivado

        loadValidatorsPaso2();

        $("#r_pers2").click(function(event) {
            event.preventDefault();
            $("div[name=datosEmpresa]").hide();
            fitFooterBottomTunel($('#tunel'));
        });
        $("#r_emp2").click(function(event) {
            event.preventDefault();
            $("div[name=datosEmpresa]").show();
            fitFooterBottomTunel($('#tunel'));
        });

        $("#r_pers2").next().click();

        setTimeout(function(){
            fitFooterBottomTunel($('#tunel'));
        },800);
        submitFormOnEnter();
    }

}

function cargaDatosPersona (guestUserBillingAddress) {

    $("#datosPersona #nombre").attr ('value',guestUserBillingAddress.firstName);
    $("#datosPersona #apellido").attr ('value',guestUserBillingAddress.lastName);
    var phone1=guestUserBillingAddress.phone1.split(' ');
    $("#datosPersona #telefono").attr ('value',phone1[1]);
    var phone2=guestUserBillingAddress.phone2.split(' ');
    $("#datosPersona #telefono2").attr ('value',phone2[1]);
    $("#email1").attr ('value',guestUserBillingAddress.email);
    $("#email2").attr ('value',guestUserBillingAddress.email);
    if (iCountry=='RU')
        $('#datosPersona #patro').attr ('value',guestUserBillingAddress.middleName);
    $("#datosPersona #direccion").attr ('value',guestUserBillingAddress.street);
    $("#datosPersona #direccion2").attr ('value',guestUserBillingAddress.street2);
    $("#datosPersona #localidad").attr ('value',guestUserBillingAddress.city);
    $("#datosPersona #provincia option[value="+guestUserBillingAddress.stateISO+"]").attr("selected",true);
    changeCustomSelect($("#signupForm").find('#select-provincia li[v=' + guestUserBillingAddress.stateISO + ']'), $("#signupForm"));
    $("#datosPersona #cp").attr ('value',guestUserBillingAddress.zipCode);

    $("#datosEmpresa #nombreEmp").attr ('value',guestUserBillingAddress.firstName);
    $("#datosEmpresa #apellidoEmp").attr ('value',guestUserBillingAddress.lastName);
    $("#datosEmpresa #telefonoEmp").attr ('value',phone1[1]);
    $("#datosEmpresa #telefonoEmp2").attr ('value',phone2[1]);
}

function cargaDatosEmpresa (guestUserBillingAddress) {

    $("#datosEmpresa #nombreEmpresa").attr ('value',guestUserBillingAddress.nameCompany);
    $("#datosEmpresa #nif").attr ('value',guestUserBillingAddress.nif);
    $("#datosEmpresa #nombreEmp").attr ('value',guestUserBillingAddress.firstName);
    $("#datosEmpresa #apellidoEmp").attr ('value',guestUserBillingAddress.lastName);
    $("#datosEmpresa #direccion").attr ('value',guestUserBillingAddress.street);
    $("#datosEmpresa #direccion2").attr ('value',guestUserBillingAddress.street2);
    $("#datosEmpresa #localidad").attr ('value',guestUserBillingAddress.city);
    $("#datosEmpresa #provincia option[value="+guestUserBillingAddress.stateISO+"]").attr("selected",true);
    changeCustomSelect($("#signupForm").find('#select-provincia li[v=' + guestUserBillingAddress.stateISO + ']'), $("#signupForm"));
    $("#datosEmpresa #cp").attr ('value',guestUserBillingAddress.zipCode);
    var phone1=guestUserBillingAddress.phone1.split(' ');
    $("#datosEmpresa #telefonoEmp").attr ('value',phone1[1]);
    var phone2=guestUserBillingAddress.phone2.split(' ');
    $("#datosEmpresa #telefonoEmp2").attr ('value',phone2[1]);
    $("#email1").attr ('value',guestUserBillingAddress.email);
    $("#email2").attr ('value',guestUserBillingAddress.email);
    if (iCountry=='RU')
        $('#datosEmpresa #patroEmp').attr ('value',guestUserBillingAddress.middleName);

    $("#radio_r_pers").removeClass ('active');
    $("#datosPersona").attr ('style','display:none');
    $("#radio_r_emp").addClass ('active');
    $("#datosEmpresa").attr ('style','display:block');
    $("input[name=tipoDatosPersonales][value=empresa]").attr('checked', true);

    $("#datosPersona #nombre").attr ('value',guestUserBillingAddress.firstName);
    $("#datosPersona #apellido").attr ('value',guestUserBillingAddress.lastName);
    $("#datosPersona #telefono").attr ('value',phone1[1]);
    $("#datosPersona #telefono2").attr ('value',phone2[1]);
}


function loadValidatorsPaso2() {
    nlInputBinds();

    // validate the comment form when it is submitted
    $("#loginForm").validate({
        submitHandler : function(form) {
            var formLogin = $("#loginForm");
            jQuery.xajax({
                url: formLogin.attr("action"),
                type: 'post',
                data: formLogin.serialize(),
                success: function(jsonRequest) {

                    if ((jsonRequest) && ((jsonRequest.errorKey==undefined) || (jsonRequest.errorKey==null))) {
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Envio_OK");
                        window.location.href = $("#OrderShippingUrl").val();
                    } else{

                        if (jsonRequest.data.passwordExpired == "1") {
                            openModalCambioPasswordExpired($('#urlResetPassword').val(),null,200,null, $('#captchaURL').val(), $("#OrderShippingUrl").val());
                        } else {
                            if (Inditex)
                                Inditex.trackPage("/Identificate/Envio_Error_" + jsonRequest.errorKey);
                            openStaticModal("ERROR", jsonRequest.errorMessage.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace("_supportPhone_",Inditex.iStoreJSON.details.supportPhone), false);
                        }



                    }
                }
            });
        },
        rules : {
            logonId : {
                required : true,
                email : true
            },
            logonPassword : {
                required : true
            }
        },
        messages : {
            logonId : Messages.logonId,
            logonPassword : Messages.logonPassword
        }
    });

    // validate signup form on keyup and submit
    $("#signupForm").validate({
        submitHandler : function(form) {
            var formLogin = $("#signupForm");
            var birthdate = $('#fechaNacimiento').val().split("/");
            if (birthdate.length == 3) {
                $('#day').val(birthdate[0]);
                $('#month').val(birthdate[1]);
                $('#year').val(birthdate[2]);
            }

            jQuery.xajax({
                url: formLogin.attr("action"),
                type: 'post',
                data: formLogin.serialize(),
                dataType: 'json',
                success: function(data) {
                    if  (data.status > 0) {
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Registrarse/Envio_OK");
                        window.location.href = $("#OrderShippingUrl").val();
                    } else{
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Registrarse/Envio_Error_" + data.type);
                        openStaticModal(data.title, data.errorMessage, false);
                    }
                }
            });
        },
        rules	: {
            sexo : "required",
            firstName: "required",
            middleName: "required",
            companyName: "required",
            nif : {
                required:true,
                validateNif: true
            },
            privatePolicy : "required",
            lastName: "required",
            city: "required",
            birthDate : {
                requiredChangeClassLocalDate : true
            },
            zipCode: {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            state:"itxSelect",
            country:"required",
            phone1Prefix : {
                validPrefixRegister : true,
                required : true
            },
            phone1 : {
                validatePhoneRegister : true//,
                //required : true
            },
            phone2 : {
                validatePhone : true
            },
            phone2Prefix : {
                validPrefix : true
            },
            city : "required",
            email1 : {
                required : true,
                email : true
            },
            email2 : {
                required : true,
                email : true,
                equalTo : ".email1Reg"
            },
            logonPassword : {
                validNewPassword : true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                required : true,
                minlength : 8,
                equalTo : "#password"
            }
        },
        messages: {
            sexo : Messages.sexo,
            firstName : Messages.required,
            middleName : Messages.requiredMiddleName,
            nif : {
                required:Messages.required,
                validateNif: Messages.nifIncorrecto
            },
            companyName : Messages.required,
            lastName: Messages.lastName,
            birthDate : Messages.bithDate,
            zipCode: {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },
            state: Messages.state,
            country: Messages.country,
            city: Messages.city,
            phone1: {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            phone2:eval('Messages.phone_' + iCountry),
            email1: Messages.email1,
            email2: {
                required: Messages.required,
                email: Messages.email1,
                equalTo: Messages.emailEqualTo
            },
            logonPassword: {
                required: Messages.required,
                minlength: Messages.minlength
            },
            logonPasswordVerify: {
                required: Messages.required,
                minlength: Messages.minlength,
                equalTo: Messages.equalTo
            }
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=nif]").rules("remove");

        $("input[name=nif]").rules("add", {
            required:true,
            validateNifCif:  function(element){
                return true;
            },
            messages: {
                required:Messages.required,
                validateNifCif:Messages.nifIncorrectoMX
            }
        });

    }

    if (iCountry == "US") {
        $("input[name=address1]").rules("add", {
            required: true,
            maxlength: 35,
            messages: {
                required: Messages.address1
                //maxlength: "long"
            }
        });
    } else  {
        $("input[name=address1]").rules("add", {
            required: true,
            messages: {
                required: Messages.address1
            }
        });
    }

    //Este formulario desaparece pero se mantiene su validacion por si es necesario recuperarlo
    $("#personaForm").validate({
        submitHandler : function(form) {
            $('#modif_datos').hide();
            $('#datos_pers').hide();
        },
        rules : {
            nombreField : "required",
            apellidosField : "required",
            direccionField : "required",
            localidadField : "required",
            cpField : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            provinciaField : "required",
            emailField : {
                required : true,
                email : true
            }
        },
        messages : {
            nombreField : "Debe rellenar este campo",
            apellidosField : "Debe rellenar este campo",
            localidadField : "Debe rellenar este campo",
            direccionField : "Debe rellenar este campo",
            cpField : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },
            provinciaField : "Debe rellenar este campo",
            emailField : "Por favor introduzca un email valido"
        }
    });

    //Este formulario desaparece pero se mantiene su validacion por si es necesario recuperarlo
    $("#empresaForm").validate({
        submitHandler : function(form) {
            $('#modif_datos').hide();
            $('#datos_emp').hide();
        },
        rules : {
            nombreEmpresaField : "required",
            nifField : {
                required : true
            },
            emailField : {
                required : true,
                email : true
            },
            nombreField : "required",
            apellidosField : "required",
            direccionField : "required",
            cpField : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            provinciaField : "required",
            pais : "required",
            localidadField : "required"
        },
        messages : {
            nombreEmpresaField : "Introduzca su nombre",
            nifField : {
                required:Messages.required
            },
            nombreField : "Debe rellenar este campo",
            apellidosField : "Debe rellenar este campo",
            direccionField : "Domicilio o trabajo",
            cpField : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },
            provinciaField : "Elija su provincia",
            localidadField : "Debe rellenar este campo",
            emailField : "Por favor introduzca un email valido",
            pais : "Elija su pais"
        }
    });
}

function modificarDatos() {
    $('#modif_datos').toggle()
}

function showFormularioEmpresa(showFormEmpresa) {
    if(showFormEmpresa) {
        $('#datos_pers').hide();
        $('#datos_emp').show();
    } else {
        $('#datos_pers').show();
        $('#datos_emp').hide();
    }
}

function suscribeToNewsletter (onSuccess) {

    if ( $( "#check_newsletter" ).hasClass( "active" ) ) {

        var url = Inditex.generateUrl('SubscribeNewslettersCmd', {
            "storeId"				: Inditex.iStoreId,
            "catalogId"				: Inditex.iCatalogId,
            "langId"				: Inditex.iLangId,
            "categoryId"			: Inditex.iCategoryId,
            "mail"					: $('#email1').val(),
            "userIdForProcess"		: $('#memberId').val(),
            "checkoutAsGuest"		: true,
            "viewTaskName"			: "NoURL",
            "viewname"				: "ItxResponseJSON",
            "errorViewName"			: "ItxDynamicError",
            "newslettersName"		: "newsletterGeneral",
            "privacyPolicy"			: "on"
        }, true);

        Inditex.request({
            "url": url,
            "onSuccess": function(aText) {
                onSuccess ();
            },
            "onFailure": function(aText) {
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
    }
    else {

        onSuccess ();
    }
}

function loadValidatorsPaso2Guest() {
    nlInputBinds();

    // validate the comment form when it is submitted
    $("#loginForm").validate({
        submitHandler : function(form) {
            var formLogin = $("#loginForm");
            jQuery.xajax({
                url: formLogin.attr("action"),
                type: 'post',
                data: formLogin.serialize(),
                success: function(jsonRequest) {

                    if ((jsonRequest) && ((jsonRequest.errorKey==undefined) || (jsonRequest.errorKey==null))) {
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Envio_OK");
                        Inditex.trackEvent( categoryEvent,"Login_ok",null,{
                            'hitCallback':function(){
                                window.location.href = $("#OrderShippingUrl").val();
                            }
                        });
                    } else{

                        if (jsonRequest.data.passwordExpired == "1") {
                            openModalCambioPasswordExpired($('#urlResetPassword').val(),null,200,null, $('#captchaURL').val(), $("#OrderShippingUrl").val());
                        } else {
                            if (Inditex) {
                                Inditex.trackPage("/Identificate/Envio_Error_" + jsonRequest.errorKey);
                                Inditex.trackEvent( categoryEvent,"Login_error",Inditex.codeError(jsonRequest.errorKey,jsonRequest.errorMessage),true);
                            }
                            openStaticModal("ERROR", jsonRequest.errorMessage.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace("_supportPhone_",Inditex.iStoreJSON.details.supportPhone), false);
                        }



                    }
                }
            });
        },
        rules : {
            logonId : {
                required : true,
                email : true
            },
            logonPassword : {
                required : true
            }
        },
        messages : {
            logonId : Messages.logonId,
            logonPassword : Messages.logonPassword
        }
    });

    // validate signup form on keyup and submit
    $("#signupForm").validate({
        submitHandler : function(form) {

            var middleName="";

            if ($('#tieneYaDireccionFacturacion').attr('value')=="") {

                if ($('input[name=tipoDatosPersonales]:checked', '#signupForm').attr('value')=='personal') {

                    if ($('#datosPersona #patro').length>0) {
                        middleName=$('#datosPersona #patro').val();
                    }
                    var parametros = {
                        "storeId"					: Inditex.iStoreId,
                        "languageId"				: Inditex.iLangId,
                        "memberId"					: $('#memberId').val(),
                        "firstName"					: $('#datosPersona #nombre').val(),
                        "lastName"					: $('#datosPersona #apellido').val(),
                        "middleName"				: middleName,
                        "isCompany"					: false,
                        "countryCode"				: $('#countryCode').val(),
                        "phoneCountryCode_0"		: $('#datosPersona #prefijo').val(),
                        "phoneSubscriberNumber_0"	: $('#datosPersona #telefono').val(),
                        "phoneCountryCode_1"		: $('#datosPersona #prefijo2').val(),
                        "phoneSubscriberNumber_1"	: $('#datosPersona #telefono2').val(),
                        "isShippingAddress"			: false,
                        "email"					    : $('#email1').val(),
                        "checkUserExists"           : "true",
                        "viewname"					: "ItxStandardJSON",
                        "errorViewName"				: "ItxStandardJSON"
                    };
                    if ($("#hasVirtualGiftCard").val()=="true") {
                        $.extend(parametros,{
                            "addressLine_0"				: $('#datosPersona #direccion').val(),
                            "addressLine_1"				: $('#datosPersona #direccion2').val(),
                            "city"						: $('#datosPersona #localidad').val(),
                            "zipCode"					: $('#datosPersona #cp').val(),
                            "stateCode"					: $('#datosPersona #provincia').val(),
                            "countryCode"				: $('#countryCode').val(),
                            "isFullAddress"			: "true"
                        });
                    }

                    Inditex.orderManage({
                        "customRequest": jQuery.xajax,
                        "url": Inditex.generateUrl("ItxStandardAddAddressCmd", parametros,true),
                        "type": "post",
                        "dataType": 'json',
                        "success": function(json, textStatus, jqXHR) {
                            if (json.errorKey == null )
                                Inditex.trackEvent( categoryEvent,"Sin_registro_ok",null,{
                                    'hitCallback': function(){

                                        suscribeToNewsletter (function () { document.location.href=$("#urlShopCart").attr('value'); });
                                    }
                                },true);
                            else {
                                Inditex.trackEvent( categoryEvent,"Sin_registro_error",Inditex.codeError(json.errorKey,json.errorMessage),true);
                                openStaticModal(Messages.tituloUserRegistered, ITX_TEXT_EMAIL_USER_REGISTERED, false);
                            }
                        },
                        "error": function(xhr) {
                            Inditex.trackEvent( categoryEvent,"Sin_registro_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                            showError(ITX_TEXT_GENERIC_PROBLEM);
                        }
                    });
                }
                else {

                    if ($('#datosEmpresa #patroEmp').length>0) {
                        middleName=$('#datosEmpresa #patroEmp').val();
                    }

                    Inditex.orderManage({
                        "customRequest": jQuery.xajax,
                        "url": Inditex.generateUrl("ItxStandardAddAddressCmd", {
                            "storeId"					: Inditex.iStoreId,
                            "languageId"				: Inditex.iLangId,
                            "memberId"					: $('#memberId').val(),
                            "companyName"				: $('#datosEmpresa #nombreEmpresa').val(),
                            "companyVatin"				: $('#datosEmpresa #nif').val(),
                            "firstName"					: $('#datosEmpresa #nombreEmp').val(),
                            "lastName"					: $('#datosEmpresa #apellidoEmp').val(),
                            "middleName"				: middleName,
                            "isCompany"					: true,
                            "addressLine_0"				: $('#datosEmpresa #direccion').val(),
                            "addressLine_1"				: $('#datosEmpresa #direccion2').val(),
                            "city"						: $('#datosEmpresa #localidad').val(),
                            "zipCode"					: $('#datosEmpresa #cp').val(),
                            "stateCode"					: $('#datosEmpresa #provincia').val(),
                            "countryCode"				: $('#countryCode').val(),
                            "phoneCountryCode_0"		: $('#datosEmpresa #prefijoEmp').val(),
                            "phoneSubscriberNumber_0"	: $('#datosEmpresa #telefonoEmp').val(),
                            "phoneCountryCode_1"		: $('#datosEmpresa #prefijoEmp2').val(),
                            "phoneSubscriberNumber_1"	: $('#datosEmpresa #telefonoEmp2').val(),
                            "colony"					: ($('#datosEmpresa #colony')&&$('#datosEmpresa #colony').length>0)?$('#datosEmpresa #colony').val():"",
                            "municipality"				: ($('#datosEmpresa #municipality')&&$('#datosEmpresa #municipality').length>0)?$('#datosEmpresa #municipality').val():"",
                            "isShippingAddress"			: false,
                            "email"					    : $('#email1').val(),
                            "checkUserExists"           : "true",
                            "viewname"					: "ItxStandardJSON",
                            "errorViewName"				: "ItxStandardJSON"
                        },true),
                        "type": "post",
                        "dataType": 'json',
                        "success": function(json, textStatus, jqXHR) {
                            if (json.errorKey == null )
                                suscribeToNewsletter (function () { document.location.href=$("#urlShopCart").attr('value'); });
                            else
                                openStaticModal(Messages.tituloUserRegistered, ITX_TEXT_EMAIL_USER_REGISTERED, false);
                        },
                        "error": function() {
                            showError(ITX_TEXT_GENERIC_PROBLEM);
                        }
                    });
                }
            }
            else {

                if ($('input[name=tipoDatosPersonales]:checked', '#signupForm').attr('value')=='personal') {

                    if ($('#datosPersona #patro').length>0) {
                        middleName=$('#datosPersona #patro').val();
                    }

                    var parametros = {
                        "storeId"					: Inditex.iStoreId,
                        "languageId"				: Inditex.iLangId,
                        "addressId"					: guestUserBillingAddress.addressId,
                        "memberId"					: $('#memberId').val(),
                        "firstName"					: $('#datosPersona #nombre').val(),
                        "lastName"					: $('#datosPersona #apellido').val(),
                        "middleName"				: middleName,
                        "isCompany"					: false,
                        "countryCode"				: $('#countryCode').val(),
                        "phoneCountryCode_0"		: $('#datosPersona #prefijo').val(),
                        "phoneSubscriberNumber_0"	: $('#datosPersona #telefono').val(),
                        "phoneCountryCode_1"		: $('#datosPersona #prefijo2').val(),
                        "phoneSubscriberNumber_1"	: $('#datosPersona #telefono2').val(),
                        "isShippingAddress"			: false,
                        "email"					    : $('#email1').val(),
                        "viewname"					: "ItxStandardJSON",
                        "errorViewName"				: "ItxStandardJSON",
                        "isFullAddress"			: "true"
                    };

                    if ($("#hasVirtualGiftCard").val()=="true") {
                        $.extend(parametros,{
                            "addressLine_0"				: $('#datosPersona #direccion').val(),
                            "addressLine_1"				: $('#datosPersona #direccion2').val(),
                            "city"						: $('#datosPersona #localidad').val(),
                            "zipCode"					: $('#datosPersona #cp').val(),
                            "stateCode"					: $('#datosPersona #provincia').val(),
                            "countryCode"				: $('#countryCode').val()
                        });
                    }

                    Inditex.orderManage({
                        "customRequest": jQuery.xajax,
                        "url": Inditex.generateUrl("ItxStandardUpdateAddressCmd", parametros,true),
                        "type": "post",
                        "dataType": 'json',
                        "success": function(json, textStatus, jqXHR) {
                            suscribeToNewsletter (function () { document.location.href=$("#urlShopCart").attr('value'); });
                        },
                        "error": function() {
                            showError(ITX_TEXT_GENERIC_PROBLEM);
                        }
                    });
                }
                else {

                    if ($('#datosEmpresa #patroEmp').length>0) {
                        middleName=$('#datosEmpresa #patroEmp').attr('value');
                    }

                    Inditex.orderManage({
                        "customRequest": jQuery.xajax,
                        "url": Inditex.generateUrl("ItxStandardUpdateAddressCmd", {
                            "storeId"					: Inditex.iStoreId,
                            "languageId"				: Inditex.iLangId,
                            "addressId"					: guestUserBillingAddress.addressId,
                            "memberId"					: $('#memberId').val(),
                            "companyName"				: $('#datosEmpresa #nombreEmpresa').val(),
                            "companyVatin"				: $('#datosEmpresa #nif').val(),
                            "firstName"					: $('#datosEmpresa #nombreEmp').val(),
                            "lastName"					: $('#datosEmpresa #apellidoEmp').val(),
                            "middleName"				: middleName,
                            "isCompany"					: true,
                            "addressLine_0"				: $('#datosEmpresa #direccion').val(),
                            "addressLine_1"				: $('#datosEmpresa #direccion2').val(),
                            "city"						: $('#datosEmpresa #localidad').val(),
                            "zipCode"					: $('#datosEmpresa #cp').val(),
                            "stateCode"					: $('#datosEmpresa #provincia').val(),
                            "countryCode"				: $('#countryCode').val(),
                            "colony"					: ($('#datosEmpresa #colony')&&$('#datosEmpresa #colony').length>0)?$('#datosEmpresa #colony').val():"",
                            "municipality"				: ($('#datosEmpresa #municipality')&&$('#datosEmpresa #municipality').length>0)?$('#datosEmpresa #municipality').val():"",
                            "phoneCountryCode_0"		: $('#datosEmpresa #prefijoEmp').val(),
                            "phoneSubscriberNumber_0"	: $('#datosEmpresa #telefonoEmp').val(),
                            "phoneCountryCode_1"		: $('#datosEmpresa #prefijoEmp2').val(),
                            "phoneSubscriberNumber_1"	: $('#datosEmpresa #telefonoEmp2').val(),
                            "isShippingAddress"			: false,
                            "email"					    : $('#email1').val(),
                            "viewname"					: "ItxStandardJSON",
                            "errorViewName"				: "ItxStandardJSON"
                        },true),
                        "type": "post",
                        "dataType": 'json',
                        "success": function(json, textStatus, jqXHR) {
                            suscribeToNewsletter (function () { document.location.href=$("#urlShopCart").attr('value'); });
                        },
                        "error": function() {
                            showError(ITX_TEXT_GENERIC_PROBLEM);
                        }
                    });
                }
            }
        },
        rules : {
            nombre : "required",
            nombreEmp : "required",
            nombreEmpresa : "required",
            nif : "required",
            patro: "required",
            patroEmp: "required",
            apellido : "required",
            apellidoEmp : "required",
            fechaNacimiento : {
                requiredChangeClassLocalDate : true
            },
            prefijo : {
                validPrefix : true,
                required : true
            },
            telefono : {
                required : true,
                number : true,
                validatePhone : true
            },
            telefono2 : {
                number : true,
                validatePhone : true
            },
            prefijo2 :{
                validPrefix : true
            },
            prefijoEmp : {
                validPrefix : true,
                required : true
            },
            telefonoEmp : {
                required : true,
                number : true,
                validatePhone : true
            },
            telefonoEmp2 : {
                number : true,
                validatePhone : true
            },
            prefijoEmp2 :{
                validPrefix : true
            },
            direccion : "required",
            localidad : "required",
            cp : "requiredChangeClass",
            provincia : "itxSelect",
            pais : "required",
            email1 : {
                required : true,
                email : true
            },
            email2 : {
                required : true,
                email : true,
                equalTo : "#email1"
            },
            privatePolicy : "required"

        },
        messages : {
            genero : Messages.genero,
            nombre : Messages.rellenarCampo,
            nombreEmp : Messages.rellenarCampo,
            patro : Messages.rellenarCampo,
            patroEmp : Messages.rellenarCampo,
            nombreEmpresa : Messages.rellenarCampo,
            nif : Messages.rellenarCampo,
            apellido : Messages.rellenarCampo,
            apellidoEmp : Messages.rellenarCampo,
            fechaNacimiento : Messages.rellenarFecha,
            telefono : Messages.rellenarTelefono,
            telefono2 : Messages.rellenarTelefono,
            telefonoEmp : Messages.rellenarTelefono,
            telefonoEmp2 : Messages.rellenarTelefono,
            localidad : Messages.rellenarTelefono,
            direccion : Messages.rellenarTelefono,
            cp : Messages.rellenarCp,
            provincia : Messages.rellenarCampo,
            pais : Messages.rellenarCampo,
            email1 : Messages.emailValido,
            privatePolicy : Messages.aceptarPolitica,
            email2 : Messages.mismoEmail
        }
    });
    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.required
                //maxlength: "long"
            }
        });
        $("input[name=nif]").rules("remove");

        $("input[name=nif]").rules("add", {
            required:true,
            validateNifCif:  function(element){
                return true;
            },
            messages: {
                required:Messages.required,
                validateNifCif:Messages.nifIncorrectoMX
            }
        });

    }
};
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_2.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_3.js (en_US) */

/* order shipping*/

//Tenemos que configurar estos ids como constantes, ya que cada metodo se comporta distinto
var RECOGER_TIENDA_SHIP_MODE_ID = 1;
var ESTANDAR_SHIP_MODE_ID 		= 2;
var EXPRESS_SHIP_MODE_ID 		= 3;
var	DROPPOINT_SHIP_MODE_ID 		= 4;
var DROPBOX_SHIP_MODE_ID 		= 5;
var SUPEREXPRESS_SHIP_MODE_ID 	= 6;

var zipCodeAllowedSuperExpress = '';
var shipModeIdSuperExpress = '';
var msgEnvioSuperExpress = 'S?per Expr?s';

var zipCodeAllowedExpress = '';
var shipModeIdExpress = '';
var shipModeIdStandard = '';
var shipModeIdStandard2 = '';
var shipModeStore = '';

var idsTiendas = null;
var camposDir;
var shipModeIdAllowed;

var needPatronymic=false;

function loadPaso_3(patronymic) {
    needPatronymic=patronymic;
    jQuery(window).bind('resize', function(e){
        if (e.target==window) {
            fitFooterBottomTunel($('#tunel'));
        }
    });
    nlInputBinds();
    load_detalleCesta(shopCartJSON);

    if(shopCartJSON.hasPersonalize=="true"){
        $("#personalize").show();
    }else{
        $("#personalize").remove();
    }

    symbolPosition = shopCartJSON.currencySuffix.length==0;
    if (!symbolPosition)
        moneda = shopCartJSON.currencySuffix;
    else
        moneda=shopCartJSON.currencyPrefix;

    decimals = shopCartJSON.decimalPlaces;

    if ($("#isUserGuest").attr('value')=="true") {
        cargarDireccionesGuest(direccionesEnvioJSON,patronymic);
    }
    else {
        cargarDirecciones(direccionesEnvioJSON);
    }

    load_tiposEnvio(TiposEnvioJSON);
    cargarTiendas(urlLocatorFav);
    configDataDropPint(TiposEnvioJSON);
    configDataItxDropPoint(TiposEnvioJSON);
    configDataDropBox(TiposEnvioJSON);
    actualizaForm();

    if (zipRestrictionEnabled) {
        $('#typeSending')[0].value = TiposEnvioJSON.defaultShipModeId;
        $("#radio_"+TiposEnvioJSON.defaultShipModeId).click();
        ActualizarDelivery.init();
    } else {
        $("#radio_"+TiposEnvioJSON.defaultShipModeId).click();
    }

    $("#frmOrderShipping").validate();

    if (errorShipping != null) {
        if (errorShipping.errorMessage != "" ) {
            openStaticModal(errorShipping.title, errorShipping.errorMessage, false);
        }
    }

    //if ($("#isUserGuest").attr('value')=="true" && TiposEnvioJSON.linkAddAddressDrop=="" && TiposEnvioJSON.linkUpdateAddressDrop=="") { 
    /*
     if ( $("#isUserGuest").attr('value')=="true" ) { //No mostramos el metodo droppoint si somos invitados
     if ( $('li[code='+DROPPOINT_SHIP_MODE_ID+']').length>0 ) {
     $('li[code='+DROPPOINT_SHIP_MODE_ID+']').attr ('style','display:none;');
     }
     }
     */

    $("#botonContinuar").click(function(event){
        event.preventDefault();

        var direccion = $('#selAddress1').val();
        var metodo = $('#shipModeId').val();

        if (Inditex)
            Inditex.trackEvent('/Tramitacion_Envio','continuar');


        $('#shippingModeId').attr('value',metodo);
        $('#shippingAddressId').attr('value',direccion);



        if ($("#listMetodos > li:visible").length==0) {
            Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError("restrictedZipcode",Messages.restrictedZipcode),true);
            openStaticModal("",Messages.restrictedZipcode,false);
        } else
        if (metodoSeleccionado == RECOGER_TIENDA_SHIP_MODE_ID ) {
            if ($('#physicalStoreRadio').val() == "") {
                Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError("ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS",Messages.ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS),true);
                openStaticModal(Messages.aviso, Messages.ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS, false);
            } else {
                //OK esta todo correcto podemos pasar al paso 4 (Metodo de envio a tienda)
                Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                    'hitCallback':function(){
                        $('#frmOrderShipping').submit();
                    }
                });
            }
        } else {
            if ( metodoSeleccionado == ESTANDAR_SHIP_MODE_ID || metodoSeleccionado == EXPRESS_SHIP_MODE_ID || metodoSeleccionado == SUPEREXPRESS_SHIP_MODE_ID ) {

                if ($("#isUserGuest").val()=="true") {//Para validar un formulario propio de usuarios invitados solamente
                    if ($('#frmOrderShipping').valid()) {
                        saveDataUserGuest();
                    }
                }
                else {
                    Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                        'hitCallback':function(){
                            $('#frmOrderShipping').submit();
                        }
                    });
                    $("#shipModeDP").val("false");
                }
            } else {
                if (metodoSeleccionado == DROPPOINT_SHIP_MODE_ID) {
                    if ($('#frmOrderShipping').valid()) {
                        var shipmodeExtendedInfo = getShipModeExtendedInfoByShipModeId(metodo);
                        if(shipmodeExtendedInfo && shipmodeExtendedInfo.kind && shipmodeExtendedInfo.kind == 'itxdroppoint'){
                            if($('#itxDropPoint #itxIdDropPoint').val() != null && $('#itxDropPoint #itxIdDropPoint').val() != '' && $('#itxDropPoint #itxIdDropPoint').val() != 'null'){
                                saveDataItxDropPoint(TiposEnvioJSON.linkAddAddressDrop)
                            }else{
                                Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError("ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS",Messages.ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS),true);
                                openStaticModal(Messages.aviso, Messages.ERR_ORDER_NOT_VALID_SHIPPING_ADDRESS, false);
                            }
                        }else{
                            saveDataDropPoint(TiposEnvioJSON.linkAddAddressDrop);
                        }
                    }
                } else {
                    if (metodoSeleccionado == DROPBOX_SHIP_MODE_ID) {
                        if ($('#frmOrderShipping').valid()) {
                            saveDataDropBox(TiposEnvioJSON.linkAddAddressDrop);
                        }
                    }
                }
            }
        }
    });

    setTimeout(function(){
        fitFooterBottomTunel($('#tunel'));

    },800);

    $("#elegir_dire").change(function(){
        $("#result").show();
    });

    $("#botonModificarDireccionGuardada").click(function(){
        $('#cambiar_dire').toggle();
    });

    $("#botonGuardarDireccionGuardada").click(function(event){
        event.preventDefault();
        $('#direccionForm').submit();
    });

    $("#botonModificarNuevaDireccion").click(function(event){
        event.preventDefault();
        $("#nueva_dire").show();
        $("#nueva_dire_ok").hide();
    });


    $("#botonGuardarNuevaDireccion").click(function(event){
        event.preventDefault();
        $('#nuevaDireccionForm').submit();
    });

    $("#botonModificarDatosFacturacion").click(function(){
        openGenericModal('includes/modales/gestionarDireccion.html',null,null,null,0.7);
    });

    $("#botonGuardarDatosFacturacion").click(function(event){
        event.preventDefault();
        $('#datosFacturacionForm').submit();
    });




    setTimeout(function(){
        fitFooterBottomTunel($('#tunel'));
    },800);

}

/* Actualiza el estado del formulario en funci?n de la selecci?n del usuario */
var idMetodoEnvio;
var metodoEnvioSeleccionado;
function actualizaForm() {

    //Obtener m?todo de env?o seleccionado
    metodoEnvioSeleccionado = $('#typeSending')[0].value;
    //var tiendaSeleccionada = $('#physicalStoreRadio')[0].value;
    //var metodoEnvioSeleccionado = '12201';
    var envioTienda;
    var dropPoint;
    var dropBox;
    var gastosEnvio;
    var envioStandar;
    var envioExpress;
    var envioSuperExpress;
    //var idMetodoEnvio;

    //Obtener importe y propiedad 'env?oTienda' del m?todo de env?o seleccionado


    lista = TiposEnvioJSON.shippingModes;
    var metodoDefecto = TiposEnvioJSON.defaultShipModeId;
    for(i=0;i< lista.length;i++){
        var item = lista[i];
        if(item.shipModeId==metodoEnvioSeleccionado)
        {
            envioTienda = item.envioTienda;
            dropPoint = item.dropPoint;
            dropBox = item.dropBox;
            gastosEnvio = item.price;
            idMetodoEnvio = item.shipModeId;
            envioStandar = item.envioStandar;
            envioExpress = item.envioExpress;
            envioSuperExpress = item.envioSuperExpress;
        }
    }



    //Actualizar hidden personAddressId con la direcci?n de env?o seleccionada
    $('#personAddressId')[0].value = TiposEnvioJSON.personAddressId;

    //Actualizar hidden 'shipModeId' con el id del m?todo de env?o seleccionado
    $('#shipModeId')[0].value = idMetodoEnvio;
    $('#shippingModeId').value = idMetodoEnvio;



    //Si es env?o en tienda, mostrar el listado de tiendas
    var envioTienda = eval(envioTienda);
    var dropPoint = eval(dropPoint);
    var dropBox = eval(dropBox);
    var envioStandar = eval(envioStandar);
    var envioExpress = eval(envioExpress);
    var envioSuperExpress = eval(envioSuperExpress);





}

var settings = null;
function restValidacionesFormulario() {
    if (settings != null) {
        for (var rule in settings.rules){
            $("#"+rule).rules("remove");
        }
    }
}

//Definimos las validaciones de los formularios	
function addValidarFormularioDropPoint(){
    settings =$("#frmOrderShipping").validate().settings;
    $.extend(settings, {
        rules: {
            idDropPoint: {required: true},
            nameDP: {required: true},
            lastNameDP: {required: true},
            prefijoDP :{
                validPrefix : true,
                required : true
            },
            telefonoDP : {
                required : true,
                validatePhone : true
            }
        },
        messages : {
            idDropPoint : Messages.required,
            nameDP : Messages.required,
            lastNameDP : Messages.required,
            telefonoDP : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            }
        }
    });
    settings = $("#frmOrderShipping").validate().settings;
}

//Definimos las validaciones de los formularios	
function addValidarFormularioItxDropPoint(){
    settings =$("#frmOrderShipping").validate().settings;
    $.extend(settings, {
        rules: {
            itxNameDP: {required: true},
            itxLastNameDP: {required: true},
            itxPrefijoDP :{
                validPrefix : true,
                required : true
            },
            itxTelefonoDP : {
                required : true,
                validatePhone : true
            }
        },
        messages : {
            itxNameDP : Messages.required,
            itxLastNameDP : Messages.required,
            itxTelefonoDP : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            }
        }
    });
    settings = $("#frmOrderShipping").validate().settings;
}

//Definimos las validaciones de los formularios	
function addValidarFormularioDropBox(){
    settings =$("#frmOrderShipping").validate().settings;
    $.extend(settings, {
        rules: {
            identifierDB: {required: true, "validarDropBox" : true},
            identifierPackDB: {required: true},
            nameDB : {required: true},
            lastNameDB : {required: true},
            prefijoDB :{
                validPrefix : true,
                required : true
            },
            telefonoDB : {
                required : true,
                validatePhone : true
            },
            newCityDB: {required: true},
            newZipCodeDB: {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true}
        },
        messages : {
            identifierDB : {required: Messages.required, "validarDropBox": Messages.errorIdentificadorDB},
            identifierPackDB : Messages.required,
            nameDB : Messages.required,
            lastNameDB : Messages.required,
            telefonoDB : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            newCityDB : Messages.required,
            newZipCodeDB : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            }
        }
    });
    settings = $("#frmOrderShipping").validate().settings;
}

//Definimos las validaciones de los formularios	
function addValidarFormularioEstandarExpress(){
    //settings =$("#frmOrderShipping").validate().settings;
    var settings = $('#frmOrderShipping').validate().settings;
    delete settings.rules;
    delete settings.messages;

    if (needPatronymic) {//Si es necesario el middleName, como en Rusia por ejemplo

        settings.rules = {
            nombre : "required",
            apellido : "required",
            patro: "required",
            prefijo : {
                validPrefix : true,
                required : true
            },
            telefono : {
                required : true,
                number : true,
                validatePhone : true
            },
            telefono2 : {
                number : true,
                validatePhone : true
            },
            prefijo2 :{
                validPrefix : true
            },
            direccion : "required",
            localidad : "required",
            cp : "requiredChangeClass",
            provincia : "itxSelect"
        };
        settings.messages = {
            nombre : Messages.rellenarCampo,
            apellido : Messages.rellenarCampo,
            patro : Messages.rellenarCampo,
            telefono : Messages.rellenarTelefono,
            telefono2 : Messages.rellenarTelefono,
            localidad : Messages.rellenarCampo,
            direccion : Messages.rellenarCampo,
            cp : Messages.rellenarCp,
            provincia : Messages.rellenarCampo
        };
    }
    else {//tiendas SIN middleName
        settings.rules = {
            nombre : "required",
            apellido : "required",
            prefijo : {
                validPrefix : true,
                required : true
            },
            telefono : {
                required : true,
                number : true,
                validatePhone : true
            },
            telefono2 : {
                number : true,
                validatePhone : true
            },
            prefijo2 :{
                validPrefix : true
            },
            direccion : "required",
            localidad : "required",
            cp : "requiredChangeClass",
            provincia : "itxSelect"
        };
        settings.messages = {
            nombre : Messages.rellenarCampo,
            apellido : Messages.rellenarCampo,
            telefono : Messages.rellenarTelefono,
            telefono2 : Messages.rellenarTelefono,
            localidad : Messages.rellenarCampo,
            direccion : Messages.rellenarCampo,
            cp : Messages.rellenarCp,
            provincia : Messages.rellenarCampo
        };
    }
    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.rellenarCampo
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.rellenarCampo
                //maxlength: "long"
            }
        });


    }


    //settings = $("#frmOrderShipping").validate().settings;
}

function load_tiposEnvio(data){

    lista = data.shippingModes;
    metodoDefecto = data.defaultShipModeId;
    var metodoEnvio;
    radios = '<input type="hidden" id="typeSending" name="typeSending" value="" />';
    radios +='<input type="hidden" id="codeSending" name="codeSending" value="" />';
    for(i=0;i< lista.length;i++){

        if (eval(lista[i].envioTienda)) {
            metodoEnvio = 1;
            shipModeStore = lista[i].shipModeId;
        } else {
            if (eval(lista[i].envioStandar)) {
                metodoEnvio = 2;
                if(String(lista[i].shipMethod) == String('Standard'))
                    shipModeIdStandard = lista[i].shipModeId;
                else
                    shipModeIdStandard2 = lista[i].shipModeId;
            } else {
                if(eval(lista[i].envioExpress)) {
                    metodoEnvio = 3;
                    zipCodeAllowedExpress = lista[i].zipCodeAllowed;
                    shipModeIdExpress = lista[i].shipModeId

                } else {
                    if(eval(lista[i].dropPoint)) {
                        metodoEnvio = 4;
                    } else {
                        if(eval(lista[i].dropBox)) {
                            metodoEnvio = 5;
                        } else {
                            if(eval(lista[i].envioSuperExpress)) {
                                metodoEnvio = 6;
                                zipCodeAllowedSuperExpress = lista[i].zipCodeAllowed;
                                shipModeIdSuperExpress = lista[i].shipModeId
                                msgEnvioSuperExpress = lista[i].description;
                            }
                        }
                    }
                }
            }
        }

        var clase = '';
        var clasePrice = '';

        if(metodoEnvio == 1){
            clase = "envioTienda";
            clasePrice = "envioTiendaPrice";
        }
        else if(metodoEnvio == 2){
            clase = "envioStandard";
            clasePrice = "envioStandardPrice";
        }


        var drop;
        if ( metodoEnvio == DROPPOINT_SHIP_MODE_ID && (iCountry == 'GB' || iCountry == 'BE'))
        {
            drop = '<span id="gastoEnvioLabel_estandar" class ="'+clase+'" >' + Messages.drops;
        }
        else
        {
            drop = '<span id="gastoEnvioLabel_estandar" class ="'+clase+'" >' + lista[i].description;
        }

        shipmodeExtendedInfo = getShipModeExtendedInfoByShipModeId(lista[i].shipModeId);

        if (shipmodeExtendedInfo) {
            if (zipRestrictionEnabled) {
                radios +='<li id="'+ lista[i].shipModeId+'" class="shipMethod methodHidden" data-kind="'+lista[i].code+'" code="'+metodoEnvio+'">';
            } else {
                radios +='<li code="'+metodoEnvio+'">';
            }
            var label = shipmodeExtendedInfo.dbcode;
            if(shipmodeExtendedInfo.kind == 'pickup') {
                label = 'Tienda';
            } else if (shipmodeExtendedInfo.kind == 'delivery') {
                if(shipmodeExtendedInfo.code=="3"){
                    label = 'Domicilio_estandar';
                }else if(shipmodeExtendedInfo.code=="1"){
                    label = 'Domicilio_express';
                }
            } else if (shipmodeExtendedInfo.kind == 'droppoint') {
                label = 'Droppoint';
            } else if (shipmodeExtendedInfo.kind == 'dropbox') {
                label = 'Packstation';
            }

            radios +=
                '<input type="radio" id="'+ lista[i].shipModeId + '" name="met" onclick="if (Inditex && $(this).data(\'evento\')== \'mouse\') {Inditex.trackEvent(\'/Tramitacion_Envio\',\'seleccion_envio\',\''+ lista[i].shipMethod +'\'); Inditex.trackEvent( categoryEvent,\'Envio_tipo\',\''+ label +'\',true);} actualizaMetodoEnvio(' + metodoEnvio + ','+ lista[i].shipModeId + ',' + lista[i].price +','+lista[i].code+','+lista[i].discount+',\''+shipmodeExtendedInfo.kind+'\');fitFooterBottomTunel($(\'#tunel\'));" />'+
                '<label for="met2">'+ drop + ' : ' + lista[i].longDescription + '</span>'+
                ((formatNumber(lista[i].price) == 0)?
                '&nbsp;<span id="span_' + lista[i].shipModeId +'" class ="'+clasePrice+'">( '+Messages.gratuito+' )</span>  '
                    :'&nbsp;<span id="span_' + lista[i].shipModeId +'" class ="'+clasePrice+'">( ' + formatCurPrice(lista[i].price, decimals,moneda) +')</span>')+
                '</label>'+
                '</li>';
        }
    }

    $("#listMetodos").html(radios);
    loadRadiosAndChecksNew(false);
    $('#listMetodos').show();
}

function  getShipModeExtendedInfoByShipModeId(shipmodeId){
    if(!shipmodeId || !Inditex.iXShippingMethods || !Inditex.iXShippingMethods.shippingMethods || Inditex.iXShippingMethods.shippingMethods.length <= 0){
        return;
    }
    var shipmode;
    $.each(Inditex.iXShippingMethods.shippingMethods,function(index,currentShipmode){
        if(currentShipmode && currentShipmode.id && currentShipmode.id == shipmodeId ){
            shipmode = currentShipmode;
            return;
        }
    });
    return shipmode;

}

function verCPEnvioSuperExpress() {

    if ($("#isUserGuest").attr('value')=="true" && direccionesEnvioJSON.addressShips[0].type!='company') { // si soy usuario invitado, y nno soy empresa (no tengo codigo postal) no lo evaluo
        return false;
    }
    else {

        if ($("#isUserGuest").attr('value')=="true") { //si soy empresa (tengo cp precargado en la direccion de envio) veo ?ste, ya que no tengo selAddress1

            var pCP = $('#direccion_envio #cp').attr('value');
            var er = new RegExp(zipCodeAllowedSuperExpress, 'gi');
            return er.test(pCP);
        }

        else {

            var idAddress = $('input[name=selAddress1]').val();
            var textFindAddress = 'div[id=address_' + idAddress +']';
            var pCP = $(textFindAddress).find('p[name=cp]');

            var er = new RegExp(zipCodeAllowedSuperExpress, 'gi');

            return er.test(pCP.text());
        }
    }
}

var ActualizarDelivery = {
    "getDeliveryMethodSelected": function () {
        var result = {};
        result.dataKind = $('#codeSending').val();
        result.id = $('#typeSending').val();
        result.zipCode = ActualizarDelivery.zipCode.get(result.dataKind);
        return result;
    },
    "checkRestricted" : function (kind) {
        if (kind!=4) {
            var zipCode = ActualizarDelivery.zipCode.get(kind);
            if ($("#isUserGuest").attr('value')=="true" && direccionesEnvioJSON.addressShips[0].type!='company') { // si soy usuario invitado, y nno soy empresa (no tengo codigo postal) no lo evaluo
                Inditex.getShippingMethodsByDefault();
            }
            else {
                Inditex.getShippingMethodsRestrictedByZipCode(zipCode,ActualizarDelivery.functionRestricted,null);
            }
        }
    },
    "functionRestricted" : function (aJson) {
        if (aJson.shippingMethods.length>0) {
            openStaticModal(Messages.aviso, Messages.ERR_ZIPCODE_NOT_ALLOWED, false);
        }
    },
    "zipCode": {
        "get": function (dataKind) {
            var zipCode;
            try {
                switch (parseInt(dataKind)) {
                    case 4: //- 4 Pick Up
                        zipCode =  ActualizarDelivery.zipCode.shop();
                        break;
                    case 6: //- 6 Drop Point
                    case 7: //- 7 Packstation
                        zipCode = ActualizarDelivery.zipCode.user();
                        break;
                    default:
                        if ($("#isUserGuest").attr('value')=="true") { //si entra aqui siendo usario invitado es que es empresa y tiene cp en el formulario
                            zipCode =  ActualizarDelivery.zipCode.deliveryAddressGuest();
                            if (zipCode == undefined || $.trim(zipCode) == "") {
                                zipCode = ActualizarDelivery.zipCode.userGuest();
                            }
                        }
                        else {
                            zipCode =  ActualizarDelivery.zipCode.deliveryAddress();
                            if (zipCode == undefined || $.trim(zipCode) == "") {
                                zipCode = ActualizarDelivery.zipCode.user();
                            }
                        }
                        break;
                }
                if (null==zipCode && undefined==zipCode ) {
                    zipCode = ActualizarDelivery.zipCode.user();
                }
            } catch(err) {
                zipCode = ActualizarDelivery.zipCode.user();
            }
            return zipCode;
        },
        "user": function () {
            return $('#codigo_postal_envio_user').val();
        },
        "shop": function () {
            return $('#tiendasRecogida').find($('a[class="radio active"]')).prev().attr("data-zipCode");
        },
        "deliveryAddress": function (){
            return $('#address_'+$('#selAddress1').val()+' .validateZipCode').text();
        },
        "userGuest": function () {
            return $('#billingAddress .validateZipCode').text();
        },
        "deliveryAddressGuest": function (){
            return $('#direccion_envio #cp').attr('value');
        }
    },
    "delivery" : function (kind) {
        var delivery = {};
        delivery.kind = kind;
        delivery.zipCode = ActualizarDelivery.zipCode.get(kind);
        return delivery;
    },
    "getAllKinds" : function () {
        var kindModes = [];
        $('.shipMethod').each(function(index, value){
            kind = value.getAttribute("data-kind");
            if ($.inArray(kind, kindModes) == -1) {
                kindModes.push(kind);
            }
        });
        return kindModes;
    },
    "init" : function () {
        ActualizarDelivery.bot_sig.hide();
        ActualizarDelivery.checkRestricted("3");

        $.each(ActualizarDelivery.getAllKinds(), function(index, kind){
            ActualizarDelivery.controlador(kind);
        });
        if ($("#listMetodos > li:visible").length>0) {
            ActualizarDelivery.bot_sig.show();
        } else {
            ActualizarDelivery.bot_sig.hide();
            ocultarTiendas();
            mostrarDirecciones();
            var enviosADireccion = $("#listMetodos li[data-kind=1], #listMetodos li[data-kind=3]");
            if (enviosADireccion.length>0) {
                $('#typeSending')[0].value = enviosADireccion[0].id;;
            }
            openStaticModal("",Messages.restrictedZipcode,false);
        }
    },
    "change" : function () {
        ActualizarDelivery.bot_sig.hide();
        kind = $('#codeSending').val();
        ActualizarDelivery.controlador(kind);
        ActualizarDelivery.checkRestricted(kind);
        if ($("#listMetodos > li:visible").length>0) {
            ActualizarDelivery.bot_sig.show();
        } else {
            openStaticModal("",Messages.restrictedZipcode,false);
        }
    },
    "groupKinds" : function (kind) {

        var kindGroup = [parseInt(kind)];
        switch (kind) {
            case "1":
            case "3":
                kindGroup = [1,3]
                break;
        }
        return kindGroup
    },
    "controlador" : function (kind) {
        $.each(ActualizarDelivery.groupKinds(kind), function(index, e){
            var delivery = ActualizarDelivery.delivery(e);
            ActualizarDelivery.updateDeliveryToShowByZipCode(delivery);
            ActualizarDelivery.select(e);
        });
    },
    "updateDeliveryToShowByZipCode" : function (delivery) {
        var aJson = "";
        var isUserGuest = $("#isUserGuest").attr('value');

        if(delivery.zipCode == "" && isUserGuest == "true"){
            aJson = Inditex.getShippingMethodsByDefault();
        }
        else{
            aJson = Inditex.getShippingMethodsByZipCode(delivery.zipCode);
        }

        ActualizarDelivery.hideDelivery(delivery.kind);
        $(aJson.shippingMethods).each(function(index, e){
            if (e.code == delivery.kind) {
                ActualizarDelivery.showShipMethod(e.id);
            }
        });
        if ($("#listMetodos > li:visible").length>0) {
            ActualizarDelivery.bot_sig.show();
        } else {
            ActualizarDelivery.bot_sig.hide();
        }
    },
    "hideDelivery": function (kind) {
        $('#listMetodos').find($('li[data-kind="'+kind+'"]')).hide();
        $('#listMetodos').find($('li[data-kind="'+kind+'"]')).removeClass("show");
    },
    "showShipMethod": function (ship_mode_id) {
        $('#listMetodos').find($('li[id="'+ship_mode_id+'"]')).show();
        $('#listMetodos').find($('li[id="'+ship_mode_id+'"]')).addClass("show");
    },
    "select" : function (kind) {
        defaultKind = $('#codeSending').val();
        if (defaultKind == kind) {
            if (kind == "4") ActualizarDelivery.setIdShop();
            var object = $('#listMetodos').find($('li[data-kind="'+defaultKind+'"].show'));
            if (object.length>0) {
                var a = $('#listMetodos').find($('li[data-kind="'+defaultKind+'"].show a.active'));
                if (a.length==0) {
                    $('#listMetodos').find($('li[data-kind="'+defaultKind+'"].show a')).click();
                }
            } else {
                var obj = $('#listMetodos').find(".show a");
                if (obj.length > 0) {
                    obj[0].click();
                }
            }
        }
    },
    "setIdShop" : function () {
        var ob = $('#tiendasRecogida').find($('a[class="radio active"]'));
        if (ob.length != 0) {
            direccionesEnvioJSON.selectedShopId = ob.prev().attr("data-idShop");
        }
    },
    "bot_sig" : {
        "hide" : function () {
            $('.bot_sig').hide();
        },
        "show" : function () {
            $('.bot_sig').show();
        }
    }

};

function checkearMetodoEnvio() {
    var isActive = $('#listMetodos li .active').length>0;
    if (!isActive) {
        var radioArray= $('#listMetodos li .radio').first();
        var inputArray= $('#listMetodos li .converted').first();
        inputArray.click();
        radioArray.addClass("selected active");
    }
}

function verCPPersonalSuperExpress() {

    if ($("#isUserGuest").attr('value')=="true" && direccionesEnvioJSON.addressShips[0].type!='company') { // si soy usuario invitado, y nno soy empresa (no tengo codigo postal) no lo evaluo
        return false;
    }
    else {
        var textFindAddress = 'div[id=billingAddress]';
        var pCP = $(textFindAddress).find('p[name=cp]');
        var er = new RegExp(zipCodeAllowedSuperExpress, 'gi');
        return er.test(pCP.text());
    }
}






var metodoSeleccionado;
function actualizaMetodoEnvio(metodoEnvio,shipModeId, precio,code,descuento,shipmodeKind){

    actualizaDescuentos(descuento);
    actualizaPrecios(precio);
    $('#typeSending')[0].value=shipModeId;
    $('#codeSending')[0].value=code;
    actualizaForm();
    restValidacionesFormulario();
    switch(metodoEnvio){
        case RECOGER_TIENDA_SHIP_MODE_ID:
            if ($("#listMetodos > li:visible").length>0) $('.bot_sig').show();
            ocultarDirecciones();
            ocultarDropPoint();
            ocultarItxDropPoint();
            ocultarDropBox();
            mostrarTiendas();

            $('#shippingMode').html(Messages.enTienda);
            metodoSeleccionado = RECOGER_TIENDA_SHIP_MODE_ID;

            //shipModeIdSuperExpress es distinto de vacio significa que tiene metodo de envio superexpress la tienda.
            if (shipModeIdSuperExpress != '') {
                if(!verCPPersonalSuperExpress()){
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.hide();
                } else {
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.show();
                }
            }


            break;
        case ESTANDAR_SHIP_MODE_ID:
            if ($("#listMetodos > li:visible").length>0) $('.bot_sig').show();
            ocultarTiendas();
            ocultarDropPoint();
            ocultarItxDropPoint();
            ocultarDropBox();
            mostrarDirecciones();
            $('#shippingMode').html(Messages.estandard);
            metodoSeleccionado = ESTANDAR_SHIP_MODE_ID;

            //shipModeIdSuperExpress es distinto de vacio significa que tiene metodo de envio superexpress la tienda.
            if (shipModeIdSuperExpress != '') {
                if(verCPEnvioSuperExpress()){
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.show();
                    openStaticModal(Messages.aviso, Messages.sendSuperExpress, false);
                } else {
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.hide();
                }
            }
            break;
        case EXPRESS_SHIP_MODE_ID:
            if ($("#listMetodos > li:visible").length>0) $('.bot_sig').show();
            ocultarTiendas();
            ocultarDropPoint();
            ocultarItxDropPoint();
            ocultarDropBox();
            mostrarDirecciones();
            $('#shippingMode').html(Messages.express);
            metodoSeleccionado = EXPRESS_SHIP_MODE_ID;

            //shipModeIdSuperExpress es distinto de vacio significa que tiene metodo de envio superexpress la tienda.
            if (shipModeIdSuperExpress != '') {
                if(verCPEnvioSuperExpress()){
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.show();
                    openStaticModal(Messages.aviso, Messages.sendSuperExpress, false);
                } else {
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.hide();
                }
            }
            break;
        case DROPPOINT_SHIP_MODE_ID:
            if ($("#listMetodos > li:visible").length>0) $('.bot_sig').show();
            ocultarTiendas();
            ocultarDirecciones();
            ocultarDropBox();

            if(shipmodeKind  == 'itxdroppoint'){
                mostrarItxDropPoint();
                ocultarDropPoint();
            }else{
                mostrarDropPoint();
                ocultarItxDropPoint();
            }
            var drop;
            if (iCountry == 'GB' || iCountry == 'BE')
            {
                drop = Messages.drops;
            }
            else
            {
                drop = Messages.droppoint;
            }
            $('#shippingMode').html(drop);
            metodoSeleccionado = DROPPOINT_SHIP_MODE_ID;

            //shipModeIdSuperExpress es distinto de vacio significa que tiene metodo de envio superexpress la tienda.
            if (shipModeIdSuperExpress != '') {
                if(!verCPPersonalSuperExpress()){
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.hide();
                } else {
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.show();
                }
            }
            break;
        case DROPBOX_SHIP_MODE_ID:
            if ($("#listMetodos > li:visible").length>0) $('.bot_sig').show();
            ocultarTiendas();
            ocultarDirecciones();
            ocultarDropPoint();
            ocultarItxDropPoint();
            mostrarDropBox();
            $('#shippingMode').html(Messages.dropbox);
            metodoSeleccionado = DROPBOX_SHIP_MODE_ID;

            //shipModeIdSuperExpress es distinto de vacio significa que tiene metodo de envio superexpress la tienda.
            if (shipModeIdSuperExpress != '') {
                if(!verCPPersonalSuperExpress()){
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.hide();
                } else {
                    var metodoEnvioSuperExpress = $('input[id=' + shipModeIdSuperExpress +']');
                    var li = metodoEnvioSuperExpress.parent();
                    li.show();
                }
            }
            break;
        case SUPEREXPRESS_SHIP_MODE_ID:
            ocultarTiendas();
            ocultarDropPoint();
            ocultarItxDropPoint();
            ocultarDropBox();
            mostrarDirecciones();
            $('#shippingMode').html(msgEnvioSuperExpress);
            metodoSeleccionado = SUPEREXPRESS_SHIP_MODE_ID;

            if(!verCPEnvioSuperExpress()){
                openStaticModal(Messages.aviso, Messages.notSendSuperExpress, false);
                $('.bot_sig').hide();
            } else {
                $('.bot_sig').show();
            }
            break;
        default:
            break;
    }

}

function ocultarDirecciones(){
    $("#direccionEnvio").hide();
}

function mostrarDirecciones(){
    $("#direccionEnvio").show();

    if ($("#isUserGuest").attr('value')=="true") {
        addValidarFormularioEstandarExpress();
    }
}

function ocultarTiendas(){
    $("#tiendaEnvio").hide();
}

function mostrarTiendas(){
    $("#tiendaEnvio").show();
    setTimeout(function(){
        $('#tienda_'+direccionesEnvioJSON.selectedShopId).next().click();

    },3000);
}

function ocultarDropPoint(){
    $("#dropPoint").hide();
}

function mostrarDropPoint(){
    $("#dropPoint").show();
    addValidarFormularioDropPoint();
}

function ocultarItxDropPoint(){
    $("#itxDropPoint").hide();
}
function mostrarItxDropPoint(){
    $("#itxDropPoint").show();
    addValidarFormularioItxDropPoint();
}

function ocultarDropBox(){
    $("#dropBox").hide();
}

function mostrarDropBox(){
    $("#dropBox").show();
    addValidarFormularioDropBox();
}

function actualizaPrecios(precio){

//	shippingPrice = formatNumber(precio,2);
    $("#shippingPrice").html(formatCurPrice(precio,decimals,moneda));
    totalArticles= parseFloat($("#totalArticlesPrice").attr('sinformato'));
    var totalDesc = 0;
    $("[id=totalDescuentoPrice]").each(function(index, e){
        totalDesc = totalDesc + parseFloat($(e).attr('sinformato'));
    });

    if(isNaN(totalDesc))
    {
        totalDesc=0;
    }
    if($("#totalArticlesSalesTax") && $("#totalArticlesSalesTax").length > 0){
        totalSalesTax = parseFloat($("#totalArticlesSalesTax").attr('sinformato'));
    }else{
        totalSalesTax = 0;
    }
    if($("#giftPriceAmount") && $("#giftPriceAmount").length > 0){
        totalGift = parseFloat($("#giftPriceAmount").attr('sinformato'));
    }else{
        totalGift = 0;
    }
    tp = totalArticles + precio+totalDesc + totalSalesTax+totalGift;
    $("#totalPrice").html(formatCurPrice(tp+"",decimals,moneda));
}

var ubicacion;
var shippingAddressIdPosition;

function cargarDirecciones(data){
    //$.getJSON(url, function(data) {
    var elementoDefault =  data.addressShips[0];
    $("#select").empty();

    var navegador = navigator.appName;

    //Aqui da error de google analytics al entrar en el segundo al poner la nueva libreria de jquery (1.11.0)
//		if (navegador == "Microsoft Internet Explorer"){

    var comboInicial = '<div id="selectDireccionEnvio" class="multidrop single tunelenvio" title="'+Messages.dirFacturacion2+'">' +
        '<select id="selectAddress" onchange="cambiarDireccion(this);" title="'+Messages.dirFacturacion2+'">' +
        '</select> </div>';

//		}else{
//		
//			var comboInicial = '<div id="selectDireccionEnvio" class="multidrop single tunelenvio" title="'+Messages.dirFacturacion+'">' +
//            '<select id="selectAddress" onchange="cambiarDireccion(this);" title="'+Messages.dirFacturacion+'">' +					
//            '</select> </div>';
//		}


    $("#mainDireccionEnvio").html(comboInicial);
    shippingAddressId =  data.shippingAddressId;
    lista = data.addressShips;
    direcciones = '';
    ba = '';
    options='';
    // Si el usuario es wallet, la segunda direccion la obviamos ya que es la de facturacion.
    var isWalletUser = Inditex._readUserJSON().isWalletUser;

    if (shippingAddressIdPosition != undefined) {

        for(i=0;i<lista.length;i++){
            if (!isWalletUser || (isWalletUser && i!=1)) {
                var element = lista[i];
                var isDefault = false;
                if (element != null && element != 'undefined') {
                    isDefault = (shippingAddressIdPosition == i);

                    var urlBillingAddress = data.linkOrderUpdateAddressShipping + '&addressId=' + element.addressId;
                    if(element.isBillingAddress){
                        //direccion = JSON.parse(unescape(element));
                        ubicacion = element.city + ',' + element.zipCode;
                        ba = '<div>'+
                            cargaDireccion(element,"'"+urlBillingAddress+"'", "facturacion")+
                            '</div>';
                    }
                    options +=
                        '<option value="' + element.addressId + '" ' + (isDefault?'selected="selected"':'') + '>' +  element.addressDecription + '</option>';
                    direcciones +=
                        '<div id="address_'+element.addressId + '" ' +  (!isDefault?'style="display:none;"':'') + '>'+
                        cargaDireccion(element,"'"+urlBillingAddress+"'", "envio")+
                        '</div>';

                    if (isDefault) {
                        elementoDefault = lista[i];
                        shippingAddressId =element.addressId;
                    }
                }
            }
        }

    } else {
        for(i=0;i<lista.length;i++){
            if (!isWalletUser || (isWalletUser && i!=1)) {
                var element = lista[i];
                var isDefault = false;
                if (element != null && element != 'undefined') {
                    isDefault = (element.addressId == shippingAddressId);

                    if(element.isBillingAddress){
                        //direccion = JSON.parse(unescape(element));
                        ubicacion = element.city + ',' + element.zipCode;
                        ba = '<div>'+
                            cargaDireccion(element,"'"+data.linkOrderUpdateAddressShipping+"'","facturacion")+
                            '</div>';
                    }
                    options +=
                        '<option value="' + element.addressId + '" ' + (isDefault?'selected="selected"':'') + '>' +  element.addressDecription + '</option>';
                    direcciones +=
                        '<div id="address_'+element.addressId + '" ' +  (!isDefault?'style="display:none;"':'') + '>'+
                        cargaDireccion(element,"'"+data.linkOrderUpdateAddressShipping+"'","envio")+
                        '</div>';

                    if (isDefault) {
                        elementoDefault = lista[i];
                    }
                }
            }
        }
    }



    $("#shippingAddresses").html(direcciones);
    $("#billingAddress").html(ba);
    $("#selectAddress").html(options);
    selectBinds(21,'%');
    $('.md-select-ul-li').each(function(){
        if ($(this).attr('v') == shippingAddressId ){
            var obj = $(this);
            var v = $(this).attr('v');
            var s = $(this).attr('s');
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').val(v);
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').change();
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').click();
            obj.parent().parent().parent().parent().parent().find('#select-inner-name-'+s).html($(this).html());
            $(this).parent().parent().parent().parent().parent().find('.enclosing').slideUp('fast');
            $(this).parent().slideUp('slow', function(){
                obj.removeClass('active');
                folding = false;
            });
        }

    });
    if (zipRestrictionEnabled) {
        $('.md-select-ul-li').bind('click' , function(){
            ActualizarDelivery.change();
        });
    }
    /* cargamos la primera por defecto */
    $("[id^=address_]").each(function(){
        if($(this).attr("id") == 'address_' + elementoDefault.addressId){
            $(this).show();

            var pCP = $(this).find('p[name=cp]');
            $("#zipCodeSelected").attr("value", pCP.text());
            $('#zipCodeSelected').change();
        }
        else
            $(this).hide();
    })
    if (elementoDefault.addressId == $("#personAddressId").attr("value")){
        $("#sameAddress")[0].value=true;
    }else {
        $("#sameAddress")[0].value=false;
    }
    $('#selAddress1')[0].value= elementoDefault.addressId;

    $('#personAddressId')[0].value= elementoDefault.addressId;

}

function cargarDireccionesGuest(data,patronymic){
    shippingAddressId =  data.shippingAddressId;
    lista = data.addressShips;
    direcciones = '';
    ba = '';
    options='';
    for(i=0;i<lista.length;i++){
        element=lista[i];
        isDefault = element.addressId==shippingAddressId;
        if(patronymic){
            if(element.isBillingAddress){
                ba = '<div>'+
                    cargaDireccionInvitado(element,patronymic)+
                    '</div>';
            }
            options +=
                '<option value="' + element.addressId + '" ' + (isDefault?'selected="selected"':'') + '>' +  element.addressDecription + '</option>';
            direcciones +=
                '<div id="address_'+element.addressId + '" ' +  (!isDefault?'style="display:none;"':'') + '>'+
                cargaDireccionInvitado(element,patronymic) +
                '</div>';
        }
        else{
            if(element.isBillingAddress){
                ba = '<div>'+
                    cargaDireccionInvitado(element)+
                    '</div>';
            }
            options +=
                '<option value="' + element.addressId + '" ' + (isDefault?'selected="selected"':'') + '>' +  element.addressDecription + '</option>';
            direcciones +=
                '<div id="address_'+element.addressId + '" ' +  (!isDefault?'style="display:none;"':'') + '>'+
                cargaDireccionInvitado(element) +
                '</div>';
        }
    }
    $("#shippingAddresses").html(direcciones);
    $("#billingAddress").html(ba);
    $("#selectAddress").html(options);
    selectBinds(228,'px');
    preFillForm(data,patronymic);
}

function preFillForm(addr,patronymic){
    var dir = addr.addressShips[0];

    if (addr.addressShips.length>1) {
        var dirEnvio=addr.addressShips[1];
        $('#yaHayDireccionEnvio').attr('value','1');
        $('#ShipAddressIdForUpdate').attr('value',addr.addressShips[1].addressId);
    }

    if (dir.type=='company') {

        $('#direccionEnvio #direccion_envio #companyVatin').attr('value',dir.nif);
        $('#direccionEnvio #direccion_envio #companyName').attr('value',dir.nameCompany);
        $('#direccionEnvio #direccion_envio #nombre').attr('value',dir.firstName);
        $('#direccionEnvio #direccion_envio #apellido').attr('value',dir.lastName);
        if(dir.phone1 != null){
            $('#direccionEnvio #direccion_envio #telefono').attr('value',dir.phone1.substr(4,12));
        }
        if(dir.phone2 != null){
            $('#direccionEnvio #direccion_envio #telefono2').attr('value',dir.phone2.substr(4,12));
        }
        $('#direccionEnvio #direccion_envio #direccion').attr('value',dir.street);
        $('#direccionEnvio #direccion_envio #direccion2').attr('value',dir.street2);
        $('#direccionEnvio #direccion_envio #localidad').attr('value',dir.city);
        $("#direccionEnvio #direccion_envio #provincia option[value="+dir.stateISO+"]").attr("selected",true);
        changeCustomSelect($("#frmOrderShipping").find('#select-provincia li[v=' + dir.stateISO + ']'), $("#frmOrderShipping"));
        $('#direccionEnvio #direccion_envio #cp').attr('value',dir.zipCode);
        $('#direccionEnvio #direccion_envio #isCompany').attr('value',true);
        if(patronymic){
            $('#direccionEnvio #direccion_envio #patro').attr('value',dir.middleName);
        }
        if($('#direccionEnvio #direccion_envio #colony')&&$('#direccionEnvio #direccion_envio #colony').length>0){
            $('#direccionEnvio #direccion_envio #colony').attr('value',dir.colony);
        }
        if($('#direccionEnvio #direccion_envio #municipality')&&$('#direccionEnvio #direccion_envio #municipality').length>0){
            $('#direccionEnvio #direccion_envio #municipality').attr('value',dir.municipality);
        }
    }
    else {

        $('#direccionEnvio #direccion_envio #nombre').attr('value',dir.firstName);
        $('#direccionEnvio #direccion_envio #apellido').attr('value',dir.lastName);
        if(dir.phone1 != null){
            $('#direccionEnvio #direccion_envio #telefono').attr('value',dir.phone1.substr(4,12));
        }
        if(dir.phone2 != null){
            $('#direccionEnvio #direccion_envio #telefono2').attr('value',dir.phone2.substr(4,12));
        }
        if (addr.addressShips.length>1) {//cargamos en el resto de campos los datos de la direcci?n de envio si ya la hay
            $('#direccionEnvio #direccion_envio #direccion').attr('value',dirEnvio.street);
            $('#direccionEnvio #direccion_envio #direccion2').attr('value',dirEnvio.street2);
            $('#direccionEnvio #direccion_envio #localidad').attr('value',dirEnvio.city);
            $("#direccionEnvio #direccion_envio #provincia option[value="+dirEnvio.stateISO+"]").attr("selected",true);
            changeCustomSelect($("#frmOrderShipping").find('#select-provincia li[v=' + dirEnvio.stateISO + ']'), $("#frmOrderShipping"));
            $('#direccionEnvio #direccion_envio #cp').attr('value',dirEnvio.zipCode);
        }
        $('#direccionEnvio #direccion_envio #isCompany').attr('value',false);
        if(patronymic){
            $('#direccionEnvio #direccion_envio #patro').attr('value',dir.middleName);
        }
        if($('#direccionEnvio #direccion_envio #colony')&&$('#direccionEnvio #direccion_envio #colony').length>0){
            $('#direccionEnvio #direccion_envio #colony').attr('value',dir.colony);
        }
        if($('#direccionEnvio #direccion_envio #municipality')&&$('#direccionEnvio #direccion_envio #municipality').length>0){
            $('#direccionEnvio #direccion_envio #municipality').attr('value',dir.municipality);
        }
    }
}

function cargarDireccionesUrl(url){
    jQuery.xajax({
        url: url,
        dataType: 'json',
        success: function(data) {
            cargarDirecciones(data);
            fitFooterBottomTunel($('#tunel'));

            setTimeout(function() {
                var radio = $('input[id=typeSending]').val();
                $('input[id='+radio+ ']').click({evento: 'trigger'});
            }, 500);
            if (zipRestrictionEnabled) {
                ActualizarDelivery.init();
            }
        }
    });
}


/** Funci?n para encontrar la latitud y longitud del direcci?n que se especifica
 *  Como la funcion geocode de googel es asincrona tengo que pasar la funcion que
 *  queremos que se ejecute despues de encontrar la longitud y latitud.
 *
 *  Es una forma de hacer sincorono el metodo geocode.
 * **/
function getCorderMapShipping(address, paisISO, callback) {


    //Esto si es necesario.  Ya que canarias googel map retorna  como region "ES" no "ESCN" que propia de Inditex
    if (paisISO == "ESCN" || paisISO == "IC") {
        paisISO = "ES";
    }

    var latlng = [0, 0];
    var geocod = new google.maps.Geocoder();
    geocod.geocode({address: address, 'region': paisISO}, function(lsResult, status) {
        if(status=google.maps.GeocoderStatus.OK) {
            for(var loc=0; loc<lsResult.length; loc++){
                var localizacion = lsResult[loc];
                var datosPais = localizacion.address_components;

                for(var reg=datosPais.length-1; reg>=0; reg--){
                    var region = datosPais[reg];
                    // comprobamos el pais
                    if(!region || (region.types[0]=='country' )) {
                        if (region.short_name == paisISO) {
                            latlng = localizacion.geometry.location;
                            callback.call(this, latlng);

                        }
                    }
                }
            }
        }
    });

}


function cargarTiendas(urlLocatorFav){

    var paisISO = $('input[name="paisISO"]').attr('value');
    var tiendasArray = new Array();
    idsTiendas = new Array();
    tiendas='';

    Inditex.getGoogleCoords(paisISO,ubicacion, function (aResult) {
        var latitud = aResult.geometry.location.lat();
        var longitud = aResult.geometry.location.lng();
        var dataFrom = {latitude: latitud, longitude: longitud};

        jQuery.xajax({
            url: urlLocatorFav+ '&latitude=' +latitud+'&longitude=' +longitud,
            type: "post",
            dataType: 'json',
            success: function(respHtml) {
                var conParametros = true;
                cargarTiendasHelper(respHtml,conParametros);
            }
        });

    });


}

function cargarTiendasHelper(respHtml,conParametros){

    var maxNear=4;
    var tiendasUsrJSON	= getResponseJSON(respHtml);
    if (tiendasUsrJSON==null) return;
    cercanas= tiendasUsrJSON.closerStores;
    ultimas = tiendasUsrJSON.lastUsedStores;
    favoritas = tiendasUsrJSON.favouriteStores;

    for(i=0;i<cercanas.length;i++){
        if(i<maxNear){
            if(idsTiendas.indexOf(cercanas[i].id) < 0){
                tiendas += generateHTMLTiendas(idsTiendas,cercanas[i]);
                idsTiendas.push(cercanas[i].id);
            }
        }else{
            break;
        }
    }
    for(i=0;i<ultimas.length;i++){
        if(idsTiendas.indexOf(ultimas[i].id) < 0){
            tiendas += generateHTMLTiendas(idsTiendas,ultimas[i]);
            idsTiendas.push(ultimas[i].id);
        }
    }
    for(i=0;i<favoritas.length;i++){
        if(idsTiendas.indexOf(favoritas[i].id) < 0){
            tiendas += generateHTMLTiendas(idsTiendas,favoritas[i]);
            idsTiendas.push(favoritas[i].id);
        }
    }

    $("#tiendasRecogida").html(tiendas);
    loadRadiosAndChecksNew(false);
    fitFooterBottomTunel($('#tunel'));

    //si no salen tiendas, puede que tenga mal la direccion y maps no encuentre nada,asique lo hacemos sin geolocalizador
    if(conParametros && tiendas == ''){

        jQuery.xajax({
            url: urlLocatorFav,
            type: "post",
            dataType: 'json',
            success: function(respHtml) {
                var conParametros = false;
                cargarTiendasHelper(respHtml,conParametros);

            }
        });

    }

}

function generateHTMLTiendas(idsTiendas, element){
    var value = '';
    //Si no existe lo a?adimos y generamos html
    if (idsTiendas == null) {
        idsTiendas = new Array();
    }
    if(indexOf(idsTiendas, element) < 0){
        idsTiendas.push(element.id);
        value =
            '<li>'+
            '<input type="radio" id="tienda_' + element.id + '" name="tienda"   onclick="actualizaTienda(' + element.id + ',$(this).data(\'evento\'))" data-zipCode='+element.zipCode+' data-idShop='+element.id+' />'+
            '<label for="tienda' + element.id + '">' + element.city + ' ' + element.name +
            '<br>' ;
        if (element.sections != ''){
            value +=  '( ';


            var sectionName = {sections1: sections1JS, sections2: sections2JS, sections3: sections3JS};

            /*var tokens = element.sections ? element.sections.split(",") : [];
             for (var j = 0; j < tokens.length; j++) {
             var sectionName='DUTTI_SECTION_'+tokens[j];
             value+= window[sectionName];
             value+=", ";
             }
             value=value.substring(0, value.length-2);*/
            element.sections = element.sections.replace("1",  sectionName.sections1);
            element.sections = element.sections.replace("2",  sectionName.sections2);
            element.sections = element.sections.replace("3",  sectionName.sections3);
            element.sections = element.sections.replace(/,/g, " / ");
            value+= element.sections;
            value+= ' )' ;
        }
        value +=  '</label>'+
            '</li>';
    }
    return value;
}

function generateHTMLTiendasOld(idsTiendas, element){
    var value = '';
    //Si no existe lo a?adimos y generamos html
    if (idsTiendas == null) {
        idsTiendas = new Array();
    }
    if(indexOf(idsTiendas, element) < 0){
        idsTiendas.push(element.physicalStoreId);
        value =
            '<li>'+
            '<input type="radio" id="tienda_' + element.physicalStoreId + '" name="tienda"   onclick="actualizaTienda(' + element.physicalStoreId +',$(this).data(\'evento\'))" data-zipCode='+element.postalCode+' data-idShop='+element.physicalStoreId+'  />'+
            '<label for="tienda' + element.physicalStoreId + '">' + element.city + ' ' + element.name +
            '<br>' ;
        if (element.sections != '')
            value +=  '( ' + element.sections + ' )' ;
        value +=  '</label>'+
            '</li>';
    }
    return value;
}

function actualizaTienda(idTienda, evento){
    $('#physicalStoreRadio')[0].value =  idTienda;
    if (zipRestrictionEnabled) {
        ActualizarDelivery.change();
    }
    if (Inditex && (evento == "mouse")){
        Inditex.trackEvent('/Tramitacion_Envio','tienda',''+idTienda);
    }
}






function cambiarDireccion(element){

    $("[id^=address_]").each(function(index, value){
        if($(this).attr("id") == 'address_' + element.value){
            $(this).show();
            shippingAddressIdPosition =  index;

            var pCP = $(this).find('p[name=cp]');
            $("#zipCodeSelected").attr("value", pCP.text());
            $('#zipCodeSelected').change();
        }
        else
            $(this).hide();
    })
    if (element.value == $("#personAddressId").attr("value")){
        $("#sameAddress")[0].value=true;
    }else {
        $("#sameAddress")[0].value=false;
    }
    $('#selAddress1')[0].value= element.value;


}

function showHideMetodoEnvio(showRecogidaTienda, showEstandar, showExpress){
    if (showRecogidaTienda) $("#tiendas").show();
    else $("#tiendas").hide();

    if (showEstandar) $("#direcciones").show();
    else $("#direcciones").hide();
}

function showHideDirecciones(igual, guardada, nueva){
    $(".metodoEnvioBlock").hide();

    if (guardada) $("#elegir_dire").show();
    else $("#elegir_dire").hide();

    if (nueva) $("#nueva_dire,#new").show();
    else $("#nueva_dire,#new").hide();

}

function isChecked(idRadio) {
    return document.getElementById(idRadio).checked;
}


function onAddTiendaTunel(tienda){

    if (Inditex)
        Inditex.trackEvent('/Tiendas','seleccionar');

    closeModal(this);
    //element = JSON.parse(unescape(tienda));
    html = generateHTMLTiendasOld(idsTiendas, tienda);
    $("#tiendasRecogida").prepend(html);
    if (html != ''){
        loadRadiosAndChecksNew(false);
        // loadRadiosAndChecksAux($("#tienda_" + tienda.physicalStoreId), "radio", true);
    }
    $("#tienda_" + tienda.physicalStoreId).next().click();

}



function load_mod(){

    $("#gestionarDireccion").validate({
        submitHandler : function(form) {
            var addressId = $('#addressId');
            var iLogicChunk = '';
            if (addressId.val() != '') {
                addressId.attr('name', 'addressId');
                iLogicChunk = '/Editar_Direccion';
            } else {
                addressId.removeAttr('name');
                iLogicChunk = '/Nueva_Direccion';
            }

            $.xajax({
                url: form.action,
                type: 'post',
                data: $(form).serialize(),
                dataType: 'json',
                success: function(data) {
                    if (data.status > 0) {
                        if (Inditex) {
                            Inditex.trackPage(iLogicChunk + "/Envio_OK");
                            if (addressId.data('origen')=="envio") {
                                Inditex.trackEvent( categoryEvent,"Envio_editar_direccion_ok",null,true);
                            } else if (addressId.data('origen')=="envioAnyadir") {
                                Inditex.trackEvent( categoryEvent,"Envio_anadir_direccion_ok",null,true);
                            }
                        }
                        openStaticModal(Messages.datosPersonalesDir, Messages.datosGuardadosDir, true);
                        closeAndRefresh();


                    } else {
                        if (Inditex) {
                            Inditex.trackPage(iLogicChunk + "/Envio_Error_" + data.type);
                            if (addressId.data('origen')=="envio") {
                                Inditex.trackEvent( categoryEvent,"Envio_editar_direccion_error",Inditex.codeError(data.key,data.message),true);
                            } else if (addressId.data('origen')=="envioAnyadir") {
                                Inditex.trackEvent( categoryEvent,"Envio_anadir_direccion_error",Inditex.codeError(data.key,data.errorMessage),{});
                            }
                        }
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                    fitFooterBottomTunel($('#tunel'));

                },
                error: function(xhr){
                    if (addressId.data('origen')=="envio") {
                        Inditex.trackEvent( categoryEvent,"Envio_editar_direccion_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                    } else if (addressId.data('origen')=="envioAnyadir") {
                        Inditex.trackEvent( categoryEvent,"Envio_anadir_direccion_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                    }
                }
            });

        },
        rules : {
            nif : { required :	function() {
                return $("#typeData").val() == "company";
            },
                validateNif: function() {
                    return $("#typeData").val() == "company";
                }
            },
            companyName : { required :	function() {
                return $("#typeData").val() == "company";
            }
            },
            addressName : "required",
            firstName : "required",
            middleName : "required",
            lastName : "required",
            city : "required",
            zipCode : {"requiredChangeClass" : true, "requiredChangeClassRestrictedCP" : true},
            state : "itxSelect",
            country : "required",
            phone1Prefix :{
                validPrefix : true,
                required : true
            },
            phone1 : {
                required : true,
                validatePhone : true
            },
            phone2 : {
                validatePhone : true
            },
            phone2Prefix :{
                validPrefix : true
            }
        },
        messages : {
            companyName : {required:Messages.required},
            nif : {required:Messages.required,
                validateNif: Messages.nifIncorrecto},
            addressName : Messages.required,
            middleName : Messages.requiredMiddleName,
            firstName : Messages.required,
            lastName : Messages.required,
            city : Messages.required,
            zipCode : {
                "requiredChangeClass" : eval('Messages.zipCode_' + iCountry),
                "requiredChangeClassRestrictedCP" : Messages.restrictedZipcode
            },
            apellido : Messages.required,
            fechaNacimiento : Messages.birthDate,
            phone1 : {
                required: Messages.required,
                validatePhone : eval('Messages.phone_' + iCountry)
            },
            phone2 : eval('Messages.phone_' + iCountry),
            state : Messages.state,
            country : Messages.country
        }
    });

    if (iCountry == "MX") {
        $("input[name=colony]").rules("add", {
            required: true,
            messages: {
                required: Messages.rellenarCampo
                //maxlength: "long"
            }
        });
        $("input[name=municipality]").rules("add", {
            required: true,
            messages: {
                required: Messages.rellenarCampo
                //maxlength: "long"
            }
        });


    }
    if (iCountry == "US") {
        $("input[name=address1]").rules("add", {
            required: true,
            maxlength: 35,
            messages: {
                required: Messages.address
                //maxlength: "long"
            }
        });
    } else  {
        $("input[name=address1]").rules("add", {
            required: true,
            messages: {
                required: Messages.address
            }
        });
    }

    selectBinds(155, 'px');
    changeCustomSelect($("#gestionarDireccion").find('#select-ul-provincia li[v=]'), $("#gestionarDireccion"));
    if(!isIPad()){
        setTimeout(function(){
            setScroll();
        },500);
    }

}


function closeAndRefresh(){
    var dir = $('#selectDireccionEnvio');
    if(dir.size() == 0){
        var url = $("#datosEnvioJSON").attr("value");
        loadDirecciones(url);

    }else{
        var url = $("#iDireccionesEnvioURL").attr("value");
        parent.cargarDireccionesUrl(url);
        closeModal(this.window);


    }
    if (zipRestrictionEnabled) {
        ActualizarDelivery.bot_sig.hide();
    }
}
function configDataDropBox(TiposEnvioJSON) {
    $('#nameDB').val(TiposEnvioJSON.personName);
    $('#lastNameDB').val(TiposEnvioJSON.personLastName);
    $('#prefijoDB').val(TiposEnvioJSON.personPrefix);
    $('#telefonoDB').val(TiposEnvioJSON.personPhone);
}

function saveDataDropBox(urlAddAddressDrop) {

    var urlSaveAddressDrop = urlAddAddressDrop;

    urlSaveAddressDrop = urlSaveAddressDrop + '&dropType=DB'
        +'&firstName='+ $('#nameDB').val()
        +'&lastName='+ $('#lastNameDB').val()
        +'&phoneCountryCode_0='+$('#prefijoDB').val().replace('+','%2B')
        +'&phoneSubscriberNumber_0='+$('#telefonoDB').val()
        +'&addressName='+$('#identifierPackDB').val()
        +'&addressLine_0='+$('#identifierPackDB').val()
        +'&addressLine_1=' + $('#identifierDB').val()
        +'&city='+$('#newCityDB').val()
        +'&zipCode='+$('#newZipCodeDB').val()
        +'&addressField1=P'
        +'&authToken=' + encodeURIComponent($('#authTokenDP').val());


    Inditex.orderManage({
        customRequest: jQuery.xajax,
        url: urlSaveAddressDrop,
        dataType: 'json',
        success: function(dataResponse) {
            $('#selAddress1')[0].value= dataResponse.data.addressId;
            $('#shippingAddressId')[0].value= dataResponse.data.addressId;
            $("#sameAddress")[0].value=false;
            //alert('ok');
            Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                'hitCallback':function(){
                    $('#frmOrderShipping').submit();
                }
            });
        },
        error: function(xhr) {
            Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(xhr.status,xhr.statusText),true);
        }
    });
}

function saveDataDropPoint(urlAddAddressDrop) {

    var urlSaveAddressDrop = urlAddAddressDrop;

    urlSaveAddressDrop = urlSaveAddressDrop + '&dropType=DP'
        +'&firstName='+encodeURIComponent($('#nameDP').val())
        +'&lastName='+encodeURIComponent($('#lastNameDP').val())
        +'&phoneCountryCode_0='+$('#prefijoDP').val().replace('+','%2B')
        +'&phoneSubscriberNumber_0='+$('#telefonoDP').val()
        +'&addressName='+encodeURIComponent($('#physicalAddressDP').val())
        +'&addressLine_1='+ encodeURIComponent($('#idDropPoint').val())
        +'&addressLine_0=' + encodeURIComponent($('#addressDP').val())
        +'&city=' + encodeURIComponent($('#cityDP').val())
        +'&zipCode=' + $('#zipCodeDP').val()
        +'&addressField1=P'
        +'&authToken=' + encodeURIComponent($('#authTokenDP').val());
    Inditex.orderManage({
        customRequest: jQuery.xajax,
        url: urlSaveAddressDrop,
        dataType: 'json',
        success: function(dataResponse) {
            $('#selAddress1')[0].value= dataResponse.data.addressId;
            $('#shippingAddressId')[0].value= dataResponse.data.addressId;
            $("#sameAddress")[0].value=false;


            //alert('ok saveDataDropPoint');
            Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                'hitCallback':function(){
                    $('#frmOrderShipping').submit();
                }
            });
        },
        error: function(xhr) {
            Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(xhr.status,xhr.statusText),true);
        }
    });
}

function saveDataItxDropPoint(urlAddAddressItxDrop) {

    var urlSaveAddressItxDrop = urlAddAddressItxDrop;

    urlSaveAddressItxDrop = urlSaveAddressItxDrop + '&dropType=DP'
        +'&firstName='+encodeURIComponent($('#itxDropPoint #itxNameDP').val())
        +'&lastName='+encodeURIComponent($('#itxDropPoint #itxLastNameDP').val())
        +'&phoneCountryCode_0='+$('#itxDropPoint #itxPrefijoDP').val().replace('+','%2B')
        +'&phoneSubscriberNumber_0='+$('#itxDropPoint #itxTelefonoDP').val()
        +'&addressName='+encodeURIComponent($('#itxDropPoint #itxPhysicalAddressDP').val())
        +'&addressLine_1='+ encodeURIComponent($('#itxDropPoint #itxIdDropPoint').val())
        +'&addressLine_0=' + encodeURIComponent($('#itxDropPoint #itxAddressDP').val())
        +'&city=' + encodeURIComponent($('#itxDropPoint #itxCityDP').val())
        +'&zipCode=' + $('#itxDropPoint #itxZipCodeDP').val()
        +'&municipality=' + $('#itxDropPoint #itxMunicipalyDP').val()
        +'&colony=' + $('#itxDropPoint #itxColonyDP').val()
        +'&addressField1=P'
        +'&authToken=' + encodeURIComponent($('#authTokenDP').val());
    Inditex.orderManage({
        customRequest: jQuery.xajax,
        url: urlSaveAddressItxDrop,
        dataType: 'json',
        success: function(dataResponse) {
            $('#selAddress1')[0].value= dataResponse.data.addressId;
            $('#shippingAddressId')[0].value= dataResponse.data.addressId;
            $("#sameAddress")[0].value=false;


            //alert('ok saveDataDropPoint');
            Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                'hitCallback':function(){
                    $('#frmOrderShipping').submit();
                }
            });
        },
        error: function(xhr) {
            Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(xhr.status,xhr.statusText),true);
        }
    });
}

function saveDataUserGuest() {

    var middleName="";

    if ($('#frmOrderShipping #direccionEnvio #direccion_envio #patro').length>0) {
        middleName=$('#frmOrderShipping #direccionEnvio #direccion_envio #patro').attr('value');
    }

    if ($('#yaHayDireccionEnvio').attr('value')=='0') {

        Inditex.orderManage({
            "customRequest" : jQuery.xajax,
            "url": Inditex.generateUrl("ItxStandardAddAddressCmd", {
                "addressId"					: direccionesEnvioJSON.addressShips[0].addressId,
                "storeId"					: Inditex.iStoreId,
                "languageId"				: Inditex.iLangId,
                "memberId"					: $('#memberId').val(),
                "firstName"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #nombre').val(),
                "lastName"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #apellido').val(),
                "middleName"				: middleName,
                "companyVatin"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #companyVatin').val(),
                "companyName"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #companyName').val(),
                "isCompany"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #isCompany').val(),
                "addressName"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion').val() + "_1",
                "addressLine_0"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion').val(),
                "addressLine_1"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion2').val(),
                "countryCode"				: $('#countryCode').val(),
                "phoneCountryCode_0"		: $('#frmOrderShipping #direccionEnvio #direccion_envio #prefijo').val(),
                "phoneSubscriberNumber_0"	: $('#frmOrderShipping #direccionEnvio #direccion_envio #telefono').val(),
                "phoneCountryCode_1"		: $('#frmOrderShipping #direccionEnvio #direccion_envio #prefijo2').val(),
                "phoneSubscriberNumber_1"	: $('#frmOrderShipping #direccionEnvio #direccion_envio #telefono2').val(),
                "stateCode"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #provincia').val(),
                "city"						: $('#frmOrderShipping #direccionEnvio #direccion_envio #localidad').val(),
                "zipCode"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #cp').val(),
                "isShippingAddress"			: true,
                "email"					    : direccionesEnvioJSON.addressShips[0].email,
                "colony"					: ($('#frmOrderShipping #direccionEnvio #direccion_envio #colony')&&$('#frmOrderShipping #direccionEnvio #direccion_envio #colony').length>0)?$('#frmOrderShipping #direccionEnvio #direccion_envio #colony').val():"",
                "municipality"				: ($('#frmOrderShipping #direccionEnvio #direccion_envio #colony')&&$('#frmOrderShipping #direccionEnvio #direccion_envio #municipality').length>0)?$('#frmOrderShipping #direccionEnvio #direccion_envio #municipality').val():"",
                "viewname"					: "ItxStandardJSON",
                "errorViewName"				: "ItxStandardJSON"
            },true),
            "type": "post",
            "dataType": 'json',
            "success": function(json, textStatus, jqXHR) {

                if (json.data==null) {
                    Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(json.errorKey,json.errorMessage),true);
                    showError(json.errorMessage);
                }
                else {
                    $('#selAddress1').attr('value',json.data.addressId);
                    $('#sameAddress').attr('value',false);
                    $("#shipModeDP").attr("value","false");
                    Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                        'hitCallback':function(){
                            $('#frmOrderShipping').submit();
                        }
                    });
                }
            },
            "error": function(xhr) {
                Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
    }
    else {

        Inditex.orderManage({
            "customRequest": jQuery.xajax,
            "url": Inditex.generateUrl("ItxStandardUpdateAddressCmd", {
                "addressId"					: direccionesEnvioJSON.addressShips[0].addressId,
                "storeId"					: Inditex.iStoreId,
                "languageId"				: Inditex.iLangId,
                "addressId"					: $('#ShipAddressIdForUpdate').val(),
                "memberId"					: $('#memberId').val(),
                "firstName"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #nombre').val(),
                "lastName"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #apellido').val(),
                "middleName"				: middleName,
                "companyVatin"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #companyVatin').val(),
                "companyName"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #companyName').val(),
                "isCompany"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #isCompany').val(),
                "addressName"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion').val() + "_1",
                "addressLine_0"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion').val(),
                "addressLine_1"				: $('#frmOrderShipping #direccionEnvio #direccion_envio #direccion2').val(),
                "countryCode"				: $('#countryCode').val(),
                "phoneCountryCode_0"		: $('#frmOrderShipping #direccionEnvio #direccion_envio #prefijo').val(),
                "phoneSubscriberNumber_0"	: $('#frmOrderShipping #direccionEnvio #direccion_envio #telefono').val(),
                "phoneCountryCode_1"		: $('#frmOrderShipping #direccionEnvio #direccion_envio #prefijo2').val(),
                "phoneSubscriberNumber_1"	: $('#frmOrderShipping #direccionEnvio #direccion_envio #telefono2').val(),
                "stateCode"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #provincia').val(),
                "city"						: $('#frmOrderShipping #direccionEnvio #direccion_envio #localidad').val(),
                "zipCode"					: $('#frmOrderShipping #direccionEnvio #direccion_envio #cp').val(),
                "isShippingAddress"			: true,
                "email"					    : direccionesEnvioJSON.addressShips[0].email,
                "colony"					: ($('#frmOrderShipping #direccionEnvio #direccion_envio #colony')&&$('#frmOrderShipping #direccionEnvio #direccion_envio #colony').length>0)?$('#frmOrderShipping #direccionEnvio #direccion_envio #colony').val():"",
                "municipality"				: ($('#frmOrderShipping #direccionEnvio #direccion_envio #colony')&&$('#frmOrderShipping #direccionEnvio #direccion_envio #municipality').length>0)?$('#frmOrderShipping #direccionEnvio #direccion_envio #municipality').val():"",
                "viewname"					: "ItxStandardJSON",
                "errorViewName"				: "ItxStandardJSON"
            },true),
            "type": "post",
            "dataType": 'json',
            "success": function(json, textStatus, jqXHR) {

                if (json.data==null) {
                    Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(json.errorKey,json.errorMessage),true);
                    showError(json.errorMessage);
                }
                else {
                    $('#selAddress1').attr('value',json.data.addressId);
                    $('#sameAddress').attr('value',false);
                    $("#shipModeDP").attr("value","false");
                    Inditex.trackEvent( categoryEvent,"Envio_continuar_ok",null,{
                        'hitCallback':function(){
                            $('#frmOrderShipping').submit();
                        }
                    });
                }
            },
            "error": function(xhr) {
                Inditex.trackEvent( categoryEvent,"Envio_continuar_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
    }
}

function configButtonPopUpDropPintLocator(urlPopUpDropPoint) {
    var buttonPopUpDropPointLoc = $('#openPopUpDropPintLocator');

    buttonPopUpDropPointLoc.click(function(event){
        event.preventDefault();
        openBigModal(urlPopUpDropPoint, null,function(){setTimeout(function(){initSeleccionarDropPoint({onAddDropPoint: loadDataDropPintLocator});}, 1000);},null,0.9);
    });
}


function loadDataDropPintLocator(dataPoint) {
    var divLocDropPoint = $('#locDropPoint');
    divLocDropPoint.empty();

    var label = document.createElement('label');
    label.innerHTML= dataPoint.name;

    var inputCity = document.createElement('input');
    inputCity.type = 'hidden';
    inputCity.id = 'cityDP';
    inputCity.value = dataPoint.city;

    var inputZipCode = document.createElement('input');
    inputZipCode.type = 'hidden';
    inputZipCode.id = 'zipCodeDP';
    inputZipCode.value = dataPoint.postCode;

    var inputAddress = document.createElement('input');
    inputAddress.type = 'hidden';
    inputAddress.id = 'addressDP';
    inputAddress.value = dataPoint.name + ' ' +dataPoint.homeNo;

    var inputPhysicalAddress = document.createElement('input');
    inputPhysicalAddress.type = 'hidden';
    inputPhysicalAddress.id = 'physicalAddressDP';
    inputPhysicalAddress.value = dataPoint.street + ' ' +dataPoint.homeNo + ', ' + dataPoint.city;

    divLocDropPoint.append(label);
    divLocDropPoint.append(inputCity);
    divLocDropPoint.append(inputZipCode);
    divLocDropPoint.append(inputAddress);
    divLocDropPoint.append(inputPhysicalAddress);

    $('#idDropPoint').val(dataPoint.identifier);
}

function configDataDropPint(TiposEnvioJSON) {
    $('#nameDP').val(TiposEnvioJSON.personName);
    $('#lastNameDP').val(TiposEnvioJSON.personLastName);
    $('#prefijoDP').val(TiposEnvioJSON.personPrefix);
    $('#telefonoDP').val(TiposEnvioJSON.personPhone);
    configButtonPopUpDropPintLocator(TiposEnvioJSON.linkDropPointLocator);
}

function configDataItxDropPoint(TiposEnvioJSON) {
    $('#itxDropPoint #itxNameDP').val(TiposEnvioJSON.personName);
    $('#itxDropPoint #itxLastNameDP').val(TiposEnvioJSON.personLastName);
    $('#itxDropPoint #itxPrefijoDP').val(TiposEnvioJSON.personPrefix);
    $('#itxDropPoint #itxTelefonoDP').val(TiposEnvioJSON.personPhone);

    loadStatesItxDropPoint();

    $('#itxDropPoint #buscarItxDropPoints').bind('click', function(){
        showItxDropPoints();
    });
    $('#itxDropPoint #itxDroppointZipCode').click(function(e){
        clearStateMunicipalityColony();
    });


}

function loadStatesItxDropPoint(){
    $('#itxDropPoint #estadoDroppoint').val(null);
    $('#itxDropPoint #estadoDroppoint').html('');
    Inditex.getRestBamItxDropPointStates({
        'countryCode':Inditex.iStoreJSON.countryCode,
        'onSuccess':function(states){
            var options ='<option value=""></option>';
            if(states && states.states && states.states.length > 0){
                $.each(states.states,function(index,state){
                    options += 	'<option value="' + state + '" >' +  state + '</option>';
                });
            }
            $('#itxDropPoint #estadoDroppoint').html(options);
            configureStatesItxDropPoint();
        }
    });
}

function configureStatesItxDropPoint(){

    if( $('#itxDropPoint #estadoDroppoint').length <= 0 || $('#itxDropPoint #estadoDroppointContainer').length <= 0){
        return;
    }

    if($('#itxDropPoint #estadoDroppoint option').length <= 0){
        $('#itxDropPoint #estadoDroppoint')[0].style.visibility = 'hidden';
    }

    $('#itxDropPoint #estadoDroppointContainer').removeClass('loaded');
    var select = $('#itxDropPoint #estadoDroppoint');
    var title = select.attr('title');
    $('#multidrop-'+title).remove();

    selectBinds(15,'%');
    //La primera opci?n del combo es vac?a, para que por defecto no seleccione ning?n valor y como no nos interesa que se vea, pues la ocultamos
    if($('#select-ul-'+title + ' li').length > 1){
        $('#select-ul-'+title + ' li')[0].style.display='none';
    }
    select.unbind('change').change(function(e){
        clearZipCodeItxDropPoints();
        var estado = $(this).val();
        if(estado && estado != ''){
            loadMunicipalitiesItxDropPoint(estado);
            loadColoniesItxDropPoint(estado,null);
        }
    });

    var estado = $('#itxDropPoint #estadoDroppoint').val();
    if(!estado || estado == null || estado == ''){
        loadMunicipalitiesItxDropPoint(null);
        loadColoniesItxDropPoint(null,null);
    }
}

function loadMunicipalitiesItxDropPoint(state){
    $('#itxDropPoint #municipioDroppoint').val(null);
    $('#itxDropPoint #municipioDroppoint').html('');

    if(!state || state == null){
        configureMunicipalitiesItxDropPoint();
        return;
    }
    Inditex.getRestBamItxDropPointMunicipalities({
        'countryCode':Inditex.iStoreJSON.countryCode,
        'state':state,
        'onSuccess':function(municipalities){
            var options ='<option value=""></option>';
            if(municipalities && municipalities.municipalities && municipalities.municipalities.length > 0){
                $.each(municipalities.municipalities,function(index,municipality){
                    options += 	'<option value="' + municipality + '" >' +  municipality + '</option>';
                });
            }
            $('#itxDropPoint #municipioDroppoint').html(options);
            configureMunicipalitiesItxDropPoint();
        }
    });
}

function configureMunicipalitiesItxDropPoint(){

    if( $('#itxDropPoint #municipioDroppoint').length <= 0 || $('#itxDropPoint #municipioDroppointContainer').length <= 0){
        return;
    }

    var select = $('#itxDropPoint #municipioDroppoint');
    var title = select.attr('title');
    $('#multidrop-'+title).remove();
    if($('#itxDropPoint #municipioDroppoint option').length <= 0){
        $('#itxDropPoint #municipioDroppoint')[0].style.visibility = 'hidden';
    }else{
        $('#itxDropPoint #municipioDroppointContainer').removeClass('loaded');
        selectBinds(15,'%');
        //La primera opci?n del combo es vac?a, para que por defecto no seleccione ning?n valor y como no nos interesa que se vea, pues la ocultamos
        if($('#select-ul-'+title + ' li').length > 1){
            $('#select-ul-'+title + ' li')[0].style.display='none';
        }
    }

    select.unbind('change').change(function(e){
        clearZipCodeItxDropPoints();
        var municipio = $(this).val();
        var estado = $('#itxDropPoint #estadoDroppoint').val();
        if(estado && estado != '' && municipio && municipio != ''){
            loadColoniesItxDropPoint(estado,municipio);
        }
    });


}

function loadColoniesItxDropPoint(state,municipaly){
    $('#itxDropPoint #coloniaDroppoint').val(null);
    $('#itxDropPoint #coloniaDroppoint').html('');
    if(!state || state == null|| !municipaly || municipaly == null){
        configureColoniesItxDropPoint();
        return;
    }
    Inditex.getRestBamItxDropPointColonies({
        'countryCode':Inditex.iStoreJSON.countryCode,
        'state':state,
        'municipality':municipaly,
        'onSuccess':function(colonies){
            var options ='<option value=""></option>';
            if(colonies && colonies.colonies && colonies.colonies.length > 0){
                $.each(colonies.colonies,function(index,colony){
                    options += 	'<option value="' + colony + '" >' +  colony + '</option>';
                });
            }
            $('#itxDropPoint #coloniaDroppoint').html(options);
            configureColoniesItxDropPoint();
        }
    });
}

function configureColoniesItxDropPoint(){

    if( $('#itxDropPoint #coloniaDroppoint').length <= 0 || $('#itxDropPoint #coloniaDroppointContainer').length <= 0){
        return;
    }

    var select = $('#itxDropPoint #coloniaDroppoint');
    var title = $('#itxDropPoint #coloniaDroppoint').attr('title');
    $('#multidrop-'+title).remove();
    if($('#itxDropPoint #coloniaDroppoint option').length <= 0){
        $('#itxDropPoint #coloniaDroppoint')[0].style.visibility = 'hidden';
    }else{
        $('#itxDropPoint #coloniaDroppointContainer').removeClass('loaded');
        selectBinds(15,'%');
        //La primera opci?n del combo es vac?a, para que por defecto no seleccione ning?n valor y como no nos interesa que se vea, pues la ocultamos
        if($('#select-ul-'+title + ' li').length > 1){
            $('#select-ul-'+title + ' li')[0].style.display='none';
        }
        select.unbind('change').change(function(e){
            clearZipCodeItxDropPoints();
        });
    }

}


function showItxDropPoints(){
    var estado = $('#itxDropPoint #estadoDroppoint').val();
    var municipio = $('#itxDropPoint #municipioDroppoint').val();
    var colonia = $('#itxDropPoint #coloniaDroppoint').val();
    var zipCode = $('#itxDropPoint #itxDroppointZipCode').val();

    if((estado == null || municipio == null || colonia == null || estado == '' || municipio == '' || colonia == '') && (zipCode == null || zipCode == '')){
        clearItxDropPoints();
        $('#searchInfoItxDropPoint').css('color','#9b0202');
        return;
    }
    $('#searchInfoItxDropPoint').css('color','#000');

    if(zipCode != null && zipCode != ''){
        Inditex.getRestBamItxDropPointsByPostalCode({
            countryCode: Inditex.iStoreJSON.countryCode,
            postalCode: zipCode,
            onSuccess: function(droppoints) {
                drawItxDroppoints(droppoints);
            }
        })
    }else{
        Inditex.getRestBamItxDropPoints({
            'countryCode':Inditex.iStoreJSON.countryCode,
            'state':estado,
            'municipality':municipio,
            'colony':colonia,
            'onSuccess':function(droppoints){
                drawItxDroppoints(droppoints);
            }
        });
    }
}

function clearItxDropPoints(){
    $('#itxDropPoint #itxdroppoint-list .detalleDropPointDireccion').remove();
    $('#itxDropPoint #itxdroppoint-list').hide();
}

function clearZipCodeItxDropPoints(){
    $('#itxDropPoint #itxDroppointZipCode').val('');
}

function clearStateMunicipalityColony(){
    loadStatesItxDropPoint();
}

function drawItxDroppoints(droppoints){

    clearItxDropPoints();

    if(!droppoints || !droppoints.dropPoints || droppoints.dropPoints.length <= 0){
        return;
    }
    var listDroppoints = '';
    $.each(droppoints.dropPoints,function(index,element){
        listDroppoints += '<ul class="detalleDropPointDireccion"><li><span>';
        if(element.city && element.city != null && element.city != '' && element.city != 'null'){
            listDroppoints += element.city;
            listDroppoints += '<br>';
        }
        if(element.street && element.street != null && element.street != '' && element.street != 'null'){
            listDroppoints += element.street;
            listDroppoints += '<br>';
        }
        if(element.zipCode && element.zipCode != null && element.zipCode != '' && element.zipCode != 'null'){
            listDroppoints += element.zipCode + ' ' + element.state;
            listDroppoints += '<br>';
        }
        if(element.municipality && element.municipality != null && element.municipality != '' && element.municipality != 'null'){
            listDroppoints += element.municipality;
            listDroppoints += '<br>';
        }
        if(element.colony && element.colony != null && element.colony != '' && element.colony != 'null'){
            listDroppoints += element.colony;
            listDroppoints += '<br>';
        }
        if(element.openingHours && element.openingHours != null){
            if(element.openingHours.mondayTime && element.openingHours.mondayTime != null && element.openingHours.mondayTime != '' && element.openingHours.mondayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.LUNES + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.tuesdayTime && element.openingHours.tuesdayTime != null && element.openingHours.tuesdayTime != '' && element.openingHours.tuesdayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.MARTES + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.wednesdayTime && element.openingHours.wednesdayTime != null && element.openingHours.wednesdayTime != '' && element.openingHours.wednesdayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.MIERCO + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.thursdayTime && element.openingHours.thursdayTime != null && element.openingHours.thursdayTime != '' && element.openingHours.thursdayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.JUEVES + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.fridayTime && element.openingHours.fridayTime != null && element.openingHours.fridayTime != '' && element.openingHours.fridayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.VIERNES + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.saturdayTime && element.openingHours.saturdayTime != null && element.openingHours.saturdayTime != '' && element.openingHours.saturdayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.SABADO + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }
            if(element.openingHours.sundayTime && element.openingHours.sundayTime != null && element.openingHours.sundayTime != '' && element.openingHours.sundayTime != 'null'){
                listDroppoints += '&nbsp&nbsp&nbsp' + Messages.DOMINGO + ': ' + element.openingHours.mondayTime
                listDroppoints += '<br>';
            }

        }
        listDroppoints += '</span></li><a data-id="'+element.id+'" class="accion2 seleccionarItxDropPoints" href="javascript:void(0)"><strong>'
        listDroppoints += Messages.select;
        listDroppoints += '</strong></a></ul>';
    });
    var droppointsList = $('#itxDropPoint #itxdroppoint-list');
    droppointsList.html(listDroppoints);
    configureItxDropPoints(droppoints.dropPoints);
    droppointsList.show();

}

function configureItxDropPoints(droppointsList){
    $('#itxDropPoint a.seleccionarItxDropPoints').bind('click',function(){
        selectItxDropPoints(this,droppointsList);
    });
}

function selectItxDropPoints(droppoint,droppointsList){
    if(!droppoint || droppoint == null){
        return
    }
    $("#itxDropPoint .seleccionarItxDropPoints").hide();
    $(droppoint).closest("ul").siblings().hide();
    var droppointId = $(droppoint).attr('data-id');
    $('#itxDropPoint #itxIdDropPoint').val(droppointId);
    if(droppointsList && droppointsList.length > 0){
        $.each(droppointsList,function(index,element){
            if(element && element.id == droppointId){
                $('#itxDropPoint #itxPhysicalAddressDP').val(element.street + ', ' + element.city);
                $('#itxDropPoint #itxAddressDP').val(element.name);
                $('#itxDropPoint #itxCityDP').val(element.city);
                $('#itxDropPoint #itxZipCodeDP').val(element.zipCode);
                $('#itxDropPoint #itxMunicipalyDP').val(element.municipality);
                $('#itxDropPoint #itxColonyDP').val(element.colony);
            }
        });
    }
}

//JIRA ECOMDUTI-1742	Fallo web DE 3? paso da compra
function actualizaDescuentos(descuento) {
    var aplicaDescuento = false;
    var existeDescuento = false;
    var descripcion = Messages.discountDescription;
    var rowActualDiscount = $('.shippingDiscount');
    var totalDescuentoPrice = $('.shippingDiscount #totalDescuentoPrice');
    if ($.trim(descuento)!="" && descuento<0) {
        aplicaDescuento = true;
    }
    if (rowActualDiscount.length>0) {
        existeDescuento = true;
    }

    if (!aplicaDescuento && existeDescuento) {
        rowActualDiscount.remove()
    } else if (aplicaDescuento && existeDescuento) {
        var descuentoFormateado = formatCurPrice(descuento,decimals,moneda);
        totalDescuentoPrice.html(descuentoFormateado);
        totalDescuentoPrice.attr('sinformato',descuento)

    } else if (aplicaDescuento && !existeDescuento) {
        var descuentoFormateado = formatCurPrice(descuento,decimals,moneda);
        var row =  '<tr class="noborde shippingDiscount">'+
            '<td colspan="5" class="right"><p>'+descripcion+'</p></td>'+
            '<td class="right"><p><strong id="totalDescuentoPrice" sinFormato="' + descuento + '">'+ descuentoFormateado +'</strong></p></td>'+
            '</tr>';
        $('.shippingMode').before(row)
    }
}
//!JIRA ECOMDUTI-1742	Fallo web DE 3? paso da compra;
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_3.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_4.js (en_US) */



var index;
var numeroTarjetasUsadas = 0;
var NUMERO_MAXIMO_PAGO_TARJETAS =  $('#maxTarjetasRegaloHidden').attr('value');
var storeCountryABBR = "";
var numeroTRUsadas = 0;
var gt3000 = false;
var isCompany = false;
var paymentMethodsArray = new Array();
var numGiftCardAppend = [];
var eidKlarna="0";
var chargeKlarna="0";
var firstLoadKlarnaParameters=true;
var primaryAddress = "";
var genderKlarna = "";
var birthdayKlarna = "";

function load4() {
    $().ready(function() {
        Inditex.writeCookie("WC_GAOrder",null,-1);
        Inditex.getUserJSON(function(user){
            if ($("#isUserGuest").attr('value')!="true") {
                primaryAddress = user.primaryAddressId;
            }
            if (user.isWalletUser) {
                categoryEvent = 'Cesta_de_Compra_Rapida';
                extraPageview = '/Compra_rapida';
            } else {
                categoryEvent = 'Cesta_de_Compra';
                extraPageview = '';
            }
            var galogic = $('body').attr('data-ga-logic-universal-tunel');
            if (galogic) Inditex.trackPage( galogic+extraPageview,true);
            index =0;
            if ($("#storeCountryABBR")) {
                storeCountryABBR = $("#storeCountryABBR").attr('value');
            }

            jQuery(window).bind('resize', function(e){
                if (e.target==window) {
                    fitFooterBottomTunel($('#tunel'));
                }
            });

            if(shopCartJSON.hasPersonalize=="true"){
                $("#personalize").show();
            }else{
                $("#personalize").remove();
            }

            //restriccion cp Russia
            var classCOD=true;
            //	var zipCodesRestrictedRussia="^75001$";
            var zipCodesRestrictedRussia=$("#MD2_Var_Payment_Restricted_CP").attr("value");
            if(typeof(zipCodesRestrictedRussia) != "undefined" && zipCodesRestrictedRussia != null  && zipCodesRestrictedRussia != ''){//restriccion cp COD

                var er = new RegExp(zipCodesRestrictedRussia, 'gi');
                if(er.test(shippingAddressJSON.zipCode)){
                    classCOD=false;
                }
            }

            load_paymentMethods(tiposPagoJSON,classCOD);
            if ($("#isUserGuest").attr('value')=="true") {
                load_GuestBillingAddress(billingAddressJSON);
            }
            else {
                load_billingAddress(billingAddressJSON);
            }
            load_shippingAddress(shippingAddressJSON);
            load_detalleCesta(shopCartJSON);

            symbolPosition = shopCartJSON.currencySuffix.length==0;
            if (!symbolPosition)
                moneda = shopCartJSON.currencySuffix;
            else
                moneda=shopCartJSON.currencyPrefix;

            decimals = shopCartJSON.decimalPlaces;

            $.validator.setDefaults({
                submitHandler: function(form) {
                }
            });

            //Definiciones de los validadores
            $.validator.setDefaults({
                submitHandler: function(form) {
                }
            });
            $.validator.addMethod(
                "localDate",
                function(value, element) {
                    chunks = value.split('/');
                    if(chunks.length != 2 ) return false;
                    date = new Date(chunks[1], chunks[0])
                    return value.match(/^\d\d?\/\d\d\d\d$/);
                },
                Messages.formatoFecha
            );

            setTimeout(function(){
                fitFooterBottomTunel($('#tunel'));
            },100);

            $('#iWalletCardSelect').bind('change', function(){
                if ($('#iWalletCardSelect') != ""){
                    $('#isWalletForm').val('true');
                    if (Inditex){
                        Inditex.trackEvent('/Tramitacion_Pago','seleccion_pago','walletcard');
                    }
                    changePaymentMethodWallet();
                }else
                    $('#isWalletForm').val('false');
            });

            $('#radio2').bind('click', function(){
                $('#datos_pago').attr('style','display:block');
                load_paymentMethods(tiposPagoJSON);
                $('#walletCheckbox').attr('value','0');
                habilitarPagoNoWallet();
            });

            $('#radio1').bind('click', function(){
                $('#datos_pago').attr('style','display:none');
                habilitarPagoWallet();
                if (Inditex){
                    Inditex.trackEvent('/Tramitacion_Pago','seleccion_pago','walletcard');
                }
                changePaymentMethodWallet();
            });

            if ($('#radioWallet').attr('class')=='radio active'){
                $('#datos_pago').attr('style','display:none');
                habilitarPagoWallet();
                changePaymentMethodWallet();
            }

            $('#radioWallet').bind('click', function(){
                $('#datos_pago').attr('style','display:none');
                habilitarPagoWallet();
                changePaymentMethodWallet();
            });

            $('#radioNoWallet').bind('click', function(){
                $('#datos_pago').attr('style','display:block');
                load_paymentMethods(tiposPagoJSON);
                $('#walletCheckbox').attr('value','0');
                habilitarPagoNoWallet();

                if (Inditex){
                    Inditex.trackEvent('/Tramitacion_Pago','seleccion_pago','nuevo');
                }


            });

            $('#principalWalletCard').click ( function(){
                abrirComboTarjeta();
            });





            var numeroTarjetas = $('#numCards').attr('value');
            //seleccionamos la tarjeta por defecto
            $('a[data-defaultCard=true]').trigger('click');

            if ($('#listPagos :first-child')[1]) {
                changePaymentMethod($($('#listPagos :first-child')[1])[0],index);

            }

        })});

    if (errorPayment != null) {
        if (errorPayment.errorMessage != "" ) {
            openStaticModal(errorPayment.title, errorPayment.errorMessage, false);
        }
    }

    //shopCartJSON.minPriceToInvoce
    if(shopCartJSON.minPriceToInvoce != ""){
        if(parseFloat(shopCartJSON.totalPrice)>parseFloat(shopCartJSON.minPriceToInvoce)){
            gt3000 = true;
        }
        else{
            gt3000 = false;
        }
    }
    if (shippingAddressJSON.type == "company") {
        isCompany = true;
    } else {
        isCompany = false;
    }
}


function separarFecha(){
    var indice = tiposPagoJSON.cards.length-1;
    var fechaCaducidad = $('#fechaCaducidad');
    if (fechaCaducidad[0] != undefined ){
        if (fechaCaducidad.val() != ''){
            fecha = fechaCaducidad.val().split('/');
            $("#cardMonth_"+indice).val(fecha[0]);
            $("#cardYear_"+indice).val(fecha[1]);
        }
    }

}



/*
 *
 * Ventana modal generica
 *
 */
function openModalTramitar(params, onReady,top, height) {

    divId='mini_modal';
    var tramitandoPedidoHtml = '<div class="int"><p class="gran">'+ Messages.titleTramitarPedio + '</p><p class="peq">'+Messages.tramitandoPedidoMessage+'</p><img src="'+DUTTI_STATIC_CONTENT_PATH+'/img/ico_dutti.png" /></div>';
    data=tramitandoPedidoHtml;
    if(divId == null)
        divId = "general_modal";
    var overlayId;
    var alreadyOverlay = false;


    overlayId = 's_overlay';
    alreadyOverlay = false;


    closeModalNoCallback();
    $('<div/>', {
        'id' : overlayId,
        'class' : 'transp',
        'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
    }).appendTo('body');
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#' + overlayId);
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });

    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'style' :(height!= null)? 'overflow:hidden':'overflow:auto'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal

    $('#'+divId).html(data);

    $('#' + overlayId).find('#close_modal').bind('click', function() {
        closeModal(this);
    });


    calculatedHeight = (height != null ? $(window).height() * height : $(window).height());

    if(height != null) {
        $('#' + divId).css({
            'height' : calculatedHeight
        });
        if(top == null) {
            $('#' + divId).css({
                'top' : ($(window).height() - calculatedHeight) / 4
            });
            //$('#' + divId).offset({top: ($(window).height() - calculatedHeight) /2});
        }
    }

    if(top != null) {
        $('#' + divId).css({
            'top' : $(window).height() / 2 - top
        });
    } else {

    }
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
        if(top != null) {
            $('#' + divId).css({
                'top' : calculatedHeight / 2 - top
            });
        }
    })
    setTimeout(function() {

        $('#' + divId).find("#scrollable").css({
            'height' : calculatedHeight
        });
        $('#' + divId).fadeIn(function(){
        });
        if((onReady != null) && (onReady != undefined))
            onReady(params);

    }, 300)

    $('#' + overlayId).css('left', 0).fadeIn(function() {
        $('#close_overlay').bind('click', function() {
            closeModal(this);
        });
    })

    Inditex.getUserJSON(function(user){
        if (user.isWalletUser) {
            Inditex.trackPage( 'Cesta_de_Compra/Tramitar_Pedido/Validacion/'+trackingGetTarjeta()+"/Compra_rapida",{});
        } else {
            Inditex.trackPage( 'Cesta_de_Compra/Tramitar_Pedido/Validacion/'+trackingGetTarjeta(),{});
        }
    });
}

function enviarFormulario() {

    var walletCardName = $("#datos_pago #walletCardName").val();
    if (walletCardName !== undefined && walletCardName.length>0) {
        $("#datos_pago #walletCheckbox").val(1);
    } else {
        $("#datos_pago #walletCheckbox").val(0);
    }

    if ($('#radioWallet').attr('class') == "radio active"){
        $('#form1').append($('<input>').attr({    type: 'hidden',    id: 'useIli',    name: 'useIli',    value: 'false'}));
        if ( $("#modalidadPagoAffinityMoreInfo") && $("#modalidadPagoAffinityMoreInfo option:selected").val()!="" ) {
            $('#form1').append($('<input>').attr({    type: 'hidden',    id: 'installmentsCode_0',    name: 'installmentsCode_0',    value: $("#modalidadPagoAffinityMoreInfo option:selected").val()}));
        }
        var hasSelected = $('#cardHash_0').val();
        principalCardTunnel(hasSelected,function(){continuarEnviarFormulario();});
    }else{
        continuarEnviarFormulario();
    }
}

function continuarEnviarFormulario(){

    if ((isCompany) || (shopCartJSON.minPriceToInvoce != "") || Inditex.iStoreJSON.details.eInvoiceEnabled == "1") {
        if(($('#check_factura').attr("class") == "check active") || (gt3000 == true) || (isCompany)){
            $("#form1").append('<input type="hidden" value="1" name="isChecked" id="isChecked">');
        } else {
            if ($('#isChecked').length > 0){
                $('#isChecked').attr("value", "");
            }else{
                $("#form1").append('<input type="hidden" value="0" name="isChecked" id="isChecked">');
            }
        }

    }
    validacionesFormularios();

    $('#form1').submit();
}

function enviarDatosPago(){
    var existe = true;
    var cont = 0;
    var paypal = true;

    //Dejamos autorizar el pago s?lo si el n?mero de tarjetas regalo es 0 (pago con lo que sea menos GCard)
    //o si la cantidad de ? en las tarjeta es mayor que el pago sin haber otra forma de pago
    //o si la ?ltima forma de pago no es GC
    var numGCards = 0;
    var json = tiposPagoJSON;
    for(var x=0;x<json.cards.length;x++) {
        if(json.cards[x].type=="GiftCard") numGCards++;
    }
    var cantdEnTarjetasRegalo = cantidadEnTarjetasRegalo(json);

    if ((numGCards == 0 && json.cards[json.cards.length-1].type!=null) ||
        cantdEnTarjetasRegalo>=shopCartJSON.totalPrice ||
        (json.cards[json.cards.length-1].type!=null && json.cards[json.cards.length-1].type!=json.constants.giftcard)) {
    } else {
        var totalBalance = 0;
        for (var i = 0; i < json.cards.length; i++) {
            totalBalance += parseFloat(json.cards[i].balance);
        }
        var diferenciaPorPagar = parseFloat(shopCartJSON.totalPrice)-parseFloat(totalBalance);
        salida = true;
        openStaticModal(errorPayment.title ,Messages.TRNoSaldo , false);
    }

}
function pagoCero() {
    openModalTramitar(null,null,200,null);
    jQuery.xajax({
        "url": Inditex.generateUrl("ItxStandardOrderConfirmationCmd", {
            "storeId": Inditex.iStoreId,
            "langId": Inditex.iLangId,
            "catalogId": Inditex.iCatalogId,
            "orderId": tiposPagoJSON.orderId
        },true),
        "type": "post",
        "dataType": 'json',
        "data": $('#form1').serialize(),
        "success": function(json, textStatus, jqXHR) {
            processPaymentStatus(json);
        },
        "error": function(xhr) {
            Inditex.trackEvent( categoryEvent,"Autorizar_Pago_"+trackingGetTarjeta()+"_validacion_error",Inditex.codeError(xhr.status,xhr.statusText),true);
            showError(ITX_TEXT_GENERIC_PROBLEM);
        }
    });
}

function load_paymentMethods(data,classCOD) {
    index = data.cards.length;
    var tramitandoPedido =$("#mensajeTramitarURL").attr("value");
    detalle = data;
    var contenido='';
    var formulario='';
    var submit = '';
    var contenidoCOD='';

    // Comprobamos si el total es 0.00. Si lo es ocultamos los metodos de pago
    var precioTotal= Math.round(shopCartJSON.totalPrice).toFixed(2);
    var cantdEnTarjetasRegalo = cantidadEnTarjetasRegalo(detalle);

    if (precioTotal<=0.00) {
        if ($('.free')) {
            $('.free').each(function() {
                $(this).css('display','none');
            });
            $('#comprar').css('float','left');
        }
        contenido += '<a style="display:block;" id="buttonSubmit" onclick=";pagoCero();" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';
        $("#comprar").html(contenido);
    }else {
        for(i=0;i<detalle.payments.length;i++){

            if (detalle.payments[i].paymentId == "COD" && classCOD) {

                var walletSuitable= detalle.payments[i].suitableForWallet;
                var paymentId = detalle.payments[i].paymentId;
                //Im?genes metodos de pago

                contenidoCOD += '<img class="imagePayment" data-walletsuitable="'+walletSuitable+'" indice="0" onmouseover="showPaymentActive(this);" onmouseleave="showPaymentDisabled(this);" class="imagePayment" on="' + detalle.payments[i].paymentIdImageSrcOn + '" off="' + detalle.payments[i].paymentIdImageSrcOff + '" id="' + detalle.payments[i].paymentId + '" onclick="if (Inditex) Inditex.trackEvent(\'Cesta_de_compra\',\'Pago_tipo\',\''+ detalle.payments[i].paymentId +'\',true); if (Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\',\'seleccion_pago\',\''+ detalle.payments[i].paymentId +'\');changePaymentMethod(this,'+index+');" src="' + detalle.payments[i].paymentIdImageSrcOff + '"/>'+

                    '<input style="display:none;" class="radio converted" type="radio" id="radio_' + detalle.payments[i].paymentId + '" name="metodoPago"/>';

                $("#imgCOD").html(contenidoCOD);
                $("#paymentCOD").show();

                $("#selectsPaymentMethods").addClass("cod_cont");
            }


            if (detalle.payments[i].paymentId != "COD") {

                if (detalle.payments[i].paymentId != "KINVOICE" && detalle.payments[i].paymentId != "KACCOUNT") {

                    var walletSuitable= detalle.payments[i].suitableForWallet;
                    var paymentId = detalle.payments[i].paymentId;
                    //Im?genes metodos de pago
                    contenido += '<li>'+
                        '<img  data-walletsuitable="'+walletSuitable+'" indice="0" onmouseover="showPaymentActive(this);" onmouseleave="showPaymentDisabled(this);" class="imagePayment" on="' + detalle.payments[i].paymentIdImageSrcOn + '" off="' + detalle.payments[i].paymentIdImageSrcOff + '" id="' + detalle.payments[i].paymentId + '" onclick="if (Inditex) Inditex.trackEvent(\'Cesta_de_compra\',\'Pago_tipo\',\''+ detalle.payments[i].paymentId +'\',true); if (Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\',\'seleccion_pago\',\''+ detalle.payments[i].paymentId +'\');changePaymentMethod(this,'+index+');" src="' + detalle.payments[i].paymentIdImageSrcOff + '"/>'+
                        '<input style="display:none;" class="radio converted" type="radio" id="radio_' + detalle.payments[i].paymentId + '" name="metodoPago"/>'
                    '</li>';
                }
                else {

                    var walletSuitable= detalle.payments[i].suitableForWallet;
                    var paymentId = detalle.payments[i].paymentId;
                    //tratamiento imagen ON
                    var tokens = detalle.payments[i].paymentIdImageSrcOn.split ("/");
                    imagenOn = tokens[tokens.length-1];
                    imagenOn = imagenOn.split (".");
                    imagenOn = imagenOn[0]+ "_" + storeCountryABBR + "." + imagenOn[1];
                    var on="";
                    for (var w=0; w < tokens.length; w++) {
                        if (w<tokens.length-1)
                            on = on + tokens [w] + "/";
                        else
                            on = on + imagenOn;
                    }
                    //tratamiento imagen OFF
                    tokens = detalle.payments[i].paymentIdImageSrcOff.split ("/");
                    imagenOff = tokens[tokens.length-1];
                    imagenOff = imagenOff.split (".");
                    imagenOff = imagenOff[0]+ "_" + storeCountryABBR + "." + imagenOff[1];
                    var off="";
                    for (var z=0; z < tokens.length; z++) {
                        if (z<tokens.length-1)
                            off = off + tokens [z] + "/" ;
                        else
                            off = off + imagenOff;
                    }

                    //Im?genes metodos de pago
                    contenido += '<li>'+
                        '<img  data-walletsuitable="'+walletSuitable+'" indice="0" onmouseover="showPaymentActive(this);" onmouseleave="showPaymentDisabled(this);" class="imagePayment" on="' + on + '" off="' + off + '" id="' + detalle.payments[i].paymentId + '" onclick="if (Inditex) Inditex.trackEvent(\'Cesta_de_compra\',\'Pago_tipo\',\''+ detalle.payments[i].paymentId +'\',true); if (Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\',\'seleccion_pago\',\''+ detalle.payments[i].paymentId +'\');changePaymentMethod(this,'+index+');" src="' + detalle.payments[i].paymentIdImageSrcOff + '"/>'+
                        '<input style="display:none;" class="radio converted" type="radio" id="radio_' + detalle.payments[i].paymentId + '" name="metodoPago"/>'
                    '</li>';
                }
            }
        }

        $("#listPagos").html(contenido);
        $("#datos_pago").html(formulario);

        var divPaymentMethods = '<div class="row" id="payment_methods_add_'+index+'" style="display:none" ><ul id="list_pagos_add"></ul><div id="datos_pago_add"></div></div>';
        $("#payment_methods").html(divPaymentMethods);

        numeroTarjetasUsadas ++;

        validacionesFormularios();

        $("#comprar").html(submit);

        //Bindeamos el borrado de la fecha
        $("[name^=fechaCaducidad]").each(function(){
            removeValueFromFieldOnClickByName($(this).attr("id"));
        });

        $("[name^=walletCardName]").each(function(){
            removeValueFromFieldOnClickByName($(this).attr("id"));
        });

        loadRadiosAndChecks();

        if (isCompany && Inditex.iStoreJSON.details.eInvoiceEnabled != "1") {
            $('.nifnie_input').show();
            $('.gt3000').show();
            $('#check_factura, #factura').remove()
            fitFooterBottomTunel($('#tunel'));
        } else if (shopCartJSON.minPriceToInvoce != "" || Inditex.iStoreJSON.details.eInvoiceEnabled == "1") {
            if(shopCartJSON.checkFactura == 'checked'){
                $("#check_factura").addClass("active");
                $('.nifnie_input').show();
            }

            if (gt3000) {
                $('.nifnie_input').show();
                $('.gt3000').show();
                $('#check_factura, #factura').remove()
                fitFooterBottomTunel($('#tunel'));
            }else{
                $('.lt3000').show();
                fitFooterBottomTunel($('#tunel'));
            }
            $('#factura').bind('change', function(){
                if ($(this).is(':checked')) {
                    $('.nifnie_input').show()
                    fitFooterBottomTunel($('#tunel'));
                }else{
                    $('.nifnie_input').hide()
                    fitFooterBottomTunel($('#tunel'));
                }
            })

        }
    }
}

function loadKlarnaParameters (loadKlarna) {

    if (firstLoadKlarnaParameters) {

        Inditex.getXConfiguracion({
            parametro: 'KLARNA_FRONT_MERCHANTID',
            onSuccess: function(aJson) {
                if (aJson != null && aJson.value != null)
                    eidKlarna = aJson.value;
                else
                    eidKlarna	= "0";

                Inditex.getXConfiguracion({
                    parametro: 'KLARNA_INVOICE_CHARGE',
                    onSuccess: function(aJson) {
                        if (aJson != null && aJson.value != null)
                            chargeKlarna  = aJson.value;
                        else
                            chargeKlarna 	= "0";

                        loadKlarna();
                    },
                    onFailure: function(aStatus) {
                        Inditex.showGenericError();
                    }
                });
            },
            onFailure: function(aStatus) {
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
    }
    else {

        loadKlarna();
    }
}

function changePaymentMethod(element,index){

    var klarna=false;

    if($("#principalWalletCard").length>0){
        $('#datos_pago').attr('style','display:block');
        $('#walletCheckbox').attr('value','0');
        habilitarPagoNoWallet();
    }


    tiposPagoJSON.cards.length = 1;
    id=$(element).attr('id');

    $("#explanationCWV2").hide();
    $('#discountAffinity').css('display','none');
    $(".imagePayment").each(function(){
        if($(this).attr('id') != id){
            srcImage = $(this).attr('off');
            $(this).attr('src',srcImage);
            $(this).parent().css('border-color','transparent');
        }
        else{
            srcImage = $(this).attr('on');
            $(this).attr('src',srcImage);
            $("#radio_"+id).click();
            $(this).parent().css('border-color','black');
        }
    });

    var formulario ="";
    var submit = '';
    var paymentId = id;

    // si existe alguno ya,lo eliminamos y creamos el nuevo
    if ($('#paymentpanel')[0] != undefined){
        $('#paymentpanel').remove();
    }

    //texto cod
    $('.cod_text').removeClass('active');
    if($(element).attr('id') == 'COD') {
        $('.cod_text').addClass('active');
    }
    var selectedMethod= getPaymentMethodById(paymentId);
    if(selectedMethod.kind=='credit_card_installments'){
        formulario +=formularioCreditCardInstallments(paymentId, 0);
    }else if(selectedMethod.kind=='safetypay'){
        formulario +=formularioSafetyPay(paymentId, 0);
    }else if(paymentId.toLowerCase() == 'mobile'){
        formulario +=formularioinWalletMobile(paymentId, 0);
    }else if(paymentId.toLowerCase() == 'inwallet'){
        formulario +=formularioinWallet(paymentId, 0);
    }else if(paymentId.toLowerCase() != 'affinityes' && paymentId.toLowerCase() != 'affinity'){
        if (paymentId.toLowerCase() != 'paypales' && paymentId.toLowerCase() != 'paypal' && paymentId.toLowerCase() != 'giftcard' && paymentId.toLowerCase() != 'qiwi'
            && paymentId.toLowerCase() != 'cod' && paymentId.toLowerCase() != 'ideal' && paymentId.toLowerCase() != 'p24' && paymentId.toLowerCase() != 'discount'
            && paymentId.toLowerCase() != 'kinvoice' && paymentId.toLowerCase() != 'kaccount' && paymentId.toLowerCase() != 'account' ){
            formulario += formularioNotAffinity(paymentId,0);
        } else {
            if(paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount'){
                formulario += formularioTR(paymentId,0);
            } else {

                if(paymentId.toLowerCase() == 'qiwi'){
                    formulario = formularioQiwi(paymentId,0);
                }else {
                    if(paymentId.toLowerCase() == 'cod'){
                        formulario = formularioCOD(paymentId,0);
                    }else {
                        if(paymentId.toLowerCase() == 'paypal'){
                            formulario = formularioPayPal(paymentId,0);
                        } else {
                            if(paymentId.toLowerCase() == 'ideal'){
                                formulario += formularioiDeal(paymentId,0);
                            } else {
                                if(paymentId.toLowerCase() == 'kinvoice'){
                                    formulario += formularioKlarnaInvoice(paymentId,0);
                                    klarna=true;
                                }  else {
                                    if(paymentId.toLowerCase() == 'kaccount'){
                                        formulario += formularioKlarnaAccount(paymentId,0);
                                        klarna=true;
                                    } else {
                                        formulario += formularioP24(paymentId,0);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

    }else{//Affinity
        formulario += formularioAffinity(paymentId,0);
    }


    //Submits
    var indice_anterior = index-1;
    if (paymentId.toLowerCase() == 'paypales' || paymentId.toLowerCase() == 'paypal' || paymentId.toLowerCase() == 'qiwi' || paymentId.toLowerCase() == 'kinvoice' || paymentId.toLowerCase() == 'kaccount')//qiwi
        submit += '<a style="display:block;" id="buttonSubmit" onclick="enviarFormulario()" href="javascript:void(0)">'+ Inditex.msg('autorizarCompra') +'</a>';
    else if (storeCountryABBR == 'DE' && (paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount'))
        submit += '<a style="display:block;" id="buttonSubmit" onclick="get_balance('+indice_anterior+');" href="javascript:void(0)">'+ Inditex.msg('compraDE') +'</a>';
    else if (storeCountryABBR == 'DE')
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compraDE') +'</a>';
    else if(paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount')
        submit += '<a style="display:block;" id="buttonSubmit" onclick="get_balance('+indice_anterior+');" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';
    else
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';

    $("#datos_pago").html(formulario);


    if (klarna) {

        loadKlarnaParameters(loadKlarna);
        loadKlarnaDetails();
    }


    if(paymentId.toLowerCase() == 'mobile'){
        $('#data-itx-bind-mobile-payment-qr-submit').click(function(event){
            validateQR(event);
        });

        Inditex.bindMobilePayment({
            "orderId":tiposPagoJSON.orderId,
            "showWaitView":function(){
                openStaticModal(Messages.inWalletTitle, Messages.inWalletMobileWaitingConfirmation+"<br /><br /><button id='cancel_inwallet' class='acc_butt'>"+Messages.inWalletCancel+"</button>");
                $("#s_overlay").addClass("loading");

                $('#cancel_inwallet').bind('click', function() {
                    closeModal(this);
                    return;
                });

            },
            "showErrorQRView":function(){
                closeModal('#cancel_inwallet');
                var validator = $( "#form1" ).validate();
                validator.showErrors({
                    "data-itx-bind-mobile-payment-qr-input":Messages.errorQR
                });
            },
            "showErrorView":function(aJson){
                closeModal('#cancel_inwallet');
                openStaticModal(Messages.errorTitle, Messages.errorRecoverInWalletCards);
            },
            "showCardView":function(aJson){
                closeModal('#cancel_inwallet');
                var alias=aJson.walletQRCards[0].alias;
                var printablePan=aJson.walletQRCards[0].printablePan;
                var paymentCodeName=aJson.walletQRCards[0].paymentCodeName;
                var cardHash=aJson.walletQRCards[0].hash;
                $("#cardHash_0").val(cardHash);
                $("#qrCard").val(cardHash);
                closeModal('#cancel_inwallet');
                $("#qr_content").html("<p><b>"+Messages.selectedCard+"</b><br /><br />"+Messages.cardAlias+"<br />"+alias+"<br /><br />"+Messages.cardNumber+"<br />"+paymentCodeName+": "+printablePan+"</p>");
            }
        });

    }

    selectBinds(100, '%');
    $("#comprar").html(submit);


    privacyPolicyControllerView(paymentId);

    //Bindeamos el borrado de la fecha
    $("[name^=fechaCaducidad]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    });
    $("[name^=walletCardName]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    });

    loadRadiosAndChecks();


    var index =element.attributes.getNamedItem('indice').nodeValue;
    var method = element.id;
    tiposPagoJSON.cards.splice(index, tiposPagoJSON.cards.length);

    var is_billing_address_mandatory = "0";
    for ( var pos = 0; pos < tiposPagoJSON.payments.length; pos++) {
        var payMethod = tiposPagoJSON.payments[pos];
        if (payMethod.type == method) {
            is_billing_address_mandatory = payMethod.is_billing_address_mandatory;
        }
    }

    tiposPagoJSON.cards.push({
        "type": method, "is_billing_address_mandatory" : is_billing_address_mandatory
    });
    validacionesFormularios();

    if (tiposPagoJSON.cards[0].type==tiposPagoJSON.constants.giftcard ){
        numeroTRUsadas++;
    }
    $('#captchaImg').attr('src',$('#captchaURL').attr('value')+"&t="+new Date().getTime());

    if (isCompany && Inditex.iStoreJSON.details.eInvoiceEnabled != "1") {
        $('.nifnie_input').show();
        $('.gt3000').show();
        $('.lt3000').remove();
        $('#check_factura, #factura').remove()
        fitFooterBottomTunel($('#tunel'));
    } else if (shopCartJSON.minPriceToInvoce != ""  || Inditex.iStoreJSON.details.eInvoiceEnabled == "1"){
        if(shopCartJSON.checkFactura == 'checked'){
            $("#check_factura").addClass("active");
            $('.nifnie_input').show();
        }

        if(gt3000){
            $('.nifnie_input').show();
            $('.gt3000').show();
            $('.lt3000').remove();
            $('#check_factura, #factura').remove()
            fitFooterBottomTunel($('#tunel'));
        }else{
            $('.lt3000').show();
            $('.lt3000.info_campo').appendTo($('.nifnie_input'));
            $('.gt3000').remove();
            fitFooterBottomTunel($('#tunel'));
        }
        $('#factura').bind('change', function(){
            if ($(this).is(':checked')) {
                $('.nifnie_input').show()
                fitFooterBottomTunel($('#tunel'));
                $('.info_campo',$('#factura').parent()).show();
            }else{
                $('.nifnie_input').hide()
                fitFooterBottomTunel($('#tunel'));
                $('.info_campo',$('#factura').parent()).hide();
            }
        })
    }
    walletControl();

    if(paymentId.toLowerCase() == 'qiwi') {
        setTimeout(function(){
            $('#paymentpanel .info_campo').hide();
        }, 200);
    }
    if(paymentId.toLowerCase() == 'paypal') {
        $('#paymentpanel .info_campo').hide();
        $('#opt_check br').hide();
        $('#opt_check .info_campo').hide();
    } else {
        $('#paymentpanel .info_campo').show();
        $('#opt_check br').show();
        $('#opt_check .info_campo').show();
    }
}

//Funcion para prerellenar los campos fecha de nacimiento y genero en metodos de pago klarna
function loadKlarnaDetails(){

    if ($("#isUserGuest").attr('value')!="true" && primaryAddress!=null && primaryAddress!="" && (storeCountryABBR=='AT' || storeCountryABBR=='DE' || storeCountryABBR=='NL')) {

        if (firstLoadKlarnaParameters == true) {

            Inditex.getUserAddressJSON({
                "addressId": primaryAddress,
                "forceCommerce":1,
                "onSuccess": function(address) {
                    if (address !=null) {
                        if (address.birthdate !=null && $("#kbPNO_0").length>0) {
                            birthdayKlarna = address.birthdate.split("-");
                            if (storeCountryABBR == 'NL' && Inditex.iLangId == -1) {
                                birthdayKlarna = birthdayKlarna[1]+birthdayKlarna[2]+birthdayKlarna[0];
                            }
                            else {
                                birthdayKlarna = birthdayKlarna[2]+birthdayKlarna[1]+birthdayKlarna[0];
                            }
                            $("#kbPNO_0").val(birthdayKlarna);
                        }
                        if (address.gender !=null && $("#radio_r_men").length>0) {
                            genderKlarna = address.gender;
                            if (address.gender == "M") {
                                $("#radio_r_men").trigger('click');
                            }
                            if (address.gender == "F") {
                                $("#radio_r_women").trigger('click');
                            }
                        }
                    }
                }
            });
        }
        else {

            loadRadiosAndChecks();

            if (birthdayKlarna !="" && $("#kbPNO_0").length>0) {
                $("#kbPNO_0").val(birthdayKlarna);
            }
            if (genderKlarna !="" && $("#radio_r_men").length>0) {
                if (genderKlarna == "M") {
                    $("#radio_r_men").trigger('click');
                }
                if (genderKlarna == "F") {
                    $("#radio_r_women").trigger('click');
                }
            }
        }
    }

    firstLoadKlarnaParameters = false;
}

function privacyPolicyControllerView(paymentId){
    if (paymentId && paymentId.toLowerCase() == 'discount') {
        $('#check_politica').addClass('active');
        $('#politica').prop('checked', true);
        $('#liCheckPoliticaEmpleado').hide();
    }
    else {
        $('#check_politica').removeClass('active');
        $('#politica').prop('checked', false);
        $('#liCheckPoliticaEmpleado').show();
    }
}

/**Enviamos el formulario cuando se activa desde el combo**/
function changePaymentMethodWallet(){

    id= "walletcard";

    var formulario ="";
    var submit = '';
    var paymentId = "walletcard";

    // si existe alguno ya,lo eliminamos y creamos el nuevo
    if ($('#paymentpanel')[0] != undefined){
        $('#paymentpanel').remove();
    }

    //Formulario Wallet

    formulario += formularioWallet();

    //Submits
    if (storeCountryABBR == 'DE')
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compraDE') +'</a>';
    else
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';

    $("#datos_pago").html(formulario);
    $("#datos_pago").css('display','block');
    $("#comprar").html(submit);


    validacionesFormularios();

}

function showPaymentActive(element){
    srcImage = $(element).attr('on');
    $(element).attr('src',srcImage);
    $(element).parent().css('border-color','black');
}

function showPaymentDisabled(element){
    srcImage = $(element).attr('off');
    id=$(element).attr('id');

    if($("#radio_"+id).is(':checked') == false){
        $(element).parent().css('border-color','transparent');
        $(element).attr('src',srcImage);
    }
}

function toggleWrapper(index) {
    Inditex.trackEvent( categoryEvent,'Pago_ver_cvv',null,true);
    if (parseInt(index) == 0) {
        var hidden1 = $('.hidden_text_1');
        if (hidden1) {
            if (hidden1[0] && hidden1[0].style.display == 'block') {
                toggle('1');
            }
        }
    } else {
        var hidden0 = $('.hidden_text_0');
        if (hidden0) {
            if (hidden0[0] && hidden0[0].style.display == 'block') {
                toggle('0');
            }
        }
    }

    toggle(index);
}

function toggleWrapperGC(index) {
    if (parseInt(index) == 0) {
        var hidden1 = $('.hidden_text_1');
        if (hidden1) {
            if (hidden1[0] && hidden1[0].style.display == 'block') {
                toggle('1');
            }
        }
    } else {
        var hidden0 = $('.hidden_text_0');
        if (hidden0) {
            if (hidden0[0] && hidden0[0].style.display == 'block') {
                toggle('0');
            }
        }
    }

    toggleGC(index);
}

function toggle(index){
    //Hay que dividirlo porque en IE7 el orden es importante
    if ($(".hidden_text_"+index).is(":visible")){
        $("#paymentPanel").find(".info_campo").toggle();
        $("#paymentPanel").find(".opt_check").toggle();
        $("#paymentPanel").find(".ancho").toggle();
        $("#paymentPanel").find("#comprar").toggle();
        $(".hidden_text_"+index).slideUp(function(){

        });
    }
    else{

        $("#paymentPanel").find(".info_campo").toggle();
        $("#paymentPanel").find(".opt_check").toggle();
        $("#paymentPanel").find(".ancho").toggle();
        $("#paymentPanel").find("#comprar").toggle();
        $(".hidden_text_"+index).slideDown();
    }

    var cvvinfo= $('#infoCVV').html();
    $('.aux_cont').html(cvvinfo);
    $('.aux_cont').css('display','block');
    //Inditex.trackPage( "Cesta_de_Compra/Tramitar_Pedido/Pago/"+trackingGetTarjeta()+"/Informacion_CVV"+extraPageview,true);

}

function toggleGC(index){
    //Hay que dividirlo porque en IE7 el orden es importante
    if ($(".hidden_text_"+index).is(":visible")){
        $("#paymentPanel").find(".info_campo").toggle();
        $("#paymentPanel").find(".opt_check").toggle();
        $("#paymentPanel").find(".ancho").toggle();
        $("#paymentPanel").find("#comprar").toggle();
        $(".hidden_text_"+index).slideUp(function(){

        });
    }
    else{

        $("#paymentPanel").find(".info_campo").toggle();
        $("#paymentPanel").find(".opt_check").toggle();
        $("#paymentPanel").find(".ancho").toggle();
        $("#paymentPanel").find("#comprar").toggle();
        $(".hidden_text_"+index).slideDown();
    }

    var cvvinfo= $('#infoCVVGC').html();
    $('.aux_cont').html(cvvinfo);
    $('.aux_cont').css('display','block');


}
//Crear el formulario para Affinity
function formularioAffinity(paymentId,index,code){
    var precioTotal= parseFloat(shopCartJSON.totalPrice);
    var cantdEnTarjetasRegalo = cantidadEnTarjetasRegalo(detalle);
    var cantidadPorPagar = parseFloat(precioTotal - cantdEnTarjetasRegalo);

    var formAff = '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.numeroTarjeta+'</label>'+
        '<input type="text" id="cardNumber_'+index+'" name="cardNumber_'+index+'" class="cardNumber_'+index+'" onblur="cargaModalidadPago()"/>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.nif+'</label>'+
        '<input type="text"  id="cardNif_'+index+'" name="cardNif_'+index+'" onblur="cargaModalidadPago()"/> '+
        '</div>'+
        '</div>'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.titularTarjeta+'</label>'+
        '<input type="text"  id="cardHolder_'+index+'" name="cardHolder_'+index+'"/>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.modalidad+'</label>'+
        '<select name="cardMode_'+index+'" id="cardMode_'+index+'"   disabled="disabled" >'+
        '</select>'+

        '</div>'+
        getSubmit(true,paymentId)+
        '</div>';
    return formAff;
}

function cargarModoPago(){
    var a=0;

}



//Obtiene los modos de pago disponibles para Affinity Card, mediante llamada AJAX
//Carga el combo con los m?todos de pago
function getAffinityPaymentModes(accountNumber, nif, amount)
{

    var urlPaymentModes = tiposPagoJSON.affinityPayModesUrl;
    var index = tiposPagoJSON.cards.length-1;
    //A?adir par?metros a la url
    urlPaymentModes = urlPaymentModes.replace('_account_', escape(accountNumber));
    urlPaymentModes = urlPaymentModes.replace('_nif_', escape(nif));
    urlPaymentModes = urlPaymentModes.replace('_amount_', escape(amount));
    var selected = $('#cardMode_'+index).val();
    var existe = false;

    var newUrl = urlPaymentModes.split('?')[0];

    var data = {
        "storeId" 		:	Inditex.iStoreId,
        "langId"		:	Inditex.iLangId,
        "catalogId"		:	Inditex.iCatalogId,
        "amount"		:	amount,
        "account"		:	accountNumber,
        "nif"			:   nif
    };

    //Llamada Ajax para obtener los payment modes
    jQuery.xajax({
        url: newUrl,
        dataType: 'json',
        type: 'post',
        data: data,
        success: function(responseJson) {

            if(responseJson.status=="1"){
                return;
            }
            if(responseJson==null){
                return;
            }

            $('#paymentpanel #cardMode_'+index+'').empty();
            var opcion = '';
            for (var i=0;i<responseJson.affinityPayMethods.length; i++){
                var item = responseJson.affinityPayMethods[i];
                if (selected==item.paymentModeId) {
                    existe=true;
                }
                opcion += '<option name="'+item.paymentModeName+'" value="'+item.paymentModeId+'">' +item.paymentModeName+'</option>';
            }

            if (responseJson.isEmployee == "true"){
                $('#discountAffinity').css('display','block');
            } else {
                $('#discountAffinity').css('display','none');
            }


            $("#paymentpanel #cardMode_"+index).html(opcion);
            $("#paymentpanel #cardMode_"+index).removeAttr('disabled');
            if(existe) {
                $("#paymentpanel #cardMode_"+index).attr("value",selected);
            }

        }
    });


}




function cargaModalidadPago(){
    var index = tiposPagoJSON.cards.length-1;
    if(($("#cardNumber_"+index).val() != '') &&
        ($("#cardNif_"+index).val() != '')){
        //Solo se ejecuta cuando sea affinity
        if ($("#cardType_"+index).val().toLowerCase() == 'affinity' ) {
            $("#cardMode_"+i).removeAttr('disabled');
            //Si se obtienen correctamente las modalidades de pago Affinity, cargar el combo
            getAffinityPaymentModes($('#cardNumber_'+index).val(), $('#cardNif_'+index).val(), shopCartJSON.totalPrice);
        }
    }else {
        $('#cardMode_0').empty();

    }

}

function cargaModalidadPagoInstallments(paymentId){
    var index = tiposPagoJSON.cards.length-1;
    var totalBalance=0;
    for (var i = 0; i < tiposPagoJSON.cards.length; i++) {
        if (tiposPagoJSON.cards[i].balance != undefined)
            totalBalance += parseFloat(formatPriceGiftCard(tiposPagoJSON.cards[i].balance));
    }
    var amount = parseFloat(shopCartJSON.totalPrice)-parseFloat(totalBalance);
    if($("#cardNumber_"+index)&&$("#cardNumber_"+index).val() != '' ){
        var cardNoSpaces=$('#cardNumber_'+index).val().replace(/\s/g,'');
        Inditex.getRestOrderPaymentModes({
            number: cardNoSpaces,
            amount: amount,
            policy: paymentId,
            vatin:($('#nifPay'))?$('#nifPay').val():"",
            onSuccess: function(aJson) {
                if(aJson.errorKey){
                    showError(aJson.errorMessage);
                }else{
                    if(aJson.paymentModes&&aJson.paymentModes.length>0){
                        $("#installmentsCode_"+index).empty();
                        var opcion = '';
                        for (var i=0;i<aJson.paymentModes.length; i++){
                            var item = aJson.paymentModes[i];

                            opcion += '<option name="'+item.name+'" value="'+item.id+'">' +item.name+'</option>';
                        }
                        $("#installmentsCode_"+index).html(opcion);
                        $("#installmentsCode_"+index).removeAttr('disabled');
                        $("#installmentsCode_"+index).parent().css('visibility','visible');
                    }else{
                        $("#installmentsCode_"+index).attr('disabled');
                        $("#installmentsCode_"+index).parent().css('visibility','hidden');
                    }
                }
            },
            onFailure: function(aStatus) {
                showError(ITX_TEXT_GENERIC_PROBLEM);
                $("#installmentsCode_"+i).attr('disabled');
                $("#installmentsCode_"+i).parent().css('visibility','hidden');
            }
        });
    }else {
        $('#installmentsCode_'+index).empty();

    }

}
//aadimos el botn de submit
function getSubmit(aclaracion, paymentId){

    var submit ="";
    var indice = tiposPagoJSON.cards.length-1;

    if (paymentId.toLowerCase() == 'qiwi' || paymentId.toLowerCase() == 'cod')
        var textInformativo ='';
    else {
        var textInformativo = '<span class="info_campo">' + Messages.camposObligatorios + '</span>';
    }

    if ( (($('#isWalletEnabled').val()=='true') && ($("#userType").attr('value')=="R") && ($("#"+paymentId).attr('data-walletsuitable')==1))&& ($('#shipModeDP').val()=='true') ){
        submit += walletZone();
    }
    submit+=  '<div id="cv2_desc" class="hidden_text_' + indice + '" style="background-color:white;">'+
        '<div class="aux_capa">'+
        '<a href="javascript:void(0);" onclick="toggle(\'' + indice + '\');" class="close">&nbsp;</a>'+
        '<div class="aux_cont info" id="insert_desc">'+
        '<br>'+
        '<br>'+
        '</div>'+
        '</div>'+
        '</div>' +
        (aclaracion? textInformativo:'');
    if (indice == 0){
        submit+= getRadiosCompra(paymentId);
    }

    if(paymentId.toLowerCase() == 'ideal'){
        submit += '<input type="hidden" id="eShopperCode_'+indice+'"  name="eShopperCode_'+indice+'" value="" />';
    }
    if(paymentId.toLowerCase() == 'p24'){
        submit += '<input type="hidden" id="eShopperCode_'+indice+'"  name="eShopperCode_'+indice+'" value="'+ storeCountryABBR +'" />';
    }

    submit+=
        '<input type="hidden" id="cardType_'+indice+'"  name="cardType_'+indice+'" value="' + paymentId + '" />'+
        '<input type="hidden" id="cardAmount_'+indice+'"  name="cardAmount_'+indice+'" value="" />'+
        '<input type="hidden" id="cardVariant_'+indice+'"  name="cardVariant_'+indice+'" value="" />'+
        '<input type="hidden" id="cardBalance_'+indice+'"  name="cardBalance_'+indice+'" value="" />'+
        '<input type="hidden" id="cardMonth_'+indice+'" name="cardMonth_'+indice+'" value=""/>'+
        '<input type="hidden" id="cardYear_'+indice+'" name="cardYear_'+indice+'" value="" />';
    if(paymentId.toLowerCase() == 'mobile'||paymentId.toLowerCase() == 'inWallet'){
        submit += '<input type="hidden" id="cardHash_'+indice+'"  name="cardHash_'+indice+'" value="" />';
    }
    return submit;
}

function getRadiosCompra(paymentId){
    var radios = "";
    radios+= '<ul class="opt_check" id="opt_check">';
    if(shopCartJSON.minPriceToInvoce != ""  || Inditex.iStoreJSON.details.eInvoiceEnabled == "1" || isCompany){
        //El check de la factura s?lo es necesario repintarlo para el primer m?todo de pago para el resto no es necesario
        if(tiposPagoJSON.cards.length == 1){
            radios+= '<li style="border-top:solid 1px #9f9f9f;border-bottom:solid 1px #9f9f9f; padding: 10px 0">';
            radios+= getFacturaRadio();
            radios+= '</li>';
        }
    }
    radios += '<li id="liCheckPoliticaEmpleado">';
    radios += getPoliticaPrivacidad(paymentId);
    radios+= '</li>';
    radios+= '</ul>';
    return radios;
}

function getFacturaRadio(){
    var factura = "";
    var solicitarFactura;
    if (Inditex.iStoreJSON.details.eInvoiceEnabled&&Inditex.iStoreJSON.details.eInvoiceEnabled!="0"){
        solicitarFactura=Messages.solicitarEFactura;
    }else{
        solicitarFactura=Messages.solicitarFactura;
    }
    factura+= '<input type="checkbox" style="display: none;" name="factura" value="false" id="factura" >'+
        '<label class="lt3000" style="display:inline">'+solicitarFactura+'</label>'+
        '<label class="gt3000" style="display:none">'+Messages.nifImporteSuperior+' </label>'+
        '<br style="clear:both"/>'+
        '<div class="nifnie_input" class="column" style="display:none"><label class="lt3000" style="display:none">'+Messages.nifImporteInferior+'</label><div class="row"><input type="text" name="nifPay" id="nifPay" value="'+shopCartJSON.nif+'"  style="float:left; position:relative; padding-left:4px" />'+
        '<input type="hidden" name="address_id" id="address_id" value="'+shopCartJSON.address_id+'" />'+
        '<input type="hidden" name="shipModeDP" id="shipModeDP" value="'+$('#shipModeDP').val()+'" />'+
        '</div>'+
        '</div>'+
        '<br style="clear:both"/>'+
        '<span class="info_campo lt3000" style="display:none">'+Messages.camposObligatorios+'</span>';//shopCartJSON.minPriceToInvoce
    if(shopCartJSON.minPriceToInvoce != ""){
        factura+= '<span class="info_campo gt3000" style="display:none">'+Messages.campoObligatorioImporteSuperior+' ' + Inditex.formatPrice(shopCartJSON.minPriceToInvoce* Math.pow(10,Math.abs(Inditex.iStoreJSON.details.locale.currencyDecimals)))+'</span>';
    }else{
        factura+= '<span class="info_campo gt3000" style="display:none">'+Messages.camposObligatorios+'</span>';
    }


    return factura;
}


function getPoliticaPrivacidad(paymentId){
    var politica ="";
    var urlCondicionesCompra =  $('#iCondicionesCompraView').attr('value');
    var urlPolitica = $('#ipoliticaPrivacidadURL').attr('value');
    var mostarPolitica = $('#showPolicyPriv').attr('value');
    var urlCondicionesTR = $('#iCondicionesTR').attr('value');

    if(shopCartJSON.minPriceToInvoce != ""){
        politica+=	'<input type="checkBox" name="politica" id="politica"/>'+
            '<label>'+Messages.acepto+' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'condiciones_compra\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_condiciones_de_compra\',null,true); openGenericModal(\''+urlCondicionesCompra+'\',[\'scrollable\'],addScroll,null,0.7)">'+Messages.condicionesCompra+'</a>';
    }
    else{
        politica+= '<input type="checkBox" name="politica" id="politica"/>'+
            '<label>'+Messages.acepto+' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'condiciones_compra\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_condiciones_de_compra\',null,true); openGenericModal(\''+urlCondicionesCompra+'\',[\'scrollable\'],addScroll,null,0.7)">'+Messages.condicionesCompra+'</a>';
    }
    if (mostarPolitica == "true"){
        if (paymentId.toLowerCase() != 'giftcard') {
            politica+= Messages.union;
        }else {
            politica+= ",";
        }
        politica+=' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'politica_privacidad\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_politica_de_privacidad\',null,true); openGenericModal(\''+urlPolitica+'\',[\'scrollable\'],addScroll,null,0.7);">'+Messages.politica+'</a></label>';
        if(paymentId.toLowerCase() == 'giftcard'){
            politica+='<label> ' + Messages.union +' <a href="javascript:void(0);" onclick="openGenericModal(\''+urlCondicionesTR+'\',[\'scrollable\'],addScroll,null,0.7);">'+Messages.condicionesCompraTR+'</a></label>';
        }
        politica+= '<p for="politica" class="error" style="display:none;">'+Messages.condicionesYPolitica+'</p>';
    }else{
        if(paymentId.toLowerCase() == 'giftcard'){
            politica+=Messages.union +' <a href="javascript:void(0);" onclick="openGenericModal(\''+urlCondicionesTR+'\',[\'scrollable\'],addScroll,null,0.7);">'+Messages.condicionesCompraTR+'</a>';
        }
        politica+= '</a></label><p for="politica" class="error" style="display:none;">'+Messages.condiciones+'</p>';
    }
    return politica;

}

/*Submit cuando pagamos con wallet*/
function getWalletSubmit(aclaracion, paymentId){
    var urlCondicionesCompra =  $('#iCondicionesCompraView').attr('value');

    var urlPolitica = $('#ipoliticaPrivacidadURL').attr('value');
    var mostarPolitica = $('#showPolicyPriv').attr('value');
    var urlCondicionesTR = $('#iCondicionesTR').attr('value');
    var submit ="";
    var indice = tiposPagoJSON.cards.length-1;

    var textInformativo = '<span class="info_campo">' + Messages.camposObligatorios + '</span>';

    if(shopCartJSON.minPriceToInvoce != "" || Inditex.iStoreJSON.details.eInvoiceEnabled == "1"){
        var solicitarFactura;
        if (Inditex.iStoreJSON.details.eInvoiceEnabled&&Inditex.iStoreJSON.details.eInvoiceEnabled!="0"){
            solicitarFactura=Messages.solicitarEFactura;
        }else{
            solicitarFactura=Messages.solicitarFactura;
        }
        submit+='<ul class="opt_check" id="opt_check">'+
            '<li>'+
            '<span class="info_campo lt3000" style="display:block">'+Messages.camposObligatorios+'</span>'+
            '<div class="ancho">'+
            '</li>'+

            '<li>'+
            '<input type="checkbox" style="display:none;" name="factura" value="false" id="factura">'+
            '<a id="check_factura" class="check" onclick="javascript:compruebaFactura();"></a>'+
            '<label class="lt3000" style="">'+solicitarFactura+'</label>'+
            '<label class="gt3000" style="display:none">'+Messages.nifImporteSuperior+' </label>'+

            '<br style="clear:both"/>'+
            '<div class="nifnie_input" class="column" style="display:none">'+
            '<label class="lt3000" >'+Messages.nifImporteInferior+'</label>'+
            '<div class="row"><input type="text" name="nifPay" id="nifPay" value="'+shopCartJSON.nif+'"  style="float:left; position:relative; padding-left:4px" />'+
            '<input type="hidden" name="address_id" id="address_id" value="'+shopCartJSON.address_id+'" />'+
            '<input type="hidden" name="shipModeDP" id="shipModeDP" value="'+$('#shipModeDP').val()+'" />'+
            '</div>'+
            '<br style="clear:both"/>'+
            '<span class="info_campo lt3000" style="display:block">'+Messages.camposObligatorios+'</span>';//shopCartJSON.minPriceToInvoce
        if(shopCartJSON.minPriceToInvoce != ""){
            submit+= '<span class="info_campo gt3000" style="display:none">'+Messages.campoObligatorioImporteSuperior+' ' + Inditex.formatPrice(shopCartJSON.minPriceToInvoce)+'</span>';
        }else{
            submit+= '<span class="info_campo gt3000" style="display:none">'+Messages.camposObligatorios+'</span>';
        }
        submit+='</li>'+
            '<li id="liCheckPoliticaEmpleado"><div class="ancho"></div>'+
            '<input id="politica" class="converted" type="checkBox" name="politica" style="visibility: hidden; position: absolute; width: 0px;">'+
            '<a id="check_politica" class="check" onclick="compruebaPolitica();"></a>'+
            '<label>'+Messages.acepto+' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'condiciones_compra\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_condiciones_de_compra\',null,true); openGenericModal(\''+urlCondicionesCompra+'\',[\'scrollable\'],addScroll,null,0.7)">'+Messages.condicionesCompra+'</a>'
        ;
    }
    else{
        submit+= '<ul class="opt_check" id="opt_check">'+
            '<li id="liCheckPoliticaEmpleado">'+
            '<input id="politica" class="converted" type="checkBox" name="politica" style="visibility: hidden; position: absolute; width: 0px;">'+
            '<a id="check_politica" class="check" onclick="compruebaPolitica();"></a>'+
            '<label>'+Messages.acepto+' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'condiciones_compra\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_condiciones_de_compra\',null,true); openGenericModal(\''+urlCondicionesCompra+'\',[\'scrollable\'],addScroll,null,0.7)">'+Messages.condicionesCompra+'</a>';
    }
    if (mostarPolitica == "true"){
        if (paymentId.toLowerCase() != 'giftcard' && paymentId.toLowerCase() != 'discount') {
            submit+= Messages.union;
        }else {
            submit+= ",";
        }
        submit+=' <a href="javascript:void(0);" onclick="if(Inditex) Inditex.trackEvent(\'/Tramitacion_Pago\', \'politica_privacidad\'); Inditex.trackEvent( categoryEvent,\'Pago_ver_politica_de_privacidad\',null,true); openGenericModal(\''+urlPolitica+'\',[\'scrollable\'],addScroll,null,0.7);">'+Messages.politica+'</a></label>';
        if(paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount'){
            submit+='<label> ' + Messages.union +' <a href="javascript:void(0);" onclick="openGenericModal(\''+urlCondicionesTR+'\',[\'scrollable\'],addScroll,null,0.7);">'+Messages.condicionesCompraTR+'</a></label>';
        }
        submit+= '<p for="politica" class="error" style="display:none;">'+Messages.condicionesYPolitica+'</p>' +
            '</li>';
    }else{
        submit+= '</a></label><p for="politica" class="error" style="display:none;">'+Messages.condiciones+'</p>' +
            '</li>';
    }
    submit+=
        '</ul>';

    submit+=
        '<input type="hidden" id="cardType_'+indice+'"  name="cardType_'+indice+'" value="' + paymentId + '" />'+
        '<input type="hidden" id="cardAmount_'+indice+'"  name="cardAmount_'+indice+'" value="" />'+
        '<input type="hidden" id="cardVariant_'+indice+'"  name="cardVariant_'+indice+'" value="" />'+
        '<input type="hidden" id="cardBalance_'+indice+'"  name="cardBalance_'+indice+'" value="" />'+
        '<input type="hidden" id="cardMonth_'+indice+'" name="cardMonth_'+indice+'" value=""/>'+
        '<input type="hidden" id="cardYear_'+indice+'" name="cardYear_'+indice+'" value="" />';



    return submit;
}


function formularioTR(paymentId,index){
    if (numeroTRUsadas >= NUMERO_MAXIMO_PAGO_TARJETAS){
        var mensajeNumMaxTRAlcanzado = Messages.numMaxTRAlcanzado;
        openStaticModal(errorPayment.title, mensajeNumMaxTRAlcanzado, false);
        return '';
    }
    else{
        var displayPropertyTarjeta = Messages.numeroTR;
        if (paymentId.toLowerCase() == 'discount') {
            displayPropertyTarjeta = Messages.numeroTarjeta;
        }
        return  '<div id="paymentpanel" style="display:block;"  class="form">'+
            '<div class="row">'+
            '<div class="block">'+
            '<label>'+displayPropertyTarjeta+'</label>'+
            '<input type="text" id="cardNumber_'+index+'" name="cardNumber_'+index+'" class="cardNumber_'+index+'"/>'+
            '</div>'+
            '<div class="block r">'+
            '<label>&nbsp;</label>'+
            '<a href="javascript:void(0)" class="acc_butt" onclick="get_balance('+index+')" >'+Messages.validar+'</a>'+
            '</div>'+
            '</div>'+
            '<div class="row">'+
            '<div class="block">'+
            '<label>'+Messages.codigoSeg+'</label>'+
            '<input type="text" class="wid1" id="cardCvv_'+index+'" name="cardCvv_'+index+'"/>'+
            '</div>'+
            '</div>'+
            '<div class="row" style="margin-top:-10px;" id="infoLink">'+
            '<div class="block">'+
            '<a onclick="toggleWrapperGC(\'' + index +'\');Inditex.trackPage( \'Cesta_de_Compra/Tramitar_Pedido/Pago\' +trackingGetTarjeta()+ \'/Informacion_CVV\' +extraPageview ,{\'page\':false});" href="javascript:void(0)" class="a_info">'+Messages.queEsCodigoSeg+'</a>'+
            '</div>'+
            '</div>'+
            '<div class="row" id="captchaRow_'+index+'">'+
            '<div class="block">'+
            '<label>'+Messages.captcha+'</label>'+
            '<img src="'+$('#captchaURL').attr('value')+'" alt="captcha" id="captchaImg" />'+
            '</div>'+
            '</div>'+
            '<div class="row" id="captchaRow_ct_'+index+'">'+
            '<input type="text" class="wid1" id="ct_'+index+'" name="ct" class="ct_'+index+'"/>'+
            '</div>'+
            '<div class="row" id="card_data" style="display:none; border:1px solid #000; font-size:12px; padding:6px 8px; width: 96%">'+
            '<div style="float:left">'+
            Messages.saldoActual+
            '</div>'+
            '<div id="card_balance" style="float:right"></div>'+
            '<br style="clear:both">'+
            '<div id="remain_block" style="display:none;">'+
            '<hr style="margin:2px 0;" />' +
            '<div style="float:left">'+
            Messages.metodoAdicional+
            '</div>'+
            '<div id="remain_to_pay" style="float:right"></div>'+
            '<br style="clear:both">'+
            '</div>'+
            '</div>'+
            '<div class="row" id="additional_method" style="display:none">'+
            '<a href="javascript:void(0)" style="color:#000; font-size:12px;" onclick="get_additional_methods()">'+ Messages.seleccioneMetodoAdicional+'</a>'+
            '<img src="'+DUTTI_STATIC_CONTENT_PATH+'/img/right_arrow.png" class="but_arrow" id="ocultar_'+index+'" style="margin-left:5px;">'+
            '<img src="'+DUTTI_STATIC_CONTENT_PATH+'/img/down_arrow.png" class="but_arrow" id="mostrar_'+index+'" style="margin-left:3px; display:none">'+
            '</div>'+
            getSubmit(true,paymentId)+
            '</div>';
    }

}


function formularioQiwi(paymentId,index){
    return '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<div class="row">'+
        '<div class="">'+
        '<label>'+Messages.numeroQiwi+'</label>'+
        '<input type="text"  id="phoneNumber_'+index+'" name="phoneNumber_'+index+'" class="phoneNumber"/>'+
        '</div>'+
        '</div>'+ getSubmit(true,paymentId)+
        '</div>';
}
function formularioCOD(paymentId,index){
    return '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<div class="row">'+
        '<div class="">'+
        '<label>'+ Messages.descCOD+'</label>'+
        '</div>'+
        '</div>'+ getSubmit(true,paymentId)+
        '</div>';
}

//Crear el formulario si no es Affinity ni PAYPAL
function formularioNotAffinity(paymentId,index){
    var self = this;

    var htmlCard = '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.numeroTarjeta+'</label>'+
        '<input type="text"  id="cardNumber_'+index+'" name="cardNumber_'+index+'" class="cardNumber_'+index+'"/>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.titularTarjeta+'</label>'+
        '<input type="text" id="cardHolder_'+index+'" name="cardHolder_'+index+'"/>'+
        '</div>'+
        '</div>'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.fechaCaducidad+'</label>'+
        '<input type="text" id="fechaCaducidad" name="fechaCaducidad" value="'+Messages.formatDateMonthYear+'"/>'+
        '<p class="infor" id="fechaInfo">'+Messages.fechaCaducidadMayor+'</p>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.codigoSeg+'</label>'+
        '<input type="text" class="wid1" id="cardCvv_'+index+'" name="cardCvv_'+index+'"/>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '<div class="row" style="margin-top:-10px;" id="infoLink">'+
        '<div class="block r">'+
        '<a onclick="toggleWrapper(\'' + index +'\');Inditex.trackPage( \'Cesta_de_Compra/Tramitar_Pedido/Pago\' +trackingGetTarjeta()+ \'/Informacion_CVV\' +extraPageview ,{\'page\':false});" href="javascript:void(0)" class="a_info">'+Messages.queEsCodigoSeg+'</a>'+
        '</div>'+
        '</div>';



    var paymentMethod = self.getPaymentMethodById(paymentId);
    if (paymentMethod != null && paymentMethod.is_billing_address_mandatory == "1" && $("#isUserGuest").attr('value')=="true") {
        htmlCard += '<div class="row">' +
            '	<div class="block">' +
            '		<label>' + Messages.lbAddressBilling + ' *</label>' +
            '		<input type="text" name="direccionFact" id="direccionFact" class="required">' +
            '	</div>' +
            '	<div class="block r">' +
            '		<label>' + Messages.lbZipCode + ' *</label>' +
            '		<input type="text" name="codigoPostal" id="codigoPostal" class="required requiredChangeClass">' +
            '	</div>' +
            '	<div class="block">' +
            '		<label>' + Messages.lbCity + ' *</label>' +
            '		<input type="text" name="localidad" id="localidad" class="required">' +
            '	</div>';

        if (iCountry == "GB") {
            htmlCard += '	<div class="block r" style="display: none">';
        } else {
            htmlCard +=  '	<div class="block r">';
        }

        htmlCard +=  '		<label>' + Messages.lbState + ' *</label>' +
            '		<div class="multidrop single tunelcuenta" title="provincia">' +
            '			<select id="provincia" name="provincia" title="provincia" class="itxSelect">';

        if (iCountry == "GB") {
            htmlCard += '<option value="GBUKD">GBUKD</option>';
        } else {
            htmlCard += '<option value="">'+ Messages.lbState +'</option>';
            for ( var int = 0; int < Inditex.iXStateJSON.states.length; int++) {
                var state = Inditex.iXStateJSON.states[int];
                htmlCard += '<option value="'+ state.code +'">'+ state.name +'</option>';
            }
        }

        htmlCard += '				</select>'+
            '		</div>' +
            '		<br class="clearf">';
        htmlCard += '<p class="error" style="display:none;margin-top: 23px;" for="provincia">Elija su provincia</p>';
        htmlCard += '	</div>' +
            '</div>';
    }




    htmlCard += getSubmit(true,paymentId) +'</div>';
    return htmlCard;
}

//Crear el formulario si no es PAYPAL
function formularioPayPal(paymentId,index){
    return '<div id="paymentpanel" style="display:block;"  class="form">'+
        '<div class="row"><p style="text-decoration:underline">'+ Messages.paypal+'</p></div>'+
        '<div class="row"><p>'+ Messages.paypalInfo+'</p></div>'+
        getSubmit(false, paymentId)+
        '</div>';
}

function formularioSafetyPay(paymentId,index){
    return '<div id="paymentpanel" style="display:block;"  class="form">'+
        '<div class="row"><p style="text-decoration:underline">'+ Messages.safetypay+'</p></div>'+
        '<div class="row"><p>'+ Messages.safetypayInfo+'<br/>'+ Messages.safetypayBanks +'</p></div>'+
        getSubmit(false, paymentId)+
        '</div>';
}

function formularioinWalletMobile(paymentId,index){
    return '<div id="paymentpanel" style="display:block;"  class="form">'+

        '<div class="row"><p>'+Messages.inWalletMobilePayment+'</p></div>'+
        '<div id="qr_content" class="row">'+
        '<label for="data-itx-bind-mobile-payment-qr-input">'+Messages.introducirQR+'</label><br>'+
        '<input type="text" name="data-itx-bind-mobile-payment-qr-input" id="data-itx-bind-mobile-payment-qr-input" class="required checkValidQR" />'+
        '<div class="row errorPlace"></div>'+
        '<label><small>'+Messages.inWalletMobileInfo+'</small></label>' +
        '<p><a id="data-itx-bind-mobile-payment-qr-submit" class="acc_butt"  href="javascript:void(0)">'+Messages.validar+'</a></p>'+
        '<input id="qrCard" name="qrCard" style="visibility: hidden; height: 0px" class="checkValidatedQR">'+
        '</div><span class="info_campo">'+  Messages.camposObligatorios + '</span>'
        +getSubmit(false, paymentId)+
        '</div>';
}

function formularioinWallet(paymentId,index){
    return  '<div id="paymentpanel" style="display:block;"  class="form">'+
        '<div class="row"><p>'+Messages.inWalletPayment+'</p></div>'+
        '<div id="qr_content" class="row">'+
        '<div id="inWalletUser"><label for="in_user">'+Messages.inWalletUser+'</label><br>'+
        '<input type="text" name="in_user" id="in_user" class="required" /></div>'+
        '<div id="inWalletPass"><label for="in_pass">'+Messages.inWalletPassword+'</label><br>'+
        '<input type="password" name="in_pass" id="in_pass" class="required" /></div>'+
        '<p><a id="in_user_validate" class="acc_butt" onclick="recoverInWalletCards();" href="javascript:void(0)">'+Messages.recuperarTarjetas+'</a></p>'+
        '<div><input name="loguedInwalletUser" id="loguedInwalletUser" style="visibility: hidden" class="checkLoguedInwalletUser">'+
        '</div>'+
        '</div></div>'+
        '<div class="row">'+
        '<div id="inWallet_payments" class="row">'+

        '</div></div>'+
        '<span class="info_campo">'+Messages.camposObligatorios+'</span>'
        +getSubmit(false, paymentId)+'</div>';
}

//Crear el formulario si es iDeal
function formularioiDeal(paymentId, index) {


    var htmkIdeal = '<div id="paymentpanel" style="display:block;"  class="form">'+
        '<div class="row"><p>'+ Messages.ideal + '</p></div>'+
        '<div class="row">'+
        '<div class="block">'+
        '<label for="bankName">'+ Messages.idealBank + '</label><br>'+
        '<div class="multidrop single required">'+
        '<select title="bankselector" id="bankName" name="bankName" onchange="loadEShopperCode()">'+
        '<option value="">'+ Messages.idealBankOptionDefalut + '</option>';

    for (var i=0; i< idealBanksJSON.length; i++) {
        htmkIdeal = htmkIdeal + '<option value="' + idealBanksJSON[i].key + '">' + idealBanksJSON[i].name + '</option>';
    }
    htmkIdeal = htmkIdeal +			'</select>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '<div class="row errorPlace"></div>'+
        '<div class="row"><p>'+ Messages.idealInfo + '</p></div>'
        + getSubmit(false, paymentId)+'</div>';

    return htmkIdeal;
}

function loadEShopperCode() {
    var indice = tiposPagoJSON.cards.length-1;
    $('#eShopperCode_'+indice).val( $('#bankName').find(":selected").val());
}

function formularioKlarnaGuest(index){
    var RECOGER_TIENDA_SHIP_MODE_ID = 4;
    if (shopCartJSON.shippingModeId == RECOGER_TIENDA_SHIP_MODE_ID && $("#isUserGuest").attr('value')=="true") {
        var htmlCard = '<div class="row">' +
            '	<div class="block">' +
            '		<label>' + Messages.lbAddressBilling + ' *</label>' +
            '		<input type="text" name="kl_address1_'+index+'" id="kl_address1_'+index+'" class="required">' +
            '	</div>' +
            '	<div class="block r">' +
            '		<label>' + Messages.lbZipCode + ' *</label>' +
            '		<input type="text" name="kl_zipCode_'+index+'" id="kl_zipCode_'+index+'" class="required requiredChangeClass">' +
            '	</div></div><div class="row">' +
            '	<div class="block">' +
            '		<label>' + Messages.lbCity + ' *</label>' +
            '		<input type="text" name="kl_city_'+index+'" id="kl_city_'+index+'" class="required">' +
            '	</div>';

        if (iCountry == "GB") {
            htmlCard += '	<div class="block r" style="display: none">';
        } else {
            htmlCard +=  '	<div class="block r">';
        }

        htmlCard +=  '		<label>' + Messages.lbState + ' *</label>' +
            '		<div class="multidrop single tunelcuenta" title="' + Messages.lbState + '">' +
            '			<select id="kl_state_'+index+'" name="kl_state_'+index+'" title="' + Messages.lbState + '" class="required itxSelect">';

        if (iCountry == "GB") {
            htmlCard += '<option value="GBUKD">GBUKD</option>';
        } else {
            htmlCard += '<option value="">'+ Messages.lbState +'</option>';
            for ( var int = 0; int < Inditex.iXStateJSON.states.length; int++) {
                var state = Inditex.iXStateJSON.states[int];
                htmlCard += '<option value="'+ state.code +'">'+ state.name +'</option>';
            }
        }

        htmlCard += '				</select>'+
            '		</div>' +
            '		<br class="clearf">';
        htmlCard += '<p class="error" style="display:none;margin-top: 23px;" for="kl_state_0">Elija su provincia</p>';
        htmlCard += '	</div>' +
            '</div>';
        return htmlCard;
    }
    return "";
}

//Crear el formulario si es kinvoice
function formularioKlarnaInvoice(paymentId, index) {

    var localeKlarna = $("#locale").val();
    var shortLocale = $("#shortLocale").val();
    localeKlarna = (shortLocale === 'no' ? 'nb' : shortLocale) + '_' + storeCountryABBR;

    switch (storeCountryABBR) {

        case 'DK':
        case 'SE':
        case 'FI':

            loadKlarna  =  function() {
                new Klarna.Terms.Invoice({
                    el: 'invoiceTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    charge: chargeKlarna,
                    type: 'desktop'
                });
            };

            return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaInvoice+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaInvoiceText +'&nbsp;<span id="invoiceTerms"></span></p></div>'+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.personalNumber +'</label><input id="kbPNO_'+index+'" type="text" name="kbPNO_'+index+'"><p id="personalNumberInfo" class="infor">'+ getMessage('validKlarnaPersonalNumber') +'</p></div></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaInvoice");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';

            break;

        case 'AT':
        case 'DE':

            loadKlarna  =  function() {
                new Klarna.Terms.Invoice({
                    el: 'invoiceTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    charge: chargeKlarna,
                    type: 'desktop'
                });

                new Klarna.Terms.Consent({
                    el: 'invoiceConsent',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });

                //loadRadiosAndChecks();
                removeValueFromFieldOnClick("kbPNO_"+index);
            };

            return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaInvoice+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaInvoiceText +'&nbsp;<span id="invoiceTerms"></span></p></div>'+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat') +'"><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat') +'</p></div>'+
                '<div class="block r"><label>'+ Messages.gender +'</label>'+
                '<fieldset>'+
                '<input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p>'+
                '</fieldset></div></div>'+formularioKlarnaGuest(index)+
                '<div id="klarnaTermsCond" class="row"><input id="klarnaConditions" type="checkbox" name="klarnaConditions"><label>'+ Messages.acceptTermsConditionsInvoice +
                '</label>'+'<p class="error" style="display:none;height:25px;" for="klarnaConditions">'+ Messages.mustAcceptTermsConditions +'</p></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaInvoice");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';

            break;

        case 'NL':

            loadKlarna  =  function() {
                new Klarna.Terms.Invoice({
                    el: 'invoiceTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    charge: chargeKlarna,
                    type: 'desktop'
                });

                loadRadiosAndChecks();
                removeValueFromFieldOnClick("kbPNO_"+index);
            };

            if (Inditex.iLangId == -1) {

                return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                    '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaInvoice+'</p></div>'+
                    '<div class="row"><p>'+ Messages.klarnaInvoiceText +'&nbsp;<span id="invoiceTerms"></span></p></div>'+
                    '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                    '<div class="row"><div class="block"><label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat_NLEN') +'"/><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat_NLEN') +'</p></div>'+
                    '<div class="block r"><label>'+ Messages.gender +'</label>'+
                    '<fieldset>'+
                    '<input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                    '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                    '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p></fieldset></div></div>'+
                    '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                    '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaInvoice");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                    '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                    +getSubmit(false, paymentId)+'</div>';
            }
            else {

                return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                    '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaInvoice+'</p></div>'+
                    '<div class="row"><p>'+ Messages.klarnaInvoiceText +'&nbsp;<span id="invoiceTerms"></span></p></div>'+
                    '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                    '<div class="row"><div class="block"><label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat_NLNL') +'"/><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat_NLNL') +'</p></div>'+
                    '<div class="block r"><label>'+ Messages.gender +'</label>'+
                    '<fieldset>'+
                    '<input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                    '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                    '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p></fieldset></div></div>'+
                    '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                    '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaInvoice");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                    '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                    +getSubmit(false, paymentId)+'</div>';
            }

            break;

        case 'NO':

            loadKlarna  =  function() {

                loadRadiosAndChecks();

                new Klarna.Terms.Invoice({
                    el: 'invoiceTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    charge: chargeKlarna,
                    type: 'desktop'
                });

                new Klarna.Terms.Invoice({
                    el: 'readmore_invoice',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });
            };

            return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaInvoice+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaInvoiceText +'&nbsp;<span id="invoiceTerms"></span></p></div>'+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.personalNumber +'</label><input id="kbPNO_'+index+'" type="text" name="kbPNO_'+index+'"><p id="personalNumberInfo" class="infor">'+ getMessage('validKlarnaPersonalNumber') +'</p></div></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaInvoice");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';
            break;
    }
}

//Crear el formulario si es KlarnaAccount
function formularioKlarnaAccount(paymentId, index) {

    var localeKlarna = $("#locale").val();
    var shortLocale = $("#shortLocale").val();
    localeKlarna = (shortLocale === 'no' ? 'nb' : shortLocale) + '_' + storeCountryABBR;

    switch (storeCountryABBR) {

        case 'DK':
        case 'SE':
        case 'FI':

            loadKlarna  =  function() {
                new Klarna.Terms.Account({
                    el: 'accountTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });
            };

            return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaAccount+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaAccountText +'&nbsp;<span id="accountTerms"></span></p></div>'+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.personalNumber +'</label><input id="kbPNO_'+index+'" type="text" name="kbPNO_'+index+'"><p id="personalNumberInfo" class="infor">'+ getMessage('validKlarnaPersonalNumber') +'</p></div></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaAccount");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';

            break;

        case 'AT':
        case 'DE':

            loadKlarna  =  function() {
                new Klarna.Terms.Account({
                    el: 'accountTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });
                new Klarna.Terms.Consent({
                    el: 'accountConsent',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });

                //loadRadiosAndChecks();
                removeValueFromFieldOnClick("kbPNO_"+index);
            };

            return '<div id="paymentpanet" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaAccount+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaAccountText +'&nbsp;<span id="accountTerms"></span></p></div>'+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat') +'"><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat') +'</p></div>'+
                '<div class="block r"><label>'+ Messages.gender +'</label><fieldset><input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p></fieldset></div></div>'+formularioKlarnaGuest(index)+
                '<div id="klarnaTermsCond" class="row"><input id="klarnaConditions" type="checkbox" name="klarnaConditions"><label>'+ Messages.acceptTermsConditionsAccount +
                '</label>'+'<p class="error" style="display:none;height:25px;" for="klarnaConditions">'+ Messages.mustAcceptTermsConditions +'</p></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaAccount");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';

            break;

        case 'NL':

            loadKlarna  =  function() {
                new Klarna.Terms.Account({
                    el: 'accountTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });

                loadRadiosAndChecks();
                removeValueFromFieldOnClick("kbPNO_"+index);
            };

            if (Inditex.iLangId == -1) {

                return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                    '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaAccount+'</p></div>'+
                    '<div class="row"><p>'+ Messages.klarnaAccountText +'&nbsp;<span id="accountTerms"></span></p></div>'+
                    '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                    '<div class="row"><div class="block"> <label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat_NLEN') +'"><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat_NLEN')+'</p></div>'+
                    '<div class="block r"><label>'+ Messages.gender +'</label><fieldset><input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                    '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                    '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p></fieldset></div></div>'+formularioKlarnaGuest(index)+
                    '<div id="klarnaTermsCond" class="row"><img width="124" height="56" src="'+DUTTI_STATIC_CONTENT_PATH+'/img/tarjetas/balk_afm5.jpg"></div>'+
                    '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                    '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaAccount");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+
                    '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                    +getSubmit(false, paymentId)+'</div>';
            }
            else {

                return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                    '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaAccount+'</p></div>'+
                    '<div class="row"><p>'+ Messages.klarnaAccountText +'&nbsp;<span id="accountTerms"></span></p></div>'+
                    '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                    '<div class="row"><div class="block"> <label>'+ Messages.dateBirth +'</label><input type="text" id="kbPNO_'+index+'" name="kbPNO_'+index+'" value="'+ getMessage('klarnaDateFormat_NLNL') +'"><p id="fechaInfo" class="infor" style="margin-left:0px;">'+ getMessage('validKlarnaDateFormat_NLNL')+'</p></div>'+
                    '<div class="block r"><label>'+ Messages.gender +'</label><fieldset><input id="r_men" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="m">'+
                    '<label class="radio_l" for="r_men" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.man+'</label><input id="r_women" class="radio_i" type="radio" name="kbGender_0" style="visibility: hidden; position: absolute; width: 0px;" value="f">'+
                    '<label class="radio_l" for="r_women" style="margin-right: 20px;margin-top: -2px;width: auto;">'+ Messages.woman+'</label><p class="error" style="display:none" for="kbGender_0">'+ Messages.sexo +'</p></fieldset></div></div>'+formularioKlarnaGuest(index)+
                    '<div id="klarnaTermsCond" class="row"><img width="124" height="56" src="'+DUTTI_STATIC_CONTENT_PATH+'/img/tarjetas/balk_afm5.jpg"></div>'+
                    '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                    '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaAccount");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+
                    '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                    +getSubmit(false, paymentId)+'</div>';
            }

            break;

        case 'NO':

            loadKlarna  =  function() {

                loadRadiosAndChecks();

                new Klarna.Terms.Account({
                    el: 'accountTerms',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });

                new Klarna.Terms.Account({
                    el: 'readmore_account',
                    eid: eidKlarna,
                    locale: localeKlarna,
                    type: 'desktop'
                });
            };

            return '<div id="paymentpanel" style="display:block;"  class="form klarna">'+
                '<div class="row"><p style="text-decoration:underline">'+ Messages.methodSelected +' '+ Messages.klarnaAccount+'</p></div>'+
                '<div class="row"><p>'+ Messages.klarnaAccountText +'&nbsp;<span id="accountTerms"></span></p></div>'+$("#klarnaAccount").html()+
                '<div class="row"><p>'+ Messages.requestKlarnaInfo +'</p></div>'+
                '<div class="row"><div class="block"> <label>'+ Messages.personalNumber +'</label><input id="kbPNO_'+index+'" type="text" name="kbPNO_'+index+'"><p id="personalNumberInfo" class="infor">'+ getMessage('validKlarnaPersonalNumber') +'</p></div></div>'+
                '<div id="infoLink" class="row" style="margin-top:-10px;"><div class="block r"></div></div>'+
                '<div id="cv2_desc" class="hidden_text_klarnaInvoice" style="background-color:white;"><div class="aux_capa"><a class="close" onclick="toggle("klarnaAccount");" href="javascript:void(0);"></a><div id="insert_desc" class="aux_cont info"><br><br></div></div></div>'+formularioKlarnaGuest(index)+
                '<span class="info_campo">'+ Messages.camposObligatorios +'</span>'
                +getSubmit(false, paymentId)+'</div>';


            break;
    }
}

//Crear el formulario si es P24
function formularioP24(paymentId, index) {
    return '<div id="paymentpanel" style="display:block;"  class="form">'+
        '<div class="row"><p>'+ Messages.p24 + '</p></div>'+
        '<div class="row"><p>'+ Messages.p24Info + '</p></div>'
        +getSubmit(false, paymentId)+'</div>';
}

//Crear el formulario si es de tipo credit_card_installments
function formularioCreditCardInstallments(paymentId,index){
    var selectedMethod=getPaymentMethodById(paymentId);
    return '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.numeroTarjeta+'</label>'+
        '<input type="text"  id="cardNumber_'+index+'" name="cardNumber_'+index+'" class="cardNumber_'+index+'" onblur="cargaModalidadPagoInstallments(\''+paymentId+'\')"/>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.titularTarjeta+'</label>'+
        '<input type="text" id="cardHolder_'+index+'" name="cardHolder_'+index+'"/>'+
        '</div>'+
        '</div>'+
        '<div class="row">'+
        '<div class="block">'+
        '<label>'+Messages.fechaCaducidad+'</label>'+
        '<input type="text" id="fechaCaducidad" name="fechaCaducidad" value="'+Messages.formatDateMonthYear+'"/>'+
        '<p class="infor" id="fechaInfo">'+Messages.fechaCaducidadMayor+'</p>'+
        '</div>'+
        '<div class="block r">'+
        '<label>'+Messages.codigoSeg+'</label>'+
        '<input type="text" class="wid1" id="cardCvv_'+index+'" name="cardCvv_'+index+'"/>'+
        '</div>'+
        '<div class="row" style="margin-top:-10px;" id="infoLink">'+
        '<div class="block r">'+
        '<a onclick="toggleWrapperGC(\'' + index +'\');Inditex.trackPage( \'Cesta_de_Compra/Tramitar_Pedido/Pago\' +trackingGetTarjeta()+ \'/Informacion_CVV\' +extraPageview ,{\'page\':false});" href="javascript:void(0)" class="a_info">'+Messages.queEsCodigoSeg+'</a>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '<div class="row">'+
        '<div class="block" style="visibility:hidden">'+
        '<label>'+Messages.modalidadFraccionado+'</label>'+
        '<select name="installmentsCode_'+index+'" id="installmentsCode_'+index+'"   disabled="disabled" >'+
        '</select>'+
        '</div>'+
        '</div>'+
        '</div>'+
        getSubmit(true,paymentId)+
        '</div>';
    '</div>'+
    '<div class="row" style="margin-top:-10px;" id="infoLink">'+
    '<div class="block r">'+
    '<a onclick="toggleWrapper(\'' + index +'\');Inditex.trackPage( \'Cesta_de_Compra/Tramitar_Pedido/Pago\' +trackingGetTarjeta()+ \'/Informacion_CVV\' +extraPageview ,{\'page\':false});" href="javascript:void(0)" class="a_info">'+Messages.queEsCodigoSeg+'</a>'+
    '</div>'+
    '</div>'+ getSubmit(true,paymentId)+
    '</div>';
}

function getPaymentMethodById(paymentId){
    for (var i=0;i<tiposPagoJSON.payments.length;i++){
        if(tiposPagoJSON.payments[i].paymentId==paymentId){
            return tiposPagoJSON.payments[i];
        }
    }
    return null;
}

var rules = {};
var messages = {};

var iAsyncPaymentPollingCount = 0;

function submitAsyncPayment(data) {

    iAsyncPaymentPollingCount = 0;

    var data = $("#form1").serializeArray();

    for (var i=0; i<data.length; i++) {
        if (data[i].name == 'viewname') {
            data[i].value = 'ItxStandardJSON'
        }
        if (data[i].name == 'errorViewName') {
            data[i].name = 'ItxStandardJSON';
        }
        if ($("#cardType_0").val()=="KINVOICE" || $("#cardType_0").val()=="KACCOUNT") {
            //Formateamos el valor de la fecha que se le enva al comando, quitndole las barras
            if (data[i].name.indexOf('kbPNO_')>-1) {
                data[i].value = $("#"+data[i].name).val().replace( new RegExp('/', 'g'),"");
                if (storeCountryABBR == 'NL' && Inditex.iLangId == -1) {
                    data[i].value = data[i].value[2] + data[i].value[3] + data[i].value.substring(0,2)[0] + data[i].value.substring(0,2)[1] + data[i].value.substring(4);
                }
            }
        }
    }

    data = $.param(data);

    jQuery.xajax({
        "url": Inditex.generateUrl("ItxStandardOrderConfirmationCmd", {
            "storeId": Inditex.iStoreId,
            "langId": Inditex.iLangId,
            "catalogId": Inditex.iCatalogId,
            "orderId": tiposPagoJSON.orderId
        },true),
        "type": "post",
        "dataType": 'json',
        "data": data,
        "success": function(json, textStatus, jqXHR) {
            processPaymentStatus(json);
        },
        "error": function(xhr) {
            Inditex.trackEvent( categoryEvent,"Autorizar_Pago_"+trackingGetTarjeta()+"_validacion_error",Inditex.codeError(xhr.status,xhr.statusText),true);
            showError(ITX_TEXT_GENERIC_PROBLEM);
        }
    });
};

function showError(text) {

    var e0,e1;

    e0 = jQuery("<div />");
    e1 = jQuery("<div />", {
        "class": "int"
    });
    e1.append(jQuery("<div/>", {
        "class": "gran",
        "html": ITX_TEXT_ERROR
    }));
    e1.append(jQuery("<div />", {
        "class": "peq",
        "html": text
    }));
    e1.append(jQuery("<div />", {
        "style" : "margin-bottom: 20px"
    }));

    e0.append(e1);

    Inditex.popupHtml(
        e0,
        600,
        265,
        function(ref) {
            if (Inditex) {
                Inditex.trackPage('/Cesta_de_Compra/Tramitar_Pedido/Verificacion_Tarjeta');
            }
        }
    );
}


function processPaymentStatus(json,compraRapida) {

    var accionEvent = "Autorizar_Pago_"+trackingGetTarjeta()+"_validacion_error";
    /*if (compraRapida) {
     accionEvent = "Autorizar_pago_error";		
     }*/

    if (json.data === null || json.data.orderStatus === undefined) {
        if (json.errorKey) {
            Inditex.trackEvent( categoryEvent,accionEvent,Inditex.codeError(json.errorKey,json.errorMessage),true);
            showError(json.errorMessage);
        } else {
            Inditex.trackEvent( categoryEvent,accionEvent,Inditex.codeError("ITX_TEXT_GENERIC_PROBLEM",ITX_TEXT_GENERIC_PROBLEM),true);
            showError(ITX_TEXT_GENERIC_PROBLEM);
        }
    } else if (json.data.orderStatus === "PQ" && json.data.redirectTo != null
        && json.data.noPolling == true) {
        redirectPaymentTo(json.data.redirectTo, json.data.redirectData,compraRapida);
    } else if (json.data.orderStatus === "P") {
        if (json.errorKey) {
            Inditex.trackEvent( categoryEvent,accionEvent,Inditex.codeError(json.errorKey,json.errorMessage),true);
            showError(json.errorMessage);
        } else if (json.data.redirectTo) {
            redirectPaymentTo(json.data.redirectTo, json.data.redirectData,compraRapida);
        } else {
            Inditex.trackEvent( categoryEvent,accionEvent,Inditex.codeError("ITX_TEXT_INVALID_PAYMENT_DATA",ITX_TEXT_INVALID_PAYMENT_DATA),true);
            showError(ITX_TEXT_INVALID_PAYMENT_DATA);
        }
    } else if (json.data.orderStatus === "PQ") {
        if (iAsyncPaymentPollingCount < Inditex.iAsyncPaymentPollingTries) {
            fetchPaymentStatus(json.data.orderId);
        } else {
            redirectPaymentTo(json.data.redirectTo, json.data.redirectData,compraRapida);
        }
    } else {
        redirectPaymentTo(json.data.redirectTo, json.data.redirectData,compraRapida);
    }
};

function fetchPaymentStatus(orderId,compraRapida) {
    var accionEvent = "Autorizar_Pago_"+trackingGetTarjeta()+"_validacion_error";
    /*if (compraRapida) {
     accionEvent = "Autorizar_pago_error";		
     }*/
    iAsyncPaymentPollingCount++;

    setTimeout(function() {
        jQuery.xajax({
            "url": Inditex.generateUrl("ItxStandardOrderStatusCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "orderId": orderId
            },true),
            "type": "post",
            "dataType": 'json',
            "success": function(json, textStatus, jqXHR) {
                processPaymentStatus(json);
            },
            "error": function(xhr) {
                Inditex.trackEvent( categoryEvent,accionEvent,Inditex.codeError(xhr.status,xhr.statusText),true);
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
    }, Inditex.iAsyncPaymentPollingInterval);
};

function redirectPaymentTo(url, data, compraRapida) {

    if (data) {
        var e0, e1;

        e1 = jQuery("<form />", {
            "id": "secure3DForm",
            "method": "post",
            "action": url
        });

        for (var i in data) {
            e1.append(jQuery("<input />", {
                "type": "hidden",
                "name": i,
                "value": data[i]
            }));
        }

        e1.append(jQuery("<div />", {
            "class": "bot_sig",
            "style": "margin: 5px;"
        }).append(jQuery("<a />", {
            "href": "javascript:Inditex.writeCookie('WC_GAOrder','1');$('#secure3DForm').submit()",
            "html": ITX_TEXT_SECURE3D_BUTTON_CONTINUE
        })));

        e1.append(jQuery("<div />",{
            "style": "clear:both"
        }));


        e0 = jQuery("<div />");
        e2 = jQuery("<div />", {
            "class": "int"
        });

        e2.append(jQuery("<div/>", {
            "class": "gran",
            "html": ITX_TEXT_SECURE3D_TITLE
        }));
        e2.append(jQuery("<div />", {
            "class": "peq",
            "html": ITX_TEXT_SECURE3D_MESSAGE
        }));
        e2.append(jQuery("<div />", {
            "class": "peq",
            "html": ITX_TEXT_SECURE3D_MESSAGE2
        }));
        e2.append(e1);

        e0.append(e2);

        Inditex.popupHtml(
            e0,
            600,
            265,
            function() {
                if (Inditex) {
                    Inditex.trackPage('/Cesta_de_Compra/Tramitar_Pedido/Verificacion_Tarjeta');
                }
            }
        );
    } else {
        Inditex.writeCookie("WC_GAOrder","1");
        Inditex.getUserJSON(function(user){
            var accionEvent = "Autorizar_pago_ok";
            if ($('#ItxStandardOneClickPreviewCmd').length==0) {
                accionEvent = "Autorizar_Pago_"+trackingGetTarjeta()+"_validacion_ok";
            }
            Inditex.trackEvent( categoryEvent,accionEvent,null,{
                hitCallback: function(){
                    window.location = url;
                }
            })
        });
    }
};




function validacionesFormularios(){
    var self = this;

    //Definimos las validaciones de los formularios	



    $.validator.addMethod("checkLoguedInwalletUser", function(value, element) {

        if(validateInUser()){
            if($("#loguedInwalletUser").val()&&$("#loguedInwalletUser").val()!=""){
                return true;
            }
        }else{
            return true;
        }
        return false;
    }, Messages.selectInWalletCard);

    $.validator.addMethod("checkValidatedQR", function(value, element) {

        if($('#data-itx-bind-mobile-payment-qr-input').val()!=""&&IsValidQr($("#data-itx-bind-mobile-payment-qr-input").val())){
            if($('#qrCard').val()||$('#qrCard').val()!=""){
                return true;
            }
        }else{
            return true;
        }
        return false;
    });
    $.validator.addMethod("checkValidQR", function(value, element) {
        var regex =  /^[a-zA-Z0-9]{6,6}$/;
        return regex.test(value);

    }, Messages.errorQR);

    $.validator.addMethod("requiredChangeClassPersonalNumber", function(value, element) {

        if (value != null && value != "" && value.length==10) {
            $(element).parent().find("#personalNumberInfo").show();
            return true;
        } else {
            $(element).parent().find("#personalNumberInfo").hide();
            return false;
        }
    }, getMessage('validKlarnaPersonalNumber'));

    $.validator.addMethod("requiredChangeClassPersonalNumber2", function(value, element) {

        if (value != null && value != "" && value.length==10) {
            $(element).parent().find("#personalNumberInfo").show();
            return true;
        } else {
            $(element).parent().find("#personalNumberInfo").hide();
            return false;
        }
    }, getMessage('validKlarnaPersonalNumber'));

    $.validator.addMethod("requiredChangeClassPersonalNumber3", function(value, element) {

        if (value != null && value != "" && value.length==11) {
            $(element).parent().find("#personalNumberInfo").show();
            return true;
        } else {
            $(element).parent().find("#personalNumberInfo").hide();
            return false;
        }
    }, getMessage('validKlarnaPersonalNumber'));

    $.validator.addMethod("requiredChangeDateKlarna", function(value, element) {


        if (validDateKlarna(value)) {

            $(element).parent().find("#fechaInfo").show();
            return true;
        } else {
            $(element).parent().find("#fechaInfo").hide();
            return false;
        }
    }, getMessage('validKlarnaDateFormat'));

    $.validator.addMethod("requiredChangeDateKlarnaNL", function(value, element) {


        if (validDateKlarnaNL(value)) {

            $(element).parent().find("#fechaInfo").show();
            return true;
        } else {
            $(element).parent().find("#fechaInfo").hide();
            return false;
        }
    }, getMessage('validKlarnaDateFormat'));

    $('#datos_pago form').bind('submit' , function(){
        setTimeout(function(){
            $('#nifPay').next('p.error').css('float' , 'none')
        }, 200)

    })
    //$('#nifnie').next('p.error').css('float' , 'none')	
    rules = {};
    var validaciones = tiposPagoJSON.cards.length;
    for (var k = 0; k < validaciones; k++) {

        var card = tiposPagoJSON.cards[k];
        rules["cardNumber_"+k] = {
            required: true,
            creditcard2: function(){ return {cards: tiposPagoJSON.cards}; }
        }

        rules["cardMode_"+k] = {
            required: true
        }
        rules["cardNif_"+k] = {
            required: true
        }
        rules["cardCvv_"+k] = {
            required: true
        }
        rules["cardHolder_"+k] = {
            required: true
        }
        rules["phoneNumber_"+k]= {
            required: true
        }
        if (card != null) {
            if (card.type == "iDeal") {
                rules["bankName"]= {
                    required: true
                }
            }

            if (card.is_billing_address_mandatory == "1" && $("#isUserGuest").attr('value')=="true") {
                rules["direccionFact"]= {
                    required: true
                }
                rules["codigoPostal"]= {
                    "requiredChangeClass" : true
                }
                rules["localidad"]= {
                    required: true
                }
                rules["provincia"]= {
                    "itxSelect": true
                }
            }

            if(card.type!=null){
                if (card.type.toLowerCase()=='kinvoice' || card.type.toLowerCase()=='kinvoice') {
                    rules["kl_address1_"+k]= {
                        required: true
                    }
                    rules["kl_zipCode_"+k]= {
                        required: true,
                        "requiredChangeClass" : true
                    }
                    rules["kl_city_"+k]= {
                        required: true
                    }
                    rules["kl_state_"+k]= {
                        required: true
                    }
                }
            }
        }

        //Validation Klarna
        switch (storeCountryABBR) {

            case 'DK':
            case 'FI':
                rules["kbPNO_"+k] = {requiredChangeClassPersonalNumber: true};
                break;

            case 'NO':
                rules["kbPNO_"+k] = {requiredChangeClassPersonalNumber3: true};
                break;

            case 'SE':
                rules["kbPNO_"+k] = {requiredChangeClassPersonalNumber2: true};
                break;

            case 'AT':
            case 'DE':
                rules["kbPNO_"+k] = {requiredChangeDateKlarna: true};
                break;
            case 'NL':
                if (Inditex.iLangId == -1) {
                    rules["kbPNO_"+k] = {requiredChangeDateKlarnaNL: true};
                }
                else {
                    rules["kbPNO_"+k] = {requiredChangeDateKlarna: true};
                }
                break;
        }

        rules["kbGender_"+k] = {required: true};

    }
    rules["politica"] = "required";
    rules["nifPay"] = "required";
    if (iCountry == "MX") {
        rules["nifPay"] = {
            required: true,
            validateNifCif:  function(element){
                if  (isCompany){
                    return true;
                }else{
                    return false;
                }
            }
        }


    }
    rules["cardCvv_0"] = "required";

    rules["cardNumber_0"] = "required"

    rules["fechaCaducidad"]= {requiredChangeClassCaducidadDate: true};
    rules["walletCardName"]= {requiredChangeClassAlias: true};


    rules["klarnaConditions"] = {required: true};

    messages = {};
    for (var j = 0; j < validaciones; j++) {
        var card = tiposPagoJSON.cards[j];
        messages["cardNumber_"+j] = {
            required: Messages.required,
            creditcard2:Messages.tarjetaIncorrecta
        }
        messages["cardCvv_"+j] = {
            required: Messages.required
        }
        messages["cardMode_"+j] = {
            required: Messages.required
        }
        messages["cardNif_"+j] = {
            required: Messages.required
        }
        messages["cardHolder_"+j] = {
            required: Messages.required
        }
        messages["phoneNumber_"+j]= {
            required: Messages.required
        }
        messages["walletCardName"]= {
            required: Messages.required
        }

        if (card != null) {
            if (card.type == "iDeal") {
                messages["bankName"]= {
                    required:  Messages.requiredBankIdeal
                }
            }


            if (card.is_billing_address_mandatory == "1" && $("#isUserGuest").attr('value')=="true") {
                messages["direccionFact"]= {
                    required: Messages.required
                }
                messages["codigoPostal"]= {
                    "requiredChangeClass" : eval('Messages.zipCode_' + Inditex.iStoreJSON.countryCode)
                }
                messages["localidad"]= {
                    required: Messages.required
                }
                messages["provincia"]= {
                    "itxSelect":  Messages.state
                }
                //$('#provincia').attr('title',  Messages.state);
            }

            //if(card.type!=null){
            //if (card.type.toLowerCase()=='kinvoice' || card.type.toLowerCase()=='kinvoice') {
            messages["kl_address1_"+j]= {
                required: Messages.enterAddress
            }
            messages["kl_zipCode_"+j]= {
                required: Messages.enterZipCode,
                required: Messages.enterZipCode,
                "requiredChangeClass" : eval('Messages.zipCode_' + Inditex.iStoreJSON.countryCode)
            }
            messages["kl_city_"+j]= {
                required: Messages.enterCity
            }
            messages["kl_state_"+j]= {
                required: Messages.ItxMyAccountOrderReturnAddressView_validate_inpprovi
            }
            //$('#provincia').attr('title',  Messages.state);
            //}
            //}
        }

        //Klarna messages
        switch (storeCountryABBR) {

            case 'DK':
            case 'NO':
            case 'FI':
                messages["kbPNO_"+j] = getMessage('validKlarnaPersonalNumber');
                break;

            case 'SE':
                messages["kbPNO_"+j] = getMessage('validKlarnaPersonalNumber');
                break;

            case 'AT':
            case 'DE':
            case 'NL':
                messages["kbPNO_"+j] = getMessage('validKlarnaDateFormat');
                break;
        }

        messages["kbGender_"+j] = Messages.sexo;
    }
    messages ["politica"] = Messages.politicaPrivacidad;
    messages ["fechaCaducidad"] = Messages.fechaCaducidadMayor;
    messages ["nifPay"] = Messages.required;
    messages ["data-itx-bind-mobile-payment-qr-input"] = Messages.rellenarCampo;

    messages ["data-itx-bind-mobile-payment-qr-input"] = {
        required : Messages.rellenarCampo,
        checkValidQR : Messages.errorQR
    };
    messages ["in_user"] = {
        required : Messages.rellenarCampo
    };
    messages ["in_pass"] = {
        required : Messages.rellenarCampo
    };
    messages ["loguedInwalletUser"] = Messages.selectInWalletCard;

    messages["cardHash_0"] = {
        required: Messages.selectInWalletCard
    };
    if (iCountry == "MX") {
        messages["nifPay"] = {
            required:Messages.required,
            validateNifCif:Messages.nifIncorrectoMX
        }


    }


    messages["klarnaConditions"] = Messages.mustAcceptTermsConditions;

    //$("#form1").rules("remove");
    $('#form1').validate({
        submitHandler: function(form) {

            var j = 0;

            while ($('#cardType_'+j).length >0 ){

                var textTypePayment =$('#cardType_'+j).val();
                if ((textTypePayment.toUpperCase()==tiposPagoJSON.constants.visacs.toUpperCase())
                    || (textTypePayment.toUpperCase()==tiposPagoJSON.constants.mastercardcs.toUpperCase())
                    || (textTypePayment.toUpperCase()==tiposPagoJSON.constants.amexcs.toUpperCase())
                    || (textTypePayment.toUpperCase()==tiposPagoJSON.constants.discovercs.toUpperCase())
                    || (textTypePayment.toUpperCase()==tiposPagoJSON.constants.dinersclubcs.toUpperCase())
                    || (textTypePayment.toUpperCase()==tiposPagoJSON.constants.jcbcs.toUpperCase()) ) {

                    if (tiposPagoJSON.billingAddress.address1.length > 35) {
                        //event.stop();
                        Inditex.trackEvent( categoryEvent, 'Autorizar_Pago_'+trackingGetTarjeta()+'_datos_error',Inditex.codeError('addressLong',Messages.addressLong),true);
                        var mesg = Messages.addressLong + "(" + Messages.dirFacturacion + ")";
                        openStaticModal(errorPayment.title , mesg, false);
                        return;
                    }

                }

                j++;
            }


            var numCard = tiposPagoJSON.cards.length;
            var card = tiposPagoJSON.cards[numCard -1];

            Inditex.trackEvent( categoryEvent, 'Autorizar_Pago_'+trackingGetTarjeta()+'_datos_ok',null,true);
            if (card.is_billing_address_mandatory == "1" && $("#isUserGuest").attr('value')=="true") {
                //TODO: ES un parche porque en el metodo de envio se tendria que 
                //TODO: refrescar el JSON con el address.
                var uJson = Inditex._readUserJSON();
                uJson.timestamp = 0;
                Inditex._writeUserJSON(uJson);
                Inditex.getUserJSON(function (uJson) {
                    Inditex.getUserAddressJSON({
                        "addressId": uJson.primaryAddressId,
                        "forceCommerce":1,
                        "onSuccess": function(address) {
                            var nif = "";
                            if(address.isCompany) {
                                if(address.company != null) {
                                    nif = address.company.vatin;
                                }
                            } else {
                                nif = address.vatin;
                            }

                            var urlParams = {
                                "storeId"					: Inditex.iStoreId,
                                "languageId"				: Inditex.iLangId,
                                "addressId"					: uJson.primaryAddressId,
                                "memberId"					: uJson.identity.userId,
                                "firstName"					: address.firstName,
                                "middleName"				: address.middleName,
                                "lastName"					: address.lastName,
                                "birthDate"					: address.birthdate,
                                "isCompany"					: address.isCompany,
                                "addressLine_0"				: $('#direccionFact').val(),
                                "countryCode"				: address.countryCode,
                                "phoneCountryCode_0"		: address.phones[0].countryCode,
                                "phoneSubscriberNumber_0"	: address.phones[0].subscriberNumber,
                                "stateCode"					:  $('#provincia').val(),
                                "city"						:  $('#localidad').val(),
                                "zipCode"					:  $('#codigoPostal').val(),
                                "email"					    : address.email,
                                "viewname"					: "ItxStandardJSON",
                                "errorViewName"				: "ItxStandardJSON",
                                "isFullAddress"				: "true",
                                "vatin"						: nif

                            }

                            if (iCountry == "MX") {
                                urlParams["municipality"] =	address.municipality;
                                urlParams["colony"] =	address.colony;
                            }

                            var url = Inditex.generateUrl('ItxStandardUpdateAddressCmd', urlParams, true);

                            Inditex.orderManage({
                                "url": url,
                                "method": "post",
                                "onSuccess": function(aText) {
                                    var aJsonResponse = Inditex.evalJSON(aText);
                                    $("#address_id").val(aJsonResponse.data.addressId);
                                    if (Inditex)
                                        Inditex.trackPage("/Cesta_de_Compra/Tramitar_Pedido/Validacion");
                                    openModalTramitar(null,null,200,null);

                                    submitAsyncPayment(form);
                                }
                            });
                        }
                    });
                });
            } else {
                if (Inditex)
                    Inditex.trackPage("/Cesta_de_Compra/Tramitar_Pedido/Validacion");
                openModalTramitar(null,null,200,null);

                submitAsyncPayment(form);
            }

        },
        invalidHandler: function(event, validator) {
            if (Inditex) {
                validator.invalidElements().each(function(){
                    if ($(this).val() == '') {
                        Inditex.trackEvent('/Tramitacion_Pago', 'formulario','campo_' + ($(this).attr('name') +'_vacio'));
                        Inditex.trackEvent( categoryEvent, 'Autorizar_Pago_'+trackingGetTarjeta()+'_datos_error',Inditex.codeError('campo_' + ($(this).attr('name') +'_vacio'),'campo_' + ($(this).attr('name') +'_vacio')),true);
                    } else {
                        Inditex.trackEvent('/Tramitacion_Pago', 'formulario','campo_' + ($(this).attr('name') +'_error'));
                        Inditex.trackEvent( categoryEvent, 'Autorizar_Pago_'+trackingGetTarjeta()+'_datos_error',Inditex.codeError('campo_' + ($(this).attr('name') +'_error'),'campo_' + ($(this).attr('name') +'_error')),true);
                    }
                });
                /*validator.validElements().each(function(){
                 Inditex.trackEvent('/Tramitacion_Pago', 'formulario','campo_' + ($(this).attr('name') +'_relleno'));
                 })*/
                var errors = validator.numberOfInvalids();
            }
        },
        errorPlacement : function(error, element) {
            if($(element).prop("id") === "qrCard") {
                openStaticModal(Messages.inWalletTitle, Messages.validateQRError);
            }else if($(element).parent().parent().prop("id")==="inWallet_payments"){
                error.insertAfter($("#inWallet_payments"));
                error.css('margin-top', '10px');
                error.css('margin-bottom', '5px');
            }
            else {
                error.insertAfter(element); // default error placement.
            }
        },
        ignoreTitle: true,
        focusCleanup: true,
        focusInvalid: false,
        rules:rules,
        messages:messages
    });


}


/*****************************************************************************************
 * Operaciones para TR *
 *****************************************************************************************/

function cantidadEnTarjetasRegalo (json) {
    var cantidad = 0;
    for (var i = 0; i < json.cards.length; i++) {
        if(json.cards[i].balance!=undefined && json.cards[i].balance!=null && json.cards[i].balance!=""){
            cantidad+=parseFloat(json.cards[i].balance);
        }
    }
    return cantidad;
}



function tarjetaYaUsada (data) {
    var json = tiposPagoJSON;
    for (var x=0;x<json.cards.length;x++) {
        if (json.cards[x].type==json.constants.giftcard && json.cards[x].number == data.cardNumber) {
            return true;
        }
    }
    return false;
}



function pintarErrorTR (campo,error){
    var indice = tiposPagoJSON.cards.length-1;
    var cardCampo = $("#"+campo+"_"+indice);
    $('#custom_error_'+campo+indice).hide();
    $('<p />' , {
        'text' : error,
        'class' : 'error',
        'id' : 'custom_error_'+campo+indice
    }).insertAfter(cardCampo);
    cardCampo.bind('keydown', function(){
        $('#custom_error_'+campo+indice).hide();
        $(this).unbind();
    })
}

function get_balance(index){

    var valido = true;
    var cardNumberValue = $("#cardNumber_"+index).val();
    var cardNumber = $("#cardNumber_"+index);
    var cardCvv = $("#cardCvv_"+index);
    var cardCvvValue = $("#cardCvv_"+index).val();
    var ct = $("#ct_"+index);
    var ctValue = $("#ct_"+index).val();
    var url = $("#iGiftCardTestJSONURL").attr("value").replace("_cardNumber_", cardNumberValue).replace("_cardCvv_", cardCvvValue);

    $('#additional_method').hide();

    // validamos que los campos est?n rellenos
    if (cardNumberValue == "" ){
        pintarErrorTR ("cardNumber",Messages.required);
        valido = false;
    } else {

    }
    if (cardCvvValue == "" ){
        pintarErrorTR ("cardCvv",Messages.required);
        valido = false;
    } else {

    }
    if (ctValue == "" ){
        pintarErrorTR ("ct",Messages.required);
        valido = false;
    } else {

    }
    if (valido){

        if ($.inArray(cardNumberValue, self.numGiftCardAppend) == -1){

            if (self.numGiftCardAppend.length < $('#maxTarjetasRegaloHidden').attr('value')) {

                var options = {};
                options.captcha = ctValue;
                options.orderId = tiposPagoJSON.orderId;

                options.cards = [];

                for (var i = 0; i < self.paymentMethodsArray.length; i++) {
                    options.cards.push({
                        "cardType": "GiftCard",
                        "cardKind": "gift_card",
                        "cardNumber": self.paymentMethodsArray[i].cardNumber,
                        "cardCvv": self.paymentMethodsArray[i].cardCvv,
                        "cardBalance": self.paymentMethodsArray[i].cardBalance,
                        "cardVariant": self.paymentMethodsArray[i].cardVariant
                    });
                }

                options.cards.push({
                    "cardType": "GiftCard",
                    "cardKind": "gift_card",
                    "cardNumber": cardNumberValue,
                    "cardCvv": cardCvvValue,
                    "cardBalance": 0
                });

                options.onSuccess = function(aJson) {
                    var captchaPath = $('#captchaImg').attr('src');
                    if(captchaPath){
                        var splitCaptchaPath = captchaPath.split('&');
                        if(splitCaptchaPath){
                            $('#captchaImg').attr('src',captchaPath+'&t='+Inditex.iBuildVersion);
                        }
                    }

                    if (aJson.errorKey) {
                        showError(aJson.errorMessage);
                    } else {
                        self.numGiftCardAppend.push(cardNumberValue);
                        self.paymentMethodsArray.push({
                            "cardType": "GiftCard",
                            "cardKind": "gift_card",
                            "cardNumber": cardNumberValue,
                            "cardCvv": cardCvvValue
                        });

                        if(shopCartJSON.isNexusOrder=="1" && shopCartJSON.isStoreTaxesIncluded == "0"){
                            var url= Inditex.generateUrl("ShopCartJSON", {
                                "storeId": Inditex.iStoreId,
                                "langId": Inditex.iLangId,
                                "catalogId": Inditex.iCatalogId
                            },true);

                            Inditex.request({
                                "url": url,
                                "method": "get",
                                "onSuccess": function(text) {
                                    var aJsonResponse = Inditex.evalJSON(text);
                                    shopCartJSON = aJsonResponse;
                                    load_detalleCesta(shopCartJSON);
                                    draw_detail_gift_card(aJson.data.adjustments,index,$.trim(cardNumberValue));
                                },
                                "onFailure": function(text) {
                                    showError(ITX_TEXT_GENERIC_PROBLEM);
                                }
                            });

                        }else{
                            draw_detail_gift_card(aJson.data.adjustments,index,$.trim(cardNumberValue));
                        }
                    }
                };

                options.onFailure = function(aStatus) {
                    var captchaPath = $('#captchaImg').attr('src');
                    if(captchaPath){
                        var splitCaptchaPath = captchaPath.split('&');
                        if(splitCaptchaPath){
                            $('#captchaImg').attr('src',captchaPath+'&t='+Inditex.iBuildVersion);
                        }
                    }

                    showError(ITX_TEXT_GENERIC_PROBLEM);

                };

                Inditex.getRestOrderCardAdjustmentsJSON(options);
            }
            else{
                openStaticModal(Messages.giftCardError, Messages.giftCardMaxExceeded, false);
            }
        }

        else{
            openStaticModal(Messages.giftCardError, Messages.giftCardExistError, false);
        }
    }
}

function draw_detail_gift_card(data,index,cardNumberValue){

    $("#buttonSubmit").attr("onclick","separarFecha();enviarFormulario();");
    if(storeCountryABBR == 'DE')
        $("#buttonSubmit").text(Inditex.msg('compraDE'));
    else
        $("#buttonSubmit").text(Inditex.msg('compra'));

    $('#captchaRow_'+index).remove();
    $('#captchaRow_ct_'+index).remove();

    for (var j = 0; j < data.length; j++) {
        if (data[j].cardNumber==cardNumberValue) {
            tiposPagoJSON.cards[index].balance = data[j].cardAmount;
            tiposPagoJSON.cards[index].number = data[j].cardNumber;
            tiposPagoJSON.cards[index].cvv = data[j].cardCvv;
            tiposPagoJSON.cards[index].type = "GiftCard";
            self.paymentMethodsArray[index].cardBalance=data[j].cardAmount;
            self.paymentMethodsArray[index].cardVariant=data[j].cardVariant;
            self.paymentMethodsArray[index].type="GiftCard";
            self.paymentMethodsArray[index].saldoGifCard=data[j].cardBalance;

            $('#cardAmount_'+index).attr ('value',data[j].cardAmount);
            $('#cardVariant_'+index).attr ('value',data[j].cardVariant);
            $('#cardBalance_'+index).attr ('value',data[j].cardBalance);
        }
    }

    var totalBalance = 0;
    for (var i = 0; i < tiposPagoJSON.cards.length; i++) {
        if (tiposPagoJSON.cards[i].balance != undefined)
            totalBalance += parseFloat(formatPriceGiftCard(tiposPagoJSON.cards[i].balance));
    }
    var diferenciaPorPagar = parseFloat(shopCartJSON.totalPrice)-parseFloat(totalBalance);
    if (totalBalance < shopCartJSON.totalPrice) {
        if (index == 0 ) {

            if(self.paymentMethodsArray[index].cardVariant == "EmployeeCard"){
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].balance),decimals,moneda));
            }
            else{
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].saldoGifCard),decimals,moneda));
            }

            $('#remain_block').show();
            $('#remain_to_pay').html(formatCurPrice(diferenciaPorPagar,decimals,moneda));
            $('#additional_method').show();
            load_additional_paymentMethods(tiposPagoJSON);
            $('.but_arrow').toggle();
            $('#card_data').fadeIn();
        }
        else {
            if(self.paymentMethodsArray[index].cardVariant == "EmployeeCard"){
                $('#payment_methods_add_'+index).find('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].balance),decimals,moneda));
            }
            else{
                $('#payment_methods_add_'+index).find('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].saldoGifCard),decimals,moneda));
            }


            $('#payment_methods_add_'+index).find('#remain_block').show();
            $('#payment_methods_add_'+index).find('#remain_to_pay').html( formatCurPrice(diferenciaPorPagar,decimals,moneda));
            $('#payment_methods_add_'+index).find('#additional_method').show();
            $('#payment_methods_add_'+index).find('.but_arrow').toggle();
            $('#payment_methods_add_'+index).find('#card_data').fadeIn();
            load_additional_paymentMethods(tiposPagoJSON);
        }
    } else {
        if (index == 0 ) {

            if(self.paymentMethodsArray[index].cardVariant == "EmployeeCard"){
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].balance),decimals,moneda));
            }
            else{
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].saldoGifCard),decimals,moneda));
            }
            $('#card_data').fadeIn();
        }
        else {
            if(self.paymentMethodsArray[index].cardVariant == "EmployeeCard"){
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].balance),decimals,moneda));
            }
            else{
                $('#card_balance').html(formatCurPrice(formatPriceGiftCard(self.paymentMethodsArray[index].saldoGifCard),decimals,moneda));
            }
            $('#payment_methods_add_'+index).find('#card_data').fadeIn();
        }
    }

    //Actualizamos descuentos y precios restantes si hay tarjeta de empleado
    var employeeCard=false;
    var totalEmployeeDiscount = 0;

    //Vemos si hay alguna tarjeta Empleado
    for (j = 0; j < data.length; j++) {
        if (data[j].cardVariant=="EmployeeCard") {
            employeeCard=true;
            totalEmployeeDiscount+=data[j].cardAmount;
        }
    }

    //actualizamos saldos en la variable tiposPagoJSON
    for (j = 0; j < data.length; j++) {
        for (i = 0; i < tiposPagoJSON.cards.length; i++) {
            if (tiposPagoJSON.cards[i].number==data[j].cardNumber) {
                tiposPagoJSON.cards[i].balance=data[j].cardAmount;
                $('#cardAmount_'+i).attr ('value',data[j].cardAmount);
                $('#cardVariant_'+i).attr ('value',data[j].cardVariant);
                $('#cardBalance_'+i).attr ('value',data[j].cardBalance);
            }
        }
    }

    //Si hay tarjeta Empleado
    if (employeeCard) {

        //actualizamos saldos y precios restantes en la pantalla
        for (j = 0; j < data.length; j++) {
            for (i = 0; i < tiposPagoJSON.cards.length; i++) {
                if (tiposPagoJSON.cards[i].number==data[j].cardNumber) {

                    totalBalance=0;
                    for (h = 0; h <= i; h++) {
                        if (tiposPagoJSON.cards[h].balance != undefined)
                            totalBalance += parseFloat(formatPriceGiftCard(tiposPagoJSON.cards[h].balance));
                    }

                    diferenciaPorPagar = parseFloat(shopCartJSON.totalPrice)-parseFloat(totalBalance);

                    if (i==0) {

                        if (data[j].cardVariant=="EmployeeCard") {
                            //$('label:first').html(Messages.numeroTE);
                            $('#card_data:first').find('div:first-child').html('<div>'+Messages.descuentoTE+'</div>');

                            //if ($('#tarjetaEmpleado').length) {
                            //	$("#tarjetaEmpleado").remove ();
                            //}

                            //$("#cuerpoTabla").append("<tr id='tarjetaEmpleado' class='noborde'><td class='right' colspan='5'><p><span>Tarjeta Empleado</span></p></td><td class='right'><p><strong id='shippingPrice'>-"+formatCurPrice(data[j].cardAmount,decimals,moneda)+"</strong></p></td></tr>");
                            //var totalPriceUpdated=parseFloat(shopCartJSON.totalPrice)-parseFloat(data[j].cardAmount);
                            //$("#totalPrice").html(formatCurPrice(totalPriceUpdated,decimals,moneda));

                            $('#card_balance:first').html(formatCurPrice(formatPriceGiftCard(data[j].cardAmount),decimals,moneda));
                        }
                        else{
                            $('#card_balance:first').html(formatCurPrice(formatPriceGiftCard(data[j].cardBalance),decimals,moneda));
                        }


                        $('#remain_to_pay:first').html(formatCurPrice(diferenciaPorPagar,decimals,moneda));
                    }
                    else{

                        if (data[j].cardVariant=="EmployeeCard") {
                            //$('#payment_methods_add_'+i).find('label:first').html(Messages.numeroTE);
                            $('#payment_methods_add_'+i).find('#card_data').find('div:first-child').html('<div>'+Messages.descuentoTE+'</div>');

                            //if ($('#tarjetaEmpleado').length) {
                            //	$("#tarjetaEmpleado").remove ();
                            //}

                            //$("#cuerpoTabla").append("<tr id='tarjetaEmpleado' class='noborde'><td class='right' colspan='5'><p><span>Tarjeta Empleado</span></p></td><td class='right'><p><strong id='shippingPrice'>-"+formatCurPrice(data[j].cardAmount,decimals,moneda)+"</strong></p></td></tr>");
                            //var totalPriceUpdated=parseFloat(shopCartJSON.totalPrice)-parseFloat(data[j].cardAmount);
                            //$("#totalPrice").html(formatCurPrice(totalPriceUpdated,decimals,moneda));

                            $('#payment_methods_add_'+i).find('#card_balance').html(formatCurPrice(formatPriceGiftCard(data[j].cardAmount),decimals,moneda));
                        }
                        else{
                            $('#payment_methods_add_'+i).find('#card_balance').html(formatCurPrice(formatPriceGiftCard(data[j].cardBalance),decimals,moneda));
                        }


                        $('#payment_methods_add_'+i).find('#remain_to_pay').html( formatCurPrice(diferenciaPorPagar,decimals,moneda));
                    }

                }
            }
        }


        //Actualizamos el total
        $("#tarjetaEmpleado").remove();
        $("#cuerpoTabla").append("<tr id='tarjetaEmpleado' class='noborde'><td class='right' colspan='5'><p><span>"+Messages.descuentoTE+"</span></p></td><td class='right'><p><strong id='shippingPrice'>-"+formatCurPrice(formatPriceGiftCard(totalEmployeeDiscount),decimals,moneda)+"</strong></p></td></tr>");
        var totalPriceUpdated=parseFloat(shopCartJSON.totalPrice)-parseFloat(formatPriceGiftCard(totalEmployeeDiscount));
        $("#totalPrice").html(formatCurPrice(totalPriceUpdated,decimals,moneda));
    }


}


function get_additional_methods(){
    $('.but_arrow').toggle();
    var indice = tiposPagoJSON.cards.length-1;
    validacionesFormularios();
    $('#payment_methods_add_'+indice).slideToggle();
    if ($($('.but_arrow')[0]).css('display')){
        $('#cardType_'+indice).remove();
    }
}



function load_additional_paymentMethods(data) {

    index = data.cards.length;
    var indice_actual = index;
    var indice_anterior = indice_actual-1;
    var paymentMethodDefault = "VISA";

    var divPaymentMethods = '<div class="row" id="payment_methods_add_'+indice_actual+'" style="display:none" ><ul id="list_pagos_add"></ul><div id="datos_pago_add"></div></div>';
    $(".opt_check").after(divPaymentMethods);

    //numeroTarjetasUsadas++;
    detalle = data;
    var contenido='';
    var formulario='';
    var submit = '';
    for(i=0;i<detalle.payments.length;i++){

        if (detalle.payments[i].paymentId != "KINVOICE" && detalle.payments[i].paymentId != "KACCOUNT") {

            paymentId = detalle.payments[i].paymentId+'_'+index;
            //Metodos de pago
            contenido += '<li>'+
                '<img onmouseover="showPaymentActive(this);" onmouseleave="showPaymentDisabled(this);" indice="'+indice_actual+'" class="imagePayment add" on="' + detalle.payments[i].paymentIdImageSrcOn + '" off="' + detalle.payments[i].paymentIdImageSrcOff + '" id="' + paymentId+'" onclick="changePaymentMethodAdd(this,'+indice_actual+');" src="' + detalle.payments[i].paymentIdImageSrcOff + '"/>'+
                '<input style="display:none;" class="radio converted" type="radio" id="radio_' + paymentId + '" name="metodoPago"/>'
            '</li>';

            paymentId_add = detalle.payments[i].paymentId;
        }
        else {

            paymentId = detalle.payments[i].paymentId+'_'+index;

            //tratamiento imagen ON
            var tokens = detalle.payments[i].paymentIdImageSrcOn.split ("/");
            imagenOn = tokens[tokens.length-1];
            imagenOn = imagenOn.split (".");
            imagenOn = imagenOn[0]+ "_" + storeCountryABBR + "." + imagenOn[1];
            var on="";
            for (var w=0; w < tokens.length; w++) {
                if (w<tokens.length-1)
                    on = on + tokens [w] + "/";
                else
                    on = on + imagenOn;
            }
            //tratamiento imagen OFF
            tokens = detalle.payments[i].paymentIdImageSrcOff.split ("/");
            imagenOff = tokens[tokens.length-1];
            imagenOff = imagenOff.split (".");
            imagenOff = imagenOff[0]+ "_" + storeCountryABBR + "." + imagenOff[1];
            var off="";
            for (var z=0; z < tokens.length; z++) {
                if (z<tokens.length-1)
                    off = off + tokens [z] + "/" ;
                else
                    off = off + imagenOff;
            }

            //Metodos de pago
            contenido += '<li>'+
                '<img onmouseover="showPaymentActive(this);" onmouseleave="showPaymentDisabled(this);" indice="'+indice_actual+'" class="imagePayment add" on="' + on + '" off="' + off + '" id="' + paymentId+'" onclick="changePaymentMethodAdd(this,'+indice_actual+');" src="' + off + '"/>'+
                '<input style="display:none;" class="radio converted" type="radio" id="radio_' + paymentId + '" name="metodoPago"/>'
            '</li>';

            paymentId_add = detalle.payments[i].paymentId;
        }

    }
    // seleccionamos Visa por defecto
    // formulario visa por defecto
    tiposPagoJSON.cards.push({
        "type": paymentMethodDefault
    });
    formulario += formularioNotAffinity(paymentMethodDefault,index);

    $("#payment_methods_add_"+indice_actual).find("#list_pagos_add").html(contenido);
    $("#payment_methods_add_"+indice_actual).find("#datos_pago_add").html(formulario);

    var top = 1300*indice_actual;
    $('footer').css('top' , top)
    $("#payment_methods_add_"+indice_actual).find('#list_pagos_add li:eq(0) img').each(function(){
        srcImage = $(this).attr('on');
        $(this).attr('src',srcImage);
        $("#radio_"+id).click();
        $(this).parent().css('border-color','black');
    })
    if ( index>1 ) {
        $("#payment_methods_add_"+indice_actual)
            .css({
                'padding' : '6px 8px',
                'width' : '96%',
                'border' : 'solid 1px #444'
            })
            .insertAfter('#payment_methods_add_'+indice_anterior).fadeIn();
    } else {
        $("#payment_methods_add_"+indice_actual)
            .css({
                'padding' : '6px 8px',
                'width' : '96%',
                'border' : 'solid 1px #444'
            })
            .insertAfter('#additional_method').fadeIn();
    }


    //Bindeamos el borrado de la fecha
    $("[name^=fechaCaducidad]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    })

    $("[name^=walletCardName]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    });

    jQuery(window).bind('resize', function(){
        fitFooterBottomTunel($('#tunel'));
    });
    var checkPolitica = $('#liCheckPoliticaEmpleado');
    if(checkPolitica){
        checkPolitica.empty()
        checkPolitica.append(getPoliticaPrivacidad(paymentMethodDefault));
        loadRadiosAndChecks();
    }
    validacionesFormularios();
    //Se le pasa el valor visa porque por defecto se selecciona visa
    privacyPolicyControllerView(paymentMethodDefault);

}



function changePaymentMethodAdd(element, index){

    var klarna=false;

    id=$(element).attr('id');
    //$("#explanationCWV2").hide();
    $('#discountAffinity').css('display','none');
    $(".imagePayment.add").each(function(){
        if($(this).attr('id') != id){
            srcImage = $(this).attr('off');
            $(this).attr('src',srcImage);
            $(this).parent().css('border-color','transparent');
        }
        else{
            srcImage = $(this).attr('on');
            $(this).attr('src',srcImage);
            $("#radio_"+id).click();
            $(this).parent().css('border-color','black');
        }
    });
    // Pintamos formulario seleccionado
    var formulario ="";
    var submit = '';
    var paymentId_Num = element.id.split('_');
    var paymentId = paymentId_Num[0];
    var indice = tiposPagoJSON.cards.length -1 ;
    // si existe alguno ya,lo eliminamos y creamos el nuevo
    if ($('#payment_methods_add_'+indice).find('#paymentpanel')[0] != undefined){
        $('#payment_methods_add_'+indice).find('#paymentpanel').remove();
    }
    var selectedMethod= getPaymentMethodById(paymentId);
    if(selectedMethod.kind=='credit_card_installments'){
        formulario +=formularioCreditCardInstallments(paymentId, indice);
    }else if(selectedMethod.kind=='safetypay'){
        formulario +=formularioSafetyPay(paymentId, indice);
    }else if(paymentId.toLowerCase() == 'mobile'){
        formulario +=formularioinWalletMobile(paymentId, indice);
    }else if(paymentId.toLowerCase() == 'inwallet'){
        formulario +=formularioinWallet(paymentId, indice);
    }else if(paymentId.toLowerCase() != 'affinityes' && paymentId.toLowerCase() != 'affinity'){
        if (paymentId.toLowerCase() != 'paypales' && paymentId.toLowerCase() != 'paypal' && paymentId.toLowerCase() != 'giftcard' && paymentId.toLowerCase() != 'qiwi'
            && paymentId.toLowerCase() != 'cod' && paymentId.toLowerCase() != 'ideal' && paymentId.toLowerCase() != 'p24' && paymentId.toLowerCase() != 'discount'
            && paymentId.toLowerCase() != 'kinvoice' && paymentId.toLowerCase() != 'kaccount'){
            formulario += formularioNotAffinity(paymentId, indice);
        } else {
            if(paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount'){
                formulario += formularioTR(paymentId, indice);
            } else {
                if(paymentId.toLowerCase() == 'paypal'){
                    formulario += formularioPayPal(paymentId,indice);
                } else {
                    if(paymentId.toLowerCase() == 'ideal'){
                        formulario += formularioiDeal(paymentId,indice);
                    } else {
                        if(paymentId.toLowerCase() == 'kinvoice'){
                            formulario += formularioKlarnaInvoice(paymentId,indice);
                            klarna=true;
                        } else {
                            if(paymentId.toLowerCase() == 'kaccount'){
                                formulario += formularioKlarnaAccount(paymentId,indice);
                                klarna=true;
                            } else {
                                formulario += formularioP24(paymentId,indice);
                            }
                        }
                    }
                }
            }
        }
    }
    //Affinity
    else{
        formulario += formularioAffinity(paymentId,indice);
    }
    //Submits
    if (paymentId.toLowerCase() == 'paypales' || paymentId.toLowerCase() == 'paypal' || paymentId.toLowerCase() == 'qiwi')//qiwi
        submit += '<a style="display:block;" id="buttonSubmit" onclick="enviarFormulario()" href="javascript:void(0)">'+ Inditex.msg('autorizarCompra') +'</a>';
    else if (storeCountryABBR == 'DE' && (paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount'))
        submit += '<a style="display:block;" id="buttonSubmit" onclick="get_balance('+index+');" href="javascript:void(0)">'+ Inditex.msg('compraDE') +'</a>';
    else if (storeCountryABBR == 'DE')
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compraDE') +'</a>';
    else if(paymentId.toLowerCase() == 'giftcard' || paymentId.toLowerCase() == 'discount')
        submit += '<a style="display:block;" id="buttonSubmit" onclick="get_balance('+index+');" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';
    else
        submit += '<a style="display:block;" id="buttonSubmit" onclick="separarFecha();enviarFormulario();" href="javascript:void(0)">'+ Inditex.msg('compra') +'</a>';

    $('#payment_methods_add_'+indice).find("#datos_pago_add").html(formulario);
    $("#comprar").html(submit);

    if (klarna) {

        loadKlarnaParameters(loadKlarna);
    }

    if(paymentId.toLowerCase() == 'mobile'){
        $('#data-itx-bind-mobile-payment-qr-submit').click(function(event){
            validateQR(event);
        });
        Inditex.bindMobilePayment({
            "orderId":tiposPagoJSON.orderId,
            "showWaitView":function(){
                openStaticModal(Messages.inWalletTitle, Messages.inWalletMobileWaitingConfirmation+"<br /><br /><button id='cancel_inwallet' class='acc_butt'>"+Messages.inWalletCancel+"</button>");
                $("#s_overlay").addClass("loading");

                $('#cancel_inwallet').bind('click', function() {
                    closeModal(this);
                    return;
                });

            },
            "showErrorQRView":function(){
                closeModal('#cancel_inwallet');
                var validator = $( "#form1" ).validate();
                validator.showErrors({
                    "data-itx-bind-mobile-payment-qr-input":Messages.errorQR
                });
            },
            "showErrorView":function(aJson){
                closeModal('#cancel_inwallet');
                openStaticModal(Messages.errorTitle, Messages.errorRecoverInWalletCards);
            },
            "showCardView":function(aJson){
                closeModal('#cancel_inwallet');
                var alias=aJson.walletQRCards[0].alias;
                var printablePan=aJson.walletQRCards[0].printablePan;
                var paymentCodeName=aJson.walletQRCards[0].paymentCodeName;
                var cardHash=aJson.walletQRCards[0].hash;
                $("#cardHash_0").val(cardHash);
                $("#qrCard").val(cardHash);
                closeModal('#cancel_inwallet');
                $("#qr_content").html("<p><b>"+Messages.selectedCard+"</b><br /><br />"+Messages.cardAlias+"<br />"+alias+"<br /><br />"+Messages.cardNumber+"<br />"+paymentCodeName+": "+printablePan+"</p>");
            }
        });
    }
    var checkPolitica = $('#liCheckPoliticaEmpleado');
    if(checkPolitica){
        checkPolitica.empty()
        checkPolitica.append(getPoliticaPrivacidad(paymentId));
        loadRadiosAndChecks();
    }

    privacyPolicyControllerView(paymentId);

    //Bindeamos el borrado de la fecha
    $('#payment_methods_add_'+indice).find("[name^=fechaCaducidad]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    });
    $('#payment_methods_add_'+indice).find("[name^=walletCardName]").each(function(){
        removeValueFromFieldOnClickByName($(this).attr("id"));
    });

    tiposPagoJSON.cards.push({
        "type": paymentId
    });
    loadRadiosAndChecks();


    var index =element.attributes.getNamedItem('indice').nodeValue;
    var method = element.id;
    tiposPagoJSON.cards.splice(index, tiposPagoJSON.cards.length);
    tiposPagoJSON.cards.push({
        "type": method
    });



    validacionesFormularios();

    if (tiposPagoJSON.cards[index].type.indexOf(tiposPagoJSON.constants.giftcard) != -1 ){
        numeroTRUsadas++;
    }
    $('#captchaImg').attr('src',$('#captchaURL').attr('value')+"&t="+new Date().getTime());
}

function errorNoPagableConTr() {
    openStaticModal(Messages.aviso, Messages.ItxOrderPaymentGiftCard_validation_noPagableConTr, false);
}

function facturaRequerida(){
    if( $("#factura").length){
        if( $("#factura").is(':checked')){
            return true;
        }else{
            return false;
        }
    }else{
        return true;
    }
}


function walletZone(){
    /*var urlCondicionesCompraWallet = $("#iCondicionesWalletURL").attr("value");
     var zonaWallet;

     zonaWallet= '<div class="row">'+ 
     '<div style="float:left;display:inline">';

     zonaWallet+='<label for="walletCheckboxCard" class="walletCheckboxlabel">'+
     ''+Messages.oneClickSaveCardWalletUser+'&nbsp;<a style="color: #222222;text-decoration: underline;" onclick="openGenericModal(\''+urlCondicionesCompraWallet+'\',[\'scrollable\'],addScroll,null,0.7)"  href="javascript:void(0);">('+Messages.oneClickInfoLink+')</a></label>';

     zonaWallet+='<input type="hidden" name="walletCheckbox" id="walletCheckbox" value="0">'+
     '</div>'+
     '<div class="campo">'+
     '<br>'+
     '<input type="text" class="walletCardName" id="walletCardName" name="walletCardName" tabIndex="10"/>'+
     '</div>'+
     '</div>';

     return zonaWallet;*/
    return '';
}

function walletControl(){
    if ( ($('#isWalletEnabled').val()=='true') && ($('.campo')) )
    {

        $('#walletCardName').bind('change', function() {
            if ($('#walletCardName').attr('value')!= ""){
                $('#walletCheckbox').val(1);
            }
        });

        $('#walletCardName').bind('click', function() {
            if ($("#securePassword").attr('value')=='false'){
                openModalCambioPassword(null,null,200,null);
            }
        });
    }
}



function openModalCambioPassword(params, onReady,top, height){
    divId='general_modal';
    var formCambioPass = '<form id="updatePasswordForm" method="post" action="'+$('#userAccountPasswordUpdateURL').val()+'">'+
        '<input type="hidden" name="storeId" value="'+$('#iStoreId').val()+'" />'+
        '<input type="hidden" name="catalogId" value="'+$('#iCatalogId').val()+'" />'+
        '<input type="hidden" name="URL" value="NoURL" />'+
        '<input type="hidden" name="viewname" value="ItxResponseJSON" />'+
        '<input type="hidden" name="errorViewName" value="ItxDynamicError" />'+
        '<input type="hidden" name="langId" value="'+$('#iLangId').val()+'" />'+
        '<input type="hidden" name="mode" value="UPDATE_USER_PASSWORD" />'+

        '<p class="title">'+Messages.recoverTitle+'</p>'+
        '<p>'+Messages.walletPassText1+'<br>'+Messages.walletPassText2+'<br>'+Messages.walletPassText3+'</p>'+

        '<div id="modificar_pass">' +
        '<div class="block first">' +
        '<label>'+Messages.passActual+'</label>'+
        '<input type="password" name="logonPasswordOld" id="passwordActual"/>'+
        '</div>' +
        '<div class="block two">' +
        '<div class="column">' +
        '<label>'+Messages.newPass+'</label>'+
        '<input type="password" name="logonPassword" id="password1"/>'+
        '</div>'+
        '<div class="column">' +
        '<label>'+Messages.repeatNewPass+'</label>'+
        '<input type="password" name="logonPasswordVerify" id="password2"/>'+
        '</div>'+
        '</div>'+
        '<div class="block">' +
        '<label>'+Messages.walletCodigo+'</label>'+
        '<img id="captchaImg" class="captcha" src="'+$('#captchaURL').attr('value')+'" alt="captcha" style="width:60%;margin-bottom:5px;"/>'+
        '<input type="text" id="captcha" name="captcha"/>'+
        '</div>'+
        '</div>'+
        '<span class="info_campo">'+Messages.camposObligatorios+'</span>'+
        '<div class="boton"  style="margin-top:5px;">'+
//							 '<a class="acc_butt l" href="javascript:void(0)" onclick="openGenericModalWihtoutEffect('+vueltaAtras+',null, null, general_modal)">'+Messages.recoverVolver+'</a>'+
        '<div class="">'+
        '<a class="acc_butt main" id="updatePasswordBtn" onclick="$(this).closest(recoverPassword).submit();" href="javascript:void(0)">'+Messages.submit+'</a>'+
        '</div>'+
        '</div>'+
        '</form><a id="close_modal" class="close_modal" href="javascript:void(0)"> </a>';

    if(divId == null)
        divId = "general_modal";
    var overlayId;
    var alreadyOverlay = false;


    overlayId = 's_overlay';
    alreadyOverlay = false;


    closeModalNoCallback();
    $('<div/>', {
        'id' : overlayId,
        'class' : 'transp',
        'style' : 'height:' + $(window).height() + 'px; width:' + $(window).width() + 'px'
    }).appendTo('body');
    $('<div/>', {
        'id' : 'close_overlay'
    }).appendTo('#' + overlayId);
    Inditex.ga(function(tracker) {
        var defaultPage = tracker.get('page');
        $('#' + overlayId).data('page',defaultPage);
    });

    //a?adimos la modal en si
    $('<div/>', {
        'id' : divId,
        'style' :(height!= null)? 'overflow:hidden':'overflow:auto'
    }).appendTo('#' + overlayId);
    // Meter aqu los contenidos del modal

    $('#'+divId).html(formCambioPass);

    $('#' + overlayId).find('#close_modal').bind('click', function() {
        closeModal(this);
    });


    calculatedHeight = (height != null ? $(window).height() * height : $(window).height());

    if(height != null) {
        $('#' + divId).css({
            'height' : calculatedHeight
        });
        if(top == null) {
            $('#' + divId).css({
                'top' : ($(window).height() - calculatedHeight) / 4
            });
            //$('#' + divId).offset({top: ($(window).height() - calculatedHeight) /2});
        }
    }

    if(top != null) {
        $('#' + divId).css({
            'top' : $(window).height() / 2 - top
        });
    } else {

    }
    $(window).bind('resize', function() {
        $('#s_overlay').css({
            'width' : $(window).width(),
            'height' : $(window).height()
        })
        if(top != null) {
            $('#' + divId).css({
                'top' : calculatedHeight / 2 - top
            });
        }
    })
    setTimeout(function() {

        $('#' + divId).find("#scrollable").css({
            'height' : calculatedHeight
        });
        $('#' + divId).fadeIn(function(){
        });
        if((onReady != null) && (onReady != undefined))
            onReady(params);

    }, 300)

    $('#' + overlayId).css('left', 0).fadeIn(function() {
        $('#close_overlay').bind('click', function() {
            closeModal(this);
        });
    })

    $("#updatePasswordBtn").click(function() {
        $("#updatePasswordForm").submit();
        setTimeout(function() {$('#captchaImg').attr('src',$('#captchaURL').attr('value')+"&t="+new Date().getTime());
        },2000);
    });



    $("#updatePasswordForm").validate({
        submitHandler : function(form) {
            var form = $("#updatePasswordForm");
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                dataType: 'json',
                data: form.serialize(),
                success: function(data) {

                    if (data.status > 0) {
                        if (Inditex)
                            Inditex.trackPage("/Cesta_de_Compra/Tramitar_Pedido/Validacion/Modificar_Contrasena/Envio_OK");
                        openPasswordUpdateGeneralModal(Messages.titlePassword, Messages.msgPassword, false, securizarPassword());
                    } else {
                        if (Inditex)
                            Inditex.trackPage("/Cesta_de_Compra/Tramitar_Pedido/Validacion/Modificar_Contrasena//Envio_Error_" + data.type);
                        openStaticModal(data.title, data.errorMessage, true);
                    }
                }
            });
        },
        rules : {
            logonPasswordOld : {
                validPassword: true,
                required : true,
                minlength : 6
            },
            logonPassword : {
                validNewPassword: true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                required : true,
                minlength : 8,
                equalTo : "#password1"
            }
        },
        messages : {
            logonPasswordOld : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPassword : {
                required : Messages.required,
                minlength : Messages.minlength
            },
            logonPasswordVerify : {
                required : Messages.required,
                minlength : Messages.minlength,
                equalTo : Messages.equalTo
            }
        }

    });

    //cambia el valor de inseguro a seguro en el jsp
    //suponemos que el cambio de password ha sido a seguro por las comprobaciones hechas al guardar el nuevo password
    function securizarPassword()
    {
        $('#securePassword').val(true);
        $('#check_walletCheckboxCard').focus();
        $('#check_walletCheckboxCard').attr('class', 'check active');
        $('#walletCheckbox').val(1);
        $('.campo').show();

    }
}

/**
 * Funcion que devuelve el formulario en caso que un usuario wallet seleccione una de las
 * tarjetas que se le muestran en el nuevo combo de tarjetas que hay en la pantalla
 * de seleccion de formas de pago.
 */
function formularioWallet(){
    var storeId = $("#iStoreId").val();
    var catalogId = $("#iCatalogId").val();
    var paymentId = "walletcard";


    var formularioWallet =
        '<div id="paymentpanel" style="display:block;" method="post" class="form">'+
        '<input type="hidden" name="storeId" id="storeId" value="'+storeId+'">'+
        '<input type="hidden" name="catalogId" id="catalogId" value="'+catalogId+'">'+
        getWalletSubmit(true,paymentId)+
        '</div>';
    return formularioWallet;
}

function abrirComboTarjeta(){
    if ($('#card_selector').attr('style') != "display:block"){
        $('#card_selector').attr('style', 'display:block');
        $('#card_selector_inner').attr('style', 'display:block');
    }

}

function cerrarComboTarjeta(){
    if ($('#card_selector').attr('style') == "display:block"){
        $('#card_selector').attr('style','display:none');
    }

}

function habilitarPagoWallet(){
    $('#radioWallet').attr('class', 'radio active');
    $('#radioNoWallet').attr('class', 'radio');
    $('#datos_pago1').attr('style', 'display:block');
    $('#card_selector_inner').attr('style','display:none');
}

function habilitarPagoNoWallet(){
    $('#radioNoWallet').attr('class', 'radio active');
    $('#radioWallet').attr('class', 'radio');
    $('#datos_pago1').attr('style', 'display:none');

}
function seleccionarTarjeta(walletCard){
    var separacionTexto = walletCard.split('|#|');

    $('#principalWalletCard').text(separacionTexto[0]);
    var numero= separacionTexto[1];

    var alias = 'aliasWallet'+numero;
    var tipo = 'typeWallet'+numero;
    var pan = 'panWallet'+numero;
    var hashWallet = 'hashWallet'+numero;

    $('#card_info').attr('style', 'display:block');
    $('#aliasPago').text($("#"+alias).attr('value'));
    $('#typePago').text($("#"+tipo).attr('value'));
    $('#cardPago').text($("#"+pan).attr('value'));
    $('#cardHash_0').attr('value',$("#"+hashWallet).attr('value'));
    $('#cardType_0').attr('value','walletcard');
    $('#walletCheckbox').attr('value','1');

    var tipoAlias = $("#"+alias).attr('value');
    var tipoTarjeta = $("#"+tipo).attr('value');

    $("#morePaymentInfo").remove();

    //Recupero los datos wallet para el usuario wallet
    Inditex.getRestWalletGetWalletCards({
        onSuccess: function(aJson) {
            if (aJson && aJson.walletCards && aJson.walletCards.length > 0){

                $.each(aJson.walletCards, function(index, card) {

                    if(card.alias == tipoAlias){

                        if(card.requestPaymentDetails == "1"){

                            if(card.paymentCode == "7"){
                                var modalidades = '<label>'+Messages.modalidadPago+'</label>'+'<div class="block">'+
                                    '<div class="multidrop single required" title="modalidadPagoAffinityMoreInfo">' +
                                    '<select id="cardMode_0" name="cardMode_0" title="modalidadPagoAffinityMoreInfo" >';

                                for (var i=0; i<card.paymentModes.length; i++) {
                                    modalidades+='<option value="';
                                    modalidades+=card.paymentModes[i].id;
                                    modalidades+='">';
                                    modalidades+=card.paymentModes[i].name;
                                    modalidades+='</option>';
                                }

                                modalidades+='</select></div>';




                                var more_info = "<div id='morePaymentInfo'><p>"+Messages.verifyTarjet+"</p><div class='row'><label>"+Messages.numeroTarjeta+"</label><input type='text' id='cardNumber_0' name='cardNumber_0'><div class='clearfix'></div><div id='modalidades' class='mx_compra_popup'></div></div></div><p></p><p></p><p></p>";
                                $("#datos_pago1").append(more_info);
                                $("#morePaymentInfo").find("#modalidades").html(modalidades);

                                selectBinds();
                                if(card.paymentModes.length>0){
                                    $("#select-inner-name-modalidadPagoAffinityMoreInfo").text(card.paymentModes[0].name);
                                }

                            }else{

                                var more_info = "<div id='morePaymentInfo'><p>"+Messages.verifyTarjet+"</p><div class='row'><label>"+Messages.codigoSeg+"</label><input type='text' class='wid1' id='cardCvv_0' name='cardCvv_0'><p class='infor'><a class='a_info' href='javascript:void(0)' onClick='toggleWrapper(\"0\");Inditex.trackPage( \"Cesta_de_Compra/Tramitar_Pedido/Pago\" +trackingGetTarjeta()+ \"/Informacion_CVV\" +extraPageview ,{\'page\':false});'>"+Messages.queEsCodigoSeg+"</a></p></div></div>";

                                var indice = 0;
                                var aclaracion = true;
                                var textInformativo = '<span class="info_campo">' + Messages.camposObligatorios + '</span>';
                                more_info+=  '<div id="cv2_desc" class="hidden_text_' + indice + '" style="background-color:white;">'+
                                    '<div class="aux_capa">'+
                                    '<a href="javascript:void(0);" onclick="toggle(\'' + indice + '\');" class="close">&nbsp;</a>'+
                                    '<div class="aux_cont info" id="insert_desc">'+
                                    '<br>'+
                                    '<br>'+
                                    '</div>'+
                                    '</div>'+
                                    '</div>' +
                                    (aclaracion? textInformativo:'');

                                $("#datos_pago1").append(more_info);
                            }
                        }

                        else if(card.paymentCode == "7"){

                            var modalidades = '<label>'+Messages.modalidadPago+'</label>'+'<div class="block">'+
                                '<div class="multidrop single required" title="modalidadPagoAffinityMoreInfo">' +
                                '<select id="cardMode_0" name="cardMode_0" title="modalidadPagoAffinityMoreInfo" >';

                            for (var i=0; i<card.paymentModes.length; i++) {
                                modalidades+='<option value="';
                                modalidades+=card.paymentModes[i].id;
                                modalidades+='">';
                                modalidades+=card.paymentModes[i].name;
                                modalidades+='</option>';
                            }

                            modalidades+='</select></div>';


                            var more_info = "<div id='morePaymentInfo'><p>"+Messages.verifyTarjet+"</p><div class='row'><div id='modalidades' class='mx_compra_popup'></div></div></div><p></p><p></p><p></p>";
                            $("#datos_pago1").append(more_info);
                            $("#morePaymentInfo").find("#modalidades").html(modalidades);

                            selectBinds();
                            if(card.paymentModes.length>0){
                                $("#select-inner-name-modalidadPagoAffinityMoreInfo").text(card.paymentModes[0].name);
                            }

                        }

                        //Carga de modalidades de pago Installments de las tarjetas Wallet guardadas
                        if (card.paymentMethod.indexOf('Installments') != -1) {

                            var more_info = "<div id='morePaymentInfo' style='float:left;'><div class='row'><div id='modalidades' class='mx_compra_popup'><div class='block' style='visibility:hidden;width:100%;'>" +
                                "<label>"+Messages.PaymentMethod+"</label>" +
                                "<div class='multidrop single tunelcuenta' >" +
                                "<select id='modalidadPagoAffinityMoreInfo' name='modalidadPagoAffinityMoreInfo' title='"+Messages.method+"' disabled='disabled'></select>" +
                                "</div></div></div></div>";

                            $("#datos_pago1").append(more_info);

                            var amount = shopCartJSON.totalPrice;

                            Inditex.getRestOrderPaymentModes({
                                number: "",
                                amount: amount,
                                policy: card.paymentCodeName,
                                vatin:  "",
                                onSuccess: function(aJson) {
                                    if (aJson.paymentModes.length > 0) {
                                        $("#modalidadPagoAffinityMoreInfo").empty();

                                        var opcion = '';

                                        for (var i=0;i<aJson.paymentModes.length; i++){
                                            var item = aJson.paymentModes[i];

                                            opcion += '<option name="'+item.name+'" value="'+item.id+'">' +item.name+'</option>';
                                        }

                                        $("#modalidadPagoAffinityMoreInfo").html(opcion);

                                        $("#modalidadPagoAffinityMoreInfo").removeAttr('disabled');
                                        $("#modalidadPagoAffinityMoreInfo").parent().parent().css('visibility','visible');

                                        selectBinds();
                                    } else {
                                        $("#modalidadPagoAffinityMoreInfo").empty();
                                        $("#modalidadPagoAffinityMoreInfo").attr('disabled');
                                        $("#modalidadPagoAffinityMoreInfo").parent().parent().css('visibility','hidden');
                                    }
                                },

                                onFailure: function(aStatus) {
                                    showError(ITX_TEXT_GENERIC_PROBLEM);
                                    $("#morePaymentInfo").find("#modalidades").empty();
                                }

                            });
                        }
                    }

                });
            }
        },
        onFailure: function(aStatus) {

        }
    });






}

function principalCardTunnel(element,success){

    jQuery.xajax({
        "url": Inditex.generateUrl("ItxStandardSetDefaultPaymentCardCmd", {
            "storeId": Inditex.iStoreId,
            "langId": Inditex.iLangId,
            "catalogId": Inditex.iCatalogId
        },true),
        "type": "post",
        "dataType": 'json',
        "data": "hash="+element,
        "success": function(data) {
            if (data.status > 0) {
                success();
            } else{
                openStaticModal(data.title, data.errorMessage, true);
            }
        }
    });

}


function ocultarCapa(){

    if (($('#card_selector').attr('style'))=='display:block')
        $('#card_selector').attr('style','display:none');
}

function compruebaFactura(){

    if ($('#check_factura').attr('class') == "check") {
        $('#check_factura').attr('class','check active');
        $('.nifnie_input').show()
        fitFooterBottomTunel($('#tunel'));
    }else{
        $('#check_factura').attr('class','check');
        $('.nifnie_input').hide()
        fitFooterBottomTunel($('#tunel'));
    }

}
function compruebaPolitica(){

    if ($('#check_politica').attr('class') == "check") {
        $('#check_politica').removeClass('check');
        $('#check_politica').attr('class','check active');
        $('#politica').attr('class','valid');
        $('#politica').attr('checked', true);

    }else{
        $('#check_politica').removeClass('check active');
        $('#check_politica').attr('class','check');
        $('#politica').attr('class','error');
        $('#politica').attr('checked', false);

    }
}

function comprobarCheck(url){

    var data = $("#compraRapidaConfirmacion").serializeArray();

    data["deviceChannel"] = "0:STANDARD:OrderPaymentPage:ItxStandardOrderDetailPage:" + Inditex.iLangId + ":" + Inditex.iCatalogId;

    if( $('#codigoSeguridad').length && $('#codigoSeguridad').val() == ''){

        $("#codigoSeguridadRequired").css("display","block");
    }
    else if( $('#codigoSeguridad').length){
        data["cardCvv_0"] = $('#codigoSeguridad').val();
    }

    if($('#numeroTarjeta').length && $('#numeroTarjeta').val() == ''){

        $("#numCardRequired").css("display","block");
    }
    else if($('#numeroTarjeta').length){
        data["cardNumber_0"] = $('#numeroTarjeta').val();
    }

    if($('#cardMode_0').length && $('#cardMode_0').val() != ''){
        data["cardMode_0"] = $('#cardMode_0').val();
    }

    if ( $("#modalidadPagoAffinityMoreInfo") && $("#modalidadPagoAffinityMoreInfo option:selected").val()!="" ) {
        data["installmentsCode_0"] = $("#modalidadPagoAffinityMoreInfo option:selected").val();
    }

    if ($('#check_politica').attr('class')=="check active"){
//		if (Inditex.iEnableAsyncPayments) {

        iAsyncPaymentPollingCount = 0;


        for (var i=0; i<data.length; i++) {
            if (data[i].name == 'viewname') {
                data[i].value = 'ItxStandardJSON'
            }
            if (data[i].name == 'errorViewName') {
                data[i].name = 'ItxStandardJSON';
            }
        }
        var installmentsCode_0 = $("#modalidadPagoAffinityMoreInfo").val();
        if (installmentsCode_0) {
            data.push({
                name: 'installmentsCode_0',
                value: installmentsCode_0
            });
        }


        data = $.param(data);


        var orderTemp =  $("#iOrderId").attr('value');

        //tiposPagoJSON.orderId = orderTemp;


        jQuery.xajax({
            "url": Inditex.generateUrl("ItxStandardOrderConfirmationCmd", {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId,
                "orderId": orderTemp,
                "useIli": false
            },true),
            "type": "post",
            "dataType": 'json',
            "data": data,
            "success": function(json, textStatus, jqXHR) {
                processPaymentStatus(json,true);
            },
            "error": function(xhr) {
                Inditex.trackEvent( "Cesta_de_Compra_Rapida","Autorizar_pago_error",Inditex.codeError(xhr.status,xhr.statusText),true);
                showError(ITX_TEXT_GENERIC_PROBLEM);
            }
        });
//		} else {	
//			document.location.href=url;
//			return true;	
//		}


    }else{
        if($('#ItxStandardOneClickPreviewCmd').length>0){
            Inditex.trackEvent('Cesta_de_Compra_Rapida','Autorizar_pago_error', Inditex.codeError('check_politica_privacidad','check_politica_privacidad'), true);
        }
        $(".error").css("display","block");
    }

}

function ocultarValidacionCampo(campo){
    $("#"+campo).css("display","none");
}


function formatPriceGiftCard(stringPrice){
    return (parseFloat(stringPrice)/100).toFixed(2);
}


function validateQR(event){

    if($("#data-itx-bind-mobile-payment-qr-input").val() != ''){


        var valid = IsValidQr($("#data-itx-bind-mobile-payment-qr-input").val());

        if(!valid){
            var validator = $( "#form1" ).validate();
            validator.showErrors({
                "data-itx-bind-mobile-payment-qr-input":Messages.errorQR
            });

            event.stopImmediatePropagation();
            return false;
        }

    }else{
        var validator = $( "#form1" ).validate();
        validator.showErrors({
            "data-itx-bind-mobile-payment-qr-input":Messages.rellenarCampo
        });
        event.stopImmediatePropagation();
        return false;
    }

}

function validateInUser(){
    var errors=false;
    if($("#in_user").val() == ''||$("#in_user").val() == undefined){
        var validator = $( "#form1" ).validate();
        validator.showErrors({
            "in_user" : Messages.rellenarCampo
        });
        errors=true;
    }
    if($("#in_pass").val() == ''||$("#in_pass").val() == undefined){
        var validator = $( "#form1" ).validate();
        validator.showErrors({
            "in_pass" : Messages.rellenarCampo
        });
        errors=true;
    }
    if (errors){
        return false;
    }else{
        //selectBinds();
        //showPayments();
        return true;
    }
}

function recoverInWalletCards(){
    $("#loguedInwalletUser").val("");
    if(validateInUser()){
        var user = $('#in_user').val();
        var password = $('#in_pass').val();

        Inditex.getRestWalletGetInWalletCards({
            email: user,
            password: password,

            "onSuccess": function(aJson) {
                if (aJson && aJson.cards){
                    target=$('#inWallet_payments');
                    target.html(
                        '<label>'+Messages.seleccionaTarjeta+'</label><br>'+
                        '<div class="multidrop single required">'+
                        '<select  id="cardHash_0"  name="cardHash_0" title="'+Messages.tarjetas+'" class="required" value="">'+
                        '</select>'+
                        '</div>');


                    var select =$('#inWallet_payments  select');
                    var option = $('<option></option>').attr({
                        'value' : ''
                    }).html(Messages.tarjetas);
                    select.append(option);

                    $.each(aJson.cards, function(index, card) {

                        var option = $('<option></option>').attr({
                            'value' : card.hash
                        }).html(card.alias+" ("+card.printablePan+")");

                        select.append(option);
                    });
                    selectBinds();
                    //$("#cardHash_0").val("");
                    showPayments();
                }},
            "onFailure": function(aStatus) {
                openStaticModal(Messages.inWalletTitle, Messages.invalidInWalletUser);
            }
        });

    }
}


function showPayments(){
    $("#qr_content").hide();
    $("#inWallet_payments").show();
}

function IsValidQr(qr) {

    var regex =  /^[a-zA-Z0-9]{6,6}$/;
    return regex.test(qr);
}

function trackingGetTarjeta(){
    if ($('#radioWallet.active').length>0) {
        return $('#typePago').text();
    } else if (typeof tiposPagoJSON!="undefined" && tiposPagoJSON && tiposPagoJSON.cards && tiposPagoJSON.cards.length>0) {
        return tiposPagoJSON.cards[tiposPagoJSON.cards.length-1].type;
    } else {
        return '';
    }
}
;
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_4.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_5.js (en_US) */
function load5() {


    jQuery(window).bind('resize', function(e){
        if (e.target==window) {
            fitFooterBottomTunel($('#tunel'));
        }
    });

    if ($("#esSeguimientoPedido").attr('value')=="true") {
        load_resumenPedidoGuest(resumenPedido);
    }
    else {
        load_resumenPedido(resumenPedido);
    }
    if ($("#isUserGuest").attr('value')=="true") {
        load_GuestBillingAddress(billingAddressJSON);
        selectBinds(327,'px');
    }
    else {
        load_billingAddress(billingAddressJSON);
    }
    load_shippingAddress(shippingAddressJSON);
    load_detalleCesta(detallesPedidoJSON);

    setTimeout(function(){
        fitFooterBottomTunel($('#tunel'));

        verPopupCompraRapida();

    },800);

    $('.openform').click(function(e){
        e.preventDefault();
        $('#regForm').slideToggle(500,function(){
            $(window).trigger('resize');
        });
    });

    loadRadiosAndChecks();

    removeValueFromFieldOnClick("birthDate");

    $('#regForm form').validate({
        submitHandler : function(form) {
            var form = $("#regForm form");
            var email=$("#regForm form #email1").attr("value");
            readDate($('#birthDate'),$('#day'),$('#month'),$('#year'));
            jQuery.xajax({
                url: form.attr("action"),
                type: 'post',
                dataType: 'json',
                data: form.serialize(),
                success: function(resp) {
                    var data = getResponseJSON(resp);
                    if (data.key==null && data.status > 0) {
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Registrarse/Envio_OK");
                        $('#regForm form').css('opacity','0.5');
                        setTimeout(function(){
                            $('.openform').trigger('click').unbind('click');
                            $('.thanks.message').html(Messages.registroOk1+email+Messages.registroOk2);
                        },800);
                        openStaticModal(Messages.titleSendToFriend, Messages.asociacionDePedidoACuentaOK, false);
                        Inditex.drawHeader();
                    }
                    else {
                        if (Inditex)
                            Inditex.trackPage("/Identificate/Registrarse/Envio_Error_" + data.type);
                        openStaticModal(data.title, data.errorMessage, false);
                    }
                }
            });
        },
        rules : {
            sexo : "required",
            nombreEmpresa : "required",
            nif : {
                required:true,
                nif:true
            },
            birthDate : {
                requiredChangeClassLocalDate : true
            },
            address1 : "required",
            city : "required",
            zipCode : "requiredChangeClass",
            state : "itxSelect",
            country : "required",
            email1 : {
                required : true,
                email : true
            },
            logonPassword : {
                validPassword: true,
                required : true,
                minlength : 8
            },
            logonPasswordVerify : {
                required : true,
                minlength : 8,
                equalTo : "#logonPassword"
            },
            politica : "required"
        },
        messages : {
            sexo : Messages.rellenarGenero,
            nombreEmpresa : Messages.rellenarCampo,
            nif : Messages.rellenarCampo,
            birthDate : Messages.rellenarFecha,
            city : Messages.rellenarCampo,
            address1 : Messages.rellenarCampo,
            zipCode : Messages.rellenarCp,
            state : Messages.rellenarCampo,
            country : Messages.rellenarCampo,
            logonPassword : {
                validPassword : Messages.validNewPassword,
                required : Messages.rellenarCampo,
                minlength : Messages.minCaracteres
            },
            logonPasswordVerify : {
                required : Messages.rellenarCampo,
                minlength : Messages.minCaracteres,
                equalTo : Messages.mismaPassword
            },
            email1 : Messages.emailValido,
            politica : Messages.aceptarPolitica,
        }
    });

    if (iCountry == "MX") {
        if ($("input[name=colony]").length>0) {
            $("input[name=colony]").rules("add", {
                required: true,
                messages: {
                    required: Messages.rellenarCampo
                    //maxlength: "long"
                }
            });
        }
        if ($("input[name=municipality]").length>0) {
            $("input[name=municipality]").rules("add", {
                required: true,
                messages: {
                    required: Messages.rellenarCampo
                    //maxlength: "long"
                }
            });
        }
    }

}

function load_resumenPedido(data){
    var contenido ='';
    //$.getJSON(url, function(data) {
    $("#fechaPedido").html(data.date);
    $("#numeroPedido").html(data.orderId);
    $("#modoEnvio").html(data.shipMode);
    //});
}

function load_resumenPedidoGuest(data) {

    $("#fechaPedido").html(data.date);
    $("#numeroPedido").html(data.orderId);
    $("#modoEnvio").html(data.shipMode);
    $("#estadoPedido").html(data.state);
    $("#fechaEstimadaEntrega").html(data.estDate);
    $("#trackingNumber").attr("href",data.url);
    $("#trackingNumber").html(data.tracking);
    $("#transporte").html(data.courier);
}

function verPopupCompraRapida() {
    //Ejemplo (prueba local): Inditex.iXWalletWalletInfoJSON = {firstTimeSave: false, savePayment:true, saveShipping: true, securePass: true,showSaveDialog:true};

    Inditex.getUserJSON(function(userInfo) {

        var userInfo = userInfo;

        // -- se recupera la informaci?n del usuario 
        if (userInfo && userInfo.userType == "R" &&  Inditex.iStoreJSON.details
            && Inditex.iStoreJSON.details.walletEnabled == true){

            if (userInfo.isWalletUser){


                // mostramos pop up para alias de wallet
                if(Inditex.iXWalletWalletInfoJSON.showSaveDialog == true) {
                    if (Inditex.iXWalletWalletInfoJSON.savePayment == true) {
                        openPopupSaveCardOneClick()
                    } else {
                        saveAddressWallet(resumenPedido.orderId);
                    }
                }

            } else {
                // abrimos popup para que el usuario pueda adherirse al wallet
                if(Inditex.iXWalletWalletInfoJSON.showSaveDialog == true) {
                    openPopupSaveCardOneClick()
                }
            }
        }
    });


}

function saveAddressWallet(orderId){
    var saveShipping = "0";
    var savePayment = "0";
    if (Inditex.iXWalletWalletInfoJSON.saveShipping == true) {
        saveShipping = "1";
    }

    if (Inditex.iXWalletWalletInfoJSON.savePayment == true) {
        savePayment = "1";
    }

    url = Inditex.generateUrl("ItxStandardSaveWalletInfoCmd",{
        "storeId" : Inditex.iStoreId,
        "langId" : Inditex.iLangId,
        "catalogId" : Inditex.iCatalogId,
        "orderId" : resumenPedido.orderId,
        "updateShipping" : saveShipping,
        "updatePayment" : savePayment
    }, true);

    Inditex.request({
        "url": url,
        "onSuccess": function(aText) {
        },
        "onFailure": function(aText) {
        }
    });
    Inditex.request({
        "url": url,
        "onSuccess": function(aText) {
        },
        "onFailure": function(aText) {
        }
    });

}

function openPopupSaveCardOneClick() {
    var urlSaveOneClick = Inditex.generateUrl('ItxOneClickSaveCardView',{
            "storeId"			: Inditex.iStoreId,
            "langId"			: Inditex.iLangId,
            "catalogId"			: Inditex.iCatalogId
        },
        true);

    openGenericModal(urlSaveOneClick,null, null, 200,null);
    setTimeout(function(){
        $('#compra_rapida_check').on('click', function(){
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
            } else {
                $(this).addClass('active');
            }
            $('input[name="compra_rapida_check"]').trigger("click");

        });
    },800);
}

function compra_rapida_validate(){
    $("#add_new_card").validate({
        submitHandler: function(form) {
            url = Inditex.generateUrl("ItxStandardSaveWalletInfoCmd",{
                "storeId" : Inditex.iStoreId,
                "langId" : Inditex.iLangId,
                "catalogId" : Inditex.iCatalogId,
                "orderId" : resumenPedido.orderId,
                "walletCardName" : $('#card_name').val(),
                "updateShipping" : Inditex.iXWalletWalletInfoJSON.saveShipping == true ? "1": "0",
                "updatePayment" : Inditex.iXWalletWalletInfoJSON.savePayment == true ? "1": "0"
            }, true);


            Inditex.request({
                "url": url,
                "onSuccess": function(aText) {
                    openStaticModal(Messages.oneClickTitle, Messages.msgSaveCardOneClick, true);
                    Inditex.trackEvent( "Compra_Rpida","Alta_Ok",null,true);
                },
                "onFailure": function(aText) {
                    openStaticModal(Messages.aviso, Messages.errorOneClick, true);
                    Inditex.trackEvent( "Compra_Rpida","Alta_Error",Inditex.codeError("errorOneClick",Messages.errorOneClick),true);
                }
            });

        },
        rules: {
            compra_rapida_check: {
                required: true
            },
            card_name: {
                required: true,
                requiredChangeClassAlias: true,
            }
        },
        messages: {
            compra_rapida_check: Messages.warningOneClickCheck,
            card_name: {
                required: Messages.warningOneClickAlias,
            }
        }
    });
};
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_5.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_common.js (en_US) */


/* comun */

var DROPPOINT_SHIP_MODE_ID_COMPARE = '6';

function load_detalleCesta(data){

    var tallaUnica = $('#textoTallaUnica').val();
    symbolPosition = data.currencySuffix.length==0;
    if (!symbolPosition)
        moneda = data.currencySuffix;
    else
        moneda=data.currencyPrefix;
    decimals = data.decimalPlaces;
    var contenido ='';
    //$.getJSON(url, function(data) {
    lista = data.listItems;
    contenido='<tr class="nom">' +
        '<td colspan="2"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_order+'</p></td>' +
        '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_color+'</p></td>' +
        '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_size+'</p></td>' +
        '<td><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_quantity+'</p></td>' +
        '<td style="width:100px;"><p>'+ Messages.ItxMyAccountOrderRequestedDetailsView_order_heard_total+'</p></td>' +
        '</tr>' ;
    for(i=0;i< lista.length;i++){
        producto = lista[i];
        if ( producto != undefined ) {
            contenido +=

                '<tr>' +
                '<td>' +
                '  <img src="' + producto.image + '" width="55px;" />' +
                '</td>' +
                '<td>' +
                '	<p>' + producto.description + '</p>' +
                '    <span>Ref. ' + producto.reference + '</span>' +
                '</td>' +
                '<td class="center">' +
                '	<p>' + producto.cutColorName + '</p>' +
                '</td>';



            if(producto.numSizes == '1'){
                contenido +='<td class="center">' +
                    '<p>' + tallaUnica + '</p>' +
                    '</td>';
            }
            else{
                contenido +='<td class="center">' +
                    '<p>' + producto.size + '</p>' +
                    '</td>';
            }

            contenido +=   '<td class="center">' +
                '	<p>' + formatNumber(producto.quantity,0) + '</p>' +
                '</td>' +
                '<td class="right">' +
                ' 	<p>' + formatCurPrice(producto.unitPrice * producto.quantity,decimals,moneda) + '</p>' +
                ' </td>' +
                '</tr>';
        }
    }
    contenido += '<tr class="noborde">'+
        '<td colspan="5" class="right"><p>'+Messages.totalArticulos+'</p></td>'+
        '<td class="right"><p><strong id="totalArticlesPrice" sinFormato="' + data.totalProductPrice + '">'+ formatCurPrice(data.totalProductPrice,decimals,moneda) +'</strong></p></td>'+
        '</tr>';

    if(data.isGift === "true"){
        contenido +='<tr class="noborde antesDesc">'+
            '<td colspan="5" class="right"><p id="giftPriceDesc">'+Messages.envoltorioRegalo+'</p></td>'+
            '<td class="right"><p><strong id="giftPriceAmount" sinFormato=" '+ data.giftPrice+'">'+ formatCurPrice(data.giftPrice,decimals,moneda) +'</strong></p></td>'+
            '</tr>';
    }

    if(data.isStoreTaxesIncluded == '0' && data.productTaxes != '-1'){

        if (data.tipoDesgloseImpuestos=='1') {

            contenido +='<tr class="noborde">'+
                '<td colspan="5" class="right"><p>'+getMessage("impuestosTotalArticulos")+'</p></td>'+
                '<td class="right"><p><strong id="totalArticlesSalesTax" sinFormato="' + data.productTaxes + '">'+ formatCurPrice(data.productTaxes,decimals,moneda) +'</strong></p></td>'+
                '</tr>';
        }


        if (data.tipoDesgloseImpuestos=='2') {

            for (var j=0;j < data.invoiceVatDetailsData.length; j++) {

                t=data.invoiceVatDetailsData[j].invoiceVatDataVatType+' '+ formatCurPercent(data.invoiceVatDetailsData[j].invoiceVatDataVatRate,decimals);
                contenido +='<tr class="noborde">'+
                    '<td colspan="5" class="right"><p>'+t+'</p></td>'+
                    '<td class="right"><p><strong sinFormato="' + data.invoiceVatDetailsData[j].taxes + '">'+ formatCurPrice(data.invoiceVatDetailsData[j].taxes,decimals,moneda) +'</strong></p></td>'+
                    '</tr>';
            }

            contenido +='<tr class="noborde">'+
                '<td colspan="5" class="right"><p>'+getMessage("impuestosTotalArticulos")+'</p></td>'+
                '<td class="right"><p><strong id="totalArticlesSalesTax" sinFormato="' + data.productTaxes + '">'+ formatCurPrice(data.productTaxes,decimals,moneda) +'</strong></p></td>'+
                '</tr>';
        }

    }

    var drop;
    if ( data.shippingModeId == DROPPOINT_SHIP_MODE_ID_COMPARE && (iCountry == 'GB' || iCountry == 'BE'))
    {
        drop = Messages.drops;
    }
    else
    {
        drop = data.shippingMode;
    }

    for (var j=0; j<data.discounts.length;j++){
        contenido += '<tr class="noborde '+(data.discounts[j].isShippingAdjustment?"shippingDiscount":"")+'">'+
            '<td colspan="5" class="right"><p>'+(data.discounts[j].isShippingAdjustment?Messages.discountDescription:data.discounts[j].description)+'</p></td>'+
            '<td class="right"><p><strong id="totalDescuentoPrice" sinFormato="' + data.discounts[j].amount + '">'+ formatCurPrice(data.discounts[j].amount,decimals,moneda) +'</strong></p></td>'+
            '</tr>';
    }
    contenido    +=
        '<tr class="noborde shippingMode">'+
        '<td colspan="5" class="right"><p id="shippingMode"><span>'+ drop + '</span></p></td>'+
        '<td class="right"><p><strong id="shippingPrice">'+ formatCurPrice(data.shippingPrice,decimals,moneda) +'</strong></p></td>'+
        '</tr>';

    $("#cuerpoTabla").html(contenido);
    $("#totalPrice").html(formatCurPrice(data.totalPrice,decimals,moneda));
    //});
}

function load_billingAddress(data){
    //$.getJSON(url, function(data) {
    loadAddress(data, "billingAddress", false);
    //});
}
function load_GuestBillingAddress(data){
    loadAddress(data, "billingAddress", false);
}
function load_shippingAddress(data){
    //$.getJSON(url, function(data) {
    loadAddress(data, "shippingAddress", false);
    //});
}

function escapeHtml(text) {
    return (text==null?'':$('<div/>').text(text).html());
}

function loadAddress(data, id, withLink){

    if(data.type=='individual' || data.type=='particular'){
        if (Inditex.checkMiddleName(data.middleName)) {
            $("#"+id).find("[name=nombre]").replaceWith('<p name="nombre">' + escapeHtml(data.firstName) + ' ' + escapeHtml(data.middleName) + ' ' + escapeHtml(data.lastName )+'</p>');
        } else {
            $("#"+id).find("[name=nombre]").replaceWith('<p name="nombre">' + escapeHtml(data.firstName) + ' ' + escapeHtml(data.lastName) +'</p>');
        }
    }
    else{
        $("#"+id).find("[name=nombre]").replaceWith('<p name="nombre">' + escapeHtml(data.nameCompany) +'</p>');
    }

    //Si tiene el state ese valor significa que la compra se ha hecho sin registro y es particular
    //Busco los datos del Usuario si el userType = R esta registrado, Si es G no esta registrado.
    Inditex.getUserJSON(function(json) {
        if ( (json.userType == "R" || data.isBillingAddress == "false" ||  data.type=="company") && data.zipCode != "-" ) {
            $("#"+id).find("[name=direccion]").replaceWith('<p name="direccion">' + escapeHtml(data.street) + ' - ' + escapeHtml(data.street2) + ' ' + escapeHtml(data.city) +'</p>');
            $("#"+id).find("[name=cp]").replaceWith('<p name="cp">' + data.zipCode +'</p>');
            if (data.state!=null)
                $("#"+id).find("[name=ciudad]").replaceWith('<p name="ciudad">' + data.state +'</p>');
            else
                $("#"+id).find("[name=ciudad]").attr ('style','display:none;');

            if($("#"+id).find("[name=colonia-municipio]")&&$("#"+id).find("[name=colonia-municipio]").length>0){
                $("#"+id).find("[name=colonia-municipio]").replaceWith('<p name="colonia-municipio">' + escapeHtml(data.colony) + '  ' + escapeHtml(data.municipality)+'</p>');
            }

        }
        else{
            $("#"+id).find("[name=direccion]").attr ('style','display:none;');
            $("#"+id).find("[name=cp]").attr ('style','display:none;');
            $("#"+id).find("[name=ciudad]").attr ('style','display:none;');
            if($("#"+id).find("[name=colony]")&&$("#"+id).find("[name=colony]").length>0){
                $("#"+id).find("[name=colony]").attr ('style','display:none;');
            }
            if($("#"+id).find("[name=municipality]")&&$("#"+id).find("[name=municipality]").length>0){
                $("#"+id).find("[name=municipality]").attr ('style','display:none;');
            }
        }
    });

    $("#"+id).find("[name=pais]").replaceWith('<p name="pais">' + data.country +'</p>');
    $("#"+id).find("[name=telefono]").replaceWith('<p name="telefono">' + data.phone1 +'</p>');
    $("#"+id).find("[name=email]").replaceWith('<p name="email">' + data.email +'</p>');
    if(withLink){
        $("#"+id).append(linkModificarDatos());
    }
}


function cargaDireccion(element,url, tipo){
    direccion = "";
    if (Inditex.checkMiddleName(element.middleName) && element.type != "company") {
        direccion += '<p name="nombre">' + escapeHtml(element.firstName) + ' ' + escapeHtml(element.middleName) + ' ' + escapeHtml(element.lastName)+ '</p>';
    } else {
        direccion += '<p name="nombre">' + escapeHtml(element.type == "company"?element.nameCompany:element.firstName) + ' ' + escapeHtml(element.lastName)+ '</p>';
    }
    direccion += 	'<p name="direccion">' + escapeHtml(element.street) + ' ' + escapeHtml(element.street2) + ' ' + escapeHtml(element.city) +'</p>'+
        '<p name="cp" class="validateZipCode">' + element.zipCode + '</p>';
    if(iCountry=="MX"){
        direccion +='<p name="colonia-municipio">' + element.colony+" "+ element.municipality+ '</p>'
    }
    direccion +=    '<p name="ciudad">' + element.state + '</p>'+
        '<p name="pais">' +  element.country + '</p>'+
        '<p name="telefono">' + element.phone1 + '</p>';

    if (element.isBillingAddress) {
        $("#personAddressId").value = element.addressId;
    }

    direccion += linkModificarDireccion(element,url,tipo);

    return direccion;
}

function linkModificarDireccion(object,url,tipo){
    object = JSON.stringify(object);
    if(tipo == "facturacion"){
        var tag = "editar_direccion_factura";
        return '<a id="botonModificarDireccionEnvio" onclick="Inditex.trackEvent(\''+categoryEvent+'\',\'Modificar_datos_facturacion\',null, true);openFormModal('+url+',\'' + escape(object) + '\' , cargarCamposDireccion,null,0.7); if (Inditex){ Inditex.trackPage(\'/Editar_Direccion/Formulario\'); Inditex.trackEvent(\'/Tramitacion_Envio\',\''+tag+'\'); }" href="javascript:void(0)" class="accion2 gaPage"><strong>'+Messages.modificarDireccion+'</strong></a>';
    }
    else{
        var tag = "editar_direccion_envio";
        return '<a id="botonModificarDireccionEnvio" onclick="openFormModal('+url+',\'' + escape(object) + '\' , function(data){Inditex.trackPage( \'Cesta_de_Compra/Tramitar_Pedido/Envio/Domicilio/Editar_Direccion\'+extraPageview,true);cargarCamposDireccion(data,\''+tipo+'\');},null,0.7); if (Inditex){ Inditex.trackPage(\'/Editar_Direccion/Formulario\'); Inditex.trackEvent(\'/Tramitacion_Envio\',\''+tag+'\'); }" href="javascript:void(0)" class="accion2 gaPage"><strong>'+Messages.modificarDireccion+'</strong></a>';
    }
}

function linkModificarDatos(object){
    object = JSON.stringify(object);
    url = "'" + url +"'";
    link = '<a id="botonModificarDireccionEnvio" onclick="openGenericModal('+url+',\'' + escape(object) + '\' , cargarCamposDireccion,null,0.7); if (Inditex) Inditex.trackPage(\'/Editar_Direccion/Formulario\');" href="javascript:void(0)" class="accion2 gaPage" ><strong>'+Messages.modificarDireccion+'</strong></a>';
    return link;
}

function cargarCamposDireccion(object,origen){
    camposDir = object;
    form = $("#gestionarDireccion");
    if (form[0] != undefined){
        element = JSON.parse(unescape(object));
        $("#titleGestionarDirecciones").html(Messages.updateAddress);
        $("#addressId").attr('value',element.addressId);
        $("#addressName").attr('value',element.addressDecription);
        if(element.isBillingAddress){
            $("#addressName").attr('disabled',true);
            form[0].action = $('#updateBillingURL').attr('value');
            form[0].addressType.value = "SB";
        }else {
            form[0].action = $('#updateURL').attr('value');
        }

        if (element.type == "company") {
            $("#empresa").attr('value',	element.nameCompany);
            $("#nif").attr('value',	element.nif);
        }


        $("#nombre").attr('value',element.firstName);
        if (Inditex.checkMiddleName(element.middleName)) {
            $("#middleName").attr('value',element.middleName);
        }
        $("#apellidos").attr('value',element.lastName);
        $("#direccion").attr('value',element.street);
        $("#direccion2").attr('value',element.street2);
        $("#localidad").attr('value',element.city);
        $("#cp").attr('value',element.zipCode);
        $("#provincia").attr('value',element.stateISO);
        var titleProvincia =  $("#provincia").attr('title');
        changeCustomSelect(form.find('#select-'+ titleProvincia+' li[v=' + element.stateISO + ']'), form);
        $("#prefijo").attr('value',extractPrefix(element.phone1));
        $("#telefono").attr('value',extractPhone(element.phone1));
        $("#prefijo2").attr('value',extractPrefix(element.phone2));
        $("#telefono2").attr('value',extractPhone(element.phone2));
        $("#pais").attr('value',element.country);
        if($("#colony")&&$("#colony").length>0){
            $("#colony").attr('value',element.colony);
        }
        if($("#municipality")&&$("#municipality").length>0){
            $("#municipality").attr('value',element.municipality);
        }
        $("#pais").attr('value',element.country);

    }
    if (origen=="envio") {
        $("#addressId").data("origen",origen);
    }
}

//Invitado
function cargaDireccionInvitado(element,patronymic){
    // si patronimico es true estamos en Rusia y lo pintamos
    var direccion = "";

    if(element.type != "company"){ //Particular 

        if (Inditex.checkMiddleName(element.middleName))

            direccion = '<p name="nombre">' + escapeHtml(element.firstName) + ' ' + escapeHtml(element.middleName) + ' ' + escapeHtml(element.lastName)+ '</p>';

        else

            direccion = '<p name="nombre">' + escapeHtml(element.firstName) + ' ' + escapeHtml(element.lastName) + '</p>';

        direccion +='<p name="country">' + element.country + '</p>';
        direccion +='<p name="telefono">' + element.phone1 + '</p>';
        direccion +='<p name="email">' + element.email + '</p>';
    }
    else { //Empresa

        direccion = '<p name="nombreEmpresa">' + escapeHtml(element.nameCompany) + '</p>';

        /*
         if (Inditex.checkMiddleName(element.middleName)) 

         direccion += '<p name="nombre">' + element.firstName + ' ' + element.middleName + ' ' + element.lastName+ '</p>';

         else 

         direccion += '<p name="nombre">' + element.firstName + ' ' + element.lastName + '</p>';
         */

        direccion += '<p name="direccion">' + escapeHtml(element.street) + ' ' + escapeHtml(element.street2) + ' ' + escapeHtml(element.city) +'</p>'+
            '<p name="cp" class="validateZipCode">' + element.zipCode + '</p>';
        if(iCountry=="MX"){
            direccion +='<p name="colonia-municipio">' + element.colony+" "+ element.municipality+ '</p>'
        }
        direccion +='<p name="ciudad">' + element.state + '</p>'+
            '<p name="pais">' +  element.country + '</p>'+
            '<p name="telefono">' + element.phone1 + '</p>'+
            '<p name="email">' + element.email + '</p>';
    }

    return direccion;
}
;
/* END /DuttiNEWStorefrontAssetStore/js/Checkout/Main/contenttunel_common.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Navigation/Main/detallePopUp.js (en_US) */
//Variable global para el stock del producto
stocks = null;
//Variable global para los detalles del producto
detalle = null;
//variable global en la que se almacenan los src de las imagenes de zoom
var zoomImgSrc = new Array();
//variable global en la que se almacenan los src de las imagenes de megazoom
var megaZoomImgSrc = new Array();
//separador para reemplazar en la cadena de la url del servlet que proporciona el json de productos ya vistos
var LASTVIEW_SEPARATOR = '_lastProducView_';
//Variable para saber el ndice del zoom
var current_zoom = 0;
//Variable para el fading del zoom
var fading = false;
var currentViewed;


//variable para comprobar si el producto tiene back soon
var isBackSoon = 'false';
var isComingSoon = 'false';
var listaSkuBackSoon = '';
var listaSkuComingSoon = '';
var hasBackSoon = 'false';
var hasComingSoon = 'false';
var skuBackSoonArray = new Array();
var skuComingSoonArray = new Array();
/**
 * Metodo que carga los datos generales del producto
 */
function loadMetadataPopUp(data) {

    //Llamada ajax que recupera y parsea a json la url pasada
    detalle = data;
    //seteo nombre del producto
    $('#title_detail').html(data.name);
    //seteo de la referencia
    $('#reference').html(Messages.reference + data.ref);
    //Seteo del precio
    $('#price_detail').html(data.curPrice);
    //Seteo del precio rebajado
    $('#price_detail_sale').html((data.oldPrice != '') ? data.oldPrice : '');
    //seteo de la descripcion
    $('#principal_desc').prepend(data.desc);

    //miro si el producto tiene imagen 3D.
    if(data.urlImg3D != null && data.urlImg3D != '') {
        productImg3D = true;
        urlImg3D = DUTTI_STATIC_CONTENT_PATH + data.urlImg3D;
        zoomImg3D = DUTTI_STATIC_CONTENT_PATH + data.zoomImg3D;
    } else {
        productImg3D = false;
        urlImg3D = '';
        zoomImg3D = '';
    }


    //Comprobacion de si existe descripcion secundaria
    if(data.desc2 != null && data.desc2 != '') {
        //$('#secondary_desc').prepend('<br>' + data.desc2);
        $('#insert_desc').prepend('<p>' + data.desc2 + '</p>');
        $('#secondary_desc').after('<a id="info_deploy" href="javascript:void(0)" onClick="extradata(\'secondary_desc\',$(this));" style="color:#333">'+Messages.moreInfo+'</a>');
    }

    //Composicion
    var exterior = '<li class="titulo">'+Messages.exterior+'</li>';
    var mostrarExterior = false;
    var lining = '<li class="titulo">'+Messages.lining+'</li>';
    var mostrarLining = false;
    var interior = '<li class="titulo">'+Messages.interior+'</li>';
    var mostrarInterior = false;
    $.each(data.composition, function(i, composite) {
        switch(checkComposite(composite.identifier)) {
            case 1:
                mostrarExterior = true;
                exterior += '<li><span>' + composite.percent + '%</span> ' + composite.component + '</li>';
                break;
            case 2:
                mostrarLining = true;
                lining += '<li><span>' + composite.percent + '%</span> ' + composite.component + '</li>';
                break;
            case 3:
                mostrarInterior = true;
                interior += '<li><span>' + composite.percent + '%</span> ' + composite.component + '</li>';
                break;
        }
    });
    $('#composition_detail').append(((mostrarExterior) ? exterior : '') + ((mostrarLining) ? lining : '') + ((mostrarInterior) ? interior : ''));

    //Cuidado
    $.each(data.care, function(j, cuidado) {
        $('#cuidados_detail').append('<li><img src="' + cuidado.image + '" /><p>' + cuidado.desc + '</p></li>');
    });

    //Colores
    var colores = '';
    $.each(data.colors, function(k, col) {
        colores += ('<img src = "' + col.cutColor + '"color="' + col.code + '" id_color="' + col.idColor + '" rel="' + col.nameColor + '" class="color_detail tooltip' + ((k == 0) ? ' active' : '') + '" />');
    });
    $('#color_list').html(colores);

    //Se cargan las tallas e imagenes del primer color de la lista. Si se modifica el color se actualizara con otra funcion
    var color = data.colors[0];
    if(color){
        //Tallas y botones
        $.xajax({
            url: data.linkStock,
            dataType: 'json',
            success: function(dataStock) {
                stocks = dataStock;

                $.each(color.sizes, function(j, s) {
                    s.hasStock = getInventorySku(stocks.items, s.id);
                });

                var tallas = '';
                tallasSinHermanados = getQuitandoTallasHermanadas(data.colors,stocks);
                // atributo 
                showProductNoStock = data.showProductNoStock;
                // a nivel de producto
                isBackSoon = data.isBackSoon;
                // a nivel de skus
                listaSkuBackSoon = data.listaSkuBackSoon;
                if (!listaSkuBackSoon) {
                    listaSkuBackSoon = "";
                }else{
                    listaSkuBackSoon = getSkus(listaSkuBackSoon);
                }

                isComingSoon = data.isComingSoon;
                listaSkuBackSoon = $.trim(listaSkuBackSoon);

                listaSkuComingSoon = data.listaSkuComingSoon;
                if (!listaSkuComingSoon) {
                    listaSkuComingSoon = "";
                }else{
                    listaSkuComingSoon = getSkus(listaSkuComingSoon);
                }
                listaSkuComingSoon = $.trim(listaSkuComingSoon);

                if(tallasSinHermanados[color.idColor] != null){
                    $.each(tallasSinHermanados[color.idColor], function(l, talla) {
                        if(tallasSinHermanados[color.idColor].length > 1) {
                            tallas += printSize(talla, stocks,isBackSoon,listaSkuBackSoon,showProductNoStock,false,isComingSoon, listaSkuComingSoon);
                        }else{
                            tallas += printSize(talla, stocks,isBackSoon,listaSkuBackSoon,showProductNoStock,true,isComingSoon, listaSkuComingSoon);
                        }


                        var listaSkuBackSoonArray  = listaSkuBackSoon.split(',');
                        var skuBackSoon = 'false';
                        for (i = 0; i < listaSkuBackSoonArray.length; i++) {
                            if (( parseInt(listaSkuBackSoonArray[i]) == parseInt(talla.id)))
                                skuBackSoon = 'true';
                        }
                        if ((isBackSoon == 'true') || (skuBackSoon == 'true')){
                            hasBackSoon = 'true';
                        }

                        var listaSkuComingSoonArray = listaSkuComingSoon.split(',');
                        var skuComingSoon = 'false';
                        for (i = 0; i < listaSkuComingSoonArray.length; i++) {
                            if (( parseInt(listaSkuComingSoonArray[i]) == parseInt(talla.id))) {
                                skuComingSoon = 'true';
                            }
                        }

                        if ((isComingSoon == 'true') || (skuComingSoon == 'true')) {
                            hasComingSoon = 'true';
                        }


                    });
                }
                $('#size_list').html(tallas);
                //Efectos sobre el titulo de TALLAS
                sizeTriggerBinds();
                //Efectos sobre las tallas
                sizeBinds(color.sizes);
                //Chequeo del stock del producto
                checkOutStock(stocks);
                //A?ade tooltip a las tallas sin stock
                tooltipBinds();
                /* si tienes tallas agotadas */
                if ($('.soon').length) {
                    /* si el producto tiene el atributo BACKSOON */
                    if (hasBackSoon == 'true') {

                        if (document.getElementById('textToolTip')) {
                            var texto = document
                                .getElementById('textToolTip').value;
                            $('#tooltip_stock').html(texto);
                        }

                        $('#tooltip_stock').appendTo('body');
                        setTimeout(function() {
                            $('#tooltip_stock').css(
                                {
                                    'left' : $('.soon:eq(0)')
                                        .offset().left - 10,
                                    'top' : $('.soon:eq(0)')
                                        .offset().top + 15
                                }).fadeIn();
                            setTimeout('$("#tooltip_stock").fadeOut()',
                                3000);
                        }, 1000)
                        $('.soon')
                            .bind(
                            {
                                'mouseenter' : function() {
                                    $('#tooltip_stock')
                                        .css(
                                        {
                                            'left' : $(
                                                this)
                                                .offset().left - 10,
                                            'top' : $(
                                                this)
                                                .offset().top + 15
                                        })
                                        .show();
                                },
                                'mouseleave' : function() {
                                    $('#tooltip_stock')
                                        .css(
                                        {
                                            'left' : $(
                                                this)
                                                .offset().left - 10,
                                            'top' : $(
                                                this)
                                                .offset().top + 15
                                        })
                                        .hide();
                                }
                            })
                    } else {
                        $('#tooltip_stock').empty();

                    }

                } else if ($('.comingSoon').length) {
                    if (hasComingSoon == 'true') {

                        if (document
                                .getElementById('textToolTipComingSoon')) {
                            var texto = document
                                .getElementById('textToolTipComingSoon').value;
                            $('#tooltip_stock').html(texto);
                        }

                        $('#tooltip_stock').appendTo('body');

                        setTimeout(function() {
                            $('#tooltip_stock').css(
                                {
                                    'left' : $('.comingSoon:eq(0)')
                                        .offset().left - 10,
                                    'top' : $('.comingSoon:eq(0)')
                                        .offset().top + 15
                                }).fadeIn();
                            setTimeout('$("#tooltip_stock").fadeOut()',
                                3000);
                        }, 1000)
                        $('.comingSoon')
                            .bind(
                            {
                                'mouseenter' : function() {
                                    $('#tooltip_stock')
                                        .css(
                                        {
                                            'left' : $(
                                                this)
                                                .offset().left - 10,
                                            'top' : $(
                                                this)
                                                .offset().top + 15
                                        })
                                        .show();
                                },
                                'mouseleave' : function() {
                                    $('#tooltip_stock')
                                        .css(
                                        {
                                            'left' : $(
                                                this)
                                                .offset().left - 10,
                                            'top' : $(
                                                this)
                                                .offset().top + 15
                                        })
                                        .hide();
                                }
                            })
                    } else {
                        $('#tooltip_stock').empty();

                    }
                } else {
                    $('#tooltip_stock').empty();

                }

                tooltipNoStock();



            }
        });



        //Thumbs
        //Thumbs
        var thumbs = printImageByColor(color);
        $('#p_thumbs').prepend(thumbs);

        //Actualizamos los eventos sobre las partes dinamicas de la pagina (colores, thumbs,...)
        updateBinds();

        $('#detail').fadeIn();
        colorWidth = $('#compra').width();
        colorTitleWidth = $('#color_title').innerWidth();
        $("#color_title").css({'width':colorTitleWidth+'px'});
        $("#color_list").css({'width':( colorWidth - 10 - colorTitleWidth)+'px'});
        $("#color_marker").css({'left':(colorTitleWidth+11 )+'px'});

        //Posiciono correctamente el div del flash para que se vea correctamente.
        $($('#flashContainer')).prependTo('#product_detail');


        if ($.browser.msie && $.browser.version == 7) {
            $('#flashContainer').css({'margin-top': '-20px', 'position': 'absolute', 'left': '0px'});
        } else {
            $('#flashContainer').css({'margin-top': '-20px', 'position': 'absolute'});
        }

    }

}
;
/* END /DuttiNEWStorefrontAssetStore/js/Navigation/Main/detallePopUp.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/seleccionarDropPoint.js (en_US) */
var mapa = null;
var resultList = null;
var marcadores = null;
var seleccionarDropPointParams = null;

function initSeleccionarDropPoint(params){
    _initSeleccionarDropPoint(params);
}

function _initSeleccionarDropPoint(params){
    var controle = this;
    resultList = document.getElementById("resultList");
    seleccionarDropPointParams=params;

    var locDropPointFrom = $('#buscarDropPointFrom');

    locDropPointFrom.submit(function(e){
        e.preventDefault();
    });

    // Inicializamos mapa
    setTimeout(function() {
        if (initializeMapDropPoint()){
            $(".btnDP").click(function() {

                controle.resultList.innerHTML = "";

                var paisISO = $('input[name="paisISO"]').attr('value');

                var locDropPointFrom = $('#buscarDropPointFrom');


                if (paisISO == 'ES') {
                    var location = locDropPointFrom.find('input[name=location]');
                    Inditex.trackEvent( categoryEvent,"Envio_Droppoint_Buscador_Buscar",location.val(),true);
                    getCorderMapDropPoint(location.val(), paisISO, function(longitude, latitude){

                        jQuery.xajax({
                            url: locDropPointFrom.attr("action") + '&longitude=' + longitude + '&latitude=' + latitude,
                            type: 'post',
                            success: function(respHtml) {
                                var data = getResponseJSON(respHtml);

                                loadJSONPhysicalDropPoint(data);
                            }
                        });
                    });

                } else {
                    var zipCode = locDropPointFrom.find('input[name=zipcode]');
                    Inditex.trackEvent( categoryEvent,"Envio_Droppoint_Buscador_Buscar",zipCode.val(),true);
                    jQuery.xajax({
                        url: locDropPointFrom.attr("action") + "&zipCode=" + zipCode.val(),
                        type: 'post',
                        success: function(respHtml) {
                            var data = getResponseJSON(respHtml);

                            loadJSONPhysicalDropPoint(data);
                        }
                    });
                }
            });
        }
    }, 500);

    if ($('input[name=location]')){
        $('input[name=location]').keypress(function(e){
            if (e.keyCode == 13){
                e.preventDefault();
                $(".btnDP").trigger('click');
            }
        });
    }

    if ($('input[name=zipcode]')){
        $('input[name=zipcode]').keypress(function(e){
            if (e.keyCode == 13){
                e.preventDefault();
                $(".btnDP").trigger('click');
            }
        });
    }

}


function initializeMapDropPoint() {
    var canvas = document.getElementById("map_canvas");
    if (canvas!=null){
        var paisISO = $('input[name="paisISO"]').attr('value');
        var address = $('input[name="pais"]').attr('value');
        Inditex.initGoogleMaps('map_canvas', paisISO,address, function(aMap) {
            mapa=aMap;
            paintMapDropPoint(aMap);
        },"icono-dutti");
        return true;
    } else{
        alert("Imposible inicializar el mapa. No existe el elemento 'map_canvas'");
        return false;
    }
}


/** Funci?n para encontrar la latitud y longitud del direcci?n que se especifica
 *  Como la funcion geocode de googel es asincrona tengo que pasar la funcion que
 *  queremos que se ejecute despues de encontrar la longitud y latitud.
 *
 *  Es una forma de hacer sincorono el metodo geocode.
 * **/
function getCorderMapDropPoint(addressJS, paisISO, callback) {
    //alert(paisISO);
    //alert(address);

    //Esto si es necesario.  Ya que canarias googel map retorna  como region "ES" no "ESCN" que propia de Inditex
    if (paisISO == "ESCN" || paisISO == "IC") {
        paisISO = "ES";
    }

    Inditex.getGoogleCoords(
        paisISO,
        addressJS,
        function(aResult) {
            if (aResult) {
                var latitud = aResult.geometry.location.lat();
                var longitud = aResult.geometry.location.lng();
                callback.call(this, longitud,latitud);
                encontrado = 1;
            }
        }
    );

}


function paintMapDropPoint(aMap) {

    var gs = [{
        stylers : [{
            saturation : -100
        }]
    }];
    aMap.iMap.mapTypes.set('gs', new google.maps.StyledMapType(gs, {
        map: aMap.iMap,
        name: 'Grayscale'
    }));
    aMap.iMap.setMapTypeId('gs');

    //var latlng = new google.maps.LatLng(latitude, longitude);
    var gst = new google.maps.StyledMapType(gs, {
        name : "Grayscale"
    });
    var gs = [{
        stylers : [{
            saturation : -100
        }]
    }];
}


/** Funcion que se encaraga de cargar un JSON con puntos DropPoint mas proximos al zipcode
 * **/
function loadJSONPhysicalDropPoint(dataDropPoint) {
    Inditex.trackPage( "Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Droppoint/Buscador/Resultados"+extraPageview,true);
    //$("#dvlistad").slideUp('slow');
    //tiendas = new Array();
    var latlng = null;
    $("#dvlistad").show();
    // $(window).trigger('resize');
    //$(window).resize();
    var geolocalizar = false;
    $.each(dataDropPoint, function(l, dropPoint) {

        if (dropPoint.latitude != null && dropPoint.longitude != null){
            geolocalizar = true;
        }

        //tiendas.push(tienda);
        //Cargo la informacion de los DropPoint
        resultList.appendChild(paintInfoDropPoint(dropPoint));

        mapa.addMark(
            l,
            dropPoint.latitude,
            dropPoint.longitude,
            "");


//	    var tiendaClickada = tienda;
//		google.maps.event.addListener(marcador, 'click', function(){
//			onClickMarcador(marcadorActual, tiendaClickada);
//		});

//		 google.maps.event.addListener(mapa, 'zoom_changed', hideTiendaTooltip);
//		 google.maps.event.addListener(mapa, 'resize', hideTiendaTooltip);
//		 google.maps.event.addListener(mapa, 'projection_changed', hideTiendaTooltip);
//		 google.maps.event.addListener(mapa, 'dragstart', hideTiendaTooltip);
//		 google.maps.event.addListener(mapa, 'center_changed', hideTiendaTooltip);
//		 google.maps.event.addListener(mapa, 'bounds_changed', hideTiendaTooltip);




        $(window).resize();
    });
    $(window).resize();

    if (geolocalizar){
        mapa.focus();
    }
}

function inicializoMarcadores(){
    //$(detalleTiendaDireccion).html(''); //Borro el detalle
    if (marcadores!=null){
        for (var i = 0; i < marcadores.length; i++ ) {
            marcadores[i].setMap(null);
        }
    }

    marcadores = new Array();
}


function paintInfoDropPoint(dropPoint) {
    var linea = document.createElement("li");
    linea.id = dropPoint.identifier;
    linea.className = "tienda columns";
    var span = document.createElement("span");
    span.className="spnsel";
    span.innerHTML = dropPoint.name;

    $(linea).click(function() {
        verDetalleDropPoint(dropPoint, linea);
    });
    //span.appendChild(link);
    linea.appendChild(span);
    // addResulLine.

    return linea;
}

function verDetalleDropPoint(dropPoint, linea) {

    var telf = null;
    if (dropPoint.telephone != 'null'){
        telf = dropPoint.telephone + "<br />";
    }else{
        telf = '' + "<br />";
    }

    var mond = dropPoint.openingHours.close;
    if (dropPoint.openingHours.mondayTimetable != ''){
        mond = dropPoint.openingHours.mondayTimetable;
    }

    var tues = dropPoint.openingHours.close;
    if (dropPoint.openingHours.tuesdayTimetable != ''){
        tues=dropPoint.openingHours.tuesdayTimetable;
    }

    var wedn = dropPoint.openingHours.close;
    if (dropPoint.openingHours.wednesdayTimetable != ''){
        wedn=dropPoint.openingHours.wednesdayTimetable;
    }

    var thur = dropPoint.openingHours.close;
    if (dropPoint.openingHours.thursdayTimetable != ''){
        thur=dropPoint.openingHours.thursdayTimetable;
    }

    var fri = dropPoint.openingHours.close;
    if (dropPoint.openingHours.fridayTimetable != ''){
        fri=dropPoint.openingHours.fridayTimetable;
    }

    var sat = dropPoint.openingHours.close;
    if (dropPoint.openingHours.saturdayTimetable != ''){
        sat=dropPoint.openingHours.saturdayTimetable;
    }

    var sun = dropPoint.openingHours.close;
    if (dropPoint.openingHours.sundayTimetable != ''){
        sun=dropPoint.openingHours.sundayTimetable;
    }

    var html = "<li><span>"
        + dropPoint.name + "<br />"
        + dropPoint.homeNo + " " + dropPoint.street + " "  + dropPoint.postCode + " " + dropPoint.city + "<br />"
        + telf
        + "HORARIO: <br />"
        + "&nbsp&nbsp&nbsp" + Messages.LUNES + ":" + mond + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.MARTES + ":" + tues + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.MIERCO + ":" + wedn + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.JUEVES + ":" + thur + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.VIERNES + ":" + fri + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.SABADO + ":" + sat + "<br />"
        + "&nbsp&nbsp&nbsp" + Messages.DOMINGO + ":" + sun
        + "</span></li>";
    html+= '<li><a id="verEnMapa" onclick="verEnMapaDropPoint('+ dropPoint.latitude + ','+ dropPoint.longitude + ')" href="#">' + Messages.showStoreMap + '</a></li>';

    var divDetalleDropPoint = $('#detalleDropPoint');
    divDetalleDropPoint.html(html);

    var divAddDropPoint = document.createElement("div");
    divAddDropPoint.className="boton3";
    var linkAddDropPoint = document.createElement("a");
    linkAddDropPoint.href="javascript:void(0)";
    linkAddDropPoint.id="seleccionarDropPointBtn";
    linkAddDropPoint.className = "acc_butt tienda";
    linkAddDropPoint.innerHTML= Messages.selectDropPoint;
    $(linkAddDropPoint).click(function(){
        seleccionarDropPointParams.onAddDropPoint(dropPoint);
        Inditex.trackEvent( categoryEvent,"Envio_Droppoint_Buscador_Seleccionar",dropPoint.identifier,true);
        $('#close_modal').click();
    });
    divAddDropPoint.appendChild(linkAddDropPoint);

    $('.dvlistadder').empty();
    $('.dvlistadder').append(divDetalleDropPoint);
    $('.dvlistadder').append(divAddDropPoint);

    $(".tienda").removeClass("tiendaSelected");
    $(linea).addClass("tiendaSelected");

    //para ajustar el scroll.
    if ($('#scrollable')) {
        setScroll();
    }

    $('#detalleDropPoint').show();
}


function verEnMapaDropPoint(latitude, longitude){
    if (Inditex)
        Inditex.trackEvent('Tiendas','ver_en_mapa');

    mapa.panTo(new google.maps.LatLng(latitude, longitude));
    //mapa.setZoom(15);
};
/* END /DuttiNEWStorefrontAssetStore/js/seleccionarDropPoint.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_compra_fisica.js (en_US) */


function loadPaso_TRFisica(){


    $('#select-inner-name-Importe').html($('#importe_dd option:eq(0)').html());
    $('#condiciones_check').fadeTo(0,0);

    $('#compra_fisica_form').validate({
        debug: true,
        submitHandler: function(form) {
            var catEntryId =  $('#f_itemId').val();
            var senderName =  $('#senderName').val();
            var receiverName =  $('#receiverName').val();
            var receiverPhone =  $('input[name=receiverPhone]').val();
            var message =  "";
            var receiverEmail =  "";

            var itemCard = {
                "catEntryId":catEntryId,
                "quantity": 1,
                "senderName": senderName,
                "receiverName":receiverName,
                "receiverPhone": receiverPhone,
                "message": message,
                "receiverEmail": receiverEmail,
                "onSuccess" : function(aJson) {
                    if(!aJson.errorKey){
                        Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_ok',null,true);
                        Inditex.drawHeader();
                        $('a.add_butt span').toggle(); //Cambio el texto del boton a?adir
                        $('a.final').children('span').toggle();
                        $('a.add_tram').fadeIn();  //Muestro el boton de tramitar
                        $('#compra_virtual_form').resetForm();
                        var i, array = giftcardJSON.dataTR.cards[0].items, length = array.length;
                        for( i=0; i < length; i++) {
                            if(array[i].id == precio){
                                Inditex.trackPage("Cesta_de_Compra/Anadir_Cesta/" + array[i].partNumber);
                                break;
                            }
                        }
                    }else{
                        Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_error',Inditex.codeError(aJson.errorKey,aJson.errorMessage),true);
                        Inditex.xOpenErrorPopUp(350,200, aJson.errorMessage);
                    }
                },
                "onFailure" : function(aStatus) {
                    Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_error',Inditex.codeError("ERROR","ERROR"),true);
                    Inditex.xOpenErrorPopUp(350,200);
                }
            }

            $('a.add_butt_tr').children('span').toggle(); //Cambio el texto del boton a?adir (a?adiendo)
            Inditex.restOrderAddPhysicalGiftCard(itemCard);
        },
        groups: {
            movil: "movil_prefix receiverPhone"
        },
        messages:{
            condiciones: Messages.aceptarCondicionesCompra
        }
    })

    // Hay que crear la Cookie si no existe, por el hecho de que se puede llegar a esta JSP directamente
    // desde el comando ItxSocialShareCmd
    if (getCookie('WC_DuttiStore')== null){

        setCookie("WC_DuttiStore", '${iStoreId},${iLangId},${iCatalogId}',365, '/' );
    }

    initializeSocialNetwork(0);

    loadLikes(MerchandisingAssociationsJSON);
    loadMetadataTarjetaFisica(giftcardJSON);
    nlInputBinds();
    zoomBinds();
    cestaBinds(giftcardJSON);
    $('#multidrop-undefined').width(278);
    if(!isIPad()){
        jQuery(window).bind('resize', function() {
            positions2();
        });
    }

    positions2();
    $().ready(function() {

        if(isIPad()){
            $("#content").removeClass("center");
            $(".product_data").css({'height':'465px'});
            $(".aux_cont").css({'height':'100px'});
            if (!isIPad_5()){
                setTimeout(function(){
                    $('body').css({'background':'url("'+DUTTI_STATIC_CONTENT_PATH+'/img/fondo_parrilla.png") repeat-y scroll 0 0 #EDEAE6'});
                },1000);
            }
        }
    });
    setGlobalProperties(3000,1000,500);
}


function loadMetadataTarjetaFisica(data) {

    //Llamada ajax que recupera y parsea a json la url pasada
    detalle = data.dataTR.cards[0];


    var mfPartNumbers = {};
    for (var i = 0; i < detalle.items.length; i++) {
        if (!mfPartNumbers[detalle.items[i].mfPartNumber]) {
            mfPartNumbers[detalle.items[i].mfPartNumber] = [];
        }

        mfPartNumbers[detalle.items[i].mfPartNumber].push(detalle.items[i]);
    }

    var uniqueItems = [];
    var freeItems = [];
    for (var i in mfPartNumbers) {
        if (mfPartNumbers[i].length == 1) {
            uniqueItems.push(mfPartNumbers[i][0]);
        } else {
            freeItems.push(mfPartNumbers[i].sort(function(a, b) {
                return a.price - b.price;
            }));
        }
    }

    uniqueItems.sort(function(a, b) {
        return a.price - b.price;
    });


    var tallas = '';
    if (uniqueItems){
        $.each(uniqueItems, function(l, talla) {
            tallas +=
                '<option value="' + talla.id + '" >' +   talla.price + '</option>';
        });
    }
    if (freeItems[0]){
        $.each(freeItems[0], function(l, talla) {
            tallas +=
                '<option value="' + talla.id + '" >' +   talla.price + '</option>';
        });
    }
    $('#importe_dd').html(tallas);


    //A?ade tooltip a las tallas sin stock
    tooltipBinds();
    selectBinds(100,'%');
    $('.md-select-ul-li').each(function(index, value){
        if (index == 0){
            var obj = $(this);
            var v = $(this).attr('v');
            var s = $(this).attr('s');
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').val(v);
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').change();
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').click();
            obj.parent().parent().parent().parent().parent().find('#select-inner-name-'+s).html($(this).html());
            $(this).parent().parent().parent().parent().parent().find('.enclosing').slideUp('fast');
            $(this).parent().slideUp('slow', function(){
                obj.removeClass('active');
                folding = false;
            });
        }

    });

    var thumbs = '';
    $.each(detalle.images, function(m, image) {
        thumbs += printImage(image, (m == 0) ? true : false, m, false);
        $("img_marker").css('display','block');
    });
    $('#p_thumbs').prepend(thumbs);


    //Generamos los href de los botones anterior y siguiente si fuera necesario
    loadNavigation(data.productId);

    //Actualizamos los eventos sobre las partes dinamicas de la pagina (colores, thumbs,...)
    updateBinds();

    loadLastProductGitFisca(data);

    $('#detail').fadeIn();
    $('#backgroundimage').attr('id', 'backgroundimage2');


}

/** Funcion que se encarga de mostrar los ultimos productos vistos ***/
function loadLastProductGitFisca(data) {
    if (data.categoryId != null && data.categoryId != 'undefined'
        && data.productId != null && data.productId != 'undefined') {
        Inditex.getRestCatalogProductDetail({
            catalogId: Inditex.iCatalogId,
            categoryId: data.categoryId,
            productId: data.productId,
            onSuccess: function(aProductJSON) {
                Inditex.addProductToLastProductList(aProductJSON, function() {
                    loadViewed();
                });
            }
        });
    }
}


function send_tr_form_fisica(){
    if($('#compra_fisica_form').valid()){
        Inditex.trackEvent( 'Tarjeta_regalo','anadir_tarjeta_cesta','Fisica_'+$('#importe_dd option:selected').text(),true);
        /* TR seleccionada*/
        var idItemGiftCard = $('#importe_dd').val();
        $('#f_itemId').attr('value', idItemGiftCard);
        var tlfCompleto = $('#movil_prefix').attr('value').concat(" ").concat($('#receivedPhone').val());
        $("input[name=receiverPhone]").attr('value', tlfCompleto);
        //$('#compra_fisica_form').submit(); 
        Inditex.orderManage({'form':$('#compra_fisica_form')});
    }
}

function checkConditions() {
    var check = $('#condiciones_check');
    var check_a = $('#check_');
    if (check_a.hasClass("active")) {
        check.removeClass("required");
    } else {
        check.addClass("required");
    }

}

$(document).ready(function(){

})


;
/* END /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_compra_fisica.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_compra_virtual.js (en_US) */



function loadMetadataTarjetaVirtual(data) {

    //Llamada ajax que recupera y parsea a json la url pasada
    detalle = data.dataTR.cards[0];


    var mfPartNumbers = {};
    for (var i = 0; i < detalle.items.length; i++) {
        if (!mfPartNumbers[detalle.items[i].mfPartNumber]) {
            mfPartNumbers[detalle.items[i].mfPartNumber] = [];
        }

        mfPartNumbers[detalle.items[i].mfPartNumber].push(detalle.items[i]);
    }

    var uniqueItems = [];
    var freeItems = [];
    for (var i in mfPartNumbers) {
        if (mfPartNumbers[i].length == 1) {
            uniqueItems.push(mfPartNumbers[i][0]);
        } else {
            freeItems.push(mfPartNumbers[i].sort(function(a, b) {
                return a.price - b.price;
            }));
        }
    }

    uniqueItems.sort(function(a, b) {
        return a.price - b.price;
    });


    var tallas = '';
    if (uniqueItems){
        $.each(uniqueItems, function(l, talla) {
            tallas +=
                '<option value="' + talla.id + '" >' +   talla.price + '</option>';
        });
    }
    if (freeItems[0]){
        $.each(freeItems[0], function(l, talla) {
            tallas +=
                '<option value="' + talla.id + '" >' +   talla.price + '</option>';
        });
    }
    $('#importe_dd').html(tallas);



    //A?ade tooltip a las tallas sin stock
    tooltipBinds();
    selectBinds(48,'%');
    $('.md-select-ul-li').each(function(index, value){
        if (index == 0){
            var obj = $(this);
            var v = $(this).attr('v');
            var s = $(this).attr('s');
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').val(v);
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').change();
            obj.parent().parent().parent().parent().parent().parent().parent().find('select[title='+s+']').click();
            obj.parent().parent().parent().parent().parent().find('#select-inner-name-'+s).html($(this).html());
            $(this).parent().parent().parent().parent().parent().find('.enclosing').slideUp('fast');
            $(this).parent().slideUp('slow', function(){
                obj.removeClass('active');
                folding = false;
            });
        }

    });

    var thumbs = '';
    $.each(detalle.images, function(m, image) {
        thumbs += printImage(image, (m == 0) ? true : false, m, false);
    });
    $('#p_thumbs').prepend(thumbs);

    //Generamos los href de los botones anterior y siguiente si fuera necesario
    loadNavigation(data.productId);

    //Actualizamos los eventos sobre las partes dinamicas de la pagina (colores, thumbs,...)
    updateBinds();

    loadLastProductGitVirtual(data);

    $('#detail').fadeIn();
    $('#backgroundimage').attr('id', 'backgroundimage2');


}


/** Funcion que se encarga de mostrar los ultimos productos vistos ***/
function loadLastProductGitVirtual(data) {
    if (data.categoryId != null && data.categoryId != 'undefined'
        && data.productId != null && data.productId != 'undefined') {
        Inditex.getRestCatalogProductDetail({
            catalogId: Inditex.iCatalogId,
            categoryId: data.categoryId,
            productId: data.productId,
            onSuccess: function(aProductJSON) {
                Inditex.addProductToLastProductList(aProductJSON, function() {
                    loadViewed();
                });
            }
        });
    }
}


function loadPaso_TRVirtual(){

    $('#select-inner-name-Importe').html($('#importe_dd option:eq(0)').html());
    $('#condiciones_check').fadeTo(0,0)
    $('#compra_virtual_form').validate({
        debug: true,
        submitHandler: function(form) {
            //Recuperamos el sku del importe libre
            var dat = $('#day').val();
            var mon = $('#month').val();
            var year = $('#year').val();
            var hours = $('#hour').val();
            var minutes =$('#minute').val();


            var catEntryId =  $('#f_itemId').val();
            var senderName =  $('#senderName').val();
            var receiverName =  $('#receiverName').val();
            var receiverPhone =  $('input[name=receiverPhone]').val();
            var message =  $('#message').val();
            var receiverEmail =  $('#receiverEmail').val();

            var itemCard = {
                "catEntryId":catEntryId,
                "quantity": 1,
                "senderName": senderName,
                "receiverName":receiverName,
                "receiverPhone": receiverPhone,
                "message": message,
                "receiverEmail": receiverEmail,
                "year": year,
                "month": mon,
                "day": dat,
                "hour": hours,
                "minute": minutes,
                "onSuccess" : function(aJson) {
                    if(!aJson.errorKey){
                        Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_ok',null,true);
                        Inditex.drawHeader();
                        $('a.add_butt span').toggle(); //Cambio el texto del boton a?adir
                        $('a.final').children('span').toggle();
                        $('a.add_tram').fadeIn();  //Muestro el boton de tramitar
                        $('#compra_virtual_form').resetForm();
                        var i, array = giftcardJSON.dataTR.cards[0].items, length = array.length;
                        for( i=0; i < length; i++) {
                            if(array[i].id == precio){
                                Inditex.trackPage("Cesta_de_Compra/Anadir_Cesta/" + array[i].partNumber);
                                break;
                            }
                        }
                    }else{
                        Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_error',Inditex.codeError(aJson.errorKey,aJson.errorMessage),true);
                        Inditex.xOpenErrorPopUp(350,200, aJson.errorMessage);
                    }
                },
                "onFailure" : function(aStatus) {
                    Inditex.trackEvent( 'Tarjeta_regalo','formulario_tarjeta_ envio_error',Inditex.codeError("ERROR","ERROR"),true);
                    Inditex.xOpenErrorPopUp(350,200);
                }
            }

            $('a.add_butt_tr').children('span').toggle();
            Inditex.restOrderAddVirtualGiftCard(itemCard);



        },
        groups: {
            movil: "movil_prefix receiverPhone"
        },
        messages:{
            condiciones: Messages.aceptarCondicionesCompra
        },
        rules: {
            receiverEmailConfirmation : {
                equalTo: "#receiverEmail"
            }
        }

    })

    // Hay que crear la Cookie si no existe, por el hecho de que se puede llegar a esta JSP directamente
    // desde el comando ItxSocialShareCmd
    if (getCookie('WC_DuttiStore')== null){

        setCookie("WC_DuttiStore", '${iStoreId},${iLangId},${iCatalogId}',365, '/' );
    }

    initializeSocialNetwork(0);

    loadLikes(MerchandisingAssociationsJSON);
    loadMetadataTarjetaVirtual(giftcardJSON);
    nlInputBinds();
    zoomBinds();
    cestaBinds(giftcardJSON);


    if(!isIPad()){
        jQuery(window).bind('resize', function() {
            positions2();
        });
    }
    positions2();
    $().ready(function() {

        if(isIPad()){
            $("#content").removeClass("center");
            $(".product_data").css({'height':'500px'});
            $(".aux_cont").css({'height':'100px'});
            if (!isIPad_5()){
                setTimeout(function(){
                    $('body').css({'background':'url("'+DUTTI_STATIC_CONTENT_PATH+'/img/fondo_parrilla.png") repeat-y scroll 0 0 #EDEAE6'});
                },1000);
            }
        }
    });
    setGlobalProperties(3000,1000,500);
}

function send_tr_form_virtual(){
    if($('#compra_virtual_form').valid()){
        Inditex.trackEvent( 'Tarjeta_regalo','anadir_tarjeta_cesta','Ecard_'+$('#importe_dd option:selected').text(),true);
        /* TR seleccionada*/
        var idItemGiftCard = $('#importe_dd').val();
        $('#f_itemId').attr('value', idItemGiftCard);
        var tlfCompleto = $('#movil_prefix').attr('value').concat(" ").concat($('#receivedPhone').val());
        $("input[name=receiverPhone]").attr('value', tlfCompleto);
        //$('#compra_fisica_form').submit(); 
        Inditex.orderManage({'form':$('#compra_virtual_form')});
    }
}

function fixBoxesSize() {

    var divGiftBox = $('#gift_box');
    var divInnerGiftBox = $('#inner');

    var divGiftBoxSize = divGiftBox.height();
    var divInnerGiftBoxSize = parseInt(divInnerGiftBox.height());

    divGiftBox.height(divInnerGiftBoxSize+parseInt(100));


}

function loadDateHourPicker() {
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var isiPhone = navigator.userAgent.match(/iPhone/i) != null;
    if(isiPad || isiPhone){
        $('#datepicker').hide().attr('name' , '');
        $('#datepicker_html').show().attr('name' , 'datepicker');
        $('#timepicker').hide().attr('name' , '');
        $('#timepicker_html').show().attr('name' , 'timepicker');
    }
}

function checkConditions() {
    var check = $('#condiciones_check');
    var check_a = $('#check_');
    if (check_a.hasClass("active")) {
        check.removeClass("required");
    } else {
        check.addClass("required");
    }

}

$(document).ready(function(){
    $.validator.addMethod("fechaSuperior", fechaSuperior, Messages.afterTodayTime);
    setTimeout(function(){
        var today = new Date();
        var hoy = new Date();
        today.setFullYear(hoy.getUTCFullYear(),hoy.getUTCMonth(),hoy.getUTCDate());
        $('#datepicker').datepicker({
            dayNames: Messages.dayNames,
            dayNamesMin: Messages.dayNamesMin,
            monthNames: Messages.monthNames,
            monthNamesShort: Messages.monthNamesShort,
            dateFormat : 'dd-mm-yy',
            firstDay: 1,
            minDate : today,
            onSelect: function(dateText, inst) {
                $('#day').val(inst.selectedDay);
                $('#month').val(inst.selectedMonth + 1);
                $('#year').val(inst.selectedYear);

            }
        });
        $('#timepicker').timepicker({
            onSelect: function (dateText, inst){
                $('#hour').val(inst.hours);
                $('#minute').val(inst.minutes);
            }
        });
    }, 2000)

})

function fechaSuperior(value, element) {
    var today = new Date();
    var fechaEscogida = new Date($('#year').val(),$('#month').val(),$('#day').val(),$('#hour').val(),$('#minute').val());
    return fechaEscogida>today;
}

jQuery.extend(jQuery.validator.messages, {
    required: Messages.campoOblig,
    email: Messages.emailNovalido,
    equalTo: Messages.emailNoCoincide,
    digits: Messages.soloNumeros
});


;
/* END /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_compra_virtual.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_card_subhome.js (en_US) */
"use strict;"

function consulta_saldo_modal(){
    openGenericModal('includes/modales/giftSaldo.html')
}
function condiciones_gift_modal(){
    openGenericModal('includes/modales/giftCondiciones.html')
}
function activacion_gift_modal(){
    openGenericModal('includes/modales/giftActivacion.html')
}

$(document).ready(function(){


})







function show_saldo_avail(){
    if($('#trform').valid()){

        var valido = true;
        var cardNumberValue = $("#num_tr").val();
        var cardCvvValue = $("#tr_cvv").val();
        var captchaValue = $("#ct").val();
        var url = $("#iGiftCardTestJSONURL").attr("value").replace("_cardNumber_", cardNumberValue).replace("_cardCvv_", cardCvvValue);

        jQuery.xajax({
            url: url,
            type: 'post',
            data: "ct="+captchaValue+"&cardCvv="+cardCvvValue+"&cardNumber="+cardNumberValue,
            dataType: 'json',
            success: function(data) {

                $("#captcha").attr('src',$("#captchaURL").val()+'&t='+new Date().getTime());
                $('#saldo_info').hide();
                var cardNumberValue = $("#num_tr").val('');
                var cardCvvValue = $("#tr_cvv").val('');
                var captchaValue = $("#ct").val('');
                if(data=="" || data.cardStatusStr != '') {
                    openStaticModal(Messages.aviso, data.cardStatusStr, false);
                    Inditex.trackEvent( 'Tarjeta_regalo','consulta_de_saldo_envio_error',Inditex.codeError('StatusGC-generico','StatusGC-generico'),true);
                } else if (data.cardStatusStr=="" && data.cardBalance!=""){
                    var moneda = data.currencyCode;
                    var symbolPosition = '';

                    if (data.currencySuffix != undefined){
                        symbolPosition = data.currencySuffix.length==0;
                        if (!symbolPosition){
                            moneda = data.currencySuffix;
                        }else{
                            moneda= data.currencyPrefix;
                        }
                    }
                    //$('#saldo_avail').html(data.cardBalance+' '+data.currencyCode);
                    $('#saldo_avail').html(formatCurPrice(data.cardBalance,2,moneda));
                    $('#saldo_info').attr('style','font-size:14px; border: solid 1px #444; padding:4px;margin-top:125px;');
                    $('#saldo_info').show();
                    Inditex.trackEvent( 'Tarjeta_regalo','consulta_de_saldo_envio_ok',null,true);
                }
            }
        });
    }
}
$('#trform').validate({
    debug : true
})

function pintarErrorTR2 (campo,error){
    var cardCampo = $("#"+campo);
    $('#custom_error_'+campo).hide();
    $('<p />' , {
        'text' : error,
        'class' : 'error',
        'id' : 'custom_error_'+campo
    }).insertAfter(cardCampo);
    cardCampo.bind('keydown', function(){
        $('#custom_error_'+campo).hide();
        $(this).unbind();
    })
}



function activar(){
    if($('#formactiva').valid()){
        $('#formactiva').submit();
    }
}


function activate_card(){

    $('#formactiva').validate({
        debug: true,
        submitHandler: function(form) {
            jQuery.xajax({
                url:$(form).attr("action"),
                type: 'post',
                data: $(form).serialize(),
                dataType: 'json',
                success: function(data) {
                    $('#captchaErrorCode').hide();
                    Inditex.drawHeader();
                    $('#formactiva').resetForm();
                    $('#captcha').attr('src',$('#captchaURL').attr('value')+'&ts='+new Date().getTime());
                    openStaticModal(Messages.aviso,data.message, false);
                    if (data.status==1) {
                        Inditex.trackEvent( 'Tarjeta_regalo','activar_tarjeta_envio_ok',null,true);
                    } else {
                        Inditex.trackEvent( 'Tarjeta_regalo','activar_tarjeta_envio_error',Inditex.codeError(data.key,data.message),true);
                    }
                }
            });

        }

    });

}

function fixBoxesSize() {

    var divGiftBox = $('#gift_box');
    var divInnerGiftBox = $('#inner_gift_box');

    var divGiftBoxSize = divGiftBox.height();
    var divInnerGiftBoxSize = parseInt(divInnerGiftBox.height());

    divGiftBox.height(divInnerGiftBoxSize+parseInt(100));


}

function fixBoxesSizeSaldo() {

    var divGiftBox = $('#gift_box');
    var divInnerGiftBox = $('#inner');

    var divGiftBoxSize = divGiftBox.height();
    var divInnerGiftBoxSize = parseInt(divInnerGiftBox.height());

    divGiftBox.height(divInnerGiftBoxSize+parseInt(100));


}

;
/* END /DuttiNEWStorefrontAssetStore/js/GiftCard/gift_card_subhome.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/seleccionarTiendaFooter.js (en_US) */

var TOOLTIP_OFFSET = 80;
var tiendaSeleccionada = null;
var resultList = null;
var detalleTienda = null;
var tiendas = null;
var marcadores = null;
var resultList = null;
var mapa = null;
var seleccionarTiendaFooterParams = null;
var tiendaTooltip = null;
var createLinkSeleccionar = true;
var selectable = true;
var activemarker;
var paisISO;

function initSeleccionarTiendaFooter(params){
    _initSeleccionarTiendaFooter(params);
}

function _initSeleccionarTiendaFooter(params){
    // Para resetear la seleccion de tinda anterior
    // y que cuando se entre no aparezca un toolTip informativo de 
    // la ultima tienda seleccionada
    tiendaSeleccionada = null;
    tiendaTooltip = null;
    activemarker;

    var controle = this;

    if (params==null || params.onAddTienda==null){
        createLinkSeleccionar = false;
        $("#pais").removeAttr('disabled');
        params.onAddTienda = function(tienda){alert("Add Tienda "+tienda.name);}
    }
    else{
        $("#pais").attr('disabled', 'true');
        createLinkSeleccionar = true;
    }
    seleccionarTiendaFooterParams=params;
    resultList = document.getElementById("resultList");
    detalleTienda = document.getElementById("detalleTienda");
    resultList = document.getElementById("resultList");
    //$("#dvlistad").slideUp('slow');

    // Inicializamos mapa
    setTimeout(function() {
        if (initializeMap(true)){
            // Inicializamos los datos

            $(".acc_butt").click(function() {
                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex) {
                            Inditex.trackEvent('Tiendas','formulario',address);
                            if (params.origen=="footer") {
                                Inditex.trackEvent( 'Tiendas','Buscar',paisISO+"-"+address,true);
                            } else if (params.origen=="devolucion") {
                                Inditex.trackEvent( 'Mi_cuenta','Devolucion_buscador_tienda',paisISO+"-"+address,true);
                            } else if (params.origen=="tunel") {
                                Inditex.trackEvent( categoryEvent,'Envio_Tiendas_Buscador_Buscar',paisISO+"-"+address,true);
                            }
                        }
                    }
                    controle.getCorderMapFooter(address, paisISO, loadJSONPhysicalStoreFooter);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });

            $("#ubicacion").keypress(function(e) {
                if(e.keyCode == 13) {
                    $(".acc_butt").click();
                }
            });

            $("#buscarTiendasForm").bind("submit", function(event) {
                event.stopPropagation();
                event.preventDefault();

                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').attr('value');
                    if (address != ""){
                        if (Inditex)
                            Inditex.trackEvent('Tiendas','formulario',address);
                    }
                    controle.getCorderMapFooter(address, paisISO, loadJSONPhysicalStoreFooter);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });
        }
    }, 500);
}

function initSeleccionarTiendaFooterTunel(params){
    _initSeleccionarTiendaFooterTunel(params);
}

function _initSeleccionarTiendaFooterTunel(params){
    // Para resetear la seleccion de tinda anterior
    // y que cuando se entre no aparezca un toolTip informativo de 
    // la ultima tienda seleccionada
    tiendaSeleccionada = null;
    tiendaTooltip = null;

    var controle = this;

    createLinkSeleccionar = true;
    seleccionarTiendaFooterParams=params;
    resultList = document.getElementById("resultList");
    detalleTienda = document.getElementById("detalleTienda");
    resultList = document.getElementById("resultList");
    //$("#dvlistad").slideUp('slow');

    // Inicializamos mapa
    setTimeout(function() {
        if (initializeMap(true)){
            // Inicializamos los datos
            // $.getJSON("data/ItxPhysicalStoreListJSON.json", loadTiendas);
            $(".acc_butt").click(function() {
                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').val();
                    if (address != ""){
                        if (Inditex) {
                            Inditex.trackEvent('Tiendas','formulario',address);
                            if (params.origen=="footer") {
                                Inditex.trackEvent( 'Tiendas','Buscar',$.trim($("#pais option:selected").text())+"-"+address,true);
                            } else if (params.origen=="devolucion") {
                                Inditex.trackEvent( 'Mi_cuenta','Devolucion_buscador_tienda',$.trim($("#pais option:selected").text())+"-"+address,true);
                            } else if (params.origen=="tunel") {
                                Inditex.trackEvent( categoryEvent,'Envio_Tiendas_Buscador_Buscar',paisISO+"-"+address,true);
                            }
                        }
                    }
                    controle.getCorderMapFooter(address, paisISO, loadJSONPhysicalStoreFooterTunel, {origen: params.origen});

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });

            $("#ubicacion").keypress(function(e) {
                if(e.keyCode == 13) {
                    $(".acc_butt").click();
                }
            });

            $("#buscarTiendasForm").bind("submit", function(event) {
                event.stopPropagation();
                event.preventDefault();

                controle.resultList.innerHTML = "";
                $(detalleTienda).hide();
                setTimeout(function() {
                    //$('#buscarTiendasForm').submit();
                    paisISO = $("#pais option:selected").val();
                    var address = $('input[name="ubicacion"]').attr('value');
                    if (address != ""){
                        if (Inditex)
                            Inditex.trackEvent('Tiendas','formulario',address);
                    }
                    controle.getCorderMapFooter(address, paisISO, loadJSONPhysicalStoreFooter);

                    //var data = $(document.getElementById("buscarTiendasForm")).serialize();
                    //alert(data);

                }, 1000);
            });
        }
    }, 500);
}

/** Funci?n para encontrar la latitud y longitud del direcci?n que se especifica
 *  Como la funcion geocode de googel es asincrona tengo que pasar la funcion que
 *  queremos que se ejecute despues de encontrar la longitud y latitud.
 *
 *  Es una forma de hacer sincorono el metodo geocode.
 *
 **/
function getCorderMapFooter(address, paisISO, callback, paramsCallback) {

    //Esto si es necesario.  Ya que canarias googel map retorna  como region "ES" no "ESCN" que propia de Inditex
    if (paisISO == "ESCN" || paisISO == "IC") {
        paisISO = "ES";
    }
    //alert(paisISO);
    //alert(address);

    if(Inditex.iStoreJSON.countryCode=="CN"&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""){
        Inditex.getBaiduCoords(
            paisISO,
            address,
            function(aResult) {
                if (aResult) {
                    var latitud = aResult.lat;
                    var longitud = aResult.lng;
                    callback.call(this, latitud,longitud, paramsCallback);
                    encontrado = 1;
                } else{
                    $('#results_header').show();
                    $('#total_tiendas').html('0 ');
                }
            }
        );
    } else {
        Inditex.getGoogleCoords(
            paisISO,
            address,
            function(aResult) {
                if (aResult) {
                    var latitud = aResult.geometry.location.lat();
                    var longitud = aResult.geometry.location.lng();
                    callback.call(this,latitud,longitud,paramsCallback);
                    encontrado = 1;
                } else{
                    $('#results_header').show();
                    $('#total_tiendas').html('0 ');
                }

            }
        );

    }


}



/** Funcion que se encaraga de cargar un JSON con las tiendas fisicas mas proximas a
 *  la longitud y latiutd que le pasamos.
 *
 * **/
function loadJSONPhysicalStoreFooter(latitude, longitude) {
    var url = $('#buscarTiendasForm').attr('action');
    url = url + "&latitude=" + latitude + "&longitude=" + longitude;
    //lo hacemos mediante POST para poder crear una pagina HTML y procesar los datos 
    // la respuesta la convertimos en un JSON y los pintamos en el mapa.
    // Lo suyo es utilizar el metodo $.getJSON pero no consigo hacer funcionar correctamente la JSP
    jQuery.xajax({
        url: url,
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSONBuscadorTienda(respHtml);
            loadTiendas(dataJSON,$('#pageOrigen').val()||true);
            //Actualizamos el scroll por si es necesario.
            setScroll();
        }
    });
}

/** Funcion que se encaraga de cargar un JSON con las tiendas fisicas mas proximas a
 *  la longitud y latiutd que le pasamos.
 *
 * **/
function loadJSONPhysicalStoreFooterTunel(latitude,longitude,params) {
    var url = $('#buscarTiendasForm').attr('action');
    url = url + "&latitude=" + latitude + "&longitude=" + longitude;
    //lo hacemos mediante POST para poder crear una pagina HTML y procesar los datos 
    // la respuesta la convertimos en un JSON y los pintamos en el mapa.
    // Lo suyo es utilizar el metodo $.getJSON pero no consigo hacer funcionar correctamente la JSP
    var origen = true;
    if (params && params.origen) {
        origen = params.origen;
    }
    jQuery.xajax({
        url: url,
        dataType: 'html',
        success: function(respHtml) {
            var dataJSON = getResponseJSONBuscadorTienda(respHtml);
            loadTiendas(dataJSON, origen, true);
            //Actualizamos el scroll por si es necesario.
            setScroll();
        }
    });
}

function getTiendaLineFooter(tienda,origen) {
    var linea = document.createElement("li");

    linea.id = tienda.physicalStoreId;
    linea.className = "tienda columns";
    var span = document.createElement("span");
    span.className = "spnsel";
    span.innerHTML = tienda.city +' - '+tienda.name;
    $(linea).click(function() {
        $(span).toggleClass('active')
        //	seleccionarTienda(tienda, linea);
        if(Inditex.iStoreJSON.countryCode=="CN"&&Inditex.iBaiduMapsKey&&Inditex.iBaiduMapsKey!=""){
            onClickMarcadorBaiduFooter(tienda.marcador, tienda);
        }else{
            onClickMarcadorFooter(tienda.marcador, tienda);
        }

        if (origen=="footer") {
            Inditex.trackEvent( "Tiendas","Desplegar_Lista",tienda.physicalStoreId,{'page':'Stores/Tiendas/Lista_Mapa'});
        } else if (origen=="tunel" && $(span).hasClass('active')) {
            Inditex.trackEvent( categoryEvent,"Envio_Tiendas_Buscador_Lista_Desplegar",tienda.physicalStoreId,{'page':"Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador/Lista_Mapa"+extraPageview});
        }
    });
    linea.appendChild(span);
    return linea;
}

function seleccionarTiendaFooter(tienda, linea) {
    tiendaSeleccionada = tienda;

    var html = tienda.address + "<br />" + tienda.postalCode + " " + tienda.city + "<br />";
    if (tienda.phone1 != null && tienda.phone1 != '') {
        html += "Tel. " + tienda.phone1;
    }
    tienda.sections = tienda.sections.replace("1",  seleccionarTiendaFooterParams.sections1);
    tienda.sections = tienda.sections.replace("2",  seleccionarTiendaFooterParams.sections2);
    tienda.sections = tienda.sections.replace("3",  seleccionarTiendaFooterParams.sections3);
    tienda.sections = tienda.sections.replace(/,/g, " / ");
    html += "<br />( " + tienda.sections + " )";
    if(createLinkSeleccionar){
        html += '<a class="tienda_sel" id="seleccionarTiendaBtn" href="javascript:void(0)">'+Messages.select+'</a>';
    }

    $('.detalletienda.active').removeClass('active')
    setTimeout(function() {
        if (!$(linea).children('.detalletienda').length) {
            $('<div />', {
                'html': html,
                'class': 'detalletienda active'
            }).appendTo(linea).hide().slideDown(function() {
                setScroll()
            });
            $('a.tienda_sel[id=seleccionarTiendaBtn]',linea).click(function(event){
                event.stopPropagation()
                seleccionarTiendaFooterBtn(false);
                modaltiendas.closemodal();

            })
        }
    }, 1)
    setTimeout(function() {
        $('.detalletienda:not(.active)').slideUp(function() {
            setScroll()
            $(this).parent().removeClass('tiendaSelected')
            $(this).remove()
        })
    }, 2)





    $(".tienda").removeClass("tiendaSelected");
    $(linea).addClass("tiendaSelected");
    $(detalleTienda).show();
}


function loadTiendasFooter(dataTiendas,latlngDefault,tunel) {
    var mismoPais = 0;
    $('#results_header').show();
    tiendas = new Array();
    var marcador = null;
    var latlng = null;
    var bounds = new google.maps.LatLngBounds();
    clearMarcadores();
    $("#dvlistad").show();
    var total_tiendas = 0;
    $.each(dataTiendas, function(l, tienda) {
        if (paisISO == tienda.country) {
            mismoPais = 1;
        } else {
            mismoPais = 0;
        }

        if (mismoPais == 1) {
            total_tiendas++;
            tiendas.push(tienda);
            resultList.appendChild(getTiendaLineFooter(tienda));
            latlng = new google.maps.LatLng(tienda.latitude, tienda.longitude);
            marcador = new google.maps.Marker({
                position: latlng,
                map: mapa,
                icon: DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png",
                title: tienda.name
            });
            var marcadorActual = marcador;
            tienda.marcador = marcadorActual;
            var tiendaClickada = tienda;
            google.maps.event.addListener(marcador, 'click', function() {
                onClickMarcadorFooter(marcadorActual, tiendaClickada);
                Inditex.trackEvent( "Tiendas","Desplegar_Mapa",Inditex.iGaIsoStore,true);
            });
            google.maps.event.addListener(mapa, 'zoom_changed', hideTiendaTooltip);
            google.maps.event.addListener(mapa, 'resize', hideTiendaTooltip);
            google.maps.event.addListener(mapa, 'projection_changed', hideTiendaTooltip);
            google.maps.event.addListener(mapa, 'dragstart', hideTiendaTooltip);
            google.maps.event.addListener(mapa, 'center_changed', hideTiendaTooltip);
            google.maps.event.addListener(mapa, 'bounds_changed', hideTiendaTooltip);
            marcadores.push(marcador);
            bounds.extend(latlng);
        }
    });
    $('#total_tiendas').html(total_tiendas+' ');
    mapa.fitBounds(bounds);
    setScroll()
    Inditex.trackPage( "Tiendas/Lista_Mapa", true);
}

function verEnMapa() {
    mapa.panTo(new google.maps.LatLng(tiendaSeleccionada.latitude, tiendaSeleccionada.longitude));
}

function onClickMarcadorFooter(marcador, tiendaClickada) {
    for (var i = 0; i < mapa.iMarkers.length; i++) {
        mapa.iMarkers[i].setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png");
    }
    var pos = marcador.getPosition();
    var overlayProjection = tiendaTooltip.getProjection();
    if (overlayProjection != null) {
        var punto = overlayProjection.fromLatLngToContainerPixel(pos);
        punto.y = punto.y - TOOLTIP_OFFSET;
        pos = overlayProjection.fromContainerPixelToLatLng(punto);
    }
    marcador.setIcon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png");
    mapa.iMap.panTo(pos);
    seleccionarTiendaFooter(tiendaClickada, document.getElementById(tiendaClickada.physicalStoreId));
    tiendaTooltip.setMap(mapa.iMap);
}

function onClickMarcadorBaiduFooter(marcador, tiendaClickada) {

    for (var i = 0; i < mapa.iMarkers.length; i++ ) {
        new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png",  new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight));
        mapa.iMarkers[i].setIcon(new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti.png",new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
    }
    var pos = marcador.getPosition();
    marcador.setIcon(new BMap.Icon(DUTTI_STATIC_CONTENT_PATH + "/img/icono-dutti-activo.png",new BMap.Size(Inditex.baiduIconWidth, Inditex.baiduIconHeight)));
    seleccionarTiendaFooter(tiendaClickada, document.getElementById(tiendaClickada.physicalStoreId));
    tiendaTooltip.show();
    $(tiendaTooltip.content).show();
    mapa.iMap.panTo(pos);
}



function onAddTooltipFooter() {
    var div = getTooltipHTMLFooter(tiendaSeleccionada);
}

function getTooltipHTMLFooter(tienda){
    var tiendaName = "&nbsp;";
    var tiendaPostalCode = "&nbsp;";
    var tiendaCity = "&nbsp;";
    var tiendaSections = "&nbsp;";
    but='';
    if(createLinkSeleccionar){
        but = '<a class="tienda_sel" id="seleccionarTiendaBtn" href="javascript:void(0)" onclick="seleccionarTiendaFooterBtn(true);modaltiendas.closemodal()">'+Messages.select+'</a>';
    }



    if (tienda != null) {
        tiendaName = tienda.name;
        tiendaPostalCode = tienda.postalCode;
        tiendaCity = tienda.city;
        tienda.sections = tienda.sections.replace("1",  seleccionarTiendaFooterParams.sections1);
        tienda.sections = tienda.sections.replace("2",  seleccionarTiendaFooterParams.sections2);
        tienda.sections = tienda.sections.replace("3",  seleccionarTiendaFooterParams.sections3);
        tienda.sections = tienda.sections.replace(/,/g, " / ");
        tiendaSections = tienda.sections + but;
    } else {
        tiendaName = "&nbsp;";
        tiendaPostalCode = "&nbsp;";
        tiendaCity = "&nbsp;";
        tiendaSections = "&nbsp;";
    }


    $("#mapa_tooltip").find("#mCalle").html(tiendaName);
    $("#mapa_tooltip").find("#mCp").html(tiendaPostalCode + ' ' + tiendaCity);
    $("#mapa_tooltip").find("#mSeccion").html(tiendaSections);
}

function seleccionarTiendaFooterBtn(mapa){
    if (mapa) {
        Inditex.trackEvent( categoryEvent,"Envio_Tiendas_Buscador_Mapa_Seleccionar",tiendaSeleccionada.physicalStoreId,{'page':"Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador/Lista_Mapa"+extraPageview});
    } else {
        Inditex.trackEvent( categoryEvent,"Envio_Tiendas_Buscador_Lista_Seleccionar",tiendaSeleccionada.physicalStoreId,{'page':"Cesta_de_Compra/Tramitar_Pedido/Envio/Recoger_Tienda/Buscador/Lista_Mapa"+extraPageview});
    }
    var urlEnviar = $('#iAddUrl').val();
    jQuery.xajax({
        url: urlEnviar,
        type: "post",
        dataType: 'json',
        data: "physicalStoreId="+tiendaSeleccionada.physicalStoreId,
        success: function(aJson) {

            if ((aJson) && ((aJson.errorKey==undefined) || (aJson.errorKey==null))) {
                if (Inditex)
                    Inditex.trackEvent('Tiendas','seleccionar');
                seleccionarTiendaFooterParams.onAddTienda(tiendaSeleccionada);
            }
            else {

                if (aJson.errorKey=="_ERR_MAX_USER_FAVOURITE_STORES") {
                    openStaticModal("ERROR", aJson.errorMessage, false);
                }
                else {
                    showError(ITX_TEXT_GENERIC_PROBLEM);
                }
            }
        }

    });
}


function fixscrollableFooter(){
    $('#shopform #scrollable').css({
        'height' : $('#shopform').height() - $('#formfix').height() - 70
    })
}
/** Funcion que no retonar la respuesta de Servidor en un JSON **/
function getResponseJSONBuscadorTienda(respHtml) {
    var type = typeof respHtml;
    var dataJSON = null;
    if (type == 'string') {
        dataJSON = jQuery.parseJSON(respHtml);
    } else {
        dataJSON = respHtml;
    }
    return dataJSON;
}


;
/* END /DuttiNEWStorefrontAssetStore/js/seleccionarTiendaFooter.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/popUpPanel.js (en_US) */
;var popUpPanel = {

    /**
     * M?todo que se encarga de inicializar, configurar y abrir el popup
     * url - URL a partir de la cual se cargar? el contenido del popup
     * contenedor - ID o clase a partir de la cual se puede recuperar el contenedor donde se cargar? el popup
     * closeClass - Clase del elemento sobre el que se har? clic para cerrar el popup, este par?metro es opcional, por defecto valdr? cierre
     * origin - String que sirve para idenficar desde donde se ha solicitado que se cargue el popup
     */
    initialize : function(url,contenedor,closeClass, origin, panelConfig){

        var controller = this;

        if(origin){
            controller.originGlobalPopup = origin;
        }else{
            controller.originGlobalPopup = null;
        }
        if(!url || !contenedor || !closeClass){
            return;
        }
        //Esto es para controlar que no se cargue otro popup mientras se est? cargando uno.
        if(controller.loadding){
            return;
        }else {
            controller.loadding= true;
        }

        controller.initPopUp(url,$(contenedor),closeClass, panelConfig);
    },

    /**
     * M?todo que se encarga de recuperar el contenido del popup y de configurarlo
     */
    initPopUp : function(url,contenedor,closeClass, panelConfig){

        var controller = this;

        $.xajax({
            url:url,
            success:function(htmlData, status){

                controller.configPosition(contenedor, panelConfig);
                contenedor.html(htmlData);
                if (closeClass){
                    $('.cierre').attr('class',closeClass);
                }
                contenedor.css('display','block');
                controller.configClose(url,contenedor,closeClass);

            },
            complete:function(event, xhr, settings){
                controller.loadding = false;
            }
        });

    },

    /**
     * M?todo que se encarga de posicionar el popup.
     *
     * Este m?todo deber?a calcular la posici?n din?micamente, pero como en principio se va cambiar pronto la tienda y no se tiene previsto que se a?adan
     * nuevos popups, dejamos las posiciones est?ticas seg?n la maqueta del popup de notificaci?n de stock.
     */
    configPosition: function (contenedor, panelConfig){

        if (panelConfig){

            if (panelConfig.height)contenedor.css('height', panelConfig.height + 'px');
            if (panelConfig.width)contenedor.css('width', panelConfig.width + 'px');
            if (panelConfig.left)contenedor.css('left', panelConfig.left + '%');
            if (panelConfig.top)contenedor.css('top', panelConfig.top + '%');
            if (panelConfig.marginTop) contenedor.css('margin-top', panelConfig.marginTop + 'px');
            if (panelConfig.marginLeft)contenedor.css('margin-left', panelConfig.marginLeft + 'px');

            if (panelConfig.autoTop){
                var posY = -160 + $(window).scrollTop();
                contenedor.css({'top':'50%', 'margin-top':posY+'px'});
            }


        }else{
            contenedor.css('height', '430px');
            contenedor.css('width', '700px');
            contenedor.css('left', '50%');
            contenedor.css('top', '50%');
            contenedor.css('margin-left','-350px');
            contenedor.css('margin-top', '-200px');
            contenedor.css('padding-left', '20px');
        }
        contenedor.css('position', 'absolute');
        contenedor.css('z-index', '10000');
    },

    /**
     * M?todo que se encarga de configurar el elemento que se encargar? de cerrar el popup
     */
    configClose : function(url,contenedor,closeClass){

        var controller = this;
        var cierre = '.';

        if (closeClass){
            cierre = cierre + closeClass;
        }else{
            cierre = cierre + 'cierre';
        }

        $(cierre).click(function(e) {
            e.preventDefault();
            contenedor.children().remove();
            contenedor.css('display','none');

            if($('#trama2')){
                $('#trama2').remove();
            }
        });
    },

    getOrigin: function(){
        var self = this;
        return self.originGlobalPopup;
    }


};;
/* END /DuttiNEWStorefrontAssetStore/js/popUpPanel.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/Navigation/Main/devolucionTicketRegalo.js (en_US) */
function init_devolucionRegalo() {

    if ( $('#obligatorio').hasClass('error') && $('#barcode').val() != "" && $('input[id="captcha"]').val() != ""  ) {
        $('#obligatorio').removeClass('error');
    }

    if ( $('#barcode').val() == "" || $('input[id="captcha"]').val() == "" ) {
        $('#obligatorio').addClass('error');
        return false;
    }

    loadGiftCardHash(function() {

        var getGiftCardURL = Inditex.generateUrl('ItxStandardGiftCardValidateCmd',{
            "storeId"			: Inditex.iStoreId,
            "langId"			: Inditex.iLangId,
            "catalogId"			: Inditex.iCatalogId,
            "captcha"			: $('input[name=captcha]').val(),
            "barcode"			: $('#barcode').val(),
            "gc_token"			: $('input[name=gc_token]').val(),
            "viewname"			:"ItxStandardJSON",
            "errorViewName"		:"ItxStandardJSON"
        }, true);

        jQuery.xajax({
            url: getGiftCardURL,
            type: "post",
            dataType: 'json',
            success: function(respHtml) {
                if (respHtml.errorKey == null && respHtml.data != null){
                    var captchaPath = $('#captchaurl').attr('src');
                    if(captchaPath){
                        var splitCaptchaPath = captchaPath.split('&');
                        if(splitCaptchaPath){
                            $('#captchaurl').attr('src',captchaPath+'&t='+Inditex.iBuildVersion);
                        }
                    }

                    var ticketdevo = Inditex.generateUrl('ItxReturnTicketView',{
                        "storeId"			: Inditex.iStoreId,
                        "langId"			: Inditex.iLangId,
                        "catalogId"			: Inditex.iCatalogId,
                        "orderId"			: respHtml.data.orderId
                    }, true);

                    openGenericModal(ticketdevo,['scrollable'],function onReady() {
                        addScroll;
                        var pedidoId = respHtml.data.orderId;
                        $('#barcodeId').val($('#barcode').val());
                        var aOrderJson = respHtml.data.order;
                        Inditex.getUserJSON(function(json){
                            Inditex.getUserAddressBookJSON({
                                "onSuccess": function(aJson) {
                                    if ((aJson) && ((aJson.errorKey==undefined) || (aJson.errorKey==null))) {

                                        $('#orderId').val(pedidoId);
                                        self.iUserAddressBook = aJson;
                                        $("#userGuestId").val(json.identity.userId);
                                        var dataJSON = getResponseJSON(aOrderJson);
                                        $("#general_modal").css('max-height','730px');
                                        loadDetalleTicketDevolver(dataJSON);
                                    }
                                },
                                "onFailure": function(aStatus) {
                                    openStaticModal(ITX_TEXT_ERROR,Messages.ItxOrderTicketReturnConfirmView_error_menssage);
                                }
                            });
                        });
                    },null,0.8,false);

                } else{
                    var captchaPath = $('#captchaurl').attr('src');
                    if(captchaPath){
                        var splitCaptchaPath = captchaPath.split('&');
                        if(splitCaptchaPath){
                            $('#captchaurl').attr('src',captchaPath+'&t='+Inditex.iBuildVersion);
                        }
                    }
                    openStaticModal(ITX_TEXT_ERROR,respHtml.errorMessage);
                }



            },
            onFailure: function(aStatus) {
                var captchaPath = $('#captchaurl').attr('src');
                if(captchaPath){
                    var splitCaptchaPath = captchaPath.split('&');
                    if(splitCaptchaPath){
                        $('#captchaurl').attr('src',captchaPath+'&t='+Inditex.iBuildVersion);
                    }
                }
            }
        });
    });
}

function initDevoTicketRegalo(){

    $("#devoTicketRegaloForm").validate({
        submitHandler : function(form) {

            saveOrderRetrunTicketConfirm();

        },
        rules : {
            email1 : {
                required : true,
                email : true
            },
            email2 : {
                required : true,
                email : true,
                equalTo : "#email1"
            },
            nombre : "required",
            apellido : "required",
            direccion : "required",
            localidad : "required",
            cp : "requiredChangeClass",
            inpprovi : "required",
            inpprefijo : {
                validPrefix : true,
                required : true
            },
            inpmovil : {
                required : true,
                number : true,
                validatePhone : true
            },
            inpnumcaj : "cajasChangeClass",
            privatePolicy : "required"
        },
        messages : {
            email1 : Messages.email1,
            email2 : {
                required: Messages.required,
                email: Messages.email1,
                equalTo: Messages.emailEqualTo
            },
            nombre : Messages.required,
            apellido : Messages.lastName,
            direccion : Messages.rellenarCampo,
            inpprovi : Messages.state,
            privatePolicy : Messages.aceptarPolitica,
        }
    });
}

/**
 * Binds para los botones +- en la seleccion de productos a devolver
 */
function detalleDevolucionBindsDevo() {
    $('#devoTicketRegaloForm .mas').unbind().bind("click", function(){
        var radios=$(this).parent().parent().parent().find('a[id^="radio"]');
        radios.bind('click',function(){
            $(this).parent().parent().find('a').removeClass('active');
            $(this).addClass('active');

            this.click();
            this.checked = true;
        });

        var currPriceValue = parseInt($(this).prev().attr('value'));

        var tr = $(this).parent("div").parent("td").parent("tr");
        motivo_devolucionExt(currPriceValue + 1 , $(this));
        var quantityMax = $(tr).find("input[class=\"quantity\"]").attr("id");

        if ((currPriceValue + 1) <= quantityMax) {
            $('#devoTicketRegaloForm span#maxQuantity').hide();
            $(this).prev().attr('value', currPriceValue + 1);
            recalcularTotalTicketProduct($(this));
        } else {
            var messageValidacion = Messages.ItxMyAccountOrderReturnSelectItemView_validate_maxquantity_parte1
                + $(tr).find("td[id=\"desc\"]").find("p").text()
                + Messages.ItxMyAccountOrderReturnSelectItemView_validate_maxquantity_parte2;
            $('#devoTicketRegaloForm span#maxQuantity').text(messageValidacion);
            $('#devoTicketRegaloForm span#maxQuantity').show();
        }
    });
    $('#devoTicketRegaloForm .menos').unbind().bind("click", function(){
        var currPriceValue = parseInt($(this).next().attr('value'));
        if(currPriceValue > 0) {
            $('#devoTicketRegaloForm span#maxQuantity').hide();
            $(this).next().attr('value', currPriceValue - 1);
            motivo_devolucionExt(currPriceValue - 1 , $(this));
            recalcularTotalTicketProduct($(this));
        }
    });
}

/**
 * Oculta o muestra el bot?n de 'elegir motivo' de devoluci?n
 */
function motivo_devolucionExt(ammount, selector){
    if(ammount > 0){
        selector.parents('tr').find('.boton4').fadeIn();
        $('.devoMotivo a.radio').off('mouseup').on('mouseup'  , function(){
            $(this).parents('.devoMotivo').slideUp();
        })
    }else{
        selector.parents('tr').find('.boton4').fadeOut();
        $('.devoMotivo a.radio').unbind('click')
    }

}

/**
 * Calcula el importe segn las unidades que se devuelven de un producto
 */
function recalcularTotalTicketProduct(element) {
    var unitPrice = parseFloat(element.parent().parent().parent().find('#unitPrice').find('p').attr('id'), 2);
    var quantity = parseInt(element.parent().find('.quantity').attr('value'));
    //valor a visualizar
    element.parent().parent().parent().find('.product_total').html(Inditex.formatPrice(unitPrice * quantity));
}

/**
 * Comprueba que se va a devolver al menos una unidad de cada producto
 */

function validateProductsDevo() {
    orderReturnResponse.listItems = new Array();
    var continuar = false;
    var notValid = true;
    $.each($('#devoTicketRegaloForm input.quantity'), function(key, input) {
        if(parseInt($(input).val()) >= 1 && isNumber($(input).val())){
            //Ref. 
            //Guardo en el JSON global todos los orderItems que va devolver el usuario. 
            var tr = $(input).parent("div").parent("td").parent("tr");
            var orderItemId = $(tr).attr("id");
            var imageSrc = $(tr).find("td[id=\"image\"]").find("img").attr("src");
            var description =$(tr).find("td[id=\"desc\"]").find("p").text();
            var reference = $(tr).find("td[id=\"desc\"]").find("span").text();
            var cutColorName = $(tr).find("td[id=\"cutColorName\"]").find("p").text();
            var size = $(tr).find("td[id=\"size\"]").find("p").text();
            var unitPrice = $(tr).find("td[id=\"unitPrice\"]").find("p").attr("id");

            if (! $(tr).find("td[id=\"reasonReturn\"]").find("a.radio.active")[0]){
                continuar = false;
                notValid = false;
            } else {
                var reasonReturn = $(tr).find("td[id=\"reasonReturn\"]").find("a.radio.active")[0].id.replace('radio_','');


                var orderItemJSON = '{"orderItemId": "'+  orderItemId + '", '
                    + '"image": "' + imageSrc + '", '
                    + '"description": "' + description + '", '
                    + '"reference": "' + reference + '", '
                    + '"cutColorName": "' + cutColorName + '", '
                    + '"size": "' + size + '", '
                    + '"quantity": "' + $(input).val() + '", '
                    + '"reasonReturn": "' + reasonReturn + '", '
                    + '"unitPrice": "' + unitPrice + '"}';
                orderReturnResponse.listItems.push(jQuery.parseJSON(orderItemJSON));
                continuar = true;
            }
        }
    });

    if ($('input.quantity').parents('tr').find('a.radio.active').length < 1){
        continuar = false;
    }

    if(continuar && notValid) {
        $('#devoTicketRegaloForm span.spnroj').hide();
        $("#devoTicketRegaloForm").submit();
    } else {
        $('#devoTicketRegaloForm span.spnroj').first().show();
    }

}

/**
 * Muestra/oculta el div para seleccionar un motivo de devolucion
 */
function slideMotivoTicket(element) {
    var initPadding = $("#devoTicketRegaloForm").css("padding-bottom");
    $('a.accion').not(element).removeClass('activo');
    //$('.devoMotivo').not(element.next()).slideUp();
    element.next().css({
        'top' : element.position().top + $('#large_modal').scrollTop() + element.height() + 3
    });
    element.toggleClass('activo');
    //element.next().slideToggle();

    element.next().slideToggle(function(){
        //$("#scrollable").jScrollPane();
        var desplegable_max_y = $(this).outerHeight() + $(this).position().top;
        var content_max_y = $('#devoTicketRegaloForm').outerHeight() + $('#devoTicketRegaloForm').position().top;
        var dif = desplegable_max_y - content_max_y ;

        if(dif > 0){
            $('#devoTicketRegaloForm').css('padding-bottom' , (parseInt(initPadding) + dif));
            $("#scrollable").jScrollPane();
        }else{
            $('#devoTicketRegaloForm').css('padding-bottom' , (parseInt(initPadding)));
            $("#scrollable").jScrollPane();
        }
    });

}

/**
 * Metodo que carga datos del json de Detalle de pedido
 */
function loadDetalleTicketDevolver(data) {

    var contenido = '';
    lista = data.items;

    Inditex.getRestReturnReason({
        "onSuccess": function(aJson) {

            listaReason = aJson.returnReasons;
            for( i = 0; i < lista.length; i++) {
                var reason = '';
                var quantity  = "0";
                producto = lista[i];

                var symbolPosition = DUTTI_PRICE_SUFFIX_POS.length==0;
                if (!symbolPosition)
                    moneda = DUTTI_PRICE_SUFFIX_POS;
                else
                    moneda=DUTTI_PRICE_PREFIX_POS;

                //Si nos ha pulsado la opcion 1, hay que poner como lo teniamos.
//					var lsOrderReturnResponse = orderReturnResponse.listItems;
//					for( j = 0; j < lsOrderReturnResponse.length; j++) {
//						productoResponse = lsOrderReturnResponse[i];
//						if (producto.sku == productoResponse.orderItemId) {
//							quantity = productoResponse.quantity;
//						}
//					}

                /*A?adimos una columna mas*/

                $('.articulosdevolver1').find('tr').append('<th class="thbot">&nbsp;</th>')

                for( m = 0; m < listaReason.length; m++) {
                    reason += '<li><input type="radio" name="motivo_'+i+'" id="'+listaReason[m].id+'" style="display: none;">'
                        + '<label>'+ listaReason[m].description +'</label><br style="clear:both"></li>';
                }


                contenido += '<tr id="' + producto.sku + '">'
                    + '<td id="image">' + '  <img src="'+ Inditex.getProductImageUrls(producto.image,1,5)[0] +'"  width="70px" />' + '</td>'
                    + '<td id="desc" class="left">' + '	<p>' + producto.name + '</p>' + '    <span>Ref. ' + producto.reference + '</span>' + '</td>'
                    + '<td id="cutColorName">' + '	<p>' + producto.color + '</p>' + '</td>'
                    + '<td id="size" class="center">' + ' 	<p>' + producto.size + '</p>' + ' </td>'
                    + '<td><div class="contadores"><img class="menos" src="' + DUTTI_STATIC_CONTENT_PATH + '/img/ico_menos.png"><input id="' +producto.quantity + '" class="quantity" type="text" value="'+ quantity + '" readonly="true"/><img class="mas" src="' + DUTTI_STATIC_CONTENT_PATH + '/img/ico_mas.png"></div></td>'
                    + '<td id="unitPrice">' + '<p id="' + producto.unitPrice+ '" class="product_total">' + Inditex.formatPrice(producto.unitPrice * quantity) + '</p>' + ' </td>'
                    + '<td id="reasonReturn" class="right"><div class="boton4"  style="display:none"><a class="accion" onclick="slideMotivoTicket($(this))" href="javascript:void(0)">'+Messages.elegirMotivo+'</a>'
                    + '<span class="devoMotivo"><a class="close" onclick="cerrarMotivos(this)" href="javascript:void(0);">&nbsp;</a>'
                    + '<span class="devoCont"><ul class="opt_check">'
                    + reason +'</ul></span></span></div></td>'
                    + '</tr>';
            }
            //quantity

            //Borro los orderItems seleccionados la ultima vez ya que se van a elegir otros.
            orderReturnResponse.listItems = new Array();

            $("#tablaPedidos").html(contenido);

            loadRadiosAndChecks();
            initDevoTicketRegalo();
            detalleDevolucionBindsDevo();
            selectBinds(205,'px');
            setScroll();
            $('#orderReturnEnd').click(function() {
                validateProductsDevo();
            });
        },
        "onFailure": function(aStatus) {
            openStaticModal(ITX_TEXT_ERROR,Messages.ItxOrderTicketReturnConfirmView_error_menssage);
        }
    });

}

/** Funcion que no retonar la respuesta de Servidor en un JSON **/
function getResponseJSON(respHtml) {
    var type = typeof respHtml;
    var dataJSON = null;
    if (type == 'string') {
        dataJSON = jQuery.parseJSON(respHtml);
    } else {
        dataJSON = respHtml;
    }
    return dataJSON;
}

/** funcion que graba en base de datos la devolcion de los articulos **/
function saveOrderRetrunTicketConfirm() {
    var lista = orderReturnResponse.listItems;

    if (lista.length >0) {

        var urlGuest = $("#urlAddAddress").val();
        Inditex.getUserJSON(function(aJson) {
            var userGuestId = aJson.identity.userId;
            Inditex.getUserAddressBookJSON({
                "onSuccess": function(aJson) {
                    if ((aJson) && ((aJson.errorKey==undefined) || (aJson.errorKey==null))) {
                        self.iUserAddressBook = aJson;
                        var addressId = '';
                        if (self.iUserAddressBook.addresses[0] != null && self.iUserAddressBook.addresses[0] != undefined){

                            var data = 'orderId=' + $('#orderId').val()
                                + '&firstName=' + encodeURIComponent($('#nombre').val())
                                + '&email=' + encodeURIComponent($('#email1').val())
                                + '&barcode=' + encodeURIComponent($('#barcode').val())
                                + '&middleName=' + ((Inditex.iStoreJSON.details.isMiddleName) ? (encodeURIComponent(orderReturnResponse.address.middleName)) : "" )
                                + '&lastName=' + encodeURIComponent($('#apellido').val())
                                + '&zipCode=' + encodeURIComponent($('#cp').val())
                                + '&addressLine_0=' + encodeURIComponent($('#direccion').val())
                                + '&addressLine_1=' + encodeURIComponent($('#direccion2').val())
                                + '&countryCode=' + Inditex.iStoreJSON.countryCode
                                + '&stateCode=' + $("#devoTicketRegaloForm").find('#inpprovi').val()
                                + '&city=' + encodeURIComponent($('#localidad').val())
                                + '&phoneCountryCode_0=' + $('#inpprefijo').val().replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
                                + '&phoneSubscriberNumber_0=' + $('#inpmovil').val()
                                + '&phoneCountryCode_1=' + $('#inpprefijo2').val().replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
                                + '&phoneSubscriberNumber_1=' + $('#inptlfn').val()
                                + '&colony=' + ""
                                + '&municipality=' + ""
                                + '&comments=' + ""
                                + '&numberBoxes=' + $('#inpnumcaj').val();


                            for( i = 0; i < lista.length; i++) {
                                var orderItem = lista[i];
                                data += '&catEntryId_'+i+'='+orderItem.orderItemId
                                    + '&quantity_'+i+'='+orderItem.quantity
                                    + '&reasonId_'+i+'='+orderItem.reasonReturn;
                            }

                            var urlOrderReturnEndCmd = $("#iOrderReturnEndCmdURL").attr('value');

                            jQuery.xajax({
                                url: urlOrderReturnEndCmd,
                                type: "post",
                                dataType: 'json',
                                data: data,
                                success: function(respHtml) {
                                    openStaticModal(Messages.ItxMyAccountOrderReturnConfirmView_end_title, Messages.ItxOrderTicketReturnConfirmView_end_menssage, true);

                                    $("#s_over_overlay").find('#close_modal').bind('click', function() {
                                        $("#s_overlay").find('#close_modal').click();
                                    });

                                    $("#s_over_overlay").find('#close_over_overlay').bind('click', function() {
                                        $("#s_overlay").find('#close_modal').click();
                                    });
                                },
                                onFailure: function(respHtml) {
                                    openStaticModal(ITX_TEXT_ERROR,Messages.ItxOrderTicketReturnConfirmView_error_menssage);
                                }
                            });
                        }

                        else {
                            var dataGuest = 'languageId=' + Inditex.iLangId
                                + '&firstName=' + encodeURIComponent($('#nombre').val())
                                + '&email=' + encodeURIComponent($('#email1').val())
                                + '&lastName=' + encodeURIComponent($('#apellido').val())
                                + '&phoneCountryCode_0=' + $('#inpprefijo').val().replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
                                + '&phoneSubscriberNumber_0=' + $('#inpmovil').val()
                                + '&countryCode=' + Inditex.iStoreJSON.countryCode
                                + '&storeId=' + Inditex.iStoreId
                                + '&isCompany=' + false
                                + '&privacyPolicyAccepted=' + true
                                + '&memberId=' + userGuestId
                                + '&addressId=' + addressId
                                + '&viewname= ItxStandardJSON'
                                + '&errorViewName= ItxStandardJSON'

                            var urlOrderReturnEndCmd = $("#iOrderReturnEndCmdURL").attr('value');

                            Inditex.orderManage({
                                "url": urlGuest,
                                "data": dataGuest,
                                "method": "post",
                                "onSuccess": function(aText) {
                                    var aJson = Inditex.evalJSON(aText);
                                    if (aJson.errorKey){
                                        Inditex.xOpenErrorPopUp(350,300,Inditex.iProperties["DEFAULT_ERROR_MESSAGE_TITLE"],aJson.errorMessage);
                                    }else{

                                        var data = 'orderId=' + $('#orderId').val()
                                            + '&firstName=' + encodeURIComponent($('#nombre').val())
                                            + '&email=' + encodeURIComponent($('#email1').val())
                                            + '&barcode=' + encodeURIComponent($('#barcode').val())
                                            + '&middleName=' + ((Inditex.iStoreJSON.details.isMiddleName) ? (encodeURIComponent(orderReturnResponse.address.middleName)) : "" )
                                            + '&lastName=' + encodeURIComponent($('#apellido').val())
                                            + '&zipCode=' + encodeURIComponent($('#cp').val())
                                            + '&addressLine_0=' + encodeURIComponent($('#direccion').val())
                                            + '&addressLine_1=' + encodeURIComponent($('#direccion2').val())
                                            + '&countryCode=' + Inditex.iStoreJSON.countryCode
                                            + '&stateCode=' + $("#devoTicketRegaloForm").find('#inpprovi').val()
                                            + '&city=' + encodeURIComponent($('#localidad').val())
                                            + '&phoneCountryCode_0=' + $('#inpprefijo').val().replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
                                            + '&phoneSubscriberNumber_0=' + $('#inpmovil').val()
                                            + '&phoneCountryCode_1=' + $('#inpprefijo2').val().replace("+","%2B")  //Es necesario hacer esto para que llegue bien el carcter +
                                            + '&phoneSubscriberNumber_1=' + $('#inptlfn').val()
                                            + '&colony=' + ""
                                            + '&municipality=' + ""
                                            + '&comments=' + ""
                                            + '&numberBoxes=' + $('#inpnumcaj').val();


                                        for( i = 0; i < lista.length; i++) {
                                            var orderItem = lista[i];
                                            data += '&catEntryId_'+i+'='+orderItem.orderItemId
                                                + '&quantity_'+i+'='+orderItem.quantity
                                                + '&reasonId_'+i+'='+orderItem.reasonReturn;
                                        }

                                        jQuery.xajax({
                                            url: urlOrderReturnEndCmd,
                                            type: "post",
                                            dataType: 'json',
                                            data: data,
                                            success: function(respHtml) {

                                                openStaticModal(Messages.ItxMyAccountOrderReturnConfirmView_end_title, Messages.ItxOrderTicketReturnConfirmView_end_menssage, true);

                                                $("#s_over_overlay").find('#close_modal').bind('click', function() {
                                                    $("#s_overlay").find('#close_modal').click();
                                                });

                                                $("#s_over_overlay").find('#close_over_overlay').bind('click', function() {
                                                    $("#s_overlay").find('#close_modal').click();
                                                });

                                            },
                                            onFailure: function(respHtml) {
                                                openStaticModal(ITX_TEXT_ERROR,Messages.ItxOrderTicketReturnConfirmView_error_menssage);
                                            }
                                        });

                                    }
                                    // Pasamos al checkout
                                }
                            });

                        }


                    }

                },
                "onFailure": function(aStatus) {
                    openStaticModal(ITX_TEXT_ERROR,Messages.ItxOrderTicketReturnConfirmView_error_menssage);
                }
            });
        });
    }
}

;
/* END /DuttiNEWStorefrontAssetStore/js/Navigation/Main/devolucionTicketRegalo.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/variablesExternas.js (en_US) */

var constantes = new Array();

constantes['FICHAPRODUCTO']="/Ficha_Producto";
constantes['PATHNAME']="/webapp/wcs/stores/servlet/";
constantes['PARRILLA']="/Parrilla";
constantes['CABECERA']="/Cabecera";

;
/* END /DuttiNEWStorefrontAssetStore/js/variablesExternas.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/itx-core-standard.js (en_US) */
InditexClass.prototype.closeCookiesWarn = function() {
    Inditex.writeCookie("WC_MD2_COOKIESPOLICYACCEPTED",true,365);
    if (typeof Inditex.customCloseCookiesWarn == "function") {
        Inditex.customCloseCookiesWarn();
    } else {
        $("#cookiesWarn").hide();
    }
}

InditexClass.prototype.closeCookiesWarn = function() {
    Inditex.writeCookie("WC_MD2_COOKIESPOLICYACCEPTED",true,365);
    if (typeof Inditex.customCloseCookiesWarn == "function") {
        Inditex.customCloseCookiesWarn();
    } else {
        $("#cookiesWarn").hide();
    }
}

InditexClass.prototype.showCookiesWarn = function() {
    $("#cookiesWarn").show();
    if (typeof Inditex.customShowCookiesWarn == "function") {
        Inditex.customShowCookiesWarn();
    }
}

InditexClass.prototype.getCookiesPolicyAccepted = function() {
    var cookie = true;
    var cookiesPolicyAccepted = Inditex.readCookie("WC_MD2_COOKIESPOLICYACCEPTED");
    if (cookiesPolicyAccepted!='true') {
        cookie = false;
    }
    return cookie;
};

(function(){

    var originalCategoryJSON = null;
    var prevCategory = null;

    Inditex.iReadyArray.unshift(function(){
        Inditex.getSessionAttribute('prevCategory',function(name,value){
            prevCategory = value;
            Inditex.setSessionAttribute('prevCategory','');
        });
    })

    function getCategory() {
        if (originalCategoryJSON==null) {
            if (Inditex.iXCategoryJSON) {
                originalCategoryJSON = Inditex.iXCategoryJSON;
            } else {
                originalCategoryJSON = {nameEn:'',key:'',id:''}
            }
        }
        return originalCategoryJSON;
    }

    InditexClass.prototype.getECListCategory = function(category) {
        var list;
        var data = category.split("/");
        if (data.length>=2) {
            list = "CATALOGO_";
            list += data[1];
            if (data.length>=4) {
                if (data[2]=="T" || data[2]=="S") {
                    if (data[3]=="ESP") {
                        list = "CATALOGO_ESPECIAL_";
                        list += data[1];
                    } else if (data[3]=="MIC") {
                        list = "MICROSITE";
                    } else if (data[3]=="LBK") {
                        list = "LOOKBOOK";
                    }
                } else if (data[3]=="T" || data[3]=="S") {
                    if (data[4]=="ESP") {
                        list = "CATALOGO_ESPECIAL_";
                        list += data[2];
                    } else if (data[4]=="MIC") {
                        list = "MICROSITE";
                    } else if (data[4]=="LBK") {
                        list = "LOOKBOOK";
                    } else {
                        list = "CATALOGO_";
                        list += data[2];
                    }
                }
            }
            return list;
        } else {
            return category;
        }
    };

    InditexClass.prototype._getGASource = function() {
        var gaSource = Inditex.readCookie("WC_GASource");
        if (!gaSource) {
            if (Inditex.iWC_GASource) {
                gaSource = Inditex.iWC_GASource;
            } else {
                if (Inditex.iPrevGaSource && Inditex.iPrevURL==window.location.href) {
                    Inditex.sessionStore("prevGASource",Inditex.iPrevGaSource);
                    Inditex.sessionStore("prevURL",window.location.href);
                    gaSource = Inditex.iPrevGaSource
                } else {
                    gaSource = "";
                }
            }
        }
        return gaSource;
    }

    var eclist=null;
    InditexClass.prototype._setECList = function(list){
        eclist = list;
    }
    InditexClass.prototype._getECList = function(){
        if (eclist!=null) return eclist;
        var list = 'unknow';
        var gaSource = Inditex._getGASource();
        var match = gaSource.match(/^parrilla#(\d*)#(.*)/);
        if (match) {
            var category = match[2].replace(new RegExp("[-_]","g"), "/");
            return Inditex.getECListCategory(category);
        }
        match = gaSource.match(/^buscador#(.*)/);
        if (match) {
            return "BUSCADOR";
        }
        match = gaSource.match(/^productos relacionados#(.*)/);
        if (match) {
            return "PRODUCTOS_RELACIONADOS";
        }
        match = gaSource.match(/^ltimos productos vistos#(.*)/);
        if (match) {
            return "ULTIMOS_PRODUCTOS_VISTOS";
        }
        match = gaSource.match(/^fichaproducto#(.*)/);
        if (match) {
            return "FICHA_PRODUCTO";
        }
        match = gaSource.match(/^lookbook#(.*)/);
        if (match) {
            return "LOOKBOOK";
        }
        match = gaSource.match(/^microsite#(.*)/);
        if (match) {
            return "MICROSITE";
        }
        if (document.referrer) {
            var domain = Inditex.iGaDomain[0] == '.' ? Inditex.iGaDomain.substr('1') : self.iGaDomain;
            if (!new RegExp("^(http(s)?://)?(www\\.)?.*(" + domain + ").*","i").test(document.referrer)) {
                return "ENTRADA EXTERNA";
            }
        }
        if (prevCategory!=null) {
            var categoryJSON = Inditex.evalJSON(prevCategory);
            if (categoryJSON) {
                if (categoryJSON.search) {
                    return "BUSCADOR";
                } else if (categoryJSON.key) {
                    var category = categoryJSON.key.replace(new RegExp("[-_]","g"), "/");
                    return Inditex.getECListCategory(category);
                }
            }
        }
        return list;
    }

    var ecbrand=null;
    InditexClass.prototype._setECBrand = function(brand){
        ecbrand = brand;
    }
    InditexClass.prototype._getECBrand = function(){
        if (ecbrand!=null) return ecbrand;
        var brand = 'unknow';
        var gaSource = Inditex._getGASource();
        var match = gaSource.match(/^parrilla#(.*)/);
        if (match) {
            return getCategory().nameEn;
        }
        match = gaSource.match(/^buscador#(.*)/);
        if (match) {
            return "BUSCADOR";
        }
        match = gaSource.match(/^productos relacionados#(.*)/);
        if (match) {
            return "PRODUCTOS_RELACIONADOS";
        }
        match = gaSource.match(/^ltimos productos vistos#(.*)/);
        if (match) {
            return "ULTIMOS_PRODUCTOS_VISTOS";
        }
        match = gaSource.match(/^fichaproducto#(.*)/);
        if (match) {
            return "FICHA_PRODUCTO";
        }
        match = gaSource.match(/^lookbook#(.*)/);
        if (match) {
            return getCategory().nameEn;
        }
        match = gaSource.match(/^microsite#(.*)/);
        if (match) {
            return getCategory().nameEn;
        }
        if (document.referrer) {
            var domain = Inditex.iGaDomain[0] == '.' ? Inditex.iGaDomain.substr('1') : self.iGaDomain;
            if (!new RegExp("^(http(s)?://)?(www\\.)?.*(" + domain + ").*","i").test(document.referrer)) {
                return "ENTRADA EXTERNA";
            }
        }
        if (prevCategory!=null) {
            var categoryJSON = Inditex.evalJSON(prevCategory);
            if (categoryJSON) {
                if (categoryJSON.search) {
                    return "BUSCADOR";
                } else if (categoryJSON.key) {
                    return categoryJSON.nameEn;
                }
            }
        }
        return brand;
    }

    var eccategory=null;
    InditexClass.prototype._setECCategory = function(category){
        eccategory = category;
    }
    InditexClass.prototype._getECCategory = function(){
        if (eccategory!=null) return eccategory;
        var category = getCategory().key?getCategory().key.replace(new RegExp("[-_]","g"), "/"):'unknow';
        var gaSource = Inditex._getGASource();
        var match = gaSource.match(/^buscador#(\d*)#(.*)/);
        if (match) {
            return "Buscador_"+match[2];
        }
        match = gaSource.match(/^fichaproducto#(\d*)#(.*)/);
        if (match) {
            return match[2];
        }
        if (prevCategory!=null) {
            var categoryJSON = Inditex.evalJSON(prevCategory);
            if (categoryJSON) {
                if (categoryJSON.search) {
                    return "Buscador_"+categoryJSON.search;
                } else if (categoryJSON.key) {
                    return categoryJSON.key.replace(new RegExp("[-_]","g"), "/");
                }
            }
        }
        return category;
    }

    var eccategoryDataDB=null;
    InditexClass.prototype._setECCategoryDataDB = function(categorydb){
        eccategoryDataDB = categorydb;
    }
    InditexClass.prototype._getECCategoryDataDB = function(index){
        if (eccategoryDataDB!=null) return eccategoryDataDB;
        var category = getCategory().id;
        var gaSource = Inditex._getGASource();
        var match = gaSource.match(/^buscador#(\d*)#(.*)/);
        if (!index) index=0;
        if (match) {
            return "0#"+match[2]+"#"+index;
        }
        if (category==0) {
            if (prevCategory!=null) {
                var categoryJSON = Inditex.evalJSON(prevCategory);
                if (categoryJSON) {
                    if (categoryJSON.search) {
                        return "0#"+categoryJSON.search+"#"+index;
                    }
                }
            }
        }
        return category+"#"+index;
    }

    var ecparentid=null;
    InditexClass.prototype._setECParentId = function(parentid){
        ecparentid = parentid;
    }
    var originaliXProductJSON = null;
    InditexClass.prototype._getECParentId = function() {
        if (ecparentid!=null) return ecparentid;
        if (originaliXProductJSON==null) {
            if (Inditex.iXCategoryJSON) {
                originaliXProductJSON = Inditex.iXProductJSON;
            } else {
                originaliXProductJSON = {id:null}
            }
        }
        return originaliXProductJSON.id;

    }

})();;
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/itx-core-standard.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxHeaderDisplay.js (en_US) */
function ItxHeaderDisplayClass() {
    var self = this;
    self._init();
};

ItxHeaderDisplayClass.prototype._init = function() {
    var self = this;
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var isAndroidTablet = (navigator.userAgent.match(/Android/i) != null && navigator.userAgent.match(/Mobile/i) == null);
    self.isTablet = isiPad || isAndroidTablet;

    self._addEventListeners();

    if(!Inditex.iStoreJSON.isOpenForSale) {
        $('#general-menu .account, #general-menu .basket').remove();
        $('#general-menu .account_sep, #general-menu .basket_sep').remove();
    }

    Inditex.getUserJSON(function(userData) {
        if(userData.userType == 'R') {
            if($('.logout').length==0){
                var logoutElement = $('<li></li>').addClass('logout');
                var logoutLink = $('<a></a>').attr('href', '').text(Inditex.iProperties['exit']);
                $(logoutElement).append(logoutLink);
                $('#general-menu .basket').before(logoutElement);

                var separator = $('<li/>', {
                    'html': '|',
                    'class': 'separator'
                });
                logoutElement.after(separator);

                if(typeof window.devicePixelRatio === 'undefined' || window.devicePixelRatio < 1.5) {
                    $('#general-menu .account a').text(userData.firstName + ' ' + userData.lastName).addClass('text-bold');
                } else {
                    $('#general-menu .account').addClass('logged-in');
                }

                logoutLink.on('click', function(event) {
                    event.preventDefault();
                    Inditex.trackEvent('Header','Mi_Cuenta_Logout',null,{hitCallback:function(){
                        logout();
                    }});
                });
            }

        }

        var count = 0;
        $.each(userData.shopCart.items, function(i,j){
            if(j.reference !== "XGIFTSKU"){
                count += j.quantity;
            }
        });

        $('.basket-items-amount').html(count);

        $(document).ready(function() {
            //if ipad or other device with retina display, it doesn't show label on a tag and must have 13 x 13 size
            if(window.devicePixelRatio >= 1.5) {
                $('#general-menu .help a, #general-menu .contact a, #general-menu .account a, #general-menu .logout a').empty().css({'display': 'block', 'width': '13px', 'height': '13px'});
            }

            // We add a padding to the top of the body (header position)
            var header_height = $('header').height();

            // If the navigator is less than IE9 we crop 5px (display problems)
            if($('html').hasClass('lt-ie9')) {
                header_height = header_height - 5;
            }
            $('body').css({ 'padding-top': header_height + 'px' });
        });
    });
};

ItxHeaderDisplayClass.prototype._addEventListeners = function() {
    var self = this;
    $('#search').off('click').on('click', function() {
        $('#searchForm').submit();
    });
    $('#search_text').on('click',function(e) {
        e.stopPropagation();
    });

    $('#searchForm').submit(function(ev) {
        var inputSearch = $('#search_text');
        Inditex.trackEvent('Header','Buscador',inputSearch.val(),{hitCallback: function(){
            var url = Inditex.generateUrl("ItxSolrSearchingDataCmd", {
                storeId: Inditex.iStoreId,
                langId: Inditex.iLangId,
                catalogId: Inditex.iCatalogId,
                searchTerm: inputSearch.val()
            }, false);
            window.location = url;
        }});

        return false;
    });

    $('li.help').off('click').on('click', function() {
        var url = Inditex.generateUrl("ItxStandardShopGuidePage", {
            storeId: Inditex.iStoreId,
            langId: Inditex.iLangId,
            catalogId: Inditex.iCatalogId
        }, false);
        window.location = url;
    });

    $('#general-menu li.account a').off('click').on('click', function() {
        Inditex.getUserJSON(function(userData) {
            if(userData.userType == 'G') {
                Inditex.trackEvent('Header','Mi_Cuenta_Acceder',null,true);
                var url = Inditex.generateUrl("ItxStandardMyAccountPopUpPage", {
                    storeId: Inditex.iStoreId,
                    langId: Inditex.iLangId,
                    catalogId: Inditex.iCatalogId
                }, false);
                Inditex.request({
                    "url": url,
                    "onSuccess": function(aText) {
                        popupCestaUrl(aText,500, "auto", function(){
                            $('#account-enter').on('click', function() {
                                var url = Inditex.generateUrl("LogonForm", {
                                    storeId: Inditex.iStoreId,
                                    langId: Inditex.iLangId,
                                    catalogId: Inditex.iCatalogId,
                                    myAcctMain: "1"
                                }, true);
                                Inditex.trackEvent(constantes.CABECERA,'login');
                                Inditex.trackEvent('Identificate','Usuario_Ya_Registrado',null,{hitCallback: function(){
                                    openGenericModal(url,null,function(){
                                        $('.overlay_bg_cesta').trigger('click',["trigger"]);
                                        Inditex.trackPage( 'Identificate/Iniciar_sesion',{dimension19:'unknown'})
                                    },200,null);
                                }});

                            });

                            $('#account-register').on('click', function() {
                                var url = Inditex.generateUrl("UserRegistrationForm", {
                                    storeId: Inditex.iStoreId,
                                    langId: Inditex.iLangId,
                                    catalogId: Inditex.iCatalogId
                                }, true);
                                Inditex.trackEvent('Identificate','Usuario_Nuevo',null,{hitCallback:function(){
                                    openFormModal(url,null,function(){
                                        $('.overlay_bg_cesta').trigger('click',["trigger"]);
                                        Inditex.trackPage( 'Identificate/Registro',{});
                                        $('#fieldsetGenero').css('width',$('#fieldsetGenero').parent().css('width'));
                                    },null,0.7);
                                }});
                            });
                        },"Identificate/Accede_Cuenta")
                    }
                });

            }
            else if(userData.userType == 'R') {
                if(Inditex)
                    Inditex.trackEvent('Header','Mi_Cuenta_Menu',null,true);
                var url = Inditex.generateUrl('ItxMyAccountView', {
                    'storeId':		Inditex.iStoreId,
                    'langId':		Inditex.iLangId,
                    'catalogId':	Inditex.iCatalogId
                }, true);
                openLargeModal(url,  "miCuentaHome", showMiCuentaOption, null,0.8);
            }
        });
    });

    $('body').find('#general-menu li.contact a, a.popup-contact').off('click').on('click', function(event) {
        Inditex.trackEvent('Header','Contactar',null,true);
        var url = Inditex.generateUrl("ItxStandardContactPopUpPage", {
            storeId: Inditex.iStoreId,
            langId: Inditex.iLangId,
            catalogId: Inditex.iCatalogId
        }, false);
        Inditex.request({
            "url": url,
            "onSuccess": function(aText) {
                popupCestaUrl(aText, "770", "auto",null,'Contacto',function(){
                    Inditex.trackEvent('Contacto','Cerrar',null,true);
                });
            }
        });

    });

    if(!self.isTablet) {
        // Al hacer scroll, si superamos los 100 pixeles de altura (tamano del menu), lo contraemos
        $(window).on('scroll', function() {
            if($(window).scrollTop() > 100){
                $('header').addClass('unfolded-header');
            } else {
                $('header').removeClass('unfolded-header');
            }
        });
    }
};;
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxHeaderDisplay.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxHeaderDisplayTunel.js (en_US) */
function ItxHeaderDisplayTunelClass() {
    var self = this;
    self._init();
};

ItxHeaderDisplayTunelClass.prototype._init = function() {
    var self = this;
    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var isAndroidTablet = (navigator.userAgent.match(/Android/i) != null && navigator.userAgent.match(/Mobile/i) == null);
    self.isTablet = isiPad || isAndroidTablet;

    self._addEventListeners();

    if(!Inditex.iStoreJSON.isOpenForSale) {
        $('#general-menu .account, #general-menu .basket').remove();
    }

    Inditex.getUserJSON(function(userData) {
        if(userData.userType == 'R') {
            if($('#general-menu li.logout').length==0){
                var logoutElement = $('<li></li>').addClass('logout');
                var logoutLink = $('<a></a>').attr('href', '').text(Inditex.iProperties['exit']);
                $(logoutElement).append(logoutLink);
                $('#general-menu .basket').before(logoutElement);

                var separator = $('<li/>', {
                    'html': '|',
                    'class': 'separator'
                });
                logoutElement.after(separator);
                logoutLink.on('click', function(event) {
                    event.preventDefault();
                    Inditex.trackEvent('Header','Mi_Cuenta_Logout',null,{hitCallback:function(){
                        logout();
                    }});
                });
            }

            if(typeof window.devicePixelRatio === 'undefined' || window.devicePixelRatio < 1.5) {
                $('#general-menu .account a').text(userData.firstName + ' ' + userData.lastName).addClass('text-bold');
            } else {
                $('#general-menu .account').addClass('logged-in');
            }



        }

        var count = 0;
        $.each(userData.shopCart.items, function(i,j){
            if(j.reference !== "XGIFTSKU"){
                count += j.quantity;
            }
        });

        $('.basket-items-amount').html(count);


        $(document).ready(function() {
            //if ipad or other device with retina display, it doesn't show label on a tag and must have 13 x 13 size
            if(window.devicePixelRatio >= 1.5) {
                $('#general-menu .help a, #general-menu .contact a, #general-menu .account a, #general-menu .logout a').empty().css({'display': 'block', 'width': '13px', 'height': '13px'});
            }

            // We add a padding to the top of the body (header position)
            var header_height = $('header').height();

            // If the navigator is less than IE9 we crop 5px (display problems)
            if($('html').hasClass('lt-ie9')) {
                header_height = header_height - 5;
            }
        });
    });
};

ItxHeaderDisplayTunelClass.prototype._addEventListeners = function() {
    var self = this;

    $('li.help').off('click').on('click', function() {
        var url = Inditex.generateUrl("ItxStandardShopGuidePage", {
            storeId: Inditex.iStoreId,
            langId: Inditex.iLangId,
            catalogId: Inditex.iCatalogId
        }, false);
        window.location = url;
    });

    $('#general-menu li.account a').off('click').on('click', function() {
        Inditex.getUserJSON(function(userData) {
            if(userData.userType == 'G') {
                Inditex.trackEvent('Header','Mi_Cuenta_Acceder',null,true);
                var url = Inditex.generateUrl("ItxStandardMyAccountPopUpPage", {
                    storeId: Inditex.iStoreId,
                    langId: Inditex.iLangId,
                    catalogId: Inditex.iCatalogId
                }, false);
                Inditex.request({
                    "url": url,
                    "onSuccess": function(aText) {
                        popupCestaUrl(aText,500, "auto", function(){
                            $('#account-enter').on('click', function() {
                                var url = Inditex.generateUrl("LogonForm", {
                                    storeId: Inditex.iStoreId,
                                    langId: Inditex.iLangId,
                                    catalogId: Inditex.iCatalogId,
                                    myAcctMain: "1"
                                }, true);
                                Inditex.trackEvent(constantes.CABECERA,'login');
                                Inditex.trackEvent('Identificate','Usuario_Ya_Registrado',null,{hitCallback: function(){
                                    openGenericModal(url,null,function(){
                                        $('.overlay_bg_cesta').trigger('click',["trigger"]);
                                        Inditex.trackPage( 'Identificate/Iniciar_sesion',{dimension19:'unknown'})
                                    },200,null);
                                }});

                            });

                            $('#account-register').on('click', function() {
                                var url = Inditex.generateUrl("UserRegistrationForm", {
                                    storeId: Inditex.iStoreId,
                                    langId: Inditex.iLangId,
                                    catalogId: Inditex.iCatalogId
                                }, true);
                                Inditex.trackEvent('Identificate','Usuario_Nuevo',null,{hitCallback:function(){
                                    openFormModal(url,null,function(){
                                        $('.overlay_bg_cesta').trigger('click',["trigger"]);
                                        Inditex.trackPage( 'Identificate/Registro',{});
                                        $('#fieldsetGenero').css('width',$('#fieldsetGenero').parent().css('width'));
                                    },null,0.7);
                                }});
                            });
                        },"Identificate/Accede_Cuenta")
                    }
                });
            }
            else if(userData.userType == 'R') {
                Inditex.trackEvent('Header','Mi_Cuenta_Menu',null,true);
                var url = Inditex.generateUrl('ItxMyAccountView', {
                    'storeId':		Inditex.iStoreId,
                    'langId':		Inditex.iLangId,
                    'catalogId':	Inditex.iCatalogId
                }, true);
                openLargeModal(url,  "miCuentaHome", showMiCuentaOption, null,0.8);
            }
        });
    });

    $('body').find('#general-menu li.contact a, a.popup-contact').off("click").on("click", function(event) {
        Inditex.trackEvent('Header','Contactar',null,true);
        var url = Inditex.generateUrl("ItxStandardContactPopUpPage", {
            storeId: Inditex.iStoreId,
            langId: Inditex.iLangId,
            catalogId: Inditex.iCatalogId
        }, false);

        Inditex.request({
            "url": url,
            "onSuccess": function(aText) {
                popupCestaUrl(aText, "770", "auto");
            }
        });
    });
};;
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxHeaderDisplayTunel.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxMenuDisplay.js (en_US) */
var modules = [];
var sub_pages = [];

function ItxMenuDisplayClass() {
    var self = this;

    self._init();
};

ItxMenuDisplayClass.prototype._init = function() {
    var self = this;

    // Variable to save a countdown to hide the sub-menu
    self.sub_menuTimer;

    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var isAndroidTablet = (navigator.userAgent.match(/Android/i) != null && navigator.userAgent.match(/Mobile/i) == null);
    self.isTablet = isiPad || isAndroidTablet;

    self._modelMenu(Inditex.iCategoryTreeJSON.categories);

    // If the total length of the categories of the menu is too large, we add the class .long-menu to reduce the font-size
    if(self._countCategoryNameLength() > 80) {
        $('#main-menu').addClass('long-menu');
    }

    // If the total width of the elements of the menu is more than the maximum width of it's container we'll add the class
    // .table-menu to display it as a table, and we'll apply a specific width to it's 'cells'
    if(self._calculateMenuWidth() > parseInt($('#main-menu ul').css('max-width'))) {
        $('#main-menu').addClass('table-menu');

        var width = Math.floor(1000 / $('#main-menu ul li').length);
        $('#main-menu ul li').css({ 'width': width + 'px' });
    }

    self._addEventListeners();
};

/**
 *	Action to build the Menu; it loops the entire category JSON array and prints the elements on the #main-menu, it also calls _modelSubMenu
 *	if this category have sub-categories
 *
 *	@param	{array}			categories		Array of categories
 */
ItxMenuDisplayClass.prototype._modelMenu = function(categories) {
    var self = this;
    var filtered_categories = self._getFilteredCategories(categories);

    $.each(filtered_categories, function(index, category) {

        // Checking if the category is an object (in some parts of the code there are fucntions appended to
        // the array prototype for older versions of IE, so maybe some iterated items might be functions)
        if(typeof category === 'object') {
            var filtered_subcategories = self._getFilteredCategories(category.subcategories);

            var container = $('<li />');
            // If the current category is the same as the loaded page the item is displayed with specific styles in the Main-Menu
            if(self._isSelected(category.id)) {
                container.addClass('selected');
            }
            container.appendTo($('header nav #main-menu ul'));

            // By default a #main-menu item is not clickable, so the link points to nowhere
            var url_category = '#';

            if(category.viewCategoryId !== 0 || filtered_subcategories.length == 0) {
                // If the property viewCategoryId of the current category is not 0 it must be referred to that subcategory
                if(category.viewCategoryId !== 0) {
                    categoryId = category.viewCategoryId;
                    // Otherwise, if the category have no subcategories it must be autoreferred
                } else if(filtered_subcategories.length == 0) {
                    categoryId = category.id;
                }

                url_category = self._generateUrlByCategory(category, categoryId);
            }

            // Generation of the menu item and printing it to it's container
            self._modelLink(url_category, category.name, { id: category.id , nameEn: category.nameEn }, category.attachments).appendTo(container);
            var column_number = self._getNumberOfColumns(filtered_subcategories);
            hard_mode = false;
            $.each(category.attachments, function(index, attachment) {
                if(attachment.path && attachment.path.match(/TABLET_2_COLUMNS/) && self.isTablet) {
                    var number = 2;

                    if(self._getNumberOfInformatives(filtered_subcategories) <= number) {
                        column_number = number;
                        hard_mode = true;
                    }
                }
            })
            // If the category have subcategories after filtering, we proceed to create the Sub-Menu 
            if(filtered_subcategories && filtered_subcategories.length) {
                self._modelSubMenu(filtered_subcategories, category.id, column_number, hard_mode);
            }
        }
    });
}

/**
 *	Action to build the Sub-Menu; it loops the an entire subcategory JSON array and prints the elements on the #sub-menu
 *
 *	@param	{array}			subcategories		Array of subcategories
 *	@param	{number}		parent_id			Id of it's parent (#main-menu category)
 *	@param	{number}		column_number		Number of columns to divide
 *	@param	{boolean}		hard_mode			Indicator to override column number, subcategory grouping and divisions
 */
ItxMenuDisplayClass.prototype._modelSubMenu = function(subcategories, parent_id, column_number, hard_mode) {
    var self = this;

    // Getting the informative groups for the subcategory list provided and the number of columns
    // based on the amount of subcategories and screen size
    var subcategories_group = self._getGroupedSubcategories(subcategories, hard_mode);

    // We divide the subcategories in groups, based on the number of columns
    var columns = self._divideSubcategories(subcategories_group, column_number);

    var sub_menu_container = $('<div />', {
        'id': parent_id
    }).appendTo($('header nav #sub-menu'));

    if(column_number < 4) {
        sub_menu_container.addClass('centered-text');
    }

    var style = 'informatives';
    if(!self._haveInformatives(subcategories_group)) {
        var style = 'no-informatives';
    }
    sub_menu_container.addClass(style);

    $.each(columns, function(index, column) {
        var parent = $('<ul />', {
            'class': parent_id + '-' + index,
        }).css({ 'width': (100 / (column_number < columns.length ? column_number : columns.length)) + '%' }).appendTo(sub_menu_container);

        for (var column_index in column) {
            var subcategory = column[column_index];

            // Checking if the category is an object (in some parts of the code there are fucntions appended to
            // the array prototype for older versions of IE, so maybe some iterated items might be functions)
            if(typeof subcategory === 'object' && !subcategory.key.match(/_(NEWCOLUMN)$/)) {
                var container = $('<li />');

                // If the current subcategory is the same as the loaded page the item is displayed with specific styles in the Sub-Menu
                if(self._isSelected(subcategory.id)) {
                    container.addClass('selected');
                }
                if(subcategory.key) {
                    if(subcategory.key.match(/_(INFORMATIVE)$/)) {
                        container.addClass('informative-text');
                    } else if(subcategory.key.match(/_(SUBINFORMATIVE)$/)) {
                        container.addClass('sub-informative-text');
                    }
                }
                container.appendTo(parent);

                // Generation of the menu item
                var link = self._modelLink('#', '');

                if(!subcategory.key.match(/_(EMPTY)$/)) {
                    var url_category = '#';
                    if(!subcategory.key.match(/_((SUB)?INFORMATIVE)$/)) {
                        url_category = self._generateUrlByCategory(subcategory);
                    }

                    // If the subcategory is not an empty element we regenerate the menu item with a valid link
                    link = self._modelLink(url_category, subcategory.name, { id: subcategory.id, parent: parent_id, nameEn:subcategory.nameEn }, subcategory.attachments);
                }

                link.appendTo(container);
            }
        }
    });
}

/**
 *	Function to get non-excluded categories from Inditex JSON (excluded EXCLUSIONs, MOBILE, APP and DIVIDERs categories)
 *	@param	{array}			categories			Categories from the Inditex Store JSON
 *
 *	@return	{array}								Filtered categories
 *
 *	Every .name property of an object is checked before using it because of an incompatibility with IE8
 */
ItxMenuDisplayClass.prototype._getFilteredCategories = function(categories) {
    var self = this;
    var filtered_categories = [];

    for (var index in categories) {
        var category = categories[index];

        // If the category/subcategory have name and is not empty
        // If the category/subcategory is not a DIVIDER (old site menu)
        // If the category/subcategory is not a function (in some pages there are functions added to the array prototype)
        if(category && typeof category !== 'function' && ((category.name && category.name.length > 0 && !category.name.match(/DIVIDER/) || (category.key && category.key.match(/_(EMPTY|NEWCOLUMN)$/))))) {

            var key = self._removeChars(category.key);
            var exclusions = [];
            $.each(category.attachments, function(i, attachment){
                if (attachment.type == 'EXCLUSION') {
                    exclusions.push(attachment.name)
                }
            });

            // If the category/subcategory is not a MOBILE or APP category
            // If the category/subcategory is not excluded by country
            if(category.key.indexOf('_MOBILE') === -1 && category.key.indexOf('_APP') === -1 && exclusions.indexOf(Inditex.iStoreJSON.countryCode) === -1) {
                filtered_categories.push(category);
            }
        }
    }

    return filtered_categories;
}

/**
 *	Function to generate a URL based on a category, it comproves if the category must be referred or if it has some specific attributes
 *
 *	@param	{object}		category			A category/subcategory which the URL will be based on
 *	@param	{number}		id					Category where the url will referrer
 *
 *	@return	{string}							Generated URL
 */
ItxMenuDisplayClass.prototype._generateUrlByCategory = function(category, id) {
    var url = '';

    if(typeof id !== 'number') {
        id = category.id;
    }

    // When key ends on _CLICK then we change the url to which is defined
    if(category.key && category.key.match(/_CLICK$/)) {
        url = category.shortDescription;
    } else {
        url = Inditex.generateUrl('CategoryPage', {
            'storeId':		Inditex.iStoreId,
            'langId':		Inditex.iLangId,
            'catalogId':	Inditex.iCatalogId,
            'categoryId':	id
        }, false);
    }

    return url;
}

/**
 *	Function to check if category/subcategory must be marked as selected
 *
 *	@param	{number}		id					ID of the category to check
 *
 *	@return	{boolean}							True if matches and false if not
 */
ItxMenuDisplayClass.prototype._isSelected = function(id) {
    var self = this;
    var selected = false;

    if(self._getParentsTree().indexOf(id) != -1) {
        selected = true;
    }

    return selected;
}

/**
 *	Function to get the parents of a category ID
 *
 *	@param	{number}		id					ID of the category to check
 *	@param	{array}			array				List of categories to find if the ID matches
 *
 *	@param	{array}								Array with the parents and the selected ID
 */
ItxMenuDisplayClass.prototype._getParentsTree = function(id, array) {
    var self = this;
    var roots = [];

    if(!id) {
        id = Inditex.iCategoryId;
    }
    if(!array) {
        array = Inditex.iCategoryTreeJSON.categories;
    }

    $.each(array, function(index, category) {
        if(category.id == id) {
            roots.push(category.id)
        } else {
            if(category.subcategories) {
                var result = self._getParentsTree(id, category.subcategories);
                if(result.length) {
                    $.each(result, function(i, n) {
                        roots.push(n);
                    });

                    roots.push(category.id)
                }
            }
        }
    });

    return roots;
}

/**
 *	Function to modelate a link (<a />) to append it on the required menu (#main-menu or #sub-menu)
 *
 *	@param	{string}		url					URL where the link will be pointing in
 *	@param	{string}		html				Text which will be inside the tags
 *	@param	{object}		options				Options to give information to the link using HTML5 data attributes (id, parent)
 *	@param	{object}		attachments			Options to model the link (provided by the category object where this function is called)
 *
 *	@return	{jQuery object}						jQuery Object with the link prepared to be append on it's container
 */
ItxMenuDisplayClass.prototype._modelLink = function(url, html, options, attachments) {
    var self = this;

    var link = $('<a />', {
        'href':		url,
        'html':		html
    });

    if(options) {
        // The values are added as attribute and data parameters because if we need to access right now, after the element is evaluated by
        // jQuery, attr does not work and data does. But if we need to access after to this values, the data parameter will be unset and
        // is needed the attr to be evaluated by jQuery
        if(options.id && typeof options.id === 'number') {
            link.attr({ 'data-id': options.id }).data('id', options.id);
        }
        if(options.parent && typeof options.parent === 'number') {
            link.attr({ 'data-parent': options.parent }).data('parent', options.parent);
        }
        if(options.nameEn && typeof options.nameEn === 'string') {
            link.attr({ 'data-nameEn': options.nameEn }).data('nameEn', options.nameEn);
        }
    }

    if(attachments && typeof attachments === 'object') {
        // Loading category attachments to the link generated previously
        self._loadAttachments(link, attachments);
    }

    return link;
}

/**
 *	Action to add attachment-like values to an element
 *
 *	@param	{jQuery object}	element				Element on which the options must be attached
 *	@param	{array}			attachments			List of options to be attached
 */
ItxMenuDisplayClass.prototype._loadAttachments = function(element, attachments) {
    // If the attachments are an array
    if(attachments && attachments.length) {
        var attachment_list = {};

        $.each(attachments, function(n, attachment) {
            // Specific category color
            if(attachment.path && attachment.path.match(/ON_COLOR/)) {
                attachment_list['color'] = {
                    'type': 'css',
                    'val': '#' + attachment.path.match(/[\w]{6,6}$/)
                };
            }
            // Specific link destination
            if(attachment.path == 'TARGET_BLANK') {
                attachment_list['target'] = {
                    'type': 'attr',
                    'val': '_blank'
                };
            }
            // 'New' Label
            if(attachment.path == 'NEW_CATEGORY') {
                attachment_list['append'] = {
                    'type': 'append',
                    'val': ' <span class="label-new-subcategory">NEW</span>'
                };
            }
        });

        // Appending each attachment dynamically to the element
        $.each(attachment_list, function(index, attachment) {
            // Differing string from object function requests
            if(index.match(/append/)) {
                element[attachment['type']](attachment['val']);
            } else {
                var data = {};
                data[index] = attachment.val;

                element[attachment['type']](data);
            }
        });
    }
}


/**
 *	Function to group subcategories basing on if there are some informative subcategories.
 *	in each returned group must be an informative variable (the first one) unless there are only one group,
 *	on which maybe there are no informatives.
 *	There are also another case, when there are more than one group, and the first one may not have any informative too
 *
 *	@param	{array}		subcategories			List of subcategories to be grouped
 *  @param	{boolean}	hard_mode				Indicator to override column number, subcategory grouping and divisions
 *	@return	{array}								List of groups of subcategories
 */
ItxMenuDisplayClass.prototype._getGroupedSubcategories = function(subcategories, hard_mode) {
    var self = this;

    // Variable to store the groups of categories
    var grouped_subcategories = [];
    // Variable to contain an unic group of categories
    var group = [];

    for (var index in subcategories) {
        var subcategory = subcategories[index];

        // If the category is informative, we create a new group and we push the current one to the storage
        if(subcategory.key) {
            if((hard_mode && subcategory.key.match(/_(INFORMATIVE)$/)) || (!hard_mode && subcategory.key.match(/_(INFORMATIVE|NEWCOLUMN)$/))) {
                if(group.length) {
                    grouped_subcategories.push(group);
                }

                group = [];
            }

            group.push(subcategory);
        }
    }

    grouped_subcategories.push(group);

    return grouped_subcategories;
}

/**
 *	Funtion to get the number of columns should has the #sub-menu, basing on the number of subcategories we are printing and
 *	the size of the screen and the device
 *
 *	@param	{array}		subcategories			List of subcategories
 *
 *	@return	{number}							Number of colums the Sub-Menu should has for this subcategory list
 */
ItxMenuDisplayClass.prototype._getNumberOfColumns = function(subcategories) {
    var self = this;
    var amount = 4;
    var max_columns = 4;
    subcategories_number = subcategories.length - self._getNumberOfInformatives(subcategories) - self._getNumberOfFunctions(subcategories);

    if(self.isTablet && screen.width < 1040) {
        amount = 3;
        max_columns = 3;
        if(subcategories_number < 4) {
            amount = subcategories_number;
        } else if(subcategories_number < 7) {
            amount = 2;
        }
    } else {
        if(subcategories_number < 4) {
            amount = subcategories_number;
        } else if(subcategories_number < 9) {
            amount = 2;
        } else if(subcategories_number < 13) {
            amount = 3;
        }
    }
    if(amount < max_columns) {
        if(amount + self._getNumberOfNewColumns(subcategories) > max_columns) {
            amount = max_columns;
        } else {
            amount = amount + self._getNumberOfNewColumns(subcategories);
        }
    }
    return amount;
}

/**
 *	Function to get the number of elements with the key NEWCOLUMN
 *
 *	@param	{array}		subcategories			List of subcategories
 *
 *	@return	{number}							Number of matching elements the list have
 */
ItxMenuDisplayClass.prototype._getNumberOfNewColumns = function(subcategories) {
    var result = 0;

    $.each(subcategories, function(index, subcategory) {
        if(subcategory.key && subcategory.key.match(/_(NEWCOLUMN)$/)) {
            result++;
        } else {
            var grouped = subcategory;

            $.each(grouped, function(index, group) {
                if(group && group.key && group.key.match(/_(NEWCOLUMN)$/)) {
                    result++;
                }
            });
        }
    });

    return result;
}
/**
 *	Function to divide the groups of categories divided by informative groups by the number of columns they should be printed
 *
 *	@param	{array}		subcategories_group		List of groups of subcategories
 *	@param	{number}	column_number			Number of columns the groups of subcategories must be divided on
 *
 *	@return	{array}								Columns of divided groups of subcategories
 */
ItxMenuDisplayClass.prototype._divideSubcategories = function(subcategories_group, column_number) {
    var self = this;

    // Number of groups of subcategories
    var amount = subcategories_group.length;

    // 4 groups to divide in 3 columns (tablet)
    if(amount == 4 && column_number == 3) {
        if(self._getNumberOfNewColumns(subcategories_group)) {
            $.each(subcategories_group, function(index, group) {
                if(group && group.length && group[0].key.match(/_(NEWCOLUMN)$/)) {
                    $.each(group, function(i, subcategory) {
                        subcategories_group[index - 1].push(subcategory);
                    });

                    subcategories_group.splice(index, 1);
                }
            });

        } else {
            // Removing the subcategories from the last group and pushing them to the first group
            $.each(subcategories_group[subcategories_group.length - 1], function(index, subcategory) {
                if(subcategory.key) {
                    subcategories_group[0].push(subcategory);
                }
            });

            // Removing the last group (which is now appended to the first one)
            subcategories_group = subcategories_group.slice(0, subcategories_group.length - 1);
        }

        // Updating the number of groups of subcategories
        amount = subcategories_group.length;
    }

    // Array to store the definitive structure of Sub-Menu in columns (dividing groups of subcategories)
    var columns = [];
    var have_informatives = self._haveInformatives(subcategories_group);

    // By default the division is only on the largest group, but it can also be two groups divided in two columns
    var two_columns = false;
    // If there are 2 groups of subcategories and 4 columns or there are 2 groups, 3 columns and we're on a tablet
    if((amount == 2 && column_number == 4) || (amount == 2 && column_number == 3 && self.isTablet)) {
        // By default the variability index is 4 but it can be overwrited for specific stores
        var variability = 4;
        if(Inditex.iStoreJSON.menuDivisionVariability && Inditex.iStoreJSON.menuDivisionVariability > 0) {
            variability = Inditex.iStoreJSON.menuDivisionVariability;
        }

        // Defining the real length of the two groups that might be divided in two columns
        var first = subcategories_group[0].length - self._getNumberOfInformatives(subcategories_group[0]) - self._getNumberOfFunctions(subcategories_group[0]) - self._getNumberOfNewColumns(subcategories_group[0]);
        var last = subcategories_group[1].length - self._getNumberOfInformatives(subcategories_group[1]) - self._getNumberOfFunctions(subcategories_group[1]) - self._getNumberOfNewColumns(subcategories_group[1]);
        // If the groups are equal or they differ inside de index of variability they must be divided in two columns
        if(first == last) {
            two_columns = true;
        } else if(first <= last && first + variability >= last) {
            two_columns = true;
        } else if(last <= first && last + variability >= first) {
            two_columns = true;
        }
    }

    if(two_columns) {
        // Dividing the two groups of subcategories in two columns each one
        $.each(subcategories_group, function(index, group) {
            if(typeof group === 'object') {
                var divisions = Math.ceil(column_number / amount);
                if(self.isTablet) {
                    divisions = 1;
                }

                var items_per_column = Math.ceil(group.length / divisions);

                for(division = 0; division < divisions; division++) {
                    var from = division * items_per_column;
                    var to = ((division + 1) * items_per_column);
                    columns.push(group.slice(from, to));
                }
            }
        });
    } else {
        // Index of array and size of the largest group
        var largest_group_index = null;
        var largest_group_size = 0;
        // Number of divisions to divide the largest group
        var divisions = column_number - amount + 1;

        $.each(subcategories_group, function(index, group) {
            if(group.length > largest_group_size) {
                largest_group_index = parseInt(index);
                largest_group_size = group.length;
            }
        });

        if(largest_group_index >= 0) {
            var parts = {
                'first': null,
                'divided': [],
                'last': null
            };

            // Largest group of subcategories
            var largest = subcategories_group[largest_group_index];
            // X groups before the largest group
            parts.first = subcategories_group.slice(0, largest_group_index);
            // X groups after the largest group
            parts.last = subcategories_group.slice(largest_group_index + 1, subcategories_group.length);

            if(column_number === 2 && have_informatives) {
                largest_group_size += self._getNumberOfInformatives(subcategories_group);
            }
            if(self._getNumberOfNewColumns(subcategories_group)) {
                largest_group_size += self._getNumberOfNewColumns(subcategories_group);
            }

            var operation = 'ceil';
            if(have_informatives && !self._getNumberOfNewColumns(subcategories_group)) {
                operation = 'floor';
            }
            var items_per_column = Math[operation](largest_group_size / divisions);

            var informatives = 0;
            // Dividing the groups of subcategories in three parts (first group(s), divided group and last group(s))
            for(division = 0; division < divisions; division++) {
                var from = division * items_per_column;
                var to = ((division + 1) * items_per_column);

                var part = largest.slice(from + informatives, to + informatives);
                if(column_number !== 2 && self._haveInformatives(part)) {
                    part = largest.slice(from + informatives, to + 1);
                    informatives++;
                }

                parts.divided.push(part);
            }

            // Dividing the parts in columns
            $.each(parts, function(index, part) {
                $.each(part, function(partIndex, single) {
                    columns.push(single);
                });
            });
        }
    }

    return columns;
}

/**
 *	Function to check a group of subcategories have any informative element
 *
 *	@param	{array}		subcategories_group		List of groups of subcategories to be checked
 *
 *	@return	{bool}								True if there is some informative element and False if not
 */
ItxMenuDisplayClass.prototype._haveInformatives = function(subcategories_group) {
    var self = this;
    var result = false;

    if(self._getNumberOfInformatives(subcategories_group)) {
        result = true;
    }

    return result;
}

/**
 *	Function to count the amount of informative elements inside a list of subcategories
 *
 *	@param	{array}		subcategories			List of subcategories to be checked
 *
 *	@return	{number}							Number of informative elements inside the subcategories group
 */
ItxMenuDisplayClass.prototype._getNumberOfInformatives = function(subcategories) {
    var result = 0;

    $.each(subcategories, function(index, subcategory) {
        if(subcategory.key && subcategory.key.match(/_(INFORMATIVE)$/)) {
            result++;
        } else {
            var grouped = subcategory;

            $.each(grouped, function(index, group) {
                if(group && group.key && group.key.match(/_(INFORMATIVE)$/)) {
                    result++;
                }
            });
        }
    });

    return result;
}

/**
 *	Function to count the amount of functions inside an array
 *
 *	@param	{array}		array					Array to be checked
 *
 *	@return	{number}							Number of informative elements inside the array
 */
ItxMenuDisplayClass.prototype._getNumberOfFunctions = function(array) {
    var result = 0;

    $.each(array, function(index, array) {
        if(typeof array === 'function') {
            result++;
        } else {
            var subarrays = array;

            $.each(subarrays, function(index, subarray) {
                if(typeof subarray === 'function') {
                    result++;
                }
            });
        }
    });

    return result;
}

/**
 *	Function to remove special characters from category keys
 *	@param	{string}	key						Identifier key for a category
 *
 *	@return	{string}							Key with special characters removed
 */
ItxMenuDisplayClass.prototype._removeChars = function(key) {
    return key.replace('.','_').replace('&','_').replace(' ','_');
}

/**
 *	Function to count the total of first level categories names length
 *
 *	@return	{number}							Sum of all the names of the first level categories
 *
 *	Every .name property of an object is checked before using it because of an incompatibility with IE8
 */
ItxMenuDisplayClass.prototype._countCategoryNameLength = function() {
    var length = 0;

    $('#main-menu ul li a').each(function(index, element) {
        if($(element).text()) {
            length += $(element).text().length;
        }
    });

    return length;
}

/**
 *	Function to calculate the total width of the elements of the main-menu
 *
 *	@return	{number}							Total width of the elements of the main-menu
 */
ItxMenuDisplayClass.prototype._calculateMenuWidth = function() {
    var width = 0;

    $('#main-menu ul li').each(function(index, element) {
        width += $(element).outerWidth();
    });

    return width;
}

ItxMenuDisplayClass.prototype._addEventListeners = function() {
    var self = this;

    // For tablets we've a specific behavior and for desktop another one
    if(self.isTablet) {
        // When clicking on a first level category in the main-menu in tablet, we will show/hide/change the shown sub-menu
        $('#main-menu a').on('click', function(event) {
            var sub_menu = $('#sub-menu #' + $(this).data('id'));
            if(sub_menu.length) {
                // If there is a sub-menu (subcategories) of the category clicked, we stop the default action (href)
                event.preventDefault();

                // If the sub-menu is visible it means is unfolded
                if($('#sub-menu').is(':visible')) {
                    // If the div of the category clicked is visible it mans we must close it
                    if(sub_menu.is(':visible')) {
                        self._hideSubMenu();
                        // Otherwise, it means we are changing from category
                    } else {
                        $('#sub-menu div').not(sub_menu).hide();
                        sub_menu.show();

                        $('#sub-menu').stop().fadeIn(200);
                    }
                    // Otherwise, it means the menu must be shown
                } else {
                    sub_menu.show();
                    $('#sub-menu').show();
                }

                $('#main-menu .active, #sub-menu .active').removeClass('active');
                $(this).parent().addClass('active');
            }
        });

        // When clicking on every part of the web we close the sub-menu
        $('html').on('click', function() {
            self._hideSubMenu();
        });
        // But when clicking on a first level category we prevent the closing of the menu
        $('#main-menu a, #sub-menu').on('click', function(event){
            event.stopPropagation();
        });
    } else {
        // When mouse enters the first level category on desktop we show this category sub-menu
        $('#main-menu a').on('mouseenter', function() {
            // First we clear the timeout if the sub-menu has a timeout to be closed
            clearTimeout(self.sub_menuTimer);

            var sub_menu = $('#sub-menu #' + $(this).data('id'));

            $('#sub-menu div').not(sub_menu).hide();
            sub_menu.show();

            Inditex.trackEvent('Menu_Superior_Principal','Desplegar_'+$(this).data('nameEn'),null,true);

            $('#sub-menu').stop().fadeIn(200);

            $('#main-menu .active').removeClass('active');
            // When it leaves this category we set a timeout to hide it
        }).on('mouseleave', function() {
            self._hideSubMenu(true);
        });

        // When mouse enters on the sub-menu we clear the timeout
        $('#sub-menu').on('mouseenter', function() {
            clearTimeout(self.sub_menuTimer);
            // When it leaves this category we set a timeout to hide it
        }).on('mouseleave', function() {
            self._hideSubMenu(true);
        });
    }

    $('#sub-menu li a:not([target=_blank])').off('click').on('click', function(event) {
        event.preventDefault();
        var seccion = $("a[data-id="+$(this).data('parent')+"]").data('nameEn').replace(/\s+/g, '');
        var category = $(this).data('nameEn').replace(/\s+/g, '');
        var url = $(this).attr("href");
        Inditex.trackEvent( 'Menu_Superior_Principal','Click_Categoria',seccion+"_"+category,{
            hitCallback: function(){
                document.location.href=url;
            }
        });
    });

    $('#sub-menu li a[target="_blank"]').off('click').on('click', function(event) {
        var seccion = $("a[data-id="+$(this).data('parent')+"]").data('nameEn').replace(/\s+/g, '');
        var category = $(this).data('nameEn').replace(/\s+/g, '');
        var url = $(this).attr("href");
        Inditex.trackEvent( 'Menu_Superior_Principal','Click_Categoria',seccion+"_"+category,true);
    });
    if(!self.isTablet){
        $('#main-menu li a:not([target=_blank],[href="#"])').off('click').on('click', function(event) {
            event.preventDefault();
            var category = $(this).data('nameEn').replace(/\s+/g, '');
            var url = $(this).attr("href");
            Inditex.trackEvent( 'Menu_Superior_Principal','Click_Categoria',category,{
                hitCallback: function(){
                    document.location.href=url;
                }
            });
        })
    }
    $('#main-menu li a[target=_blank]').off('click').on('click', function(event) {
        var category = $(this).data('nameEn').replace(/\s+/g, '');
        Inditex.trackEvent( 'Menu_Superior_Principal','Click_Categoria',category,true);
    })

    // When clicking on a first level category in the main-menu or the sub-msnu which don't have a link to a category, we prevent the link to #
    $('#main-menu a[href="#"], #sub-menu a[href="#"], #sub-menu li.informative-text a, #sub-menu li.sub-informative-text a').on('click', function(event) {
        event.preventDefault();
    });

    $.each($("#sub-menu li.informative-text a, sub-menu li.sub-informative-text a"), function( index, el ) {
        $(el).attr('href',"#")
    });


    // IE8 Fix because of compatibility with :first-child and :last-child
    if(navigator.userAgent.toLowerCase().indexOf('msie 8') !== -1) {
        $('header').ready(function() {
            $('#sub-menu').find('ul:last-child:not(:first-child)').css({ 'float': 'right' });
            $('#sub-menu ul').find('li:last-child').css({ 'margin': 0 });
        });
    }

    $("header nav #sub-menu li:last-child").css({ "margin": 0 });
    $("header nav #sub-menu div.informatives ul li:first-child:not(.informative-text)").css({ "margin-top": "36px" })
};

/**
 *	Action to hide #sub-menu
 *	@param	{boolean}	timer					Sets if the hide must be delayed or not (none by default)
 */
ItxMenuDisplayClass.prototype._hideSubMenu = function(timer) {
    var self = this;

    if(timer === true) {
        // If the hide of sub-menu must be delayed we'll call this function without delaying after x milliseconds
        self.sub_menuTimer = setTimeout(function() {
            self._hideSubMenu(false);
        }, 500);
    } else {
        // If the hide of sub-menu is not delayed we'll hide it
        $('#sub-menu').stop().fadeOut(200, function() {
            $('#sub-menu div').hide();
            $('#main-menu .active, #sub-menu .active').removeClass('active');
        });
    }
}

/**
 *	We'll define indexOf Javascript fucntion if is not defined (<IE8)
 */
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(obj, start) {
        for (var i = (start || 0), j = this.length; i < j; i++) {
            if (this[i] === obj) {
                return i;
            }
        }
        return -1;
    }
};
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxMenuDisplay.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxMenuGiftCard.js (en_US) */
function ItxMenuGiftCardClass() {
    var self = this;
    self._init();
};

ItxMenuGiftCardClass.prototype._init = function() {

    //load Active menu
    var htmlId = $('html').attr('id');

    switch(htmlId) {
        case "ItxGiftCardActivatePage":
            $("#StandardGiftCardActivatePage").addClass("active");
            break;
        case "ItxGiftCardConditionsPage":
            $("#StandardGiftCardConditionsPage").addClass("active");
            break;
        case "ItxGiftCardBalancePage":
            $("#StandardGiftCardBalancePage").addClass("active");
            break;
    }

    $("#menu-gifcard .link, .giftbut").on('click', function() {
        if($(this).attr("id")!==undefined){
            window.location.href = Inditex.generateUrl("Itx" + $(this).attr("id"), {
                "storeId": Inditex.iStoreId,
                "langId": Inditex.iLangId,
                "catalogId": Inditex.iCatalogId
            });
        }
    });

};;
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxMenuGiftCard.js (en_US) */

/* BEGIN /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxFooterDisplay.js (en_US) */
function ItxFooterDisplayClass() {
    var self = this;
    self._init();
};

ItxFooterDisplayClass.prototype._init = function() {
    var self = this;

    var isiPad = navigator.userAgent.match(/iPad/i) != null;
    var isAndroidTablet = (navigator.userAgent.match(/Android/i) != null && navigator.userAgent.match(/Mobile/i) == null);

    if(isiPad || isAndroidTablet) {
        $('#footer-top ul li').addClass('show');
    }

    Inditex.getXConfiguracion({
        parametro: 'SHOW_GIFT_CARD',
        onSuccess: function(aJson) {
            var giftCardAvailable=false;
            if (aJson != null && aJson.value != null && aJson.value=="true" ){
                giftCardAvailable=true;
            }
            if(!Inditex.iStoreJSON.isOpenForSale || (Inditex.iStoreJSON.isOpenForSale && !giftCardAvailable)) {
                self.removeGiftCardButton();
            }

        },
        onFailure: function(aStatus) {
            showError(ITX_TEXT_GENERIC_PROBLEM);
        }
    });




    if(Inditex.iStoreJSON.countryCode == 'RU') {
        self.renderRussianSocialNetworks();
    }
    else if(Inditex.iStoreJSON.countryCode == 'CN') {
        self.renderChineseSocialNetworks();
    }

    self.renderLanguages();
    self._loadBindings();

    $('footer').ready(function() {
        var milliseconds = 500;
        //animaciones para los botones del footer superior
        if(!isiPad && !isAndroidTablet) {
            $('#footer-top ul li').hover(function() {
                $parent = $(this);
                $parent.stop().animate({ 'top': '25px' }, milliseconds);

                if($parent.hasClass('new-apps') || $parent.hasClass('gift-card') || $parent.hasClass('shops')) {
                    $link = $parent.children('a');
                    $link.stop().animate({ 'padding': '13px 0' });

                    $img = $link.children('div');

                    if($('html').hasClass('lt-ie9')) {
                        $img.stop().animate({ 'margin-top': '6px' }).fadeIn();
                    } else {
                        $img.stop().animate({
                            'margin-top': '6px',
                            'opacity': 1,
                            '-o-opacity': 1,
                            '-ms-opacity': 1,
                            '-moz-opacity': 1,
                            '-khtml-opacity': 1
                        }, milliseconds);
                    }
                } else {

                    $parent.children('span').stop().animate({ 'padding': '13px 0' }, milliseconds);
                    $parent.children('div').stop().animate({ 'top': '34px' }, milliseconds);
                    Inditex.trackEvent('Footer','Newsletter_desplegar', null, true);
                }
            }, function() {
                $parent = $(this);
                $parent.stop().animate({ 'top': '50px' }, milliseconds);

                if($parent.hasClass('new-apps') || $parent.hasClass('gift-card') || $parent.hasClass('shops')) {
                    $link = $parent.children('a');
                    $link.stop().animate({ 'padding': '19px 0' });

                    $img = $link.children('div');

                    if($('html').hasClass('lt-ie9')) {
                        $img.stop().animate({ 'margin-top': '19px' }).fadeOut();
                    } else {
                        $img.stop().animate({
                            'margin-top': '19px',
                            'opacity': 0,
                            '-o-opacity': 0,
                            '-ms-opacity': 0,
                            '-moz-opacity': 0,
                            '-khtml-opacity': 0
                        }, milliseconds);
                    }
                } else {
                    $parent.children('span').stop().animate({ 'padding': '19px 0' }, milliseconds);
                    $parent.children('div').stop().animate({ 'top': '46px' }, milliseconds);
                }
            });
        }
        //aplicar clase no-border-right (no existen los pseudoselectores y last-child)
        $('#footer-menu ul li:last-child').addClass('no-border-right');
        $('#change-country ul li').addClass('no-border-right');
        $('#change-language-menu ul li:last-child').addClass('no-border-right');

        $('footer #social-menu .icono:last-child a').css({ 'margin': '0' });
        $('#footer-top .footer-top-background ul li:last-child').css({ 'border-right': 'none' });
    });
}

ItxFooterDisplayClass.prototype._loadBindings = function(){
    var self = this;

    $('#footer-top ul li.shops a').on('click', function(e) {
        e.preventDefault();
        Inditex.trackEvent('Footer','Ver_Tiendas', null, {hitCallback: function(){
            get_tiendas('footer');
        }});
    });

    $('#newsletter-form').submit(function(e) {
        e.preventDefault();
        var url = Inditex.generateUrl("NewsletterFormView", {
            "storeId": Inditex.iStoreId,
            "langId": Inditex.iLangId,
            "catalogId": Inditex.iCatalogId
        });
        openGenericModal(url, $('#newsletter-form').find('#newsletter').val(), onReadyNewLetterError, 200, null);
    });

    $('#change-country ul li a').on('click', function(e) {
        e.preventDefault();
        Inditex.trackEvent('Footer','Cambiar_pais', null, {hitCallback: function(){
            window.location.href = Inditex.generateUrl('WorldWidePage',{storeId:Inditex.iStoreId,useCookie:0},false)
        }});
    });

    $('#footer-menu ul li.politicacookiesFooter a').on('click',function(){
        Inditex.trackEvent('Footer','Ver_Politica_de_cookies', null, true);
    })


    $('#footer-menu ul li.empresaFooter a').on('click',function(){
        Inditex.trackEvent('Footer','Ver_Empresa', null, true);
    })

    $('#footer-menu ul li.joinfashionFooter a').on('click',function(){
        Inditex.trackEvent('Footer','Ver_JoinFashion', null, true);
    })

    $('#footer-menu ul li.ayudaFooter a').on('click',function(){
        Inditex.trackEvent('Footer','Ver_Ayuda', null, true);
    })

    $('#footer-menu ul li:first a').on('click',function(){
        Inditex.trackEvent('Footer','Ver_EditAndPlaces', null, true);
    })




    self._socialTracking();

    $(document).on('click', function() {
        self._hideIframe();
    });
    $(document).on('scroll', function() {
        self._hideIframe();
    });
}


ItxFooterDisplayClass.prototype._socialTracking = function(){
    var self = this;
    $('#footer-bottom > #social-menu li a.tw').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','twitter',true);
    });
    $('#footer-bottom > #social-menu li a.fb').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','facebook',true);
    });
    $('#footer-bottom > #social-menu li a.yb').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','youtube',true);
    });
    $('#footer-bottom > #social-menu li a.ic').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','pinterest',true);
    });
    $('#footer-bottom > #social-menu li a.in').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','instagram',true);
    });
    $('#footer-bottom > #social-menu li a.in').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','instagram',true);
    });
    $('#footer-bottom > #social-menu li a.vk').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','vk',true);
    });
    $('#footer-bottom > #social-menu li a.yk').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','youku',true);
    });
    $('#footer-bottom > #social-menu li a.wb').on('click',function(e){
        Inditex.trackEvent('Footer','Ir_a_Perfil_social','weibo',true);
    });
}

ItxFooterDisplayClass.prototype._hideIframe = function() {
    $('iframe').each(function(index, element) {
        if($(element).attr('src').match(/.*Googleadservices.*/)) {
            $(element).hide();
        }
        if($(element).attr('name')=="google_conversion_frame") {
            $(element).hide();
        }

    });
}

ItxFooterDisplayClass.prototype.renderLanguages = function() {

    var currentLanguageId = Inditex.iLangId

    var languages = Inditex.iStoreJSON.supportedLanguages;

    if(languages.length > 1) {
        var languageList = $('<ul></ul>');

        for(var i = 0; i < languages.length; i++) {
            var url= Inditex.generateLangUrl(languages[i].id);

            var element = $('<li></li>');
            var link;
            if(currentLanguageId != languages[i].id) {
                link = $('<a></a>', {
                    'href': url,
                    'lang': languages[i].code
                }).append(languages[i].name).bind('click',function(e){
                    e.preventDefault();
                    var el= this;
                    Inditex.trackEvent('Footer','Cambiar_idioma', $(el).attr('lang'), {hitCallback:function(){
                        window.location.href= $(el).attr('href');
                    }})
                })
            } else {
                link = languages[i].name;
                $(element).addClass('no-rollover active');
            }

            $(element).append(link);

            $(languageList).append(element);
            if(i + 1 < languages.length) {
                var separator = $('<li/>', {
                    'html': '|',
                    'class': 'separator'
                });
                $(languageList).append(separator);
            }
        }

        $('#change-language-menu').html(languageList);
    }
}

ItxFooterDisplayClass.prototype.removeGiftCardButton = function() {
    $('#footer-top ul li').css('width', '33.3%');
    $('#footer-top ul li.gift-card').remove();
}


ItxFooterDisplayClass.prototype.renderRussianSocialNetworks = function() {
    var vkLink = $('<a></a>').addClass('vk').attr({
        target: '_blank',
        href: 'http://vk.com/massimodutti'
    });
    var vkontakte = $('<li></li>').addClass('icono last').append(vkLink);
    $('#social-menu ul').append(vkontakte);
}


ItxFooterDisplayClass.prototype.renderChineseSocialNetworks = function() {
    var youkuLink = $('<a></a>').addClass('yk').attr({
        target: '_blank',
        href: 'http://i.youku.com/u/UMjI1OTUzNTQ4'
    });
    var youku = $('<li></li>').addClass('icono last').append(youkuLink);
    var weiboLink = $('<a></a>').addClass('wb').attr({
        target: '_blank',
        href: ' http://e.weibo.com/massimodutti'
    });
    var weibo = $('<li></li>').addClass('icono last').append(weiboLink);
    $('#social-menu ul').append(youku, weibo);
};
/* END /DuttiNEWStorefrontAssetStore/js/../itxstandard/js/ItxFooterDisplay.js (en_US) */

